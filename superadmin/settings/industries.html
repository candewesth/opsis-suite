<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industrias - SuperAdmin | Opsis Suite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/superadmin.css?v=16">
    <style>
        /* Settings Navigation - Verdi Pills */
        .settings-nav { background: white; border-radius: 20px; padding: 0.5rem; margin-bottom: 2rem; display: flex; gap: 0.5rem; flex-wrap: wrap; box-shadow: 0 4px 15px rgba(2, 35, 38, 0.06); border: 1px solid rgba(2, 115, 94, 0.1); }
        .settings-nav-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.85rem 1.25rem; border-radius: 14px; font-size: 0.9rem; font-weight: 500; color: #64748b; text-decoration: none; transition: all 0.25s ease; background: transparent; }
        .settings-nav-item:hover { background: #f0fdf4; color: #02735E; }
        .settings-nav-item.active { background: linear-gradient(135deg, #022326 0%, #02735E 100%); color: white; box-shadow: 0 4px 15px rgba(2, 115, 94, 0.3); }
        .settings-nav-item.active i { color: white; }
        
        /* Stats Bar - Verdi + Aire (fondo oscuro, iconos y texto blancos) */
        .stats-bar { display: flex; gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: linear-gradient(135deg, #022326 0%, #02735E 100%); border-radius: 16px; padding: 1.25rem 1.5rem; border: none; box-shadow: 0 4px 20px rgba(2, 35, 38, 0.15); display: flex; align-items: center; gap: 1rem; }
        .stat-icon { width: 48px; height: 48px; background: rgba(255, 255, 255, 0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; }
        .stat-icon i { color: white; }
        .stat-info h4 { font-size: 1.5rem; font-weight: 700; color: white; }
        .stat-info p { font-size: 0.85rem; color: rgba(255, 255, 255, 0.7); }
        
        /* Industry Grid */
        .industry-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        
        /* Add Card */
        .add-card { background: linear-gradient(135deg, rgba(2, 115, 94, 0.05), rgba(16, 185, 129, 0.08)); border: 2px dashed #02735E; border-radius: 24px; padding: 2rem; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 260px; cursor: pointer; transition: all 0.3s ease; }
        .add-card:hover { background: linear-gradient(135deg, rgba(2, 115, 94, 0.1), rgba(16, 185, 129, 0.15)); transform: translateY(-4px); box-shadow: 0 15px 40px rgba(2, 115, 94, 0.15); }
        .add-card-icon { width: 72px; height: 72px; background: linear-gradient(135deg, #02735E, #10b981); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; color: white; margin-bottom: 1rem; }
        .add-card-icon i { color: white; }
        .add-card h4 { font-size: 1.05rem; font-weight: 700; color: #02735E; margin-bottom: 0.25rem; }
        .add-card p { font-size: 0.8rem; color: #64748b; text-align: center; }
        
        /* Industry Card */
        .industry-card { background: white; border-radius: 24px; padding: 1.75rem; border: 1px solid rgba(2, 115, 94, 0.1); box-shadow: 0 4px 20px rgba(2, 35, 38, 0.06); transition: all 0.3s ease; position: relative; overflow: hidden; }
        .industry-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--card-color, #02735E), var(--card-color-light, #10b981)); opacity: 0; transition: opacity 0.3s; }
        .industry-card:hover { transform: translateY(-6px); box-shadow: 0 20px 50px rgba(2, 35, 38, 0.12); }
        .industry-card:hover::before { opacity: 1; }
        
        .industry-card-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .industry-icon { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
        .industry-icon.fa-icon { background: linear-gradient(135deg, var(--card-color, #022326), var(--card-color-light, #02735E)); color: white; }
        .industry-icon.fa-icon i { color: white; }
        .industry-icon.emoji { background: #f0fdf4; font-size: 1.75rem; }
        
        .industry-info { flex: 1; min-width: 0; }
        .industry-info h4 { font-size: 1.05rem; font-weight: 700; color: #1e293b; margin-bottom: 0.15rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .industry-info .count { font-size: 0.8rem; color: #64748b; display: flex; align-items: center; gap: 0.35rem; }
        .industry-info .count i { color: #02735E; font-size: 0.7rem; }
        
        .industry-actions { display: flex; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid #f1f5f9; }
        .btn-action { flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.4rem; padding: 0.65rem 0.75rem; border-radius: 10px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-family: inherit; border: none; }
        .btn-action.edit { background: #f0fdf4; color: #02735E; }
        .btn-action.edit:hover { background: #dcfce7; }
        .btn-action.delete { background: #fef2f2; color: #dc2626; }
        .btn-action.delete:hover { background: #fee2e2; }
        
        /* Enhanced Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(2, 35, 38, 0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; backdrop-filter: blur(8px); transition: all 0.3s; padding: 1rem; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-v { background: white; border-radius: 28px; width: 100%; max-width: 560px; overflow: hidden; transform: scale(0.95) translateY(20px); transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 30px 100px rgba(2, 35, 38, 0.35); max-height: 90vh; display: flex; flex-direction: column; }
        .modal-overlay.active .modal-v { transform: scale(1) translateY(0); }
        
        .modal-header-v { background: linear-gradient(135deg, #022326 0%, #035951 50%, #02735E 100%); color: white; padding: 1.75rem 2rem; display: flex; justify-content: space-between; align-items: flex-start; position: relative; overflow: hidden; }
        .modal-header-v::before { content: ''; position: absolute; top: -50%; right: -20%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(16, 185, 129, 0.2) 0%, transparent 70%); border-radius: 50%; }
        .modal-header-v h3 { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; color: white; position: relative; z-index: 1; }
        .modal-header-v h3 i { color: white; font-size: 1.1rem; }
        .modal-header-v p { font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 0.35rem; position: relative; z-index: 1; }
        .modal-close-v { background: rgba(255,255,255,0.15); border: none; color: white; width: 40px; height: 40px; border-radius: 12px; cursor: pointer; font-size: 1.35rem; transition: all 0.2s; position: relative; z-index: 1; display: flex; align-items: center; justify-content: center; }
        .modal-close-v:hover { background: rgba(255,255,255,0.25); transform: rotate(90deg); }
        
        .modal-body-v { padding: 2rem; overflow-y: auto; flex: 1; }
        
        /* Preview Section */
        .preview-section { background: linear-gradient(135deg, #f8fafc, #f0fdf4); border-radius: 20px; padding: 1.5rem; margin-bottom: 1.75rem; display: flex; align-items: center; gap: 1.25rem; border: 1px solid rgba(2, 115, 94, 0.1); }
        .preview-icon { width: 72px; height: 72px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 2rem; transition: all 0.3s ease; }
        .preview-icon.fa-icon { background: linear-gradient(135deg, #022326, #02735E); color: white; }
        .preview-icon.fa-icon i { color: white; }
        .preview-icon.emoji { background: white; font-size: 2.5rem; border: 2px solid #e2e8f0; }
        .preview-icon.empty { background: #e2e8f0; color: #94a3b8; }
        .preview-info h4 { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-bottom: 0.25rem; }
        .preview-info p { font-size: 0.8rem; color: #64748b; }
        .preview-badge { margin-left: auto; background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; color: #02735E; border: 1px solid rgba(2, 115, 94, 0.2); }
        
        /* Form Elements */
        .form-group-v { margin-bottom: 1.5rem; }
        .form-label-v { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; color: #1e293b; margin-bottom: 0.65rem; }
        .form-label-v .required { color: #ef4444; }
        .form-input-v { width: 100%; padding: 1rem 1.15rem; border: 2px solid #e2e8f0; border-radius: 14px; font-size: 0.95rem; color: #1e293b; background: white; transition: all 0.25s ease; font-family: inherit; }
        .form-input-v:focus { outline: none; border-color: #02735E; box-shadow: 0 0 0 4px rgba(2, 115, 94, 0.1); }
        .form-input-v::placeholder { color: #94a3b8; }
        
        /* Section Title */
        .section-title { font-size: 0.8rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .section-title i { color: #02735E; font-size: 0.75rem; }
        
        /* Icon Picker */
        .icon-picker { display: grid; grid-template-columns: repeat(8, 1fr); gap: 0.5rem; padding: 1rem; background: #f8fafc; border-radius: 16px; border: 2px solid #e2e8f0; max-height: 200px; overflow-y: auto; }
        .icon-option { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; font-size: 1.15rem; background: white; border: 2px solid transparent; transition: all 0.2s; }
        .icon-option:hover { border-color: #02735E; background: #f0fdf4; transform: scale(1.1); }
        .icon-option.selected { background: linear-gradient(135deg, #022326, #02735E); color: white; border-color: transparent; box-shadow: 0 4px 15px rgba(2, 115, 94, 0.3); }
        .icon-option.selected i { color: white; }
        .icon-option i { color: #64748b; transition: color 0.2s; }
        
        /* Color Picker */
        .color-picker-container { display: flex; gap: 0.65rem; flex-wrap: wrap; padding: 1rem; background: #f8fafc; border-radius: 16px; border: 2px solid #e2e8f0; }
        .color-option { width: 44px; height: 44px; border-radius: 12px; cursor: pointer; border: 3px solid transparent; transition: all 0.25s; position: relative; }
        .color-option:hover { transform: scale(1.15); }
        .color-option.selected { border-color: white; box-shadow: 0 0 0 3px #1e293b, 0 4px 15px rgba(0,0,0,0.2); transform: scale(1.1); }
        .color-option::after { content: ''; position: absolute; inset: 0; border-radius: 9px; opacity: 0; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E") center/16px no-repeat; transition: opacity 0.2s; }
        .color-option.selected::after { opacity: 1; }
        
        /* Custom Icon Input */
        .custom-input-group { display: flex; gap: 0.75rem; margin-top: 0.75rem; }
        .custom-input-group .form-input-v { flex: 1; }
        .custom-input-group .btn-test { padding: 0 1.25rem; background: linear-gradient(135deg, #022326, #02735E); color: white; border: none; border-radius: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .custom-input-group .btn-test:hover { box-shadow: 0 4px 15px rgba(2, 115, 94, 0.3); }
        .custom-input-group .btn-test i { color: white; }
        
        .modal-footer-v { padding: 1.5rem 2rem; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; gap: 0.75rem; justify-content: flex-end; }
        .btn-verdi { display: inline-flex; align-items: center; gap: 0.5rem; padding: 1rem 1.75rem; background: linear-gradient(135deg, #022326, #02735E); color: white; border: none; border-radius: 14px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.25s ease; font-family: inherit; }
        .btn-verdi:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(2, 115, 94, 0.35); }
        .btn-verdi i { color: white; }
        .btn-verdi-outline { display: inline-flex; align-items: center; gap: 0.5rem; padding: 1rem 1.5rem; background: white; color: #64748b; border: 2px solid #e2e8f0; border-radius: 14px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.25s ease; font-family: inherit; }
        .btn-verdi-outline:hover { background: #f8fafc; border-color: #cbd5e1; color: #1e293b; }
        
        /* Delete Modal */
        .delete-modal .modal-v { max-width: 420px; }
        .delete-modal .modal-header-v { background: linear-gradient(135deg, #dc2626, #ef4444); }
        .delete-icon { width: 80px; height: 80px; margin: 0 auto 1.5rem; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .delete-icon i { font-size: 2rem; color: #dc2626; }
        .delete-content { text-align: center; }
        .delete-content h4 { font-size: 1.15rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem; }
        .delete-content p { font-size: 0.9rem; color: #64748b; }
        .delete-content .name { color: #dc2626; font-weight: 700; }
        .btn-danger { display: inline-flex; align-items: center; gap: 0.5rem; padding: 1rem 1.5rem; background: linear-gradient(135deg, #dc2626, #ef4444); color: white; border: none; border-radius: 14px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.25s ease; font-family: inherit; }
        .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(239, 68, 68, 0.35); }
        .btn-danger i { color: white; }
    </style>
</head>
<body>
    <div class="app-shell">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <header class="page-header">
                <div class="page-header-content">
                    <h1 class="page-title">Cat치logo de Industrias</h1>
                    <p class="page-subtitle">Gestiona las industrias disponibles para tus clientes</p>
                </div>
            </header>
            <div class="page-content">
                <nav class="settings-nav">
                    <a href="general.html" class="settings-nav-item"><i class="fas fa-cog"></i> General</a>
                    <a href="industries.html" class="settings-nav-item active"><i class="fas fa-industry"></i> Industrias</a>
                    <a href="products.html" class="settings-nav-item"><i class="fas fa-box"></i> Productos</a>
                    <a href="plans.html" class="settings-nav-item"><i class="fas fa-credit-card"></i> Planes</a>
                    <a href="integrations.html" class="settings-nav-item"><i class="fas fa-plug"></i> Integraciones</a>
                </nav>
                
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-industry"></i></div>
                        <div class="stat-info">
                            <h4 id="totalIndustries">0</h4>
                            <p>Total industrias</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-building"></i></div>
                        <div class="stat-info">
                            <h4 id="totalCompanies">0</h4>
                            <p>Compa침칤as activas</p>
                        </div>
                    </div>
                </div>
                
                <div class="industry-grid" id="industriesGrid"></div>
            </div>
        </main>
    </div>
    
    <!-- Enhanced Modal -->
    <div class="modal-overlay" id="industryModal">
        <div class="modal-v">
            <div class="modal-header-v">
                <div>
                    <h3 id="modalTitle"><i class="fas fa-plus-circle"></i> Nueva Industria</h3>
                    <p id="modalSubtitle">Crea una nueva categor칤a de industria para tus clientes</p>
                </div>
                <button class="modal-close-v" onclick="closeModal()">칑</button>
            </div>
            <div class="modal-body-v">
                <input type="hidden" id="editingKey">
                
                <!-- Live Preview -->
                <div class="preview-section">
                    <div class="preview-icon empty" id="previewIcon">
                        <i class="fas fa-question"></i>
                    </div>
                    <div class="preview-info">
                        <h4 id="previewName">Nombre de industria</h4>
                        <p>Vista previa en tiempo real</p>
                    </div>
                    <span class="preview-badge">Preview</span>
                </div>
                
                <!-- Name Input -->
                <div class="form-group-v">
                    <label class="form-label-v">
                        <i class="fas fa-tag"></i> Nombre de la industria <span class="required">*</span>
                    </label>
                    <input type="text" class="form-input-v" id="industryName" placeholder="Ej: Tecnolog칤a, Construcci칩n, Salud..." oninput="updatePreview()">
                </div>
                
                <!-- Icon Selection -->
                <div class="form-group-v">
                    <div class="section-title"><i class="fas fa-icons"></i> Selecciona un icono</div>
                    <div class="icon-picker" id="iconPicker"></div>
                    <input type="hidden" id="selectedIcon">
                </div>
                
                <!-- Color Selection -->
                <div class="form-group-v">
                    <div class="section-title"><i class="fas fa-palette"></i> Color del icono</div>
                    <div class="color-picker-container" id="colorPicker"></div>
                    <input type="hidden" id="selectedColor" value="#02735E">
                </div>
            </div>
            <div class="modal-footer-v">
                <button class="btn-verdi-outline" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-verdi" onclick="saveIndustry()">
                    <i class="fas fa-check"></i> Guardar Industria
                </button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay delete-modal" id="deleteModal">
        <div class="modal-v">
            <div class="modal-header-v">
                <div>
                    <h3><i class="fas fa-exclamation-triangle"></i> Eliminar Industria</h3>
                    <p>Esta acci칩n no se puede deshacer</p>
                </div>
                <button class="modal-close-v" onclick="closeDeleteModal()">칑</button>
            </div>
            <div class="modal-body-v">
                <div class="delete-icon">
                    <i class="fas fa-trash-alt"></i>
                </div>
                <div class="delete-content">
                    <h4>쮼st치s seguro?</h4>
                    <p>Vas a eliminar la industria <span class="name" id="deleteIndustryName"></span></p>
                    <p style="margin-top: 0.5rem; font-size: 0.8rem;">Esto eliminar치 permanentemente la industria del cat치logo.</p>
                </div>
                <input type="hidden" id="deleteKey">
            </div>
            <div class="modal-footer-v" style="justify-content: center;">
                <button class="btn-verdi-outline" onclick="closeDeleteModal()">
                    <i class="fas fa-arrow-left"></i> Cancelar
                </button>
                <button class="btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> S칤, eliminar
                </button>
            </div>
        </div>
    </div>
    
    <script src="../js/sidebar.js"></script>
    <script src="../js/supabase-loader.js"></script>
<script src="../js/data.js"></script>
    <script>
        const STORAGE_KEY = 'opsis_industries';
        
        const availableIcons = [
            'fas fa-hard-hat', 'fas fa-hospital', 'fas fa-truck', 'fas fa-shopping-cart',
            'fas fa-leaf', 'fas fa-laptop-code', 'fas fa-graduation-cap', 'fas fa-utensils',
            'fas fa-home', 'fas fa-car', 'fas fa-cog', 'fas fa-building', 'fas fa-industry',
            'fas fa-plane', 'fas fa-ship', 'fas fa-warehouse', 'fas fa-store', 'fas fa-hotel',
            'fas fa-briefcase', 'fas fa-gem', 'fas fa-paint-brush', 'fas fa-camera',
            'fas fa-music', 'fas fa-film', 'fas fa-book', 'fas fa-flask', 'fas fa-microscope',
            'fas fa-heartbeat', 'fas fa-dumbbell', 'fas fa-spa', 'fas fa-seedling'
        ];
        
        const availableColors = [
            '#022326', '#034040', '#035951', '#02735E', '#10b981'
        ];
        
        let currentColor = '#02735E';
        
        // Colores Verdi v치lidos
        const verdiColors = ['#022326', '#034040', '#035951', '#02735E', '#10b981'];
        
        document.addEventListener('DOMContentLoaded', async () => {
            await SuperAdminData.ready;
            initIconPicker();
            initColorPicker();
            migrateToVerdiColors(); // Migrar colores existentes
            loadIndustries();
        });
        
        // Migrar industrias existentes a colores Verdi
        function migrateToVerdiColors() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (!stored) return;
            
            const industries = JSON.parse(stored);
            let needsUpdate = false;
            
            Object.keys(industries).forEach((key, index) => {
                const ind = industries[key];
                if (!verdiColors.includes(ind.color)) {
                    // Asignar un color Verdi en rotaci칩n
                    ind.color = verdiColors[index % verdiColors.length];
                    needsUpdate = true;
                }
            });
            
            if (needsUpdate) {
                saveToStorage(industries);
            }
        }
        
        function getIndustries() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) return JSON.parse(stored);
            const defaults = { ...SuperAdminData.industries };
            saveToStorage(defaults);
            return defaults;
        }
        
        function saveToStorage(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            SuperAdminData.industries = data;
        }
        
        function countCompaniesForIndustry(industryKey) {
            if (!SuperAdminData.companies) return 0;
            return SuperAdminData.companies.filter(c => c.industry === industryKey).length;
        }
        
        function loadIndustries() {
            const industries = getIndustries();
            const grid = document.getElementById('industriesGrid');
            
            let totalCompanies = 0;
            Object.keys(industries).forEach(key => {
                const count = countCompaniesForIndustry(key);
                industries[key].companies = count;
                totalCompanies += count;
            });
            
            document.getElementById('totalIndustries').textContent = Object.keys(industries).length;
            document.getElementById('totalCompanies').textContent = totalCompanies;
            
            let html = `
                <div class="add-card" onclick="openModal()">
                    <div class="add-card-icon"><i class="fas fa-plus"></i></div>
                    <h4>Nueva Industria</h4>
                    <p>Agregar al cat치logo</p>
                </div>
            `;
            
            Object.entries(industries).forEach(([key, ind]) => {
                const isFaIcon = ind.icon && ind.icon.includes('fa-');
                const companiesCount = ind.companies || 0;
                const canDelete = companiesCount === 0;
                const color = ind.color || '#02735E';
                const colorLight = adjustColor(color, 40);
                
                html += `
                    <div class="industry-card" style="--card-color: ${color}; --card-color-light: ${colorLight};">
                        <div class="industry-card-header">
                            <div class="industry-icon ${isFaIcon ? 'fa-icon' : 'emoji'}" style="${isFaIcon ? 'background: linear-gradient(135deg, ' + color + ', ' + colorLight + ')' : ''}">
                                ${isFaIcon ? '<i class="' + ind.icon + '"></i>' : (ind.icon || '游닍')}
                            </div>
                            <div class="industry-info">
                                <h4>${escapeHtml(ind.name)}</h4>
                                <div class="count">
                                    <i class="fas fa-building"></i> ${companiesCount} compa침칤a${companiesCount !== 1 ? 's' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="industry-actions">
                            <button class="btn-action edit" onclick="editIndustry('${key}')">
                                <i class="fas fa-pen"></i> Editar
                            </button>
                            ${canDelete ? `
                                <button class="btn-action delete" onclick="openDeleteModal('${key}')">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        function adjustColor(color, amount) {
            const num = parseInt(color.replace('#', ''), 16);
            const r = Math.min(255, (num >> 16) + amount);
            const g = Math.min(255, ((num >> 8) & 0x00FF) + amount);
            const b = Math.min(255, (num & 0x0000FF) + amount);
            return '#' + (b | (g << 8) | (r << 16)).toString(16).padStart(6, '0');
        }
        
        function initIconPicker() {
            const picker = document.getElementById('iconPicker');
            picker.innerHTML = availableIcons.map(icon => `
                <div class="icon-option" data-icon="${icon}" onclick="selectIcon(this, '${icon}')">
                    <i class="${icon}"></i>
                </div>
            `).join('');
        }
        
        function selectIcon(el, icon) {
            document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('selectedIcon').value = icon;
            document.getElementById('customIcon').value = '';
            updatePreview();
        }
        
        function initColorPicker() {
            const picker = document.getElementById('colorPicker');
            picker.innerHTML = availableColors.map((color, i) => `
                <div class="color-option ${i === 3 ? 'selected' : ''}" style="background: ${color};" data-color="${color}" onclick="selectColor(this, '${color}')"></div>
            `).join('');
        }
        
        function selectColor(el, color) {
            document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('selectedColor').value = color;
            currentColor = color;
            updatePreview();
        }
        
        function updatePreview() {
            const name = document.getElementById('industryName').value.trim() || 'Nombre de industria';
            const customIcon = document.getElementById('customIcon').value.trim();
            const selectedIcon = document.getElementById('selectedIcon').value;
            const color = document.getElementById('selectedColor').value;
            
            document.getElementById('previewName').textContent = name;
            
            const previewEl = document.getElementById('previewIcon');
            const icon = customIcon || selectedIcon;
            
            if (icon && icon.includes('fa-')) {
                previewEl.className = 'preview-icon fa-icon';
                previewEl.innerHTML = '<i class="' + icon + '"></i>';
                previewEl.style.background = `linear-gradient(135deg, ${color}, ${adjustColor(color, 40)})`;
            } else if (icon) {
                previewEl.className = 'preview-icon emoji';
                previewEl.innerHTML = icon;
                previewEl.style.background = '';
            } else {
                previewEl.className = 'preview-icon empty';
                previewEl.innerHTML = '<i class="fas fa-question"></i>';
                previewEl.style.background = '';
            }
        }
        
        function testCustomIcon() {
            document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
            document.getElementById('selectedIcon').value = '';
            updatePreview();
        }
        
        function openModal(editKey = null) {
            const modal = document.getElementById('industryModal');
            const title = document.getElementById('modalTitle');
            const subtitle = document.getElementById('modalSubtitle');
            
            // Reset
            document.getElementById('industryName').value = '';
            document.getElementById('customIcon').value = '';
            document.getElementById('selectedIcon').value = '';
            document.getElementById('editingKey').value = '';
            document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
            document.querySelectorAll('.color-option').forEach((o, i) => o.classList.toggle('selected', i === 3));
            document.getElementById('selectedColor').value = '#02735E';
            currentColor = '#02735E';
            
            if (editKey) {
                const industries = getIndustries();
                const ind = industries[editKey];
                if (ind) {
                    title.innerHTML = '<i class="fas fa-pen-to-square"></i> Editar Industria';
                    subtitle.textContent = 'Modifica los detalles de esta industria';
                    document.getElementById('industryName').value = ind.name;
                    document.getElementById('editingKey').value = editKey;
                    
                    if (ind.icon && ind.icon.includes('fa-')) {
                        const iconEl = document.querySelector(`.icon-option[data-icon="${ind.icon}"]`);
                        if (iconEl) {
                            iconEl.classList.add('selected');
                            document.getElementById('selectedIcon').value = ind.icon;
                        } else {
                            document.getElementById('customIcon').value = ind.icon;
                        }
                    } else {
                        document.getElementById('customIcon').value = ind.icon || '';
                    }
                    
                    if (ind.color) {
                        const colorEl = document.querySelector(`.color-option[data-color="${ind.color}"]`);
                        if (colorEl) {
                            document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                            colorEl.classList.add('selected');
                            document.getElementById('selectedColor').value = ind.color;
                            currentColor = ind.color;
                        }
                    }
                }
            } else {
                title.innerHTML = '<i class="fas fa-plus-circle"></i> Nueva Industria';
                subtitle.textContent = 'Crea una nueva categor칤a de industria para tus clientes';
            }
            
            updatePreview();
            modal.classList.add('active');
            setTimeout(() => document.getElementById('industryName').focus(), 100);
        }
        
        function closeModal() {
            document.getElementById('industryModal').classList.remove('active');
        }
        
        function editIndustry(key) {
            openModal(key);
        }
        
        function saveIndustry() {
            const name = document.getElementById('industryName').value.trim();
            const customIcon = document.getElementById('customIcon').value.trim();
            const selectedIcon = document.getElementById('selectedIcon').value;
            const color = document.getElementById('selectedColor').value;
            const editingKey = document.getElementById('editingKey').value;
            
            if (!name) {
                showToast('El nombre es requerido', 'error');
                document.getElementById('industryName').focus();
                return;
            }
            
            const icon = customIcon || selectedIcon;
            if (!icon) {
                showToast('Selecciona o escribe un icono', 'error');
                return;
            }
            
            const industries = getIndustries();
            
            let key = editingKey;
            if (!key) {
                key = name.toLowerCase()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .replace(/\s+/g, '_')
                    .replace(/[^a-z0-9_]/g, '');
                
                let baseKey = key;
                let counter = 1;
                while (industries[key]) {
                    key = baseKey + '_' + counter;
                    counter++;
                }
            }
            
            industries[key] = {
                name: name,
                icon: icon,
                color: color,
                companies: industries[key]?.companies || 0
            };
            
            saveToStorage(industries);
            closeModal();
            loadIndustries();
            showToast(editingKey ? `"${name}" actualizada` : `"${name}" agregada`, 'success');
        }
        
        function openDeleteModal(key) {
            const industries = getIndustries();
            const ind = industries[key];
            if (!ind) return;
            
            document.getElementById('deleteIndustryName').textContent = '"' + ind.name + '"';
            document.getElementById('deleteKey').value = key;
            document.getElementById('deleteModal').classList.add('active');
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }
        
        function confirmDelete() {
            const key = document.getElementById('deleteKey').value;
            const industries = getIndustries();
            const name = industries[key]?.name || key;
            
            delete industries[key];
            saveToStorage(industries);
            
            closeDeleteModal();
            loadIndustries();
            showToast(`"${name}" eliminada`, 'success');
        }
        
        function showToast(msg, type = 'success') {
            const t = document.createElement('div');
            const bg = type === 'success' ? 'linear-gradient(135deg, #02735E, #10b981)' : 
                       type === 'error' ? 'linear-gradient(135deg, #dc2626, #ef4444)' : 
                       'linear-gradient(135deg, #034040, #035951)';
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle';
            t.innerHTML = '<i class="fas fa-' + icon + '" style="color:white"></i> ' + escapeHtml(msg);
            t.style.cssText = 'position:fixed;top:20px;right:20px;padding:1rem 1.5rem;background:' + bg + ';color:white;border-radius:14px;display:flex;align-items:center;gap:0.75rem;font-weight:600;box-shadow:0 10px 40px rgba(0,0,0,0.2);z-index:99999;font-family:Inter,sans-serif;animation:slideIn 0.4s cubic-bezier(0.4,0,0.2,1);';
            document.body.appendChild(t);
            setTimeout(() => {
                t.style.opacity = '0';
                t.style.transform = 'translateX(20px)';
                t.style.transition = 'all 0.3s ease';
                setTimeout(() => t.remove(), 300);
            }, 3000);
        }
        
        document.getElementById('industryModal').addEventListener('click', e => {
            if (e.target.id === 'industryModal') closeModal();
        });
        document.getElementById('deleteModal').addEventListener('click', e => {
            if (e.target.id === 'deleteModal') closeDeleteModal();
        });
        
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                closeModal();
                closeDeleteModal();
            }
        });
    </script>
</body>
</html>
