<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturas - SuperAdmin | Opsis Suite</title>
    <style>
        :root { --verdi-dark: #022326; --sidebar-width: 240px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { background: #f8fafc; }
        body { opacity: 0; transition: opacity 0.15s ease-in; }
        body.loaded { opacity: 1; }
        .app-shell { min-height: 100vh; background: #f8fafc; }
        .sidebar { position: fixed; left: 0; top: 0; width: var(--sidebar-width); height: 100vh; background: var(--verdi-dark); }
        .main-content { margin-left: var(--sidebar-width); min-height: 100vh; background: #f8fafc; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/superadmin.css?v=7">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="app-shell">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <h1 class="page-title">Facturas</h1>
                    <p class="page-subtitle">Gestión de facturas y cobros</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="exportInvoices()">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                    <button class="btn btn-primary" onclick="openNewInvoiceModal()">
                        <i class="fas fa-plus"></i> Nueva Factura
                    </button>
                </div>
            </header>

            <div class="page-content">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalInvoices">0</div>
                            <div class="stat-label">Facturas este mes</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">$<span id="totalPaid">0</span></div>
                            <div class="stat-label">Cobrado</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">$<span id="totalPending">0</span></div>
                            <div class="stat-label">Pendiente</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon danger">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalOverdue">0</div>
                            <div class="stat-label">Vencidas</div>
                        </div>
                    </div>
                </div>

                <!-- Invoice Charts Row -->
                <div class="grid-2" style="margin-bottom: 1.5rem; gap: 1.5rem;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-chart-bar"></i> Cobros por Mes</h3>
                        </div>
                        <div class="card-body" style="height: 220px;">
                            <canvas id="invoiceChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-chart-pie"></i> Estado de Facturas</h3>
                        </div>
                        <div class="card-body" style="height: 220px;">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Aging Report -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-clock"></i> Antigüedad de Cuentas por Cobrar</h3>
                    </div>
                    <div class="card-body">
                        <div id="agingReport" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div class="search-box" style="flex: 1; min-width: 200px;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="Buscar factura..." oninput="filterInvoices()">
                        </div>
                        <select class="filter-select" id="statusFilter" onchange="filterInvoices()">
                            <option value="">Todas las facturas</option>
                            <option value="paid">Pagadas</option>
                            <option value="pending">Pendientes</option>
                            <option value="overdue">Vencidas</option>
                        </select>
                        <select class="filter-select" id="dateFilter" onchange="filterInvoices()">
                            <option value="month">Este mes</option>
                            <option value="quarter">Últimos 3 meses</option>
                            <option value="year">Este año</option>
                        </select>
                    </div>
                </div>

                <!-- Invoices Table -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list"></i> Listado de Facturas
                        </h3>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nº Factura</th>
                                    <th>Cliente</th>
                                    <th>Concepto</th>
                                    <th>Monto</th>
                                    <th>Fecha</th>
                                    <th>Vencimiento</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- New Invoice Modal -->
    <div class="modal-overlay" id="newInvoiceModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice"></i> Nueva Factura</h3>
                <button class="modal-close" onclick="closeModal('newInvoiceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="newInvoiceForm">
                    <div class="form-group">
                        <label>Cliente</label>
                        <select id="invoiceCompany" required>
                            <option value="">Seleccionar cliente...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Concepto</label>
                        <input type="text" id="invoiceConcept" placeholder="Ej: Suscripción mensual" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Monto ($)</label>
                            <input type="number" id="invoiceAmount" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha de Vencimiento</label>
                            <input type="date" id="invoiceDueDate" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('newInvoiceModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="createInvoice()">
                    <i class="fas fa-save"></i> Crear Factura
                </button>
            </div>
        </div>
    </div>

    <!-- Invoice Detail Modal -->
    <div class="modal-overlay" id="invoiceDetailModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice-dollar"></i> Detalle de Factura</h3>
                <button class="modal-close" onclick="closeModal('invoiceDetailModal')">&times;</button>
            </div>
            <div class="modal-body" id="invoiceDetailContent">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('invoiceDetailModal')">Cerrar</button>
                <button class="btn btn-primary" id="invoiceActionBtn">
                    <i class="fas fa-download"></i> Descargar PDF
                </button>
            </div>
        </div>
    </div>

    <script src="../js/sidebar.js"></script>
    <script src="../js/data.js"></script>
    <script>
        // Ensure page is visible
        document.body.classList.add('loaded');
        
        let allInvoices = [];
        let invoiceChart = null;
        let statusChart = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            loadInvoices();
            populateCompanySelect();
            setDefaultDueDate();
            initCharts();
            renderAgingReport();
        });

        function loadInvoices() {
            allInvoices = SuperAdminData.getInvoices();
            updateStats();
            renderInvoices(allInvoices);
        }

        function updateStats() {
            const paid = allInvoices.filter(i => i.status === 'paid');
            const pending = allInvoices.filter(i => i.status === 'pending');
            const overdue = allInvoices.filter(i => i.status === 'overdue' || (i.status === 'pending' && new Date(i.dueDate) < new Date()));
            
            document.getElementById('totalInvoices').textContent = allInvoices.length;
            document.getElementById('totalPaid').textContent = paid.reduce((sum, i) => sum + i.amount, 0).toLocaleString();
            document.getElementById('totalPending').textContent = pending.reduce((sum, i) => sum + i.amount, 0).toLocaleString();
            document.getElementById('totalOverdue').textContent = overdue.length;
        }
        
        function initCharts() {
            // Invoice amounts by month
            const ctx1 = document.getElementById('invoiceChart').getContext('2d');
            const monthlyData = getMonthlyInvoiceData();
            
            invoiceChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        label: 'Cobrado',
                        data: monthlyData.paid,
                        backgroundColor: '#22c55e',
                        borderRadius: 4
                    }, {
                        label: 'Pendiente',
                        data: monthlyData.pending,
                        backgroundColor: '#f59e0b',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { callback: val => '$' + val }
                        }
                    }
                }
            });
            
            // Status pie chart
            const ctx2 = document.getElementById('statusChart').getContext('2d');
            const paid = allInvoices.filter(i => i.status === 'paid').reduce((s, i) => s + i.amount, 0);
            const pending = allInvoices.filter(i => i.status === 'pending' && new Date(i.dueDate) >= new Date()).reduce((s, i) => s + i.amount, 0);
            const overdue = allInvoices.filter(i => i.status === 'pending' && new Date(i.dueDate) < new Date()).reduce((s, i) => s + i.amount, 0);
            
            statusChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Pagadas', 'Pendientes', 'Vencidas'],
                    datasets: [{
                        data: [paid, pending, overdue],
                        backgroundColor: ['#22c55e', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.label}: $${ctx.raw.toLocaleString()}`
                            }
                        }
                    }
                }
            });
        }
        
        function getMonthlyInvoiceData() {
            const now = new Date();
            const labels = [];
            const paid = [];
            const pending = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                labels.push(date.toLocaleDateString('es-ES', { month: 'short' }));
                
                const monthInvoices = allInvoices.filter(inv => {
                    const invDate = new Date(inv.date);
                    return invDate.getMonth() === date.getMonth() && invDate.getFullYear() === date.getFullYear();
                });
                
                paid.push(monthInvoices.filter(i => i.status === 'paid').reduce((s, i) => s + i.amount, 0));
                pending.push(monthInvoices.filter(i => i.status === 'pending').reduce((s, i) => s + i.amount, 0));
            }
            
            return { labels, paid, pending };
        }
        
        function renderAgingReport() {
            const now = new Date();
            const buckets = [
                { label: '0-30 días', days: 30, amount: 0, color: '#22c55e' },
                { label: '31-60 días', days: 60, amount: 0, color: '#f59e0b' },
                { label: '61-90 días', days: 90, amount: 0, color: '#fb923c' },
                { label: '90+ días', days: Infinity, amount: 0, color: '#ef4444' }
            ];
            
            allInvoices.filter(i => i.status === 'pending').forEach(inv => {
                const invDate = new Date(inv.date);
                const daysOld = Math.floor((now - invDate) / (1000 * 60 * 60 * 24));
                
                if (daysOld <= 30) buckets[0].amount += inv.amount;
                else if (daysOld <= 60) buckets[1].amount += inv.amount;
                else if (daysOld <= 90) buckets[2].amount += inv.amount;
                else buckets[3].amount += inv.amount;
            });
            
            document.getElementById('agingReport').innerHTML = buckets.map(b => `
                <div style="background: ${b.color}10; border: 1px solid ${b.color}30; border-radius: 12px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">${b.label}</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: ${b.color};">$${b.amount.toLocaleString()}</div>
                </div>
            `).join('');
        }

        function renderInvoices(invoices) {
            const tbody = document.getElementById('invoicesTable');
            
            if (invoices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <i class="fas fa-file-invoice" style="font-size: 2rem; opacity: 0.5; display: block; margin-bottom: 1rem;"></i>
                            No hay facturas que mostrar
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = invoices.map(invoice => {
                const isOverdue = invoice.status === 'pending' && new Date(invoice.dueDate) < new Date();
                const status = isOverdue ? 'overdue' : invoice.status;
                const statusClass = status === 'paid' ? 'status-active' : status === 'pending' ? 'status-trial' : 'status-inactive';
                const statusText = status === 'paid' ? 'Pagada' : status === 'pending' ? 'Pendiente' : 'Vencida';
                
                return `
                    <tr>
                        <td><strong>INV-${String(invoice.id).padStart(4, '0')}</strong></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div class="avatar avatar-sm">${invoice.company.charAt(0)}</div>
                                <span>${invoice.company}</span>
                            </div>
                        </td>
                        <td>${invoice.concept}</td>
                        <td><strong>$${invoice.amount.toLocaleString()}</strong></td>
                        <td>${formatDate(invoice.date)}</td>
                        <td>${formatDate(invoice.dueDate)}</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-ghost" onclick="viewInvoice(${invoice.id})" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${status === 'paid' ? `
                                <button class="btn btn-sm btn-ghost" onclick="downloadInvoice(${invoice.id})" title="Descargar">
                                    <i class="fas fa-download"></i>
                                </button>
                            ` : status === 'pending' ? `
                                <button class="btn btn-sm btn-ghost" onclick="sendReminder(${invoice.id})" title="Enviar recordatorio">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                                <button class="btn btn-sm btn-ghost" onclick="markAsPaid(${invoice.id})" title="Marcar como pagada">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-ghost" onclick="sendReminder(${invoice.id})" title="Enviar recordatorio urgente">
                                    <i class="fas fa-bell"></i>
                                </button>
                                <button class="btn btn-sm btn-ghost" onclick="markAsPaid(${invoice.id})" title="Marcar como pagada">
                                    <i class="fas fa-check"></i>
                                </button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterInvoices() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filtered = [...allInvoices];
            
            if (search) {
                filtered = filtered.filter(i => 
                    i.company.toLowerCase().includes(search) ||
                    i.concept.toLowerCase().includes(search) ||
                    `INV-${String(i.id).padStart(4, '0')}`.toLowerCase().includes(search)
                );
            }
            
            if (statusFilter) {
                if (statusFilter === 'overdue') {
                    filtered = filtered.filter(i => i.status === 'pending' && new Date(i.dueDate) < new Date());
                } else {
                    filtered = filtered.filter(i => i.status === statusFilter);
                }
            }
            
            renderInvoices(filtered);
        }

        function populateCompanySelect() {
            const select = document.getElementById('invoiceCompany');
            const companies = SuperAdminData.getCompanies();
            select.innerHTML = '<option value="">Seleccionar cliente...</option>' +
                companies.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function setDefaultDueDate() {
            const dueDate = document.getElementById('invoiceDueDate');
            const date = new Date();
            date.setDate(date.getDate() + 15);
            dueDate.value = date.toISOString().split('T')[0];
        }

        function openNewInvoiceModal() {
            document.getElementById('newInvoiceModal').classList.add('active');
            document.getElementById('newInvoiceForm').reset();
            setDefaultDueDate();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function createInvoice() {
            const companyId = document.getElementById('invoiceCompany').value;
            const concept = document.getElementById('invoiceConcept').value;
            const amount = parseFloat(document.getElementById('invoiceAmount').value);
            const dueDate = document.getElementById('invoiceDueDate').value;
            
            if (!companyId || !concept || !amount || !dueDate) {
                showNotification('Por favor completa todos los campos', 'error');
                return;
            }
            
            const company = SuperAdminData.getCompany(companyId);
            
            const invoice = SuperAdminData.createInvoice({
                companyId: parseInt(companyId),
                company: company.name,
                concept: concept,
                amount: amount,
                dueDate: dueDate,
                date: new Date().toISOString().split('T')[0],
                status: 'pending'
            });
            
            closeModal('newInvoiceModal');
            loadInvoices();
            showNotification(`Factura INV-${String(invoice.id).padStart(4, '0')} creada exitosamente`, 'success');
        }

        function viewInvoice(id) {
            const invoice = allInvoices.find(i => i.id === id);
            if (!invoice) return;
            
            const isOverdue = invoice.status === 'pending' && new Date(invoice.dueDate) < new Date();
            const status = isOverdue ? 'Vencida' : invoice.status === 'paid' ? 'Pagada' : 'Pendiente';
            
            document.getElementById('invoiceDetailContent').innerHTML = `
                <div style="text-align: center; padding: 1rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem;">
                    <h2 style="color: var(--primary-color);">INV-${String(invoice.id).padStart(4, '0')}</h2>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-secondary);">Cliente</label>
                        <p style="font-weight: 600;">${invoice.company}</p>
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-secondary);">Monto</label>
                        <p style="font-weight: 700; font-size: 1.5rem; color: var(--primary-color);">$${invoice.amount.toLocaleString()}</p>
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-secondary);">Fecha de Emisión</label>
                        <p>${formatDate(invoice.date)}</p>
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-secondary);">Fecha de Vencimiento</label>
                        <p>${formatDate(invoice.dueDate)}</p>
                    </div>
                    <div style="grid-column: span 2;">
                        <label style="font-size: 0.75rem; color: var(--text-secondary);">Concepto</label>
                        <p>${invoice.concept}</p>
                    </div>
                    <div style="grid-column: span 2;">
                        <label style="font-size: 0.75rem; color: var(--text-secondary);">Estado</label>
                        <p><span class="status status-${isOverdue ? 'inactive' : invoice.status === 'paid' ? 'active' : 'trial'}">${status}</span></p>
                    </div>
                </div>
            `;
            
            const actionBtn = document.getElementById('invoiceActionBtn');
            if (invoice.status === 'paid') {
                actionBtn.innerHTML = '<i class="fas fa-download"></i> Descargar PDF';
                actionBtn.onclick = () => downloadInvoice(id);
            } else {
                actionBtn.innerHTML = '<i class="fas fa-check"></i> Marcar como Pagada';
                actionBtn.onclick = () => { markAsPaid(id); closeModal('invoiceDetailModal'); };
            }
            
            document.getElementById('invoiceDetailModal').classList.add('active');
        }

        function markAsPaid(id) {
            SuperAdminData.updateInvoice(id, { status: 'paid' });
            loadInvoices();
            showNotification('Factura marcada como pagada', 'success');
        }

        function sendReminder(id) {
            const invoice = allInvoices.find(i => i.id === id);
            if (!invoice) return;
            showNotification(`Recordatorio enviado a ${invoice.company}`, 'success');
        }

        function downloadInvoice(id) {
            const invoice = allInvoices.find(i => i.id === id);
            if (!invoice) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const invoiceNum = `INV-${String(invoice.id).padStart(4, '0')}`;
            const isOverdue = invoice.status === 'pending' && new Date(invoice.dueDate) < new Date();
            const statusText = isOverdue ? 'VENCIDA' : invoice.status === 'paid' ? 'PAGADA' : 'PENDIENTE';
            const statusColor = isOverdue ? [239, 68, 68] : invoice.status === 'paid' ? [16, 185, 129] : [245, 158, 11];
            
            // Header con gradiente verde
            doc.setFillColor(2, 115, 94);
            doc.rect(0, 0, 210, 45, 'F');
            
            // Logo y nombre de empresa
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('OPSIS SUITE', 20, 22);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Sistema de Gestión Empresarial', 20, 30);
            
            // Badge de factura
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(140, 12, 55, 22, 3, 3, 'F');
            doc.setTextColor(2, 115, 94);
            doc.setFontSize(9);
            doc.text('FACTURA', 167.5, 20, { align: 'center' });
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(invoiceNum, 167.5, 29, { align: 'center' });
            
            // Estado de la factura
            doc.setFillColor(...statusColor);
            doc.roundedRect(140, 50, 55, 10, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(statusText, 167.5, 57, { align: 'center' });
            
            // Información de fechas
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('Fecha de Emisión:', 20, 55);
            doc.text('Fecha de Vencimiento:', 20, 62);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(30, 30, 30);
            doc.text(formatDate(invoice.date), 60, 55);
            doc.text(formatDate(invoice.dueDate), 68, 62);
            
            // Línea separadora
            doc.setDrawColor(226, 232, 240);
            doc.setLineWidth(0.5);
            doc.line(20, 72, 190, 72);
            
            // Sección Cliente
            doc.setFillColor(248, 250, 252);
            doc.roundedRect(20, 78, 170, 30, 3, 3, 'F');
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text('FACTURAR A:', 25, 86);
            doc.setTextColor(30, 30, 30);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(invoice.company, 25, 96);
            
            // Tabla de concepto
            doc.setFillColor(2, 115, 94);
            doc.rect(20, 118, 170, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('CONCEPTO', 25, 125);
            doc.text('MONTO', 170, 125, { align: 'right' });
            
            // Fila de concepto
            doc.setFillColor(255, 255, 255);
            doc.rect(20, 128, 170, 15, 'F');
            doc.setDrawColor(226, 232, 240);
            doc.rect(20, 128, 170, 15, 'S');
            doc.setTextColor(30, 30, 30);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(invoice.concept, 25, 137);
            doc.setFont('helvetica', 'bold');
            doc.text('$' + invoice.amount.toLocaleString(), 170, 137, { align: 'right' });
            
            // Total
            doc.setFillColor(248, 250, 252);
            doc.rect(20, 148, 170, 18, 'F');
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('TOTAL A PAGAR', 25, 159);
            doc.setTextColor(2, 115, 94);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('$' + invoice.amount.toLocaleString(), 185, 160, { align: 'right' });
            
            // Información de pago
            doc.setFillColor(236, 253, 245);
            doc.roundedRect(20, 175, 170, 35, 3, 3, 'F');
            doc.setTextColor(5, 150, 105);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('INFORMACIÓN DE PAGO', 25, 185);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(60, 60, 60);
            doc.text('Banco: Banco Nacional', 25, 193);
            doc.text('Cuenta: 1234-5678-9012-3456', 25, 200);
            doc.text('Referencia: ' + invoiceNum, 110, 193);
            doc.text('SWIFT: BNATUS33', 110, 200);
            
            // Footer
            doc.setDrawColor(226, 232, 240);
            doc.line(20, 250, 190, 250);
            doc.setTextColor(150, 150, 150);
            doc.setFontSize(8);
            doc.text('Gracias por su preferencia', 105, 258, { align: 'center' });
            doc.text('www.opsis-suite.com | soporte@opsis-suite.com', 105, 264, { align: 'center' });
            doc.text('Documento generado automáticamente - ' + new Date().toLocaleDateString('es-ES'), 105, 270, { align: 'center' });
            
            // Descargar
            doc.save(`factura-${invoiceNum}.pdf`);
            showNotification('Factura PDF descargada', 'success');
        }

        function exportInvoices() {
            const csv = [
                ['Nº Factura', 'Cliente', 'Concepto', 'Monto', 'Fecha', 'Vencimiento', 'Estado'].join(','),
                ...allInvoices.map(i => [
                    `INV-${String(i.id).padStart(4, '0')}`,
                    `"${i.company}"`,
                    `"${i.concept}"`,
                    i.amount,
                    i.date,
                    i.dueDate,
                    i.status
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `facturas-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Facturas exportadas a CSV', 'success');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9999;
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100px)';
                notification.style.transition = 'all 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Close modal on outside click
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
