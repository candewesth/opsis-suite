<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturación - SuperAdmin | Opsis Suite</title>
    <style>
        :root { --verdi-dark: #022326; --sidebar-width: 240px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { background: #f8fafc; }
        body { opacity: 0; transition: opacity 0.15s ease-in; }
        body.loaded { opacity: 1; }
        .app-shell { min-height: 100vh; background: #f8fafc; }
        .sidebar { position: fixed; left: 0; top: 0; width: var(--sidebar-width); height: 100vh; background: var(--verdi-dark); }
        .main-content { margin-left: var(--sidebar-width); min-height: 100vh; background: #f8fafc; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/superadmin.css?v=7">
</head>
<body>
    <div class="app-shell">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <h1 class="page-title">Facturación y Revenue</h1>
                    <p class="page-subtitle">Métricas de ingresos y gestión de facturación</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="location.href='invoices.html'">
                        <i class="fas fa-file-invoice"></i> Ver Facturas
                    </button>
                    <button class="btn btn-primary">
                        <i class="fas fa-chart-bar"></i> Generar Reporte
                    </button>
                </div>
            </header>

            <div class="page-content">
                <!-- Revenue Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">$<span id="mrr">1,546</span></div>
                            <div class="stat-label">MRR (Ingreso Mensual)</div>
                        </div>
                        <span class="stat-trend up"><i class="fas fa-arrow-up"></i> +32%</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">$<span id="arr">18,552</span></div>
                            <div class="stat-label">ARR (Ingreso Anual)</div>
                        </div>
                        <span class="stat-trend up"><i class="fas fa-arrow-up"></i> +28%</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon info">
                            <i class="fas fa-bullseye"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">$<span id="arpu">309</span></div>
                            <div class="stat-label">ARPU (Promedio)</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-user-minus"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value"><span id="churn">2.1</span>%</div>
                            <div class="stat-label">Churn Rate</div>
                        </div>
                        <span class="stat-trend down"><i class="fas fa-arrow-down"></i> -2%</span>
                    </div>
                </div>

                <!-- Revenue by Plan -->
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-chart-pie"></i> Revenue por Plan</h3>
                        </div>
                        <div id="planBreakdown">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-chart-area"></i> Tendencia Mensual</h3>
                        </div>
                        <div class="chart-placeholder">
                            <i class="fas fa-chart-line"></i>
                            <p>Gráfico de tendencia</p>
                            <small>Conectar con Chart.js</small>
                        </div>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-credit-card"></i> Transacciones Recientes</h3>
                        <button class="btn btn-sm btn-secondary" onclick="location.href='invoices.html'">Ver todas</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Compañía</th>
                                    <th>Concepto</th>
                                    <th>Monto</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Revenue Breakdown by Industry -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-industry"></i> Revenue por Industria</h3>
                    </div>
                    <div id="industryRevenue" class="grid-3">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/sidebar.js"></script>
    <script src="../js/data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadBillingData();
        });

        function loadBillingData() {
            const totals = SuperAdminData.getTotals();
            
            // Update stats
            document.getElementById('mrr').textContent = totals.mrr.toLocaleString();
            document.getElementById('arr').textContent = (totals.mrr * 12).toLocaleString();
            document.getElementById('arpu').textContent = Math.round(totals.mrr / totals.companies).toLocaleString();
            
            // Plan breakdown
            const planCounts = {};
            const planRevenue = {};
            SuperAdminData.companies.forEach(company => {
                const plan = company.plan.toLowerCase();
                planCounts[plan] = (planCounts[plan] || 0) + 1;
                planRevenue[plan] = (planRevenue[plan] || 0) + company.mrr;
            });
            
            document.getElementById('planBreakdown').innerHTML = Object.entries(SuperAdminData.plans).map(([key, plan]) => {
                const count = planCounts[key] || 0;
                const revenue = planRevenue[key] || 0;
                const percentage = totals.mrr > 0 ? Math.round((revenue / totals.mrr) * 100) : 0;
                
                return `
                    <div class="plan-item">
                        <div class="plan-icon" style="background: ${plan.color}20; color: ${plan.color};">
                            ${key.charAt(0).toUpperCase()}
                        </div>
                        <div class="plan-info">
                            <div class="plan-name">${plan.name}</div>
                            <div class="plan-count">${count} compañías</div>
                        </div>
                        <div class="plan-revenue">
                            <div class="plan-amount">$${revenue.toLocaleString()}</div>
                            <div class="plan-percentage">${percentage}%</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Recent transactions (mock data)
            const transactions = [
                { date: '2024-12-11', company: 'Jardines Verdes', concept: 'Pago mensual - Professional', amount: 399, status: 'completed' },
                { date: '2024-12-10', company: 'Constructora ABC', concept: 'Pago mensual - Professional', amount: 299, status: 'completed' },
                { date: '2024-12-10', company: 'Clínica San José', concept: 'Pago mensual - Enterprise', amount: 499, status: 'completed' },
                { date: '2024-12-09', company: 'Transportes del Norte', concept: 'Pago mensual - Professional', amount: 349, status: 'completed' },
                { date: '2024-12-01', company: 'Supermercados La Familia', concept: 'Inicio Trial', amount: 0, status: 'trial' }
            ];
            
            document.getElementById('transactionsTable').innerHTML = transactions.map(tx => `
                <tr>
                    <td>${tx.date}</td>
                    <td><strong>${tx.company}</strong></td>
                    <td>${tx.concept}</td>
                    <td><strong style="color: var(--primary-green);">$${tx.amount}</strong></td>
                    <td><span class="status status-${tx.status === 'completed' ? 'active' : 'trial'}">${tx.status === 'completed' ? 'Completado' : 'Trial'}</span></td>
                </tr>
            `).join('');
            
            // Industry revenue
            const industryRevenue = {};
            SuperAdminData.companies.forEach(company => {
                industryRevenue[company.industry] = (industryRevenue[company.industry] || 0) + company.mrr;
            });
            
            document.getElementById('industryRevenue').innerHTML = Object.entries(SuperAdminData.industries)
                .filter(([key]) => industryRevenue[key] > 0)
                .map(([key, industry]) => `
                    <div class="industry-card">
                        <div class="industry-icon"><i class="${getIndustryIcon(key)}"></i></div>
                        <div class="industry-name">${industry.name}</div>
                        <div class="industry-revenue">$${industryRevenue[key].toLocaleString()}</div>
                    </div>
                `).join('');
        }

        function getIndustryIcon(key) {
            const icons = {
                construccion: 'fas fa-hard-hat',
                medica: 'fas fa-hospital',
                transporte: 'fas fa-truck',
                retail: 'fas fa-shopping-cart',
                jardineria: 'fas fa-leaf',
                tecnologia: 'fas fa-laptop-code',
                educacion: 'fas fa-graduation-cap',
                alimentos: 'fas fa-utensils'
            };
            return icons[key] || 'fas fa-building';
        }
    </script>
</body>
</html>
