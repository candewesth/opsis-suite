<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suscripciones - SuperAdmin | Opsis Suite</title>
    <style>
        :root { --verdi-dark: #022326; --sidebar-width: 240px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { background: #f8fafc; }
        body { opacity: 0; transition: opacity 0.15s ease-in; }
        body.loaded { opacity: 1; }
        .app-shell { min-height: 100vh; background: #f8fafc; }
        .sidebar { position: fixed; left: 0; top: 0; width: var(--sidebar-width); height: 100vh; background: var(--verdi-dark); }
        .main-content { margin-left: var(--sidebar-width); min-height: 100vh; background: #f8fafc; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/superadmin.css?v=7">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app-shell">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <h1 class="page-title">Suscripciones</h1>
                    <p class="page-subtitle">Gestión de planes y suscripciones activas</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="exportToCSV()">
                        <i class="fas fa-file-csv"></i> Exportar
                    </button>
                    <button class="btn btn-primary" onclick="openUpgradeModal()">
                        <i class="fas fa-arrow-up"></i> Cambiar Plan
                    </button>
                </div>
            </header>

            <div class="page-content">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="activeCount">0</div>
                            <div class="stat-label">Suscripciones Activas</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">$<span id="totalMRR">0</span></div>
                            <div class="stat-label">MRR Total</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="trialCount">0</div>
                            <div class="stat-label">En Trial</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon danger">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="churnCount">0</div>
                            <div class="stat-label">Churn este mes</div>
                        </div>
                    </div>
                </div>

                <!-- Renewal Alerts -->
                <div id="alertsSection" class="card" style="margin-bottom: 1.5rem; display: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, #fef3c7, #fef9c3); border-bottom: 1px solid #fcd34d;">
                        <h3 class="card-title" style="color: #92400e;">
                            <i class="fas fa-bell"></i> Alertas de Renovación
                        </h3>
                        <span class="badge" id="alertsCount" style="background: #f59e0b; color: white;">0</span>
                    </div>
                    <div class="card-body" id="alertsContent" style="padding: 1rem;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid-2" style="margin-bottom: 1.5rem; gap: 1.5rem;">
                    <!-- MRR History Chart -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-area"></i> MRR Histórico
                            </h3>
                            <select id="chartPeriod" onchange="updateMRRChart()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 12px;">
                                <option value="6">Últimos 6 meses</option>
                                <option value="12" selected>Últimos 12 meses</option>
                            </select>
                        </div>
                        <div class="card-body" style="height: 280px;">
                            <canvas id="mrrChart"></canvas>
                        </div>
                    </div>

                    <!-- Revenue Projection -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-line"></i> Proyección de Ingresos
                            </h3>
                            <select id="projectionMonths" onchange="updateProjection()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 12px;">
                                <option value="3">3 meses</option>
                                <option value="6" selected>6 meses</option>
                                <option value="12">12 meses</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div id="projectionContent" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subscription Plans -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-layer-group"></i> Modelo de Pricing
                        </h3>
                        <button class="btn btn-sm btn-secondary" onclick="openPricingCalculator()">
                            <i class="fas fa-calculator"></i> Calculadora
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Pricing Model Explanation -->
                        <div style="background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border: 1px solid #86efac; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <i class="fas fa-info-circle" style="color: #22c55e;"></i>
                                <strong style="color: #166534;">Cómo funciona el pricing</strong>
                            </div>
                            <p style="font-size: 0.875rem; color: #166534; margin: 0;">
                                <strong>Plan (incluye MotorSync)</strong> + <strong>Módulos Premium</strong> = Precio mensual<br>
                                Todos los planes incluyen MotorSync. Los módulos premium son opcionales.
                            </p>
                        </div>
                        
                        <!-- Plans Row -->
                        <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-server" style="color: var(--primary-color);"></i> Planes (Capacidad)
                        </h4>
                        <div id="plansGrid" class="grid-4" style="margin-bottom: 2rem;">
                            <!-- Populated by JS -->
                        </div>
                        
                        <!-- Modules Section -->
                        <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-puzzle-piece" style="color: var(--primary-color);"></i> Módulos
                        </h4>
                        <div id="modulesGrid" class="grid-2" style="gap: 1rem;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Revenue Breakdown Section -->
                <div class="grid-2" style="margin-bottom: 1.5rem; gap: 1.5rem;">
                    <!-- Revenue by Plan -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-layer-group"></i> Ingresos por Plan
                            </h3>
                        </div>
                        <div class="card-body" id="planRevenueSection">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Revenue by Premium Module -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-puzzle-piece"></i> Ingresos por Módulo Premium
                            </h3>
                        </div>
                        <div class="card-body" id="moduleRevenueSection">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Subscriptions Table -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list"></i> Suscripciones Activas
                        </h3>
                        <div style="display: flex; gap: 0.75rem; align-items: center;">
                            <!-- Advanced Filters -->
                            <select id="filterPlan" onchange="applyFilters()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 12px;">
                                <option value="">Todos los planes</option>
                                <option value="trial">Trial</option>
                                <option value="starter">Starter</option>
                                <option value="professional">Professional</option>
                                <option value="enterprise">Enterprise</option>
                            </select>
                            <select id="filterStatus" onchange="applyFilters()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 12px;">
                                <option value="">Todos los estados</option>
                                <option value="active">Activos</option>
                                <option value="trial">En Trial</option>
                                <option value="inactive">Cancelados</option>
                            </select>
                            <select id="filterIndustry" onchange="applyFilters()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 12px;">
                                <option value="">Todas las industrias</option>
                            </select>
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchInput" placeholder="Buscar..." oninput="applyFilters()">
                            </div>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Plan</th>
                                    <th>Módulos Premium</th>
                                    <th>Desglose</th>
                                    <th>MRR Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="subscriptionsTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Upgrade Plan Modal -->
    <div class="modal-overlay" id="upgradeModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Gestionar Suscripción</h3>
                <button class="modal-close" onclick="closeModal('upgradeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="upgradeForm">
                    <div class="form-group">
                        <label>Cliente</label>
                        <select id="upgradeCompany" required onchange="loadCurrentSubscription()">
                            <option value="">Seleccionar cliente...</option>
                        </select>
                    </div>
                    
                    <div id="subscriptionDetails" style="display: none;">
                        <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border-color);">
                        
                        <div class="form-group">
                            <label>Plan</label>
                            <div id="planOptions" class="grid-4" style="gap: 0.75rem;">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Módulos Premium</label>
                            <div id="moduleOptions" style="display: flex; flex-direction: column; gap: 0.75rem;">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        
                        <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border-color);">
                        
                        <div id="pricingSummary" style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('upgradeModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveSubscription()">
                    <i class="fas fa-save"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <!-- Pricing Calculator Modal -->
    <div class="modal-overlay" id="calculatorModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-calculator"></i> Calculadora de Precios</h3>
                <button class="modal-close" onclick="closeModal('calculatorModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Seleccionar Plan</label>
                    <div id="calcPlanOptions" class="grid-4" style="gap: 0.75rem;">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Módulos Premium</label>
                    <div id="calcModuleOptions" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border-color);">
                
                <div id="calcSummary" style="background: linear-gradient(135deg, #02735E, #4ecdc4); padding: 1.5rem; border-radius: 12px; color: white;">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('calculatorModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal-overlay" id="historyModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-history"></i> Historial de Cambios</h3>
                <button class="modal-close" onclick="closeModal('historyModal')">&times;</button>
            </div>
            <div class="modal-body" id="historyContent" style="max-height: 400px; overflow-y: auto;">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('historyModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="../js/sidebar.js"></script>
    <script src="../js/data.js"></script>
    <script>
        // Ensure page is visible
        document.body.classList.add('loaded');
        
        let allCompanies = [];
        let selectedPlan = null;
        let selectedModules = [];
        let editingCompanyId = null;
        let mrrChart = null;
        
        // Simulated historical data (would come from backend)
        const mrrHistory = generateMRRHistory();
        const subscriptionHistory = generateSubscriptionHistory();
        
        function generateMRRHistory() {
            const history = [];
            const now = new Date();
            let baseMRR = 1200;
            for (let i = 11; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                baseMRR += Math.floor(Math.random() * 300) + 100;
                history.push({
                    date: date.toISOString().slice(0, 7),
                    label: date.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }),
                    mrr: baseMRR,
                    newCustomers: Math.floor(Math.random() * 3) + 1,
                    churn: Math.floor(Math.random() * 2)
                });
            }
            return history;
        }
        
        function generateSubscriptionHistory() {
            return {
                1: [
                    { date: '2024-01-15', action: 'created', plan: 'Starter', details: 'Cuenta creada' },
                    { date: '2024-03-10', action: 'upgraded', plan: 'Professional', details: 'Upgrade de Starter a Professional' },
                    { date: '2024-06-15', action: 'module_added', plan: 'Professional', details: 'Agregó módulo TimeSync (+$79)' }
                ],
                2: [
                    { date: '2024-02-10', action: 'created', plan: 'Professional', details: 'Cuenta creada' },
                    { date: '2024-05-20', action: 'upgraded', plan: 'Enterprise', details: 'Upgrade a Enterprise' },
                    { date: '2024-07-01', action: 'module_added', plan: 'Enterprise', details: 'Agregó TimeSync + HumanSync' }
                ],
                3: [
                    { date: '2024-03-05', action: 'created', plan: 'Starter', details: 'Cuenta creada' },
                    { date: '2024-08-15', action: 'upgraded', plan: 'Professional', details: 'Upgrade a Professional' },
                    { date: '2024-10-01', action: 'module_added', plan: 'Professional', details: 'Agregó FleetSync (+$149)' }
                ],
                5: [
                    { date: '2024-04-20', action: 'created', plan: 'Starter', details: 'Cuenta creada' },
                    { date: '2024-07-10', action: 'upgraded', plan: 'Professional', details: 'Upgrade a Professional' },
                    { date: '2024-09-05', action: 'module_added', plan: 'Professional', details: 'Agregó TimeSync + ToolSync' }
                ]
            };
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Reset data para asegurar estructura correcta
                if (!localStorage.getItem('opsis_data_v2')) {
                    SuperAdminData.reset();
                    localStorage.setItem('opsis_data_v2', 'true');
                }
                
                loadSubscriptions();
                renderPricingModel();
                populateSelects();
                populateIndustryFilter();
                initMRRChart();
                updateProjection();
                checkRenewalAlerts();
                console.log('Subscriptions page loaded successfully');
            } catch (e) {
                console.error('Error loading subscriptions:', e);
                showNotification('Error cargando datos: ' + e.message, 'error');
            }
        });

        function loadSubscriptions() {
            allCompanies = SuperAdminData.getCompanies();
            console.log('Companies loaded:', allCompanies);
            updateStats();
            renderSubscriptions(allCompanies);
        }

        function updateStats() {
            const active = allCompanies.filter(c => c.status === 'active');
            const trial = allCompanies.filter(c => c.status === 'trial');
            const totals = SuperAdminData.getTotals();
            
            document.getElementById('activeCount').textContent = active.length;
            document.getElementById('totalMRR').textContent = totals.mrr.toLocaleString();
            document.getElementById('trialCount').textContent = trial.length;
            document.getElementById('churnCount').textContent = allCompanies.filter(c => c.status === 'inactive').length;
        }
        
        // ========================================
        // 1. MRR HISTORY CHART
        // ========================================
        function initMRRChart() {
            const ctx = document.getElementById('mrrChart').getContext('2d');
            const period = parseInt(document.getElementById('chartPeriod').value);
            const data = mrrHistory.slice(-period);
            
            mrrChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.label),
                    datasets: [{
                        label: 'MRR',
                        data: data.map(d => d.mrr),
                        borderColor: '#02735E',
                        backgroundColor: 'rgba(2, 115, 94, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#02735E'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `MRR: $${ctx.raw.toLocaleString()}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: val => '$' + val.toLocaleString()
                            }
                        }
                    }
                }
            });
        }
        
        function updateMRRChart() {
            const period = parseInt(document.getElementById('chartPeriod').value);
            const data = mrrHistory.slice(-period);
            mrrChart.data.labels = data.map(d => d.label);
            mrrChart.data.datasets[0].data = data.map(d => d.mrr);
            mrrChart.update();
        }
        
        // ========================================
        // 2. ADVANCED FILTERS
        // ========================================
        function populateIndustryFilter() {
            const select = document.getElementById('filterIndustry');
            const industries = [...new Set(allCompanies.map(c => c.industry))].filter(Boolean);
            industries.forEach(ind => {
                const indData = SuperAdminData.industries[ind];
                if (indData) {
                    const opt = document.createElement('option');
                    opt.value = ind;
                    opt.textContent = indData.name;
                    select.appendChild(opt);
                }
            });
        }
        
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const planFilter = document.getElementById('filterPlan').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const industryFilter = document.getElementById('filterIndustry').value;
            
            let filtered = allCompanies.filter(c => {
                const matchesSearch = !search || 
                    c.name.toLowerCase().includes(search) ||
                    c.plan.toLowerCase().includes(search) ||
                    (c.premiumModules || []).some(m => m.toLowerCase().includes(search));
                
                const matchesPlan = !planFilter || c.plan.toLowerCase() === planFilter;
                const matchesStatus = !statusFilter || c.status === statusFilter;
                const matchesIndustry = !industryFilter || c.industry === industryFilter;
                
                return matchesSearch && matchesPlan && matchesStatus && matchesIndustry;
            });
            
            renderSubscriptions(filtered);
        }
        
        // ========================================
        // 3. EXPORT TO CSV
        // ========================================
        function exportToCSV() {
            const headers = ['ID', 'Empresa', 'Plan', 'Módulos Premium', 'MRR', 'Estado', 'Industria', 'Usuarios', 'Fecha Creación'];
            const rows = allCompanies.map(c => [
                c.id,
                c.name,
                c.plan,
                (c.premiumModules || []).join('; '),
                c.mrr,
                c.status,
                SuperAdminData.industries[c.industry]?.name || c.industry,
                c.users,
                c.createdAt
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.map(cell => `"${cell}"`).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `suscripciones-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Archivo CSV exportado', 'success');
        }
        
        // ========================================
        // 4. SUBSCRIPTION HISTORY
        // ========================================
        function showHistory(companyId) {
            const company = SuperAdminData.getCompany(companyId);
            const history = subscriptionHistory[companyId] || [];
            
            const actionIcons = {
                created: 'fa-plus-circle',
                upgraded: 'fa-arrow-up',
                downgraded: 'fa-arrow-down',
                module_added: 'fa-puzzle-piece',
                module_removed: 'fa-minus-circle',
                cancelled: 'fa-times-circle',
                reactivated: 'fa-redo'
            };
            
            const actionColors = {
                created: '#22c55e',
                upgraded: '#3b82f6',
                downgraded: '#f59e0b',
                module_added: '#8b5cf6',
                module_removed: '#ef4444',
                cancelled: '#ef4444',
                reactivated: '#22c55e'
            };
            
            document.getElementById('historyContent').innerHTML = `
                <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 0.25rem;">${company?.name || 'Cliente'}</h4>
                    <p style="color: var(--text-secondary); font-size: 0.875rem;">Plan actual: ${company?.plan} | MRR: $${company?.mrr}</p>
                </div>
                ${history.length ? `
                    <div style="position: relative; padding-left: 24px;">
                        <div style="position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: var(--border-color);"></div>
                        ${history.map(h => `
                            <div style="position: relative; margin-bottom: 1.5rem;">
                                <div style="position: absolute; left: -20px; width: 18px; height: 18px; border-radius: 50%; background: ${actionColors[h.action] || '#64748b'}; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas ${actionIcons[h.action] || 'fa-circle'}" style="color: white; font-size: 8px;"></i>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">
                                    ${new Date(h.date).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' })}
                                </div>
                                <div style="font-weight: 500;">${h.details}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Sin historial de cambios</p>'}
            `;
            
            document.getElementById('historyModal').classList.add('active');
        }
        
        // ========================================
        // 5. RENEWAL ALERTS
        // ========================================
        function checkRenewalAlerts() {
            const today = new Date();
            const alerts = allCompanies.filter(c => {
                if (c.status !== 'active' && c.status !== 'trial') return false;
                const created = new Date(c.createdAt);
                const renewalDate = new Date(created);
                renewalDate.setMonth(renewalDate.getMonth() + 1);
                
                // Trial ending in 3 days or less
                if (c.status === 'trial') {
                    const trialEnd = new Date(created);
                    trialEnd.setDate(trialEnd.getDate() + 14);
                    const daysLeft = Math.ceil((trialEnd - today) / (1000 * 60 * 60 * 24));
                    return daysLeft <= 3 && daysLeft >= 0;
                }
                
                // Renewal in 7 days or less
                const daysToRenewal = Math.ceil((renewalDate - today) / (1000 * 60 * 60 * 24));
                return daysToRenewal <= 7 && daysToRenewal >= 0;
            }).map(c => {
                const created = new Date(c.createdAt);
                let daysLeft, alertType;
                
                if (c.status === 'trial') {
                    const trialEnd = new Date(created);
                    trialEnd.setDate(trialEnd.getDate() + 14);
                    daysLeft = Math.ceil((trialEnd - today) / (1000 * 60 * 60 * 24));
                    alertType = 'trial_ending';
                } else {
                    const renewalDate = new Date(created);
                    renewalDate.setMonth(renewalDate.getMonth() + 1);
                    daysLeft = Math.ceil((renewalDate - today) / (1000 * 60 * 60 * 24));
                    alertType = 'renewal';
                }
                
                return { ...c, daysLeft, alertType };
            });
            
            if (alerts.length === 0) {
                document.getElementById('alertsSection').style.display = 'none';
                return;
            }
            
            document.getElementById('alertsSection').style.display = 'block';
            document.getElementById('alertsCount').textContent = alerts.length;
            document.getElementById('alertsContent').innerHTML = alerts.map(a => `
                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: ${a.alertType === 'trial_ending' ? '#fef3c7' : '#fff7ed'}; border-radius: 8px; margin-bottom: 0.5rem;">
                    <div style="width: 40px; height: 40px; border-radius: 8px; background: ${a.alertType === 'trial_ending' ? '#f59e0b' : '#fb923c'}; color: white; display: flex; align-items: center; justify-content: center;">
                        <i class="fas ${a.alertType === 'trial_ending' ? 'fa-hourglass-half' : 'fa-sync'}"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${a.name}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                            ${a.alertType === 'trial_ending' ? 'Trial termina' : 'Renovación'} en ${a.daysLeft} día${a.daysLeft !== 1 ? 's' : ''}
                        </div>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="editSubscription(${a.id})">
                        ${a.alertType === 'trial_ending' ? 'Convertir' : 'Gestionar'}
                    </button>
                </div>
            `).join('');
        }
        
        // ========================================
        // 6. REVENUE PROJECTION
        // ========================================
        function updateProjection() {
            const months = parseInt(document.getElementById('projectionMonths').value);
            const currentMRR = SuperAdminData.getTotals().mrr;
            const growthRate = 0.08; // 8% monthly growth assumption
            const churnRate = 0.02; // 2% monthly churn assumption
            
            let projectedMRR = currentMRR;
            const projections = [];
            
            for (let i = 1; i <= months; i++) {
                projectedMRR = projectedMRR * (1 + growthRate - churnRate);
                projections.push({
                    month: i,
                    mrr: Math.round(projectedMRR)
                });
            }
            
            const finalMRR = projections[projections.length - 1].mrr;
            const totalRevenue = projections.reduce((sum, p) => sum + p.mrr, 0);
            const growth = ((finalMRR - currentMRR) / currentMRR * 100).toFixed(1);
            
            document.getElementById('projectionContent').innerHTML = `
                <div style="grid-column: 1 / -1; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem;">
                        ${projections.map((p, i) => {
                            const height = (p.mrr / finalMRR) * 100;
                            return `
                                <div style="flex: 1; text-align: center;">
                                    <div style="height: 120px; display: flex; align-items: flex-end; justify-content: center;">
                                        <div style="width: 100%; background: linear-gradient(180deg, #02735E, #4ecdc4); border-radius: 4px 4px 0 0; height: ${height}%; min-height: 20px;"></div>
                                    </div>
                                    <div style="font-size: 0.65rem; color: var(--text-secondary); margin-top: 0.25rem;">Mes ${p.month}</div>
                                    <div style="font-size: 0.75rem; font-weight: 600;">$${(p.mrr/1000).toFixed(1)}k</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">MRR Proyectado</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">$${finalMRR.toLocaleString()}</div>
                    <div style="font-size: 0.75rem; color: #22c55e;"><i class="fas fa-arrow-up"></i> +${growth}%</div>
                </div>
                <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Ingresos Totales</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">$${totalRevenue.toLocaleString()}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">en ${months} meses</div>
                </div>
            `;
        }

        function renderPricingModel() {
            // Render Plans
            const planCounts = {};
            allCompanies.forEach(c => {
                const key = c.plan.toLowerCase();
                planCounts[key] = (planCounts[key] || 0) + 1;
            });
            
            const planIcons = {
                trial: 'fa-clock',
                starter: 'fa-seedling',
                professional: 'fa-bolt',
                enterprise: 'fa-building'
            };
            
            document.getElementById('plansGrid').innerHTML = Object.entries(SuperAdminData.plans).map(([key, plan]) => {
                const count = planCounts[key] || 0;
                const isPopular = key === 'professional';
                const usersText = plan.users === -1 ? 'Ilimitados' : `${plan.users} usuarios`;
                
                return `
                    <div style="padding: 1rem; border: 2px solid ${isPopular ? 'var(--primary-color)' : 'var(--border-color)'}; border-radius: 12px; text-align: center; position: relative; ${isPopular ? 'background: linear-gradient(180deg, rgba(2, 115, 94, 0.05), transparent);' : ''}">
                        ${isPopular ? '<span style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--primary-color); color: white; padding: 2px 10px; border-radius: 10px; font-size: 0.65rem; font-weight: 600;">POPULAR</span>' : ''}
                        <div style="font-size: 1.25rem; color: ${plan.color}; margin-bottom: 0.25rem;">
                            <i class="fas ${planIcons[key] || 'fa-tag'}"></i>
                        </div>
                        <h4 style="margin-bottom: 0.25rem; font-size: 0.9rem;">${plan.name}</h4>
                        <p style="font-size: 1.25rem; font-weight: 700; margin: 0.25rem 0; color: var(--text-primary);">
                            $${plan.price}<span style="font-size: 0.7rem; font-weight: 400; color: var(--text-secondary);">/mes</span>
                        </p>
                        <p style="color: var(--text-secondary); font-size: 0.7rem; margin-bottom: 0.5rem;">${usersText}</p>
                        <p style="font-size: 0.75rem; color: ${plan.color}; font-weight: 600;">${count} clientes</p>
                    </div>
                `;
            }).join('');
            
            // Render Modules
            const moduleUsage = {};
            allCompanies.forEach(c => {
                (c.premiumModules || []).forEach(m => {
                    const key = m.toLowerCase().replace(/\s+/g, '');
                    moduleUsage[key] = (moduleUsage[key] || 0) + 1;
                });
            });
            
            document.getElementById('modulesGrid').innerHTML = `
                <!-- Base Module -->
                <div style="padding: 1rem; border: 2px solid var(--primary-color); border-radius: 12px; background: linear-gradient(135deg, rgba(2, 115, 94, 0.1), transparent); display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 50px; height: 50px; border-radius: 12px; background: var(--primary-color); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem;">
                        <i class="fas fa-wrench"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <strong>MotorSync</strong>
                            <span style="background: var(--primary-color); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: 600;">INCLUIDO EN TODOS LOS PLANES</span>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 0.25rem 0 0 0;">Gestión de proyectos, clientes y operaciones</p>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary-color);">Incluido</div>
                        <div style="font-size: 0.65rem; color: var(--text-secondary);">En tu plan</div>
                    </div>
                </div>
                
                ${SuperAdminData.getPremiumModules().map(module => {
                    const usage = moduleUsage[module.key] || 0;
                    const isActive = module.status === 'active';
                    
                    return `
                        <div style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 12px; display: flex; align-items: center; gap: 1rem; ${!isActive ? 'opacity: 0.6;' : ''}">
                            <div style="width: 50px; height: 50px; border-radius: 12px; background: ${isActive ? '#f1f5f9' : '#e2e8f0'}; display: flex; align-items: center; justify-content: center; color: ${isActive ? '#3b82f6' : '#94a3b8'}; font-size: 1.25rem;">
                                <i class="${module.icon}"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <strong>${module.name}</strong>
                                    <span style="background: ${isActive ? '#dbeafe' : '#f1f5f9'}; color: ${isActive ? '#3b82f6' : '#94a3b8'}; padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: 600;">
                                        ${isActive ? 'PREMIUM' : 'PRÓXIMAMENTE'}
                                    </span>
                                </div>
                                <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 0.25rem 0 0 0;">${module.description}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.25rem; font-weight: 700; color: ${isActive ? '#3b82f6' : '#94a3b8'};">+$${module.price}</div>
                                <div style="font-size: 0.65rem; color: var(--text-secondary);">${usage} clientes</div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
            
            // Also render revenue breakdown sections
            renderRevenueBreakdown();
        }

        function renderRevenueBreakdown() {
            const totals = SuperAdminData.getTotals();
            const planBreakdown = {};
            const moduleBreakdown = {};
            
            allCompanies.forEach(c => {
                const plan = c.plan.toLowerCase();
                planBreakdown[plan] = planBreakdown[plan] || { count: 0, mrr: 0 };
                planBreakdown[plan].count++;
                planBreakdown[plan].mrr += c.mrr;
                
                (c.premiumModules || []).forEach(m => {
                    const key = m.toLowerCase().replace(/\s+/g, '');
                    const mod = SuperAdminData.products[key];
                    if (mod) {
                        moduleBreakdown[key] = moduleBreakdown[key] || { name: mod.name, count: 0, revenue: 0 };
                        moduleBreakdown[key].count++;
                        moduleBreakdown[key].revenue += mod.price;
                    }
                });
            });
            
            // Render Plan Revenue
            document.getElementById('planRevenueSection').innerHTML = Object.entries(SuperAdminData.plans)
                .filter(([k]) => k !== 'trial')
                .map(([key, plan]) => {
                    const data = planBreakdown[key] || { count: 0, mrr: 0 };
                    const percentage = totals.mrr > 0 ? Math.round((data.mrr / totals.mrr) * 100) : 0;
                    
                    return `
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 36px; height: 36px; border-radius: 8px; background: ${plan.color}20; color: ${plan.color}; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                                ${data.count}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 0.875rem;">${plan.name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">${percentage}% del MRR total</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; color: var(--primary-color);">$${data.mrr.toLocaleString()}</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">/mes</div>
                            </div>
                        </div>
                    `;
                }).join('') + `
                <div style="display: flex; justify-content: space-between; padding: 1rem 0 0 0; margin-top: 0.5rem; border-top: 2px solid var(--border-color);">
                    <span style="font-weight: 600;">Total MRR</span>
                    <span style="font-weight: 700; font-size: 1.25rem; color: var(--primary-color);">$${totals.mrr.toLocaleString()}</span>
                </div>
            `;
            
            // Render Module Revenue
            const moduleEntries = Object.entries(moduleBreakdown);
            if (moduleEntries.length === 0) {
                document.getElementById('moduleRevenueSection').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-puzzle-piece" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem; display: block;"></i>
                        <p style="margin: 0; font-size: 0.875rem;">Sin módulos premium activos</p>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem;">Los ingresos por módulos aparecerán aquí</p>
                    </div>
                `;
            } else {
                const totalModuleRevenue = moduleEntries.reduce((sum, [, data]) => sum + data.revenue, 0);
                
                document.getElementById('moduleRevenueSection').innerHTML = moduleEntries
                    .sort((a, b) => b[1].revenue - a[1].revenue)
                    .map(([key, data]) => `
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 36px; height: 36px; border-radius: 8px; background: #dbeafe; color: #3b82f6; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                                ${data.count}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 0.875rem;">${data.name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">${data.count} clientes</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; color: #3b82f6;">$${data.revenue.toLocaleString()}</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">/mes</div>
                            </div>
                        </div>
                    `).join('') + `
                    <div style="display: flex; justify-content: space-between; padding: 1rem 0 0 0; margin-top: 0.5rem; border-top: 2px solid var(--border-color);">
                        <span style="font-weight: 600;">Total Módulos</span>
                        <span style="font-weight: 700; font-size: 1.25rem; color: #3b82f6;">$${totalModuleRevenue.toLocaleString()}</span>
                    </div>
                `;
            }
        }

        function renderSubscriptions(companies) {
            const tbody = document.getElementById('subscriptionsTable');
            
            if (companies.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <i class="fas fa-sync-alt" style="font-size: 2rem; opacity: 0.5; display: block; margin-bottom: 1rem;"></i>
                            No hay suscripciones
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = companies.map(company => {
                const statusClass = company.status === 'active' ? 'status-active' : company.status === 'trial' ? 'status-trial' : 'status-inactive';
                const statusText = company.status === 'active' ? 'Activa' : company.status === 'trial' ? 'Trial' : 'Cancelada';
                const plan = SuperAdminData.plans[company.plan.toLowerCase()] || {};
                const premiumModules = company.premiumModules || [];
                
                // Calculate breakdown
                let breakdown = `Plan: $${plan.price || 0}`;
                let modulesTotal = 0;
                premiumModules.forEach(m => {
                    const mod = SuperAdminData.products[m.toLowerCase().replace(/\s+/g, '')];
                    if (mod) {
                        modulesTotal += mod.price;
                    }
                });
                if (modulesTotal > 0) {
                    breakdown += ` + Módulos: $${modulesTotal}`;
                }
                
                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div class="avatar avatar-sm">${company.name.charAt(0)}</div>
                                <div>
                                    <div style="font-weight: 600;">${company.name}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${company.users} usuarios</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge" style="background: ${plan.color || '#64748b'}20; color: ${plan.color || '#64748b'};">
                                ${company.plan}
                            </span>
                        </td>
                        <td>
                            ${premiumModules.length > 0 ? premiumModules.map(m => `
                                <span style="display: inline-block; background: #dbeafe; color: #3b82f6; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin: 1px;">${m}</span>
                            `).join('') : '<span style="color: var(--text-secondary); font-size: 0.75rem;">Solo MotorSync</span>'}
                        </td>
                        <td>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">${breakdown}</div>
                        </td>
                        <td><strong style="color: var(--primary-color);">$${company.mrr.toLocaleString()}</strong></td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-ghost" onclick="showHistory(${company.id})" title="Ver historial">
                                <i class="fas fa-history"></i>
                            </button>
                            <button class="btn btn-sm btn-ghost" onclick="editSubscription(${company.id})" title="Editar suscripción">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${company.status === 'trial' ? `
                                <button class="btn btn-sm btn-ghost" onclick="convertToPaid(${company.id})" title="Convertir a pagado">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                            ` : company.status === 'active' ? `
                                <button class="btn btn-sm btn-ghost" onclick="cancelSubscription(${company.id})" title="Cancelar">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-ghost" onclick="reactivateSubscription(${company.id})" title="Reactivar">
                                    <i class="fas fa-redo"></i>
                                </button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterSubscriptions() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allCompanies.filter(c => 
                c.name.toLowerCase().includes(search) ||
                c.plan.toLowerCase().includes(search) ||
                (c.premiumModules || []).some(m => m.toLowerCase().includes(search))
            );
            renderSubscriptions(filtered);
        }

        function populateSelects() {
            const companySelect = document.getElementById('upgradeCompany');
            companySelect.innerHTML = '<option value="">Seleccionar cliente...</option>' +
                allCompanies.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function openUpgradeModal() {
            editingCompanyId = null;
            selectedPlan = null;
            selectedModules = [];
            document.getElementById('upgradeModal').classList.add('active');
            document.getElementById('upgradeForm').reset();
            document.getElementById('subscriptionDetails').style.display = 'none';
        }

        function loadCurrentSubscription() {
            const companyId = document.getElementById('upgradeCompany').value;
            if (!companyId) {
                document.getElementById('subscriptionDetails').style.display = 'none';
                return;
            }
            
            const company = SuperAdminData.getCompany(companyId);
            if (!company) return;
            
            editingCompanyId = companyId;
            selectedPlan = company.plan.toLowerCase();
            selectedModules = [...(company.premiumModules || [])].map(m => m.toLowerCase().replace(/\s+/g, ''));
            
            document.getElementById('subscriptionDetails').style.display = 'block';
            renderPlanOptions();
            renderModuleOptions();
            updatePricingSummary();
        }

        function renderPlanOptions() {
            const container = document.getElementById('planOptions');
            const planIcons = {
                trial: 'fa-clock',
                starter: 'fa-seedling',
                professional: 'fa-bolt',
                enterprise: 'fa-building'
            };
            
            container.innerHTML = Object.entries(SuperAdminData.plans)
                .filter(([key]) => key !== 'trial')
                .map(([key, plan]) => {
                    const isSelected = selectedPlan === key;
                    return `
                        <div onclick="selectPlan('${key}')" style="padding: 0.75rem; border: 2px solid ${isSelected ? 'var(--primary-color)' : 'var(--border-color)'}; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; ${isSelected ? 'background: rgba(2, 115, 94, 0.1);' : ''}">
                            <i class="fas ${planIcons[key]}" style="color: ${plan.color}; margin-bottom: 0.25rem;"></i>
                            <div style="font-weight: 600; font-size: 0.8rem;">${plan.name}</div>
                            <div style="font-size: 0.9rem; font-weight: 700;">$${plan.price}</div>
                        </div>
                    `;
                }).join('');
        }

        function renderModuleOptions() {
            const container = document.getElementById('moduleOptions');
            const premiumModules = SuperAdminData.getActivePremiumModules();
            
            container.innerHTML = premiumModules.map(module => {
                const isSelected = selectedModules.includes(module.key);
                return `
                    <div onclick="toggleModule('${module.key}')" style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border: 2px solid ${isSelected ? '#3b82f6' : 'var(--border-color)'}; border-radius: 8px; cursor: pointer; transition: all 0.2s; ${isSelected ? 'background: rgba(59, 130, 246, 0.1);' : ''}">
                        <div style="width: 20px; height: 20px; border: 2px solid ${isSelected ? '#3b82f6' : '#cbd5e1'}; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: ${isSelected ? '#3b82f6' : 'white'};">
                            ${isSelected ? '<i class="fas fa-check" style="color: white; font-size: 0.7rem;"></i>' : ''}
                        </div>
                        <i class="${module.icon}" style="color: #3b82f6; font-size: 1.25rem;"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${module.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${module.description}</div>
                        </div>
                        <div style="font-weight: 700; color: #3b82f6;">+$${module.price}/mes</div>
                    </div>
                `;
            }).join('');
        }

        function selectPlan(planKey) {
            selectedPlan = planKey;
            renderPlanOptions();
            updatePricingSummary();
        }

        function toggleModule(moduleKey) {
            const index = selectedModules.indexOf(moduleKey);
            if (index > -1) {
                selectedModules.splice(index, 1);
            } else {
                selectedModules.push(moduleKey);
            }
            renderModuleOptions();
            updatePricingSummary();
        }

        function updatePricingSummary() {
            const container = document.getElementById('pricingSummary');
            const plan = SuperAdminData.plans[selectedPlan];
            
            if (!plan) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Selecciona un plan</p>';
                return;
            }
            
            const breakdown = SuperAdminData.getPricingBreakdown(selectedPlan, selectedModules);
            
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Plan ${breakdown.plan.name}</span>
                    <span>$${breakdown.plan.price}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: var(--text-secondary);">
                    <span><i class="fas fa-check-circle" style="color: var(--primary-color);"></i> MotorSync</span>
                    <span>Incluido</span>
                </div>
                ${breakdown.premiumModules.map(m => `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span><i class="fas fa-plus-circle" style="color: #3b82f6;"></i> ${m.name}</span>
                        <span>+$${m.price}</span>
                    </div>
                `).join('')}
                <hr style="margin: 0.75rem 0; border: none; border-top: 1px dashed var(--border-color);">
                <div style="display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: 700;">
                    <span>Total Mensual</span>
                    <span style="color: var(--primary-color);">$${breakdown.total}</span>
                </div>
            `;
        }

        function saveSubscription() {
            if (!editingCompanyId || !selectedPlan) {
                showNotification('Por favor selecciona un plan', 'error');
                return;
            }
            
            const plan = SuperAdminData.plans[selectedPlan];
            const mrr = SuperAdminData.calculateMRR(selectedPlan, selectedModules);
            
            SuperAdminData.updateCompany(editingCompanyId, {
                plan: plan.name,
                premiumModules: selectedModules.map(key => SuperAdminData.products[key]?.name || key),
                mrr: mrr,
                status: 'active'
            });
            
            closeModal('upgradeModal');
            loadSubscriptions();
            renderPricingModel();
            showNotification('Suscripción actualizada exitosamente', 'success');
        }

        function editSubscription(id) {
            document.getElementById('upgradeCompany').value = id;
            document.getElementById('upgradeModal').classList.add('active');
            loadCurrentSubscription();
        }

        function convertToPaid(id) {
            editSubscription(id);
        }

        function cancelSubscription(id) {
            if (!confirm('¿Estás seguro de cancelar esta suscripción?')) return;
            
            SuperAdminData.updateCompany(id, {
                status: 'inactive',
                mrr: 0
            });
            
            loadSubscriptions();
            renderPricingModel();
            showNotification('Suscripción cancelada', 'warning');
        }

        function reactivateSubscription(id) {
            editSubscription(id);
        }

        // Pricing Calculator
        function openPricingCalculator() {
            selectedPlan = 'professional';
            selectedModules = [];
            document.getElementById('calculatorModal').classList.add('active');
            renderCalcPlanOptions();
            renderCalcModuleOptions();
            updateCalcSummary();
        }

        function renderCalcPlanOptions() {
            const container = document.getElementById('calcPlanOptions');
            const planIcons = {
                starter: 'fa-seedling',
                professional: 'fa-bolt',
                enterprise: 'fa-building'
            };
            
            container.innerHTML = Object.entries(SuperAdminData.plans)
                .filter(([key]) => key !== 'trial')
                .map(([key, plan]) => {
                    const isSelected = selectedPlan === key;
                    return `
                        <div onclick="selectCalcPlan('${key}')" style="padding: 0.75rem; border: 2px solid ${isSelected ? 'var(--primary-color)' : 'var(--border-color)'}; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; ${isSelected ? 'background: rgba(2, 115, 94, 0.1);' : ''}">
                            <i class="fas ${planIcons[key]}" style="color: ${plan.color}; margin-bottom: 0.25rem;"></i>
                            <div style="font-weight: 600; font-size: 0.8rem;">${plan.name}</div>
                            <div style="font-size: 0.9rem; font-weight: 700;">$${plan.price}</div>
                        </div>
                    `;
                }).join('');
        }

        function renderCalcModuleOptions() {
            const container = document.getElementById('calcModuleOptions');
            const premiumModules = SuperAdminData.getActivePremiumModules();
            
            container.innerHTML = premiumModules.map(module => {
                const isSelected = selectedModules.includes(module.key);
                return `
                    <div onclick="toggleCalcModule('${module.key}')" style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border: 2px solid ${isSelected ? '#3b82f6' : 'var(--border-color)'}; border-radius: 8px; cursor: pointer; transition: all 0.2s; ${isSelected ? 'background: rgba(59, 130, 246, 0.1);' : ''}">
                        <div style="width: 20px; height: 20px; border: 2px solid ${isSelected ? '#3b82f6' : '#cbd5e1'}; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: ${isSelected ? '#3b82f6' : 'white'};">
                            ${isSelected ? '<i class="fas fa-check" style="color: white; font-size: 0.7rem;"></i>' : ''}
                        </div>
                        <i class="${module.icon}" style="color: #3b82f6; font-size: 1.25rem;"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${module.name}</div>
                        </div>
                        <div style="font-weight: 700; color: #3b82f6;">+$${module.price}</div>
                    </div>
                `;
            }).join('');
        }

        function selectCalcPlan(planKey) {
            selectedPlan = planKey;
            renderCalcPlanOptions();
            updateCalcSummary();
        }

        function toggleCalcModule(moduleKey) {
            const index = selectedModules.indexOf(moduleKey);
            if (index > -1) {
                selectedModules.splice(index, 1);
            } else {
                selectedModules.push(moduleKey);
            }
            renderCalcModuleOptions();
            updateCalcSummary();
        }

        function updateCalcSummary() {
            const container = document.getElementById('calcSummary');
            const breakdown = SuperAdminData.getPricingBreakdown(selectedPlan, selectedModules);
            
            container.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 0.875rem; opacity: 0.8; margin-bottom: 0.5rem;">Precio Mensual</div>
                    <div style="font-size: 3rem; font-weight: 800;">$${breakdown.total}</div>
                    <div style="font-size: 0.875rem; opacity: 0.8; margin-top: 0.5rem;">
                        Plan ${breakdown.plan.name} ($${breakdown.plan.price}) - MotorSync incluido
                        ${breakdown.premiumModules.length > 0 ? ` + ${breakdown.premiumModules.map(m => m.name).join(', ')}` : ''}
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.3);">
                        <span style="font-size: 1.5rem; font-weight: 700;">$${breakdown.total * 12}</span>
                        <span style="opacity: 0.8;">/año</span>
                    </div>
                </div>
            `;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'exclamation-triangle'}"></i> ${message}`;
            notification.style.cssText = `position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#f59e0b'}; color: white; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999;`;
            document.body.appendChild(notification);
            setTimeout(() => { notification.style.opacity = '0'; setTimeout(() => notification.remove(), 300); }, 3000);
        }

        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
        });
    </script>
</body>
</html>