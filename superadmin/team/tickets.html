<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tickets de Soporte - SuperAdmin | Opsis Suite</title>
    <style>
        :root { 
            --verdi-dark: #022326; 
            --verdi-mid: #034040;
            --verdi-accent: #035951;
            --verdi-light: #02735E;
            --success: #10b981;
            --sidebar-width: 240px; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { background: #f8fafc; }
        body { opacity: 0; transition: opacity 0.15s ease-in; }
        body.loaded { opacity: 1; }
        .app-shell { min-height: 100vh; background: #f8fafc; }
        .sidebar { position: fixed; left: 0; top: 0; width: var(--sidebar-width); height: 100vh; background: var(--verdi-dark); }
        .main-content { margin-left: var(--sidebar-width); min-height: 100vh; background: #f8fafc; }

        /* Filter Bar */
        .filter-bar { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .filter-bar .search-box { 
            flex: 1; 
            min-width: 200px;
            position: relative;
        }
        .filter-bar .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.9rem;
            background: white;
            transition: all 0.2s;
        }
        .filter-bar .search-box input:focus {
            outline: none;
            border-color: var(--verdi-light);
            box-shadow: 0 0 0 3px rgba(2, 115, 94, 0.1);
        }
        .filter-bar .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }
        .filter-bar select {
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.85rem;
            background: white;
            cursor: pointer;
            min-width: 140px;
        }
        .filter-bar select:focus { outline: none; border-color: var(--verdi-light); }

        /* Tickets Table */
        .tickets-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .tickets-table th {
            background: linear-gradient(135deg, #f8fafc 0%, #f0fdf4 100%);
            padding: 1rem 1.25rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--verdi-dark);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            border-bottom: 2px solid #e2e8f0;
        }
        .tickets-table td {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
            color: #374151;
            vertical-align: middle;
        }
        .tickets-table tbody tr {
            cursor: pointer;
            transition: all 0.2s;
        }
        .tickets-table tbody tr:hover {
            background: linear-gradient(90deg, #f0fdf4, transparent);
        }
        .tickets-table tbody tr:last-child td { border-bottom: none; }

        /* Ticket ID */
        .ticket-id {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
            color: var(--verdi-light);
            font-weight: 600;
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        .status-badge.new { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1e40af; }
        .status-badge.open { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #b45309; }
        .status-badge.in-progress { background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #047857; }
        .status-badge.resolved { background: linear-gradient(135deg, #e0e7ff, #c7d2fe); color: #4338ca; }
        .status-badge.closed { background: linear-gradient(135deg, #f1f5f9, #e2e8f0); color: #64748b; }

        /* Priority */
        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .priority-badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .priority-badge.high .dot { background: #ef4444; }
        .priority-badge.medium .dot { background: #f59e0b; }
        .priority-badge.low .dot { background: #10b981; }

        /* User Info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--verdi-dark), var(--verdi-accent));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .user-details strong {
            display: block;
            font-size: 0.85rem;
            color: #1e293b;
        }
        .user-details span {
            font-size: 0.7rem;
            color: #64748b;
        }

        /* Assignee */
        .assignee {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .assignee-avatar {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: linear-gradient(135deg, var(--verdi-mid), var(--verdi-light));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 600;
        }
        .assignee-name { font-size: 0.85rem; color: #374151; }
        .unassigned { color: #94a3b8; font-style: italic; font-size: 0.85rem; }

        /* Actions */
        .action-btn {
            padding: 0.5rem;
            border: none;
            background: none;
            cursor: pointer;
            color: #64748b;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .action-btn:hover {
            background: #f1f5f9;
            color: var(--verdi-light);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.active .modal {
            transform: scale(1);
        }
        .modal-header {
            background: linear-gradient(135deg, var(--verdi-dark) 0%, var(--verdi-accent) 100%);
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .modal-close {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .modal-close:hover { background: rgba(255,255,255,0.25); }
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(85vh - 140px);
        }

        /* Ticket Detail */
        .ticket-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .ticket-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .ticket-meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .ticket-meta-item label {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
        }
        .ticket-subject {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--verdi-dark);
            margin-bottom: 0.5rem;
        }
        .ticket-description {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #374151;
        }

        /* Assign Section */
        .assign-section {
            background: linear-gradient(135deg, #f0fdf4, #f8fafc);
            border: 1px solid #d1fae5;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }
        .assign-section h4 {
            font-size: 0.9rem;
            color: var(--verdi-dark);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .assign-options {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .assign-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .assign-option:hover {
            border-color: var(--verdi-light);
        }
        .assign-option.selected {
            border-color: var(--verdi-light);
            background: linear-gradient(135deg, #d1fae5, #f0fdf4);
        }
        .assign-option .avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--verdi-dark), var(--verdi-accent));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .assign-option .name {
            font-size: 0.85rem;
            font-weight: 500;
            color: #1e293b;
        }

        /* Reply Section */
        .reply-section h4 {
            font-size: 0.9rem;
            color: var(--verdi-dark);
            margin-bottom: 0.75rem;
        }
        .reply-textarea {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.9rem;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 1rem;
        }
        .reply-textarea:focus {
            outline: none;
            border-color: var(--verdi-light);
            box-shadow: 0 0 0 3px rgba(2, 115, 94, 0.1);
        }
        .reply-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--verdi-light), var(--success));
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(2, 115, 94, 0.3);
        }
        .btn-secondary {
            background: white;
            border: 1px solid #e2e8f0;
            color: #64748b;
        }
        .btn-secondary:hover {
            border-color: var(--verdi-light);
            color: var(--verdi-light);
        }
        .btn-resolve {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #64748b;
        }
        .empty-state i {
            font-size: 3rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }
        .empty-state h3 {
            font-size: 1.1rem;
            color: #475569;
            margin-bottom: 0.5rem;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/superadmin/css/superadmin.css?v=12">
</head>
<body>
    <div class="app-shell">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <h1 class="page-title">Tickets de Soporte</h1>
                    <p class="page-subtitle">Gestiona las solicitudes de los usuarios</p>
                </div>
            </header>

            <div class="page-content">
                <!-- Stats - Verdi + Aire -->
                <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 160px; background: linear-gradient(135deg, #022326 0%, #034040 100%); border-radius: 14px; padding: 1.25rem; color: white;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 44px; height: 44px; border-radius: 10px; background: rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-ticket-alt" style="font-size: 1.1rem;"></i>
                            </div>
                            <div>
                                <div style="font-size: 1.75rem; font-weight: 700; line-height: 1;" id="statTotal">0</div>
                                <div style="font-size: 0.7rem; opacity: 0.85; text-transform: uppercase;">Total Tickets</div>
                            </div>
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 160px; background: linear-gradient(135deg, #034040 0%, #035951 100%); border-radius: 14px; padding: 1.25rem; color: white;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 44px; height: 44px; border-radius: 10px; background: rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-exclamation-circle" style="font-size: 1.1rem;"></i>
                            </div>
                            <div>
                                <div style="font-size: 1.75rem; font-weight: 700; line-height: 1;" id="statNew">0</div>
                                <div style="font-size: 0.7rem; opacity: 0.85; text-transform: uppercase;">Nuevos</div>
                            </div>
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 160px; background: linear-gradient(135deg, #035951 0%, #02735E 100%); border-radius: 14px; padding: 1.25rem; color: white;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 44px; height: 44px; border-radius: 10px; background: rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-spinner" style="font-size: 1.1rem;"></i>
                            </div>
                            <div>
                                <div style="font-size: 1.75rem; font-weight: 700; line-height: 1;" id="statOpen">0</div>
                                <div style="font-size: 0.7rem; opacity: 0.85; text-transform: uppercase;">En Progreso</div>
                            </div>
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 160px; background: linear-gradient(135deg, #02735E 0%, #10b981 100%); border-radius: 14px; padding: 1.25rem; color: white;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 44px; height: 44px; border-radius: 10px; background: rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-check-circle" style="font-size: 1.1rem;"></i>
                            </div>
                            <div>
                                <div style="font-size: 1.75rem; font-weight: 700; line-height: 1;" id="statResolved">0</div>
                                <div style="font-size: 0.7rem; opacity: 0.85; text-transform: uppercase;">Resueltos</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter Bar -->
                <div class="filter-bar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Buscar por ID, asunto o usuario...">
                    </div>
                    <select id="statusFilter">
                        <option value="">Todos los estados</option>
                        <option value="new">Nuevos</option>
                        <option value="open">Abiertos</option>
                        <option value="in-progress">En progreso</option>
                        <option value="resolved">Resueltos</option>
                        <option value="closed">Cerrados</option>
                    </select>
                    <select id="priorityFilter">
                        <option value="">Todas las prioridades</option>
                        <option value="high">Alta</option>
                        <option value="medium">Media</option>
                        <option value="low">Baja</option>
                    </select>
                    <select id="assigneeFilter">
                        <option value="">Todos los agentes</option>
                        <option value="unassigned">Sin asignar</option>
                    </select>
                </div>

                <!-- Tickets Table -->
                <div class="card">
                    <table class="tickets-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Asunto</th>
                                <th>Categoría</th>
                                <th>Prioridad</th>
                                <th>Estado</th>
                                <th>Asignado a</th>
                                <th>Fecha</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="ticketsTableBody">
                        </tbody>
                    </table>
                    <div class="empty-state" id="emptyState" style="display: none;">
                        <i class="fas fa-inbox"></i>
                        <h3>No hay tickets</h3>
                        <p>Los tickets de soporte aparecerán aquí</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de detalle -->
    <div class="modal-overlay" id="ticketModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-ticket-alt"></i> <span id="modalTicketId"></span></h2>
                <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Contenido dinámico -->
            </div>
        </div>
    </div>

    <script src="/superadmin/js/sidebar.js"></script>
    <script src="/superadmin/js/data.js"></script>
    <script>
        document.body.classList.add('loaded');

        // Agentes de soporte disponibles
        const supportAgents = [
            { id: 'laura', name: 'Laura Martínez', avatar: 'LM' },
            { id: 'diego', name: 'Diego López', avatar: 'DL' },
            { id: 'juan', name: 'Juan Pérez', avatar: 'JP' }
        ];

        // Datos de ejemplo
        let tickets = JSON.parse(localStorage.getItem('opsis_support_tickets') || '[]');
        
        // Si no hay tickets, agregar algunos de ejemplo
        if (tickets.length === 0) {
            tickets = [
                {
                    id: 'TKT-1001',
                    user: { name: 'Carlos Mendoza', email: 'carlos@empresa.com', company: 'AutoTech SA' },
                    subject: 'No puedo generar reportes',
                    description: 'Cuando intento generar el reporte mensual de operaciones, el sistema me muestra un error 500. Ya intenté limpiar cache pero sigue igual.',
                    category: 'technical',
                    priority: 'high',
                    status: 'new',
                    assignee: null,
                    createdAt: new Date(Date.now() - 1000 * 60 * 30).toISOString()
                },
                {
                    id: 'TKT-1002',
                    user: { name: 'María García', email: 'maria@logistica.com', company: 'LogiPro' },
                    subject: 'Consulta sobre facturación',
                    description: 'Quisiera saber si es posible cambiar el ciclo de facturación de mensual a quincenal.',
                    category: 'billing',
                    priority: 'medium',
                    status: 'open',
                    assignee: { id: 'laura', name: 'Laura Martínez', avatar: 'LM' },
                    createdAt: new Date(Date.now() - 1000 * 60 * 60 * 2).toISOString()
                },
                {
                    id: 'TKT-1003',
                    user: { name: 'Pedro Sánchez', email: 'pedro@transport.mx', company: 'TransMex' },
                    subject: 'Agregar nuevo usuario',
                    description: 'Necesito agregar 3 usuarios adicionales a mi cuenta. ¿Cuál es el proceso?',
                    category: 'account',
                    priority: 'low',
                    status: 'in-progress',
                    assignee: { id: 'diego', name: 'Diego López', avatar: 'DL' },
                    createdAt: new Date(Date.now() - 1000 * 60 * 60 * 24).toISOString()
                },
                {
                    id: 'TKT-1004',
                    user: { name: 'Ana Ruiz', email: 'ana@flotas.com', company: 'FlotasPlus' },
                    subject: 'Error al sincronizar GPS',
                    description: 'Los dispositivos GPS de 5 unidades no están sincronizando correctamente desde ayer.',
                    category: 'technical',
                    priority: 'high',
                    status: 'new',
                    assignee: null,
                    createdAt: new Date(Date.now() - 1000 * 60 * 15).toISOString()
                }
            ];
            localStorage.setItem('opsis_support_tickets', JSON.stringify(tickets));
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof SuperAdminSidebar !== 'undefined') SuperAdminSidebar.init();
            renderTickets();
            updateStats();
            populateAssigneeFilter();
            
            // Event listeners
            document.getElementById('searchInput').addEventListener('input', renderTickets);
            document.getElementById('statusFilter').addEventListener('change', renderTickets);
            document.getElementById('priorityFilter').addEventListener('change', renderTickets);
            document.getElementById('assigneeFilter').addEventListener('change', renderTickets);
        });

        function populateAssigneeFilter() {
            const select = document.getElementById('assigneeFilter');
            supportAgents.forEach(agent => {
                const opt = document.createElement('option');
                opt.value = agent.id;
                opt.textContent = agent.name;
                select.appendChild(opt);
            });
        }

        function updateStats() {
            document.getElementById('statTotal').textContent = tickets.length;
            document.getElementById('statNew').textContent = tickets.filter(t => t.status === 'new').length;
            document.getElementById('statOpen').textContent = tickets.filter(t => ['open', 'in-progress'].includes(t.status)).length;
            document.getElementById('statResolved').textContent = tickets.filter(t => ['resolved', 'closed'].includes(t.status)).length;
        }

        function renderTickets() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const assigneeFilter = document.getElementById('assigneeFilter').value;

            let filtered = tickets.filter(t => {
                const matchSearch = !search || 
                    t.id.toLowerCase().includes(search) ||
                    t.subject.toLowerCase().includes(search) ||
                    t.user.name.toLowerCase().includes(search);
                const matchStatus = !statusFilter || t.status === statusFilter;
                const matchPriority = !priorityFilter || t.priority === priorityFilter;
                const matchAssignee = !assigneeFilter || 
                    (assigneeFilter === 'unassigned' && !t.assignee) ||
                    (t.assignee && t.assignee.id === assigneeFilter);
                return matchSearch && matchStatus && matchPriority && matchAssignee;
            });

            const tbody = document.getElementById('ticketsTableBody');
            const emptyState = document.getElementById('emptyState');

            if (filtered.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            tbody.innerHTML = filtered.map(t => `
                <tr onclick="openTicketDetail('${t.id}')">
                    <td><span class="ticket-id">${t.id}</span></td>
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">${getInitials(t.user.name)}</div>
                            <div class="user-details">
                                <strong>${t.user.name}</strong>
                                <span>${t.user.company}</span>
                            </div>
                        </div>
                    </td>
                    <td>${t.subject}</td>
                    <td>${getCategoryLabel(t.category)}</td>
                    <td>
                        <span class="priority-badge ${t.priority}">
                            <span class="dot"></span> ${getPriorityLabel(t.priority)}
                        </span>
                    </td>
                    <td><span class="status-badge ${t.status}">${getStatusLabel(t.status)}</span></td>
                    <td>
                        ${t.assignee ? `
                            <div class="assignee">
                                <div class="assignee-avatar">${t.assignee.avatar}</div>
                                <span class="assignee-name">${t.assignee.name.split(' ')[0]}</span>
                            </div>
                        ` : '<span class="unassigned">Sin asignar</span>'}
                    </td>
                    <td>${formatDate(t.createdAt)}</td>
                    <td>
                        <button class="action-btn" onclick="event.stopPropagation(); openTicketDetail('${t.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function openTicketDetail(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;

            document.getElementById('modalTicketId').textContent = ticket.id;
            document.getElementById('modalBody').innerHTML = `
                <div class="ticket-detail-header">
                    <div class="ticket-meta">
                        <div class="ticket-meta-item">
                            <label>Estado</label>
                            <span class="status-badge ${ticket.status}">${getStatusLabel(ticket.status)}</span>
                        </div>
                        <div class="ticket-meta-item">
                            <label>Prioridad</label>
                            <span class="priority-badge ${ticket.priority}"><span class="dot"></span> ${getPriorityLabel(ticket.priority)}</span>
                        </div>
                        <div class="ticket-meta-item">
                            <label>Categoría</label>
                            <span>${getCategoryLabel(ticket.category)}</span>
                        </div>
                        <div class="ticket-meta-item">
                            <label>Creado</label>
                            <span>${formatDate(ticket.createdAt)}</span>
                        </div>
                    </div>
                </div>

                <div class="user-info" style="margin-bottom: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 12px;">
                    <div class="user-avatar" style="width: 48px; height: 48px; font-size: 0.9rem;">${getInitials(ticket.user.name)}</div>
                    <div class="user-details">
                        <strong style="font-size: 1rem;">${ticket.user.name}</strong>
                        <span>${ticket.user.email} • ${ticket.user.company}</span>
                    </div>
                </div>

                <h3 class="ticket-subject">${ticket.subject}</h3>
                <div class="ticket-description">${ticket.description}</div>

                <div class="assign-section">
                    <h4><i class="fas fa-user-plus"></i> Asignar a</h4>
                    <div class="assign-options">
                        ${supportAgents.map(agent => `
                            <div class="assign-option ${ticket.assignee?.id === agent.id ? 'selected' : ''}" 
                                 onclick="assignTicket('${ticket.id}', '${agent.id}')">
                                <div class="avatar">${agent.avatar}</div>
                                <span class="name">${agent.name}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="reply-section">
                    <h4><i class="fas fa-reply"></i> Responder al usuario</h4>
                    <textarea class="reply-textarea" id="replyText" placeholder="Escribe tu respuesta..."></textarea>
                    <div class="reply-actions">
                        <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button class="btn btn-resolve" onclick="resolveTicket('${ticket.id}')">
                            <i class="fas fa-check"></i> Marcar Resuelto
                        </button>
                        <button class="btn btn-primary" onclick="sendReply('${ticket.id}')">
                            <i class="fas fa-paper-plane"></i> Enviar Respuesta
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('ticketModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('ticketModal').classList.remove('active');
        }

        function assignTicket(ticketId, agentId) {
            const ticket = tickets.find(t => t.id === ticketId);
            const agent = supportAgents.find(a => a.id === agentId);
            if (!ticket || !agent) return;

            ticket.assignee = agent;
            if (ticket.status === 'new') ticket.status = 'open';
            
            localStorage.setItem('opsis_support_tickets', JSON.stringify(tickets));
            
            showNotification(`Ticket asignado a ${agent.name}`, 'success');
            renderTickets();
            updateStats();
            openTicketDetail(ticketId); // Refrescar modal
        }

        function sendReply(ticketId) {
            const replyText = document.getElementById('replyText').value.trim();
            if (!replyText) {
                showNotification('Escribe una respuesta', 'error');
                return;
            }

            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;

            if (ticket.status === 'new') ticket.status = 'open';
            ticket.status = 'in-progress';
            
            localStorage.setItem('opsis_support_tickets', JSON.stringify(tickets));
            
            showNotification('Respuesta enviada al usuario', 'success');
            closeModal();
            renderTickets();
            updateStats();
        }

        function resolveTicket(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;

            ticket.status = 'resolved';
            localStorage.setItem('opsis_support_tickets', JSON.stringify(tickets));
            
            showNotification(`Ticket ${ticketId} marcado como resuelto`, 'success');
            closeModal();
            renderTickets();
            updateStats();
        }

        // Helpers
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }

        function getCategoryLabel(cat) {
            const labels = { technical: 'Técnico', billing: 'Facturación', account: 'Cuenta', feature: 'Sugerencia', other: 'Otro' };
            return labels[cat] || cat;
        }

        function getPriorityLabel(p) {
            const labels = { high: 'Alta', medium: 'Media', low: 'Baja' };
            return labels[p] || p;
        }

        function getStatusLabel(s) {
            const labels = { new: 'Nuevo', open: 'Abierto', 'in-progress': 'En progreso', resolved: 'Resuelto', closed: 'Cerrado' };
            return labels[s] || s;
        }

        function formatDate(iso) {
            const d = new Date(iso);
            const now = new Date();
            const diff = (now - d) / 1000 / 60; // minutos
            if (diff < 60) return `Hace ${Math.floor(diff)} min`;
            if (diff < 60 * 24) return `Hace ${Math.floor(diff / 60)}h`;
            return d.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
        }

        function showNotification(msg, type = 'info') {
            const n = document.createElement('div');
            const bgColor = type === 'success' ? 'linear-gradient(135deg, #02735E, #10b981)' : 
                           type === 'error' ? 'linear-gradient(135deg, #dc2626, #ef4444)' :
                           'linear-gradient(135deg, #034040, #035951)';
            n.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${msg}`;
            n.style.cssText = `position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; background: ${bgColor}; color: white; border-radius: 10px; display: flex; align-items: center; gap: 0.75rem; font-weight: 500; box-shadow: 0 4px 12px rgba(2, 115, 94, 0.25); z-index: 99999; transition: opacity 0.3s;`;
            document.body.appendChild(n);
            setTimeout(() => { n.style.opacity = '0'; setTimeout(() => n.remove(), 300); }, 3000);
        }

        // Cerrar modal con Escape
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeModal();
        });
        document.getElementById('ticketModal').addEventListener('click', e => {
            if (e.target.id === 'ticketModal') closeModal();
        });
    </script>
</body>
</html>
