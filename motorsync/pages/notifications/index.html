<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NotifySync - Centro de Notificaciones | Opsis Suite</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Helvetica+Neue:wght@400;500;600;700;900&display=swap">
  <link rel="stylesheet" href="styles.css?v=verdi2">
  <link rel="stylesheet" href="css/verdi-overrides.css?v=verdi2">
  <script src="notifications-manager.js"></script>
  <script src="js/seeds.js?v=verdi2"></script>
  <script src="js/modules.js?v=verdi2"></script>
  <script src="js/sidebar.js?v=verdi2"></script>
  <script src="js/back-link.js?v=verdi2"></script>
  <style>
    /* Estilos específicos de NotifySync */
    :root {
      --success-color: #10b981;
      --info-color: #0f766e;
      --warning-color: #d97706;
      --error-color: #dc2626;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-body);
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* Aire Animation */
    @keyframes aire {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* Header */
    header {
      background: linear-gradient(135deg, #02735E 0%, #035951 50%, #034040 100%);
      background-size: 200% 200%;
      animation: aire 8s ease infinite;
      padding: 24px 40px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .back-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateX(-4px);
    }

    .page-title {
      font-size: 28px;
      font-weight: 800;
      color: white;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      border: none;
    }

    .btn-white {
      background: white;
      color: var(--primary-color);
      border: 2px solid white;
    }

    .btn-white:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    /* Main Content */
    main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px;
    }

    /* Stats Section */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }

    .stat-card.success {
      border-left: 4px solid var(--success-color);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%);
    }

    .stat-card.info {
      border-left: 4px solid var(--info-color);
      background: linear-gradient(135deg, rgba(15, 118, 110, 0.05) 0%, transparent 100%);
    }

    .stat-card.warning {
      border-left: 4px solid var(--warning-color);
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, transparent 100%);
    }

    .stat-card.error {
      border-left: 4px solid var(--error-color);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, transparent 100%);
    }

    .stat-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .stat-trend {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Filters */
    .filters-section {
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
    }

    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .filters-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .filter-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: var(--bg-body);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .filter-btn:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .filter-btn.active {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }

    /* Notifications Grid */
    .notifications-grid {
      display: grid;
      gap: 16px;
    }

    .notification-card {
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .notification-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 6px;
      background: var(--notification-color, #0f766e);
      transition: width 0.3s ease;
    }

    .notification-card:hover::before {
      width: 12px;
    }

    .notification-card:hover {
      transform: translateX(8px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      border-color: var(--notification-color);
    }

    .notification-card.unread {
      background: linear-gradient(135deg, rgba(var(--notification-rgb), 0.03) 0%, transparent 100%);
      border-color: var(--notification-color);
    }

    .notification-card.success {
      --notification-color: #10b981;
      --notification-rgb: 16, 185, 129;
    }

    .notification-card.info {
      --notification-color: #0f766e;
      --notification-rgb: 15, 118, 110;
    }

    .notification-card.warning {
      --notification-color: #f59e0b;
      --notification-rgb: 245, 158, 11;
    }

    .notification-card.error {
      --notification-color: #ef4444;
      --notification-rgb: 239, 68, 68;
    }

    .notification-header {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 12px;
    }

    .notification-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .notification-card.success .notification-icon {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
    }

    .notification-card.info .notification-icon {
      background: rgba(15, 118, 110, 0.15);
      color: #0f766e;
    }

    .notification-card.warning .notification-icon {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .notification-card.error .notification-icon {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .notification-message {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin: 0 0 12px 0;
    }

    .notification-meta {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .notification-time {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .notification-action {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--primary-color);
      font-weight: 600;
    }

    .meta-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(2,115,94,0.08);
      color: #035951;
      font-weight: 700;
      font-size: 12px;
    }

    .unread-badge {
      background: var(--error-color);
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 40px;
    }

    .empty-state svg {
      width: 120px;
      height: 120px;
      color: var(--text-secondary);
      opacity: 0.2;
      margin-bottom: 24px;
    }

    .empty-state h3 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: none;
      animation: fadeIn 0.2s ease;
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 20px;
      width: 90%;
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 24px 64px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from {
        transform: translateY(40px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      padding: 32px 32px 24px;
      border-bottom: 2px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      margin: 0;
    }

    .modal-close {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--bg-body);
      border: 2px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: var(--error-color);
      border-color: var(--error-color);
      color: white;
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 32px;
    }

    .modal-notification {
      border-left: 6px solid var(--notification-color);
      padding: 24px;
      background: var(--bg-body);
      border-radius: 12px;
    }

    .modal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 2px solid var(--border-color);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--bg-body);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
    }

    .btn-secondary:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .confirm-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9000;
    }

    .confirm-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 22px;
      border: 1px solid var(--border-color);
      box-shadow: 0 25px 60px rgba(15, 23, 42, 0.35);
      max-width: 420px;
      width: 100%;
    }

    .confirm-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 18px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 640px) {
      main {
        padding: 20px;
      }

      header {
        padding: 20px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .page-title {
        font-size: 20px;
      }
    }
  </style>
</head>
<body data-sidebar-active="notifications">
  <div class="app-shell" data-theme="light" data-accent="#02735E">
    <header style="background: linear-gradient(135deg, #02735E 0%, #035951 50%, #034040 100%); background-size: 200% 200%; animation: aire 8s ease infinite; padding: 0; display: flex; align-items: flex-end;">
      <div class="logo" aria-label="Opsis Suite" style="padding: 18px 32px;">
        <div class="logo-text">
          <div class="logo-title">Opsis Suite</div>
          <div id="company-name-header" style="font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.85); margin-top: 2px;">CVE San Diego</div>
        </div>
      </div>
      <div class="module-tabs" id="module-tabs-container" style="display: flex; gap: 0;"></div>
    </header>
    
    <div class="app-content">
      <aside id="sidebar"></aside>
      <main id="main">
        <section class="page active">
          <div class="page-header" style="flex-wrap:wrap; gap:12px;">
            <div style="display:flex; align-items:center; gap:12px;">
              <button type="button" class="btn btn-secondary back-button" data-return-target="motorsync.html" style="background:rgba(2,115,94,0.1); border:1px solid rgba(2,115,94,0.2); color:#035951;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Volver
              </button>
              <h2 class="page-title">NotifySync</h2>
            </div>
            <div style="display: flex; gap: 10px;">
              <button type="button" class="btn btn-secondary" onclick="markAllAsRead()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Marcar todo como leído
              </button>
              <button type="button" class="btn btn-secondary" onclick="clearAllNotifications()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Limpiar
              </button>
            </div>
          </div>

  <!-- Main Content -->
    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Notificaciones</div>
        <div class="stat-value" id="stat-total">0</div>
        <div class="stat-trend">En el sistema</div>
      </div>
      <div class="stat-card success">
        <div class="stat-label">Éxito</div>
        <div class="stat-value" id="stat-success">0</div>
        <div class="stat-trend">Operaciones exitosas</div>
      </div>
      <div class="stat-card info">
        <div class="stat-label">Información</div>
        <div class="stat-value" id="stat-info">0</div>
        <div class="stat-trend">Actualizaciones del sistema</div>
      </div>
      <div class="stat-card warning">
        <div class="stat-label">Advertencias</div>
        <div class="stat-value" id="stat-warning">0</div>
        <div class="stat-trend">Requieren atención</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
      <div class="filters-header">
        <div class="filters-title" style="display: flex; align-items: center; gap: 8px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          Filtrar notificaciones
        </div>
        <div style="font-size: 13px; color: var(--text-secondary);">
          <span id="filtered-count">0</span> resultados
        </div>
      </div>
      <div class="filter-buttons">
        <button type="button" class="filter-btn active" data-filter="all" onclick="filterNotifications('all')">
          Todas (<span id="filter-count-all">0</span>)
        </button>
        <button type="button" class="filter-btn" data-filter="unread" onclick="filterNotifications('unread')">
          No leídas (<span id="filter-count-unread">0</span>)
        </button>
        <button type="button" class="filter-btn" data-filter="success" onclick="filterNotifications('success')">
          Éxito (<span id="filter-count-success">0</span>)
        </button>
        <button type="button" class="filter-btn" data-filter="info" onclick="filterNotifications('info')">
          Info (<span id="filter-count-info">0</span>)
        </button>
        <button type="button" class="filter-btn" data-filter="warning" onclick="filterNotifications('warning')">
          Advertencia (<span id="filter-count-warning">0</span>)
        </button>
        <button type="button" class="filter-btn" data-filter="error" onclick="filterNotifications('error')">
          Error (<span id="filter-count-error">0</span>)
        </button>
      </div>
    </div>

    <div class="card" style="margin-bottom: 24px;">
      <div class="card-header">
        <div>
          <h3 class="card-title">Eventos y visibilidad</h3>
          <p class="card-subtitle">Cada evento incluye metadata.projectId o metadata.threadId para enlazar directo a ViewSync o ThreadSync según aplique.</p>
        </div>
      </div>
      <div class="table-wrapper">
        <table class="notification-preferences table-compact">
          <thead>
            <tr>
              <th>Módulo</th>
              <th>Evento</th>
              <th>Roles notificados</th>
              <th>Metadata requerida</th>
            </tr>
          </thead>
          <tbody id="notification-rules-table"></tbody>
        </table>
      </div>
    </div>

    <!-- Notifications Grid -->
    <div class="notifications-grid" id="notifications-grid">
      <!-- Notifications will be rendered here -->
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="empty-state" style="display: none;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
      </svg>
      <h3>Todo limpio</h3>
      <p>No hay notificaciones que coincidan con tu filtro</p>
    </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="notification-modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Detalle de Notificación</h2>
        <button type="button" class="modal-close" onclick="closeModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Modal content will be rendered here -->
      </div>
    </div>
  </div>

  <script>
    let currentFilter = 'all';
    let allNotifications = [];
    const notificationRules = [
      { module: 'PlanSync', event: 'Cita confirmada / reagendada', roles: 'Owner, Admin, Técnico asignado', metadata: 'projectId + threadId (si aplica) → ViewSync / ThreadSync' },
      { module: 'ProjectSync', event: 'Etapa finalizada / hito alcanzado', roles: 'Owner, Admin, Cliente', metadata: 'projectId obligatorio → ViewSync' },
      { module: 'ThreadSync', event: 'Nueva respuesta del cliente', roles: 'Owner, Admin, Técnico del thread', metadata: 'threadId obligatorio → ThreadSync' },
      { module: 'ClientSync', event: 'Seguimiento pendiente / próxima visita', roles: 'Owner, Admin', metadata: 'projectId cuando aplica → ViewSync' },
      { module: 'TimeSync', event: 'Cuadrilla sin check-in', roles: 'Supervisores TimeSync', metadata: 'projectId opcional, crewId' }
    ];

    const notificationTypes = {
      success: {
        icon: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>',
        title: 'Éxito'
      },
      error: {
        icon: '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>',
        title: 'Error'
      },
      warning: {
        icon: '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>',
        title: 'Advertencia'
      },
      info: {
        icon: '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>',
        title: 'Información'
      }
    };

    function buildReturnLink(base, extras = {}) {
      if (window.ReturnNav && typeof window.ReturnNav.buildLink === 'function') {
        return window.ReturnNav.buildLink(base, extras);
      }
      const params = new URLSearchParams();
      Object.entries(extras).forEach(([key, value]) => {
        if (value !== undefined && value !== null && `${value}`.length) {
          params.set(key, value);
        }
      });
      const query = params.toString();
      return query ? `${base}?${query}` : base;
    }

    // Initialize
    function init() {
      // Use NotifyManager instead of direct localStorage
      allNotifications = NotifyManager.getAll();
      updateStats();
      renderNotifications();

      // Listen for notification updates from other pages
      window.addEventListener('notificationsUpdated', () => {
        allNotifications = NotifyManager.getAll();
        updateStats();
        renderNotifications();
      });
    }

    // Update Stats
    function updateStats() {
      const stats = NotifyManager.getStats();

      document.getElementById('stat-total').textContent = stats.total;
      document.getElementById('stat-success').textContent = stats.byType.success;
      document.getElementById('stat-info').textContent = stats.byType.info;
      document.getElementById('stat-warning').textContent = stats.byType.warning;

      document.getElementById('filter-count-all').textContent = stats.total;
      document.getElementById('filter-count-unread').textContent = stats.unread;
      document.getElementById('filter-count-success').textContent = stats.byType.success;
      document.getElementById('filter-count-info').textContent = stats.byType.info;
      document.getElementById('filter-count-warning').textContent = stats.byType.warning;
      document.getElementById('filter-count-error').textContent = stats.byType.error;
    }

    // Filter Notifications
    function filterNotifications(filter) {
      currentFilter = filter;
      
      // Update active button
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });

      renderNotifications();
    }

    function buildLink(notification) {
      if (notification.link) return notification.link;
      const meta = notification.metadata || {};

      if (meta.viewUrl) return meta.viewUrl;
      if (meta.projectUrl) return meta.projectUrl;

      const projectId = meta.projectId || meta.project_id || meta.project || meta.idSync || meta.id;
      const threadId = meta.threadId || meta.thread_id;

      if (notification.module === 'projectsync' || projectId) {
        return buildReturnLink('viewsync.html', projectId ? { id: projectId } : {});
      }

      if (notification.module === 'threadsync' || threadId) {
        return threadId
          ? buildReturnLink('threadsync.html', { id: threadId })
          : buildReturnLink('threadview.html');
      }

      if (notification.module === 'plansync') return buildReturnLink('plansync.html');
      if (notification.module === 'howsync') return buildReturnLink('howsync.html');
      if (notification.module === 'clientsync') return buildReturnLink('clientsync.html');
      if (notification.module === 'analytics') return buildReturnLink('analytics.html');

      return null;
    }

    function getLinkText(notification) {
      if (notification.linkText) return notification.linkText;
      if (notification.module === 'projectsync') return 'Ver proyecto';
      if (notification.module === 'threadsync') return 'Abrir thread';
      if (notification.module === 'plansync') return 'Ver agenda';
      if (notification.module === 'howsync') return 'Abrir tareas';
      if (notification.module === 'clientsync') return 'Ver cliente';
      return 'Ver detalle';
    }

    // Render Notifications
    function renderNotifications() {
      let filtered = [...allNotifications];

      if (currentFilter === 'unread') {
        filtered = filtered.filter(n => !n.read);
      } else if (currentFilter !== 'all') {
        filtered = filtered.filter(n => n.type === currentFilter);
      }

      filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      const grid = document.getElementById('notifications-grid');
      const empty = document.getElementById('empty-state');
      const filteredCount = document.getElementById('filtered-count');

      filteredCount.textContent = filtered.length;

      if (filtered.length === 0) {
        grid.style.display = 'none';
        empty.style.display = 'block';
        return;
      }

      grid.style.display = 'grid';
      empty.style.display = 'none';

      grid.innerHTML = filtered.map(notification => {
        const type = notificationTypes[notification.type] || notificationTypes.info;
        const timeAgo = formatTimeAgo(notification.timestamp);
        const resolvedLink = buildLink(notification);
        const linkText = getLinkText(notification);

        return `
          <div class="notification-card ${notification.type} ${!notification.read ? 'unread' : ''}" onclick="openModal('${notification.id}')">
            <div class="notification-header">
              <div class="notification-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                  ${type.icon}
                </svg>
              </div>
              <div class="notification-content">
                <h3 class="notification-title">
                  ${notification.title}
                  ${!notification.read ? '<span class="unread-badge">Nueva</span>' : ''}
                </h3>
                <p class="notification-message">${notification.message}</p>
                <div class="notification-meta">
                  <div class="notification-time">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    ${timeAgo}
                  </div>
                  ${resolvedLink ? `
                    <div class="notification-action">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                        <polyline points="12 5 19 12 12 19"></polyline>
                      </svg>
                      ${linkText}
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Open Modal
    function openModal(notificationId) {
      const notification = allNotifications.find(n => n.id === notificationId);
      if (!notification) return;

      // Mark as read using NotifyManager
      if (!notification.read) {
        NotifyManager.markAsRead(notificationId);
        allNotifications = NotifyManager.getAll();
        updateStats();
        renderNotifications();
      }

      const type = notificationTypes[notification.type] || notificationTypes.info;
      const modal = document.getElementById('notification-modal');
      const modalBody = document.getElementById('modal-body');
      const resolvedLink = buildLink(notification);
      const linkText = getLinkText(notification);
      const meta = notification.metadata || {};

      const metaBadges = [];
      if (notification.module) metaBadges.push(`<span class="meta-pill"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>${notification.module}</span>`);
      if (meta.projectId) metaBadges.push(`<span class="meta-pill"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="14" rx="2"></rect><path d="M3 7h18"></path></svg>Proyecto ${meta.projectId}</span>`);
      if (meta.threadId) metaBadges.push(`<span class="meta-pill"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>Thread ${meta.threadId}</span>`);
      if (meta.clientId) metaBadges.push(`<span class="meta-pill"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="7" r="4"></circle><path d="M5.5 21a6.5 6.5 0 0 1 13 0"></path></svg>Cliente ${meta.clientId}</span>`);

      modalBody.innerHTML = `
        <div class="modal-notification ${notification.type}">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
            <div class="notification-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                ${type.icon}
              </svg>
            </div>
            <div>
              <h3 style="font-size: 20px; font-weight: 700; margin: 0 0 4px 0;">${notification.title}</h3>
              <div style="font-size: 13px; color: var(--text-secondary);">${formatTimeAgo(notification.timestamp)}</div>
            </div>
          </div>
          <p style="font-size: 15px; color: var(--text-primary); line-height: 1.7; margin: 0 0 24px 0;">${notification.message}</p>
          ${metaBadges.length ? `<div class="meta-badges" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px;">${metaBadges.join('')}</div>` : ''}
          ${resolvedLink ? `
            <div class="modal-footer">
              <div style="font-size: 13px; color: var(--text-secondary);">
                ID: ${notification.id}
              </div>
              <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="window.location.href='${resolvedLink}'">
                  ${linkText}
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                    <polyline points="12 5 19 12 12 19"></polyline>
                  </svg>
                </button>
              </div>
            </div>
          ` : `
            <div class="modal-footer">
              <div style="font-size: 13px; color: var(--text-secondary);">
                ID: ${notification.id}
              </div>
              <button type="button" class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
            </div>
          `}
        </div>
      `;

      modal.classList.add('show');
    }

    // Close Modal
    function closeModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('notification-modal').classList.remove('show');
    }

    // Mark All As Read
    function markAllAsRead() {
      NotifyManager.markAllAsRead();
      allNotifications = NotifyManager.getAll();
      updateStats();
      renderNotifications();
      showToast('success', 'Todas las notificaciones marcadas como leídas');
    }

    // Clear All
    function clearAllNotifications() {
      systemConfirm('¿Eliminar todas las notificaciones del historial?', { confirmText: 'Eliminar' }).then((confirmed) => {
        if (!confirmed) return;
        NotifyManager.deleteAll();
        allNotifications = [];
        updateStats();
        renderNotifications();
        showToast('info', 'Todas las notificaciones han sido eliminadas');
      });
    }

    // Format Time Ago
    function formatTimeAgo(timestamp) {
      const now = new Date();
      const time = new Date(timestamp);
      const diffInSeconds = Math.floor((now - time) / 1000);
      
      if (diffInSeconds < 60) return 'Hace un momento';
      if (diffInSeconds < 3600) return `Hace ${Math.floor(diffInSeconds / 60)} minutos`;
      if (diffInSeconds < 86400) return `Hace ${Math.floor(diffInSeconds / 3600)} horas`;
      if (diffInSeconds < 604800) return `Hace ${Math.floor(diffInSeconds / 86400)} días`;
      
      return time.toLocaleDateString('es-MX', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // Show Toast
    function showToast(type, message) {
      const accentMap = {
        success: '#10b981',
        info: '#0f766e',
        warning: '#d97706',
        error: '#dc2626'
      };

      const accentBgMap = {
        success: 'rgba(16, 185, 129, 0.15)',
        info: 'rgba(15, 118, 110, 0.15)',
        warning: 'rgba(217, 119, 6, 0.15)',
        error: 'rgba(220, 38, 38, 0.15)'
      };

      const accent = accentMap[type] || accentMap.info;
      const accentBg = accentBgMap[type] || accentBgMap.info;

      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 24px;
        right: 24px;
        background: var(--bg-card);
        border: 2px solid ${accent};
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 320px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
      `;

      const icon = notificationTypes[type]?.icon || notificationTypes.info.icon;
      const title = notificationTypes[type]?.title || 'Notificación';

      toast.innerHTML = `
        <div style="width: 40px; height: 40px; border-radius: 10px; background: ${accentBg}; display: flex; align-items: center; justify-content: center; color: ${accent};">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            ${icon}
          </svg>
        </div>
        <div style="flex: 1;">
          <div style="font-weight: 700; font-size: 14px; color: var(--text-primary); margin-bottom: 2px;">${title}</div>
          <div style="font-size: 13px; color: var(--text-secondary);">${message}</div>
        </div>
      `;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    function systemConfirm(message, { confirmText = 'Confirmar', cancelText = 'Cancelar' } = {}) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'confirm-overlay';
        overlay.innerHTML = `
          <div class="confirm-card">
            <p>${message}</p>
            <div class="confirm-actions">
              <button class="btn btn-secondary">${cancelText}</button>
              <button class="btn btn-primary">${confirmText}</button>
            </div>
          </div>
        `;
        const [cancelBtn, confirmBtn] = overlay.querySelectorAll('button');
        cancelBtn.addEventListener('click', () => {
          overlay.remove();
          resolve(false);
        });
        confirmBtn.addEventListener('click', () => {
          overlay.remove();
          resolve(true);
        });
        overlay.addEventListener('click', (event) => {
          if (event.target === overlay) {
            overlay.remove();
            resolve(false);
          }
        });
        document.body.appendChild(overlay);
      });
    }

    function renderNotificationRules() {
      const tbody = document.getElementById('notification-rules-table');
      if (!tbody) return;
      tbody.innerHTML = notificationRules.map(rule => `
        <tr>
          <td>${rule.module}</td>
          <td>${rule.event}</td>
          <td>${rule.roles}</td>
          <td>${rule.metadata}</td>
        </tr>
      `).join('');
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      NotifyManager.init();
      init();
      renderNotificationRules();
    });
  </script>

  <style>
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  </style>

</body>
</html>
