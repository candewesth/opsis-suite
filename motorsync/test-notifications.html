<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test NotifyManager - Demo Interactivo</title>
  <script src="js/seeds.js?v=verdi2"></script>
  <script src="js/modules.js?v=verdi2"></script>
  <script src="notifications-manager.js"></script>
  <script src="./js/ui-feedback.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #02735E 0%, #035951 60%, #034040 100%);
      padding: 40px 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 48px;
      margin-bottom: 12px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .header p {
      font-size: 18px;
      opacity: 0.9;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .card h2 {
      font-size: 20px;
      margin-bottom: 16px;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      width: 100%;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-success { background: #10b981; color: white; }
    .btn-info { background: #0ea5e9; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-error { background: #ef4444; color: white; }
    .btn-secondary { background: #64748b; color: white; }
    .btn-primary { background: #02735E; color: white; }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-box {
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #1e293b;
    }

    .stat-label {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .module-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: #f1f5f9;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .toggle {
      position: relative;
      width: 50px;
      height: 26px;
      background: #cbd5e1;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle.active {
      background: #10b981;
    }

    .toggle::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.3s;
    }

    .toggle.active::after {
      transform: translateX(24px);
    }

    .log {
      background: #1e293b;
      color: #e2e8f0;
      padding: 16px;
      border-radius: 12px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      line-height: 1.6;
    }

    .log-entry {
      margin-bottom: 8px;
      padding-left: 12px;
      border-left: 3px solid #3b82f6;
    }

    .notification-preview {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 4px solid;
      background: #f8fafc;
    }

    .notification-preview.success { border-color: #10b981; }
    .notification-preview.info { border-color: #3b82f6; }
    .notification-preview.warning { border-color: #f59e0b; }
    .notification-preview.error { border-color: #ef4444; }

    .notification-preview h4 {
      font-size: 14px;
      margin-bottom: 4px;
      color: #1e293b;
    }

    .notification-preview p {
      font-size: 12px;
      color: #64748b;
    }
  </style>
</head>
<body>
  
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>NotifyManager Demo</h1>
      <p>Sistema Central de Notificaciones - Prueba Interactiva</p>
    </div>

    <!-- Stats -->
    <div class="card">
      <h2>üìä Estad√≠sticas en Tiempo Real</h2>
      <div class="stats" id="stats-grid">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Test Actions -->
    <div class="grid" id="demo-actions"></div>

    <!-- Module Toggles -->
    <div class="card">
      <h2>üîå M√≥dulos Activos</h2>
      <div id="module-toggles">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Recent Notifications -->
    <div class="card">
      <h2>üì¨ √öltimas Notificaciones (5 m√°s recientes)</h2>
      <div id="recent-notifications">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Console Log -->
    <div class="card">
      <h2>Console Log</h2>
      <div class="log" id="console-log">
        <div class="log-entry">Sistema iniciado. Listo para crear notificaciones.</div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================================
    // TEST FUNCTIONS
    // ============================================================================

    // ProjectSync Tests
    function getSeedProject() {
      try {
        const projects = DemoSeeds && typeof DemoSeeds.getProjects === 'function' ? DemoSeeds.getProjects() : [];
        return projects[0] || { id: 'project-1', idSync: 'IDSYNC-1001', name: 'Proyecto Demo' };
      } catch {
        return { id: 'project-1', idSync: 'IDSYNC-1001', name: 'Proyecto Demo' };
      }
    }

    function testProjectSync(type) {
      const project = getSeedProject();
      const projectId = project.idSync || project.id || 'project-1';
      const scenarios = {
        success: {
          type: 'success',
          title: 'Proyecto Completado',
          message: `El proyecto "${project.name || projectId}" ha sido marcado como completado.`,
          link: `viewsync.html?id=${projectId}`,
          metadata: { projectId }
        },
        info: {
          type: 'info',
          title: 'Nuevo Proyecto Creado',
          message: `Se cre√≥ el proyecto "${project.name || projectId}" en el sistema.`,
          link: `viewsync.html?id=${projectId}`,
          metadata: { projectId }
        },
        warning: {
          type: 'warning',
          title: 'Proyecto en Pausa',
          message: `El proyecto "${project.name || projectId}" fue puesto en pausa.`,
          link: `viewsync.html?id=${projectId}`,
          metadata: { projectId }
        }
      };

      const scenario = scenarios[type];
      NotifyManager.create({
        ...scenario,
        module: 'projectsync'
      });

      log(`ProjectSync: ${scenario.title}`, 'success');
      updateUI();
    }

    // TimeSync Tests
    function testTimeSync(action) {
      const scenarios = {
        approved: {
          type: 'success',
          title: 'Timesheet Aprobado',
          message: 'Tu timesheet de la semana del 25-29 Nov ha sido aprobado por el supervisor.'
        },
        rejected: {
          type: 'error',
          title: 'Timesheet Rechazado',
          message: 'Tu timesheet requiere correcciones. Revisa los comentarios del supervisor.'
        },
        submitted: {
          type: 'info',
          title: 'Timesheet Enviado',
          message: 'Timesheet enviado exitosamente. Esperando aprobaci√≥n.'
        }
      };

      const scenario = scenarios[action];
      NotifyManager.create({
        ...scenario,
        module: 'timesync',
        link: 'motorsync.html',
        metadata: { timesheetId: Math.floor(Math.random() * 1000) }
      });

      log(`TimeSync: ${scenario.title}`, 'info');
      updateUI();
    }

    // ThreadSync Tests
    function getSeedThread() {
      try {
        if (DemoSeeds && typeof DemoSeeds.getThreadListMap === 'function') {
          const map = DemoSeeds.getThreadListMap();
          const firstKey = Object.keys(map || {})[0];
          const list = map[firstKey] || [];
          if (list.length) return list[0];
        }
      } catch (err) {
        console.warn('No thread seeds', err);
      }
      return { id: 'thread-1', subject: 'Thread Demo', projectId: 'project-1' };
    }

    function testThreadSync(action) {
      const thread = getSeedThread();
      const threadId = thread.id || thread.threadId || 'thread-1';
      const projectId = thread.projectId || 'project-1';
      const scenarios = {
        message: {
          type: 'info',
          title: 'Nuevo Mensaje',
          message: `${thread.owner || 'Cliente'}: "${thread.subject || 'Actualiza el thread'}"`,
          metadata: { threadId, projectId }
        },
        mention: {
          type: 'warning',
          title: 'Te Mencionaron',
          message: `Menci√≥n en thread "${thread.subject || threadId}"`,
          metadata: { threadId, projectId }
        }
      };

      const scenario = scenarios[action];
      NotifyManager.create({
        ...scenario,
        module: 'threadsync',
        link: `threadview.html?id=${threadId}`
      });

      log(`ThreadSync: ${scenario.title}`, 'warning');
      updateUI();
    }

    // Warehouse Tests
    function testWarehouse(action) {
      const scenarios = {
        lowstock: {
          type: 'warning',
          title: 'Stock Bajo',
          message: 'Tornillos M8x20: Solo quedan 15 unidades (m√≠nimo: 50)',
          metadata: { itemId: 'M8-20' }
        },
        maintenance: {
          type: 'info',
          title: 'Mantenimiento Programado',
          message: 'Equipo #EQ-2024-087 requiere mantenimiento el 5 de diciembre',
          metadata: { warehouseId: 'EQ-2024-087' }
        }
      };

      const scenario = scenarios[action];
      NotifyManager.create({
        ...scenario,
        module: 'warehouse'
      });

      log(`Warehouse: ${scenario.title}`, 'warning');
      updateUI();
    }

    // Estimator Tests
    function testEstimator(action) {
      const scenarios = {
        created: {
          type: 'success',
          title: 'Nueva Cotizaci√≥n',
          message: 'Cotizaci√≥n #COT-2024-156 creada para Cliente ABC - Total: $25,000'
        },
        approval: {
          type: 'warning',
          title: 'Requiere Aprobaci√≥n',
          message: 'Cotizaci√≥n #COT-2024-157 supera el l√≠mite autorizado ($50,000). Aprobaci√≥n requerida.'
        }
      };

      const scenario = scenarios[action];
      NotifyManager.create({
        ...scenario,
        module: 'estimator',
        link: 'motorsync.html',
        metadata: { quoteId: Math.floor(Math.random() * 1000) }
      });

      log(`Estimator: ${scenario.title}`, 'success');
      updateUI();
    }

    // System Actions
    function viewNotifications() {
      window.location.href = 'NotifySync.html';
    }

    async function clearAll() {
      const ok = await uiConfirm('¬øEliminar todas las notificaciones?', { confirmText: 'Eliminar', cancelText: 'Cancelar' });
      if (!ok) return;
      NotifyManager.deleteAll();
      log('Sistema: Todas las notificaciones eliminadas', 'error');
      uiToast('success', 'Notificaciones eliminadas.');
      updateUI();
    }

    // ============================================================================
    // UI UPDATES
    // ============================================================================

    function updateUI() {
      updateStats();
      updateRecentNotifications();
      updateModuleToggles();
    }

    function updateStats() {
      const stats = NotifyManager.getStats();
      const statsGrid = document.getElementById('stats-grid');

      statsGrid.innerHTML = `
        <div class="stat-box">
          <div class="stat-value">${stats.total}</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">${stats.unread}</div>
          <div class="stat-label">No Le√≠das</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">${stats.byType.success}</div>
          <div class="stat-label">√âxito</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">${stats.byType.info}</div>
          <div class="stat-label">Info</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">${stats.byType.warning}</div>
          <div class="stat-label">Alertas</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">${stats.byType.error}</div>
          <div class="stat-label">Errores</div>
        </div>
      `;
    }

    function updateRecentNotifications() {
      const recent = NotifyManager.getAll().slice(0, 5);
      const container = document.getElementById('recent-notifications');

      if (recent.length === 0) {
        container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">No hay notificaciones a√∫n. Crea una usando los botones arriba.</p>';
        return;
      }

      container.innerHTML = recent.map(n => `
        <div class="notification-preview ${n.type}">
          <h4>${n.title}</h4>
          <p>${n.message}</p>
          <small style="color: #94a3b8; font-size: 11px;">
            ${n.moduleName} ‚Ä¢ ${new Date(n.timestamp).toLocaleString('es-MX')}
          </small>
        </div>
      `).join('');
    }

    function updateModuleToggles() {
      const container = document.getElementById('module-toggles');
      const modules = Object.values(NotifyManager.MODULES);

      container.innerHTML = modules.map(module => {
        const isActive = NotifyManager.isModuleActive(module.id);
        return `
          <div class="module-toggle">
            <span>${module.name}</span>
            <div class="toggle ${isActive ? 'active' : ''}" 
                 onclick="toggleModule('${module.id}', this)">
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleModule(moduleId, element) {
      const isActive = NotifyManager.isModuleActive(moduleId);
      NotifyManager.setModuleActive(moduleId, !isActive);
      element.classList.toggle('active');
      log(`M√≥dulo ${moduleId}: ${!isActive ? 'activado' : 'desactivado'}`, 'info');
    }

    function log(message, type = 'info') {
      const logContainer = document.getElementById('console-log');
      const timestamp = new Date().toLocaleTimeString('es-MX');
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      logEntry.textContent = `[${timestamp}] ${message}`;
      logContainer.insertBefore(logEntry, logContainer.firstChild);

      // Limit to 20 entries
      while (logContainer.children.length > 20) {
        logContainer.removeChild(logContainer.lastChild);
      }
    }

    // Demo actions din√°micos basados en seeds
    function buildDemoActions() {
      const container = document.getElementById('demo-actions');
      if (!container) return;
      const cards = [
        { title: 'üìÅ ProjectSync', actions: [
          { label: 'Proyecto Completado', handler: () => testProjectSync('success'), variant: 'success' },
          { label: 'Nuevo Proyecto', handler: () => testProjectSync('info'), variant: 'info' },
          { label: 'Cambio de Estado', handler: () => testProjectSync('warning'), variant: 'warning' },
        ]},
        { title: 'TimeSync', actions: [
          { label: 'Timesheet Aprobado', handler: () => testTimeSync('approved'), variant: 'success' },
          { label: 'Timesheet Rechazado', handler: () => testTimeSync('rejected'), variant: 'error' },
          { label: 'Timesheet Enviado', handler: () => testTimeSync('submitted'), variant: 'info' },
        ]},
        { title: 'üí¨ ThreadSync', actions: [
          { label: 'Nuevo Mensaje', handler: () => testThreadSync('message'), variant: 'info' },
          { label: 'Te Mencionaron', handler: () => testThreadSync('mention'), variant: 'warning' },
        ]},
        { title: 'üì¶ Warehouse', actions: [
          { label: 'Stock Bajo', handler: () => testWarehouse('lowstock'), variant: 'warning' },
          { label: 'Mantenimiento', handler: () => testWarehouse('maintenance'), variant: 'info' },
        ]},
        { title: 'üí∞ Estimator', actions: [
          { label: 'Nueva Cotizaci√≥n', handler: () => testEstimator('new'), variant: 'info' },
          { label: 'Requiere Aprobaci√≥n', handler: () => testEstimator('approval'), variant: 'warning' },
        ]},
        { title: 'Limpiar', actions: [
          { label: 'Limpiar Todas', handler: () => clearAll(), variant: 'secondary' }
        ]}
      ];

      container.innerHTML = '';
      cards.forEach((card) => {
        const cardEl = document.createElement('div');
        cardEl.className = 'card';
        const title = document.createElement('h2');
        title.textContent = card.title;
        cardEl.appendChild(title);
        card.actions.forEach((action) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = `btn btn-${action.variant}`;
          btn.textContent = action.label;
          btn.addEventListener('click', action.handler);
          cardEl.appendChild(btn);
        });
        container.appendChild(cardEl);
      });
    }

    // Listen for notification updates
    window.addEventListener('notificationsUpdated', (event) => {
      log(`Actualizaci√≥n: ${event.detail.count} notificaciones (${event.detail.unreadCount} sin leer)`, 'info');
      updateUI();
    });

    // Initialize
    updateUI();
    buildDemoActions();
  </script>

</body>
</html>
