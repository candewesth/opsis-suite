<!DOCTYPE html>
<html lang="es" data-theme="light" style="--primary-color: #02735E;"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MotorSync - Sistema Operacional Completo | Opsis Suite</title>
  <link rel="preconnect" href="https://fonts.googleapis.com/">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Helvetica+Neue:wght@400;500;600;700;900&display=swap">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    (function () {
      try {
        var settings = JSON.parse(localStorage.getItem('opsis_settings') || '{}');
        var theme = settings.theme || 'light';
        document.documentElement.dataset.theme = theme;
        if (settings.accent) {
          document.documentElement.style.setProperty('--primary-color', settings.accent);
        }
      } catch (err) {
        document.documentElement.dataset.theme = 'light';
      }
    })();
  </script>
  <style>
    :root {
      /* VERDI Color Palette */
      --verdi-dark: #022326;
      --verdi-mid: #034040;
      --verdi-accent: #035951;
      --verdi-light: #02735E;
      
      --primary-color: #02735E;
      --accent-color: #035951;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --bg-body: #fafafa;
      --bg-card: #ffffff;
      --border-color: #ebebeb;
      --surface-page-a: #fafafa;
      --surface-page-b: #f7f7f7;
      --surface-page-dark-a: #1b2538;
      --surface-page-dark-b: #151d2c;
      --table-header-bg: #fafafa;
    }

    [data-theme='dark'] {
      /* Global dark mode variables (homogenized to neutral grays for modules)
         - Panels / modules will use a gray -> darker gray gradient to match
           the desired look from the Settings page. */
      --text-primary: #f8fafc;
      --text-secondary: #b8c4dd;
      --bg-body: #0f172a;
      --bg-card: #0f1316;
      --border-color: rgba(255,255,255,0.04);
      --surface-page-dark-a: #2b2f33; /* lighter panel gray */
      --surface-page-dark-b: #0f1214; /* darker panel gray */
      --surface-page-a: var(--surface-page-dark-a);
      --surface-page-b: var(--surface-page-dark-b);
      --table-header-bg: #0b1220;
    }

    /* Centralized dark-mode panel styling: force a consistent gray gradient
       for all module-like containers so the UI looks homogeneous. This
       overrides scattered light gradients and ensures readable text and
       visible table lines. */
    html[data-theme='dark'] .portal-section,
    html[data-theme='dark'] .portal-detail-card,
    html[data-theme='dark'] .portal-grid,
    html[data-theme='dark'] .billing-column,
    html[data-theme='dark'] .billing-layout,
    html[data-theme='dark'] .billing-column .billing-list,
    html[data-theme='dark'] .billing-item,
    html[data-theme='dark'] .summary-card,
    html[data-theme='dark'] .portal-detail-card .summary-card,
    html[data-theme='dark'] .billing-history-card,
    html[data-theme='dark'] .customer-detail-card,
    html[data-theme='dark'] .portal-detail-card .billing-list {
      background: linear-gradient(180deg, var(--surface-page-dark-a), var(--surface-page-dark-b)) !important;
      border-color: var(--border-color) !important;
      box-shadow: 0 20px 48px rgba(0,0,0,0.6) !important;
      color: var(--text-primary) !important;
    }

    /* Ensure inner text and table lines remain readable */
    html[data-theme='dark'] .portal-section *,
    html[data-theme='dark'] .portal-detail-card *,
    html[data-theme='dark'] .billing-column * {
      color: inherit !important;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Helvetica Neue', Helvetica, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-body);
      color: var(--text-primary);
      font-weight: 400;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      25% { background-position: 100% 50%; }
      50% { background-position: 100% 100%; }
      75% { background-position: 0% 100%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes aire {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* Module Tabs */
        .module-tab {
            padding: 10px 28px;
            border-radius: 10px 10px 0 0;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            background: rgba(2, 115, 94, 0.15);
            color: #64748b;
            text-decoration: none;
        }    .module-tab:hover {
      background: rgba(2, 115, 94, 0.25) !important;
      color: #475569 !important;
    }

    .module-tab.active {
      background: white !important;
      color: #02735E !important;
    }

    a.skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--primary-color);
      color: #fff;
      padding: 8px 16px;
      border-radius: 0 0 8px 0;
      text-decoration: none;
      z-index: 1000;
    }

    a.skip-link:focus {
      top: 0;
    }

    :focus-visible {
      outline: 2px solid var(--accent-color);
      outline-offset: 2px;
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .app-content {
      display: grid;
      grid-template-columns: 70px 1fr;
      flex: 1;
      transition: grid-template-columns 0.3s ease;
    }

    .app-shell.sidebar-collapsed .app-content {
      grid-template-columns: 70px 1fr;
    }

    header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 20px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }

    .logo-title {
      font-size: 26px;
      font-weight: 700;
      color: #ffffff;
      text-transform: none;
      letter-spacing: -0.3px;
    }

    .sidebar-item {
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #1e293b;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
      white-space: nowrap;
    }
    
    .sidebar-item svg {
      color: #1e293b;
      transition: color 0.3s ease;
      width: 20px;
      height: 20px;
      min-width: 20px;
      min-height: 20px;
    }

    aside:not(:hover) .sidebar-item {
      justify-content: center;
      padding: 14px;
    }

    /* Sistema de opacity solo para sidebar NO colapsado */
    aside:not(.collapsed):not(:hover) .sidebar-item span {
      opacity: 0;
      width: 0;
      overflow: hidden;
    }

    aside:not(.collapsed):hover .sidebar-item span {
      opacity: 1;
      width: auto;
    }

    .sidebar-item.active {
      background: white;
      color: #02735E;
      border-left-color: #02735E;
    }
    
    .sidebar-item.active svg {
      color: #02735E;
    }

    .sidebar-item:hover {
      background: rgba(2, 115, 94, 0.06);
      color: #02735E;
      border-left-color: #02735E;
    }
    
    .sidebar-item:hover svg {
      color: #02735E;
    }

    aside {
      background: var(--bg-card);
      border-right: 1px solid var(--border-color);
      padding: 24px 0;
      position: sticky;
      top: 64px;
      height: calc(100vh - 64px);
      overflow-y: auto;
      overflow-x: hidden;
      transition: all 0.3s ease;
      width: 70px;
      z-index: 100;
    }

    /* NO expandir automáticamente si tiene clase collapsed - usar solo hover-expanded */
    aside:not(.collapsed):hover {
      width: 250px;
    }

    aside.collapsed {
      width: 70px;
    }
    
    /* Expandir sidebar temporalmente al hacer hover */
    aside.collapsed.hover-expanded {
      width: 250px;
    }
    
    aside.collapsed.hover-expanded .sidebar-item span {
      display: inline !important;
      position: static !important;
      transform: none !important;
      background: transparent !important;
      color: inherit !important;
      padding: 0 !important;
      margin: 0 !important;
      box-shadow: none !important;
      white-space: normal !important;
      pointer-events: auto !important;
      font-size: inherit !important;
      border-radius: 0 !important;
      z-index: auto !important;
    }
    
    aside.collapsed.hover-expanded .sidebar-item span::before {
      display: none !important;
    }
    
    aside.collapsed.hover-expanded .sidebar-item {
      justify-content: flex-start !important;
      padding: 14px 16px !important;
      color: #1e293b !important;
    }
    
    aside.collapsed.hover-expanded .sidebar-item.active {
      color: #02735E !important;
      background: white !important;
    }
    
    aside.collapsed.hover-expanded .sidebar-item svg {
      margin-right: 12px !important;
      margin-left: 0 !important;
      color: inherit !important;
    }
    
    aside.collapsed.hover-expanded .sidebar-item:hover {
      background: rgba(2, 115, 94, 0.06) !important;
      color: #02735E !important;
    }

    aside.collapsed .sidebar-item span {
      display: none;
    }

    aside.collapsed .sidebar-item {
      justify-content: center;
      padding: 14px 0;
      border-left: none;
      position: relative;
    }

    aside.collapsed .sidebar-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 0;
      background: #02735E;
      transition: height 0.3s ease;
    }

    aside.collapsed .sidebar-item.active::before,
    aside.collapsed .sidebar-item:hover::before {
      height: 70%;
    }

    aside.collapsed .sidebar-item svg {
      margin: 0;
    }

    aside.collapsed .sidebar-item:hover {
      background: rgba(2, 115, 94, 0.06);
      border-left: none;
    }

    /* Tooltip para sidebar colapsado */
    aside.collapsed .sidebar-item {
      position: relative;
    }

    aside.collapsed .sidebar-item span {
      display: none;
      position: absolute;
      left: 100%;
      top: 50%;
      transform: translateY(-50%);
      background: #1e293b;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      white-space: nowrap;
      margin-left: 12px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      pointer-events: none;
    }

    aside.collapsed .sidebar-item span::before {
      content: '';
      position: absolute;
      right: 100%;
      top: 50%;
      transform: translateY(-50%);
      border: 6px solid transparent;
      border-right-color: #1e293b;
    }

    aside.collapsed .sidebar-item:hover span {
      display: block;
    }
    
    /* NO mostrar tooltip cuando sidebar está expandido por hover */
    aside.collapsed.hover-expanded .sidebar-item span::before {
      content: none !important;
      display: none !important;
    }

    main {
      padding: 16px 24px;
    }

    .page {
      display: none;
      flex-direction: column;
      gap: 20px;
      background: var(--surface-page-a);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(28, 37, 54, 0.08);
      box-shadow: 0 30px 50px rgba(15, 23, 42, 0.08);
    }

    .page[hidden] {
      display: none !important;
    }

    .settings-brand-card {
      display: none;
    }

    .settings-locale-card {
      display: none;
    }

    .settings-notifications-card {
      display: none;
    }
    .settings-role-access-card {
      display: none;
    }

    #page-settings.active .settings-brand-card,
    #page-settings.active .settings-locale-card,
    #page-settings.active .settings-notifications-card,
    #page-settings.active .settings-role-access-card {
      display: block;
    }

    .role-access-table {
      width: 100%;
      border-collapse: collapse;
    }

    .role-access-table th,
    .role-access-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
    }

    .role-access-table th {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }

    .role-access-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(2, 115, 94, 0.08);
      color: #02735E;
      margin: 2px;
    }

    .page:nth-of-type(even) {
      background: var(--surface-page-b);
    }

    [data-theme='dark'] .page {
      border-color: rgba(148, 163, 184, 0.12);
      box-shadow: 0 20px 45px rgba(2, 6, 23, 0.65);
    }

    .page.active {
      display: flex;
      animation: fade 0.2s ease;
    }

    #page-dashboard {
      background: linear-gradient(135deg, rgba(2, 115, 94, 0.08), rgba(3, 89, 81, 0.04));
      border-color: rgba(2, 115, 94, 0.15);
    }

    #page-schedule {
      background: linear-gradient(135deg, rgba(3, 89, 81, 0.1), rgba(3, 64, 64, 0.05));
      border-color: rgba(2, 115, 94, 0.2);
    }

    #page-quotes {
      background: linear-gradient(135deg, rgba(2, 115, 94, 0.12), rgba(3, 89, 81, 0.06));
      border-color: rgba(2, 115, 94, 0.2);
    }

    #page-customers {
      background: linear-gradient(135deg, rgba(3, 64, 64, 0.1), rgba(2, 35, 38, 0.05));
      border-color: rgba(2, 115, 94, 0.18);
    }

    #page-inventory {
      background: linear-gradient(135deg, rgba(2, 115, 94, 0.1), rgba(3, 89, 81, 0.04));
      border-color: rgba(2, 115, 94, 0.22);
    }

    #page-reports {
      background: linear-gradient(135deg, rgba(3, 89, 81, 0.12), rgba(3, 64, 64, 0.06));
      border-color: rgba(2, 115, 94, 0.25);
    }

    #page-staff {
      background: linear-gradient(135deg, rgba(2, 35, 38, 0.1), rgba(3, 64, 64, 0.04));
      border-color: rgba(2, 115, 94, 0.2);
    }

    #page-management {
      background: linear-gradient(135deg, rgba(3, 64, 64, 0.08), rgba(2, 35, 38, 0.04));
      border-color: rgba(2, 115, 94, 0.15);
    }

    #page-roles {
      background: linear-gradient(135deg, rgba(2, 115, 94, 0.1), rgba(3, 89, 81, 0.04));
      border-color: rgba(2, 115, 94, 0.18);
    }

    #page-settings {
      background: linear-gradient(135deg, rgba(2, 115, 94, 0.06), rgba(3, 89, 81, 0.03));
      border-color: rgba(2, 115, 94, 0.12);
    }

    [data-theme='dark'] #page-dashboard,
    [data-theme='dark'] #page-schedule,
    [data-theme='dark'] #page-quotes,
    [data-theme='dark'] #page-customers,
    [data-theme='dark'] #page-inventory,
    [data-theme='dark'] #page-reports,
    [data-theme='dark'] #page-staff,
    [data-theme='dark'] #page-management,
    [data-theme='dark'] #page-roles,
    [data-theme='dark'] #page-settings {
      border-color: rgba(255, 255, 255, 0.07);
      box-shadow: 0 30px 70px rgba(2, 6, 23, 0.7);
    }

    [data-theme='dark'] #page-dashboard {
      background: linear-gradient(135deg, rgba(2, 115, 94, 0.22), rgba(7, 11, 23, 0.85));
    }

    [data-theme='dark'] #page-schedule {
      background: linear-gradient(135deg, rgba(240, 140, 0, 0.18), rgba(73, 12, 34, 0.85));
    }

    [data-theme='dark'] #page-quotes {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(2, 44, 34, 0.9));
    }

    [data-theme='dark'] #page-customers {
      background: linear-gradient(135deg, rgba(88, 28, 135, 0.35), rgba(25, 25, 60, 0.85));
    }

    [data-theme='dark'] #page-inventory {
      background: linear-gradient(135deg, rgba(20, 83, 45, 0.6), rgba(4, 17, 10, 0.95));
    }

    [data-theme='dark'] #page-reports {
      background: linear-gradient(135deg, rgba(46, 16, 101, 0.6), rgba(7, 11, 29, 0.95));
    }

    [data-theme='dark'] #page-staff {
      background: linear-gradient(135deg, rgba(79, 0, 58, 0.5), rgba(20, 8, 20, 0.95));
    }

    [data-theme='dark'] #page-management {
      background: linear-gradient(135deg, rgba(8, 12, 27, 0.92), rgba(18, 25, 41, 0.92));
    }

    [data-theme='dark'] #page-roles {
      background: linear-gradient(135deg, rgba(45, 6, 66, 0.55), rgba(14, 10, 30, 0.95));
    }

    [data-theme='dark'] #page-settings {
      background: linear-gradient(135deg, rgba(32, 35, 45, 0.9), rgba(18, 22, 32, 0.95));
    }

    /* Make all pages use the Dashboard dark-page treatment for consistency */
    html[data-theme='dark'] .page {
      background: linear-gradient(135deg, rgba(2, 115, 94, 0.22), rgba(7, 11, 23, 0.85)) !important;
      border-color: rgba(255,255,255,0.06) !important;
      box-shadow: 0 30px 70px rgba(2, 6, 23, 0.7) !important;
    }

    /* COMPREHENSIVE dark-mode override for ALL module/panel elements
       This replaces scattered light gradients with a unified gray→darker-gray look
       plus the Dashboard page background. Applies to: portal-*, billing-*, summary-*,
       customer-*, table-*, stat-*, etc. */
    html[data-theme='dark'] .portal-section,
    html[data-theme='dark'] .portal-detail-card,
    html[data-theme='dark'] .portal-grid,
    html[data-theme='dark'] .portal-main,
    html[data-theme='dark'] .billing-column,
    html[data-theme='dark'] .billing-layout,
    html[data-theme='dark'] .billing-item,
    html[data-theme='dark'] .billing-history-card,
    html[data-theme='dark'] .billing-list,
    html[data-theme='dark'] .summary-card,
    html[data-theme='dark'] .summary-card::after,
    html[data-theme='dark'] .customer-detail-card,
    html[data-theme='dark'] .customer-detail-meta div,
    html[data-theme='dark'] .customer-detail-panel,
    html[data-theme='dark'] .table-wrapper,
    html[data-theme='dark'] .stat-card,
    html[data-theme='dark'] .report-card,
    html[data-theme='dark'] .report-panel,
    html[data-theme='dark'] .portal-detail-card::after,
    html[data-theme='dark'] .portal-section::after,
    html[data-theme='dark'] .billing-column::after {
      background: linear-gradient(180deg, #2b2f33, #0f1214) !important;
      border-color: rgba(255,255,255,0.03) !important;
      box-shadow: 0 20px 48px rgba(0,0,0,0.6) !important;
      color: #e6eef8 !important;
    }

    /* Ensure text and child elements are readable */
    html[data-theme='dark'] .portal-section *,
    html[data-theme='dark'] .portal-detail-card *,
    html[data-theme='dark'] .billing-column *,
    html[data-theme='dark'] .customer-detail-card *,
    html[data-theme='dark'] .table-wrapper * {
      color: inherit !important;
    }

    /* General dark-mode card fixes: prevent bright/white cards from showing */
    html[data-theme='dark'] .schedule-card,
    html[data-theme='dark'] .report-panel,
    html[data-theme='dark'] .report-card,
    html[data-theme='dark'] .stat-card,
    html[data-theme='dark'] .portal-meta-card,
    html[data-theme='dark'] .portal-section,
    html[data-theme='dark'] .table-wrapper,
    html[data-theme='dark'] .schedule-grid .schedule-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.18));
      border-color: rgba(255,255,255,0.04);
      box-shadow: 0 18px 36px rgba(2,6,23,0.6);
      color: #f8fafc;
    }

    html[data-theme='dark'] .report-card {
      /* ensure report cards don't use pure white */
      background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));
      box-shadow: 0 16px 28px rgba(2,6,23,0.6);
    }

    html[data-theme='dark'] .schedule-card.active,
    html[data-theme='dark'] .summary-card.active {
      border-color: rgba(28,126,214,0.28);
      box-shadow: 0 28px 54px rgba(2,6,23,0.6);
    }

    html[data-theme='dark'] .summary-card::after,
    html[data-theme='dark'] .report-panel::after,
    html[data-theme='dark'] .schedule-card::after {
      background: linear-gradient(135deg, rgba(0,0,0,0.28), transparent);
      opacity: 0.6;
    }

    /* Strong dark-mode overrides for billing/quote cards and status pills.
       Many billing items are rendered with inline styles (status pills). Inline
       styles can force light backgrounds in dark mode — override them here
       with !important to ensure readability. */
    html[data-theme='dark'] .billing-list,
    html[data-theme='dark'] .billing-item,
    html[data-theme='dark'] .billing-history,
    html[data-theme='dark'] #page-quotes .billing-item {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.03)) !important;
      border: 1px solid rgba(255,255,255,0.03) !important;
      box-shadow: 0 12px 28px rgba(0,0,0,0.6) !important;
      color: #e6eef8 !important;
    }

    /* Force status pills to be readable in dark mode even when inline styles exist */
    html[data-theme='dark'] .billing-status-pill {
      background: rgba(255,255,255,0.06) !important;
      color: #0f172a !important; /* dark text on pale pill when used over dark card */
      border: 1px solid rgba(255,255,255,0.06) !important;
      box-shadow: none !important;
    }

    /* If a status pill uses very light text color from inline styles, force
       a readable variant for pills that appear on dark cards. */
    html[data-theme='dark'] .billing-status-pill[style] {
      background: rgba(255,255,255,0.06) !important;
      color: #0f172a !important;
      border: 1px solid rgba(255,255,255,0.06) !important;
    }

    /* Per-status theming so pills have distinct colors in dark mode */
    html[data-theme='dark'] .billing-status-pill.status-draft {
      background: rgba(148,163,184,0.14) !important;
      color: #e6eef8 !important;
      border-color: rgba(148,163,184,0.12) !important;
    }
    html[data-theme='dark'] .billing-status-pill.status-sent {
      background: rgba(59,130,246,0.18) !important;
      color: #e6f2ff !important;
      border-color: rgba(59,130,246,0.12) !important;
    }
    html[data-theme='dark'] .billing-status-pill.status-negotiation {
      background: rgba(250,204,21,0.18) !important;
      color: #1f2937 !important;
      border-color: rgba(250,204,21,0.12) !important;
    }
    html[data-theme='dark'] .billing-status-pill.status-won,
    html[data-theme='dark'] .billing-status-pill.status-approved,
    html[data-theme='dark'] .billing-status-pill.status-accepted,
    html[data-theme='dark'] .billing-status-pill.status-paid {
      background: rgba(34,197,94,0.16) !important;
      color: #062e16 !important;
      border-color: rgba(34,197,94,0.12) !important;
    }
    html[data-theme='dark'] .billing-status-pill.status-lost,
    html[data-theme='dark'] .billing-status-pill.status-overdue {
      background: rgba(248,113,113,0.16) !important;
      color: #2b0b0b !important;
      border-color: rgba(248,113,113,0.12) !important;
    }
    html[data-theme='dark'] .billing-status-pill.status-partial {
      background: rgba(192,132,252,0.14) !important;
      color: #2b0b3b !important;
      border-color: rgba(192,132,252,0.10) !important;
    }
    html[data-theme='dark'] .billing-status-pill.status-pending,
    html[data-theme='dark'] .billing-status-pill.status-due {
      background: rgba(249,115,22,0.16) !important;
      color: #2b1200 !important;
      border-color: rgba(249,115,22,0.12) !important;
    }

    /* Force a darker panel look for individual billing items when the page is in dark mode */
    html[data-theme='dark'] .billing-item.billing-item--dark {
      background: linear-gradient(180deg, rgba(6,12,20,0.6), rgba(10,18,28,0.55)) !important;
      border-color: rgba(255,255,255,0.04) !important;
      box-shadow: 0 12px 28px rgba(0,0,0,0.6) !important;
      color: #e6eef8 !important;
    }
    html[data-theme='dark'] .billing-item.billing-item--dark * {
      color: inherit !important;
    }


    html[data-theme='dark'] .segmented-control button.active {
      background: rgba(255,255,255,0.04);
      box-shadow: none;
      color: var(--text-primary);
    }

    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dashboard-hero {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      flex-wrap: wrap;
    }

    .dashboard-kicker {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .dashboard-date {
      font-size: 14px;
      color: var(--text-secondary);
      background: rgba(15, 23, 42, 0.05);
      padding: 10px 16px;
      border-radius: 999px;
    }

    .dashboard-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .role-context-banner {
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      border-radius: 14px;
      border: 1px solid var(--border-color);
      background: rgba(2, 115, 94, 0.08);
      color: var(--text-primary);
      margin-bottom: 16px;
      gap: 12px;
    }

    .role-context-banner.active {
      display: flex;
    }

    .role-context-meta {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .summary-card {
      border-radius: 20px;
      padding: 20px;
      color: #fff;
      position: relative;
      overflow: hidden;
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.18);
    }

    .summary-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.35), transparent);
      opacity: 0.4;
    }

    .summary-card > * {
      position: relative;
      z-index: 1;
    }

    .summary-card-label {
      font-size: 13px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      opacity: 0.8;
    }

    .summary-card-value {
      font-size: 48px;
      font-weight: 600;
      line-height: 1;
      margin: 8px 0;
    }

    .summary-card-trend {
      font-size: 13px;
      opacity: 0.9;
    }

    .summary-card-detail {
      margin-top: 18px;
      font-size: 14px;
      opacity: 0.85;
    }

    .summary-card.completed {
      background: #02735E;
    }

    .summary-card.active {
      background: #02735E;
    }

    .summary-card.upcoming {
      background: linear-gradient(135deg, #034040, #022326);
    }

    .dashboard-panels {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
    }

    .dashboard-panel {
      border-radius: 20px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      padding: 24px;
      background: var(--bg-card);
      box-shadow: 0 18px 36px rgba(15, 23, 42, 0.08);
    }

    .dashboard-panel-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.3em;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .snapshot-rows {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .snapshot-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .snapshot-row strong {
      font-size: 20px;
      color: var(--text-primary);
    }

    .priority-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .priority-list li {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .priority-list strong {
      font-size: 18px;
      color: var(--text-primary);
    }

    .dashboard-map-panel {
      margin: 12px 0;
      border-radius: 16px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      padding: 16px;
      background: var(--bg-card);
      box-shadow: 0 18px 36px rgba(15, 23, 42, 0.08);
    }

    .dashboard-map-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .map-filter-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip-filter {
      border: 1px solid rgba(15, 23, 42, 0.15);
      background: transparent;
      color: var(--text-secondary);
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 150ms ease;
    }

    .chip-filter.active {
      background: rgba(2, 115, 94, 0.12);
      color: #02735E;
      border-color: rgba(2, 115, 94, 0.3);
      font-weight: 600;
    }

    #dashboard-map {
      height: 400px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .page-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
    }

    .card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(250, 250, 250, 0.95));
      border: 1px solid rgba(2, 115, 94, 0.08);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 8px 24px rgba(2, 115, 94, 0.08);
      transition: all 0.3s ease;
    }

    .card:hover {
      border-color: rgba(2, 115, 94, 0.15);
      box-shadow: 0 12px 32px rgba(2, 115, 94, 0.12);
      transform: translateY(-2px);
    }

    .grid {
      display: grid;
      gap: 14px;
    }

    .stat-card {
      background: linear-gradient(135deg, #02735E, #035951);
      border: none;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(2, 115, 94, 0.15);
      transition: all 0.3s ease;
      color: #ffffff;
    }

    .stat-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 8px 20px rgba(2, 115, 94, 0.2);
    }

    .stat-card .stat-label {
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.4px;
      color: rgba(255, 255, 255, 0.78);
    }

    .stat-card .stat-value {
      color: #ffffff;
    }

    .stat-card .stat-change {
      color: rgba(255, 255, 255, 0.72);
    }

    .stat-card .stat-change.positive {
      color: rgba(255, 255, 255, 0.9);
    }

    [data-theme='dark'] .stat-card,
    [data-theme='dark'] .customer-card,
    [data-theme='dark'] .staff-card,
    [data-theme='dark'] .inventory-card,
    [data-theme='dark'] .fleet-card,
    [data-theme='dark'] .report-panel,
    [data-theme='dark'] .report-card,
    [data-theme='dark'] .report-queue-item,
    [data-theme='dark'] .inventory-report-item,
    [data-theme='dark'] .schedule-card,
    [data-theme='dark'] .customer-detail-panel,
    [data-theme='dark'] .customer-detail-meta div {
      background: linear-gradient(145deg, rgba(20, 28, 45, 0.95), rgba(9, 13, 24, 0.92));
      border-color: rgba(148, 163, 184, 0.22);
      box-shadow: 0 28px 48px rgba(2, 6, 23, 0.65);
    }

    .stat-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      color: #475569;
      margin-bottom: 6px;
    }

    .stat-value {
      font-size: 30px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .grid-4 {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .stat-value {
      font-size: 34px;
      font-weight: 700;
    }

    .stat-label {
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.4px;
      color: var(--text-secondary);
    }

    .btn {
      border: none;
      border-radius: 10px;
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #02735E 0%, #035951 100%);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 14px rgba(2, 115, 94, 0.25);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: #035951;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.05);
      color: var(--text-secondary);
    }

    .btn-danger {
      background: #dc2626;
      color: #fff;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    .role-switcher {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 6px 10px;
      background: var(--bg-card);
      color: var(--text-primary);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--bg-card);
    }

    th,
    td {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
      font-size: 14px;
      color: var(--text-primary);
    }

    th {
      text-transform: uppercase;
      letter-spacing: 0.4px;
      font-size: 12px;
      color: var(--text-primary);
      background: var(--table-header-bg);
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      gap: 0px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .tab.active {
      color: #02735E;
      border-bottom: 2px solid #02735E;
      font-weight: 600;
    }

    .tab-content {
      display: none;
      padding-top: 12px;
    }

    .tab-content.active {
      display: block;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
    }

    .timeline {
      border-left: 2px solid var(--border-color);
      padding-left: 16px;
    }

    .timeline-item {
      margin-bottom: 16px;
    }

    .timeline-item::before {
      content: '';
      position: relative;
      left: -20px;
      top: 10px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary-color);
      display: inline-block;
    }

    .schedule-layout {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .schedule-header {
      align-items: flex-end;
      gap: 16px;
      flex-wrap: wrap;
    }

    .schedule-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 6px;
    }

    .schedule-control-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .segmented-control {
      display: inline-flex;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.05);
      padding: 4px;
      border: 1px solid rgba(15, 23, 42, 0.08);
    }

    .segmented-control button {
      border: none;
      background: transparent;
      padding: 6px 18px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 150ms ease;
    }

    .segmented-control button.active {
      background: #fff;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.12);
      color: var(--text-primary);
    }

    .motorsync-main-tabs {
      display: flex;
      gap: 12px;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 0;
    }

    .motorsync-main-tabs button {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.2s;
      margin-bottom: -2px;
    }

    .motorsync-main-tabs button:hover {
      background: rgba(2, 115, 94, 0.05);
    }

    .motorsync-main-tabs button.active {
      border-bottom-color: #02735E;
      color: #02735E;
      background: transparent !important;
      animation: none !important;
      box-shadow: none !important;
    }

    .motorsync-main-panel {
      display: none;
    }

    .motorsync-main-panel.active {
      display: block;
    }

    .projectsync-tabs {
      margin: 24px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      width: 100%;
    }

    .projectsync-tabs button {
      flex: 1 1 140px;
      text-align: center;
    }

    .projectsync-tabs button.active {
      background: linear-gradient(135deg, #02735E 0%, #035951 50%, #034040 100%) !important;
      background-size: 200% 200%;
      animation: aire 8s ease infinite;
      color: #fff !important;
      font-weight: 700;
      box-shadow: 0 8px 24px rgba(2, 115, 94, 0.3);
    }

    .projectsync-panel {
      display: none;
    }

    .projectsync-panel.active {
      display: block;
      animation: fadeInUp 0.35s ease;
    }

    .project-collab-grid {
      margin-top: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }

    .project-brief-list {
      list-style: none;
      display: grid;
      gap: 8px;
      margin: 0 0 16px 0;
      padding: 0;
    }

    .project-brief-list li {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: #475569;
      gap: 12px;
    }

    .project-brief-list strong {
      color: #0f172a;
    }

    .project-timeline {
      margin-top: 16px;
      display: grid;
      gap: 12px;
    }

    .project-timeline-step {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-size: 13px;
      color: #475569;
    }

    .project-timeline-step.completed {
      border-color: rgba(2, 115, 94, 0.2);
      background: rgba(2, 115, 94, 0.04);
      color: #02735E;
      font-weight: 600;
    }

    .project-thread {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .project-thread:last-child {
      border-bottom: none;
    }

    .project-thread-meta {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
    }

    .schedule-mode-control {
      border-style: dashed;
    }

    .schedule-nav {
      display: inline-flex;
      gap: 8px;
    }

    .schedule-nav button {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      font-weight: 600;
      cursor: pointer;
    }

    /* Modal de selección */
    .selection-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
      z-index: 2001;
      max-width: 500px;
      width: 90%;
    }

    .selection-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 12px;
      text-align: center;
    }

    .selection-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 32px;
    }

    .selection-options {
      display: grid;
      gap: 16px;
    }

    .selection-option {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .selection-option:hover {
      border-color: var(--primary-color);
      background: rgba(2, 115, 94, 0.02);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .selection-option-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 12px;
    }

    .selection-option-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #02735E 0%, #035951 100%);
      color: white;
    }

    .selection-option-title {
      font-size: 18px;
      font-weight: 600;
    }

    .selection-option-description {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    @media (max-width: 768px) {
      .app-shell {
        display: block;
      }
      aside {
        position: static;
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        height: auto;
      }
      .sidebar-item {
        justify-content: center;
      }
      main {
        margin-left: 0;
        padding: 16px;
      }
      header {
        position: relative;
      }
    }

    .schedule-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 18px;
    }

    .schedule-card {
      border: none;
      text-align: left;
      cursor: pointer;
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.98), rgba(245, 250, 248, 0.95));
      border-radius: 20px;
      padding: 22px 24px;
      box-shadow: 0 12px 28px rgba(2, 115, 94, 0.08);
      transition: transform 220ms ease, box-shadow 220ms ease, border 220ms ease;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-family: inherit;
      color: inherit;
      border: 1px solid rgba(2, 115, 94, 0.06);
    }

    .schedule-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 18px 38px rgba(2, 115, 94, 0.14);
      border-color: rgba(2, 115, 94, 0.15);
    }

    .schedule-card.active {
      border: 1px solid rgba(2, 115, 94, 0.4);
      box-shadow: 0 20px 42px rgba(2, 115, 94, 0.22);
    }

    .schedule-card:focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 3px;
    }

    .schedule-time {
      font-size: 13px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    .schedule-title {
      font-size: 18px;
      font-weight: 600;
    }

    .schedule-service {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .schedule-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .schedule-chip {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(15, 23, 42, 0.08);
      color: var(--text-primary);
      text-transform: capitalize;
    }

    .schedule-chip-high {
      background: rgba(224, 49, 49, 0.15);
      color: #b02a2a;
    }

    .schedule-chip-normal {
      background: rgba(253, 126, 20, 0.15);
      color: #b25a00;
    }

    .schedule-chip-low {
      background: rgba(16, 185, 129, 0.18);
      color: #0f8b5f;
    }

    .schedule-chip-future {
      background: rgba(99, 102, 241, 0.18);
      color: #3730a3;
    }

    .schedule-detail {
      border-radius: 24px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: var(--bg-card);
      padding: 28px;
      min-height: 360px;
      box-shadow: 0 28px 48px rgba(15, 23, 42, 0.12);
    }

    .schedule-detail-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .schedule-detail-time {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
    }

    .schedule-detail-service {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .schedule-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .schedule-meta-grid span {
      display: block;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .schedule-meta-grid strong {
      font-size: 14px;
      color: var(--text-primary);
    }

    .schedule-detail-section {
      margin-bottom: 18px;
    }

    .schedule-detail-section h4 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .schedule-detail-section p {
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-primary);
    }

    .schedule-detail-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 12px;
    }

    .schedule-pills {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .schedule-pill {
      border-radius: 18px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      background: rgba(15, 23, 42, 0.08);
      color: var(--text-primary);
    }

    .schedule-pill.status {
      border: 1px dashed rgba(15, 23, 42, 0.2);
      background: transparent;
    }

    .schedule-pill.priority-high {
      background: rgba(224, 49, 49, 0.15);
      color: #c92a2a;
    }

    .schedule-pill.priority-normal {
      background: rgba(253, 126, 20, 0.15);
      color: #d9480f;
    }

    .schedule-pill.priority-low {
      background: rgba(16, 185, 129, 0.18);
      color: #0f8b5f;
    }

    .schedule-pill.priority-future {
      background: rgba(99, 102, 241, 0.18);
      color: #4338ca;
    }

    .schedule-task-list {
      list-style: none;
      padding-left: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .schedule-task-list li {
      position: relative;
      padding-left: 16px;
      font-size: 14px;
    }

    .schedule-task-list li::before {
      content: '•';
      position: absolute;
      left: 0;
      color: var(--primary-color);
    }

    .schedule-placeholder {
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
      padding: 40px 12px;
    }

    .schedule-sidebar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
    }

    .schedule-feed,
    .schedule-detail {
      width: 100%;
    }

    .schedule-feed {
      border-radius: 24px;
      border: 1px dashed rgba(15, 23, 42, 0.2);
      padding: 24px;
      background: var(--bg-card);
      min-height: 200px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    .schedule-feed-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .schedule-feed-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .schedule-feed-list li {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .schedule-feed-list strong {
      font-size: 14px;
      color: var(--text-primary);
    }

    .customers-dashboard {
      margin-bottom: 24px;
    }

    .customers-dashboard .stat-card {
      min-height: 140px;
      border: none;
      color: #fff;
      background: linear-gradient(135deg, #02735E, #034040);
      box-shadow: 0 24px 48px rgba(2, 115, 94, 0.25);
    }

    .customers-dashboard .stat-card:nth-child(2) {
      background: linear-gradient(135deg, #035951, #60a5fa);
      box-shadow: 0 24px 48px rgba(132, 94, 247, 0.25);
    }

    .customers-dashboard .stat-card:nth-child(3) {
      background: linear-gradient(135deg, #034040, #022326);
      box-shadow: 0 24px 48px rgba(255, 107, 107, 0.25);
    }

    .customers-dashboard .stat-card .stat-label,
    .customers-dashboard .stat-card .stat-value,
    .customers-dashboard .stat-card .stat-change {
      color: #fff;
    }

    .customers-dashboard .stat-change {
      margin-top: 6px;
      font-size: 13px;
    }

    .customers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .customer-card {
      border-radius: 24px;
      padding: 18px 20px;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(222, 233, 248, 0.92));
      border: 1px solid rgba(15, 23, 42, 0.06);
      box-shadow: 0 18px 36px rgba(15, 23, 42, 0.1);
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: transform 200ms ease, box-shadow 200ms ease;
    }

    .customer-card.active {
      border-color: rgba(2, 115, 94, 0.4);
      box-shadow: 0 16px 36px rgba(2, 115, 94, 0.18);
      transform: translateY(-4px);
    }

    .customer-card h4 {
      margin: 0;
      font-size: 18px;
    }

    .customer-card span {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .customer-card button {
      margin-top: 10px;
      align-self: flex-start;
      border: none;
      border-radius: 12px;
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
      background: #02735E;
      color: #fff;
      box-shadow: 0 8px 20px rgba(2, 115, 94, 0.25);
      transition: all 0.3s ease;
    }

    .customer-card button:hover {
      background: #035951;
      box-shadow: 0 12px 28px rgba(2, 115, 94, 0.35);
      transform: translateY(-2px);
    }

    .staff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 18px;
      margin-top: 20px;
    }

    .staff-card {
      border-radius: 22px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.96), rgba(233, 241, 255, 0.9));
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 10px;
      cursor: pointer;
      transition: transform 200ms ease, box-shadow 200ms ease;
    }

    .staff-card.active {
      box-shadow: 0 28px 48px rgba(2, 115, 94, 0.25);
      transform: translateY(-4px);
    }

    .staff-avatar {
      width: 46px;
      height: 46px;
      border-radius: 14px;
      background: #02735E;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      box-shadow: 0 12px 24px rgba(2, 115, 94, 0.2);
    }

    .staff-meta {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .staff-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(15, 23, 42, 0.06);
      color: var(--text-primary);
    }

    .staff-hours-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      color: #fff;
    }

    .hours-green {
      background: linear-gradient(135deg, #38b000, #70e000);
      box-shadow: 0 8px 18px rgba(56, 176, 0, 0.25);
    }

    .hours-orange {
      background: linear-gradient(135deg, #034040, #035951);
      box-shadow: 0 8px 18px rgba(240, 140, 0, 0.25);
    }

    .hours-red {
      background: linear-gradient(135deg, #e03131, #ff5d8f);
      box-shadow: 0 8px 18px rgba(224, 49, 49, 0.25);
    }

    .staff-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 20px;
      align-items: center;
    }

    .staff-toolbar input[type="search"] {
      flex: 1 1 240px;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-size: 14px;
      background: var(--bg-card);
    }

    .staff-hours-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .staff-hours-table th,
    .staff-hours-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color);
      font-size: 13px;
      text-align: left;
    }

    /* Inventory */
    .inventory-dashboard {
      margin-bottom: 24px;
    }

    .inventory-dashboard .stat-card {
      min-height: 140px;
      border-radius: 20px;
      border: none;
      color: #fff;
      background: #02735E;
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.18);
    }

    .inventory-dashboard .stat-card:nth-child(2) {
      background: #02735E;
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.18);
    }

    .inventory-dashboard .stat-card:nth-child(3) {
      background: linear-gradient(135deg, #034040, #022326);
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.18);
    }

    .inventory-dashboard .stat-card .stat-label,
    .inventory-dashboard .stat-card .stat-value,
    .inventory-dashboard .stat-card .stat-change {
      color: rgba(255, 255, 255, 0.92);
      text-shadow: 0 2px 8px rgba(15, 23, 42, 0.35);
    }

    .inventory-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .inventory-toolbar-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    #inventory-search {
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 10px 16px;
      min-width: 220px;
      background: var(--bg-card);
      font-size: 14px;
    }

    .inventory-view-toggles .chip-filter {
      border-radius: 999px;
      padding: 6px 14px;
    }

    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .inventory-card {
      border-radius: 22px;
      border: 1px solid rgba(15, 23, 42, 0.06);
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.98), rgba(233, 239, 255, 0.92));
      padding: 20px;
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .inventory-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .inventory-sku {
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    .inventory-status {
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .inventory-status.ok {
      background: rgba(34, 197, 94, 0.18);
      color: #15803d;
    }

    .inventory-status.low {
      background: rgba(249, 115, 22, 0.18);
      color: #c2410c;
    }

    .inventory-status.critical {
      background: rgba(244, 63, 94, 0.18);
      color: #be123c;
    }

    .inventory-card-metrics {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .inventory-card-metrics div {
      display: flex;
      flex-direction: column;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .inventory-card-metrics strong {
      font-size: 16px;
      color: var(--text-primary);
    }

    .inventory-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .inventory-card-actions {
      display: flex;
      gap: 8px;
    }

    .inventory-card-actions button {
      border-radius: 10px;
      padding: 6px 12px;
      font-size: 12px;
    }

    .inventory-table {
      display: none;
    }

    .inventory-table.active {
      display: block;
    }

    .inventory-empty {
      padding: 32px;
      text-align: center;
      color: var(--text-secondary);
    }

    .inventory-report-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }

    .inventory-report-item {
      display: flex;
      justify-content: space-between;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 12px 16px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .inventory-fleet-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .fleet-card {
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 20px;
      padding: 18px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(235, 242, 255, 0.9));
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .fleet-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .fleet-tag {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.08);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .fleet-loadout {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .fleet-chip {
      padding: 4px 10px;
      border-radius: 12px;
      background: rgba(2, 115, 94, 0.12);
      color: var(--primary-color);
      font-size: 12px;
      font-weight: 600;
    }

    .fleet-meta {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* KPI grids */
    .kpi-grid .stat-card {
      min-height: 140px;
      border: none;
      border-radius: 20px;
      color: #fff;
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.18);
    }
    .kpi-grid .stat-card .stat-label,
    .kpi-grid .stat-card .stat-value,
    .kpi-grid .stat-card .stat-change {
      color: #fff;
    }

    .kpi-grid .stat-card:nth-child(3n + 1) {
      background: #02735E;
    }

    .kpi-grid .stat-card:nth-child(3n + 2) {
      background: #02735E;
    }

    .kpi-grid .stat-card:nth-child(3n) {
      background: linear-gradient(135deg, #034040, #022326);
    }

    .management-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin: 20px 0;
    }

    .management-toolbar input[type='search'] {
      flex: 1;
      min-width: 220px;
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
    }

    .management-toolbar select {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .management-layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(260px, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .management-detail-card {
      min-height: 320px;
    }

    .management-detail-placeholder {
      text-align: center;
      color: var(--text-secondary);
      padding: 40px 20px;
    }

    .management-detail-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .management-avatar {
      width: 54px;
      height: 54px;
      border-radius: 14px;
      background: linear-gradient(135deg, #cfd8ff, #edf2ff);
      color: #1c274c;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
    }

    .management-badge {
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .management-badge.active {
      background: rgba(16, 185, 129, 0.16);
      color: #047857;
    }

    .management-badge.away {
      background: rgba(245, 158, 11, 0.2);
      color: #b45309;
    }

    .management-badge.disabled {
      background: rgba(248, 113, 113, 0.2);
      color: #b91c1c;
    }

    .management-detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .management-detail-grid div {
      background: rgba(15, 23, 42, 0.04);
      border-radius: 12px;
      padding: 12px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .management-detail-grid strong {
      display: block;
      font-size: 15px;
      color: var(--text-primary);
    }

    .management-detail-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    .management-lower {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    .management-invite-list,
    .management-activity-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .management-invite-item,
    .management-activity-item {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      align-items: center;
    }

    .management-invite-item small,
    .management-activity-item small {
      color: var(--text-secondary);
      display: block;
      margin-top: 4px;
    }

    .management-activity-item strong {
      display: block;
      color: var(--text-primary);
    }

    .management-empty {
      text-align: center;
      color: var(--text-secondary);
      padding: 24px;
      border: 1px dashed var(--border-color);
      border-radius: 14px;
    }

    .management-users-card table tbody tr.active {
      background: rgba(2, 115, 94, 0.08);
    }

    @media (max-width: 1024px) {
      .management-layout {
        grid-template-columns: 1fr;
      }
    }

    .settings-layout {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .settings-card .card-header {
      padding: 0 0 12px 0;
      border: none;
    }

    .settings-note {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .settings-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 16px;
    }

    .settings-divider {
      border-top: 1px solid var(--border-color);
      margin: 20px 0;
    }

    .reports-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin: 24px 0;
    }

    .reports-toolbar .orders-chip-group {
      flex-wrap: wrap;
    }

    .reports-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    .report-panel {
      border-radius: 22px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.97), rgba(235, 242, 255, 0.92));
      padding: 20px;
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.08);
    }

    .report-panel h3 {
      margin-bottom: 8px;
    }

    .report-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
    }

    .report-card {
      border-radius: 18px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      padding: 16px;
      background: #fff;
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .report-card strong {
      font-size: 20px;
    }

    .report-card p {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .report-queue {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .report-queue-item {
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .report-queue-item-paused {
      border-color: rgba(251, 191, 36, 0.7);
      background: rgba(251, 191, 36, 0.08);
    }

    .report-queue-item strong {
      display: block;
      font-size: 15px;
    }

    .report-queue-item small {
      color: var(--text-secondary);
    }

    .report-schedule-heading {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .schedule-paused-badge {
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(247, 144, 9, 0.2);
      color: #b45309;
    }

    .report-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .report-download-controls {
      margin-top: 16px;
      padding: 12px 16px;
      border: 1px dashed var(--border-color);
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      background: var(--bg-card);
    }

    .report-download-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .report-download-actions select {
      padding: 6px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: var(--bg-body);
      color: var(--text-primary);
    }

    .report-detail-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .report-detail-card {
      border: 1px solid var(--border-color);
      border-radius: 14px;
      padding: 12px 14px;
      background: var(--bg-card);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .report-detail-card-label {
      font-size: 13px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .report-detail-card strong {
      font-size: 20px;
    }

    .report-detail-card small {
      color: var(--text-secondary);
    }

    .report-detail-bars {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    .report-bar {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .report-bar-track {
      flex: 1;
      height: 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.08);
      overflow: hidden;
    }

    .report-bar-fill {
      height: 100%;
      background: var(--primary-color);
      border-radius: inherit;
    }

    .report-bar-value {
      font-weight: 600;
      min-width: 48px;
      text-align: right;
    }

    .report-detail-table {
      margin-top: 8px;
    }

    .report-detail-table-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .reports-history-empty {
      padding: 24px;
      text-align: center;
      color: var(--text-secondary);
    }

    @media (max-width: 1024px) {
      .reports-layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .inventory-card-metrics {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .inventory-toolbar {
        flex-direction: column;
        align-items: flex-start;
      }
      .inventory-toolbar-actions {
        width: 100%;
        justify-content: space-between;
      }
    }

    .billing-summary .stat-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(230,240,255,0.9));
      border: none;
      box-shadow: 0 20px 36px rgba(15, 23, 42, 0.08);
    }

    /* Override .billing-summary .stat-card in dark mode */
    html[data-theme='dark'] .billing-summary .stat-card {
      background: linear-gradient(180deg, #2b2f33, #0f1214) !important;
      box-shadow: 0 20px 48px rgba(0,0,0,0.6) !important;
      border-color: rgba(255,255,255,0.03) !important;
    }

    .billing-toolbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 12px;
    }

    .billing-toolbar input[type="search"] {
      flex: 1 1 280px;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-card);
      font-size: 14px;
    }

    .billing-layout {
      margin-top: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }

    .billing-column {
      border-radius: 22px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: linear-gradient(150deg, rgba(255,255,255,0.96), rgba(236,241,249,0.92));
      padding: 20px;
      box-shadow: 0 20px 36px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Override .billing-column in dark mode to prevent the hardcoded white gradient */
    html[data-theme='dark'] .billing-column {
      background: linear-gradient(180deg, #2b2f33, #0f1214) !important;
      box-shadow: 0 20px 48px rgba(0,0,0,0.6) !important;
      border-color: rgba(255,255,255,0.03) !important;
    }

    .billing-column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .billing-column-header h3 {
      margin: 0;
      font-size: 18px;
    }

    .billing-column-header p {
      margin: 4px 0 0 0;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .badge-pill {
      padding: 4px 12px;
      border-radius: 6px;
      background: rgba(2, 115, 94, 0.08);
      font-size: 11px;
      font-weight: 500;
      color: #02735E;
      border: 1px solid rgba(2, 115, 94, 0.15);
    }

    .billing-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .billing-item {
      border-radius: 18px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: var(--bg-card);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 14px 28px rgba(15, 23, 42, 0.08);
      transition: transform 150ms ease, box-shadow 150ms ease;
    }

    .billing-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.12);
    }

    .billing-item-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }

    .billing-amount {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .billing-meta {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
      gap: 6px;
      flex-wrap: wrap;
    }

    .billing-status-pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }

    .billing-item-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .billing-empty {
      padding: 18px;
      border-radius: 14px;
      border: 1px dashed rgba(15, 23, 42, 0.2);
      text-align: center;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .billing-history-grid {
      margin-top: 24px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }

    .billing-history-card {
      border-radius: 22px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: var(--bg-card);
      padding: 20px;
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.08);
    }

    .billing-history-card table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: var(--bg-card);
    }

    .billing-history-card th,
    .billing-history-card td {
      padding: 8px 4px;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
      color: var(--text-primary);
    }

    .billing-history-card th {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: var(--table-header-bg);
    }

    .customer-detail-panel {
      border-radius: 24px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: var(--bg-card);
      padding: 24px;
      box-shadow: 0 24px 44px rgba(15, 23, 42, 0.08);
      background-image: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(238,244,255,0.92));
    }

    .customer-detail-hero {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .customer-detail-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .customer-detail-meta div {
      padding: 14px 16px;
      border-radius: 18px;
      background: linear-gradient(145deg, rgba(255,255,255,0.96), rgba(230,236,247,0.92));
      border: 1px solid rgba(15, 23, 42, 0.06);
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.08);
    }

    .customer-detail-meta span {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--text-secondary);
    }

    .customer-detail-meta strong {
      display: block;
      font-size: 16px;
      color: var(--text-primary);
      margin-top: 4px;
    }

    .customer-detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }

    .customer-detail-card {
      border-radius: 22px;
      padding: 20px;
      background: linear-gradient(155deg, rgba(255,255,255,0.97), rgba(223,233,248,0.9));
      border: 1px solid rgba(15, 23, 42, 0.05);
      box-shadow: 0 22px 44px rgba(15, 23, 42, 0.1);
    }

    .customer-detail-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* Customer Detail Overlay Modal */
    .customer-detail-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 9999;
      overflow-y: auto;
      padding: 40px 20px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .customer-detail-modal {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 24px;
      padding: 32px;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideUp {
      from {
        transform: translateY(40px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .customer-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 2px solid var(--border-color);
    }

    .tab-button:hover {
      background: rgba(2, 115, 94, 0.05);
    }

    .tab-button.active {
      color: #02735E;
    }

    .modal-step {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .modal-step p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .order-step-panel {
      border-radius: 20px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      padding: 20px;
      background: linear-gradient(140deg, rgba(255,255,255,0.96), rgba(236,241,249,0.92));
      box-shadow: 0 20px 38px rgba(15, 23, 42, 0.12);
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: min(540px, 92vw);
      margin: 0 auto;
    }

    .order-step-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .order-step-actions {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .order-form {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .order-form-section {
      border-radius: 20px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      padding: 20px;
      background: linear-gradient(150deg, rgba(255,255,255,0.96), rgba(235,240,248,0.9));
      box-shadow: 0 20px 36px rgba(15, 23, 42, 0.08);
    }

    .order-form-section:nth-of-type(1) {
      background: linear-gradient(150deg, rgba(231, 245, 255, 0.98), rgba(219, 234, 254, 0.9));
    }

    .order-form-section:nth-of-type(2) {
      background: linear-gradient(150deg, rgba(248, 249, 255, 0.98), rgba(232, 244, 255, 0.9));
    }

    .order-form-section:nth-of-type(3) {
      background: linear-gradient(150deg, rgba(242, 252, 245, 0.98), rgba(223, 246, 231, 0.9));
    }

    .order-form-section:nth-of-type(4) {
      background: linear-gradient(150deg, rgba(255, 248, 240, 0.98), rgba(255, 238, 214, 0.9));
    }

    .order-form-section:nth-of-type(5) {
      background: linear-gradient(150deg, rgba(243, 243, 255, 0.98), rgba(227, 227, 255, 0.9));
    }

    .order-form-section h4 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .order-form-split {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
    }

    .helper-text {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .order-form-footer {
      display: flex;
      justify-content: flex-end;
    }

    .order-form select[multiple] {
      min-height: 150px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 8px;
      background: var(--bg-card);
    }

    #order-techs,
    #order-labors {
      width: 100%;
    }

    .modal-step input[type="search"],
    .modal-step input[type="text"],
    .modal-step select,
    .modal-step textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-size: 14px;
    }

    .customer-address-input {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .customer-address-input > input {
      flex: 1 1 280px;
      min-width: 240px;
    }

    .customer-address-input button {
      border: none;
      border-radius: 12px;
      padding: 12px 18px;
      font-weight: 600;
      cursor: pointer;
      background: var(--primary-color);
      color: #fff;
      box-shadow: 0 12px 24px rgba(2, 115, 94, 0.25);
    }

    .customer-address-input button:hover {
      opacity: 0.95;
    }

    @media (max-width: 640px) {
      .customer-address-input {
        flex-direction: column;
        align-items: stretch;
      }

      .customer-address-input button {
        width: 100%;
      }
    }

    .customer-card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .customer-address-chip {
      padding: 10px 14px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(2, 115, 94, 0.12), rgba(15, 23, 42, 0.04));
      border: 1px solid rgba(2, 115, 94, 0.2);
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      font-size: 13px;
      color: var(--text-primary);
      cursor: pointer;
      transition: background 150ms ease, border 150ms ease;
    }

    .customer-address-chip.active {
      background: linear-gradient(135deg, rgba(2, 115, 94, 0.22), rgba(3, 89, 81, 0.16));
      border-color: rgba(2, 115, 94, 0.5);
    }

    .customer-address-chip button {
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text-primary);
      font-weight: 600;
    }

    .modal-step-actions {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .orders-toolbar {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      align-items: center;
    }

    .orders-chip-group {
      display: inline-flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .orders-toolbar input[type="search"],
    .customers-toolbar input[type="search"] {
      flex: 1 1 240px;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-size: 14px;
      background: var(--bg-card);
    }

    .customers-toolbar {
      margin-bottom: 20px;
    }

    .orders-layout {
      display: block;
    }

    .order-row button {
      border: none;
      background: rgba(15, 23, 42, 0.05);
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
    }

    .schedule-timeline {
      display: none;
      flex-direction: column;
      gap: 16px;
      background: var(--bg-card);
      border-radius: 24px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      padding: 24px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.1);
    }

    .schedule-timeline.active {
      display: flex;
    }

    .timeline-entry {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      padding: 12px 0;
      cursor: pointer;
      transition: background 150ms ease, padding 150ms ease;
    }

    .timeline-entry:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .timeline-entry h4 {
      margin: 0;
      font-size: 16px;
    }

    .timeline-entry span {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .timeline-entry.active {
      background: rgba(2, 115, 94, 0.08);
      border-radius: 18px;
      padding: 12px 16px;
      border-bottom-color: transparent;
    }

    .hidden {
      display: none !important;
    }

    .is-disabled {
      opacity: 0.55;
      pointer-events: none;
    }

    /* Module Cards */
    .module-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      gap: 16px;
      align-items: flex-start;
      transition: all 0.3s ease;
    }

    .module-card.active {
      border-color: rgba(2, 115, 94, 0.3);
      box-shadow: 0 8px 24px rgba(2, 115, 94, 0.12);
    }

    .module-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.08);
    }

    .module-icon {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 18px;
      letter-spacing: -0.5px;
      flex-shrink: 0;
    }

    .module-info {
      flex: 1;
    }

    .module-info h4 {
      font-size: 16px;
      font-weight: 700;
      margin: 0 0 4px 0;
      color: var(--text-primary);
    }

    .module-info p {
      font-size: 13px;
      color: var(--text-secondary);
      margin: 0 0 8px 0;
    }

    .module-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(2, 115, 94, 0.1);
      color: #02735E;
    }

    .module-status.active {
      background: rgba(2, 115, 94, 0.15);
      color: #02735E;
    }

    /* Quick Module Cards */
    .quick-module-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .quick-module-card.active {
      border-color: rgba(2, 115, 94, 0.25);
    }

    .quick-module-card.active:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 28px rgba(2, 115, 94, 0.15);
      border-color: rgba(2, 115, 94, 0.4);
    }

    .quick-module-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .quick-module-icon {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 20px;
      letter-spacing: -0.5px;
    }

    .quick-module-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Module Access Cards (Improved) */
    .module-access-card {
      background: linear-gradient(135deg, #02735E, #035951);
      border: none;
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      text-decoration: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      color: rgba(255, 255, 255, 0.95);
      box-shadow: 0 18px 36px rgba(2, 115, 94, 0.2);
    }

    .module-access-card > * {
      position: relative;
      z-index: 1;
    }

    .module-access-card.active {
      cursor: pointer;
    }

    .module-access-card.active:hover {
      transform: translateY(-6px);
      box-shadow: 0 22px 44px rgba(2, 115, 94, 0.28);
    }

    .module-access-card.active::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.18), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .module-access-card.active:hover::before {
      opacity: 1;
    }

    .module-access-card.disabled {
      background: linear-gradient(135deg, #64748b, #475569);
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.3);
      cursor: not-allowed;
      color: rgba(255, 255, 255, 0.85);
      opacity: 1;
    }

    .module-icon {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 4px;
      background: rgba(255, 255, 255, 0.16);
    }

    .module-info {
      flex: 1;
    }

    .module-info strong {
      color: rgba(255, 255, 255, 0.95);
    }

    .module-info span {
      color: rgba(255, 255, 255, 0.8);
    }

    .module-access-card svg {
      stroke: #ffffff;
    }

    .module-access-card.disabled .module-info span {
      color: rgba(255, 255, 255, 0.75);
    }

    .module-access-card.disabled .module-icon {
      background: rgba(255, 255, 255, 0.12);
    }

    .module-badge {
      align-self: flex-start;
      padding: 4px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.5px;
      background: rgba(255, 255, 255, 0.18);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .module-badge.active {
      background: rgba(255, 255, 255, 0.24);
    }

    .module-badge.disabled {
      background: rgba(15, 23, 42, 0.38);
      border-color: rgba(255, 255, 255, 0.22);
      color: rgba(255, 255, 255, 0.85);
    }

    /* Chip Filters */
    .chip-filter {
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .chip-filter:hover {
      border-color: rgba(2, 115, 94, 0.4);
      background: rgba(2, 115, 94, 0.05);
    }

    .chip-filter.active {
      background: linear-gradient(135deg, #02735E, #035951);
      color: white;
      border-color: transparent;
    }

    /* ThreadSync Styles */
    .thread-card {
      transition: all 0.2s ease;
    }

    .thread-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
    }

    .thread-card.unread:hover {
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2) !important;
    }

    .thread-project-header:hover {
      transform: translateX(4px);
    }

    .threads-container {
      transition: all 0.3s ease;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 8px;
    }

    .btn-icon {
      background: transparent;
      border: none;
      padding: 6px;
      border-radius: 6px;
      cursor: pointer;
      color: #94a3b8;
      transition: all 0.15s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon:hover {
      background: #f1f5f9;
      color: #475569;
    }

    .project-select-card:hover {
      border-color: #10b981 !important;
      background: #f0fdf4;
      transform: translateX(4px);
    }
      .chevron-icon {
      transition: transform 0.3s ease;
    }

    .thread-project-group.expanded .chevron-icon {
      transform: rotate(180deg);
    }

    .map-filter-group {
      display: flex;
      gap: 8px;
    }

    /* Table Styles */
    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    table th {
      text-align: left;
      font-weight: 700;
      font-size: 13px;
      color: var(--text-secondary);
      padding: 14px 16px;
      border-bottom: 2px solid var(--border-color);
      background: #fafafa;
    }

    table td {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
    }

    table tbody tr:hover {
      background: rgba(2, 115, 94, 0.02);
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* Segmented Control */
    .segmented-control {
      display: inline-flex;
      gap: 4px;
      background: #f0f0f0;
      padding: 4px;
      border-radius: 10px;
    }

    .segmented-control .btn {
      margin: 0;
      border-radius: 8px;
      padding: 8px 16px;
    }

    .segmented-control .btn.active {
      background: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Notifications Styles */
    .notification-item {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.3s ease;
    }

    .notification-item:hover {
      border-color: rgba(2, 115, 94, 0.2);
      box-shadow: 0 4px 12px rgba(2, 115, 94, 0.08);
    }

    .notification-item.unread {
      background: linear-gradient(135deg, rgba(2, 115, 94, 0.03), rgba(3, 89, 81, 0.02));
      border-left: 4px solid #02735E;
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .notification-time {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .notification-body {
      color: var(--text-secondary);
      font-size: 14px;
      margin: 12px 0;
      line-height: 1.5;
    }

    .notification-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .notification-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .notification-badge.alert {
      background: #fee2e2;
      color: #dc2626;
    }

    .notification-badge.info {
      background: rgba(2, 115, 94, 0.1);
      color: #02735E;
    }

    .notification-badge.success {
      background: #d1fae5;
      color: #059669;
    }

    /* Documents Styles */
    .document-category-card {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .document-category-card:hover {
      border-color: rgba(2, 115, 94, 0.3);
      box-shadow: 0 8px 20px rgba(2, 115, 94, 0.12);
      transform: translateY(-4px);
    }

    .doc-category-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .doc-category-name {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .doc-category-count {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Territory Styles */
    .territory-card {
      border: 1px solid rgba(2, 115, 94, 0.15);
      border-radius: 12px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(250, 250, 250, 0.95));
      transition: all 0.3s ease;
    }

    .territory-card:hover {
      border-color: rgba(2, 115, 94, 0.3);
      box-shadow: 0 8px 24px rgba(2, 115, 94, 0.1);
      transform: translateY(-2px);
    }

    .territory-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .territory-details {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 16px;
    }

    .territory-detail-item {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .territory-detail-item strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .territory-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Analytics Styles */
    .grid-4 {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .stat-change {
      font-size: 13px;
      margin-top: 6px;
    }

    .stat-change.positive {
      color: #059669;
    }

    .stat-change.negative {
      color: #dc2626;
    }

    .role-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .role-layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(260px, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }


    .role-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .role-item {
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 14px;
      background: var(--bg-card);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .role-item.active {
      border-color: rgba(2, 115, 94, 0.5);
      box-shadow: 0 10px 20px rgba(2, 115, 94, 0.12);
    }

    .role-permissions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
    }

    .role-permission {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 10px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .role-users-list li {
      margin-bottom: 6px;
    }

    .role-toolbar {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .role-toolbar input[type='search'] {
      flex: 1;
      min-width: 220px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
    }

    @media (max-width: 1024px) {
      .role-layout {
        grid-template-columns: 1fr;
      }
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 24px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      width: min(900px, 95vw);
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      box-shadow: 0 30px 60px rgba(15, 23, 42, 0.22);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background: var(--bg-card);
      color: var(--text-primary);
    }
    
    /* Final dark-mode overrides (placed at the end to win over earlier rules) */
    html[data-theme='dark'] .customer-card,
    html[data-theme='dark'] .staff-card,
    html[data-theme='dark'] .report-card,
    html[data-theme='dark'] .report-panel,
    html[data-theme='dark'] .stat-card,
    html[data-theme='dark'] .card,
    html[data-theme='dark'] .billing-history-card,
    html[data-theme='dark'] .customer-detail-card,
    html[data-theme='dark'] .report-detail-card,
    html[data-theme='dark'] .inventory-card,
    html[data-theme='dark'] .table-wrapper,
    html[data-theme='dark'] .portal-section,
    html[data-theme='dark'] .portal-meta-card,
    html[data-theme='dark'] .customer-detail-panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.18));
      border-color: rgba(255,255,255,0.04);
      box-shadow: 0 18px 36px rgba(2,6,23,0.6);
      color: #f8fafc;
    }

    html[data-theme='dark'] .customer-card button,
    html[data-theme='dark'] .chip-filter.active,
    html[data-theme='dark'] .btn-secondary {
      background: linear-gradient(135deg, rgba(28,126,214,0.18), rgba(28,126,214,0.08));
      color: #f8fafc;
      box-shadow: none;
    }

    /* Stronger, page-scoped fixes for Quotes/Invoices to guarantee contrast */
    html[data-theme='dark'] #page-quotes .billing-list .billing-item,
    html[data-theme='dark'] #page-quotes .billing-list .billing-item * {
      background: transparent !important;
      color: #f8fafc !important;
    }

    html[data-theme='dark'] #page-quotes .billing-list .billing-item {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.18)) !important;
      border-color: rgba(255,255,255,0.04) !important;
      box-shadow: 0 14px 28px rgba(2,6,23,0.6) !important;
    }

    /* Normalize status pills in dark mode to ensure text is visible regardless of inline styles */
    html[data-theme='dark'] .billing-status-pill {
      background: rgba(255,255,255,0.06) !important;
      color: #0f172a !important;
      font-weight: 700;
    }

    /* For cases where inline styles set background and color on the status pill, force a visible border */
    html[data-theme='dark'] .billing-item .billing-status-pill[style] {
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
    }
    
    /* Final, page-scoped force for Quotes/Invoices: make the whole panels dark
       in case other CSS further down the file attempted to re-light them. This
       targets the container panels and their direct children to guarantee a
       consistent dark surface. */
    html[data-theme='dark'] #page-quotes .portal-section,
    html[data-theme='dark'] #page-quotes .portal-detail-card,
    html[data-theme='dark'] #page-quotes .portal-grid,
    html[data-theme='dark'] #page-quotes .portal-detail-card .billing-list,
    html[data-theme='dark'] #page-quotes .summary-card,
    html[data-theme='dark'] #page-quotes .portal-detail-card .summary-card {
      background: linear-gradient(180deg, rgba(6,12,20,0.65), rgba(10,18,28,0.6)) !important;
      border-color: rgba(255,255,255,0.03) !important;
      box-shadow: 0 20px 48px rgba(0,0,0,0.6) !important;
      color: #e6eef8 !important;
    }

    /* Also override .billing-column and .billing-layout which create the
       large white panels on the Quotes/Invoices page. These rules must be
       very specific and important to beat earlier light gradients. */
    html[data-theme='dark'] #page-quotes .billing-layout,
    html[data-theme='dark'] #page-quotes .billing-column,
    html[data-theme='dark'] #page-quotes .billing-column-header,
    html[data-theme='dark'] #page-quotes .billing-column .billing-list {
      background: linear-gradient(180deg, rgba(6,12,20,0.7), rgba(8,16,26,0.62)) !important;
      border-color: rgba(255,255,255,0.03) !important;
      box-shadow: 0 22px 48px rgba(0,0,0,0.68) !important;
      color: #e6eef8 !important;
    }

    /* Make sure the column header text and badges are visible */
    html[data-theme='dark'] #page-quotes .billing-column-header h3,
    html[data-theme='dark'] #page-quotes .billing-column-header p,
    html[data-theme='dark'] #page-quotes .badge-pill {
      color: #e6eef8 !important;
    }

    /* Ensure inner billing items also render dark and remove the light sheen */
    html[data-theme='dark'] #page-quotes .billing-list .billing-item,
    html[data-theme='dark'] #page-quotes .billing-list .billing-item * {
      background: transparent !important;
      color: inherit !important;
    }

    html[data-theme='dark'] #page-quotes .summary-card::after,
    html[data-theme='dark'] #page-quotes .portal-detail-card::after {
      background: linear-gradient(135deg, rgba(0,0,0,0.32), transparent) !important;
      opacity: 0.6 !important;
    }

    /* Leaflet Map Styles */
    #projects-map {
      width: 100% !important;
      height: 400px !important;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      background: #f0f0f0;
      position: relative;
      z-index: 1;
    }

    .leaflet-container {
      background: #e5e3df;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-size: 12px;
      line-height: 1.5;
    }

    .leaflet-popup-content-wrapper {
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .leaflet-popup-content {
      margin: 0;
      font-size: 12px;
    }

    .leaflet-control-attribution {
      background: rgba(255,255,255,0.8);
      font-size: 11px;
    }

    .custom-icon {
      border: none !important;
      background: none !important;
    }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">Ir al contenido principal</a>
  <!-- MotorSync - Sistema Operacional Base | Opsis Suite -->
  <div class="app-shell" data-theme="light" data-accent="#02735E">
    <header style="background: linear-gradient(135deg, #02735E 0%, #035951 50%, #034040 100%); background-size: 200% 200%; animation: aire 8s ease infinite; padding: 0; display: flex; align-items: flex-end;">
      <div class="logo" aria-label="Opsis Suite" style="padding: 18px 32px;">
        <div class="logo-text">
          <div class="logo-title">Opsis Suite</div>
          <div id="company-name-header" style="font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.85); margin-top: 2px;">CVE San Diego</div>
        </div>
      </div>
      
      <!-- Module Tabs -->
      <div class="module-tabs" id="module-tabs-container" style="display: flex; gap: 0;">
        <!-- Las pestañas se generan dinámicamente con JavaScript -->
      </div>
    </header>

    <div class="app-content">
    <aside id="sidebar">
      <a href="motorsync.html" class="sidebar-item active" data-nav="page" style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <rect x="3" y="3" width="7" height="9"></rect>
          <rect x="14" y="3" width="7" height="5"></rect>
          <rect x="14" y="12" width="7" height="9"></rect>
          <rect x="3" y="16" width="7" height="5"></rect>
        </svg>
        <span>Dashboard</span>
      </a>
      <a href="plansync.html" class="sidebar-item" data-nav="page" style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <span>PlanSync</span>
      </a>
      <a href="projectsync.html" class="sidebar-item" data-nav="page" style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="9" y1="3" x2="9" y2="21"></line>
        </svg>
        <span>ProjectSync</span>
      </a>
      <a href="threadsync-list.html" class="sidebar-item" data-nav="page" style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          <line x1="9" y1="10" x2="15" y2="10"></line>
          <line x1="12" y1="7" x2="12" y2="13"></line>
        </svg>
        <span>ThreadSync</span>
      </a>
      <a href="howsync.html" class="sidebar-item" data-nav="page" style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <circle cx="12" cy="12" r="2"></circle>
          <path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"></path>
        </svg>
        <span>HowSync</span>
      </a>
      <div class="sidebar-item" data-page="customers" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M22 21v-2a4 4 0 0 0-3-3.87m-3-12.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        <span data-i18n="customers">Clientes</span>
      </div>
      <div class="sidebar-item" data-page="management" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <line x1="12" y1="1" x2="12" y2="23"></line>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
        <span data-i18n="management">Management</span>
      </div>
      <div class="sidebar-item" data-page="roles" style="display: none; align-items: center; gap: 12px;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <rect x="5" y="11" width="14" height="10" rx="2" ry="2"></rect>
          <circle cx="12" cy="16" r="1"></circle>
          <path d="M8 11V7a4 4 0 0 1 8 0v4"></path>
        </svg>
        <span data-i18n="roles">Roles y accesos</span>
      </div>
      <div class="sidebar-item" data-page="settings" style="display: flex; align-items: center; gap: 12px;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3m15.4-6.4l-4.2 4.2m-7.1 0L2.6 5.6m18.8 12.8l-4.2-4.2m-7.1 0l-4.5 4.5"></path>
        </svg>
        <span data-i18n="settings">Configuración</span>
      </div>
    </aside>

    <main id="main">
      <section id="page-dashboard" class="page active" aria-labelledby="dashboard-title">
        <div class="page-header dashboard-hero">
          <div>
            <p class="dashboard-kicker" data-i18n="dashboardKicker">Operación en vivo</p>
            <h2 class="page-title" id="dashboard-title" data-i18n="dashboard">Dashboard</h2>
          </div>
          <div class="dashboard-date" id="dashboard-date">Cargando fecha...</div>
        </div>

        <!-- Simplified Summary Cards -->
        <div class="dashboard-summary" id="dashboard-summary">
          <div class="summary-card completed">
            <div class="summary-card-label">Proyectos Completados</div>
            <div class="summary-card-value">12</div>
            <div class="summary-card-trend">Este mes</div>
          </div>
          <div class="summary-card active">
            <div class="summary-card-label">En Curso</div>
            <div class="summary-card-value">8</div>
            <div class="summary-card-trend">Proyectos activos</div>
          </div>
          <div class="summary-card upcoming">
            <div class="summary-card-label">Programados</div>
            <div class="summary-card-value">4</div>
            <div class="summary-card-trend">Próximos 7 días</div>
          </div>
        </div>

        <!-- KPI Operacional en Tiempo Real -->
        <div class="grid grid-4 kpi-grid" style="margin-bottom: 24px;">
          <div class="stat-card">
            <div class="stat-label">Técnicos en Campo</div>
            <div class="stat-value" id="kpi-technicians">--</div>
            <div class="stat-change" id="kpi-technicians-detail">Cargando...</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Servicios Hoy</div>
            <div class="stat-value" id="kpi-services-today">--</div>
            <div class="stat-change" id="kpi-services-detail">Cargando...</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Pendientes Urgentes</div>
            <div class="stat-value" id="kpi-urgent">--</div>
            <div class="stat-change" id="kpi-urgent-detail">Cargando...</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Tiempo Respuesta</div>
            <div class="stat-value" id="kpi-response-time">--</div>
            <div class="stat-change" id="kpi-response-detail">Cargando...</div>
          </div>
        </div>

        <!-- Module Access (Conditional) -->
        <div class="card" style="margin-bottom: 24px;">
          <div class="card-header" style="padding: 0 0 16px 0; border: none;">
            <h3 class="card-title">Módulos Premium</h3>
            <p style="font-size: 13px; color: var(--text-secondary); margin: 6px 0 0 0;">Accede a funcionalidades adicionales si tu compañía los ha activado</p>
          </div>
          <div class="grid grid-4" style="gap: 16px;">
            <!-- TimeSync - ACTIVE -->
            <a href="../timesync/timesync.html" class="module-access-card active">
              <div class="module-icon" style="background: linear-gradient(135deg, #02735E, #035951);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
              </div>
              <div class="module-info">
                <strong style="font-size: 15px; display: block; margin-bottom: 4px; color: #ffffff;">TimeSync</strong>
                <span style="font-size: 12px; color: rgba(255, 255, 255, 0.85);">Control de horas y asistencia</span>
              </div>
              <span class="module-badge active">ACTIVO</span>
            </a>

            <!-- ToolSync - INACTIVE -->
            <div class="module-access-card disabled" onclick="alert('ToolSync no está activado. Contacta a soporte para activar este módulo.')">
              <div class="module-icon" style="background: rgba(255, 255, 255, 0.12);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2">
                  <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                </svg>
              </div>
              <div class="module-info">
                <strong style="font-size: 15px; display: block; margin-bottom: 4px; color: rgba(255, 255, 255, 0.9);">ToolSync</strong>
                <span style="font-size: 12px; color: rgba(255, 255, 255, 0.75);">Inventario y equipos</span>
              </div>
              <span class="module-badge disabled">INACTIVO</span>
            </div>

            <!-- HumanSync - INACTIVE -->
            <div class="module-access-card disabled" onclick="alert('HumanSync no está activado. Contacta a soporte para activar este módulo.')">
              <div class="module-icon" style="background: rgba(255, 255, 255, 0.12);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </div>
              <div class="module-info">
                <strong style="font-size: 15px; display: block; margin-bottom: 4px; color: rgba(255, 255, 255, 0.9);">HumanSync</strong>
                <span style="font-size: 12px; color: rgba(255, 255, 255, 0.75);">RH y nómina</span>
              </div>
              <span class="module-badge disabled">INACTIVO</span>
            </div>

            <!-- FinanSync - INACTIVE -->
            <div class="module-access-card disabled" onclick="alert('FinanSync no está activado. Contacta a soporte para activar este módulo.')">
              <div class="module-icon" style="background: rgba(255, 255, 255, 0.12);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2">
                  <line x1="12" y1="1" x2="12" y2="23"></line>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
              </div>
              <div class="module-info">
                <strong style="font-size: 15px; display: block; margin-bottom: 4px; color: rgba(255, 255, 255, 0.9);">FinanSync</strong>
                <span style="font-size: 12px; color: rgba(255, 255, 255, 0.75);">Facturación y contabilidad</span>
              </div>
              <span class="module-badge disabled">INACTIVO</span>
            </div>
      </div>
    </div>
  </section>

      <!-- MOTORSYNC HUB - PROJECTSYNC + THREADSYNC -->
      <section id="page-motorsync" class="page" aria-labelledby="motorsync-title" hidden>
        
        <!-- Header con título y tabs integrados -->
        <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-left: 4px solid var(--primary-color); border-radius: 16px; padding: 20px 24px; margin-bottom: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div style="flex: 1;">
              <p style="font-size: 11px; color: #047857; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700; margin-bottom: 6px;">Sistema Integrado</p>
              <h2 style="font-size: 28px; font-weight: 800; color: #065f46; margin: 0;">MotorSync</h2>
            </div>
            
            <!-- Buscador Global -->
            <div style="position: relative; flex: 1; max-width: 400px; margin: 0 24px;">
              <input 
                type="text" 
                id="globalSearch" 
                placeholder="🔍 Buscar proyectos, clientes, citas, threads..." 
                style="width: 100%; padding: 12px 40px 12px 16px; border: 2px solid #d1fae5; border-radius: 12px; font-size: 14px; background: white; transition: all 0.2s;"
                onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)'"
                onblur="this.style.borderColor='#d1fae5'; this.style.boxShadow='none'"
                onkeyup="performGlobalSearch(this.value)"
              />
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); pointer-events: none;">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              
              <!-- Resultados de búsqueda -->
              <div id="searchResults" style="display: none; position: absolute; top: calc(100% + 8px); left: 0; right: 0; background: white; border: 2px solid #d1fae5; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); max-height: 500px; overflow-y: auto; z-index: 1000;"></div>
            </div>
            
            <div style="display: flex; gap: 12px;">
              <button class="btn btn-white" onclick="alert('Exportar proyectos')" style="border: 1px solid #10b981; color: #10b981;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Exportar
              </button>
              <button class="btn btn-primary" onclick="showNewItemModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Nuevo
              </button>
            </div>
          </div>
          
          <!-- Tabs integrados en el header -->
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary active" data-motorsync-main="projectsync" style="background: white; border: 2px solid #10b981; color: #10b981; font-weight: 600; padding: 10px 20px; border-radius: 10px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
              ProjectSync
            </button>
            <button class="btn btn-secondary" data-motorsync-main="threadsync" style="background: transparent; border: 1px solid rgba(16, 185, 129, 0.3); color: #047857; font-weight: 600; padding: 10px 20px; border-radius: 10px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              ThreadSync
            </button>
          </div>
        </div>

        <!-- PROJECTSYNC CONTENT -->
        <div class="motorsync-main-panel active" data-motorsync-main-panel="projectsync">
          
          <!-- Global Search Bar -->
          <div style="background: white; border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e5e7eb;">
            <div style="position: relative;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%);">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input 
                type="text" 
                id="globalSearchInput" 
                placeholder="Buscar proyectos por nombre, cliente, IDSync, contacto..." 
                style="width: 100%; padding: 12px 12px 12px 44px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; font-weight: 500; transition: all 0.2s;"
                onkeyup="performGlobalSearch(this.value)"
                onfocus="this.style.borderColor='#02735E'"
                onblur="this.style.borderColor='#e5e7eb'"
              />
              <div id="searchResultsDropdown" style="display: none; position: absolute; top: calc(100% + 8px); left: 0; right: 0; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); border: 1px solid #e5e7eb; max-height: 400px; overflow-y: auto; z-index: 1000;">
                <!-- Search results will be populated here -->
              </div>
            </div>
          </div>
          
          <div class="segmented-control projectsync-tabs" role="tablist">
            <button class="btn btn-secondary active" data-projectsync-tab="overview">Resumen</button>
            <button class="btn btn-secondary" data-projectsync-tab="projects">Proyectos</button>
            <button class="btn btn-secondary" data-projectsync-tab="agenda">Agenda</button>
          </div>

        <div class="projectsync-panel active" data-projectsync-panel="overview">
          <div class="grid grid-4 kpi-grid">
            <div class="stat-card">
              <div class="stat-label">Total Proyectos</div>
              <div class="stat-value" id="stat-total-projects">0</div>
              <div class="stat-change" id="stat-active-projects">0 activos</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">En Curso</div>
              <div class="stat-value" id="stat-in-progress">0</div>
              <div class="stat-change positive" id="stat-in-progress-change">--</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Completados</div>
              <div class="stat-value" id="stat-completed">0</div>
              <div class="stat-change" id="stat-completed-change">Este mes</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Programados</div>
              <div class="stat-value" id="stat-scheduled">0</div>
              <div class="stat-change" id="stat-scheduled-change">Próximos 7 días</div>
            </div>
          </div>

          <div class="card" style="margin-top: 24px;">
            <div class="card-header" style="padding: 0 0 16px 0; border: none;">
              <div>
                <h3 class="card-title">Mapa de Proyectos</h3>
                <p style="color: #94a3b8; font-size: 13px; margin-top: 4px;">Integra rutas, cuadrillas y estado operativo en un solo lugar.</p>
              </div>
              <div class="map-filter-group">
                <button class="chip-filter active" data-map-filter="all">Todos</button>
                <button class="chip-filter" data-map-filter="active">Activos</button>
                <button class="chip-filter" data-map-filter="scheduled">Programados</button>
                <button class="chip-filter" data-map-filter="completed">Completados</button>
                <button class="chip-filter" data-map-filter="cancelled">Cancelados</button>
              </div>
            </div>
            <div id="projects-map" style="width: 100%; height: 500px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>
          </div>
        </div>

        <div class="projectsync-panel" data-projectsync-panel="projects">
          <!-- Mapa de Proyectos -->
          <div class="card">
            <div class="card-header" style="padding: 0 0 16px 0; border: none;">
              <div>
                <h3 class="card-title">Mapa de Proyectos</h3>
                <p style="color: #94a3b8; font-size: 13px; margin-top: 4px;">Visualiza y filtra todos tus proyectos en el mapa</p>
              </div>
              <div class="map-filter-group">
                <button class="chip-filter active" data-project-filter="all">Todos (24)</button>
                <button class="chip-filter" data-project-filter="active">Activos (8)</button>
                <button class="chip-filter" data-project-filter="scheduled">Programados (4)</button>
                <button class="chip-filter" data-project-filter="completed">Completados (12)</button>
                <button class="chip-filter" data-project-filter="cancelled">Cancelados (0)</button>
              </div>
            </div>
            <div id="projects-map-projects" style="width: 100%; height: 500px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>
          </div>

          <!-- Lista de Proyectos -->
          <div class="card" style="margin-top: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 class="card-title">Lista de Proyectos</h3>
              <div style="display: flex; gap: 8px;">
                <button class="chip-filter active" data-project-status-filter="all">Todos (24)</button>
                <button class="chip-filter" data-project-status-filter="active">Activos (8)</button>
                <button class="chip-filter" data-project-status-filter="scheduled">Programados (4)</button>
                <button class="chip-filter" data-project-status-filter="completed">Completados (12)</button>
                <button class="chip-filter" data-project-status-filter="cancelled">Cancelados (0)</button>
              </div>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>IDSync</th>
                    <th>Proyecto</th>
                    <th>Cliente</th>
                    <th>Estado</th>
                    <th>Inicio</th>
                    <th>Fin Estimado</th>
                    <th>Monto</th>
                    <th>Progreso</th>
                    <th>ThreadSync</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="overview-projects-tbody">
                <!-- Los proyectos se cargarán dinámicamente desde localStorage -->
                <tr style="display: none;" data-order-id="ORD-201">
                  <td>
                    <strong data-order-idsync="ORD-201">────────</strong>
                    <p style="font-size: 12px; color: #94a3b8; margin: 4px 0 0 0;" data-order-projectcode="ORD-201">Proyecto #1024</p>
                  </td>
                  <td>
                    <strong>Instalación HVAC Completo</strong>
                    <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">Av. Universidad #456</p>
                  </td>
                  <td>Residencial Torres</td>
                    <td><span class="badge" style="background: rgba(2, 115, 94, 0.1); color: #02735E; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">EN CURSO</span></td>
                    <td>10 Ene 2025</td>
                    <td>20 Ene 2025</td>
                    <td><strong>$12,500</strong></td>
                    <td>
                      <div style="width: 100%;">
                        <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                          <div style="background: linear-gradient(135deg, #02735E, #035951); width: 65%; height: 100%;"></div>
                        </div>
                        <p style="font-size: 11px; color: #64748b; margin: 4px 0 0 0;">65%</p>
                      </div>
                    </td>
                  <td>
                    <button class="btn btn-small" style="background: #035951; color: white; display: flex; align-items: center; gap: 6px;" onclick="openProjectChat('ORD-201')">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                      </svg>
                      <span style="font-size: 11px;">5</span>
                    </button>
                  </td>
                  <td>
                    <div class="project-actions-dropdown" style="position: relative;">
                      <button class="btn btn-small btn-secondary" onclick="toggleProjectActions('ORD-201')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="1"/>
                          <circle cx="12" cy="5" r="1"/>
                          <circle cx="12" cy="19" r="1"/>
                        </svg>
                      </button>
                      <div id="actions-ORD-201" class="project-actions-menu" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 150px; z-index: 1000;">
                        <button onclick="openProjectDetail('ORD-201')" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #334155; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                          Ver Detalles
                        </button>
                        <button onclick="openEditProject('ORD-201')" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #334155; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                          Editar
                        </button>
                        <button onclick="duplicateProject('ORD-201')" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #334155; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                          Duplicar
                        </button>
                        <button onclick="pauseProject('ORD-201')" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #f59e0b; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#fffbeb'" onmouseout="this.style.background='none'">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                          Pausar
                        </button>
                        <button onclick="cancelProject('ORD-201')" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #ef4444; display: flex; align-items: center; gap: 8px; border-top: 1px solid #f1f5f9;" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='none'">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                          Cancelar
                        </button>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr data-order-id="ORD-202">
                  <td>
                    <strong data-order-idsync="ORD-202">────────</strong>
                    <p style="font-size: 12px; color: #94a3b8; margin: 4px 0 0 0;" data-order-projectcode="ORD-202">Proyecto #1023</p>
                  </td>
                  <td>
                    <strong>Reparación Sistema Eléctrico</strong>
                    <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">Calle Principal #123</p>
                  </td>
                  <td>Comercial Plaza</td>
                    <td><span class="badge" style="background: rgba(234, 179, 8, 0.1); color: #eab308; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">PROGRAMADO</span></td>
                    <td>18 Ene 2025</td>
                    <td>22 Ene 2025</td>
                    <td><strong>$8,200</strong></td>
                  <td>
                    <div style="width: 100%;">
                      <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: #eab308; width: 0%; height: 100%;"></div>
                      </div>
                      <p style="font-size: 11px; color: #64748b; margin: 4px 0 0 0;">0%</p>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-small" style="background: #02735E; color: white; display: flex; align-items: center; gap: 6px;" onclick="openProjectChat('ORD-202')">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                      </svg>
                      <span style="font-size: 11px;">2</span>
                    </button>
                  </td>
                  <td>
                    <div class="project-actions-dropdown" style="position: relative;">
                      <button class="btn btn-small btn-secondary" onclick="toggleProjectActions('ORD-202')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="1"/>
                          <circle cx="12" cy="5" r="1"/>
                          <circle cx="12" cy="19" r="1"/>
                        </svg>
                      </button>
                      <div id="actions-ORD-202" class="project-actions-menu" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 150px; z-index: 1000;">
                        <button onclick="openProjectDetail('ORD-202')" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #334155; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                          Ver Detalles
                        </button>
                        <button onclick="openEditProject('ORD-202')" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #334155; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                          Editar
                        </button>
                        <button onclick="duplicateProject('ORD-202')" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #334155; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                          Duplicar
                        </button>
                        <button onclick="pauseProject('ORD-202')" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #f59e0b; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#fffbeb'" onmouseout="this.style.background='none'">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                          Pausar
                        </button>
                        <button onclick="cancelProject('ORD-202')" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #ef4444; display: flex; align-items: center; gap: 8px; border-top: 1px solid #f1f5f9;" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='none'">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                          Cancelar
                        </button>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr data-order-id="ORD-203">
                  <td>
                    <strong data-order-idsync="ORD-203">────────</strong>
                    <p style="font-size: 12px; color: #94a3b8; margin: 4px 0 0 0;" data-order-projectcode="ORD-203">Proyecto #1022</p>
                  </td>
                  <td>
                    <strong>Mantenimiento de Calderas</strong>
                    <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">Hotel Zona Centro</p>
                  </td>
                  <td>Hotel Pacífico</td>
                    <td><span class="badge" style="background: rgba(5, 150, 105, 0.1); color: #059669; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">COMPLETADO</span></td>
                    <td>05 Ene 2025</td>
                    <td>08 Ene 2025</td>
                    <td><strong>$15,400</strong></td>
                  <td>
                    <div style="width: 100%;">
                      <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: #059669; width: 100%; height: 100%;"></div>
                      </div>
                      <p style="font-size: 11px; color: #64748b; margin: 4px 0 0 0;">100%</p>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-small" style="background: #64748b; color: white; display: flex; align-items: center; gap: 6px;" onclick="openProjectChat('ORD-203')">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                      </svg>
                      <span style="font-size: 11px;">8</span>
                    </button>
                    </td>
                    <td>
                      <div class="project-actions-dropdown" style="position: relative;">
                        <button class="btn btn-small btn-secondary" onclick="toggleProjectActions('ORD-203')">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="1"/>
                            <circle cx="12" cy="5" r="1"/>
                            <circle cx="12" cy="19" r="1"/>
                          </svg>
                        </button>
                        <div id="actions-ORD-203" class="project-actions-menu" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 150px; z-index: 1000;">
                          <button onclick="openProjectDetail('ORD-203')" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #334155; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            Ver Detalles
                          </button>
                          <button onclick="openEditProject('ORD-203')" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #334155; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            Editar
                          </button>
                          <button onclick="duplicateProject('ORD-203')" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #334155; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='none'">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                            Duplicar
                          </button>
                          <button onclick="pauseProject('ORD-203')" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #f59e0b; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#fffbeb'" onmouseout="this.style.background='none'">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                            Pausar
                          </button>
                          <button onclick="cancelProject('ORD-203')" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #ef4444; display: flex; align-items: center; gap: 8px; border-top: 1px solid #f1f5f9;" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='none'">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                            Cancelar
                          </button>
                        </div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="projectsync-panel" data-projectsync-panel="agenda">
          <!-- KPIs de Agenda -->
          <div class="grid grid-4 kpi-grid">
            <div class="stat-card">
              <div class="stat-label">Hoy</div>
              <div class="stat-value" id="stat-appts-today">0</div>
              <div class="stat-change" id="stat-appts-today-confirmed">0 confirmadas</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Esta Semana</div>
              <div class="stat-value" id="stat-appts-week">0</div>
              <div class="stat-change" id="stat-appts-week-change">--</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Próximos 7 días</div>
              <div class="stat-value" id="stat-appts-next7">0</div>
              <div class="stat-change" id="stat-appts-projects">0 proyectos activos</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Pendientes</div>
              <div class="stat-value" id="stat-appts-pending">0</div>
              <div class="stat-change">Sin confirmar</div>
            </div>
          </div>

          <!-- Navegación de Vista -->
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
              <div class="segmented-control">
                <button class="btn btn-secondary active" data-agenda-view="day">Día</button>
                <button class="btn btn-secondary" data-agenda-view="week">Semana</button>
                <button class="btn btn-secondary" data-agenda-view="month">Mes</button>
                <button class="btn btn-secondary" data-agenda-view="list">Lista</button>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <button class="btn btn-secondary" id="agenda-prev">← Anterior</button>
                <strong style="font-size: 14px; min-width: 150px; text-align: center;" id="agenda-date-display">Noviembre 19, 2025</strong>
                <button class="btn btn-secondary" id="agenda-next">Siguiente →</button>
                <button class="btn btn-primary">+ Nueva Cita</button>
              </div>
            </div>
          </div>

          <!-- VISTA DÍA -->
          <div class="agenda-view" data-agenda-view-content="day" style="display: block;">
            
            <!-- Resumen de Cuadrillas - Solo en Vista Día -->
            <div class="card" style="margin-bottom: 20px;">
              <h3 class="card-title" style="margin-bottom: 16px;">Resumen de Cuadrillas - Martes 19 Nov</h3>
              <div class="grid grid-3" style="gap: 12px;">
                <div style="background: linear-gradient(135deg, rgba(2,115,94,0.08), rgba(2,115,94,0.03)); border: 1px solid rgba(2,115,94,0.2); border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(2,115,94,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'" onclick="alert('Portal de Cuadrilla A - Implementación pendiente')">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <div>
                      <h4 style="font-size: 16px; font-weight: 700; color: #02735E; margin-bottom: 4px;">Cuadrilla A</h4>
                      <p style="font-size: 12px; color: var(--text-secondary);">👨‍🔧 Líder: Juan Pérez</p>
                    </div>
                    <span class="badge" style="background: rgba(2,115,94,0.15); color: #02735E; font-size: 11px;">ACTIVA</span>
                  </div>
                  <div style="font-size: 13px; color: var(--text-primary); margin-bottom: 8px;">
                    <strong>2 proyectos hoy</strong>
                  </div>
                  <div style="font-size: 11px; color: var(--text-secondary); display: flex; flex-direction: column; gap: 4px;">
                    <div>📍 8:00 AM - Plaza Comercial</div>
                    <div>📍 3:30 PM - Edificio Corporativo</div>
                  </div>
                </div>

                <div style="background: linear-gradient(135deg, rgba(234,179,8,0.08), rgba(234,179,8,0.03)); border: 1px solid rgba(234,179,8,0.2); border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(234,179,8,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'" onclick="alert('Portal de Cuadrilla B - Implementación pendiente')">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <div>
                      <h4 style="font-size: 16px; font-weight: 700; color: #eab308; margin-bottom: 4px;">Cuadrilla B</h4>
                      <p style="font-size: 12px; color: var(--text-secondary);">👨‍🔧 Líder: María García</p>
                    </div>
                    <span class="badge" style="background: rgba(234,179,8,0.15); color: #eab308; font-size: 11px;">ACTIVA</span>
                  </div>
                  <div style="font-size: 13px; color: var(--text-primary); margin-bottom: 8px;">
                    <strong>1 proyecto hoy</strong>
                  </div>
                  <div style="font-size: 11px; color: var(--text-secondary); display: flex; flex-direction: column; gap: 4px;">
                    <div>📍 10:00 AM - Residencial Torres</div>
                  </div>
                </div>

                <div style="background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(59,130,246,0.03)); border: 1px solid rgba(59,130,246,0.2); border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(59,130,246,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'" onclick="alert('Portal de Cuadrilla C - Implementación pendiente')">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <div>
                      <h4 style="font-size: 16px; font-weight: 700; color: #3b82f6; margin-bottom: 4px;">Cuadrilla C</h4>
                      <p style="font-size: 12px; color: var(--text-secondary);">👨‍🔧 Líder: Carlos López</p>
                    </div>
                    <span class="badge" style="background: rgba(59,130,246,0.15); color: #3b82f6; font-size: 11px;">ACTIVA</span>
                  </div>
                  <div style="font-size: 13px; color: var(--text-primary); margin-bottom: 8px;">
                    <strong>1 proyecto hoy</strong>
                  </div>
                  <div style="font-size: 11px; color: var(--text-secondary); display: flex; flex-direction: column; gap: 4px;">
                    <div>📍 1:00 PM - Hotel Pacífico</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid grid-2" style="gap: 16px;">
              <!-- Columna Izquierda: Timeline del Día -->
              <div class="card">
                <h3 class="card-title" style="margin-bottom: 16px;">Agenda del Día</h3>
                <div style="display: flex; flex-direction: column; gap: 2px;">
                  <!-- 8:00 AM -->
                  <div style="display: grid; grid-template-columns: 80px 1fr; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">8:00 AM</div>
                    <div style="background: linear-gradient(135deg, rgba(2,115,94,0.08), rgba(3,89,81,0.05)); border-left: 3px solid #02735E; padding: 12px; border-radius: 6px;">
                      <strong style="font-size: 14px; display: block; margin-bottom: 4px;">Inspección Inicial - Plaza Comercial</strong>
                      <p style="font-size: 12px; color: var(--text-secondary); margin: 2px 0;">Cliente: Inmobiliaria del Norte</p>
                      <p style="font-size: 12px; color: var(--text-secondary);">📍 Av. Reforma #1234</p>
                      <div style="margin-top: 6px; display: flex; gap: 6px; align-items: center;">
                        <span class="badge" style="background: rgba(2,115,94,0.1); color: #02735E; font-size: 11px;">Confirmado</span>
                        <span style="font-size: 11px; color: var(--text-secondary);">👥 Cuadrilla A</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 10:00 AM -->
                  <div style="display: grid; grid-template-columns: 80px 1fr; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">10:00 AM</div>
                    <div style="background: linear-gradient(135deg, rgba(234,179,8,0.08), rgba(234,179,8,0.05)); border-left: 3px solid #eab308; padding: 12px; border-radius: 6px;">
                      <strong style="font-size: 14px; display: block; margin-bottom: 4px;">Instalación HVAC - Residencial</strong>
                      <p style="font-size: 12px; color: var(--text-secondary); margin: 2px 0;">Cliente: Familia Torres</p>
                      <p style="font-size: 12px; color: var(--text-secondary);">📍 Calle Universidad #456</p>
                      <div style="margin-top: 6px; display: flex; gap: 6px; align-items: center;">
                        <span class="badge" style="background: rgba(234,179,8,0.1); color: #eab308; font-size: 11px;">Pendiente</span>
                        <span style="font-size: 11px; color: var(--text-secondary);">👥 Cuadrilla B</span>
                      </div>
                    </div>
                  </div>

                  <!-- 1:00 PM -->
                  <div style="display: grid; grid-template-columns: 80px 1fr; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">1:00 PM</div>
                    <div style="background: linear-gradient(135deg, rgba(2,115,94,0.08), rgba(3,89,81,0.05)); border-left: 3px solid #02735E; padding: 12px; border-radius: 6px;">
                      <strong style="font-size: 14px; display: block; margin-bottom: 4px;">Mantenimiento Preventivo</strong>
                      <p style="font-size: 12px; color: var(--text-secondary); margin: 2px 0;">Cliente: Hotel Pacífico</p>
                      <p style="font-size: 12px; color: var(--text-secondary);">📍 Zona Hotelera</p>
                      <div style="margin-top: 6px; display: flex; gap: 6px; align-items: center;">
                        <span class="badge" style="background: rgba(2,115,94,0.1); color: #02735E; font-size: 11px;">Confirmado</span>
                        <span style="font-size: 11px; color: var(--text-secondary);">👥 Cuadrilla C</span>
                      </div>
                    </div>
                  </div>

                  <!-- 3:30 PM -->
                  <div style="display: grid; grid-template-columns: 80px 1fr; gap: 12px; padding: 12px 0;">
                    <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">3:30 PM</div>
                    <div style="background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(59,130,246,0.05)); border-left: 3px solid #3b82f6; padding: 12px; border-radius: 6px;">
                      <strong style="font-size: 14px; display: block; margin-bottom: 4px;">Revisión de Obra - Edificio Corporativo</strong>
                      <p style="font-size: 12px; color: var(--text-secondary); margin: 2px 0;">Cliente: Desarrollos GDL</p>
                      <p style="font-size: 12px; color: var(--text-secondary);">📍 Zona Financiera</p>
                      <div style="margin-top: 6px; display: flex; gap: 6px; align-items: center;">
                        <span class="badge" style="background: rgba(59,130,246,0.1); color: #3b82f6; font-size: 11px;">En ruta</span>
                        <span style="font-size: 11px; color: var(--text-secondary);">👥 Supervisor + Cuadrilla A</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Columna Derecha: Próximos 7 Días -->
              <div class="card">
                <h3 class="card-title" style="margin-bottom: 16px;">Próximos 7 días</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                  <!-- Mañana -->
                  <div style="background: var(--bg-body); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                      <strong style="font-size: 13px; color: var(--text-secondary);">MAÑANA - Nov 20</strong>
                      <span style="font-size: 12px; color: var(--text-secondary);">6 citas</span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                      <div style="font-size: 12px; padding: 6px; background: var(--bg-card); border-radius: 4px;">9:00 AM - Reparación eléctrica</div>
                      <div style="font-size: 12px; padding: 6px; background: var(--bg-card); border-radius: 4px;">11:30 AM - Instalación gas</div>
                      <div style="font-size: 12px; padding: 6px; background: var(--bg-card); border-radius: 4px;">2:00 PM - Mantenimiento</div>
                      <button class="btn btn-secondary" style="margin-top: 6px; font-size: 12px; padding: 6px;">Ver todas →</button>
                    </div>
                  </div>

                  <!-- Jueves -->
                  <div style="background: var(--bg-body); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                      <strong style="font-size: 13px; color: var(--text-secondary);">JUEVES - Nov 21</strong>
                      <span style="font-size: 12px; color: var(--text-secondary);">4 citas</span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                      <div style="font-size: 12px; padding: 6px; background: var(--bg-card); border-radius: 4px;">8:00 AM - Inspección anual</div>
                      <div style="font-size: 12px; padding: 6px; background: var(--bg-card); border-radius: 4px;">1:00 PM - Cotización</div>
                      <button class="btn btn-secondary" style="margin-top: 6px; font-size: 12px; padding: 6px;">Ver todas →</button>
                    </div>
                  </div>

                  <!-- Viernes -->
                  <div style="background: var(--bg-body); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                      <strong style="font-size: 13px; color: var(--text-secondary);">VIERNES - Nov 22</strong>
                      <span style="font-size: 12px; color: var(--text-secondary);">8 citas</span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                      <div style="font-size: 12px; padding: 6px; background: var(--bg-card); border-radius: 4px;">7:30 AM - Servicio urgente</div>
                      <div style="font-size: 12px; padding: 6px; background: var(--bg-card); border-radius: 4px;">10:00 AM - Seguimiento</div>
                      <div style="font-size: 12px; padding: 6px; background: var(--bg-card); border-radius: 4px;">3:00 PM - Entrega proyecto</div>
                      <button class="btn btn-secondary" style="margin-top: 6px; font-size: 12px; padding: 6px;">Ver todas →</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- VISTA SEMANA -->
          <div class="agenda-view" data-agenda-view-content="week" style="display: none;">
            <div class="card">
              <h3 class="card-title" style="margin-bottom: 16px;">Semana del 16 - 22 Nov (Dom - Sáb)</h3>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th style="width: 80px;">Hora</th>
                      <th>Dom 16</th>
                      <th>Lun 17</th>
                      <th>Mar 18</th>
                      <th>Mié 19 <span style="background: #02735E; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 4px;">HOY</span></th>
                      <th>Jue 20</th>
                      <th>Vie 21</th>
                      <th>Sáb 22</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="font-weight: 600; background: #f8fafc;">8:00</td>
                      <td style="background: #fafafa;"></td>
                      <td></td>
                      <td style="background: rgba(2,115,94,0.05); padding: 8px;"><small><strong>Instalación</strong><br>Cliente: Torres</small></td>
                      <td style="background: rgba(2,115,94,0.1); padding: 8px; border: 2px solid #02735E;"><small><strong>Inspección Plaza</strong><br>Cuadrilla A</small></td>
                      <td style="background: rgba(2,115,94,0.05); padding: 8px;"><small><strong>Instalación</strong><br>Cuadrilla A</small></td>
                      <td style="background: rgba(234,179,8,0.05); padding: 8px;"><small><strong>Inspección anual</strong><br>Cuadrilla B</small></td>
                      <td style="background: rgba(59,130,246,0.05); padding: 8px;"><small><strong>Servicio urgente</strong><br>Cuadrilla C</small></td>
                    </tr>
                    <tr>
                      <td style="font-weight: 600; background: #f8fafc;">10:00</td>
                      <td style="background: #fafafa;"></td>
                      <td></td>
                      <td style="background: rgba(2,115,94,0.05); padding: 8px;"><small><strong>Mantenimiento</strong><br>Cliente: García</small></td>
                      <td style="background: rgba(234,179,8,0.1); padding: 8px; border: 2px solid #eab308;"><small><strong>HVAC Instalación</strong><br>Cuadrilla B</small></td>
                      <td style="background: rgba(2,115,94,0.05); padding: 8px;"><small><strong>Reparación</strong><br>Cuadrilla A</small></td>
                      <td style="background: rgba(2,115,94,0.05); padding: 8px;"><small><strong>Mantenimiento</strong><br>Cuadrilla C</small></td>
                      <td style="background: rgba(2,115,94,0.05); padding: 8px;"><small><strong>Seguimiento</strong><br>Supervisor</small></td>
                    </tr>
                    <tr>
                      <td style="font-weight: 600; background: #f8fafc;">13:00</td>
                      <td style="background: #fafafa;"></td>
                      <td></td>
                      <td style="background: rgba(2,115,94,0.05); padding: 8px;"><small><strong>Reparación</strong><br>Cliente: López</small></td>
                      <td style="background: rgba(2,115,94,0.1); padding: 8px; border: 2px solid #02735E;"><small><strong>Mantenimiento</strong><br>Cuadrilla C</small></td>
                      <td style="background: rgba(234,179,8,0.05); padding: 8px;"><small><strong>Instalación gas</strong><br>Cuadrilla B</small></td>
                      <td style="background: rgba(2,115,94,0.05); padding: 8px;"><small><strong>Cotización</strong><br>Supervisor</small></td>
                      <td style="background: rgba(59,130,246,0.05); padding: 8px;"><small><strong>Revisión</strong><br>Cuadrilla A</small></td>
                    </tr>
                    <tr>
                      <td style="font-weight: 600; background: #f8fafc;">15:30</td>
                      <td style="background: #fafafa;"></td>
                      <td></td>
                      <td></td>
                      <td style="background: rgba(59,130,246,0.1); padding: 8px; border: 2px solid #3b82f6;"><small><strong>Revisión Edificio</strong><br>Cuadrilla A + Sup</small></td>
                      <td style="background: rgba(2,115,94,0.05); padding: 8px;"><small><strong>Mantenimiento</strong><br>Cuadrilla B</small></td>
                      <td></td>
                      <td style="background: rgba(234,179,8,0.05); padding: 8px;"><small><strong>Emergencia</strong><br>Cuadrilla C</small></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- VISTA MES -->
          <div class="agenda-view" data-agenda-view-content="month" style="display: none;">
            <div class="card">
              <h3 class="card-title" style="margin-bottom: 20px;">Noviembre 2025</h3>
              <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px;">
                <!-- Header días de la semana -->
                <div style="text-align: center; font-weight: 600; padding: 10px; background: var(--primary-color); color: white; border-radius: 8px; font-size: 13px;">Dom</div>
                <div style="text-align: center; font-weight: 600; padding: 10px; background: var(--primary-color); color: white; border-radius: 8px; font-size: 13px;">Lun</div>
                <div style="text-align: center; font-weight: 600; padding: 10px; background: var(--primary-color); color: white; border-radius: 8px; font-size: 13px;">Mar</div>
                <div style="text-align: center; font-weight: 600; padding: 10px; background: var(--primary-color); color: white; border-radius: 8px; font-size: 13px;">Mié</div>
                <div style="text-align: center; font-weight: 600; padding: 10px; background: var(--primary-color); color: white; border-radius: 8px; font-size: 13px;">Jue</div>
                <div style="text-align: center; font-weight: 600; padding: 10px; background: var(--primary-color); color: white; border-radius: 8px; font-size: 13px;">Vie</div>
                <div style="text-align: center; font-weight: 600; padding: 10px; background: var(--primary-color); color: white; border-radius: 8px; font-size: 13px;">Sáb</div>
                
                <!-- Semana 1 - Nov 1 es Sábado, comenzar desde ahí -->
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; color: var(--text-secondary); border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">1</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">09:00 - Instalación</div>
                    </div>
                  </div>
                </div>
                
                <!-- Semana 2 -->
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; color: var(--text-secondary); border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">2</div>
                  <div style="color: var(--text-secondary); font-size: 12px; font-style: italic;">Sin citas</div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">3</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">08:00 - Revisión</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">4</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">10:00 - Instalación</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">5</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">11:00 - Mantenimiento</div>
                    </div>
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">15:00 - Reparación</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">6</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">09:00 - Instalación</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">7</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">13:00 - Revisión</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">8</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">10:00 - Emergencia</div>
                    </div>
                  </div>
                </div>
                
                <!-- Semana 3 -->
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; color: var(--text-secondary); border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">9</div>
                  <div style="color: var(--text-secondary); font-size: 12px; font-style: italic;">Sin citas</div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">10</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">08:00 - Instalación</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">11</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">14:00 - Mantenimiento</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">12</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">09:00 - Reparación</div>
                    </div>
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">16:00 - Revisión</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">13</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">11:00 - Instalación</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">14</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">15:00 - Mantenimiento</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">15</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">10:00 - Revisión</div>
                    </div>
                  </div>
                </div>
                
                <!-- Semana 4 -->
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; color: var(--text-secondary); border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">16</div>
                  <div style="color: var(--text-secondary); font-size: 12px; font-style: italic;">Sin citas</div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; color: var(--text-secondary); border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">17</div>
                  <div style="color: var(--text-secondary); font-size: 12px; font-style: italic;">Sin citas</div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">18</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">08:00 - Instalación</div>
                    </div>
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">10:00 - Mantenimiento</div>
                    </div>
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">13:00 - Reparación</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 3px solid #02735E; border-radius: 10px; padding: 12px; background: rgba(2,115,94,0.05); box-shadow: 0 4px 12px rgba(2,115,94,0.15);">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; color: #02735E; border-bottom: 2px solid #02735E; padding-bottom: 6px; display: flex; justify-content: space-between; align-items: center;">
                    <span>19</span>
                    <span style="font-size: 10px; background: #02735E; color: white; padding: 3px 6px; border-radius: 4px;">● HOY</span>
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">08:00 - Inspección Plaza</div>
                    </div>
                    <div style="background: #eab308; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">10:00 - HVAC Residencial</div>
                    </div>
                    <div style="background: #3b82f6; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">13:00 - Mantenimiento</div>
                    </div>
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">15:30 - Revisión Edificio</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">20</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">08:00 - Instalación</div>
                    </div>
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">10:00 - Reparación</div>
                    </div>
                    <div style="background: #eab308; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">13:00 - Instalación gas</div>
                    </div>
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">15:30 - Mantenimiento</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">21</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #eab308; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">08:00 - Inspección anual</div>
                    </div>
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">10:00 - Mantenimiento</div>
                    </div>
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">13:00 - Cotización</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">22</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #3b82f6; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">08:00 - Servicio urgente</div>
                    </div>
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">10:00 - Seguimiento</div>
                    </div>
                    <div style="background: #3b82f6; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">13:00 - Revisión</div>
                    </div>
                    <div style="background: #eab308; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">15:30 - Emergencia</div>
                    </div>
                  </div>
                </div>
                
                <!-- Semana 5 -->
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; color: var(--text-secondary); border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">23</div>
                  <div style="color: var(--text-secondary); font-size: 12px; font-style: italic;">Sin citas</div>
                </div>

                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; color: var(--text-secondary); border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">24</div>
                  <div style="color: var(--text-secondary); font-size: 12px; font-style: italic;">Sin citas</div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">25</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">08:00 - Instalación</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">26</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">12:00 - Instalación</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">27</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">14:00 - Mantenimiento</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">28</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #eab308; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">13:00 - Emergencia</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">29</div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="background: #02735E; color: white; font-size: 10px; padding: 6px; border-radius: 4px;">
                      <div style="font-weight: 600;">10:00 - Mantenimiento</div>
                    </div>
                  </div>
                </div>
                
                <div style="min-height: 140px; border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: white;">
                  <div style="font-weight: 700; margin-bottom: 8px; font-size: 16px; color: var(--text-secondary); border-bottom: 2px solid var(--border-color); padding-bottom: 6px;">30</div>
                  <div style="color: var(--text-secondary); font-size: 12px; font-style: italic;">Sin citas</div>
                </div>
              </div>
            </div>
          </div>

          <!-- VISTA LISTA -->
          <div class="agenda-view" data-agenda-view-content="list" style="display: none;">
            <div class="card">
              <h3 class="card-title" style="margin-bottom: 16px;">Todas las Citas</h3>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Hora</th>
                      <th>Servicio</th>
                      <th>Cliente</th>
                      <th>Ubicación</th>
                      <th>Cuadrilla</th>
                      <th>Estado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="agenda-appointments-tbody">
                    <!-- Las citas se cargarán dinámicamente desde localStorage -->
                    <tr style="display: none;">
                      <td><strong>19 Nov</strong></td>
                      <td>8:00 AM</td>
                      <td>Inspección Inicial - Plaza Comercial</td>
                      <td>Inmobiliaria del Norte</td>
                      <td>Av. Reforma #1234</td>
                      <td>Cuadrilla A</td>
                      <td><span class="badge" style="background: rgba(2,115,94,0.1); color: #02735E;">Confirmado</span></td>
                      <td><button class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">Ver</button></td>
                    </tr>
                    <tr>
                      <td><strong>19 Nov</strong></td>
                      <td>10:00 AM</td>
                      <td>Instalación HVAC - Residencial</td>
                      <td>Familia Torres</td>
                      <td>Calle Universidad #456</td>
                      <td>Cuadrilla B</td>
                      <td><span class="badge" style="background: rgba(234,179,8,0.1); color: #eab308;">Pendiente</span></td>
                      <td><button class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">Ver</button></td>
                    </tr>
                    <tr>
                      <td><strong>19 Nov</strong></td>
                      <td>1:00 PM</td>
                      <td>Mantenimiento Preventivo</td>
                      <td>Hotel Pacífico</td>
                      <td>Zona Hotelera</td>
                      <td>Cuadrilla C</td>
                      <td><span class="badge" style="background: rgba(2,115,94,0.1); color: #02735E;">Confirmado</span></td>
                      <td><button class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">Ver</button></td>
                    </tr>
                    <tr>
                      <td><strong>19 Nov</strong></td>
                      <td>3:30 PM</td>
                      <td>Revisión de Obra - Edificio Corporativo</td>
                      <td>Desarrollos GDL</td>
                      <td>Zona Financiera</td>
                      <td>Supervisor + Cuadrilla A</td>
                      <td><span class="badge" style="background: rgba(59,130,246,0.1); color: #3b82f6;">En ruta</span></td>
                      <td><button class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">Ver</button></td>
                    </tr>
                    <tr>
                      <td><strong>20 Nov</strong></td>
                      <td>9:00 AM</td>
                      <td>Reparación eléctrica</td>
                      <td>Comercial Plaza</td>
                      <td>Centro Comercial</td>
                      <td>Cuadrilla A</td>
                      <td><span class="badge" style="background: rgba(2,115,94,0.1); color: #02735E;">Confirmado</span></td>
                      <td><button class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">Ver</button></td>
                    </tr>
                    <tr>
                      <td><strong>20 Nov</strong></td>
                      <td>11:30 AM</td>
                      <td>Instalación gas</td>
                      <td>Residencia López</td>
                      <td>Colonia Jardines</td>
                      <td>Cuadrilla B</td>
                      <td><span class="badge" style="background: rgba(234,179,8,0.1); color: #eab308;">Pendiente</span></td>
                      <td><button class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">Ver</button></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- CLIENTES PANEL - OCULTO (se mostrará al hacer click en proyecto específico)
        <div class="projectsync-panel" data-projectsync-panel="clients">
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
            <div>
              <h3 style="font-size: 20px; color: #0f172a; margin-bottom: 4px;">Clientes dentro de ProjectSync</h3>
              <p style="color: #64748b; font-size: 14px; margin: 0;">Pulso rápido de tus cuentas clave y su relación con los proyectos.</p>
            </div>
            <button class="btn btn-primary" onclick="alert('Nuevo cliente')">+ Nuevo Cliente</button>
          </div>

          <div class="grid grid-3 kpi-grid" style="margin-top: 24px;">
            <div class="stat-card">
              <div class="stat-label">Clientes activos</div>
              <div class="stat-value" id="stat-clients-active">0</div>
              <div class="stat-change" id="stat-clients-change">--</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Proyectos abiertos</div>
              <div class="stat-value" id="stat-clients-projects">0</div>
              <div class="stat-change" id="stat-clients-projects-status">0 en curso</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Facturación acumulada</div>
              <div class="stat-value" id="stat-clients-revenue">$0</div>
              <div class="stat-change" id="stat-clients-revenue-change">--</div>
            </div>
          </div>

          <div class="card" style="margin-top: 24px;">
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Cliente</th>
                    <th>Tipo</th>
                    <th>Contacto</th>
                    <th>Proyectos</th>
                    <th>Último servicio</th>
                    <th>Total gastado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <strong>Residencial Torres</strong>
                      <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">ops@torres.com</p>
                    </td>
                    <td><span class="badge" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">Residencial</span></td>
                    <td>+52 33 1234 5678</td>
                    <td><strong>18</strong></td>
                    <td>10 Ene 2025</td>
                    <td><strong>$124,500</strong></td>
                    <td><button class="btn btn-small btn-secondary">Ver</button></td>
                  </tr>
                  <tr>
                    <td>
                      <strong>Comercial Plaza del Sol</strong>
                      <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">contacto@plazadelsol.mx</p>
                    </td>
                    <td><span class="badge" style="background: rgba(251, 146, 60, 0.1); color: #fb923c;">Comercial</span></td>
                    <td>+52 33 8765 4321</td>
                    <td><strong>12</strong></td>
                    <td>08 Ene 2025</td>
                    <td><strong>$89,200</strong></td>
                    <td><button class="btn btn-small btn-secondary">Ver</button></td>
                  </tr>
                  <tr>
                    <td>
                      <strong>Hotel Pacífico</strong>
                      <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">mantenimiento@hotelpacifico.mx</p>
                    </td>
                    <td><span class="badge" style="background: rgba(16, 185, 129, 0.1); color: #059669;">Hospitality</span></td>
                    <td>+52 55 2213 9988</td>
                    <td><strong>8</strong></td>
                    <td>07 Ene 2025</td>
                    <td><strong>$67,800</strong></td>
                    <td><button class="btn btn-small btn-secondary">Ver</button></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card" style="margin-top: 24px;">
            <h4 style="margin-bottom: 12px;">Seguimiento rápido</h4>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div class="project-thread">
                <div>
                  <strong>Residencial Torres</strong>
                  <div class="project-thread-meta">2 facturas pendientes · visita programada</div>
                </div>
                <button class="btn btn-small btn-primary">Abrir CRM</button>
              </div>
              <div class="project-thread">
                <div>
                  <strong>Comercial Plaza</strong>
                  <div class="project-thread-meta">Contrato anual en revisión</div>
                </div>
                <button class="btn btn-small btn-secondary">Revisar</button>
              </div>
              <div class="project-thread">
                <div>
                  <strong>Hotel Pacífico</strong>
                  <div class="project-thread-meta">Trabajo cerrado · preparar encuesta</div>
                </div>
                <button class="btn btn-small" style="background: #64748b; color: white;">Actualizar</button>
              </div>
            </div>
          </div>
        </div>
        -->
        </div>
        <!-- FIN PROJECTSYNC CONTENT -->

        <!-- THREADSYNC CONTENT -->
        <div class="motorsync-main-panel" data-motorsync-main-panel="threadsync" style="display: none;">
          
          <!-- Header con acciones principales -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div>
              <h2 style="font-size: 24px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">ThreadSync</h2>
              <p style="color: #64748b; font-size: 14px;">Seguimiento de oportunidades y conversaciones de proyectos</p>
            </div>
            <div style="display: flex; gap: 12px;">
              <button class="btn btn-secondary" onclick="refreshThreads()" style="border: 1px solid #10b981; color: #10b981;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.6s ease; transform: rotate(0deg);">
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <polyline points="1 20 1 14 7 14"></polyline>
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                Actualizar
              </button>
              <button class="btn btn-primary" onclick="createNewThread()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Nuevo Thread
              </button>
            </div>
          </div>

          <!-- Filtros tipo chips -->
          <div style="display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; align-items: center;">
            <span style="font-size: 13px; font-weight: 600; color: #64748b; margin-right: 4px;">Filtrar:</span>
            <button class="chip-filter active" data-thread-filter="all">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                <path d="M3 3h18v18H3z"></path>
              </svg>
              Todos
            </button>
            <button class="chip-filter" data-thread-filter="my-threads">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              Mis Threads
            </button>
            <button class="chip-filter" data-thread-filter="mentions">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path>
              </svg>
              Menciones
            </button>
            <button class="chip-filter" data-thread-filter="unread">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                <circle cx="12" cy="12" r="10"></circle>
                <circle cx="12" cy="12" r="3" fill="currentColor"></circle>
              </svg>
              No Leídos
              <span style="background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 4px;">3</span>
            </button>
            <button class="chip-filter" data-thread-filter="archived">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                <polyline points="21 8 21 21 3 21 3 8"></polyline>
                <rect x="1" y="3" width="22" height="5"></rect>
                <line x1="10" y1="12" x2="14" y2="12"></line>
              </svg>
              Archivados
            </button>
          </div>

          <!-- Lista de threads agrupados por proyecto -->
          <div class="threads-list" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
            
            <!-- Proyecto 1 -->
            <div class="thread-project-group">
              <div class="thread-project-header" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-left: 4px solid #10b981; padding: 16px; border-radius: 12px; margin-bottom: 12px;">
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <div>
                    <h3 style="font-size: 15px; font-weight: 700; color: #065f46; line-height: 1.3;">
                      Instalación HVAC Completo
                    </h3>
                  </div>
                  <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <span style="background: white; color: #10b981; font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 10px; border: 1px solid #10b981;">
                      ACTIVO
                    </span>
                    <span style="background: #10b981; color: white; font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 10px;">
                      3 threads
                    </span>
                  </div>
                  <p style="color: #047857; font-size: 11px; opacity: 0.9; line-height: 1.4;">
                    Proyecto #1024 • 1 no leído
                  </p>
                  <div style="display: flex; gap: 6px; margin-top: 4px;">
                    <button class="btn btn-small" style="background: #10b981; border: 1px solid #10b981; color: white; font-size: 11px; padding: 6px 12px; flex: 1; display: flex; align-items: center; justify-content: center; gap: 4px;" onclick="event.stopPropagation(); goToProject('project-1', true)" title="Proyecto activo">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"></path>
                      </svg>
                      Ir al Proyecto
                    </button>
                    <button class="btn btn-small" style="background: white; border: 1px solid #10b981; color: #10b981; font-size: 11px; padding: 6px 10px;" onclick="event.stopPropagation(); createThreadForProject('project-1')" title="Nuevo Thread">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>

              <div id="threads-project-1" class="threads-container" style="display: grid;">
                
                <!-- Thread 1 - No leído -->
                <div class="thread-card unread" style="background: white; border-left: 3px solid #10b981; border-radius: 8px; padding: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" onclick="openThread('thread-1')">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                    <h4 style="font-size: 13px; font-weight: 600; color: #0f172a; line-height: 1.3;">
                      📋 Cambios en especificaciones
                      <span style="background: #ef4444; color: white; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 8px; margin-left: 4px;">3</span>
                    </h4>
                    <button class="btn-icon" onclick="event.stopPropagation(); archiveThread('thread-1')" title="Archivar">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="21 8 21 21 3 21 3 8"></polyline>
                        <rect x="1" y="3" width="22" height="5"></rect>
                      </svg>
                    </button>
                  </div>
                  
                  <p style="font-size: 11px; color: #64748b; line-height: 1.4; margin-bottom: 8px;">
                    El cliente solicita modificar el refrigerante de R-410A a R-32...
                  </p>
                  
                  <!-- Metadata compacta -->
                  <div style="display: flex; flex-direction: column; gap: 4px; font-size: 10px; color: #94a3b8;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <img src="https://ui-avatars.com/api/?name=Juan+Perez&size=18&background=10b981&color=fff" style="width: 18px; height: 18px; border-radius: 50%;">
                      <span style="font-weight: 600;">Juan Pérez</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                      <span>💬 15</span>
                      <span>📎 3</span>
                      <span>🕐 2h</span>
                    </div>
                  </div>
                </div>

                <!-- Thread 2 - Leído -->
                <div class="thread-card" style="background: white; border-left: 3px solid #cbd5e1; border-radius: 8px; padding: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" onclick="openThread('thread-2')">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                    <h4 style="font-size: 13px; font-weight: 600; color: #0f172a; line-height: 1.3;">
                      🔧 Coordinación de instalación
                    </h4>
                    <button class="btn-icon" onclick="event.stopPropagation(); archiveThread('thread-2')" title="Archivar">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="21 8 21 21 3 21 3 8"></polyline>
                        <rect x="1" y="3" width="22" height="5"></rect>
                      </svg>
                    </button>
                  </div>
                  
                  <p style="font-size: 11px; color: #64748b; line-height: 1.4; margin-bottom: 8px;">
                    Confirmar acceso al sitio el martes 21 nov a las 8:00 AM...
                  </p>
                  
                  <!-- Metadata compacta -->
                  <div style="display: flex; flex-direction: column; gap: 4px; font-size: 10px; color: #94a3b8;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <img src="https://ui-avatars.com/api/?name=Maria+Garcia&size=18&background=f97316&color=fff" style="width: 18px; height: 18px; border-radius: 50%;">
                      <span style="font-weight: 600;">María García</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                      <span>💬 8</span>
                      <span>📎 1</span>
                      <span>🕐 1d</span>
                    </div>
                  </div>
                </div>

                <!-- Thread 3 - Con fotos -->
                <div class="thread-card" style="background: white; border-left: 3px solid #cbd5e1; border-radius: 8px; padding: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" onclick="openThread('thread-3')">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                    <h4 style="font-size: 13px; font-weight: 600; color: #0f172a; line-height: 1.3;">
                      📸 Fotos del progreso
                      <span style="background: #3b82f6; color: white; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 8px; margin-left: 4px;">24</span>
                    </h4>
                    <button class="btn-icon" onclick="event.stopPropagation(); archiveThread('thread-3')" title="Archivar">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="21 8 21 21 3 21 3 8"></polyline>
                        <rect x="1" y="3" width="22" height="5"></rect>
                      </svg>
                    </button>
                  </div>
                  
                  <p style="font-size: 11px; color: #64748b; line-height: 1.4; margin-bottom: 8px;">
                    Documentación fotográfica del avance de obra hasta el viernes...
                  </p>
                  
                  <!-- Metadata compacta -->
                  <div style="display: flex; flex-direction: column; gap: 4px; font-size: 10px; color: #94a3b8;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <img src="https://ui-avatars.com/api/?name=Carlos+Lopez&size=18&background=3b82f6&color=fff" style="width: 18px; height: 18px; border-radius: 50%;">
                      <span style="font-weight: 600;">Carlos López</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                      <span>💬 12</span>
                      <span>📎 24</span>
                      <span>🕐 3d</span>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            <!-- Proyecto 2 -->
            <div class="thread-project-group">
              <div class="thread-project-header" style="background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); border-left: 4px solid #f97316; padding: 16px; border-radius: 12px; margin-bottom: 12px;">
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <div>
                    <h3 style="font-size: 15px; font-weight: 700; color: #c2410c; line-height: 1.3;">
                      Reparación Sistema Eléctrico
                    </h3>
                  </div>
                  <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <span style="background: white; color: #f97316; font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 10px; border: 1px solid #f97316;">
                      EN PROGRESO
                    </span>
                    <span style="background: #f97316; color: white; font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 10px;">
                      1 thread
                    </span>
                  </div>
                  <p style="color: #ea580c; font-size: 11px; opacity: 0.9; line-height: 1.4;">
                    Proyecto #1025 • 1 no leído
                  </p>
                  <div style="display: flex; gap: 6px; margin-top: 4px;">
                    <button class="btn btn-small" style="background: #e5e7eb; border: 1px solid #9ca3af; color: #6b7280; font-size: 11px; padding: 6px 12px; flex: 1; display: flex; align-items: center; justify-content: center; gap: 4px; cursor: not-allowed; opacity: 0.7;" onclick="event.stopPropagation(); goToProject('project-2', false)" title="Sin proyecto activo">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"></path>
                      </svg>
                      Sin Activar
                    </button>
                    <button class="btn btn-small" style="background: white; border: 1px solid #f97316; color: #f97316; font-size: 11px; padding: 6px 10px;" onclick="event.stopPropagation(); createThreadForProject('project-2')" title="Nuevo Thread">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>

              <div id="threads-project-2" class="threads-container" style="display: grid;">
                
                <!-- Thread 1 - No leído -->
                <div class="thread-card unread" style="background: white; border-left: 3px solid #f97316; border-radius: 8px; padding: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" onclick="openThread('thread-4')">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                    <h4 style="font-size: 13px; font-weight: 600; color: #0f172a; line-height: 1.3;">
                      ⚡ Inspección de seguridad
                      <span style="background: #ef4444; color: white; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 8px; margin-left: 4px;">1</span>
                    </h4>
                    <button class="btn-icon" onclick="event.stopPropagation(); archiveThread('thread-4')" title="Archivar">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="21 8 21 21 3 21 3 8"></polyline>
                        <rect x="1" y="3" width="22" height="5"></rect>
                      </svg>
                    </button>
                  </div>
                  
                  <p style="font-size: 11px; color: #64748b; line-height: 1.4; margin-bottom: 8px;">
                    Resultados de la inspección inicial y recomendaciones de actualización...
                  </p>
                  
                  <!-- Metadata compacta -->
                  <div style="display: flex; flex-direction: column; gap: 4px; font-size: 10px; color: #94a3b8;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <img src="https://ui-avatars.com/api/?name=Ana+Martinez&size=18&background=10b981&color=fff" style="width: 18px; height: 18px; border-radius: 50%;">
                      <span style="font-weight: 600;">Ana Martínez</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                      <span>💬 6</span>
                      <span>📎 2</span>
                      <span>🕐 5h</span>
                    </div>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </div>
        <!-- FIN THREADSYNC CONTENT -->

      </section>

      <!-- MODAL: Ver Detalles del Proyecto con ThreadSync -->
      <div id="projectDetailModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto;">
        <div class="modal-content" style="background: white; margin: 40px auto; max-width: 1200px; border-radius: 16px; position: relative;">
          <button onclick="closeProjectDetail()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 28px; cursor: pointer; color: #64748b; z-index: 10;">&times;</button>
          
          <div style="padding: 32px;">
            <!-- Header del Proyecto -->
            <div style="border-bottom: 1px solid #e2e8f0; padding-bottom: 24px; margin-bottom: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                  <h2 id="modal-project-title" style="font-size: 28px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">Instalación HVAC Completo</h2>
                  <p id="modal-project-location" style="color: #64748b; font-size: 16px; margin-bottom: 12px;">Av. Universidad #456</p>
                  <div style="display: flex; gap: 12px; align-items: center;">
                    <span id="modal-project-idsync" class="badge" style="background: rgba(2, 115, 94, 0.1); color: #02735E; padding: 6px 12px; font-size: 13px;">IDSync: ────────</span>
                    <span id="modal-project-status" class="badge" style="background: rgba(2, 115, 94, 0.1); color: #02735E; padding: 6px 12px; font-size: 13px;">EN CURSO</span>
                    <span id="modal-project-code" style="color: #94a3b8; font-size: 14px;">Proyecto #1024</span>
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 32px; font-weight: 700; color: #02735E;" id="modal-project-amount">$12,500</div>
                  <div style="color: #64748b; font-size: 14px;">Monto total</div>
                </div>
              </div>
            </div>

            <!-- Tabs: Información y ThreadSync -->
            <div style="border-bottom: 1px solid #e2e8f0; margin-bottom: 24px;">
              <div style="display: flex; gap: 24px;">
                <button onclick="switchModalTab('info')" id="modal-tab-info" class="modal-tab-active" style="padding: 12px 0; border: none; background: none; font-size: 15px; font-weight: 600; color: #02735E; border-bottom: 2px solid #02735E; cursor: pointer;">
                  Información del Proyecto
                </button>
                <button onclick="switchModalTab('threads')" id="modal-tab-threads" style="padding: 12px 0; border: none; background: none; font-size: 15px; font-weight: 600; color: #64748b; border-bottom: 2px solid transparent; cursor: pointer;">
                  ThreadSync <span id="modal-threads-count" style="background: #e2e8f0; color: #64748b; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 4px;">5</span>
                </button>
              </div>
            </div>

            <!-- Tab Content: Información -->
            <div id="modal-content-info" style="display: block;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
                <!-- Columna Izquierda -->
                <div>
                  <h3 style="font-size: 18px; font-weight: 600; color: #0f172a; margin-bottom: 16px;">Detalles del Proyecto</h3>
                  <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                      <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">Cliente</div>
                      <div id="modal-project-client" style="font-size: 15px; color: #0f172a; font-weight: 500;">Residencial Torres</div>
                    </div>
                    <div>
                      <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">Dirección Completa</div>
                      <div id="modal-project-address" style="font-size: 15px; color: #0f172a;">Av. Universidad #456, CDMX</div>
                    </div>
                    <div>
                      <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">Equipo Asignado</div>
                      <div id="modal-project-team" style="font-size: 15px; color: #0f172a;">HVAC Norte · 4 técnicos</div>
                    </div>
                    <div>
                      <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">Contrato</div>
                      <div id="modal-project-contract" style="font-size: 15px; color: #0f172a;">MS-2024-045 (firmado)</div>
                    </div>
                    <div>
                      <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">Facturas</div>
                      <div id="modal-project-invoices" style="font-size: 15px; color: #0f172a;">#INV-410 · pendiente de pago</div>
                    </div>
                  </div>
                </div>

                <!-- Columna Derecha -->
                <div>
                  <h3 style="font-size: 18px; font-weight: 600; color: #0f172a; margin-bottom: 16px;">Fechas y Progreso</h3>
                  <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                      <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">Fecha de Inicio</div>
                      <div id="modal-project-start" style="font-size: 15px; color: #0f172a; font-weight: 500;">10 Ene 2025</div>
                    </div>
                    <div>
                      <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">Fecha de Finalización Estimada</div>
                      <div id="modal-project-end" style="font-size: 15px; color: #0f172a; font-weight: 500;">20 Ene 2025</div>
                    </div>
                    <div>
                      <div style="font-size: 13px; color: #64748b; margin-bottom: 12px;">Progreso del Proyecto</div>
                      <div style="background: #e2e8f0; height: 12px; border-radius: 999px; overflow: hidden; margin-bottom: 8px;">
                        <div id="modal-project-progress-bar" style="background: linear-gradient(135deg, #02735E, #035951); width: 65%; height: 100%;"></div>
                      </div>
                      <div id="modal-project-progress-text" style="font-size: 24px; font-weight: 700; color: #02735E;">65%</div>
                    </div>
                  </div>

                  <h3 style="font-size: 18px; font-weight: 600; color: #0f172a; margin: 24px 0 16px;">Timeline del Proyecto</h3>
                  <div id="modal-project-timeline" style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; gap: 12px; align-items: start;">
                      <div style="width: 12px; height: 12px; border-radius: 50%; background: #02735E; margin-top: 4px;"></div>
                      <div style="flex: 1;">
                        <div style="font-weight: 600; color: #0f172a;">Kickoff & permisos</div>
                        <div style="font-size: 13px; color: #64748b;">10 Nov</div>
                      </div>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: start;">
                      <div style="width: 12px; height: 12px; border-radius: 50%; background: #02735E; margin-top: 4px;"></div>
                      <div style="flex: 1;">
                        <div style="font-weight: 600; color: #0f172a;">Entrega de materiales</div>
                        <div style="font-size: 13px; color: #64748b;">12 Nov</div>
                      </div>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: start;">
                      <div style="width: 12px; height: 12px; border-radius: 50%; background: #cbd5e1; margin-top: 4px;"></div>
                      <div style="flex: 1;">
                        <div style="font-weight: 600; color: #64748b;">Instalación y puesta en marcha</div>
                        <div style="font-size: 13px; color: #64748b;">17-20 Nov</div>
                      </div>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: start;">
                      <div style="width: 12px; height: 12px; border-radius: 50%; background: #cbd5e1; margin-top: 4px;"></div>
                      <div style="flex: 1;">
                        <div style="font-weight: 600; color: #64748b;">QA + cierre administrativo</div>
                        <div style="font-size: 13px; color: #64748b;">21 Nov</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tab Content: ThreadSync -->
            <div id="modal-content-threads" style="display: none;">
              <div id="modal-threads-container">
                <!-- Comentarios del equipo -->
                <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                  <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #02735E, #035951); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">JD</div>
                    <div style="flex: 1;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                          <div style="font-weight: 600; color: #0f172a;">Juan Díaz</div>
                          <div style="font-size: 13px; color: #64748b;">Supervisor · hace 2 horas</div>
                        </div>
                      </div>
                      <div style="color: #334155; line-height: 1.6;">
                        El equipo completó la instalación de los ductos principales. Mañana comenzamos con las conexiones eléctricas.
                      </div>
                      <div style="margin-top: 12px; display: flex; gap: 8px;">
                        <div style="display: inline-block; padding: 8px 12px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 13px; color: #64748b;">📷 IMG_4521.jpg</div>
                      </div>
                    </div>
                  </div>
                </div>

                <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                  <div style="display: flex; gap: 12px;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #94a3b8; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">MR</div>
                    <div style="flex: 1;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                          <div style="font-weight: 600; color: #0f172a;">María Rodríguez</div>
                          <div style="font-size: 13px; color: #64748b;">Técnico · hace 5 horas</div>
                        </div>
                      </div>
                      <div style="color: #334155; line-height: 1.6;">
                        Necesitamos autorización para el cambio de material. El especificado no está disponible hasta la próxima semana.
                      </div>
                    </div>
                  </div>
                </div>

                <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                  <div style="display: flex; gap: 12px;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #64748b; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">CL</div>
                    <div style="flex: 1;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                          <div style="font-weight: 600; color: #0f172a;">Cliente - Residencial Torres</div>
                          <div style="font-size: 13px; color: #64748b;">hace 1 día</div>
                        </div>
                      </div>
                      <div style="color: #334155; line-height: 1.6;">
                        ¿Cuándo estará lista la instalación? Necesitamos coordinar con el equipo de limpieza.
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Formulario para nuevo comentario -->
                <div style="margin-top: 24px; padding: 20px; background: white; border: 2px dashed #e2e8f0; border-radius: 12px;">
                  <textarea placeholder="Escribe un comentario para el equipo..." style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                    <button style="padding: 8px 16px; background: none; border: 1px solid #e2e8f0; border-radius: 8px; color: #64748b; cursor: pointer; font-size: 14px;">
                      📎 Adjuntar archivo
                    </button>
                    <button style="padding: 10px 24px; background: linear-gradient(135deg, #02735E, #035951); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                      Publicar Comentario
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL: Seleccionar Proyecto para Nuevo Thread -->
      <div id="newThreadModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto;">
        <div class="modal-content" style="background: white; margin: 80px auto; max-width: 600px; border-radius: 16px; position: relative;">
          <button onclick="closeNewThreadModal()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 28px; cursor: pointer; color: #64748b; z-index: 10;">&times;</button>
          
          <div style="padding: 32px;">
            <h2 style="font-size: 24px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">Crear Nuevo Thread</h2>
            <p style="color: #64748b; font-size: 14px; margin-bottom: 24px;">Selecciona el proyecto para el cual deseas crear el thread</p>
            
            <!-- Lista de proyectos -->
            <div style="display: grid; gap: 12px; margin-bottom: 24px;">
              
              <!-- Proyecto 1 -->
              <div class="project-select-card" onclick="selectProjectForThread('project-1', 'Instalación HVAC Completo')" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 12px; height: 12px; background: #10b981; border-radius: 50%; flex-shrink: 0;"></div>
                  <div style="flex: 1;">
                    <h3 style="font-size: 15px; font-weight: 600; color: #0f172a; margin-bottom: 4px;">Instalación HVAC Completo</h3>
                    <p style="font-size: 13px; color: #64748b;">Proyecto #1024 • Activo • 3 threads existentes</p>
                  </div>
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"></path>
                  </svg>
                </div>
              </div>

              <!-- Proyecto 2 -->
              <div class="project-select-card" onclick="selectProjectForThread('project-2', 'Reparación Sistema Eléctrico')" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 12px; height: 12px; background: #f97316; border-radius: 50%; flex-shrink: 0;"></div>
                  <div style="flex: 1;">
                    <h3 style="font-size: 15px; font-weight: 600; color: #0f172a; margin-bottom: 4px;">Reparación Sistema Eléctrico</h3>
                    <p style="font-size: 13px; color: #64748b;">Proyecto #1025 • En Progreso • 1 thread existente</p>
                  </div>
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"></path>
                  </svg>
                </div>
              </div>

              <!-- Proyecto 3 -->
              <div class="project-select-card" onclick="selectProjectForThread('project-3', 'Mantenimiento Preventivo Oficinas')" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 12px; height: 12px; background: #94a3b8; border-radius: 50%; flex-shrink: 0;"></div>
                  <div style="flex: 1;">
                    <h3 style="font-size: 15px; font-weight: 600; color: #0f172a; margin-bottom: 4px;">Mantenimiento Preventivo Oficinas</h3>
                    <p style="font-size: 13px; color: #64748b;">Proyecto #1026 • Programado • Sin threads</p>
                  </div>
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"></path>
                  </svg>
                </div>
              </div>

            </div>

            <div style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
              <button type="button" onclick="closeNewThreadModal()" style="padding: 10px 24px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; color: #64748b; font-weight: 600; cursor: pointer;">
                Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL: Editar Proyecto -->
      <div id="editProjectModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto;">
        <div class="modal-content" style="background: white; margin: 40px auto; max-width: 900px; border-radius: 16px; position: relative;">
          <button onclick="closeEditProject()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 28px; cursor: pointer; color: #64748b; z-index: 10;">&times;</button>
          
          <div style="padding: 32px;">
            <h2 style="font-size: 24px; font-weight: 700; color: #0f172a; margin-bottom: 24px;">Editar Proyecto</h2>
            
            <form id="editProjectForm" style="display: grid; gap: 24px;">
              <!-- Información Básica -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; color: #334155; margin-bottom: 8px;">Nombre del Proyecto *</label>
                  <input type="text" id="edit-project-name" value="Instalación HVAC Completo" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;" required>
                </div>
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; color: #334155; margin-bottom: 8px;">Cliente *</label>
                  <input type="text" id="edit-project-client" value="Residencial Torres" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;" required>
                </div>
              </div>

              <div>
                <label style="display: block; font-size: 14px; font-weight: 600; color: #334155; margin-bottom: 8px;">Dirección *</label>
                <input type="text" id="edit-project-address" value="Av. Universidad #456" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;" required>
              </div>

              <!-- Fechas y Monto -->
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; color: #334155; margin-bottom: 8px;">Fecha de Inicio *</label>
                  <input type="date" id="edit-project-start" value="2025-11-25" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;" required>
                </div>
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; color: #334155; margin-bottom: 8px;">Fecha Estimada de Fin *</label>
                  <input type="date" id="edit-project-end" value="2025-12-15" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;" required>
                </div>
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; color: #334155; margin-bottom: 8px;">Monto Total *</label>
                  <input type="number" id="edit-project-amount" value="12500" step="0.01" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;" required>
                </div>
              </div>

              <!-- Estado y Progreso -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; color: #334155; margin-bottom: 8px;">Estado del Proyecto *</label>
                  <select id="edit-project-status" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;" required>
                    <option value="active">En Curso</option>
                    <option value="scheduled">Programado</option>
                    <option value="paused">Pausado</option>
                    <option value="completed">Completado</option>
                    <option value="cancelled">Cancelado</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; color: #334155; margin-bottom: 8px;">Progreso (%)</label>
                  <input type="number" id="edit-project-progress" value="65" min="0" max="100" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                </div>
              </div>

              <!-- Equipo y Contrato -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; color: #334155; margin-bottom: 8px;">Equipo Asignado</label>
                  <input type="text" id="edit-project-team" value="HVAC Norte · 4 técnicos" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                </div>
                <div>
                  <label style="display: block; font-size: 14px; font-weight: 600; color: #334155; margin-bottom: 8px;">Número de Contrato</label>
                  <input type="text" id="edit-project-contract" value="MS-2024-045" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                </div>
              </div>

              <!-- Notas Adicionales -->
              <div>
                <label style="display: block; font-size: 14px; font-weight: 600; color: #334155; margin-bottom: 8px;">Notas Adicionales</label>
                <textarea id="edit-project-notes" style="width: 100%; min-height: 100px; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;" placeholder="Añade cualquier información adicional sobre el proyecto..."></textarea>
              </div>

              <!-- Botones de Acción -->
              <div style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
                <button type="button" onclick="closeEditProject()" style="padding: 10px 24px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; color: #64748b; font-weight: 600; cursor: pointer;">
                  Cancelar
                </button>
                <button type="submit" style="padding: 10px 24px; background: linear-gradient(135deg, #02735E, #035951); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                  Guardar Cambios
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <section id="page-customers" class="page" aria-labelledby="customers-title" hidden>
        <div class="page-header">
          <div>
            <h2 class="page-title" id="customers-title" data-i18n="customers">Clientes</h2>
            <p class="schedule-subtitle">Gestión de Relaciones</p>
          </div>
          <button class="btn btn-primary" id="btn-new-customer" data-capability="customers.manage">＋ <span data-i18n="newCustomer">Nuevo cliente</span></button>
        </div>

        <!-- Stats -->
        <div class="grid grid-3 customers-dashboard kpi-grid">
          <div class="stat-card">
            <div class="stat-label" data-i18n="customersStatTotal">Clientes activos</div>
            <div class="stat-value" id="customer-stat-total">127</div>
            <div class="stat-change positive" id="customer-stat-total-hint">↑ 14 este mes</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Proyectos</div>
            <div class="stat-value" id="customer-stat-addresses">342</div>
            <div class="stat-change" id="customer-stat-addresses-hint">Histórico total</div>
          </div>
          <div class="stat-card">
            <div class="stat-label" data-i18n="customersStatActive">Proyectos Activos</div>
            <div class="stat-value" id="customer-stat-active">24</div>
            <div class="stat-change positive" id="customer-stat-active-hint">8 en curso</div>
          </div>
        </div>

        <!-- Filters & Search -->
        <div class="orders-toolbar customers-toolbar">
          <div class="orders-chip-group" id="customers-type-filters">
            <button class="chip-filter active" data-customer-filter="all" data-i18n="customersFilterAll">Todos</button>
            <button class="chip-filter" data-customer-filter="residential" data-i18n="customersFilterResidential">Residencial</button>
            <button class="chip-filter" data-customer-filter="commercial" data-i18n="customersFilterCommercial">Comercial</button>
          </div>
          <input type="search" id="customers-search" placeholder="Buscar cliente por nombre, email o teléfono…" aria-label="Buscar clientes">
        </div>

        <!-- Customers Table -->
        <div class="card">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th>Tipo</th>
                  <th>Contacto</th>
                  <th>Proyectos</th>
                  <th>Último Servicio</th>
                  <th>Total Gastado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr onclick="alert('Ver detalle completo de Residencial Torres')">
                  <td>
                    <strong>Residencial Torres</strong>
                    <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">ops@torres.com</p>
                  </td>
                  <td><span class="badge" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">Residencial</span></td>
                  <td>+52 33 1234 5678</td>
                  <td><strong>18</strong> proyectos</td>
                  <td>10 Ene 2025</td>
                  <td><strong>$124,500</strong></td>
                  <td>
                    <button class="btn btn-small btn-primary">Ver Detalle</button>
                  </td>
                </tr>
                <tr onclick="alert('Ver detalle completo de Comercial Plaza')">
                  <td>
                    <strong>Comercial Plaza del Sol</strong>
                    <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">contacto@plazadelsol.mx</p>
                  </td>
                  <td><span class="badge" style="background: rgba(251, 146, 60, 0.1); color: #fb923c;">Comercial</span></td>
                  <td>+52 33 8765 4321</td>
                  <td><strong>12</strong> proyectos</td>
                  <td>08 Ene 2025</td>
                  <td><strong>$89,200</strong></td>
                  <td>
                    <button class="btn btn-small btn-primary">Ver Detalle</button>
                  </td>
                </tr>
                <tr onclick="alert('Ver detalle completo de Hotel Pacífico')">
                  <td>
                    <strong>Hotel Pacífico</strong>
                    <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">mantenimiento@pacifico.com</p>
                  </td>
                  <td><span class="badge" style="background: rgba(251, 146, 60, 0.1); color: #fb923c;">Comercial</span></td>
                  <td>+52 33 5555 6666</td>
                  <td><strong>8</strong> proyectos</td>
                  <td>05 Ene 2025</td>
                  <td><strong>$67,800</strong></td>
                  <td>
                    <button class="btn btn-small btn-primary">Ver Detalle</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Customer Detail Modal/Panel (Hidden by default) -->
        <div class="customer-detail-overlay" id="customer-detail-overlay" style="display: none;">
          <div class="customer-detail-modal">
            <div class="customer-detail-header">
              <div>
                <p class="dashboard-kicker">Cliente Residencial</p>
                <h3 style="font-size: 28px; margin: 8px 0;">Residencial Torres</h3>
                <p style="font-size: 14px; color: #64748b; margin: 8px 0 0 0;">ops@torres.com • +52 33 1234 5678</p>
              </div>
              <button class="btn btn-secondary" onclick="document.getElementById('customer-detail-overlay').style.display='none'">× Cerrar</button>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-4" style="margin: 24px 0; gap: 16px;">
              <div class="stat-card">
                <div class="stat-label">Total Proyectos</div>
                <div class="stat-value">18</div>
                <div class="stat-change">Histórico</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">En Curso</div>
                <div class="stat-value">3</div>
                <div class="stat-change">Activos ahora</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Total Gastado</div>
                <div class="stat-value">$124,500</div>
                <div class="stat-change">Lifetime value</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Satisfacción</div>
                <div class="stat-value">4.9/5</div>
                <div class="stat-change positive">Excelente</div>
              </div>
            </div>

            <!-- Project History -->
            <div class="card">
              <div class="card-header" style="padding: 0 0 16px 0; border: none;">
                <h3 class="card-title">Historial de Proyectos</h3>
                <button class="btn btn-primary btn-small" onclick="showNewItemModal()">+ Nuevo Proyecto</button>
              </div>
              
              <!-- Project Tabs -->
              <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color);">
                <button class="tab-button active" style="padding: 10px 20px; border: none; background: none; font-weight: 600; border-bottom: 3px solid #02735E; margin-bottom: -2px; cursor: pointer;">Activos (3)</button>
                <button class="tab-button" style="padding: 10px 20px; border: none; background: none; font-weight: 600; color: #64748b; cursor: pointer;">Completados (12)</button>
                <button class="tab-button" style="padding: 10px 20px; border: none; background: none; font-weight: 600; color: #64748b; cursor: pointer;">Programados (2)</button>
                <button class="tab-button" style="padding: 10px 20px; border: none; background: none; font-weight: 600; color: #64748b; cursor: pointer;">Cancelados (1)</button>
              </div>

              <!-- Project List -->
              <div style="display: flex; flex-direction: column; gap: 16px;">
                <!-- Project 1 -->
                <div style="border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <div>
                      <strong style="font-size: 16px;">Instalación HVAC Completo</strong>
                      <p style="font-size: 13px; color: #64748b; margin: 6px 0 0 0;">Ubicación: Av. Universidad #456, Torre A</p>
                    </div>
                    <span class="badge" style="background: rgba(2, 115, 94, 0.1); color: #02735E;">EN CURSO</span>
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                    <div>
                      <p style="font-size: 12px; color: #64748b; margin: 0;">Inicio</p>
                      <strong style="font-size: 14px;">10 Ene 2025</strong>
                    </div>
                    <div>
                      <p style="font-size: 12px; color: #64748b; margin: 0;">Estimado</p>
                      <strong style="font-size: 14px;">20 Ene 2025</strong>
                    </div>
                    <div>
                      <p style="font-size: 12px; color: #64748b; margin: 0;">Monto</p>
                      <strong style="font-size: 14px;">$12,500</strong>
                    </div>
                    <div>
                      <p style="font-size: 12px; color: #64748b; margin: 0;">Progreso</p>
                      <div style="background: #e0e0e0; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 4px;">
                        <div style="background: linear-gradient(135deg, #02735E, #035951); width: 65%; height: 100%;"></div>
                      </div>
                      <strong style="font-size: 12px;">65%</strong>
                    </div>
                  </div>
                </div>

                <!-- Project 2 -->
                <div style="border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <div>
                      <strong style="font-size: 16px;">Reparación Sistema Eléctrico</strong>
                      <p style="font-size: 13px; color: #64748b; margin: 6px 0 0 0;">Ubicación: Av. Universidad #456, Torre B</p>
                    </div>
                    <span class="badge" style="background: rgba(2, 115, 94, 0.1); color: #02735E;">EN CURSO</span>
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                    <div>
                      <p style="font-size: 12px; color: #64748b; margin: 0;">Inicio</p>
                      <strong style="font-size: 14px;">12 Ene 2025</strong>
                    </div>
                    <div>
                      <p style="font-size: 12px; color: #64748b; margin: 0;">Estimado</p>
                      <strong style="font-size: 14px;">18 Ene 2025</strong>
                    </div>
                    <div>
                      <p style="font-size: 12px; color: #64748b; margin: 0;">Monto</p>
                      <strong style="font-size: 14px;">$8,900</strong>
                    </div>
                    <div>
                      <p style="font-size: 12px; color: #64748b; margin: 0;">Progreso</p>
                      <div style="background: #e0e0e0; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 4px;">
                        <div style="background: linear-gradient(135deg, #02735E, #035951); width: 40%; height: 100%;"></div>
                      </div>
                      <strong style="font-size: 12px;">40%</strong>
                    </div>
                  </div>
                </div>

                <!-- Project 3 -->
                <div style="border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <div>
                      <strong style="font-size: 16px;">Mantenimiento Preventivo Anual</strong>
                      <p style="font-size: 13px; color: #64748b; margin: 6px 0 0 0;">Ubicación: Av. Universidad #456, Edificio Completo</p>
                    </div>
                    <span class="badge" style="background: rgba(2, 115, 94, 0.1); color: #02735E;">EN CURSO</span>
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                    <div>
                      <p style="font-size: 12px; color: #64748b; margin: 0;">Inicio</p>
                      <strong style="font-size: 14px;">01 Ene 2025</strong>
                    </div>
                    <div>
                      <p style="font-size: 12px; color: #64748b; margin: 0;">Estimado</p>
                      <strong style="font-size: 14px;">30 Ene 2025</strong>
                    </div>
                    <div>
                      <p style="font-size: 12px; color: #64748b; margin: 0;">Monto</p>
                      <strong style="font-size: 14px;">$24,000</strong>
                    </div>
                    <div>
                      <p style="font-size: 12px; color: #64748b; margin: 0;">Progreso</p>
                      <div style="background: #e0e0e0; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 4px;">
                        <div style="background: linear-gradient(135deg, #02735E, #035951); width: 55%; height: 100%;"></div>
                      </div>
                      <strong style="font-size: 12px;">55%</strong>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Additional Information -->
            <div class="grid grid-2" style="margin-top: 24px; gap: 20px;">
              <div class="card">
                <h3 class="card-title" style="margin-bottom: 16px;">Información de Contacto</h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                  <div>
                    <p style="font-size: 12px; color: #64748b; margin: 0;">Email Principal</p>
                    <strong>ops@torres.com</strong>
                  </div>
                  <div>
                    <p style="font-size: 12px; color: #64748b; margin: 0;">Teléfono</p>
                    <strong>+52 33 1234 5678</strong>
                  </div>
                  <div>
                    <p style="font-size: 12px; color: #64748b; margin: 0;">Dirección Principal</p>
                    <strong>Av. Universidad #456, Guadalajara, JAL</strong>
                  </div>
                  <div>
                    <p style="font-size: 12px; color: #64748b; margin: 0;">Cliente Desde</p>
                    <strong>Enero 2022</strong>
                  </div>
                </div>
              </div>

              <div class="card">
                <h3 class="card-title" style="margin-bottom: 16px;">Resumen Financiero</h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: #64748b;">Total Facturado</span>
                    <strong>$124,500</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: #64748b;">Pagado</span>
                    <strong style="color: #059669;">$79,100</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: #64748b;">Pendiente</span>
                    <strong style="color: #eab308;">$45,400</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 2px solid var(--border-color);">
                    <span style="font-weight: 600;">Promedio por Proyecto</span>
                    <strong style="color: #02735E;">$6,917</strong>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="page-management" class="page" aria-labelledby="management-title" hidden>
        <div class="page-header">
          <div>
            <h2 class="page-title" id="management-title" data-i18n="management">Management</h2>
            <p class="schedule-subtitle" data-i18n="managementSubtitle">Controla accesos, permisos y responsables del sistema Opsis.</p>
          </div>
          <button class="btn btn-primary" id="btn-new-manager" data-capability="management.manage">＋ <span data-i18n="managementAddUser">Nuevo administrador</span></button>
        </div>
        <div class="grid grid-3 kpi-grid" id="management-kpis">
          <div class="stat-card">
            <div class="stat-label" data-i18n="managementKpiAdmins">Admins activos</div>
            <div class="stat-value" id="management-kpi-admins">3</div>
            <div class="stat-change" id="management-kpi-admins-hint">Con roles críticos</div>
          </div>
          <div class="stat-card">
            <div class="stat-label" data-i18n="managementKpiInvites">Invitaciones pendientes</div>
            <div class="stat-value" id="management-kpi-invites">2</div>
            <div class="stat-change" id="management-kpi-invites-hint">2 Monitorea accesos aún no confirmados.</div>
          </div>
          <div class="stat-card">
            <div class="stat-label" data-i18n="managementKpiLastAudit">Último acceso</div>
            <div class="stat-value" id="management-kpi-lastaccess">16 jun, 07:20 a.m.</div>
            <div class="stat-change" id="management-kpi-lastaccess-hint">Última auditoría</div>
          </div>
        </div>
        <div class="management-toolbar">
          <input type="search" id="management-search" placeholder="Buscar administrador…" data-i18n-placeholder="managementSearchPlaceholder">
          <div style="display:flex; gap:10px; align-items:center;">
            <select id="management-role-filter">
              <option value="all" data-i18n="managementRoleAll">Todos los roles</option>
              <option value="owner">Owner</option>
              <option value="admin">Admin</option>
              <option value="tech">Tech</option>
            </select>
          </div>
        </div>
        <div class="management-layout">
          <div class="card management-users-card">
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th data-i18n="colName">Nombre</th>
                    <th data-i18n="colEmail">Email</th>
                    <th data-i18n="colRole">Rol</th>
                    <th data-i18n="managementStatus">Estado</th>
                    <th data-i18n="managementLastAccess">Último acceso</th>
                    <th>MFA</th>
                  </tr>
                </thead>
                <tbody id="management-tbody">
          <tr data-manager="USR-001" class="active">
            <td>Ana Owner</td>
            <td>ana@opsis.com</td>
            <td>owner</td>
            <td><span class="management-badge active">Activo</span></td>
            <td>16 jun, 07:20 a.m.</td>
            <td>✓</td>
          </tr>
          <tr data-manager="USR-002" class="">
            <td>Leo Admin</td>
            <td>leo@opsis.com</td>
            <td>admin</td>
            <td><span class="management-badge active">Activo</span></td>
            <td>15 jun, 11:45 a.m.</td>
            <td>✓</td>
          </tr>
          <tr data-manager="USR-004" class="">
            <td>Marco Tech</td>
            <td>marco@opsis.com</td>
            <td>tech</td>
            <td><span class="management-badge active">Activo</span></td>
            <td>12 jun, 01:30 a.m.</td>
            <td>—</td>
          </tr>
          <tr data-manager="USR-003" class="">
            <td>María Compliance</td>
            <td>compliance@opsis.com</td>
            <td>admin</td>
            <td><span class="management-badge away">Fuera</span></td>
            <td>10 jun, 04:05 a.m.</td>
            <td>—</td>
          </tr></tbody>
              </table>
            </div>
          </div>
          <div class="card management-detail-card" id="management-detail">
          <div class="management-detail-header">
            <div class="management-avatar">AO</div>
            <div>
              <h3>Ana Owner</h3>
              <small>ana@opsis.com</small>
            </div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px;">
            <span class="management-badge active">Activo</span>
            <span class="management-badge active">MFA activo</span>
          </div>
          <div class="management-detail-grid">
            <div>
              <span>Rol asignado</span>
              <strong>owner</strong>
            </div>
            <div>
              <span>Departamento</span>
              <strong>Dirección</strong>
            </div>
            <div>
              <span>Teléfono</span>
              <strong>+1 (858) 555-2010</strong>
            </div>
            <div>
              <span>Último acceso</span>
              <strong>16 jun, 07:20 a.m.</strong>
            </div>
          </div>
          <div class="settings-divider"></div>
          <div class="form-group">
            <label>Rol asignado</label>
            <select id="management-detail-role-select">
              <option value="owner" selected="">Owner</option><option value="admin">Admin</option><option value="tech">Tech</option><option value="labor">Labor</option><option value="client">Client</option><option value="contractor">Contractor</option>
            </select>
          </div>
          <div class="form-group">
            <label>Estado</label>
            <select id="management-detail-status-select">
              <option value="active" selected="">Activo</option><option value="away">Fuera</option><option value="disabled">Suspendido</option>
            </select>
          </div>
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="management-detail-mfa" checked="">
            Requerir MFA
          </label>
          <div class="management-detail-actions">
            <button class="btn btn-secondary" id="management-detail-save">Guardar cambios</button>
            <button class="btn btn-danger" id="management-detail-remove">Eliminar</button>
          </div></div>
        </div>
        <div class="management-lower">
          <div class="card management-invites-card">
            <div class="card-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
              <div>
                <h3 class="card-title" data-i18n="managementInvitesTitle">Invitaciones pendientes</h3>
                <p class="schedule-subtitle" data-i18n="managementInvitesSubtitle">Monitorea accesos aún no confirmados.</p>
              </div>
            </div>
            <form id="admin-invite-form" class="form-grid" style="margin-bottom:16px; gap:12px;" data-bound="true">
              <div class="form-group">
                <label>Nombre</label>
                <input type="text" id="admin-invite-name" required="">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="admin-invite-email" required="">
              </div>
              <div class="form-group">
                <label>Rol</label>
                <select id="admin-invite-role">
                  <option value="admin">Admin</option>
                  <option value="tech">Tech</option>
                  <option value="labor">Labor</option>
                </select>
              </div>
              <div class="form-group" style="grid-column:1 / -1; text-align:right;">
                <button type="submit" class="btn btn-primary">Generar invitación</button>
              </div>
            </form>
            <div id="management-invites-list" class="management-invite-list">
          <div class="management-invite-item" data-invite="INVITE-001">
            <div>
              <strong>Marta Ops · admin</strong>
              <small>marta@opsis.com</small>
              <small>Expira: 20 jun, 02:00 a.m.</small>
              <small>Contraseña temporal: <strong>Ops-12345</strong></small>
            </div>
            <div class="report-actions">
              <button class="btn btn-secondary btn-small" data-action="invite-copy">Copiar</button>
              <button class="btn btn-secondary btn-small" data-action="invite-reset">Nueva clave</button>
              <button class="btn btn-secondary btn-small" data-action="invite-resend">Reenviar</button>
              <button class="btn btn-secondary btn-small" data-action="invite-cancel">Cancelar</button>
            </div>
          </div>
          <div class="management-invite-item" data-invite="INVITE-002">
            <div>
              <strong>Jorge Finance · tech</strong>
              <small>jorge@opsis.com</small>
              <small>Expira: 19 jun, 09:30 a.m.</small>
              <small>Contraseña temporal: <strong>Ops-67890</strong></small>
            </div>
            <div class="report-actions">
              <button class="btn btn-secondary btn-small" data-action="invite-copy">Copiar</button>
              <button class="btn btn-secondary btn-small" data-action="invite-reset">Nueva clave</button>
              <button class="btn btn-secondary btn-small" data-action="invite-resend">Reenviar</button>
              <button class="btn btn-secondary btn-small" data-action="invite-cancel">Cancelar</button>
            </div>
          </div></div>
          </div>
          <div class="card management-activity-card">
            <div class="card-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
              <div>
                <h3 class="card-title" data-i18n="managementActivityTitle">Actividad reciente</h3>
                <p class="schedule-subtitle" data-i18n="managementActivitySubtitle">Auditoría y cambios críticos.</p>
              </div>
            </div>
            <div id="management-activity-list" class="management-activity-list">
          <div class="management-activity-item">
            <div>
              <strong>Cambio de rol</strong>
              <small>Ana Owner · Leo Admin</small>
            </div>
            <div style="text-align:right;">
              <span>14 jun, 10:20 a.m.</span>
              <small>Owner → Admin</small>
            </div>
          </div>
          <div class="management-activity-item">
            <div>
              <strong>Invitación enviada</strong>
              <small>Leo Admin · Marta Ops</small>
            </div>
            <div style="text-align:right;">
              <span>13 jun, 02:00 a.m.</span>
              <small>Invitación enviada</small>
            </div>
          </div>
          <div class="management-activity-item">
            <div>
              <strong>Actualización de seguridad</strong>
              <small>Ana Owner · Portal Opsis</small>
            </div>
            <div style="text-align:right;">
              <span>11 jun, 05:40 a.m.</span>
              <small>Reforzó MFA obligatorio</small>
            </div>
          </div></div>
          </div>
          <div class="card management-invites-card" data-capability="portal.invite" data-capability-display="">
            <div class="card-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
              <div>
                <h3 class="card-title">Invitaciones a portales</h3>
                <p class="schedule-subtitle">Invita técnicos, labor, clientes o contratistas.</p>
              </div>
            </div>
            <form id="portal-invite-form" class="form-grid" style="margin-bottom:16px; gap:12px;" data-bound="true">
              <div class="form-group">
                <label>Nombre contacto</label>
                <input type="text" id="portal-invite-name" required="">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="portal-invite-email" required="">
              </div>
              <div class="form-group">
                <label>Rol portal</label>
                <select id="portal-invite-role">
                  <option value="tech">Técnico</option>
                  <option value="labor">Labor</option>
                  <option value="client">Cliente</option>
                  <option value="contractor">Contratista</option>
                </select>
              </div>
              <div class="form-group">
                <label>Compañía / Proyecto</label>
                <input type="text" id="portal-invite-company" placeholder="Ej. Guzman &amp; Bros">
              </div>
              <div class="form-group" style="grid-column:1 / -1; text-align:right;">
                <button type="submit" class="btn btn-primary">Generar invitación</button>
              </div>
            </form>
            <div id="portal-invite-list"><div class="management-empty">Sin invitaciones aún</div></div>
          </div>
        </div>
      </section>

      <section id="page-roles" class="page" aria-labelledby="roles-title" hidden>
        <div class="page-header">
          <div>
            <h2 class="page-title" id="roles-title" data-i18n="roles">Roles y accesos</h2>
            <p class="schedule-subtitle" data-i18n="rolesSubtitle">Define permisos y mantén el control de seguridad.</p>
          </div>
          <button class="btn btn-primary" id="btn-role-add" data-capability="roles.manage" data-capability-display=""><span data-i18n="rolesAdd">Nuevo rol</span></button>
        </div>
        <div class="grid grid-3 kpi-grid role-dashboard" id="roles-kpi-grid">
          <div class="stat-card">
            <div class="stat-label" data-i18n="rolesKpiTotal">Roles definidos</div>
            <div class="stat-value" id="roles-kpi-total">6</div>
            <div class="stat-change" id="roles-kpi-total-hint">Distribuidos por área</div>
          </div>
          <div class="stat-card">
            <div class="stat-label" data-i18n="rolesKpiAdmins">Usuarios críticos</div>
            <div class="stat-value" id="roles-kpi-admins">3</div>
            <div class="stat-change" id="roles-kpi-admins-hint">Owners + Admins</div>
          </div>
          <div class="stat-card">
            <div class="stat-label" data-i18n="rolesKpiPermissions">Permisos activos</div>
            <div class="stat-value" id="roles-kpi-permissions">18</div>
            <div class="stat-change" id="roles-kpi-permissions-hint">Total del catálogo</div>
          </div>
        </div>
        <div class="role-toolbar">
          <input type="search" id="role-search" placeholder="Buscar rol…" data-i18n-placeholder="rolesSearchPlaceholder" data-bound="true">
          <div style="display:flex; gap:8px;">
            <button class="btn btn-secondary" id="btn-role-edit" data-capability="roles.manage" data-capability-display=""><span data-i18n="rolesEdit">Editar</span></button>
            <button class="btn btn-secondary" id="btn-role-duplicate" data-capability="roles.manage" data-capability-display=""><span data-i18n="rolesDuplicate">Duplicar</span></button>
          </div>
        </div>
        <div class="role-layout">
          <div class="card">
            <div class="role-list" id="role-list">
          <div class="role-item active" data-role="role-owner">
            <div>
              <strong>Owner</strong>
              <small>5 permisos</small>
            </div>
            <span class="management-badge active" style="background:#02735E; color:#fff;">owner</span>
          </div>
          <div class="role-item " data-role="role-admin">
            <div>
              <strong>Admin</strong>
              <small>4 permisos</small>
            </div>
            <span class="management-badge active" style="background:#035951; color:#fff;">admin</span>
          </div>
          <div class="role-item " data-role="role-tech">
            <div>
              <strong>Tech</strong>
              <small>3 permisos</small>
            </div>
            <span class="management-badge active" style="background:#034040; color:#fff;">tech</span>
          </div>
          <div class="role-item " data-role="role-labor">
            <div>
              <strong>Labor</strong>
              <small>3 permisos</small>
            </div>
            <span class="management-badge active" style="background:#035951; color:#fff;">labor</span>
          </div>
          <div class="role-item " data-role="role-client">
            <div>
              <strong>Client</strong>
              <small>3 permisos</small>
            </div>
            <span class="management-badge active" style="background:#022326; color:#fff;">client</span>
          </div>
          <div class="role-item " data-role="role-contractor">
            <div>
              <strong>Contractor</strong>
              <small>3 permisos</small>
            </div>
            <span class="management-badge active" style="background:#034040; color:#fff;">contractor</span>
          </div></div>
          </div>
          <div class="card" id="role-detail-card">
          <div class="card-header" style="padding:0 0 10px 0; border:none;">
            <div>
              <h3 class="card-title">Owner</h3>
              <p class="settings-note">Control total, auditoría y aprobaciones finales.</p>
            </div>
            <span class="management-badge active" style="background:#02735E; color:#fff;">1 Usuarios</span>
          </div>
          <div class="role-permissions">
            <div class="role-permission">Dashboard</div><div class="role-permission">Órdenes</div><div class="role-permission">Finanzas</div><div class="role-permission">Usuarios</div><div class="role-permission">Reportes</div>
          </div>
          <div class="settings-divider"></div>
          <div>
            <h4>Usuarios asignados</h4>
            <ul class="role-users-list">
              <li>Ana Owner (ana@opsis.com)</li>
            </ul>
          </div>
          <div class="settings-divider"></div>
          <div>
            <h4>Asignaciones rápidas</h4>
            <div class="role-permissions" id="role-assignment-grid">
                
                  <label class="role-permission" style="cursor:pointer;">
                    <input type="checkbox" data-role-assignment="USR-001" checked="">
                    Ana Owner (Owner)
                  </label>
                  <label class="role-permission" style="cursor:pointer;">
                    <input type="checkbox" data-role-assignment="USR-002">
                    Leo Admin (Admin)
                  </label>
                  <label class="role-permission" style="cursor:pointer;">
                    <input type="checkbox" data-role-assignment="USR-003">
                    María Compliance (Admin)
                  </label>
                  <label class="role-permission" style="cursor:pointer;">
                    <input type="checkbox" data-role-assignment="USR-004">
                    Marco Tech (Tech)
                  </label>
              </div>
          </div>
          <div class="form-group">
                  <label>Rol al desasignar</label>
                  <select id="role-assignment-fallback">
                    <option value="admin" selected="">Admin</option><option value="tech">Tech</option><option value="labor">Labor</option><option value="client">Client</option><option value="contractor">Contractor</option>
                  </select>
                </div>
          <div class="management-detail-actions">
            <button class="btn btn-secondary" id="role-assign-save">Actualizar</button>
            <button class="btn btn-secondary" id="role-assign-user">Agregar usuario</button>
          </div></div>
        </div>
      </section>

      <!-- External portals now live on standalone pages -->

      <section id="page-settings" class="page" aria-labelledby="settings-title" hidden>
        <div class="page-header">
          <h2 class="page-title" id="settings-title" data-i18n="settings">Configuración</h2>
        </div>
        <div class="grid grid-3 kpi-grid" id="settings-kpis">
          <div class="stat-card">
            <div class="stat-label" data-i18n="settingsKpiCompany">Compañía</div>
            <div class="stat-value" id="settings-kpi-company">CVE San Diego</div>
            <div class="stat-change" id="settings-kpi-company-hint">Nombre mostrado en Opsis</div>
          </div>
          <div class="stat-card">
            <div class="stat-label" data-i18n="settingsKpiTheme">Modo</div>
            <div class="stat-value" id="settings-kpi-theme">Claro</div>
            <div class="stat-change" id="settings-kpi-theme-hint">Modo actual</div>
          </div>
          <div class="stat-card">
            <div class="stat-label" data-i18n="settingsKpiLanguage">Idioma</div>
            <div class="stat-value" id="settings-kpi-language">Español</div>
            <div class="stat-change" id="settings-kpi-language-hint">UI predeterminado</div>
          </div>
        </div>
        <div class="settings-layout">
          <div class="card settings-card">
            <div class="card-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
              <div>
                <h3 class="card-title" data-i18n="settingsCompanyCard">Identidad y contacto</h3>
                <p class="settings-note" data-i18n="settingsCompanySubtitle">Nombre visible en app y datos básicos de contacto.</p>
              </div>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label data-i18n="companyName">Nombre de la empresa</label>
                <input type="text" id="settings-company">
              </div>
              <div class="form-group">
                <label data-i18n="phone">Teléfono</label>
                <input type="tel" id="settings-phone">
              </div>
              <div class="form-group">
                <label data-i18n="email">Email</label>
                <input type="email" id="settings-email">
              </div>
            </div>
            <div class="settings-actions">
              <button class="btn btn-secondary" id="btn-settings-save" data-capability="settings.write" data-i18n="settingsSaveButton" data-capability-display="">Guardar cambios</button>
            </div>
          </div>
          <div class="card settings-card">
            <div class="card-header">
              <div>
                <h3 class="card-title">Módulos Premium Activos</h3>
                <p class="settings-note">Módulos habilitados por tu plan. Contacta soporte para activar más.</p>
              </div>
            </div>
            <div class="grid grid-2" style="gap: 16px; margin-top: 16px;">
              <div class="module-card active">
                <div class="module-icon" style="background: #02735E;">MS</div>
                <div class="module-info">
                  <h4>MotorSync Base</h4>
                  <p>Sistema operacional completo</p>
                  <span class="module-status active">✓ Activo</span>
                </div>
              </div>
              <div class="module-card active">
                <div class="module-icon" style="background: #035951;">TS</div>
                <div class="module-info">
                  <h4>TimeSync</h4>
                  <p>Gestión de tiempo y asistencias</p>
                  <span class="module-status active">✓ Activo</span>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Total Proyectos</div>
                <div class="stat-value">24</div>
                <div class="stat-change">8 activos</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">En Curso</div>
                <div class="stat-value">8</div>
                <div class="stat-change positive">↑ 2 esta semana</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Completados</div>
                <div class="stat-value">12</div>
                <div class="stat-change">Este mes</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Programados</div>
                <div class="stat-value">4</div>
                <div class="stat-change">Siguiente semana</div>
              </div>
                  <p>Contabilidad y finanzas</p>
                  <span class="module-status">Disponible - Contacta soporte</span>
                </div>
              </div>
            </div>
          </div>

          <div class="card settings-card settings-brand-card">
            <div class="card-header">
              <div>
                <h3 class="card-title" data-i18n="settingsBrandingCard">Branding y apariencia</h3>
                <p class="settings-note" data-i18n="settingsBrandingSubtitle">Define tu logo, color corporativo y preferencias visuales.</p>
              </div>
            </div>
            <div class="form-grid">
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Logo de tu empresa</label>
                <div style="display: flex; align-items: center; gap: 16px; margin-top: 8px;">
                  <div id="logo-preview" style="width: 120px; height: 120px; border: 2px dashed rgba(2, 115, 94, 0.3); border-radius: 12px; display: flex; align-items: center; justify-content: center; background: rgba(2, 115, 94, 0.05); color: #02735E; font-size: 14px; font-weight: 600;">
                    Sin logo
                  </div>
                  <div style="flex: 1;">
                    <input type="file" id="logo-upload" accept="image/*" style="display: none;">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('logo-upload').click();">Subir logo</button>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">Recomendado: PNG o SVG, máximo 2MB</p>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label data-i18n="accentColor">Color de acento corporativo</label>
                <div style="display: flex; gap: 12px; align-items: center;">
                  <input type="color" id="accent-picker" value="#02735E" style="width: 60px; height: 40px; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer;">
                  <input type="text" id="accent-hex" value="#02735E" readonly style="flex: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card); font-family: monospace;">
                </div>
                <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">Se aplicará sobre la base VERDI</p>
              </div>
              <div class="form-group">
                <label data-i18n="uiTheme">Modo de interfaz</label>
                <select id="theme-select">
                  <option value="light" data-i18n="settingsThemeLight">Claro</option>
                  <option value="dark" data-i18n="settingsThemeDark">Oscuro</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="card settings-card settings-locale-card">
          <div class="card-header">
            <div>
              <h3 class="card-title" data-i18n="settingsLocalizationCard">Localización y datos</h3>
              <p class="settings-note" data-i18n="settingsLocalizationSubtitle">Controla el idioma y reinicia la data demo.</p>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label data-i18n="uiLanguage">Idioma del sistema</label>
              <select id="language-select">
                <option value="es">Español</option>
                <option value="en">English</option>
              </select>
            </div>
          </div>
          <div class="settings-divider"></div>
          <div>
            <label data-i18n="resetDemoTitle">Datos de demostración</label>
            <p class="settings-note" data-i18n="resetDemoHint">Borra y vuelve a cargar la información de ejemplo.</p>
            <button type="button" class="btn btn-secondary" id="btn-reset-demo" data-i18n="resetDemoButton">Reiniciar</button>
          </div>
        </div>
        <div class="card settings-card settings-notifications-card">
          <div class="card-header">
            <div>
              <h3 class="card-title" data-i18n="settingsNotificationsCard">Preferencias de notificaciones</h3>
              <p class="settings-note" data-i18n="settingsNotificationsSubtitle">Activa los canales (Email, SMS, In-App) para cada perfil del sistema.</p>
            </div>
            <button class="btn btn-secondary" id="btn-save-notifications" data-i18n="settingsNotificationsSave">Guardar preferencias</button>
          </div>
          <div class="table-wrapper" style="margin-top: 16px;">
            <table class="notification-preferences">
              <thead>
                <tr>
                  <th data-i18n="settingsNotificationsColumnRole">Perfil</th>
                  <th data-i18n="settingsNotificationsColumnEmail">Email</th>
                  <th data-i18n="settingsNotificationsColumnSms">SMS</th>
                  <th data-i18n="settingsNotificationsColumnInApp">In-App</th>
                </tr>
              </thead>
              <tbody id="notification-settings-table">
              </tbody>
            </table>
          </div>
          <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 12px;" data-i18n="settingsNotificationsFooter">
            Los cambios aplican para alertas operativas (MotorSync), asignaciones (TimeSync), logística (ToolSync) y facturación (FinanSync).
          </p>
        </div>
        <div class="card settings-card settings-role-access-card">
          <div class="card-header">
            <div>
              <h3 class="card-title" data-i18n="settingsRoleAccessCard">Accesos por rol</h3>
              <p class="settings-note" data-i18n="settingsRoleAccessSubtitle">Consulta qué áreas puede ver cada rol y quién puede enviar invitaciones.</p>
            </div>
          </div>
          <div class="table-wrapper" style="margin-top: 16px;">
            <table class="role-access-table">
              <thead>
                <tr>
                  <th data-i18n="settingsRoleAccessColumnRole">Rol</th>
                  <th data-i18n="settingsRoleAccessColumnPages">Áreas disponibles</th>
                  <th data-i18n="settingsRoleAccessColumnInvites">Puede invitar</th>
                </tr>
              </thead>
              <tbody id="role-access-table"></tbody>
            </table>
          </div>
          <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 12px;" data-i18n="settingsRoleAccessInviteHint">
            Owner y Admin pueden invitar técnicos, labor, clientes y contratistas para operar MotorSync.
          </p>
        </div>
      </section>

      <!-- NOTIFICATIONS PAGE -->
      <!-- DOCUMENTS PAGE -->
      <section id="page-analytics" class="page" aria-labelledby="analytics-title" hidden>
        <div class="page-header">
          <h2 class="page-title" id="analytics-title">Analytics & KPIs</h2>
          <div style="display: flex; gap: 8px;">
            <select class="btn btn-secondary" style="padding: 10px 16px;">
              <option>Últimos 7 días</option>
              <option>Últimos 30 días</option>
              <option>Últimos 90 días</option>
              <option>Este año</option>
            </select>
            <button class="btn btn-primary">Exportar Reporte</button>
          </div>
        </div>

        <!-- Main KPIs -->
        <div class="grid grid-4 kpi-grid">
          <div class="stat-card">
            <div class="stat-label">Ingresos del Mes</div>
            <div class="stat-value">$48,250</div>
            <div class="stat-change positive">↑ 18% vs mes anterior</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Trabajos Completados</div>
            <div class="stat-value">86</div>
            <div class="stat-change positive">↑ 12 vs semana pasada</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Clientes Nuevos</div>
            <div class="stat-value">14</div>
            <div class="stat-change positive">↑ 4 esta semana</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Satisfacción</div>
            <div class="stat-value">4.8/5</div>
            <div class="stat-change positive">↑ 0.2 puntos</div>
          </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="grid grid-2" style="margin-top: 24px; gap: 20px;">
          <div class="card">
            <h3 class="card-title" style="margin-bottom: 16px;">Ingresos por Semana</h3>
            <div style="background: linear-gradient(135deg, rgba(2, 115, 94, 0.05), rgba(3, 89, 81, 0.05)); border: 2px dashed rgba(2, 115, 94, 0.2); border-radius: 12px; padding: 80px; text-align: center;">
              <p style="color: var(--text-secondary); font-size: 16px; margin-bottom: 8px;">GRÁFICO DE INGRESOS</p>
              <p style="color: var(--text-secondary); font-size: 14px;">Integración con Chart.js próximamente</p>
            </div>
          </div>
          <div class="card">
            <h3 class="card-title" style="margin-bottom: 16px;">Distribución de Servicios</h3>
            <div style="background: linear-gradient(135deg, rgba(2, 115, 94, 0.05), rgba(3, 89, 81, 0.05)); border: 2px dashed rgba(2, 115, 94, 0.2); border-radius: 12px; padding: 80px; text-align: center;">
              <p style="color: var(--text-secondary); font-size: 16px; margin-bottom: 8px;">DISTRIBUCIÓN DE SERVICIOS</p>
              <p style="color: var(--text-secondary); font-size: 14px;">Integración con Chart.js próximamente</p>
            </div>
          </div>
        </div>

        <!-- Performance Metrics -->
        <div class="card" style="margin-top: 24px;">
          <h3 class="card-title" style="margin-bottom: 16px;">Métricas de Rendimiento</h3>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Métrica</th>
                  <th>Valor Actual</th>
                  <th>Objetivo</th>
                  <th>Progreso</th>
                  <th>Tendencia</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Tiempo Promedio de Respuesta</strong></td>
                  <td>42 minutos</td>
                  <td>45 minutos</td>
                  <td>
                    <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="background: linear-gradient(135deg, #02735E, #035951); width: 93%; height: 100%;"></div>
                    </div>
                  </td>
                  <td><span class="stat-change positive">↑ 3 min mejor</span></td>
                </tr>
                <tr>
                  <td><strong>Tasa de Completado en Primera Visita</strong></td>
                  <td>87%</td>
                  <td>90%</td>
                  <td>
                    <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="background: linear-gradient(135deg, #02735E, #035951); width: 87%; height: 100%;"></div>
                    </div>
                  </td>
                  <td><span class="stat-change positive">↑ 5%</span></td>
                </tr>
                <tr>
                  <td><strong>Utilización de Personal</strong></td>
                  <td>78%</td>
                  <td>85%</td>
                  <td>
                    <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="background: linear-gradient(135deg, #02735E, #035951); width: 78%; height: 100%;"></div>
                    </div>
                  </td>
                  <td><span class="stat-change">→ Sin cambio</span></td>
                </tr>
                <tr>
                  <td><strong>Tickets Promedio por Día</strong></td>
                  <td>12.4</td>
                  <td>15.0</td>
                  <td>
                    <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="background: linear-gradient(135deg, #02735E, #035951); width: 83%; height: 100%;"></div>
                    </div>
                  </td>
                  <td><span class="stat-change positive">↑ 1.2</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Top Performers -->
        <div class="grid grid-2" style="margin-top: 24px; gap: 20px;">
          <div class="card">
            <h3 class="card-title" style="margin-bottom: 16px;">Top 5 Técnicos - Este Mes</h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: linear-gradient(135deg, rgba(2, 115, 94, 0.08), rgba(3, 89, 81, 0.04)); border-radius: 8px;">
                <div>
                  <strong>Juan Martínez</strong>
                  <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">24 trabajos completados</p>
                </div>
                <div class="badge" style="background: #02735E; color: white;">#1 #1</div>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.02); border-radius: 8px;">
                <div>
                  <strong>Carlos Rodriguez</strong>
                  <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">21 trabajos completados</p>
                </div>
                <div class="badge" style="background: #035951; color: white;">#2 #2</div>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.02); border-radius: 8px;">
                <div>
                  <strong>Luis Hernández</strong>
                  <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">19 trabajos completados</p>
                </div>
                <div class="badge" style="background: #034040; color: white;">#3 #3</div>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.02); border-radius: 8px;">
                <div>
                  <strong>Miguel Sánchez</strong>
                  <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">17 trabajos completados</p>
                </div>
                <div class="badge">#4</div>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.02); border-radius: 8px;">
                <div>
                  <strong>Pedro García</strong>
                  <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">16 trabajos completados</p>
                </div>
                <div class="badge">#5</div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3 class="card-title" style="margin-bottom: 16px;">Clientes Más Frecuentes</h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: linear-gradient(135deg, rgba(2, 115, 94, 0.08), rgba(3, 89, 81, 0.04)); border-radius: 8px;">
                <div>
                  <strong>Residencial Torres</strong>
                  <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">8 servicios - $6,200 total</p>
                </div>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.02); border-radius: 8px;">
                <div>
                  <strong>Comercial Plaza</strong>
                  <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">6 servicios - $8,450 total</p>
                </div>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.02); border-radius: 8px;">
                <div>
                  <strong>Hotel Pacífico</strong>
                  <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">5 servicios - $12,100 total</p>
                </div>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.02); border-radius: 8px;">
                <div>
                  <strong>Oficinas del Centro</strong>
                  <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">5 servicios - $5,800 total</p>
                </div>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.02); border-radius: 8px;">
                <div>
                  <strong>Condominio Vista</strong>
                  <p style="font-size: 13px; color: var(--text-secondary); margin: 4px 0 0 0;">4 servicios - $4,350 total</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- TOOLSYNC - INVENTORY MANAGEMENT PAGE -->
      <section id="page-toolsync" class="page" aria-labelledby="toolsync-title" hidden>
        <div class="page-header">
          <div>
            <p class="dashboard-kicker" style="color: var(--text-secondary); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Sistema de Inventarios</p>
            <h2 class="page-title" id="toolsync-title">ToolSync - Gestión de Inventarios</h2>
          </div>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-secondary" onclick="alert('Exportar inventario')">Exportar</button>
            <button class="btn btn-secondary" onclick="alert('Escanear código de barras')">📷 Escanear</button>
            <button class="btn btn-primary" onclick="alert('Nuevo item')">+ Nuevo Item</button>
          </div>
        </div>

        <!-- Inventory Stats -->
        <div class="grid grid-4 kpi-grid">
          <div class="stat-card">
            <div class="stat-label">Total Items</div>
            <div class="stat-value">1,247</div>
            <div class="stat-change positive">↑ 28 este mes</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Valor Total</div>
            <div class="stat-value">$284,500</div>
            <div class="stat-change positive">↑ $12,400</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Stock Bajo</div>
            <div class="stat-value">23</div>
            <div class="stat-change negative">Requiere atención</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">En Tránsito</div>
            <div class="stat-value">45</div>
            <div class="stat-change">Llegada esta semana</div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card" style="margin-top: 24px;">
          <h3 class="card-title" style="margin-bottom: 16px;">Acciones Rápidas</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
            <button class="btn btn-secondary" style="padding: 16px; display: flex; align-items: center; gap: 8px; justify-content: center;">
              <span style="font-size: 1.5rem;">📦</span>
              <span>Recibir Orden</span>
            </button>
            <button class="btn btn-secondary" style="padding: 16px; display: flex; align-items: center; gap: 8px; justify-content: center;">
              <span style="font-size: 1.5rem;">🚚</span>
              <span>Transferir Stock</span>
            </button>
            <button class="btn btn-secondary" style="padding: 16px; display: flex; align-items: center; gap: 8px; justify-content: center;">
              <span style="font-size: 1.5rem;">📋</span>
              <span>Inventario Físico</span>
            </button>
            <button class="btn btn-secondary" style="padding: 16px; display: flex; align-items: center; gap: 8px; justify-content: center;">
              <span style="font-size: 1.5rem;">🔄</span>
              <span>Solicitar Reposición</span>
            </button>
            <button class="btn btn-secondary" style="padding: 16px; display: flex; align-items: center; gap: 8px; justify-content: center;">
              <span style="font-size: 1.5rem;">⚠️</span>
              <span>Ver Alertas</span>
            </button>
            <button class="btn btn-secondary" style="padding: 16px; display: flex; align-items: center; gap: 8px; justify-content: center;">
              <span style="font-size: 1.5rem;">📊</span>
              <span>Reporte de Uso</span>
            </button>
          </div>
        </div>

        <!-- Category Filters -->
        <div class="card" style="margin-top: 24px;">
          <h3 class="card-title" style="margin-bottom: 16px;">Categorías por Industria</h3>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="chip-filter active">Todas</button>
            <button class="chip-filter">Herramientas</button>
            <button class="chip-filter">Materiales</button>
            <button class="chip-filter">Equipos</button>
            <button class="chip-filter">Consumibles</button>
            <button class="chip-filter">Repuestos</button>
            <button class="chip-filter">EPP (Seguridad)</button>
            <button class="chip-filter">Vehículos</button>
            <button class="chip-filter">Tecnología</button>
          </div>
        </div>

        <!-- Filters & Search -->
        <div class="card" style="margin-top: 24px;">
          <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <input type="search" placeholder="🔍 Buscar por nombre, SKU, código de barras..." style="flex: 1; min-width: 300px; padding: 10px 16px; border: 1px solid var(--border-color); border-radius: 10px;">
            <select style="padding: 10px 16px; border: 1px solid var(--border-color); border-radius: 10px; background: white;">
              <option>Todas las ubicaciones</option>
              <option>Almacén Principal</option>
              <option>Almacén Norte</option>
              <option>Almacén Sur</option>
              <option>En Vehículos</option>
              <option>En Campo</option>
            </select>
            <select style="padding: 10px 16px; border: 1px solid var(--border-color); border-radius: 10px; background: white;">
              <option>Estado del stock</option>
              <option>✅ En Stock</option>
              <option>⚠️ Stock Bajo</option>
              <option>❌ Sin Stock</option>
              <option>🚚 En Tránsito</option>
            </select>
            <select style="padding: 10px 16px; border: 1px solid var(--border-color); border-radius: 10px; background: white;">
              <option>Ordenar por</option>
              <option>Nombre A-Z</option>
              <option>Stock (Mayor a Menor)</option>
              <option>Stock (Menor a Mayor)</option>
              <option>Valor (Mayor a Menor)</option>
              <option>Más Usados</option>
            </select>
          </div>
        </div>

        <!-- Inventory Table -->
        <div class="card" style="margin-top: 24px;">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Item</th>
                  <th>Categoría</th>
                  <th>Ubicación</th>
                  <th>Stock</th>
                  <th>Min/Max</th>
                  <th>Valor Unit.</th>
                  <th>Valor Total</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>TL-001</strong></td>
                  <td>
                    <strong>Taladro Inalámbrico DeWalt 20V</strong>
                    <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">Modelo: DCD771C2</p>
                  </td>
                  <td>Herramientas</td>
                  <td>Almacén Principal</td>
                  <td><strong style="font-size: 1.1rem;">24</strong></td>
                  <td>
                    <div style="font-size: 12px; color: #64748b;">
                      <span>Min: 10</span> | <span>Max: 30</span>
                    </div>
                  </td>
                  <td>$189.99</td>
                  <td><strong>$4,559.76</strong></td>
                  <td><span class="badge" style="background: rgba(2, 115, 94, 0.1); color: #02735E; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">✅ EN STOCK</span></td>
                  <td>
                    <div style="display: flex; gap: 4px;">
                      <button class="btn btn-small btn-secondary" title="Ver detalles">👁️</button>
                      <button class="btn btn-small btn-secondary" title="Editar">✏️</button>
                      <button class="btn btn-small btn-secondary" title="Mover">📦</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td><strong>MT-045</strong></td>
                  <td>
                    <strong>Tubería PVC 2" x 10ft</strong>
                    <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">Schedule 40</p>
                  </td>
                  <td>Materiales</td>
                  <td>Almacén Norte</td>
                  <td><strong style="font-size: 1.1rem; color: #ef4444;">8</strong></td>
                  <td>
                    <div style="font-size: 12px; color: #64748b;">
                      <span>Min: 20</span> | <span>Max: 100</span>
                    </div>
                  </td>
                  <td>$12.50</td>
                  <td><strong>$100.00</strong></td>
                  <td><span class="badge" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">⚠️ STOCK BAJO</span></td>
                  <td>
                    <div style="display: flex; gap: 4px;">
                      <button class="btn btn-small" style="background: #ef4444; color: white;" title="Solicitar reposición">🔄</button>
                      <button class="btn btn-small btn-secondary" title="Ver detalles">👁️</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td><strong>EQ-012</strong></td>
                  <td>
                    <strong>Compresor de Aire Industrial</strong>
                    <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">Marca: Ingersoll Rand 60 Gal</p>
                  </td>
                  <td>Equipos</td>
                  <td>En Campo - Obra #1024</td>
                  <td><strong style="font-size: 1.1rem;">3</strong></td>
                  <td>
                    <div style="font-size: 12px; color: #64748b;">
                      <span>Min: 2</span> | <span>Max: 5</span>
                    </div>
                  </td>
                  <td>$1,899.00</td>
                  <td><strong>$5,697.00</strong></td>
                  <td><span class="badge" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">🔧 EN USO</span></td>
                  <td>
                    <div style="display: flex; gap: 4px;">
                      <button class="btn btn-small btn-secondary" title="Ver ubicación">📍</button>
                      <button class="btn btn-small btn-secondary" title="Ver detalles">👁️</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td><strong>CN-089</strong></td>
                  <td>
                    <strong>Guantes de Seguridad (Par)</strong>
                    <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">Talla: M, L, XL - Mixto</p>
                  </td>
                  <td>Consumibles</td>
                  <td>Almacén Principal</td>
                  <td><strong style="font-size: 1.1rem;">450</strong></td>
                  <td>
                    <div style="font-size: 12px; color: #64748b;">
                      <span>Min: 200</span> | <span>Max: 500</span>
                    </div>
                  </td>
                  <td>$4.25</td>
                  <td><strong>$1,912.50</strong></td>
                  <td><span class="badge" style="background: rgba(2, 115, 94, 0.1); color: #02735E; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">✅ EN STOCK</span></td>
                  <td>
                    <div style="display: flex; gap: 4px;">
                      <button class="btn btn-small btn-secondary" title="Ver detalles">👁️</button>
                      <button class="btn btn-small btn-secondary" title="Asignar">👤</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td><strong>RP-234</strong></td>
                  <td>
                    <strong>Filtros HVAC 16x25x1</strong>
                    <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">MERV 11 - Pack de 12</p>
                  </td>
                  <td>Repuestos</td>
                  <td>En Tránsito</td>
                  <td><strong style="font-size: 1.1rem; color: #f59e0b;">0</strong></td>
                  <td>
                    <div style="font-size: 12px; color: #64748b;">
                      <span>Min: 24</span> | <span>Max: 100</span>
                    </div>
                  </td>
                  <td>$89.99</td>
                  <td><strong>$0.00</strong></td>
                  <td><span class="badge" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">🚚 EN TRÁNSITO</span></td>
                  <td>
                    <div style="display: flex; gap: 4px;">
                      <button class="btn btn-small btn-secondary" title="Ver orden">📋</button>
                      <button class="btn btn-small btn-secondary" title="Rastrear envío">📦</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td><strong>VH-003</strong></td>
                  <td>
                    <strong>Van Ford Transit 2023</strong>
                    <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">Placa: ABC-1234 | VIN: 1FTBW...</p>
                  </td>
                  <td>Vehículos</td>
                  <td>Flota - Activo</td>
                  <td><strong style="font-size: 1.1rem;">1</strong></td>
                  <td>
                    <div style="font-size: 12px; color: #64748b;">
                      <span>Asignado: Juan Pérez</span>
                    </div>
                  </td>
                  <td>$45,000.00</td>
                  <td><strong>$45,000.00</strong></td>
                  <td><span class="badge" style="background: rgba(2, 115, 94, 0.1); color: #02735E; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">🚗 OPERATIVO</span></td>
                  <td>
                    <div style="display: flex; gap: 4px;">
                      <button class="btn btn-small btn-secondary" title="Ver GPS">📍</button>
                      <button class="btn btn-small btn-secondary" title="Mantenimiento">🔧</button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Warehouse Map & Stock Levels -->
        <div class="grid grid-2" style="margin-top: 24px; gap: 20px;">
          <div class="card">
            <h3 class="card-title" style="margin-bottom: 16px;">Mapa de Almacenes</h3>
            <div style="background: linear-gradient(135deg, rgba(2, 115, 94, 0.05), rgba(3, 89, 81, 0.05)); border: 2px dashed rgba(2, 115, 94, 0.2); border-radius: 12px; padding: 60px; text-align: center;">
              <p style="color: var(--text-secondary); font-size: 16px; margin-bottom: 8px;">MAPA DE UBICACIONES</p>
              <p style="color: var(--text-secondary); font-size: 14px;">Visualización de almacenes y stock por ubicación</p>
            </div>
            <div style="margin-top: 16px; display: flex; flex-direction: column; gap: 8px;">
              <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 6px;">
                <span style="font-weight: 600;">Almacén Principal</span>
                <span style="color: #02735E;">847 items</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 6px;">
                <span style="font-weight: 600;">Almacén Norte</span>
                <span style="color: #02735E;">234 items</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 6px;">
                <span style="font-weight: 600;">Almacén Sur</span>
                <span style="color: #02735E;">121 items</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 6px;">
                <span style="font-weight: 600;">En Vehículos</span>
                <span style="color: #3b82f6;">45 items</span>
              </div>
            </div>
          </div>

          <div class="card">
            <h3 class="card-title" style="margin-bottom: 16px;">Alertas de Stock</h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div style="padding: 12px; background: rgba(239, 68, 68, 0.05); border-left: 4px solid #ef4444; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div>
                    <p style="font-weight: 600; color: #ef4444;">⚠️ Stock Crítico</p>
                    <p style="font-size: 14px; color: #64748b; margin-top: 4px;">Tubería PVC 2" - Solo quedan 8 unidades</p>
                  </div>
                  <button class="btn btn-small" style="background: #ef4444; color: white;">Reponer</button>
                </div>
              </div>
              <div style="padding: 12px; background: rgba(245, 158, 11, 0.05); border-left: 4px solid #f59e0b; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div>
                    <p style="font-weight: 600; color: #f59e0b;">📦 Orden en Tránsito</p>
                    <p style="font-size: 14px; color: #64748b; margin-top: 4px;">Filtros HVAC - Llegada estimada: 19 Nov</p>
                  </div>
                  <button class="btn btn-small btn-secondary">Rastrear</button>
                </div>
              </div>
              <div style="padding: 12px; background: rgba(59, 130, 246, 0.05); border-left: 4px solid #3b82f6; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div>
                    <p style="font-weight: 600; color: #3b82f6;">ℹ️ Próximo a Vencer</p>
                    <p style="font-size: 14px; color: #64748b; margin-top: 4px;">Certificación de extintores - Vence: 25 Nov</p>
                  </div>
                  <button class="btn btn-small btn-secondary">Ver</button>
                </div>
              </div>
              <div style="padding: 12px; background: rgba(2, 115, 94, 0.05); border-left: 4px solid #02735E; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div>
                    <p style="font-weight: 600; color: #02735E;">✅ Inventario Completado</p>
                    <p style="font-size: 14px; color: #64748b; margin-top: 4px;">Almacén Principal - 100% auditado</p>
                  </div>
                  <button class="btn btn-small btn-secondary">Reporte</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="card" style="margin-top: 24px;">
          <h3 class="card-title" style="margin-bottom: 16px;">Actividad Reciente</h3>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Fecha/Hora</th>
                  <th>Usuario</th>
                  <th>Acción</th>
                  <th>Item</th>
                  <th>Cantidad</th>
                  <th>Ubicación</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>16 Ene 2025 14:23</td>
                  <td><strong>Juan Pérez</strong></td>
                  <td><span class="badge" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">Retirado</span></td>
                  <td>Taladro Inalámbrico DeWalt</td>
                  <td>2</td>
                  <td>Almacén Principal → Obra #1024</td>
                </tr>
                <tr>
                  <td>16 Ene 2025 11:45</td>
                  <td><strong>María González</strong></td>
                  <td><span class="badge" style="background: rgba(2, 115, 94, 0.1); color: #02735E;">Recibido</span></td>
                  <td>Guantes de Seguridad</td>
                  <td>100</td>
                  <td>Almacén Principal</td>
                </tr>
                <tr>
                  <td>16 Ene 2025 09:12</td>
                  <td><strong>Carlos Ruiz</strong></td>
                  <td><span class="badge" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">Transferido</span></td>
                  <td>Tubería PVC 2"</td>
                  <td>50</td>
                  <td>Almacén Principal → Almacén Norte</td>
                </tr>
                <tr>
                  <td>15 Ene 2025 16:30</td>
                  <td><strong>Ana López</strong></td>
                  <td><span class="badge" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">Devuelto</span></td>
                  <td>Compresor de Aire</td>
                  <td>1</td>
                  <td>Obra #1022 → Almacén Principal</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

    </main>

    <!-- Project Chat Modal (Basecamp-style) -->
    <div id="project-chat-modal" style="display: none; position: fixed; top: 0; right: -400px; width: 400px; height: 100vh; background: white; box-shadow: -2px 0 16px rgba(0,0,0,0.15); transition: right 0.3s ease; z-index: 1000; overflow-y: auto;">
      <div style="position: sticky; top: 0; background: white; border-bottom: 1px solid #e0e0e0; padding: 20px; z-index: 10;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <h3 id="chat-project-name" style="margin: 0; color: #334155; font-size: 18px; font-weight: 600;">Proyecto</h3>
          <button onclick="closeProjectChat()" style="background: none; border: none; cursor: pointer; color: #64748b; font-size: 24px; line-height: 1; padding: 0; width: 32px; height: 32px;">&times;</button>
        </div>
        <p id="chat-project-id" style="margin: 0; color: #64748b; font-size: 14px;">ID: #0000</p>
      </div>

      <!-- Participants -->
      <div style="padding: 16px 20px; background: #f8fafc; border-bottom: 1px solid #e0e0e0;">
        <p style="margin: 0 0 8px 0; color: #475569; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Participantes</p>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <div style="display: flex; align-items: center; gap: 6px; background: white; padding: 6px 12px; border-radius: 16px; border: 1px solid #e0e0e0;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: #02735E; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600;">JR</div>
            <span style="color: #334155; font-size: 13px;">Juan Rodríguez</span>
            <span style="color: #64748b; font-size: 11px;">(Owner)</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px; background: white; padding: 6px 12px; border-radius: 16px; border: 1px solid #e0e0e0;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: #035951; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600;">ML</div>
            <span style="color: #334155; font-size: 13px;">María López</span>
            <span style="color: #64748b; font-size: 11px;">(Admin)</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px; background: white; padding: 6px 12px; border-radius: 16px; border: 1px solid #e0e0e0;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: #64748b; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600;">CS</div>
            <span style="color: #334155; font-size: 13px;">Carlos Sánchez</span>
            <span style="color: #64748b; font-size: 11px;">(Tech)</span>
          </div>
        </div>
      </div>

      <!-- Messages Thread -->
      <div id="chat-messages" style="padding: 20px; min-height: 300px;">
        <!-- Messages will be inserted here dynamically -->
      </div>

      <!-- Message Input -->
      <div style="position: sticky; bottom: 0; background: white; border-top: 1px solid #e0e0e0; padding: 16px 20px;">
        <div style="display: flex; gap: 8px;">
          <textarea id="chat-input" placeholder="Escribe un mensaje..." style="flex: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit; font-size: 14px; resize: none; min-height: 44px; max-height: 120px;" rows="1"></textarea>
          <button onclick="sendChatMessage()" style="background: #02735E; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;">Enviar</button>
        </div>
      </div>
    </div>

    <!-- Chat Overlay -->
    <div id="chat-overlay" onclick="closeProjectChat()" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 999;"></div>

  </div>

  <!-- Modal genérico para formularios -->
  <div class="modal" id="modal-form" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 id="modal-title"></h3>
        <button class="btn btn-secondary" id="modal-close" aria-label="Cerrar">✕</button>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>

  <!-- Document Upload Modal -->
  <div class="modal" id="document-upload-modal" style="display: none;">
    <div class="modal-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Subir Documento</h3>
        <button class="btn btn-secondary" onclick="document.getElementById('document-upload-modal').style.display='none'">✕</button>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>Nombre del Documento</label>
          <input type="text" id="doc-name" placeholder="Ej: Contrato de Servicio 2024">
        </div>
        <div class="form-group">
          <label>Categoría</label>
          <select id="doc-category">
            <option value="contracts">Contratos</option>
            <option value="templates">Plantillas</option>
            <option value="policies">Políticas</option>
            <option value="procedures">Procedimientos</option>
            <option value="certifications">Certificaciones</option>
            <option value="other">Otros</option>
          </select>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label>Archivo</label>
          <input type="file" id="doc-file" accept=".pdf,.doc,.docx,.xls,.xlsx">
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label>Descripción (Opcional)</label>
          <textarea id="doc-description" rows="3" placeholder="Breve descripción del documento"></textarea>
        </div>
      </div>
      <div style="display: flex; gap: 12px; margin-top: 20px;">
        <button class="btn btn-primary" onclick="alert('Documento subido exitosamente'); document.getElementById('document-upload-modal').style.display='none'">Subir Documento</button>
        <button class="btn btn-secondary" onclick="document.getElementById('document-upload-modal').style.display='none'">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Territory Modal -->
  <div class="modal" id="territory-modal" style="display: none;">
    <div class="modal-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Agregar Territorio</h3>
        <button class="btn btn-secondary" onclick="document.getElementById('territory-modal').style.display='none'">✕</button>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>Nombre del Territorio</label>
          <input type="text" id="terr-name" placeholder="Ej: Zona Centro - San Diego">
        </div>
        <div class="form-group">
          <label>Ciudad Principal</label>
          <input type="text" id="terr-city" placeholder="Ej: San Diego">
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label>Descripción</label>
          <input type="text" id="terr-desc" placeholder="Ej: Downtown y áreas circundantes">
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label>Códigos Postales (separados por comas)</label>
          <input type="text" id="terr-zips" placeholder="92101, 92102, 92103, 92104">
        </div>
        <div class="form-group">
          <label>Radio de Cobertura (km)</label>
          <input type="number" id="terr-radius" placeholder="15">
        </div>
        <div class="form-group">
          <label>Tarifa de Viaje</label>
          <input type="number" id="terr-fee" placeholder="0">
        </div>
      </div>
      <div style="display: flex; gap: 12px; margin-top: 20px;">
        <button class="btn btn-primary" onclick="alert('Territorio creado exitosamente'); document.getElementById('territory-modal').style.display='none'">Crear Territorio</button>
        <button class="btn btn-secondary" onclick="document.getElementById('territory-modal').style.display='none'">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEYS = {
      orders: 'opsis_orders',
      quotes: 'opsis_quotes',
      invoices: 'opsis_invoices',
      customers: 'opsis_customers',
      staff: 'opsis_staff',
      inventory: 'opsis_inventory',
      services: 'opsis_services',
      certifications: 'opsis_certifications',
      settings: 'opsis_settings',
      role: 'opsis_role',
      users: 'opsis_users',
      rolesMatrix: 'opsis_roles',
      reportDatasetDefaults: 'opsis_report_dataset_defaults',
      reportTemplates: 'opsis_report_templates',
      reportHistory: 'opsis_report_history',
      reportSchedules: 'opsis_report_schedules',
      fleet: 'opsis_fleet',
      purchaseSuppliers: 'opsis_purchase_suppliers',
      purchaseProducts: 'opsis_purchase_products',
      purchaseOrders: 'opsis_purchase_orders',
      adminInvites: 'opsis_admin_invites',
      adminActivity: 'opsis_admin_activity',
      portalRequests: 'opsis_portal_requests',
      portalInvites: 'opsis_portal_invites',
      projectIds: 'opsis_project_idsync',
      notificationPrefs: 'opsis_notification_prefs',
    };

    const storage = {
      get(key, fallback = null) {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : fallback;
        } catch {
          return fallback;
        }
      },
      set(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (err) {
          console.error('Storage set error', err);
        }
      },
      remove(key) {
        localStorage.removeItem(key);
      },
      clearAll() {
        Object.values(STORAGE_KEYS).forEach((key) => localStorage.removeItem(key));
      },
    };

    const DEFAULT_NOTIFICATION_PREFS = {
      owner: { email: true, sms: true, inApp: true },
      admin: { email: true, sms: false, inApp: true },
      tech: { email: false, sms: true, inApp: true },
      labor: { email: false, sms: true, inApp: true },
      client: { email: true, sms: false, inApp: true },
      contractor: { email: true, sms: false, inApp: true },
    };

    const idSyncManager = (() => {
      const map = storage.get(STORAGE_KEYS.projectIds, {}) || {};
      const registry = new Set(Object.values(map));
      const persist = () => storage.set(STORAGE_KEYS.projectIds, map);
      const isPreset = (value) => typeof value === 'string' && /^\d{8}$/.test(value);

      return {
        ensure(key, preset) {
          if (!key) return null;
          if (isPreset(preset)) {
            map[key] = preset;
            registry.add(preset);
            persist();
            return preset;
          }
          if (map[key]) return map[key];
          let candidate;
          do {
            candidate = (Math.floor(10000000 + Math.random() * 90000000)).toString();
          } while (registry.has(candidate));
          map[key] = candidate;
          registry.add(candidate);
          persist();
          return candidate;
        },
        get(key) {
          return map[key] || null;
        },
        format(value) {
          return value ? `IDSync ${value}` : 'IDSync —';
        },
        snapshot() {
          return { ...map };
        },
      };
    })();

    const ROLE_ACCESS = {
      owner: {
        pages: ['dashboard', 'motorsync', 'customers', 'management', 'toolsync', 'roles', 'settings'],
        defaultPage: 'dashboard',
        capabilities: ['*'],
      },
      admin: {
        pages: ['dashboard', 'motorsync', 'customers', 'management', 'toolsync'],
        defaultPage: 'dashboard',
        capabilities: [
          'orders.manage',
          'quotes.manage',
          'customers.manage',
          'inventory.manage',
          'inventory.purchase',
          'inventory.export',
          'fleet.manage',
          'reports.view',
          'reports.download',
          'reports.build',
          'reports.schedule',
          'staff.manage',
          'management.manage',
          'roles.manage',
          'portal.invite',
          'client.request',
          'contractor.request',
          'finance.view',
        ],
      },
      tech: {
        pages: ['dashboard', 'motorsync'],
        defaultPage: 'dashboard',
        capabilities: ['schedule.view', 'orders.view', 'orders.update'],
      },
      labor: {
        pages: ['dashboard', 'motorsync'],
        defaultPage: 'dashboard',
        capabilities: ['schedule.view'],
      },
      client: {
        pages: ['client'],
        defaultPage: 'client',
        capabilities: ['client.view', 'client.request'],
      },
      contractor: {
        pages: ['contractor'],
        defaultPage: 'contractor',
        capabilities: ['contractor.view', 'contractor.request'],
      },
    };

    const app = {
      currentPage: 'dashboard',
      map: null,
      mapMarkers: [],
      currentMapFilter: 'active',
      mapFiltersBound: false,
      currentLanguage: 'es',
      currentTheme: 'light',
      currentAccent: '#02735E',
      currentRole: 'owner',
      scheduleRange: 'week',
      scheduleMode: 'cards',
      selectedOrderId: null,
      orders: [],
      ordersStatusFilter: 'all',
      ordersSearch: '',
      selectedCustomerId: null,
      selectedCustomerAddress: null,
      customersSearch: '',
      customersFilter: 'all',
      customers: [],
      billingSearch: '',
      staffRecords: [],
      staffFilter: 'all',
      staffSearch: '',
      selectedStaffId: null,
      quotes: [],
      invoices: [],
      inventory: [],
      portalRequests: [],
      inventoryFilter: 'all',
      inventoryView: 'cards',
      inventorySearch: '',
      fleet: [],
      reportsCategory: 'overview',
      reportsRange: 'week',
      managementSearch: '',
      managementRoleFilter: 'all',
      selectedManagerId: null,
      reportTemplates: [],
      reportHistory: [],
      reportSchedules: [],
      reportDatasetDefaults: {},
      purchaseSuppliers: [],
      purchaseProducts: [],
      purchaseOrders: [],
      users: [],
      adminInvites: [],
      adminActivity: [],
      portalInvites: [],
      selectedRoleId: null,
      serviceCatalog: [],
      certificationsCatalog: [],
      notificationPrefs: {},
      DEFAULT_SETTINGS: {
        companyName: 'CVE San Diego',
        phone: '+1 (858) 555-2010',
        email: 'dispatch@opsis.com',
        palette: 'blue',
        language: 'es',
        theme: 'light',
        accent: '#02735E',
      },
      settings: {},
      DEFAULT_CERTIFICATIONS: [
        'C-36 Plumbing Contractor License',
        'OSHA 10',
        'OSHA 30',
        'EPA Lead-Safe',
        'Backflow Tester',
        'CSLB Pocket Card',
      ],
      inventoryCategories: [
        { id: 'materials', labelKey: 'inventoryCategoryMaterials' },
        { id: 'equipment', labelKey: 'inventoryCategoryEquipment' },
        { id: 'kits', labelKey: 'inventoryCategoryKits' },
        { id: 'consumables', labelKey: 'inventoryCategoryConsumables' },
        { id: 'safety', labelKey: 'inventoryCategorySafety' },
      ],
      INVENTORY_STATUS: {
        ok: { labelKey: 'inventoryStatusOk', className: 'ok' },
        low: { labelKey: 'inventoryStatusLow', className: 'low' },
        critical: { labelKey: 'inventoryStatusCritical', className: 'critical' },
      },
      REPORT_DATASETS: [
        {
          id: 'orders',
          labelKey: 'orders',
          groupOptions: [
            { id: 'customer', label: 'Cliente' },
            { id: 'status', label: 'Estado' },
            { id: 'priority', label: 'Prioridad' },
          ],
          columns: [
            { id: 'id', label: 'ID' },
            { id: 'customer', label: 'Cliente' },
            { id: 'service', label: 'Servicio' },
            { id: 'status', label: 'Estado' },
            { id: 'priority', label: 'Prioridad' },
            { id: 'total', label: 'Total' },
            { id: 'date', label: 'Fecha' },
          ],
          defaultColumns: ['id', 'customer', 'service', 'status', 'total'],
        },
        {
          id: 'inventory',
          labelKey: 'inventory',
          groupOptions: [
            { id: 'vendor', label: 'Proveedor' },
            { id: 'status', label: 'Estado' },
            { id: 'category', label: 'Categoría' },
          ],
          columns: [
            { id: 'name', label: 'Material' },
            { id: 'sku', label: 'SKU' },
            { id: 'qty', label: 'Cantidad' },
            { id: 'reorderPoint', label: 'Reorden' },
            { id: 'vendor', label: 'Proveedor' },
            { id: 'status', label: 'Estado' },
            { id: 'cost', label: 'Costo' },
          ],
          defaultColumns: ['name', 'sku', 'qty', 'reorderPoint', 'vendor', 'status'],
        },
        {
          id: 'staff',
          labelKey: 'staff',
          groupOptions: [
            { id: 'category', label: 'Tipo' },
            { id: 'status', label: 'Estado' },
            { id: 'specialization', label: 'Especialidad' },
          ],
          columns: [
            { id: 'name', label: 'Nombre' },
            { id: 'role', label: 'Rol' },
            { id: 'category', label: 'Tipo' },
            { id: 'status', label: 'Estado' },
            { id: 'hoursWeek', label: 'Horas semana' },
            { id: 'location', label: 'Ubicación' },
          ],
          defaultColumns: ['name', 'role', 'category', 'status', 'hoursWeek'],
        },
        {
          id: 'purchaseOrders',
          labelKey: 'poTitle',
          groupOptions: [
            { id: 'vendorName', label: 'Proveedor' },
            { id: 'status', label: 'Estado' },
          ],
          columns: [
            { id: 'id', label: 'ID' },
            { id: 'vendorName', label: 'Proveedor' },
            { id: 'jobNumber', label: 'Job' },
            { id: 'status', label: 'Estado' },
            { id: 'total', label: 'Total' },
            { id: 'date', label: 'Fecha' },
          ],
          defaultColumns: ['id', 'vendorName', 'status', 'total', 'date'],
        },
      ],
      DEFAULT_SERVICE_LIBRARY: [
        {
          id: 'install',
          label: 'Instalación',
          scope: 'Montaje completo, pruebas de presión y entrega con checklist.',
          descriptionHint: 'Describe qué debe instalarse, niveles, línea y accesorios críticos.',
          tasks: ['Inspección previa del sitio', 'Instalación y calibración', 'Prueba y documentación'],
          window: 'morning',
          technicians: ['Marco Tech'],
          labor: ['Luis', 'Iván'],
          crew: ['Marco Tech', 'Luis', 'Iván'],
        },
        {
          id: 'maintenance',
          label: 'Mantenimiento',
          scope: 'Rutina preventiva con bitácora y fotos comparativas.',
          descriptionHint: 'Incluye equipos, frecuencia y hallazgos previos.',
          tasks: ['Checklist preventivo', 'Reemplazo de consumibles', 'Reporte digital'],
          window: 'midday',
          technicians: ['Sara Field'],
          labor: ['Paul'],
          crew: ['Sara Field', 'Paul'],
        },
        {
          id: 'inspection',
          label: 'Inspección',
          scope: 'Diagnóstico y recomendaciones con estimado preliminar.',
          descriptionHint: 'Incluye síntomas, áreas críticas y acceso.',
          tasks: ['Levantamiento fotográfico', 'Pruebas de presión', 'Informe detallado'],
          window: 'afternoon',
          technicians: ['Leo Admin'],
          labor: [],
          crew: ['Leo Admin'],
        },
        {
          id: 'emergency',
          label: 'Emergencia',
          scope: 'Atención inmediata, contención y plan de corrección.',
          descriptionHint: 'Describe impacto, zonas afectadas y corte de agua disponible.',
          tasks: ['Evaluación rápida', 'Contención temporal', 'Reporte a cliente'],
          window: 'anytime',
          technicians: ['Marco Tech', 'Sara Field'],
          labor: ['Luis'],
          crew: ['Marco Tech', 'Sara Field', 'Luis'],
        },
        {
          id: 'remodel',
          label: 'Remodelación / Proyecto',
          scope: 'Coordinación con GC, fases y entregables.',
          descriptionHint: 'Indica alcance arquitectónico, fechas clave y subcontratos.',
          tasks: ['Reunión inicial', 'Coordinación con GC', 'Entrega y cierre'],
          window: 'custom',
          technicians: ['Ana Owner', 'Marco Tech'],
          labor: ['Luis'],
          crew: ['Ana Owner', 'Marco Tech', 'Luis'],
        },
      ],
      SERVICE_LIBRARY: [],
      WINDOW_OPTIONS: [
        { id: 'morning', label: '08:00 - 11:00' },
        { id: 'midday', label: '11:00 - 14:00' },
        { id: 'afternoon', label: '14:00 - 18:00' },
        { id: 'evening', label: '18:00 - 21:00' },
        { id: 'anytime', label: 'Disponibilidad completa' },
        { id: 'custom', label: 'Personalizado' },
      ],
      ORDER_STATES: {
        draft: { label: 'Draft' },
        scheduled: { label: 'Scheduled' },
        en_route: { label: 'En Route' },
        on_site: { label: 'On Site' },
        job_done: { label: 'Job Done' },
        invoiced: { label: 'Invoiced' },
        paid: { label: 'Paid' },
        archived: { label: 'Archived' },
      },
      PRIORITY_CONFIG: {
        high: { label: 'High' },
        normal: { label: 'Normal' },
        low: { label: 'Low' },
        future: { label: 'Future' },
      },
      rolesMatrix: [
        {
          id: 'role-owner',
          role: 'owner',
          color: '#02735E',
          description: 'Control total, auditoría y aprobaciones finales.',
          permissions: ['Dashboard', 'Órdenes', 'Finanzas', 'Usuarios', 'Reportes'],
        },
        {
          id: 'role-admin',
          role: 'admin',
          color: '#02735E',
          description: 'Opera agenda, inventario y reportes diarios.',
          permissions: ['Dashboard', 'Órdenes', 'Reportes', 'Inventario'],
        },
        {
          id: 'role-tech',
          role: 'tech',
          color: '#f59e0b',
          description: 'Acceso móvil a órdenes asignadas.',
          permissions: ['Órdenes asignadas', 'Captura de materiales', 'Fotos'],
        },
        {
          id: 'role-labor',
          role: 'labor',
          color: '#035951',
          description: 'Checklist y soporte en campo.',
          permissions: ['Itinerario', 'Direcciones', 'Checklist de apoyo'],
        },
        {
          id: 'role-client',
          role: 'client',
          color: '#022326',
          description: 'Portal externo para seguimiento y pagos.',
          permissions: ['Seguimiento', 'Cotizaciones', 'Pagos'],
        },
        {
          id: 'role-contractor',
          role: 'contractor',
          color: '#034040',
          description: 'Contratistas invitados para proyectos grandes.',
          permissions: ['Múltiples direcciones', 'Reportes resumidos', 'Solicitudes especiales'],
        },
      ],
      translations: {
        es: {
          dashboard: 'Dashboard',
          schedule: 'Agenda',
          orders: 'Órdenes',
          quotes: 'Cotizaciones',
          invoices: 'Facturas',
          quotesInvoices: 'Cotizaciones / Facturas',
          customers: 'Clientes',
          inventory: 'Inventario',
          inventorySubtitle: 'Control total de materiales, equipos y consumibles.',
          inventoryExport: 'Exportar',
          inventoryKpiSkus: 'SKU activos',
          inventoryKpiSkusHint: 'Registrados en Opsis',
          inventoryKpiLow: 'Stock bajo',
          inventoryKpiLowHint: 'Necesitan reorden',
          inventoryKpiValue: 'Valor estimado',
          inventoryKpiValueHint: 'Basado en costo unitario',
          inventoryFilterAll: 'Todo',
          inventoryFilterMaterials: 'Materiales',
          inventoryFilterEquipment: 'Equipos',
          inventoryFilterKits: 'Kits',
          inventoryFilterConsumables: 'Consumibles',
          inventoryFilterSafety: 'Seguridad',
          inventoryCategoryMaterials: 'Materiales',
          inventoryCategoryEquipment: 'Equipos',
          inventoryCategoryKits: 'Kits de servicio',
          inventoryCategoryConsumables: 'Consumibles',
          inventoryCategorySafety: 'Seguridad',
          inventoryViewCards: 'Tarjetas',
          inventoryViewTable: 'Tabla',
          inventorySearchPlaceholder: 'Buscar por nombre, SKU o proveedor…',
          inventoryStatusOk: 'Estable',
          inventoryStatusLow: 'Bajo',
          inventoryStatusCritical: 'Crítico',
          inventoryLocation: 'Ubicación',
          inventoryVendor: 'Proveedor',
          inventoryReorder: 'Reorden',
          inventoryUnit: 'Unidad',
          inventoryLastRestock: 'Último abastecimiento',
          inventoryCost: 'Costo unitario',
          inventoryValue: 'Valor inventario',
          inventoryEmpty: 'No hay materiales en este filtro.',
          inventoryDeleteConfirm: '¿Eliminar este material del inventario?',
          inventoryReportTitle: 'Reporte de inventario',
          inventoryReportLow: 'Materiales con stock bajo',
          inventoryReportValue: 'Valor total del inventario',
          inventoryRestockQueue: 'Pendiente de compra',
          inventoryRestockEmpty: 'Todo en orden, no hay materiales críticos.',
          inventoryRestockAction: 'Reordenar',
          inventoryGeneratePO: 'Generar PO',
          inventoryGeneratePOConfirm: 'Se generará un borrador de orden de compra con los materiales críticos. ¿Continuar?',
          inventoryPOEmpty: 'Sin materiales críticos. Todo al día.',
          inventoryPOCopy: 'Copiar resumen',
          inventoryPOCopied: 'Resumen copiado',
          inventoryFleetTitle: 'Camionetas y responsables',
          inventoryFleetSubtitle: 'Controla quién tiene qué equipo a bordo.',
          inventoryTruckLead: 'Responsable',
          inventoryTruckCapacity: 'Capacidad',
          inventoryTruckLoadout: 'Equipo a bordo',
          inventoryTruckEmpty: 'Sin inventario asignado',
          inventoryTruckLastService: 'Último servicio',
          inventoryTruckManage: 'Administrar fleet',
          inventoryTruckName: 'Nombre / Alias',
          inventoryTruckPlate: 'Placas',
          inventoryTruckAdd: 'Nueva unidad',
          inventoryTruckSave: 'Guardar unidad',
          inventoryTruckLoadoutAdd: 'Agregar al camión',
          inventoryTruckLoadoutPlaceholder: 'Selecciona inventario...',
          reportsSubtitle: 'El hub central para métricas financieras, operativas y de field service.',
          reportsKpiRevenue: 'Ingresos cobrados',
          reportsKpiConversion: 'Conversión de cotizaciones',
          reportsKpiBacklog: 'Backlog activo',
          reportsFilterOverview: 'General',
          reportsFilterOps: 'Operaciones',
          reportsFilterTechs: 'Técnicos',
          reportsRangeWeek: 'Semana',
          reportsRangeMonth: 'Mes',
          reportsRangeQuarter: 'Trimestre',
          reportsInsightsTitle: 'Insights clave',
          reportsTemplatesTitle: 'Catálogo listo para enviar',
          reportsHistoryTitle: 'Historial reciente',
          reportsHistoryName: 'Reporte',
          reportsHistoryScope: 'Periodo',
          reportsHistoryFormat: 'Formato',
          reportsHistoryRun: 'Ejecutado',
          reportsRows: 'filas',
          reportsSchedule: 'Programar envío',
          reportsBuilder: 'Nuevo reporte',
          reportsInsightActive: 'Órdenes activas',
          reportsInsightCycle: 'Ciclo promedio',
          reportsInsightTechUtil: 'Utilización de técnicos',
          reportsInsightWinRate: 'Win rate',
          reportsInsightTravel: 'Tiempo en tránsito',
          reportsTemplatePreview: 'Previsualizar',
          reportsTemplateSend: 'Enviar',
          reportsHistoryEmpty: 'Aún no hay ejecuciones.',
          reportsScheduleTitle: 'Programaciones activas',
          reportsScheduleCadence: 'Frecuencia',
          reportsScheduleRecipients: 'Destinatarios',
          reportsScheduleNextRun: 'Próximo envío',
          reportsScheduleEmpty: 'No hay envíos automáticos.',
          reportsScheduleRunNow: 'Enviar ahora',
          reportsScheduleDelete: 'Eliminar',
          reportsSchedulePause: 'Pausar',
          reportsScheduleResume: 'Reanudar',
          reportsSchedulePaused: 'Pausado',
          reportsBuilderName: 'Nombre del reporte',
          reportsBuilderCategory: 'Categoría',
          reportsBuilderFormat: 'Formato',
          reportsBuilderScope: 'Cobertura',
          reportsBuilderCadence: 'Frecuencia sugerida',
          reportsBuilderDataset: 'Fuente de datos',
          reportsBuilderColumns: 'Columnas',
          reportsBuilderGroup: 'Agrupar por',
          reportsBuilderPreview: 'Vista previa',
          reportsBuilderSave: 'Guardar plantilla',
          reportsPreviewEmpty: 'Selecciona columnas para ver la vista previa.',
          reportsTemplateDownload: 'Descargar',
          reportsTemplateSend: 'Enviar',
          reportsRunAgain: 'Re-ejecutar',
          reportsViewSnapshot: 'Ver snapshot',
          reportsDetailTitle: 'Detalle analítico',
          reportsDetailSubtitle: 'Profundiza en tus métricas con tablas dinámicas.',
          reportsDataset: 'Fuente de datos',
          reportsColumns: 'Columnas',
          reportsGrouping: 'Agrupación',
          poTitle: 'Orden de compra',
          poVendor: 'Proveedor',
          poJob: 'Número de job',
          poNotes: 'Notas',
          poItems: 'Productos sugeridos',
          poItemsOptional: 'Agrega o ajusta cantidades antes de enviar.',
          poTotal: 'Total estimado',
          poSave: 'Guardar orden',
          poStatusDraft: 'Borrador',
          poStatusSent: 'Enviado',
          poStatusReceived: 'Recibido',
          poDownloadPdf: 'Descargar PDF',
          poEmailVendor: 'Enviar al proveedor',
          poHistoryTitle: 'Órdenes de compra recientes',
          poHistoryEmpty: 'Aún no hay órdenes de compra.',
          poCreate: 'Nueva orden de compra',
          poVendorPlaceholder: 'Selecciona proveedor',
          poNoProducts: 'No hay productos registrados con este proveedor.',
          inventoryFieldName: 'Nombre del material',
          inventoryFieldSku: 'SKU / Código',
          inventoryFieldCategory: 'Categoría',
          inventoryFieldQty: 'Cantidad disponible',
          inventoryFieldUnit: 'Unidad de medida',
          inventoryFieldStatus: 'Estado',
          inventoryFieldReorder: 'Punto de reorden',
          inventoryFieldLocation: 'Ubicación',
          inventoryFieldVendor: 'Proveedor',
          inventoryFieldCost: 'Costo unitario (USD)',
          inventoryFieldRestock: 'Último abastecimiento',
          inventoryFieldNotes: 'Notas',
          inventorySaveItem: 'Guardar material',
          inventoryEditItem: 'Editar material',
          inventoryEdit: 'Editar',
          inventoryDelete: 'Eliminar',
          reports: 'Reportes',
          reportTypeInventory: 'Inventario',
          users: 'Usuarios',
          staff: 'Staff',
          roles: 'Roles y accesos',
          settings: 'Configuración',
          newOrder: 'Nueva orden',
          newQuote: 'Nueva cotización',
          newCustomer: 'Nuevo cliente',
          newUser: 'Nuevo usuario',
          dashboardKicker: 'Operación en vivo',
          summaryDone: 'Completados',
          summaryDoing: 'En curso',
          summaryUpcoming: 'Programados',
          summaryDoneHint: 'trabajos cerrados este mes',
          summaryDoingHint: 'equipos desplegados',
          summaryUpcomingHint: 'visitas confirmadas',
          summarySnapshot: 'Snapshot financiero',
          summaryPriorityMix: 'Prioridad por nivel',
          summaryTotalRevenue: 'Ingresos brutos',
          summaryAvgTicket: 'Ticket promedio',
          summaryHigh: 'Alta',
          summaryNormal: 'Media',
          summaryLow: 'Baja',
          summaryDoneTrend: 'vs semana pasada',
          summaryDoingTrend: 'frentes activos',
          summaryUpcomingTrend: 'confirmadas hoy',
          mapTitle: 'Mapa de trabajos',
          mapSubtitle: 'Estados actuales de cuadrillas',
          mapActive: 'Activas',
          mapFuture: 'Futuras',
          mapHistory: 'Histórico',
          scheduleSubtitle: 'Controla las visitas por rango y estilo',
          scheduleRangeDay: 'Día',
          scheduleRangeWeek: 'Semana',
          scheduleRangeMonth: 'Mes',
          scheduleViewBoard: 'Panel',
          scheduleViewTimeline: 'Timeline',
          scheduleEmpty: 'Selecciona un trabajo para ver los detalles',
          scheduleKpiToday: 'Visitas hoy',
          scheduleKpiTodayHint: 'Programadas para hoy',
          scheduleKpiUrgent: 'Urgentes',
          scheduleKpiUrgentHint: 'Prioridad alta',
          scheduleKpiBacklog: 'Órdenes abiertas',
          scheduleKpiBacklogHint: 'Por cerrar',
          scheduleFeedTitle: 'Próximos hitos',
          scheduleFeedEmpty: 'Aún no hay registros',
          scheduleAddress: 'Dirección',
          scheduleWindow: 'Ventana',
          scheduleCrew: 'Equipo',
          scheduleScope: 'Alcance',
          scheduleDescription: 'Descripción',
          scheduleTasks: 'Precauciones',
          scheduleNotes: 'Notas',
          scheduleEdit: 'Editar orden',
          ordersSubtitle: 'Monitorea el flujo completo y actualiza en segundos',
          ordersFilterAll: 'Todas',
          ordersFilterActive: 'Activas',
          ordersFilterCompleted: 'Cerradas',
          ordersEmpty: 'Sin órdenes con los filtros actuales',
          ordersTotalLabel: 'Total',
          ordersDateLabel: 'Programada',
          ordersSearchPlaceholder: 'Buscar orden…',
          ordersNoClients: 'No hay clientes registrados todavía',
          ordersAddressRequired: 'Ingresa la dirección',
          ordersContinue: 'Continuar',
          ordersBack: 'Regresar',
          orderSelectClient: 'Selecciona un cliente',
          orderSelectClientHint: 'Busca un cliente activo para continuar.',
          orderSearchPlaceholder: 'Buscar cliente…',
          orderSelectAddress: 'Dirección del trabajo',
          orderAddCustomer: 'Agregar nuevo cliente',
          orderAddAddress: 'Agregar nueva dirección',
          orderNewAddressPlaceholder: 'Ej. 1200 Travis St, Houston, TX',
          customersStatTotal: 'Clientes activos',
          customersStatTotalHint: 'Registrados en Opsis',
          customersStatLocations: 'Direcciones totales',
          customersStatLocationsHint: 'Sitios atendidos',
          customersStatActive: 'Órdenes activas',
          customersStatActiveHint: 'En seguimiento',
          customersSearchPlaceholder: 'Buscar cliente o contacto…',
          customersFilterAll: 'Todos',
          customersFilterResidential: 'Residencial',
          customersFilterCommercial: 'Comercial',
          customersFilterContractor: 'Contratistas',
          customerViewProfile: 'Ver perfil',
          customerAddresses: 'Direcciones',
          customerOrders: 'Órdenes',
          customerOrdersEmpty: 'Sin historial aún',
          customerAddressesEmpty: 'Agrega una dirección para este cliente',
          customerOutstanding: 'Saldo pendiente',
          customerLastService: 'Último servicio',
          financialSummary: 'Resumen financiero',
          customerEmail: 'Email principal',
          customerPhone: 'Teléfono',
          customerType: 'Tipo de cliente',
          customerTypeResidential: 'Residencial',
          customerTypeCommercial: 'Comercial',
          customerTypeContractor: 'Contratista',
          customerNotes: 'Notas internas',
          customerAddAddress: 'Agregar dirección',
          staffSubtitle: 'Gestiona técnicos, labor y disponibilidad.',
          staffAddMember: 'Nuevo miembro',
          staffTotal: 'Total de staff',
          staffTotalHint: 'registrados en Opsis',
          staffActive: 'Disponibles',
          staffActiveHint: 'en campo o on-call',
          staffHours: 'Horas semana',
          staffHoursHint: 'promedio acumulado',
          staffFilterAll: 'Todos',
          staffFilterTech: 'Técnicos',
          staffFilterLabor: 'Labor',
          staffTimesheetTitle: 'Bitácora semanal',
          staffTimesheetDay: 'Día',
          staffTimesheetJob: 'Orden',
          staffTimesheetService: 'Servicio',
          staffTimesheetDetail: 'Detalle',
          staffTimesheetHours: 'Horas',
          staffTimesheetEmpty: 'Selecciona un miembro para ver sus horas.',
          staffSearchPlaceholder: 'Buscar por nombre o especialidad…',
          billingQuotesValue: 'Valor cotizado',
          billingQuotesCount: 'activas este mes',
          billingQuotesWon: 'Cotizaciones ganadas',
          billingInvoicesDue: 'Facturas por cobrar',
          billingInvoicesCount: 'abiertas',
          billingQuoteHint: 'Embudo y seguimiento.',
          billingInvoiceHint: 'Cobranzas y pagos.',
          billingSearchPlaceholder: 'Buscar cotización o factura…',
          billingQuoteHistory: 'Historial de cotizaciones',
          billingQuoteHistoryHint: 'Últimas aprobadas o perdidas.',
          billingInvoiceHistory: 'Historial de facturas',
          billingInvoiceHistoryHint: 'Pagos registrados recientes.',
          billingValidUntil: 'Vence',
          billingDueOn: 'Cobra el',
          billingActionSend: 'Enviar',
          billingActionCollect: 'Registrar pago',
          statusDraft: 'Borrador',
          statusSent: 'Enviado',
          statusNegotiation: 'Negociación',
          statusWon: 'Ganada',
          statusApproved: 'Aprobada',
          statusAccepted: 'Aceptada',
          statusLost: 'Perdida',
          statusOpen: 'Abierta',
          statusDue: 'Por vencer',
          statusOverdue: 'Vencida',
          statusPending: 'Pendiente',
          statusPaid: 'Pagada',
          statusPartial: 'Parcial',
          staffFormName: 'Nombre completo',
          staffFormCategory: 'Tipo',
          staffFormRole: 'Rol en Opsis',
          staffFormSpecialty: 'Especialidad',
          staffFormAvailability: 'Disponibilidad',
          staffFormLocation: 'Ubicación base',
          staffFormHours: 'Horas por semana',
          staffFormCerts: 'Certificaciones requeridas',
          staffFormCertsHint: 'Selecciona todas las que correspondan según reglamentos de California.',
          staffFormCertsOther: 'Otras certificaciones',
          staffFormSave: 'Guardar miembro',
          staffCategoryTechnician: 'Técnico',
          staffCategoryLabor: 'Labor',
          staffAvailabilityAvailable: 'Disponible',
          staffAvailabilityOnCall: 'On Call',
          staffAvailabilityOffice: 'Oficina/HQ',
          orderTeamTechnicians: 'Técnicos asignados',
          orderTeamLabor: 'Auxiliares / Labor',
          orderCrewHelper: 'Selecciona el crew sugerido o agrega personal adicional.',
          orderPrecautions: 'Precauciones',
          orderPrecautionsHelper: 'Anota riesgos especiales: gas expuesto, mascotas, áreas restringidas, etc.',
          staffAvailability: 'Disponibilidad',
          staffLocation: 'Ubicación',
          staffLastJob: 'Último trabajo',
          staffWeekLabel: 'Semana actual',
          management: 'Management',
          managementSubtitle: 'Controla accesos, permisos y responsables del sistema Opsis.',
          managementAddUser: 'Nuevo administrador',
          managementKpiAdmins: 'Admins activos',
          managementKpiInvites: 'Invitaciones pendientes',
          managementKpiLastAudit: 'Último acceso',
          managementSearchPlaceholder: 'Buscar administrador…',
          managementRoleAll: 'Todos los roles',
          managementStatus: 'Estado',
          managementLastAccess: 'Último acceso',
          managementDetailPlaceholder: 'Selecciona un administrador para ver sus detalles.',
          managementDetailRole: 'Rol asignado',
          managementDetailDepartment: 'Departamento',
          managementDetailPhone: 'Teléfono',
          managementDetailLastAccess: 'Último acceso',
          managementMfaEnabled: 'MFA activo',
          managementMfaDisabled: 'MFA pendiente',
          managementInvitesTitle: 'Invitaciones pendientes',
          managementInvitesSubtitle: 'Monitorea accesos aún no confirmados.',
          managementInvitesEmpty: 'No hay invitaciones abiertas.',
          managementActivityTitle: 'Actividad reciente',
          managementActivitySubtitle: 'Auditoría y cambios críticos.',
          managementActivityEmpty: 'Sin movimientos recientes.',
          managementInviteResend: 'Reenviar',
          managementInviteCancel: 'Cancelar',
          managementInviteExpires: 'Expira',
          managementInviteResent: 'Invitación reenviada.',
          managementInviteCancelled: 'Invitación cancelada.',
          managementStatusActive: 'Activo',
          managementStatusAway: 'Fuera',
          managementStatusDisabled: 'Suspendido',
          managementEmpty: 'Sin administradores para este filtro.',
          managementActivityRoleChange: 'Cambio de rol',
          managementActivityInvite: 'Invitación enviada',
          managementActivitySecurity: 'Actualización de seguridad',
          managementModalTitleNew: 'Nuevo administrador',
          managementModalTitleEdit: 'Editar administrador',
          managementModalName: 'Nombre completo',
          managementModalEmail: 'Correo',
          managementModalPhone: 'Teléfono',
          managementModalRole: 'Rol asignado',
          managementModalStatus: 'Estado',
          managementModalMfa: 'Requerir MFA',
          managementModalSave: 'Guardar',
          managementModalRequired: 'Completa los campos obligatorios.',
          managementModalInvalidEmail: 'Correo inválido.',
          managementUserAdded: 'Administrador agregado.',
          managementUserUpdated: 'Perfil actualizado.',
          managementUserRemoved: 'Administrador eliminado.',
          managementRemoveConfirm: '¿Eliminar este administrador? Esta acción no se puede deshacer.',
          managementDetailSave: 'Guardar cambios',
          managementDetailRemove: 'Eliminar',
          managementSelectFirst: 'Selecciona un administrador primero.',
          rolesSubtitle: 'Define permisos y mantén el control de seguridad.',
          rolesAdd: 'Nuevo rol',
          rolesKpiTotal: 'Roles definidos',
          rolesKpiTotalHint: 'Distribuidos por área',
          rolesKpiAdmins: 'Usuarios críticos',
          rolesKpiAdminsHint: 'Owners + Admins',
          rolesKpiPermissions: 'Permisos activos',
          rolesKpiPermissionsHint: 'Total del catálogo',
          rolesSearchPlaceholder: 'Buscar rol…',
          rolesEdit: 'Editar',
          rolesDuplicate: 'Duplicar',
          rolesPermissionsLabel: 'permisos',
          rolesUsersLabel: 'Usuarios',
          rolesUsersList: 'Usuarios asignados',
          rolesUsersEmpty: 'Sin usuarios en este rol',
          rolesAssignUser: 'Agregar usuario',
          clientPortal: 'Portal cliente',
          contractorPortal: 'Portal contratista',
          clientPortalTitle: 'Portal del cliente',
          clientPortalSubtitle: 'Consulta el avance de tu orden, cotizaciones e historial.',
          clientPortalKpiOpen: 'Órdenes activas',
          clientPortalKpiOpenHint: 'En ejecución',
          clientPortalKpiQuote: 'Cotizaciones abiertas',
          clientPortalKpiQuoteHint: 'Pendientes de aprobación',
          clientPortalKpiInvoice: 'Facturas pendientes',
          clientPortalKpiInvoiceHint: 'Por pagar',
          clientPortalOrders: 'Órdenes recientes',
          clientPortalSummary: 'Resumen de cuenta',
          clientPortalNewOrder: 'Nueva orden',
          clientPortalEmpty: 'Aún no hay órdenes registradas.',
          contractorPortalTitle: 'Portal contratista',
          contractorPortalSubtitle: 'Monitorea múltiples sitios y solicita nuevos servicios.',
          contractorPortalKpiProjects: 'Proyectos activos',
          contractorPortalKpiProjectsHint: 'Sitios coordinados',
          contractorPortalKpiValue: 'Valor en curso',
          contractorPortalKpiValueHint: 'Suma estimada',
          contractorPortalKpiCrew: 'Cuadrillas en sitio',
          contractorPortalKpiCrewHint: 'Equipos desplegados',
          contractorPortalOrders: 'Órdenes por sitio',
          contractorPortalNewOrder: 'Solicitar servicio',
          rolesDetailPlaceholder: 'Selecciona un rol para ver sus permisos.',
          rolesEmpty: 'No hay roles para este filtro.',
          rolesModalTitleNew: 'Nuevo rol',
          rolesModalTitleEdit: 'Editar rol',
          rolesModalName: 'Nombre del rol',
          rolesModalDescription: 'Descripción',
          rolesModalColor: 'Color',
          rolesModalPermissions: 'Permisos',
          rolesModalSave: 'Guardar rol',
          rolesModalRequired: 'El nombre es obligatorio.',
          rolesModalNoPermissions: 'Selecciona al menos un permiso.',
          rolesSaved: 'Rol guardado.',
          rolesDuplicated: 'Rol duplicado.',
          rolesSelectFirst: 'Selecciona un rol primero.',
          saveCustomer: 'Guardar cliente',
          saveChanges: 'Guardar cambios',
          addMaterial: 'Agregar material',
          reportType: 'Tipo de reporte',
          startDate: 'Fecha inicio',
          endDate: 'Fecha fin',
          filters: 'Filtros',
          generate: 'Generar',
          exportPDF: 'Exportar PDF',
          sendEmail: 'Enviar email',
          reportsPlaceholder: 'Selecciona filtros para generar reporte.',
          companyName: 'Nombre de la empresa',
          phone: 'Teléfono',
          email: 'Email',
          palette: 'Paleta',
          uiLanguage: 'Idioma del sistema',
          uiTheme: 'Modo de interfaz',
          accentColor: 'Color corporativo',
          paletteBlue: 'Azul',
          paletteOrange: 'Naranja',
          paletteGreen: 'Verde',
          settingsKpiCompany: 'Compañía',
          settingsKpiTheme: 'Modo',
          settingsKpiLanguage: 'Idioma',
          settingsKpiCompanyHint: 'Nombre mostrado en Opsis',
          settingsKpiThemeHint: 'Modo actual',
          settingsKpiLanguageHint: 'UI predeterminado',
          settingsCompanyCard: 'Identidad y contacto',
          settingsCompanySubtitle: 'Nombre visible en app y datos básicos de contacto.',
          settingsBrandingCard: 'Branding y apariencia',
          settingsBrandingSubtitle: 'Define paleta, color corporativo y modo.',
          settingsLocalizationCard: 'Localización y datos',
          settingsLocalizationSubtitle: 'Controla el idioma y reinicia la data demo.',
          settingsNotificationsCard: 'Preferencias de notificaciones',
          settingsNotificationsSubtitle: 'Activa los canales (Email, SMS, In-App) para cada perfil del sistema.',
          settingsNotificationsColumnRole: 'Perfil',
          settingsNotificationsColumnEmail: 'Email',
          settingsNotificationsColumnSms: 'SMS',
          settingsNotificationsColumnInApp: 'In-App',
          settingsNotificationsRoleOwner: 'Owner / Dirección',
          settingsNotificationsRoleAdmin: 'Admin / Operaciones',
          settingsNotificationsRoleTech: 'Técnico',
          settingsNotificationsRoleLabor: 'Labor',
          settingsNotificationsRoleClient: 'Cliente',
          settingsNotificationsRoleContractor: 'Contratista',
          settingsNotificationsFooter:
            'Los cambios aplican para alertas operativas (MotorSync), asignaciones (TimeSync), logística (ToolSync) y facturación (FinanSync).',
          settingsNotificationsSave: 'Guardar preferencias',
          settingsNotificationsSaved: 'Preferencias de notificaciones guardadas.',
          settingsOwnerOnly: 'Solo el Owner puede abrir Configuración. Cambia el rol desde el menú superior.',
          settingsRoleAccessCard: 'Accesos por rol',
          settingsRoleAccessSubtitle: 'Define qué puede ver cada perfil y quién puede enviar invitaciones.',
          settingsRoleAccessColumnRole: 'Rol',
          settingsRoleAccessColumnPages: 'Áreas disponibles',
          settingsRoleAccessColumnInvites: 'Puede invitar',
          settingsRoleAccessInvitesYes: 'Sí',
          settingsRoleAccessInvitesNo: 'No',
          settingsRoleAccessInviteHint: 'Owner y Admin pueden invitar técnicos, labor, clientes y contratistas.',
          settingsSaveButton: 'Guardar cambios',
          settingsSaveSuccess: 'Preferencias guardadas.',
          settingsThemeLight: 'Claro',
          settingsThemeDark: 'Oscuro',
          resetDemoTitle: 'Datos de demostración',
          resetDemoButton: 'Reiniciar',
          resetDemoHint: 'Borra y vuelve a cargar la información de ejemplo.',
          resetDemoConfirm: 'Esto restaurará los datos de demostración. ¿Deseas continuar?',
          labelCustomer: 'Cliente',
          labelService: 'Servicio',
          colCustomer: 'Cliente',
          colService: 'Servicio',
          colStatus: 'Estado',
          colPriority: 'Prioridad',
          colTotal: 'Total',
          colActions: 'Acciones',
          colName: 'Nombre',
          colEmail: 'Email',
          colRole: 'Rol',
          colMaterial: 'Material',
          colQty: 'Cantidad',
        },
        en: {
          dashboard: 'Dashboard',
          schedule: 'Schedule',
          orders: 'Orders',
          quotes: 'Quotes',
          invoices: 'Invoices',
          quotesInvoices: 'Quotes / Invoices',
          customers: 'Customers',
          inventory: 'Inventory',
          inventorySubtitle: 'End-to-end visibility of materials, equipment, and consumables.',
          inventoryExport: 'Export',
          inventoryKpiSkus: 'Active SKUs',
          inventoryKpiSkusHint: 'Tracked in Opsis',
          inventoryKpiLow: 'Low stock',
          inventoryKpiLowHint: 'Need replenishment',
          inventoryKpiValue: 'Inventory value',
          inventoryKpiValueHint: 'Based on unit cost',
          inventoryFilterAll: 'All',
          inventoryFilterMaterials: 'Materials',
          inventoryFilterEquipment: 'Equipment',
          inventoryFilterKits: 'Kits',
          inventoryFilterConsumables: 'Consumables',
          inventoryFilterSafety: 'Safety',
          inventoryCategoryMaterials: 'Materials',
          inventoryCategoryEquipment: 'Equipment',
          inventoryCategoryKits: 'Service kits',
          inventoryCategoryConsumables: 'Consumables',
          inventoryCategorySafety: 'Safety',
          inventoryViewCards: 'Cards',
          inventoryViewTable: 'Table',
          inventorySearchPlaceholder: 'Search by name, SKU, or vendor…',
          inventoryStatusOk: 'Healthy',
          inventoryStatusLow: 'Low',
          inventoryStatusCritical: 'Critical',
          inventoryLocation: 'Location',
          inventoryVendor: 'Vendor',
          inventoryReorder: 'Reorder',
          inventoryUnit: 'Unit',
          inventoryLastRestock: 'Last restock',
          inventoryCost: 'Unit cost',
          inventoryValue: 'Inventory value',
          inventoryEmpty: 'No items found for this filter.',
          inventoryDeleteConfirm: 'Remove this item from inventory?',
          inventoryReportTitle: 'Inventory report',
          inventoryReportLow: 'Low stock items',
          inventoryReportValue: 'Total inventory value',
          inventoryRestockQueue: 'Restock queue',
          inventoryRestockEmpty: 'All clear, no low stock alerts.',
          inventoryRestockAction: 'Reorder',
          inventoryGeneratePO: 'Generate PO',
          inventoryGeneratePOConfirm: 'Generate a purchase order draft with low stock items?',
          inventoryPOEmpty: 'No low stock alerts right now.',
          inventoryPOCopy: 'Copy summary',
          inventoryPOCopied: 'Summary copied',
          inventoryFleetTitle: 'Fleet readiness',
          inventoryFleetSubtitle: 'See who is responsible for each truck and its loadout.',
          inventoryTruckLead: 'Lead tech',
          inventoryTruckCapacity: 'Capacity used',
          inventoryTruckLoadout: 'On-board gear',
          inventoryTruckEmpty: 'No equipment assigned',
          inventoryTruckLastService: 'Last service',
          inventoryTruckManage: 'Manage fleet',
          inventoryTruckName: 'Truck / Alias',
          inventoryTruckPlate: 'Plate',
          inventoryTruckAdd: 'New truck',
          inventoryTruckSave: 'Save truck',
          inventoryTruckLoadoutAdd: 'Add to loadout',
          inventoryTruckLoadoutPlaceholder: 'Select inventory item...',
          reportsSubtitle: 'The control center for every financial and operations report.',
          reportsKpiRevenue: 'Collected revenue',
          reportsKpiConversion: 'Quote conversion',
          reportsKpiBacklog: 'Active backlog',
          reportsFilterOverview: 'Overview',
          reportsFilterOps: 'Ops',
          reportsFilterTechs: 'Technicians',
          reportsRangeWeek: 'Week',
          reportsRangeMonth: 'Month',
          reportsRangeQuarter: 'Quarter',
          reportsInsightsTitle: 'Key insights',
          reportsTemplatesTitle: 'Ready-to-run catalog',
          reportsHistoryTitle: 'Recent history',
          reportsHistoryName: 'Report',
          reportsHistoryScope: 'Scope',
          reportsHistoryFormat: 'Format',
          reportsHistoryRun: 'Run at',
          reportsRows: 'rows',
          reportsSchedule: 'Schedule send',
          reportsBuilder: 'New report',
          reportsInsightActive: 'Active jobs',
          reportsInsightCycle: 'Average cycle',
          reportsInsightTechUtil: 'Technician utilization',
          reportsInsightWinRate: 'Win rate',
          reportsInsightTravel: 'Travel time',
          reportsTemplatePreview: 'Preview',
          reportsTemplateSend: 'Send',
          reportsHistoryEmpty: 'No runs yet.',
          reportsScheduleTitle: 'Active schedules',
          reportsScheduleCadence: 'Cadence',
          reportsScheduleRecipients: 'Recipients',
          reportsScheduleNextRun: 'Next run',
          reportsScheduleEmpty: 'No automated emails yet.',
          reportsScheduleRunNow: 'Send now',
          reportsScheduleDelete: 'Delete',
          reportsSchedulePause: 'Pause',
          reportsScheduleResume: 'Resume',
          reportsSchedulePaused: 'Paused',
          reportsBuilderName: 'Report name',
          reportsBuilderCategory: 'Category',
          reportsBuilderFormat: 'Format',
          reportsBuilderScope: 'Coverage',
          reportsBuilderCadence: 'Suggested cadence',
          reportsBuilderDataset: 'Dataset',
          reportsBuilderColumns: 'Columns',
          reportsBuilderGroup: 'Group by',
          reportsBuilderPreview: 'Preview',
          reportsBuilderSave: 'Save template',
          reportsPreviewEmpty: 'Pick columns to preview data.',
          reportsTemplateDownload: 'Download',
          reportsTemplateSend: 'Send',
          reportsRunAgain: 'Run again',
          reportsViewSnapshot: 'View snapshot',
          reportsDetailTitle: 'Analytical detail',
          reportsDetailSubtitle: 'Dive deeper with dynamic tables.',
          reportsDataset: 'Dataset',
          reportsColumns: 'Columns',
          reportsGrouping: 'Grouping',
          poTitle: 'Purchase order',
          poVendor: 'Vendor',
          poJob: 'Job number',
          poNotes: 'Notes',
          poItems: 'Suggested items',
          poItemsOptional: 'Adjust quantities before sending.',
          poTotal: 'Estimated total',
          poSave: 'Save PO',
          poStatusDraft: 'Draft',
          poStatusSent: 'Sent',
          poStatusReceived: 'Received',
          poDownloadPdf: 'Download PDF',
          poEmailVendor: 'Email vendor',
          poHistoryTitle: 'Recent purchase orders',
          poHistoryEmpty: 'No purchase orders yet.',
          poCreate: 'New purchase order',
          poVendorPlaceholder: 'Select vendor',
          poNoProducts: 'No products mapped to this vendor.',
          inventoryFieldName: 'Material name',
          inventoryFieldSku: 'SKU / Code',
          inventoryFieldCategory: 'Category',
          inventoryFieldQty: 'Quantity on hand',
          inventoryFieldUnit: 'Unit of measure',
          inventoryFieldStatus: 'Status',
          inventoryFieldReorder: 'Reorder point',
          inventoryFieldLocation: 'Location',
          inventoryFieldVendor: 'Vendor',
          inventoryFieldCost: 'Unit cost (USD)',
          inventoryFieldRestock: 'Last restock date',
          inventoryFieldNotes: 'Notes',
          inventorySaveItem: 'Save item',
          inventoryEditItem: 'Edit item',
          inventoryEdit: 'Edit',
          inventoryDelete: 'Delete',
          reports: 'Reports',
          reportTypeInventory: 'Inventory',
          users: 'Users',
          staff: 'Staff',
          roles: 'Roles & access',
          settings: 'Settings',
          newOrder: 'New Order',
          newQuote: 'New quote',
          newCustomer: 'New customer',
          newUser: 'New user',
          dashboardKicker: 'Live operations',
          summaryDone: 'Completed',
          summaryDoing: 'In progress',
          summaryUpcoming: 'Scheduled',
          summaryDoneHint: 'jobs closed this month',
          summaryDoingHint: 'active crews',
          summaryUpcomingHint: 'visits confirmed',
          summarySnapshot: 'Financial snapshot',
          summaryPriorityMix: 'Priority mix',
          summaryTotalRevenue: 'Gross revenue',
          summaryAvgTicket: 'Average ticket',
          summaryHigh: 'High',
          summaryNormal: 'Medium',
          summaryLow: 'Low',
          summaryDoneTrend: 'vs last week',
          summaryDoingTrend: 'fronts active',
          summaryUpcomingTrend: 'confirmed today',
          mapTitle: 'Jobs map',
          mapSubtitle: 'Crew status across states',
          mapActive: 'Active',
          mapFuture: 'Upcoming',
          mapHistory: 'History',
          scheduleSubtitle: 'Control every visit by range and style',
          scheduleRangeDay: 'Day',
          scheduleRangeWeek: 'Week',
          scheduleRangeMonth: 'Month',
          scheduleViewBoard: 'Board',
          scheduleViewTimeline: 'Timeline',
          scheduleEmpty: 'Select a job to display its details',
          scheduleKpiToday: 'Visits today',
          scheduleKpiTodayHint: 'Scheduled for today',
          scheduleKpiUrgent: 'Urgent',
          scheduleKpiUrgentHint: 'High priority',
          scheduleKpiBacklog: 'Open orders',
          scheduleKpiBacklogHint: 'Awaiting completion',
          scheduleFeedTitle: 'Next milestones',
          scheduleFeedEmpty: 'No updates yet',
          scheduleAddress: 'Address',
          scheduleWindow: 'Time window',
          scheduleCrew: 'Crew',
          scheduleScope: 'Scope',
          scheduleDescription: 'Description',
          scheduleTasks: 'Precautions',
          scheduleNotes: 'Notes',
          scheduleEdit: 'Edit order',
          ordersSubtitle: 'Track the full pipeline and update in seconds',
          ordersFilterAll: 'All',
          ordersFilterActive: 'Active',
          ordersFilterCompleted: 'Closed',
          ordersEmpty: 'No orders match the current filters',
          ordersTotalLabel: 'Total',
          ordersDateLabel: 'Scheduled',
          ordersSearchPlaceholder: 'Search order…',
          ordersNoClients: 'No customers yet',
          ordersAddressRequired: 'Please enter the address',
          ordersContinue: 'Continue',
          ordersBack: 'Back',
          orderSelectClient: 'Select a customer',
          orderSelectClientHint: 'Search an existing customer to continue.',
          orderSearchPlaceholder: 'Search customer…',
          orderSelectAddress: 'Job address',
          orderAddCustomer: 'Add new customer',
          orderAddAddress: 'Add new address',
          orderNewAddressPlaceholder: 'e.g. 1200 Travis St, Houston, TX',
          customersStatTotal: 'Active customers',
          customersStatTotalHint: 'registered in Opsis',
          customersStatLocations: 'Total locations',
          customersStatLocationsHint: 'sites served',
          customersStatActive: 'Open jobs',
          customersStatActiveHint: 'being tracked',
          customersSearchPlaceholder: 'Search customer or contact…',
          customersFilterAll: 'All',
          customersFilterResidential: 'Residential',
          customersFilterCommercial: 'Commercial',
          customersFilterContractor: 'Contractors',
          customerViewProfile: 'View profile',
          customerAddresses: 'Addresses',
          customerOrders: 'Orders',
          customerOrdersEmpty: 'No work history yet',
          customerAddressesEmpty: 'Add a job location for this customer',
          customerOutstanding: 'Outstanding',
          customerLastService: 'Last service',
          financialSummary: 'Financial summary',
          customerEmail: 'Primary email',
          customerPhone: 'Phone',
          customerType: 'Customer type',
          customerTypeResidential: 'Residential',
          customerTypeCommercial: 'Commercial',
          customerTypeContractor: 'Contractor',
          customerNotes: 'Internal notes',
          customerAddAddress: 'Add address',
          staffSubtitle: 'Manage field teams, hours and availability.',
          staffAddMember: 'New member',
          staffTotal: 'Crew members',
          staffTotalHint: 'in Opsis',
          staffActive: 'Available',
          staffActiveHint: 'on site or on call',
          staffHours: 'Weekly hours',
          staffHoursHint: 'average recorded',
          staffFilterAll: 'All',
          staffFilterTech: 'Technicians',
          staffFilterLabor: 'Labor',
          staffTimesheetTitle: 'Weekly timesheet',
          staffTimesheetDay: 'Day',
          staffTimesheetJob: 'Order',
          staffTimesheetService: 'Service',
          staffTimesheetDetail: 'Detail',
          staffTimesheetHours: 'Hours',
          staffTimesheetEmpty: 'Select a member to view hours.',
          staffSearchPlaceholder: 'Search by name or specialty…',
          billingQuotesValue: 'Quoted value',
          billingQuotesCount: 'active this month',
          billingQuotesWon: 'Quotes won',
          billingInvoicesDue: 'Invoices due',
          billingInvoicesCount: 'open items',
          billingQuoteHint: 'Pipeline and follow-up.',
          billingInvoiceHint: 'Collections and payments.',
          billingSearchPlaceholder: 'Search quote or invoice…',
          billingQuoteHistory: 'Quote history',
          billingQuoteHistoryHint: 'Recently closed or lost.',
          billingInvoiceHistory: 'Invoice history',
          billingInvoiceHistoryHint: 'Recent payments logged.',
          billingValidUntil: 'Valid until',
          billingDueOn: 'Due on',
          billingActionSend: 'Send',
          billingActionCollect: 'Collect payment',
          statusDraft: 'Draft',
          statusSent: 'Sent',
          statusNegotiation: 'Negotiation',
          statusWon: 'Won',
          statusApproved: 'Approved',
          statusAccepted: 'Accepted',
          statusLost: 'Lost',
          statusOpen: 'Open',
          statusDue: 'Due soon',
          statusOverdue: 'Overdue',
          statusPending: 'Pending',
          statusPaid: 'Paid',
          statusPartial: 'Partial',
          staffFormName: 'Full name',
          staffFormCategory: 'Type',
          staffFormRole: 'Opsis role',
          staffFormSpecialty: 'Specialty',
          staffFormAvailability: 'Availability',
          staffFormLocation: 'Base location',
          staffFormHours: 'Hours per week',
          staffFormCerts: 'Required certifications',
          staffFormCertsHint: 'Check every license needed under California regulations.',
          staffFormCertsOther: 'Other certifications',
          staffFormSave: 'Save member',
          staffCategoryTechnician: 'Technician',
          staffCategoryLabor: 'Labor',
          staffAvailabilityAvailable: 'Available',
          staffAvailabilityOnCall: 'On Call',
          staffAvailabilityOffice: 'Office/HQ',
          orderTeamTechnicians: 'Technicians',
          orderTeamLabor: 'Labor helpers',
          orderCrewHelper: 'Use the suggested team or pick any additional members you need.',
          orderPrecautions: 'Precautions',
          orderPrecautionsHelper: 'Document hazards: gas lines, pets, limited access, HOA rules, etc.',
          staffAvailability: 'Availability',
          staffLocation: 'Location',
          staffLastJob: 'Last job',
          staffWeekLabel: 'Current week',
          management: 'Management',
          managementSubtitle: 'Administrators in charge of controls and audit trail.',
          managementAddUser: 'New admin',
          managementKpiAdmins: 'Active admins',
          managementKpiInvites: 'Pending invites',
          managementKpiLastAudit: 'Last access',
          managementSearchPlaceholder: 'Search admin…',
          managementRoleAll: 'All roles',
          managementStatus: 'Status',
          managementLastAccess: 'Last access',
          managementDetailPlaceholder: 'Select an admin to see details.',
          managementDetailRole: 'Assigned role',
          managementDetailDepartment: 'Department',
          managementDetailPhone: 'Phone',
          managementDetailLastAccess: 'Last access',
          managementMfaEnabled: 'MFA enabled',
          managementMfaDisabled: 'MFA pending',
          managementInvitesTitle: 'Pending invites',
          managementInvitesSubtitle: 'Track access not yet confirmed.',
          managementInvitesEmpty: 'No open invites.',
          managementActivityTitle: 'Recent activity',
          managementActivitySubtitle: 'Audit trail and critical changes.',
          managementActivityEmpty: 'No recent activity.',
          managementInviteResend: 'Resend',
          managementInviteCancel: 'Cancel',
          managementInviteExpires: 'Expires',
          managementInviteResent: 'Invite resent.',
          managementInviteCancelled: 'Invite canceled.',
          managementStatusActive: 'Active',
          managementStatusAway: 'Away',
          managementStatusDisabled: 'Suspended',
          managementEmpty: 'No admins for this filter.',
          managementActivityRoleChange: 'Role change',
          managementActivityInvite: 'Invite sent',
          managementActivitySecurity: 'Security update',
          managementModalTitleNew: 'New admin',
          managementModalTitleEdit: 'Edit admin',
          managementModalName: 'Full name',
          managementModalEmail: 'Email',
          managementModalPhone: 'Phone',
          managementModalRole: 'Assigned role',
          managementModalStatus: 'Status',
          managementModalMfa: 'Require MFA',
          managementModalSave: 'Save',
          managementModalRequired: 'Please fill required fields.',
          managementModalInvalidEmail: 'Invalid email.',
          managementUserAdded: 'Admin added.',
          managementUserUpdated: 'Profile updated.',
          managementUserRemoved: 'Admin removed.',
          managementRemoveConfirm: 'Remove this admin? This cannot be undone.',
          managementDetailSave: 'Save changes',
          managementDetailRemove: 'Remove',
          managementSelectFirst: 'Select an admin first.',
          rolesSubtitle: 'Define permissions and keep security tight.',
          rolesAdd: 'New role',
          rolesKpiTotal: 'Defined roles',
          rolesKpiTotalHint: 'Distributed by team',
          rolesKpiAdmins: 'Critical users',
          rolesKpiAdminsHint: 'Owners + Admins',
          rolesKpiPermissions: 'Active permissions',
          rolesKpiPermissionsHint: 'Total on catalog',
          rolesSearchPlaceholder: 'Search role…',
          rolesEdit: 'Edit',
          rolesDuplicate: 'Duplicate',
          rolesPermissionsLabel: 'permissions',
          rolesUsersLabel: 'Users',
          rolesUsersList: 'Assigned users',
          rolesUsersEmpty: 'No users in this role',
          rolesAssignUser: 'Add user',
          clientPortal: 'Client portal',
          contractorPortal: 'Contractor portal',
          clientPortalTitle: 'Client portal',
          clientPortalSubtitle: 'Track progress, quotes and invoices.',
          clientPortalKpiOpen: 'Active orders',
          clientPortalKpiOpenHint: 'In progress',
          clientPortalKpiQuote: 'Open quotes',
          clientPortalKpiQuoteHint: 'Awaiting approval',
          clientPortalKpiInvoice: 'Pending invoices',
          clientPortalKpiInvoiceHint: 'To pay',
          clientPortalOrders: 'Recent orders',
          clientPortalSummary: 'Account summary',
          clientPortalNewOrder: 'New order',
          clientPortalEmpty: 'No orders yet.',
          contractorPortalTitle: 'Contractor portal',
          contractorPortalSubtitle: 'Oversee multiple sites and request new service.',
          contractorPortalKpiProjects: 'Active projects',
          contractorPortalKpiProjectsHint: 'Sites in motion',
          contractorPortalKpiValue: 'Value in progress',
          contractorPortalKpiValueHint: 'Estimated total',
          contractorPortalKpiCrew: 'Crews on site',
          contractorPortalKpiCrewHint: 'Teams deployed',
          contractorPortalOrders: 'Orders by site',
          contractorPortalNewOrder: 'Request service',
          rolesDetailPlaceholder: 'Select a role to inspect its permissions.',
          rolesEmpty: 'No roles match this filter.',
          rolesModalTitleNew: 'New role',
          rolesModalTitleEdit: 'Edit role',
          rolesModalName: 'Role name',
          rolesModalDescription: 'Description',
          rolesModalColor: 'Color',
          rolesModalPermissions: 'Permissions',
          rolesModalSave: 'Save role',
          rolesModalRequired: 'Name is required.',
          rolesModalNoPermissions: 'Select at least one permission.',
          rolesSaved: 'Role saved.',
          rolesDuplicated: 'Role duplicated.',
          rolesSelectFirst: 'Select a role first.',
          saveCustomer: 'Save customer',
          saveChanges: 'Save changes',
          addMaterial: 'Add material',
          reportType: 'Report type',
          startDate: 'Start date',
          endDate: 'End date',
          filters: 'Filters',
          generate: 'Generate',
          exportPDF: 'Export PDF',
          sendEmail: 'Send email',
          reportsPlaceholder: 'Select filters to generate a report.',
          companyName: 'Company name',
          phone: 'Phone',
          email: 'Email',
          palette: 'Palette',
          uiLanguage: 'Language',
          uiTheme: 'Theme mode',
          accentColor: 'Accent color',
          paletteBlue: 'Blue',
          paletteOrange: 'Orange',
          paletteGreen: 'Green',
          settingsKpiCompany: 'Company',
          settingsKpiTheme: 'Theme',
          settingsKpiLanguage: 'Language',
          settingsKpiCompanyHint: 'Name shown across Opsis',
          settingsKpiThemeHint: 'Current mode',
          settingsKpiLanguageHint: 'Default UI language',
          settingsCompanyCard: 'Identity & contact',
          settingsCompanySubtitle: 'Brand name and support details displayed in Opsis.',
          settingsBrandingCard: 'Branding & appearance',
          settingsBrandingSubtitle: 'Control palette, accent color and interface mode.',
          settingsLocalizationCard: 'Localization & data',
          settingsLocalizationSubtitle: 'Choose UI language and refresh demo data.',
          settingsNotificationsCard: 'Notification preferences',
          settingsNotificationsSubtitle: 'Toggle Email, SMS and in-app alerts for every Opsis profile.',
          settingsNotificationsColumnRole: 'Profile',
          settingsNotificationsColumnEmail: 'Email',
          settingsNotificationsColumnSms: 'SMS',
          settingsNotificationsColumnInApp: 'In-App',
          settingsNotificationsRoleOwner: 'Owner / Leadership',
          settingsNotificationsRoleAdmin: 'Admin / Operations',
          settingsNotificationsRoleTech: 'Technician',
          settingsNotificationsRoleLabor: 'Labor',
          settingsNotificationsRoleClient: 'Client',
          settingsNotificationsRoleContractor: 'Contractor',
          settingsNotificationsFooter:
            'Changes apply to MotorSync alerts, TimeSync assignments, ToolSync logistics and FinanSync billing reminders.',
          settingsNotificationsSave: 'Save preferences',
          settingsNotificationsSaved: 'Notification preferences saved.',
          settingsOwnerOnly: 'Only the Owner can open Settings. Use the role menu to switch back.',
          settingsRoleAccessCard: 'Role access',
          settingsRoleAccessSubtitle: 'See which areas every profile can view and who is allowed to send invites.',
          settingsRoleAccessColumnRole: 'Role',
          settingsRoleAccessColumnPages: 'Available areas',
          settingsRoleAccessColumnInvites: 'Can invite',
          settingsRoleAccessInvitesYes: 'Yes',
          settingsRoleAccessInvitesNo: 'No',
          settingsRoleAccessInviteHint: 'Only Owner and Admin can invite technicians, labor, clients and contractors.',
          settingsSaveButton: 'Save changes',
          settingsSaveSuccess: 'Preferences saved.',
          settingsThemeLight: 'Light',
          settingsThemeDark: 'Dark',
          resetDemoTitle: 'Demo data',
          resetDemoButton: 'Reset',
          resetDemoHint: 'Clears and reloads all sample records.',
          resetDemoConfirm: 'This will restore the demo data set. Continue?',
          labelCustomer: 'Customer',
          labelService: 'Service',
          colCustomer: 'Customer',
          colService: 'Service',
          colStatus: 'Status',
          colPriority: 'Priority',
          colTotal: 'Total',
          colActions: 'Actions',
          colName: 'Name',
          colEmail: 'Email',
          colRole: 'Role',
          colMaterial: 'Material',
          colQty: 'Qty',
        },
      },

      loadCollection(key, seed) {
        const storageKey = STORAGE_KEYS[key];
        if (!storageKey) return seed;
        const stored = storage.get(storageKey, null);
        if (stored) return stored;
        storage.set(storageKey, seed);
        return seed;
      },

      saveCollection(key, data) {
        const storageKey = STORAGE_KEYS[key];
        if (!storageKey) return;
        storage.set(storageKey, data);
      },

      persist(...keys) {
        keys.forEach((key) => {
          if (Array.isArray(key)) {
            this.persist(...key);
          } else {
            this.saveCollection(key, this[key]);
          }
        });
      },

      getNotificationChannelsConfig() {
        return [
          { id: 'email', labelKey: 'settingsNotificationsColumnEmail' },
          { id: 'sms', labelKey: 'settingsNotificationsColumnSms' },
          { id: 'inApp', labelKey: 'settingsNotificationsColumnInApp' },
        ];
      },

      getNotificationRolesConfig() {
        return [
          { id: 'owner', labelKey: 'settingsNotificationsRoleOwner' },
          { id: 'admin', labelKey: 'settingsNotificationsRoleAdmin' },
          { id: 'tech', labelKey: 'settingsNotificationsRoleTech' },
          { id: 'labor', labelKey: 'settingsNotificationsRoleLabor' },
          { id: 'client', labelKey: 'settingsNotificationsRoleClient' },
          { id: 'contractor', labelKey: 'settingsNotificationsRoleContractor' },
        ];
      },

      getDefaultNotificationPrefs() {
        return JSON.parse(JSON.stringify(DEFAULT_NOTIFICATION_PREFS));
      },

      normalizeNotificationPrefs(rawPrefs) {
        const defaults = this.getDefaultNotificationPrefs();
        const normalized = {};
        const source = rawPrefs && typeof rawPrefs === 'object' ? rawPrefs : {};
        Object.keys(defaults).forEach((role) => {
          const roleDefaults = defaults[role];
          const stored = source[role] && typeof source[role] === 'object' ? source[role] : {};
          normalized[role] = {
            email: typeof stored.email === 'boolean' ? stored.email : roleDefaults.email,
            sms: typeof stored.sms === 'boolean' ? stored.sms : roleDefaults.sms,
            inApp: typeof stored.inApp === 'boolean' ? stored.inApp : roleDefaults.inApp,
          };
        });
        return normalized;
      },

      init() {
        this.seedData();
        this.bindUI();
        this.translatePage();
        this.renderAll();
      },

      seedData() {
        const serviceSeeds = (this.DEFAULT_SERVICE_LIBRARY || []).map((service) => ({
          ...service,
          tasks: [...(service.tasks || [])],
          technicians: [...(service.technicians || [])],
          labor: [...(service.labor || [])],
          crew: [...(service.crew || [])],
        }));
        this.SERVICE_LIBRARY = this.loadCollection('services', serviceSeeds);
        this.serviceCatalog = Array.isArray(this.SERVICE_LIBRARY) ? [...this.SERVICE_LIBRARY] : [];
        this.certificationsCatalog = this.loadCollection('certifications', [...this.DEFAULT_CERTIFICATIONS]);
        this.rolesMatrix = this.loadCollection('rolesMatrix', this.rolesMatrix);
        const now = new Date();
        const orderSeeds = [
          {
            id: 'ORD-201',
            customer: 'Residencial Torres',
            projectNumber: '1024',
            projectName: 'Instalación HVAC Completo',
            idSync: '10845231',
            service: 'Instalación',
            status: 'on_site',
            priority: 'high',
            total: 12500,
            lat: 29.7604,
            lng: -95.3698,
            date: now.toISOString(),
            future: false,
            address: 'Av. Universidad #456 · Guadalajara, MX',
            window: '10:00 - 14:00',
            scope: 'Instalación de equipo HVAC completo y puesta en marcha.',
            description: 'Proyecto clave para Residencial Torres con integración de sensores y control central.',
            crewLead: 'Carlos Sánchez',
            crew: ['Luis', 'Iván'],
            tasks: ['Montaje de condensadoras', 'Configuración de termostatos', 'Pruebas de presión'],
            notes: 'Validar acceso con mantenimiento a las 09:30.'
          },
          {
            id: 'ORD-202',
            customer: 'Comercial Plaza',
            projectNumber: '1023',
            projectName: 'Reparación Sistema Eléctrico',
            idSync: '20849654',
            service: 'Reparación',
            status: 'scheduled',
            priority: 'normal',
            total: 8200,
            lat: 32.7767,
            lng: -96.797,
            date: now.toISOString(),
            future: true,
            address: 'Calle Principal #123 · Monterrey, MX',
            window: '09:00 - 11:00',
            scope: 'Diagnóstico de tablero y reemplazo de breakers críticos.',
            description: 'Reparación con certificación UL para áreas comerciales.',
            crewLead: 'María López',
            crew: ['Paul', 'Nico'],
            tasks: ['Revisión de cargas', 'Cambio de breaker 3 y 4', 'Reportar evidencias'],
            notes: 'Cliente requiere reporte firmado para seguro.'
          },
          {
            id: 'ORD-203',
            customer: 'Hotel Pacífico',
            projectNumber: '1022',
            projectName: 'Mantenimiento de Calderas',
            idSync: '30840192',
            service: 'Mantenimiento',
            status: 'job_done',
            priority: 'high',
            total: 15400,
            lat: 29.4241,
            lng: -98.4936,
            date: new Date(now.getTime() - 86400000).toISOString(),
            future: false,
            address: 'Hotel Zona Centro · Puerto Vallarta, MX',
            window: '07:00 - 12:00',
            scope: 'Puesta a punto de calderas y certificación NOM.',
            description: 'Limpieza profunda, pruebas de combustión y bitácora para auditoría.',
            crewLead: 'Diego Lead',
            crew: ['Alex'],
            tasks: ['Desmontar tapas', 'Medir eficiencia', 'Registrar resultados'],
            notes: 'Cliente listo para firmar cierre y encuesta.'
          },
          {
            id: 'ORD-204',
            customer: 'Harbor Logistics',
            projectNumber: '1050',
            projectName: 'Sistema contra incendios',
            idSync: '50927411',
            service: 'Reparación mayor',
            status: 'draft',
            priority: 'high',
            total: 14200,
            lat: 30.2672,
            lng: -97.7431,
            date: new Date(now.getTime() + 172800000).toISOString(),
            future: true,
            address: '221 East Ave · Austin, TX',
            window: '07:00 - 09:00',
            scope: 'Reemplazo de manifold principal y prueba hidráulica.',
            description: 'Trabajo programado pendiente de confirmación de refacciones.',
            crewLead: 'Ana Owner',
            crew: ['Miguel'],
            tasks: ['Validar certificación', 'Cargar evidencias al expediente'],
            notes: 'Coordinar con almacén ToolSync para surtir refacciones.'
          },
        ];
        const customerSeeds = [
          {
            id: 'C-RES',
            name: 'Residencial Torres',
            contacts: ['ops@torres.com', '+52 33 1234 5678'],
            locations: ['Guadalajara - Zona Centro'],
            type: 'residential',
            notes: 'Condominio premium con mantenimiento mensual.'
          },
          {
            id: 'C-COM',
            name: 'Comercial Plaza',
            contacts: ['contacto@plazadelsol.mx', '+52 33 8765 4321'],
            locations: ['Monterrey - Zona Comercial'],
            type: 'commercial',
            notes: 'Centro comercial de alto flujo.'
          },
          {
            id: 'C-HOT',
            name: 'Hotel Pacífico',
            contacts: ['mantenimiento@hotelpacifico.mx', '+52 55 2213 9988'],
            locations: ['Puerto Vallarta - Zona Centro'],
            type: 'commercial',
            notes: 'Cadena hotelera con requerimientos NOM.'
          },
          {
            id: 'C-HAR',
            name: 'Harbor Logistics',
            contacts: ['ops@harborlogistics.com', '+1 512 555 2010'],
            locations: ['Austin - East District'],
            type: 'contractor',
            notes: 'Operación logística con red multi-sitio.'
          },
        ];
        const quoteSeeds = [
          {
            id: 'Q-200',
            customer: 'Residencial Torres',
            total: 12900,
            status: 'draft',
            issued: '2025-01-01',
            validUntil: '2025-01-30',
            service: 'Instalación HVAC'
          },
          {
            id: 'Q-201',
            customer: 'Comercial Plaza',
            total: 8200,
            status: 'sent',
            issued: '2025-01-05',
            validUntil: '2025-01-25',
            service: 'Reparación eléctrica'
          },
          {
            id: 'Q-202',
            customer: 'Hotel Pacífico',
            total: 15400,
            status: 'won',
            issued: '2024-12-20',
            validUntil: '2025-01-10',
            service: 'Mantenimiento calderas'
          },
        ];
        const invoiceSeeds = [
          {
            id: 'INV-410',
            customer: 'Residencial Torres',
            total: 9800,
            status: 'open',
            issued: '2024-12-15',
            due: '2025-01-15',
            service: 'Instalación HVAC'
          },
          {
            id: 'INV-411',
            customer: 'Comercial Plaza',
            total: 8200,
            status: 'overdue',
            issued: '2024-12-01',
            due: '2024-12-30',
            service: 'Reparación eléctrica'
          },
          {
            id: 'INV-412',
            customer: 'Hotel Pacífico',
            total: 15400,
            status: 'paid',
            issued: '2024-11-10',
            due: '2024-12-05',
            service: 'Mantenimiento calderas'
          },
        ];
        const inventorySeeds = [
          {
            id: 'INV-001',
            name: 'Tubo PVC 1"',
            sku: 'PVC-100',
            category: 'materials',
            qty: 340,
            unit: 'ft',
            reorderPoint: 120,
            status: 'ok',
            location: 'Bodega Norte',
            vendor: 'Ferguson',
            cost: 2.15,
            lastRestock: '2024-12-28',
            notes: 'Uso diario en proyectos comerciales.',
          },
          {
            id: 'INV-002',
            name: 'Bomba sumergible 1HP',
            sku: 'BMP-1HP',
            category: 'equipment',
            qty: 2,
            unit: 'pieza',
            reorderPoint: 3,
            status: 'low',
            location: 'Rack E-04',
            vendor: 'Grainger',
            cost: 780,
            lastRestock: '2024-11-18',
            notes: 'Reservadas para emergencias.',
          },
          {
            id: 'INV-003',
            name: 'Kit reparación válvulas 2"',
            sku: 'KIT-V2',
            category: 'kits',
            qty: 18,
            unit: 'kit',
            reorderPoint: 10,
            status: 'ok',
            location: 'Bodega Centro',
            vendor: 'Zurn',
            cost: 65,
            lastRestock: '2025-01-05',
            notes: 'Incluye empaques y resortes.',
          },
          {
            id: 'INV-004',
            name: 'Anillos de hule 2"',
            sku: 'OR-200',
            category: 'consumables',
            qty: 45,
            unit: 'bolsa (25)',
            reorderPoint: 60,
            status: 'low',
            location: 'Bodega Norte',
            vendor: 'Home Depot Pro',
            cost: 18,
            lastRestock: '2024-12-10',
            notes: 'Empaques para reparación rápida.',
          },
          {
            id: 'INV-005',
            name: 'Detector portátil de gas',
            sku: 'SAFE-GAS',
            category: 'safety',
            qty: 6,
            unit: 'pieza',
            reorderPoint: 4,
            status: 'ok',
            location: 'Locker seguridad',
            vendor: 'Fluke',
            cost: 420,
            lastRestock: '2024-10-22',
            notes: 'Calibración cada 6 meses.',
          },
          {
            id: 'INV-006',
            name: 'Soplador de línea 3"',
            sku: 'EQP-03',
            category: 'equipment',
            qty: 1,
            unit: 'pieza',
            reorderPoint: 2,
            status: 'critical',
            location: 'Patio principal',
            vendor: 'RIDGID',
            cost: 2150,
            lastRestock: '2024-09-15',
            notes: 'Equipo asignado a cuadrilla norte.',
          },
          {
            id: 'INV-007',
            name: 'Codo cobre 3/4"',
            sku: 'COP-ELB34',
            category: 'materials',
            qty: 220,
            unit: 'pieza',
            reorderPoint: 150,
            status: 'ok',
            location: 'Pasillo C',
            vendor: 'Winsupply',
            cost: 4.2,
            lastRestock: '2025-01-08',
            notes: 'Empaque de 25 piezas.',
          },
          {
            id: 'INV-008',
            name: 'Sellador roscas PTFE',
            sku: 'CONS-PTFE',
            category: 'consumables',
            qty: 28,
            unit: 'tubo',
            reorderPoint: 40,
            status: 'low',
            location: 'Bodega Centro',
            vendor: 'Oatey',
            cost: 9.5,
            lastRestock: '2024-12-18',
            notes: 'Para instalaciones de gas y agua.',
          },
          {
            id: 'INV-009',
            name: 'Guantes nitrilo 8mil',
            sku: 'SAFE-NIT-8',
            category: 'safety',
            qty: 14,
            unit: 'caja (50)',
            reorderPoint: 20,
            status: 'low',
            location: 'Locker seguridad',
            vendor: 'Fastenal',
            cost: 26,
            lastRestock: '2024-11-30',
            notes: 'Uso obligatorio en mantenimiento HVAC.',
          },
          {
            id: 'INV-010',
            name: 'Cámara inspección 200ft',
            sku: 'EQP-CAM200',
            category: 'equipment',
            qty: 2,
            unit: 'pieza',
            reorderPoint: 1,
            status: 'ok',
            location: 'Patio principal',
            vendor: 'Vivax',
            cost: 4860,
            lastRestock: '2024-01-18',
            notes: 'Asignada a equipo diagnóstico.',
          },
          {
            id: 'INV-011',
            name: 'Kit gas leak emergency',
            sku: 'KIT-GAS',
            category: 'kits',
            qty: 5,
            unit: 'kit',
            reorderPoint: 5,
            status: 'critical',
            location: 'Camión 02',
            vendor: 'Victaulic',
            cost: 195,
            lastRestock: '2024-10-05',
            notes: 'Contiene pinzas, tapones y selladores.',
          },
          {
            id: 'INV-012',
            name: 'Ánodo para boiler 40gal',
            sku: 'MAT-AN40',
            category: 'materials',
            qty: 12,
            unit: 'pieza',
            reorderPoint: 8,
            status: 'ok',
            location: 'Bodega Sur',
            vendor: 'State Water Heaters',
            cost: 42,
            lastRestock: '2025-01-02',
            notes: 'Repuesto para contratos residenciales.',
          },
        ];
        const fleetSeeds = [
          {
            id: 'TRK-01',
            name: 'Van Norte 01',
            plate: 'TX-4821',
            lead: 'Marco Tech',
            leadRole: 'Lead Technician',
            capacityUsed: 68,
            lastService: '2024-12-30',
            loadout: [
              { itemId: 'INV-001', qty: 120 },
              { itemId: 'INV-007', qty: 40 },
              { itemId: 'INV-005', qty: 1 },
            ],
          },
          {
            id: 'TRK-02',
            name: 'Van Centro 07',
            plate: 'CA-2098',
            lead: 'Sara Field',
            leadRole: 'Service Technician',
            capacityUsed: 54,
            lastService: '2024-12-12',
            loadout: [
              { itemId: 'INV-003', qty: 6 },
              { itemId: 'INV-004', qty: 15 },
              { itemId: 'INV-008', qty: 6 },
            ],
          },
          {
            id: 'TRK-03',
            name: 'Van Costa 03',
            plate: 'CA-3186',
            lead: 'Paul Rivera',
            leadRole: 'Labor',
            capacityUsed: 32,
            lastService: '2024-11-25',
            loadout: [
              { itemId: 'INV-009', qty: 4 },
              { itemId: 'INV-012', qty: 3 },
            ],
          },
        ];
        const staffSeeds = [
          {
            id: 'STF-01',
            name: 'Marco Tech',
            category: 'technician',
            role: 'Lead Technician',
            specialization: 'Instalación comercial',
            availability: 'On Call',
            status: 'active',
            hoursWeek: 34,
            hoursMonth: 142,
            location: 'Houston, TX',
            certifications: ['Journeyman', 'OSHA 30'],
            lastJob: 'ORD-101',
            nextShift: 'Mañana · 07:00',
            technicians: ['Marco Tech'],
            labors: ['Luis', 'Iván'],
          },
          {
            id: 'STF-02',
            name: 'Sara Field',
            category: 'technician',
            role: 'Service Technician',
            specialization: 'Mantenimiento HVAC',
            availability: 'En ruta',
            status: 'active',
            hoursWeek: 29,
            hoursMonth: 118,
            location: 'Dallas, TX',
            certifications: ['EPA', 'Backflow'],
            lastJob: 'ORD-102',
            nextShift: 'Hoy · 13:00',
            technicians: ['Sara Field'],
            labors: ['Paul'],
          },
          {
            id: 'STF-03',
            name: 'Paul Rivera',
            category: 'labor',
            role: 'Helper',
            specialization: 'Apoyo general',
            availability: 'Disponible',
            status: 'standby',
            hoursWeek: 18,
            hoursMonth: 72,
            location: 'San Antonio, TX',
            certifications: ['Seguridad básica'],
            lastJob: 'ORD-102',
            nextShift: 'Viernes · 09:00',
            technicians: [],
            labors: ['Paul Rivera'],
          },
        ];
        let ordersMutated = false;
        this.orders = this.loadCollection('orders', orderSeeds).map((order, index) => {
          const normalized = { ...order };
          if (!normalized.id) {
            normalized.id = `ORD-SEED-${index}`;
            ordersMutated = true;
          }
          if (!normalized.projectNumber) {
            normalized.projectNumber = (1000 + index).toString();
            ordersMutated = true;
          }
          if (!normalized.projectName) {
            normalized.projectName = normalized.scope || normalized.service || `Proyecto ${normalized.projectNumber}`;
            ordersMutated = true;
          }
          const ensured = idSyncManager.ensure(normalized.id, normalized.idSync);
          if (normalized.idSync !== ensured) {
            normalized.idSync = ensured;
            ordersMutated = true;
          }
          return normalized;
        });
        if (ordersMutated) {
          this.saveCollection('orders', this.orders);
        }
        this.customers = this.loadCollection('customers', customerSeeds);
        this.quotes = this.loadCollection('quotes', quoteSeeds);
        this.invoices = this.loadCollection('invoices', invoiceSeeds);
        this.inventory = this.loadCollection('inventory', inventorySeeds);
        this.fleet = this.loadCollection('fleet', fleetSeeds);
        this.portalRequests = this.loadCollection('portalRequests', []);
        this.portalInvites = this.loadCollection('portalInvites', []);
        const templateSeeds = [
          {
            id: 'REP-FIN-01',
            name: 'Financial Snapshot',
            category: 'financial',
            dataset: 'orders',
            columns: this.getDefaultDatasetColumns('orders'),
            groupBy: 'status',
            cadence: 'weekly',
            format: 'PDF',
            scope: 'Week-to-date',
          },
          {
            id: 'REP-OPS-01',
            name: 'Operations Pulse',
            category: 'operations',
            dataset: 'orders',
            columns: this.getDefaultDatasetColumns('orders'),
            groupBy: 'priority',
            cadence: 'daily',
            format: 'Dashboard',
            scope: 'Active jobs',
          },
          {
            id: 'REP-TECH-01',
            name: 'Technician Productivity',
            category: 'technicians',
            dataset: 'staff',
            columns: this.getDefaultDatasetColumns('staff'),
            groupBy: 'category',
            cadence: 'monthly',
            format: 'Spreadsheet',
            scope: 'Crew performance',
          },
          {
            id: 'REP-INV-01',
            name: 'Inventory Health',
            category: 'inventory',
            dataset: 'inventory',
            columns: this.getDefaultDatasetColumns('inventory'),
            groupBy: 'status',
            cadence: 'weekly',
            format: 'Spreadsheet',
            scope: 'Low stock + value',
          },
        ];
        const historySeeds = [
          { id: 'HIST-001', templateId: 'REP-FIN-01', name: 'Financial Snapshot', scope: 'May 1-15', format: 'PDF', ranAt: '2025-01-15T09:10:00Z' },
          { id: 'HIST-002', templateId: 'REP-TECH-01', name: 'Technician Productivity', scope: 'Jun Week 2', format: 'XLSX', ranAt: '2025-01-14T18:45:00Z' },
          { id: 'HIST-003', templateId: 'REP-INV-01', name: 'Inventory Health', scope: 'Jun 10', format: 'CSV', ranAt: '2025-01-13T07:30:00Z' },
        ].map((entry) => {
          const template = templateSeeds.find((tpl) => tpl.id === entry.templateId) || templateSeeds[0];
          return {
            ...entry,
            dataset: template.dataset,
            columns: [...(template.columns || [])],
            groupBy: template.groupBy || '',
            snapshot: this.buildReportSnapshot(template),
          };
        });
        this.reportTemplates = this.loadCollection('reportTemplates', templateSeeds);
        this.migrateReportTemplates();
        this.reportHistory = this.loadCollection('reportHistory', historySeeds);
        this.migrateReportHistory();
        this.reportSchedules = this.loadCollection('reportSchedules', [
          {
            id: 'SCH-001',
            templateId: 'REP-FIN-01',
            templateName: 'Financial Snapshot',
            cadence: 'weekly',
            recipients: ['finance@opsis.com'],
            nextRun: '2025-01-22T08:00:00Z',
            paused: false,
          },
          {
            id: 'SCH-002',
            templateId: 'REP-OPS-01',
            templateName: 'Operations Pulse',
            cadence: 'daily',
            recipients: ['dispatch@opsis.com', 'ana@opsis.com'],
            nextRun: '2025-01-17T06:30:00Z',
            paused: false,
          },
        ]);
        this.purchaseSuppliers = this.loadCollection('purchaseSuppliers', [
          { id: 'SUP-001', name: 'Ferguson', contact: 'Laura Sales', email: 'orders@ferguson.com' },
          { id: 'SUP-002', name: 'Grainger', contact: 'Ben Ops', email: 'support@grainger.com' },
          { id: 'SUP-003', name: 'Home Depot Pro', contact: 'HD Pro', email: 'prodesk@homedepot.com' },
        ]);
        this.purchaseProducts = this.loadCollection('purchaseProducts', [
          { id: 'PO-PVC-12', vendorId: 'SUP-001', sku: 'PVC-100', name: 'Tubo PVC 1"', price: 2.15 },
          { id: 'PO-ELB-34', vendorId: 'SUP-001', sku: 'COP-ELB34', name: 'Codo cobre 3/4"', price: 4.2 },
          { id: 'PO-BMB-1', vendorId: 'SUP-002', sku: 'BMP-1HP', name: 'Bomba sumergible 1HP', price: 780 },
          { id: 'PO-SEAL', vendorId: 'SUP-003', sku: 'CONS-PTFE', name: 'Sellador roscas PTFE', price: 9.5 },
        ]);
        this.purchaseOrders = this.loadCollection('purchaseOrders', [
          {
            id: 'PO-240610',
            vendorId: 'SUP-001',
            vendorName: 'Ferguson',
            vendorEmail: 'orders@ferguson.com',
            date: '2025-01-10T09:00:00Z',
            status: 'draft',
            jobNumber: '20240610',
            notes: 'Reposición PVC Houston',
            total: 820,
            items: [
              { sku: 'PVC-100', name: 'Tubo PVC 1"', qty: 250, price: 2.15, subtotal: 537.5 },
              { sku: 'COP-ELB34', name: 'Codo cobre 3/4"', qty: 60, price: 4.2, subtotal: 252 },
              { sku: 'CONS-PTFE', name: 'Sellador roscas PTFE', qty: 3, price: 10.5, subtotal: 31.5 },
            ],
          },
        ]);
        this.staffRecords = this.loadCollection('staff', staffSeeds);
        this.reportDatasetDefaults = storage.get(STORAGE_KEYS.reportDatasetDefaults, {}) || {};
        if (typeof this.reportDatasetDefaults !== 'object') {
          this.reportDatasetDefaults = {};
        }

        this.orders.forEach((order) => {
          order.serviceId = this.findServiceIdByLabel(order.service) || order.serviceId || (this.SERVICE_LIBRARY[0]?.id || '');
          const team = this.getServiceDefinition(order.serviceId) || {};
          const crewArray = Array.isArray(order.crew) ? [...order.crew] : [];
          if (!order.technicians || !order.technicians.length) {
            if (order.crewLead) {
              order.technicians = [order.crewLead];
            } else if (team.technicians) {
              order.technicians = [...team.technicians];
            } else {
              order.technicians = [];
            }
          }
          if (!order.labors || !order.labors.length) {
            if (crewArray.length) {
              order.labors = crewArray.filter((name) => !order.technicians.includes(name));
            } else if (team.labor) {
              order.labors = [...team.labor];
            } else {
              order.labors = [];
            }
          }
          if (!order.crewLead && order.technicians.length) {
            [order.crewLead] = order.technicians;
          }
          if (!order.crew || !order.crew.length) {
            order.crew = [...order.labors];
          }
        });

        const userSeeds = [
          {
            id: 'USR-001',
            name: 'Ana Owner',
            email: 'ana@opsis.com',
            role: 'owner',
            status: 'active',
            mfa: true,
            phone: '+1 (858) 555-2010',
            department: 'Dirección',
            lastActive: '2025-01-16T14:20:00Z',
          },
          {
            id: 'USR-002',
            name: 'Leo Admin',
            email: 'leo@opsis.com',
            role: 'admin',
            status: 'active',
            mfa: true,
            phone: '+1 (512) 555-1830',
            department: 'Operaciones',
            lastActive: '2025-01-15T18:45:00Z',
          },
          {
            id: 'USR-003',
            name: 'María Compliance',
            email: 'compliance@opsis.com',
            role: 'admin',
            status: 'away',
            mfa: false,
            phone: '+1 (213) 555-0477',
            department: 'Compliance',
            lastActive: '2025-01-10T11:05:00Z',
          },
          {
            id: 'USR-004',
            name: 'Marco Tech',
            email: 'marco@opsis.com',
            role: 'tech',
            status: 'active',
            mfa: false,
            phone: '+1 (832) 555-9980',
            department: 'Field Service',
            lastActive: '2025-01-12T08:30:00Z',
          },
        ];
        const adminInviteSeeds = [
          {
            id: 'INVITE-001',
            name: 'Marta Ops',
            email: 'marta@opsis.com',
            role: 'admin',
            tempPassword: 'Ops-12345',
            status: 'pending',
            sentAt: '2025-01-13T09:00:00Z',
            expiresAt: '2025-01-20T09:00:00Z',
          },
          {
            id: 'INVITE-002',
            name: 'Jorge Finance',
            email: 'jorge@opsis.com',
            role: 'tech',
            tempPassword: 'Ops-67890',
            status: 'pending',
            sentAt: '2025-01-12T16:30:00Z',
            expiresAt: '2025-01-19T16:30:00Z',
          },
        ];
        const adminActivitySeeds = [
          {
            id: 'ACT-001',
            actor: 'Ana Owner',
            action: 'managementActivityRoleChange',
            target: 'Leo Admin',
            detail: 'Owner → Admin',
            timestamp: '2025-01-14T17:20:00Z',
          },
          {
            id: 'ACT-002',
            actor: 'Leo Admin',
            action: 'managementActivityInvite',
            target: 'Marta Ops',
            detail: 'Invitación enviada',
            timestamp: '2025-01-13T09:00:00Z',
          },
          {
            id: 'ACT-003',
            actor: 'Ana Owner',
            action: 'managementActivitySecurity',
            target: 'Portal Opsis',
            detail: 'Reforzó MFA obligatorio',
            timestamp: '2025-01-11T12:40:00Z',
          },
        ];
        this.users = this.loadCollection('users', userSeeds);
        this.adminInvites = this.loadCollection('adminInvites', adminInviteSeeds);
        this.adminActivity = this.loadCollection('adminActivity', adminActivitySeeds);
        const storedNotificationPrefs = storage.get(STORAGE_KEYS.notificationPrefs, null);
        this.notificationPrefs = this.normalizeNotificationPrefs(storedNotificationPrefs);
        storage.set(STORAGE_KEYS.notificationPrefs, this.notificationPrefs);

        const storedSettings = storage.get(STORAGE_KEYS.settings, null);
        this.settings = storedSettings ? { ...this.DEFAULT_SETTINGS, ...storedSettings } : { ...this.DEFAULT_SETTINGS };
        this.currentLanguage = this.settings.language || this.DEFAULT_SETTINGS.language;
        this.currentTheme = this.settings.theme || this.DEFAULT_SETTINGS.theme;
        this.currentAccent = this.settings.accent || this.DEFAULT_SETTINGS.accent;
        this.applyTheme(this.currentTheme);
        this.applyAccent(this.currentAccent);
        this.saveSettings();
        this.currentRole = storage.get(STORAGE_KEYS.role, this.currentRole);
        storage.set(STORAGE_KEYS.role, this.currentRole);
        if (['client', 'contractor'].includes(this.currentRole)) {
          window.location.href = this.currentRole === 'client' ? 'client-portal.html' : 'contractor-portal.html';
          return;
        }
      },

      bindUI() {
        const sidebar = document.getElementById('sidebar');
        const appShell = document.querySelector('.app-shell');
        
        // Expandir sidebar temporalmente al hacer hover cuando está colapsado
        let hoverTimeout;
        sidebar.addEventListener('mouseenter', () => {
          if (sidebar.classList.contains('collapsed')) {
            clearTimeout(hoverTimeout);
            sidebar.classList.add('hover-expanded');
          }
        });
        
        sidebar.addEventListener('mouseleave', () => {
          if (sidebar.classList.contains('collapsed')) {
            hoverTimeout = setTimeout(() => {
              sidebar.classList.remove('hover-expanded');
            }, 300);
          }
        });
        
        document.querySelectorAll('.sidebar-item').forEach((item) => {
          // Skip navigation links - they handle their own navigation
          if (item.hasAttribute('data-nav') || item.tagName === 'A') {
            console.log('✓ Skipping navigation link:', item.textContent.trim());
            return;
          }
          
          if (item.dataset.external) {
            item.addEventListener('click', () => {
              window.location.href = item.dataset.external;
            });
          } else if (item.dataset.page) {
            item.addEventListener('click', () => {
              console.log('Navegando a:', item.dataset.page);
              
              // Remover hover-expanded inmediatamente
              sidebar.classList.remove('hover-expanded');
              
              // Colapsar sidebar para todas las páginas excepto Dashboard
              if (item.dataset.page === 'dashboard') {
                sidebar.classList.remove('collapsed');
                appShell.classList.remove('sidebar-collapsed');
              } else {
                sidebar.classList.add('collapsed');
                appShell.classList.add('sidebar-collapsed');
              }
              
              this.showPage(item.dataset.page);
            });
          }
        });
        document.getElementById('language-select').addEventListener('change', (e) => {
          this.currentLanguage = e.target.value;
          this.settings.language = this.currentLanguage;
          this.saveSettings();
          this.translatePage();
        });
        document.getElementById('theme-select').addEventListener('change', (e) => {
          const theme = e.target.value;
          this.applyTheme(theme);
          this.settings.theme = theme;
          this.saveSettings();
        });
        document.getElementById('accent-picker').addEventListener('input', (e) => {
          const color = e.target.value;
          this.applyAccent(color);
          this.settings.accent = color;
          this.saveSettings();
        });
        document.querySelectorAll('[data-schedule-range]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const range = btn.dataset.scheduleRange;
            if (this.scheduleRange === range) return;
            this.scheduleRange = range;
            this.renderSchedule();
          });
        });
        document.querySelectorAll('[data-schedule-mode]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const mode = btn.dataset.scheduleMode;
            if (this.scheduleMode === mode) return;
            this.scheduleMode = mode;
            this.renderSchedule();
          });
        });
        document.getElementById('btn-new-customer').addEventListener('click', () => this.openCustomerModal());
        document.getElementById('btn-new-quote').addEventListener('click', () => this.openQuoteModal());
        const addItemBtn = document.getElementById('btn-add-item');
        if (addItemBtn) {
          addItemBtn.addEventListener('click', () => this.openInventoryModal());
        }
        const newManagerBtn = document.getElementById('btn-new-manager');
        if (newManagerBtn) {
          newManagerBtn.addEventListener('click', () => this.openAdminModal('add'));
        }
        document.getElementById('schedule-prev').addEventListener('click', () => this.navigateSchedule(-1));
        document.getElementById('schedule-next').addEventListener('click', () => this.navigateSchedule(1));
        document.getElementById('modal-close').addEventListener('click', () => this.closeModal());
        document.getElementById('modal-form').addEventListener('click', (e) => {
          if (e.target.id === 'modal-form') this.closeModal();
        });
        const searchOrders = document.getElementById('search-orders');
        if (searchOrders) {
          searchOrders.addEventListener('input', (e) => {
            this.ordersSearch = e.target.value;
            this.renderOrders();
          });
        }
        document.querySelectorAll('[data-orders-filter]').forEach((btn) => {
          btn.addEventListener('click', () => {
            this.ordersStatusFilter = btn.dataset.ordersFilter || 'all';
            this.renderOrders();
          });
        });
        const customersSearchInput = document.getElementById('customers-search');
        if (customersSearchInput) {
          customersSearchInput.addEventListener('input', (e) => {
            this.customersSearch = e.target.value;
            this.renderCustomers();
          });
        }
        document.querySelectorAll('[data-customer-filter]').forEach((btn) => {
          btn.addEventListener('click', () => {
            this.customersFilter = btn.dataset.customerFilter || 'all';
            this.renderCustomers();
          });
        });
        this.updateCustomerFilterChips();
        const createOrderBtn = document.getElementById('btn-create-order');
        if (createOrderBtn) {
          createOrderBtn.addEventListener('click', () => this.startNewOrderFlow());
        }

        const companyInput = document.getElementById('settings-company');
        if (companyInput) {
          companyInput.addEventListener('input', (e) => {
            this.settings.companyName = e.target.value;
            this.saveSettings();
            this.renderTenantBadge();
          });
        }
        const staffSearchInput = document.getElementById('staff-search');
        if (staffSearchInput) {
          staffSearchInput.addEventListener('input', (e) => {
            this.staffSearch = e.target.value;
            this.renderStaff();
          });
        }
        document.querySelectorAll('[data-staff-filter]').forEach((btn) => {
          btn.addEventListener('click', () => {
            this.staffFilter = btn.dataset.staffFilter || 'all';
            this.renderStaff();
          });
        });
        const newStaffBtn = document.getElementById('btn-new-staff');
        if (newStaffBtn) {
          newStaffBtn.addEventListener('click', () => this.openStaffModal());
        }
        const billingSearchInput = document.getElementById('billing-search');
        if (billingSearchInput) {
          billingSearchInput.addEventListener('input', (e) => {
            this.billingSearch = e.target.value;
            this.renderQuotes();
          });
        }
        const exportQuotesBtn = document.getElementById('btn-export-quotes');
        if (exportQuotesBtn) {
          exportQuotesBtn.addEventListener('click', () => alert('Exportación disponible pronto.'));
        }
        const sendBillingBtn = document.getElementById('btn-send-billing');
        if (sendBillingBtn) {
          sendBillingBtn.addEventListener('click', () => alert('Resumen enviado (demo).'));
        }
        const inventorySearchInput = document.getElementById('inventory-search');
        if (inventorySearchInput) {
          inventorySearchInput.addEventListener('input', (e) => {
            this.inventorySearch = e.target.value;
            this.renderInventory();
          });
        }
        document.querySelectorAll('[data-inventory-filter]').forEach((btn) => {
          btn.addEventListener('click', () => {
            this.inventoryFilter = btn.dataset.inventoryFilter || 'all';
            this.updateInventoryFilterChips();
            this.renderInventory();
          });
        });
        document.querySelectorAll('[data-inventory-view]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const view = btn.dataset.inventoryView || 'cards';
            if (view === this.inventoryView) return;
            this.inventoryView = view;
            this.updateInventoryViewControls();
            this.renderInventory();
          });
        });
        const inventoryExportBtn = document.getElementById('btn-inventory-export');
        if (inventoryExportBtn) {
          inventoryExportBtn.addEventListener('click', () => this.exportInventoryCsv());
        }
        const inventoryPOBtn = document.getElementById('inventory-generate-po');
        if (inventoryPOBtn) {
          inventoryPOBtn.addEventListener('click', () => this.openPurchaseOrderModal());
        }
        const manageFleetBtn = document.getElementById('inventory-manage-fleet');
        if (manageFleetBtn) {
          manageFleetBtn.addEventListener('click', () => this.openFleetModal());
        }
        document.querySelectorAll('[data-report-category]').forEach((btn) => {
          btn.addEventListener('click', () => {
            this.reportsCategory = btn.dataset.reportCategory || 'overview';
            this.renderReportsPage();
          });
        });
        document.querySelectorAll('[data-report-range]').forEach((btn) => {
          btn.addEventListener('click', () => {
            this.reportsRange = btn.dataset.reportRange || 'week';
            this.renderReportsPage();
          });
        });
        const reportExportBtn = document.getElementById('btn-report-export');
        if (reportExportBtn) {
          reportExportBtn.addEventListener('click', () => alert('Exportación consolidada disponible próximamente.'));
        }
        const reportScheduleBtn = document.getElementById('btn-report-schedule');
        if (reportScheduleBtn) {
          reportScheduleBtn.addEventListener('click', () => this.openReportScheduleModal());
        }
        const reportBuilderBtn = document.getElementById('btn-report-builder');
        if (reportBuilderBtn) {
          reportBuilderBtn.addEventListener('click', () => this.openReportBuilder());
        }
        const reportHistoryExport = document.getElementById('btn-reports-history-export');
        if (reportHistoryExport) {
          reportHistoryExport.addEventListener('click', () => this.exportReportHistory());
        }
        const addScheduleBtn = document.getElementById('btn-add-schedule');
        if (addScheduleBtn) {
          addScheduleBtn.addEventListener('click', () => this.openReportScheduleModal());
        }
        const portalInviteForm = document.getElementById('portal-invite-form');
        if (portalInviteForm && !portalInviteForm.dataset.bound) {
          portalInviteForm.addEventListener('submit', (event) => {
            event.preventDefault();
            this.createPortalInvite();
          });
          portalInviteForm.dataset.bound = 'true';
        }
        const adminInviteForm = document.getElementById('admin-invite-form');
        if (adminInviteForm && !adminInviteForm.dataset.bound) {
          adminInviteForm.addEventListener('submit', (event) => {
            event.preventDefault();
            this.createAdminInvite();
          });
          adminInviteForm.dataset.bound = 'true';
        }
        const poCreateBtn = document.getElementById('btn-po-create');
        if (poCreateBtn) {
          poCreateBtn.addEventListener('click', () => this.openPurchaseOrderWizard());
        }
        const phoneInput = document.getElementById('settings-phone');
        if (phoneInput) {
          phoneInput.addEventListener('input', (e) => {
            this.settings.phone = e.target.value;
            this.saveSettings();
          });
        }
        const emailInput = document.getElementById('settings-email');
        if (emailInput) {
          emailInput.addEventListener('input', (e) => {
            this.settings.email = e.target.value;
            this.saveSettings();
          });
        }
        const managementSearch = document.getElementById('management-search');
        if (managementSearch) {
          managementSearch.addEventListener('input', (e) => {
            this.managementSearch = e.target.value;
            this.renderManagement();
          });
        }
        const managementRoleFilter = document.getElementById('management-role-filter');
        if (managementRoleFilter) {
          managementRoleFilter.addEventListener('change', (e) => {
            this.managementRoleFilter = e.target.value || 'all';
            this.renderManagement();
          });
        }
        const paletteSelect = document.getElementById('settings-palette');
        if (paletteSelect) {
          paletteSelect.addEventListener('change', (e) => {
            const palette = e.target.value;
            this.settings.palette = palette;
            this.applyPaletteChoice(palette);
            this.saveSettings();
          });
        }
        const saveSettingsBtn = document.getElementById('btn-settings-save');
        if (saveSettingsBtn) {
          saveSettingsBtn.addEventListener('click', () => {
            this.saveSettings();
            this.showNotification(this.t('settingsSaveSuccess'), 'success');
          });
        }
        const resetDemoBtn = document.getElementById('btn-reset-demo');
        if (resetDemoBtn) {
          resetDemoBtn.addEventListener('click', () => this.resetDemoData());
        }
        const notificationTable = document.getElementById('notification-settings-table');
        if (notificationTable && !notificationTable.dataset.bound) {
          notificationTable.addEventListener('change', (event) => {
            const target = event.target;
            if (!target.matches('input[type="checkbox"][data-role][data-channel]')) return;
            this.updateNotificationPref(target.dataset.role, target.dataset.channel, target.checked);
          });
          notificationTable.dataset.bound = 'true';
        }
        const saveNotificationsBtn = document.getElementById('btn-save-notifications');
        if (saveNotificationsBtn && !saveNotificationsBtn.dataset.bound) {
          saveNotificationsBtn.addEventListener('click', () => {
            this.saveNotificationPrefs();
            this.showNotification(this.t('settingsNotificationsSaved'), 'success');
          });
          saveNotificationsBtn.dataset.bound = 'true';
        }
        const roleAddBtn = document.getElementById('btn-role-add');
        if (roleAddBtn) {
          roleAddBtn.addEventListener('click', () => this.openRoleModal('add'));
        }
        const roleEditBtn = document.getElementById('btn-role-edit');
        if (roleEditBtn) {
          roleEditBtn.addEventListener('click', () => this.openRoleModal('edit', this.selectedRoleId));
        }
        const roleDuplicateBtn = document.getElementById('btn-role-duplicate');
        if (roleDuplicateBtn) {
          roleDuplicateBtn.addEventListener('click', () => this.duplicateRole());
        }
        this.initRoleSwitcher();
      },

      hydrateSettingsForm() {
        const settings = this.settings || this.DEFAULT_SETTINGS;
        const companyInput = document.getElementById('settings-company');
        if (companyInput) {
          companyInput.value = settings.companyName || '';
        }
        const phoneInput = document.getElementById('settings-phone');
        if (phoneInput) {
          phoneInput.value = settings.phone || '';
        }
        const emailInput = document.getElementById('settings-email');
        if (emailInput) {
          emailInput.value = settings.email || '';
        }
        const paletteSelect = document.getElementById('settings-palette');
        if (paletteSelect) {
          paletteSelect.value = settings.palette || 'blue';
        }
        const languageSelect = document.getElementById('language-select');
        if (languageSelect) {
          languageSelect.value = this.currentLanguage;
        }
        const themeSelect = document.getElementById('theme-select');
        if (themeSelect) {
          themeSelect.value = this.currentTheme || 'light';
        }
        const accentPicker = document.getElementById('accent-picker');
        if (accentPicker) {
          accentPicker.value = this.currentAccent || '#02735E';
        }
      },

      renderTenantBadge() {
        const tenantLabel = document.getElementById('tenant-name');
        if (tenantLabel) {
          const company = (this.settings && this.settings.companyName ? this.settings.companyName : '').trim();
          tenantLabel.textContent = company || 'Tu compañía';
        }
      },

      resetDemoData() {
        const message = this.t('resetDemoConfirm') || 'Reset demo data?';
        if (!window.confirm(message)) return;
        storage.clearAll();
        this.ordersStatusFilter = 'all';
        this.customersFilter = 'all';
        this.staffFilter = 'all';
        this.inventoryFilter = 'all';
        this.inventoryView = 'cards';
        this.inventorySearch = '';
        this.selectedCustomerId = null;
        this.selectedOrderId = null;
        this.selectedStaffId = null;
        this.seedData();
        this.translatePage();
      },

      translatePage() {
        document.querySelectorAll('[data-i18n]').forEach((node) => {
          const key = node.getAttribute('data-i18n');
          node.textContent = this.t(key);
        });
        this.renderAll();
      },

      t(key) {
        return this.translations[this.currentLanguage][key] || key;
      },

      applyTheme(theme) {
        this.currentTheme = theme;
        const shell = document.querySelector('.app-shell');
        if (shell) {
          shell.dataset.theme = theme;
        }
        document.documentElement.dataset.theme = theme;
      },

      applyAccent(color) {
        this.currentAccent = color;
        document.documentElement.style.setProperty('--primary-color', color);
        const accentPicker = document.getElementById('accent-picker');
        if (accentPicker && accentPicker.value !== color) {
          accentPicker.value = color;
        }
      },

      applyPaletteChoice(palette) {
        const presets = {
          blue: '#02735E',
          orange: '#ff922b',
          green: '#035951',
        };
        const color = presets[palette] || palette;
        if (color) {
          this.applyAccent(color);
        }
      },

      saveSettings() {
        const normalized = {
          ...this.DEFAULT_SETTINGS,
          ...this.settings,
          language: this.currentLanguage,
          theme: this.currentTheme,
          accent: this.currentAccent,
        };
        this.settings = normalized;
        storage.set(STORAGE_KEYS.settings, normalized);
        this.renderSettingsKpis();
      },

      saveNotificationPrefs() {
        this.notificationPrefs = this.normalizeNotificationPrefs(this.notificationPrefs);
        storage.set(STORAGE_KEYS.notificationPrefs, this.notificationPrefs);
      },

      updateNotificationPref(role, channel, enabled) {
        if (!role || !channel) return;
        const validChannels = this.getNotificationChannelsConfig().map((ch) => ch.id);
        if (!validChannels.includes(channel)) return;
        if (!this.notificationPrefs || typeof this.notificationPrefs !== 'object') {
          this.notificationPrefs = this.normalizeNotificationPrefs({});
        }
        if (!this.notificationPrefs[role]) {
          const defaults = this.getDefaultNotificationPrefs();
          this.notificationPrefs[role] = defaults[role]
            ? { ...defaults[role] }
            : { email: false, sms: false, inApp: false };
        }
        this.notificationPrefs[role][channel] = !!enabled;
      },

      renderNotificationPrefsTable() {
        const tableBody = document.getElementById('notification-settings-table');
        if (!tableBody) return;
        const roles = this.getNotificationRolesConfig();
        const channels = this.getNotificationChannelsConfig();
        const prefs =
          this.notificationPrefs && typeof this.notificationPrefs === 'object'
            ? this.notificationPrefs
            : this.getDefaultNotificationPrefs();
        const rows = roles
          .map(({ id, labelKey }) => {
            const label = this.t(labelKey) || labelKey;
            const safeLabel = this.escapeHtml(label);
            const rolePrefs = prefs[id] || {};
            const cells = channels
              .map(({ id: channelId, labelKey: channelLabelKey }) => {
                const channelLabel = this.t(channelLabelKey) || channelLabelKey;
                const aria = `${label} ${channelLabel}`;
                const checkedAttr = rolePrefs[channelId] ? 'checked' : '';
                return `<td><input type="checkbox" data-role="${id}" data-channel="${channelId}" aria-label="${this.escapeHtml(
                  aria
                )}" ${checkedAttr}></td>`;
              })
              .join('');
            return `<tr><td>${safeLabel}</td>${cells}</tr>`;
          })
          .join('');
        tableBody.innerHTML = rows;
      },

      getPageLabel(page) {
        const map = {
          dashboard: this.t('dashboard'),
          projectsync: 'ProjectSync',
          customers: this.t('customers'),
          management: this.t('management'),
          roles: this.t('roles'),
          settings: this.t('settings'),
          toolsync: this.t('toolsync'),
        };
        return map[page] || this.formatLabel(page);
      },

      renderRoleAccessMatrix() {
        const body = document.getElementById('role-access-table');
        if (!body) return;
        const rows = Object.entries(ROLE_ACCESS)
          .map(([roleKey, config]) => {
            const label = this.escapeHtml(this.formatLabel(roleKey));
            const pages = (config.pages || [])
              .map((page) => `<span class="role-access-badge">${this.escapeHtml(this.getPageLabel(page))}</span>`)
              .join('') || '—';
            const canInvite = this.hasCapability('portal.invite', roleKey);
            const inviteLabel = this.t(canInvite ? 'settingsRoleAccessInvitesYes' : 'settingsRoleAccessInvitesNo');
            return `<tr><td>${label}</td><td>${pages}</td><td>${inviteLabel}</td></tr>`;
          })
          .join('');
        body.innerHTML = rows;
      },

      renderAll() {
        this.enforceRoleAccess();
        this.renderDashboard();
        this.renderProjectSync();
        this.renderSchedule();
        this.renderOrders();
        this.renderQuotes();
        this.renderCustomers();
        this.renderStaff();
        this.renderInventory();
        this.renderReportsPage();
        this.renderManagement();
        this.renderRoles();
        this.renderSettingsKpis();
        this.hydrateSettingsForm();
        this.renderNotificationPrefsTable();
        this.renderRoleAccessMatrix();
        this.renderTenantBadge();
        this.updateRoleSwitcher();
        this.syncCapabilityVisibility();
      },

      findOrderByKey(identifier) {
        if (!identifier || !Array.isArray(this.orders)) return null;
        const key = identifier.toString();
        return this.orders.find(
          (order) =>
            order.id === key ||
            (order.projectNumber && order.projectNumber.toString() === key) ||
            order.idSync === key ||
            order.projectName === key
        );
      },

      renderProjectSync() {
        if (!Array.isArray(this.orders)) return;
        let mutated = false;
        this.orders = this.orders.map((order, index) => {
          const normalized = { ...order };
          if (!normalized.id) {
            normalized.id = `ORD-SEED-${index}`;
            mutated = true;
          }
          if (!normalized.projectNumber) {
            normalized.projectNumber = (1000 + index).toString();
            mutated = true;
          }
          if (!normalized.projectName) {
            normalized.projectName = normalized.scope || normalized.service || `Proyecto ${normalized.projectNumber}`;
            mutated = true;
          }
          const ensured = idSyncManager.ensure(normalized.id, normalized.idSync);
          if (normalized.idSync !== ensured) {
            normalized.idSync = ensured;
            mutated = true;
          }
          return normalized;
        });
        if (mutated) {
          this.saveCollection('orders', this.orders);
        }

        const formatIdSync = (order) => (order?.idSync ? order.idSync : '────────');

        document.querySelectorAll('[data-order-idsync]').forEach((el) => {
          const order = this.findOrderByKey(el.dataset.orderIdsync);
          if (order) {
            el.textContent = formatIdSync(order);
          }
        });

        document.querySelectorAll('[data-order-projectcode]').forEach((el) => {
          const order = this.findOrderByKey(el.dataset.orderProjectcode);
          if (order) {
            el.textContent = `Proyecto #${order.projectNumber}`;
          }
        });

        document.querySelectorAll('[data-order-idsync-badge]').forEach((el) => {
          const order = this.findOrderByKey(el.dataset.orderIdsyncBadge);
          if (order) {
            el.textContent = formatIdSync(order);
          }
        });

        document.querySelectorAll('[data-order-idsync-inline]').forEach((el) => {
          const order = this.findOrderByKey(el.dataset.orderIdsyncInline);
          if (order) {
            el.textContent = formatIdSync(order);
          }
        });
      },

      renderDashboard() {
        const summaryEl = document.getElementById('dashboard-summary');
        if (!summaryEl) return;
        const metrics = this.getRoleDashboardPresentation();
        summaryEl.innerHTML = metrics.cards
          .map(
            (card) => `
          <div class="summary-card ${card.className}">
            <div class="summary-card-label">${card.label}</div>
            <div class="summary-card-value">${card.value}</div>
            <div class="summary-card-trend">${card.trend}</div>
            <div class="summary-card-detail">${card.detail}</div>
          </div>`
          )
          .join('');
        this.renderRoleContextBanner(metrics.context);

        const dateLabel = document.getElementById('dashboard-date');
        if (dateLabel) {
          dateLabel.textContent = new Intl.DateTimeFormat(this.getLocale(), {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
          }).format(new Date());
        }

        const snapshotEl = document.getElementById('dashboard-snapshot-body');
        if (snapshotEl) {
          snapshotEl.innerHTML = (metrics.snapshotRows || [])
            .map(
              (row) => `
            <div class="snapshot-row">
              <span>${row.label}</span>
              <strong>${row.value}</strong>
            </div>`
            )
            .join('');
        }

        const priorityEl = document.getElementById('dashboard-priority-body');
        if (priorityEl) {
          priorityEl.innerHTML = (metrics.priorityEntries || [])
            .map(
              (entry) => `
            <li>
              <span>${entry.label}</span>
              <strong>${entry.value}</strong>
            </li>`
            )
            .join('');
        }

        const mapPanel = document.querySelector('.dashboard-map-panel');
        if (mapPanel) {
          mapPanel.style.display = metrics.showMap ? '' : 'none';
        }
        if (metrics.showMap) {
          this.bindMapFilters();
          setTimeout(() => {
            this.initMap();
            this.updateMap(this.currentMapFilter);
          }, 100);
        }
      },

      renderRoleContextBanner(context) {
        const banner = document.getElementById('dashboard-role-context');
        if (!banner) return;
        if (!context) {
          banner.classList.remove('active');
          banner.innerHTML = '';
          return;
        }
        banner.classList.add('active');
        banner.innerHTML = `
          <div>
            <strong>${context.title}</strong>
            <div class="role-context-meta">${context.meta || ''}</div>
          </div>
          <div class="role-context-meta">${context.nextLabel || ''}</div>`;
      },

      calculateDashboardMetrics() {
        const completedStatuses = new Set(['job_done', 'paid', 'invoiced', 'completed', 'archived']);
        const activeStatuses = new Set(['scheduled', 'en_route', 'on_site']);
        const counts = { completed: 0, active: 0, upcoming: 0 };
        const priority = { high: 0, normal: 0, low: 0, future: 0 };
        let revenue = 0;

        this.orders.forEach((order) => {
          revenue += order.total || 0;
          const priorityKey = ['high', 'normal', 'low', 'future'].includes(order.priority) ? order.priority : 'normal';
          priority[priorityKey] = (priority[priorityKey] || 0) + 1;

          if (completedStatuses.has(order.status)) {
            counts.completed += 1;
          } else if (order.future || order.status === 'draft') {
            counts.upcoming += 1;
          } else if (activeStatuses.has(order.status)) {
            counts.active += 1;
          } else {
            counts.active += 1;
          }
        });

        const totalOrders = this.orders.length || 1;
        const cards = [
          {
            className: 'completed',
            label: this.t('summaryDone'),
            value: counts.completed,
            detail: this.t('summaryDoneHint'),
            trend: `${counts.completed || 0} ${this.t('summaryDoneTrend')}`,
          },
          {
            className: 'active',
            label: this.t('summaryDoing'),
            value: counts.active,
            detail: this.t('summaryDoingHint'),
            trend: `${counts.active || 0} ${this.t('summaryDoingTrend')}`,
          },
          {
            className: 'upcoming',
            label: this.t('summaryUpcoming'),
            value: counts.upcoming,
            detail: this.t('summaryUpcomingHint'),
            trend: `${counts.upcoming || 0} ${this.t('summaryUpcomingTrend')}`,
          },
        ];

        const priorityEntries = [
          { label: this.t('summaryHigh'), value: priority.high || 0 },
          { label: this.t('summaryNormal'), value: priority.normal || 0 },
          { label: this.t('summaryLow'), value: priority.low || 0 },
          { label: this.getPriorityLabel('future'), value: priority.future || 0 },
        ];

        return {
          cards,
          revenue,
          avgTicket: revenue / totalOrders,
          priorityEntries,
        };
      },

      getRolePersona(role = this.currentRole) {
        const staff = this.staffRecords || [];
        if (role === 'tech') {
          const roster = staff.filter((member) => member.category === 'technician').map((member) => member.name);
          if (!roster.length) return null;
          return {
            role,
            title: this.localize('Vista de técnicos', 'Technician focus'),
            members: roster,
            description: `${roster.length} ${this.localize('técnicos activos', 'active techs')}`,
          };
        }
        if (role === 'labor') {
          const roster = staff.filter((member) => member.category === 'labor').map((member) => member.name);
          if (!roster.length) return null;
          return {
            role,
            title: this.localize('Equipo de apoyo', 'Field support'),
            members: roster,
            description: `${roster.length} ${this.localize('ayudantes en ruta', 'laborers on route')}`,
          };
        }
        return null;
      },

      getRoleDashboardPresentation() {
        const base = this.calculateDashboardMetrics();
        const dataset = {
          cards: base.cards,
          priorityEntries: base.priorityEntries,
          snapshotRows: [
            { label: this.t('summaryTotalRevenue'), value: this.formatCurrency(base.revenue) },
            { label: this.t('summaryAvgTicket'), value: this.formatCurrency(base.avgTicket) },
          ],
          showMap: true,
          context: null,
        };
        const persona = this.getRolePersona();
        if (!persona) {
          return dataset;
        }
        const rosterOrders = this.getOrdersForRoster(persona.members);
        const today = rosterOrders.filter((order) => this.isSameDay(order.date, new Date()));
        const openOrders = rosterOrders.filter((order) => !this.isOrderCompleted(order.status));
        const completedToday = rosterOrders.filter(
          (order) => this.isOrderCompleted(order.status) && this.isSameDay(order.date, new Date())
        );
        const nextJob = openOrders
          .filter((order) => order.date)
          .sort((a, b) => new Date(a.date || 0) - new Date(b.date || 0))[0];

        dataset.cards = [
          {
            className: 'active',
            label: this.localize('Hoy', 'Today'),
            value: today.length,
            detail: this.localize('Turnos programados', 'Scheduled stops'),
            trend: `${today.length} ${this.localize('visitas', 'stops')}`,
          },
          {
            className: 'upcoming',
            label: this.localize('Pendientes', 'Upcoming'),
            value: openOrders.length,
            detail: this.localize('Asignadas a tu equipo', 'Assigned to your team'),
            trend: `${openOrders.length} ${this.localize('activas', 'active')}`,
          },
          {
            className: 'completed',
            label: this.localize('Cerradas', 'Closed'),
            value: completedToday.length,
            detail: this.localize('Finalizadas recientemente', 'Finished recently'),
            trend: `${completedToday.length} ${this.localize('lista(s)', 'done')}`,
          },
        ];
        dataset.priorityEntries = openOrders
          .slice()
          .sort((a, b) => new Date(a.date || 0) - new Date(b.date || 0))
          .slice(0, 4)
          .map((order) => ({
            label: `${this.formatShortDate(order.date)} · ${order.customer}`,
            value: order.window || this.formatStatus(order.status),
          }));
        dataset.snapshotRows = [
          { label: this.localize('Equipo', 'Team'), value: persona.description },
          {
            label: this.localize('Próxima ventana', 'Next window'),
            value: nextJob ? `${this.formatShortDate(nextJob.date)} · ${nextJob.window || '—'}` : '—',
          },
        ];
        dataset.showMap = false;
        dataset.context = {
          title: persona.title,
          meta: persona.description,
          nextLabel: nextJob
            ? `${nextJob.customer} · ${this.formatShortDate(nextJob.date)}`
            : this.localize('Sin asignaciones próximas', 'No upcoming assignments'),
        };
        return dataset;
      },

      bindMapFilters() {
        if (this.mapFiltersBound) return;
        document.querySelectorAll('[data-map-filter]').forEach((btn) => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('[data-map-filter]').forEach((b) => b.classList.remove('active'));
            btn.classList.add('active');
            this.updateMap(btn.dataset.mapFilter);
          });
        });
        this.mapFiltersBound = true;
      },

      initMap() {
        const mapContainer = document.getElementById('dashboard-map');
        if (!mapContainer) return;
        if (this.map) {
          this.map.invalidateSize();
          return;
        }
        this.map = L.map('dashboard-map', { zoomControl: false }).setView([31.0, -99.0], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 18,
          attribution: '© OpenStreetMap',
        }).addTo(this.map);
      },

      updateMap(filter = 'active') {
        if (!this.map) return;
        this.currentMapFilter = filter;
        this.mapMarkers.forEach((marker) => marker.remove());
        this.mapMarkers = [];
        const colorMap = {
          completed: '#38b000',
          active: '#02735E',
          upcoming: '#034040',
        };
        const dataset = this.orders.filter((order) => {
          if (filter === 'future') return order.future;
          if (filter === 'history') return ['job_done', 'paid', 'invoiced', 'completed', 'archived'].includes(order.status);
          return !['job_done', 'paid', 'invoiced', 'completed', 'archived'].includes(order.status);
        });
        dataset.forEach((order) => {
          if (!order.lat || !order.lng) return;
          const category = this.getOrderMapCategory(order);
          const color = colorMap[category] || '#02735E';
          const marker = L.circleMarker([order.lat, order.lng], {
            radius: 10,
            color,
            weight: 2,
            fillColor: color,
            fillOpacity: 0.85,
          })
            .addTo(this.map)
            .bindPopup(
              `<strong>${order.customer}</strong><br>${order.service}<br>${this.formatStatus(order.status)}`
            );
          this.mapMarkers.push(marker);
        });
      },

      getOrderMapCategory(order) {
        const completedStatuses = new Set(['job_done', 'paid', 'invoiced', 'completed', 'archived']);
        const activeStatuses = new Set(['scheduled', 'en_route', 'on_site']);
        if (completedStatuses.has(order.status)) return 'completed';
        if (order.future || order.status === 'draft') return 'upcoming';
        if (activeStatuses.has(order.status)) return 'active';
        return 'active';
      },

      renderSchedule(range) {
        if (range) {
          this.scheduleRange = range;
        }
        const grid = document.getElementById('schedule-grid');
        if (!grid) return;
        const jobs = this.getScheduleDataset(this.scheduleRange);
        this.renderScheduleKpis(jobs);
        if (!jobs.length) {
          grid.innerHTML = `<div class="schedule-placeholder">${this.t('scheduleEmpty')}</div>`;
          const timeline = document.getElementById('schedule-timeline');
          if (timeline) {
            timeline.innerHTML = `<p class="schedule-placeholder">${this.t('scheduleEmpty')}</p>`;
            timeline.classList.toggle('active', this.scheduleMode === 'timeline');
            timeline.classList.toggle('hidden', this.scheduleMode !== 'timeline');
          }
          grid.classList.toggle('hidden', this.scheduleMode === 'timeline');
          this.showScheduleDetail(null);
          this.renderScheduleFeed([]);
          this.updateScheduleControls();
          return;
        }
        this.renderScheduleCards(jobs);
        this.renderScheduleTimeline(jobs);
        const defaultId =
          this.selectedOrderId && jobs.find((job) => job.id === this.selectedOrderId)
            ? this.selectedOrderId
            : jobs[0].id;
        this.showScheduleDetail(defaultId);
        this.renderScheduleFeed(jobs);
        this.updateScheduleControls();
      },

      renderScheduleKpis(jobs = []) {
        const todayEl = document.getElementById('schedule-kpi-today');
        const urgentEl = document.getElementById('schedule-kpi-urgent');
        const backlogEl = document.getElementById('schedule-kpi-backlog');
        if (!todayEl || !urgentEl || !backlogEl) return;
        const todayHint = document.getElementById('schedule-kpi-today-hint');
        const urgentHint = document.getElementById('schedule-kpi-urgent-hint');
        const backlogHint = document.getElementById('schedule-kpi-backlog-hint');
        const today = new Date();
        const todayKey = today.toDateString();
        const todayJobs = jobs.filter((job) => job.date && new Date(job.date).toDateString() === todayKey);
        const urgentJobs = jobs.filter((job) => (job.priority || '').toLowerCase() === 'high');
        const backlogOrders = (this.orders || []).filter((order) => !this.isOrderCompleted(order.status));
        todayEl.textContent = todayJobs.length;
        urgentEl.textContent = urgentJobs.length;
        backlogEl.textContent = backlogOrders.length;
        if (todayHint) {
          todayHint.textContent = `${this.t('scheduleKpiTodayHint')} · ${this.formatShortDate(today.toISOString())}`;
        }
        if (urgentHint) {
          urgentHint.textContent = this.t('scheduleKpiUrgentHint');
        }
        if (backlogHint) {
          backlogHint.textContent = this.t('scheduleKpiBacklogHint');
        }
      },

      getScheduleDataset(range) {
        const limit = range === 'day' ? 3 : range === 'month' ? 12 : 6;
        return [...this.orders]
          .sort((a, b) => new Date(a.date) - new Date(b.date))
          .slice(0, limit);
      },

      renderScheduleCards(jobs) {
        const grid = document.getElementById('schedule-grid');
        if (!grid) return;
        grid.innerHTML = jobs.map((job) => this.scheduleCardTemplate(job)).join('');
        grid.querySelectorAll('.schedule-card').forEach((card) => {
          card.addEventListener('click', () => {
            this.showScheduleDetail(card.dataset.order);
          });
        });
      },

      renderScheduleTimeline(jobs) {
        const timeline = document.getElementById('schedule-timeline');
        if (!timeline) return;
        const entries = jobs
          .map(
            (job) => `
          <div class="timeline-entry" data-order="${job.id}">
            <div>
              <h4>${job.customer}</h4>
              <span>${this.formatScheduleTime(job.date)}</span>
              <span>${job.service} · ${job.address || ''}</span>
            </div>
            <div class="schedule-tags">
              <span class="schedule-chip schedule-chip-${job.priority || 'normal'}">${this.formatPriority(job.priority || 'normal')}</span>
              <span class="schedule-chip">${this.formatStatus(job.status)}</span>
            </div>
          </div>`
          )
          .join('');
        timeline.innerHTML = entries || `<p class="schedule-placeholder">${this.t('scheduleEmpty')}</p>`;
        timeline.classList.toggle('active', this.scheduleMode === 'timeline');
        timeline.classList.toggle('hidden', this.scheduleMode !== 'timeline');
        const grid = document.getElementById('schedule-grid');
        if (grid) {
          grid.classList.toggle('hidden', this.scheduleMode === 'timeline');
        }
        timeline.querySelectorAll('.timeline-entry').forEach((entry) => {
          entry.addEventListener('click', () => this.showScheduleDetail(entry.dataset.order));
        });
      },

      updateScheduleControls() {
        document.querySelectorAll('[data-schedule-range]').forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.scheduleRange === this.scheduleRange);
        });
        document.querySelectorAll('[data-schedule-mode]').forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.scheduleMode === this.scheduleMode);
        });
      },

      scheduleCardTemplate(job) {
        const timeLabel = this.formatScheduleTime(job.date);
        const priorityLabel = job.priority || 'normal';
        const priorityClass = `schedule-chip-${priorityLabel}`;
        return `
          <button type="button" class="schedule-card" data-order="${job.id}" aria-pressed="false">
            <div class="schedule-time">${timeLabel} · ${job.window || ''}</div>
            <div class="schedule-title">${job.customer}</div>
            <div class="schedule-service">${job.service}</div>
            <div class="schedule-tags">
              <span class="schedule-chip ${priorityClass}">${this.formatPriority(priorityLabel)}</span>
              <span class="schedule-chip">${this.formatStatus(job.status)}</span>
            </div>
          </button>`;
      },

      showScheduleDetail(orderId) {
        const detail = document.getElementById('schedule-detail');
        if (!detail) return;
        const order = this.orders.find((o) => o.id === orderId);
        if (!order) {
          detail.innerHTML = `<div class="schedule-placeholder">${this.t('scheduleEmpty')}</div>`;
          this.highlightScheduleCard(null);
          this.selectedOrderId = null;
          return;
        }
        this.selectedOrderId = orderId;
        const dayLabel = this.formatScheduleDetailDate(order.date);
        detail.innerHTML = `
          <div class="schedule-detail-header">
            <div>
              <p class="schedule-detail-time">${dayLabel} · ${order.window || ''}</p>
              <h3>${order.customer}</h3>
              <p class="schedule-detail-service">${order.service}</p>
            </div>
            <div class="schedule-pills">
              <span class="schedule-pill status">${this.formatStatus(order.status)}</span>
              <span class="schedule-pill priority-${order.priority || 'normal'}">${this.formatPriority(order.priority || 'normal')}</span>
            </div>
          </div>
          <div class="schedule-meta-grid">
            <div>
              <span>${this.t('scheduleAddress')}</span>
              <strong>${order.address || '—'}</strong>
            </div>
            <div>
              <span>${this.t('scheduleWindow')}</span>
              <strong>${order.window || '—'}</strong>
            </div>
            <div>
              <span>${this.t('orderTeamTechnicians')}</span>
              <strong>${this.formatList(order.technicians && order.technicians.length ? order.technicians : [order.crewLead])}</strong>
            </div>
            <div>
              <span>${this.t('orderTeamLabor')}</span>
              <strong>${this.formatList(order.labors || order.labor || order.crew)}</strong>
            </div>
            <div>
              <span>${this.t('scheduleScope')}</span>
              <strong>${order.scope || order.service}</strong>
            </div>
          </div>
          <div class="schedule-detail-section">
            <h4>${this.t('scheduleDescription')}</h4>
            <p>${order.description || ''}</p>
          </div>
          <div class="schedule-detail-section">
            <h4>${this.t('scheduleTasks')}</h4>
            <ul class="schedule-task-list">
              ${
                order.tasks && order.tasks.length
                  ? order.tasks.map((task) => `<li>${task}</li>`).join('')
                  : '<li>—</li>'
              }
            </ul>
          </div>
          <div class="schedule-detail-section">
            <h4>${this.t('scheduleNotes')}</h4>
            <p>${order.notes || '—'}</p>
          </div>
          <div class="schedule-detail-actions">
            <button class="btn btn-secondary" data-action="edit-order">${this.t('scheduleEdit')}</button>
          </div>
        `;
        this.highlightScheduleCard(orderId);
        const editBtn = detail.querySelector('[data-action="edit-order"]');
        if (editBtn) {
          editBtn.addEventListener('click', () => this.openOrderForm(orderId));
        }
      },

      openCustomerModal() {
        if (!this.requireCapability('customers.manage')) return;
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        modal.classList.add('active');
        title.textContent = this.t('newCustomer');
        const addresses = [];
        body.innerHTML = `
          <form id="customer-form" class="modal-step">
            <div class="form-grid">
              <div class="form-group">
                <label>${this.t('labelCustomer')}</label>
                <input type="text" name="name" placeholder="Atlas Builders" required />
              </div>
              <div class="form-group">
                <label>${this.t('customerEmail')}</label>
                <input type="email" name="email" placeholder="ops@atlas.com" />
              </div>
              <div class="form-group">
                <label>${this.t('customerPhone')}</label>
                <input type="tel" name="phone" placeholder="+1 (858) 555-2010" />
              </div>
              <div class="form-group">
                <label>${this.t('customerType')}</label>
                <select name="type">
                  <option value="residential">${this.t('customerTypeResidential')}</option>
                  <option value="commercial">${this.t('customerTypeCommercial')}</option>
                  <option value="contractor">${this.t('customerTypeContractor')}</option>
                </select>
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>${this.t('customerNotes')}</label>
                <textarea rows="3" name="notes" placeholder="Notas internas..."></textarea>
              </div>
            </div>
            <div class="form-group">
              <label>${this.t('customerAddresses')}</label>
              <div class="customer-address-input">
                <input type="text" id="customer-address-input" placeholder="${this.t('orderNewAddressPlaceholder')}" list="customer-address-datalist" autocomplete="off" />
                <button type="button" id="customer-add-address">${this.t('customerAddAddress')}</button>
              </div>
              <datalist id="customer-address-datalist"></datalist>
              <div class="customer-card-grid" id="customer-address-form-list"></div>
            </div>
            <div class="modal-step-actions" style="justify-content:flex-end;">
              <button class="btn btn-primary" type="submit">${this.t('saveCustomer')}</button>
            </div>
          </form>`;
        const addressList = document.getElementById('customer-address-form-list');
        const addressInput = document.getElementById('customer-address-input');
        const addressDatalist = document.getElementById('customer-address-datalist');
        const knownAddresses = this.getKnownAddresses();
        const encode = (value = '') =>
          value
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        if (addressDatalist) {
          addressDatalist.innerHTML = knownAddresses
            .map((addr) => `<option value="${encode(addr)}"></option>`)
            .join('');
        }
        const renderAddresses = () => {
          if (!addresses.length) {
            addressList.innerHTML = `<p class="schedule-placeholder">${this.t('customerAddressesEmpty')}</p>`;
            return;
          }
          addressList.innerHTML = addresses
            .map(
              (addr, index) => `
            <div class="customer-address-chip">
              <span>${addr}</span>
              <button type="button" data-index="${index}">×</button>
            </div>`
            )
            .join('');
          addressList.querySelectorAll('button[data-index]').forEach((btn) => {
            btn.addEventListener('click', () => {
              addresses.splice(parseInt(btn.dataset.index, 10), 1);
              renderAddresses();
            });
          });
        };
        const addAddress = () => {
          const value = (addressInput.value || '').trim();
          if (!value) return;
          addresses.push(value);
          addressInput.value = '';
          renderAddresses();
        };
        renderAddresses();
        if (addressInput) {
          addressInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
              event.preventDefault();
              addAddress();
            }
          });
        }
        document.getElementById('customer-add-address').addEventListener('click', addAddress);
        document.getElementById('customer-form').addEventListener('submit', (event) => {
          event.preventDefault();
          const data = new FormData(event.currentTarget);
          const name = (data.get('name') || '').trim();
          if (!name) return;
          const email = (data.get('email') || '').trim();
          const phone = (data.get('phone') || '').trim();
          const newCustomer = {
            id: this.generateCustomerId(),
            name,
            contacts: [email, phone].filter(Boolean),
            locations: addresses.length ? [...addresses] : [],
            type: data.get('type') || 'residential',
            notes: data.get('notes') || '',
          };
          this.customers.unshift(newCustomer);
          this.persist('customers');
          this.renderCustomers();
          this.closeModal();
        });
      },

      openInventoryModal(itemId = null) {
        if (!this.requireCapability('inventory.manage')) return;
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        if (!modal || !title || !body) return;
        const existing = itemId ? (this.inventory || []).find((item) => item.id === itemId) : null;
        const isNew = !existing;
        const inventoryId = isNew ? this.generateInventoryId() : existing?.id || this.generateInventoryId();
        const categoriesOptions = (this.inventoryCategories || [])
          .map(
            (category) => `
              <option value="${category.id}" ${category.id === (existing?.category || 'materials') ? 'selected' : ''}>
                ${this.t(category.labelKey)}
              </option>`
          )
          .join('');
        const currentStatus = existing?.status || 'ok';
        const statusOptions = Object.entries(this.INVENTORY_STATUS || {})
          .map(
            ([key, meta]) => `
              <option value="${key}" ${key === currentStatus ? 'selected' : ''}>
                ${this.t(meta.labelKey)}
              </option>`
          )
          .join('');
        modal.classList.add('active');
        title.textContent = isNew ? this.t('addMaterial') : this.t('inventoryEditItem');
        body.innerHTML = `
          <form id="inventory-form" class="modal-step">
            <div class="form-grid">
              <div class="form-group">
                <label>${this.t('inventoryFieldName')}</label>
                <input type="text" name="name" value="${this.escapeHtml(existing?.name || '')}" required />
              </div>
              <div class="form-group">
                <label>${this.t('inventoryFieldSku')}</label>
                <input type="text" name="sku" value="${this.escapeHtml(existing?.sku || '')}" />
              </div>
              <div class="form-group">
                <label>${this.t('inventoryFieldCategory')}</label>
                <select name="category">
                  ${categoriesOptions}
                </select>
              </div>
              <div class="form-group">
                <label>${this.t('inventoryFieldQty')}</label>
                <input type="number" name="qty" min="0" value="${existing?.qty ?? 0}" required />
              </div>
              <div class="form-group">
                <label>${this.t('inventoryFieldUnit')}</label>
                <input type="text" name="unit" value="${this.escapeHtml(existing?.unit || '')}" placeholder="pieza, ft, kit..." />
              </div>
              <div class="form-group">
                <label>${this.t('inventoryFieldReorder')}</label>
                <input type="number" name="reorderPoint" min="0" value="${existing?.reorderPoint ?? 0}" />
              </div>
              <div class="form-group">
                <label>${this.t('inventoryFieldStatus')}</label>
                <select name="status">
                  ${statusOptions}
                </select>
              </div>
              <div class="form-group">
                <label>${this.t('inventoryFieldLocation')}</label>
                <input type="text" name="location" value="${this.escapeHtml(existing?.location || '')}" />
              </div>
              <div class="form-group">
                <label>${this.t('inventoryFieldVendor')}</label>
                <input type="text" name="vendor" value="${this.escapeHtml(existing?.vendor || '')}" />
              </div>
              <div class="form-group">
                <label>${this.t('inventoryFieldCost')}</label>
                <input type="number" step="0.01" name="cost" value="${existing?.cost ?? 0}" />
              </div>
              <div class="form-group">
                <label>${this.t('inventoryFieldRestock')}</label>
                <input type="date" name="lastRestock" value="${existing?.lastRestock || ''}" />
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>${this.t('inventoryFieldNotes')}</label>
                <textarea name="notes" rows="3">${this.escapeHtml(existing?.notes || '')}</textarea>
              </div>
            </div>
            <div class="modal-step-actions" style="justify-content: space-between; align-items:center;">
              ${
                isNew
                  ? '<span></span>'
                  : `<button type="button" class="btn btn-secondary" id="inventory-delete" data-id="${inventoryId}">${this.t('inventoryDelete')}</button>`
              }
              <button class="btn btn-primary" type="submit">${this.t('inventorySaveItem')}</button>
            </div>
          </form>`;
        const form = document.getElementById('inventory-form');
        if (form) {
          form.addEventListener('submit', (event) => {
            event.preventDefault();
            const data = new FormData(form);
            const payload = {
              id: inventoryId,
              name: (data.get('name') || '').trim(),
              sku: (data.get('sku') || '').trim(),
              category: data.get('category') || 'materials',
              qty: Number(data.get('qty')) || 0,
              unit: (data.get('unit') || '').trim(),
              reorderPoint: Number(data.get('reorderPoint')) || 0,
              status: data.get('status') || '',
              location: (data.get('location') || '').trim(),
              vendor: (data.get('vendor') || '').trim(),
              cost: Number(data.get('cost')) || 0,
              lastRestock: data.get('lastRestock') || '',
              notes: (data.get('notes') || '').trim(),
            };
            if (!payload.status) {
              payload.status = this.resolveInventoryStatus(payload);
            }
            if (isNew) {
              this.inventory.unshift(payload);
            } else if (existing) {
              Object.assign(existing, payload);
            }
            this.persist('inventory');
            this.renderInventory();
            this.closeModal();
          });
        }
        if (!isNew) {
          const deleteBtn = document.getElementById('inventory-delete');
          if (deleteBtn) {
            deleteBtn.addEventListener('click', () => this.deleteInventoryItem(inventoryId));
          }
        }
      },

      openPurchaseOrderModal() {
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        modal.classList.add('active');
        title.textContent = this.t('inventoryGeneratePO');
        const lowItems = this.calculateInventoryMetrics().lowItems;
        if (!lowItems.length) {
          body.innerHTML = `<div class="modal-step"><p>${this.t('inventoryPOEmpty')}</p></div>`;
          return;
        }
        const grouped = lowItems.reduce((acc, item) => {
          const vendor = item.vendor || '—';
          acc[vendor] = acc[vendor] || [];
          acc[vendor].push(item);
          return acc;
        }, {});
        const sections = Object.entries(grouped)
          .map(([vendor, items]) => {
            const rows = items
              .map((item) => {
                const pending = Math.max(0, (Number(item.reorderPoint) || 0) - (Number(item.qty) || 0));
                return `
                <tr>
                  <td>${this.escapeHtml(item.name || '')}</td>
                  <td>${this.escapeHtml(item.sku || '—')}</td>
                  <td>${item.qty || 0}</td>
                  <td>${item.reorderPoint || 0}</td>
                  <td>${pending}</td>
                </tr>`;
              })
              .join('');
            return `
              <h4 style="margin-top:16px;">${this.escapeHtml(vendor)}</h4>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>${this.t('colMaterial')}</th>
                      <th>SKU</th>
                      <th>${this.t('colQty')}</th>
                      <th>${this.t('inventoryReorder')}</th>
                      <th>${this.t('inventoryRestockAction')}</th>
                    </tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>`;
          })
          .join('');
        body.innerHTML = `
          <div class="modal-step" style="gap:16px;">
            <p>${this.t('inventoryGeneratePOConfirm')}</p>
            <div>${sections}</div>
            <button class="btn btn-secondary" id="po-copy">${this.t('inventoryPOCopy')}</button>
          </div>`;
        const copyButton = document.getElementById('po-copy');
        if (copyButton && navigator.clipboard) {
          copyButton.addEventListener('click', async () => {
            const lines = lowItems
              .map((item) => {
                const need = Math.max(0, (Number(item.reorderPoint) || 0) - (Number(item.qty) || 0));
                return `${item.vendor || '—'} · ${item.name} (${item.sku || 's/n'}) -> ${need}`;
              })
              .join('\n');
            try {
              await navigator.clipboard.writeText(lines);
              copyButton.textContent = this.t('inventoryPOCopied');
              setTimeout(() => {
                copyButton.textContent = this.t('inventoryPOCopy');
              }, 2000);
            } catch (err) {
              console.error(err);
            }
          });
        }
      },

      openPurchaseOrderWizard(vendorName = '', presetItems = []) {
        if (!this.requireCapability('inventory.purchase')) return;
        if (!this.purchaseSuppliers || !this.purchaseSuppliers.length) {
          alert('Agrega proveedores de compra antes de crear órdenes.');
          return;
        }
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        const initialVendor = this.getPurchaseSupplierByName(vendorName) || this.purchaseSuppliers[0];
        const vendorIdDefault = initialVendor?.id || '';
        const buildProductOptions = (vendorId) =>
          (this.purchaseProducts || [])
            .filter((product) => product.vendorId === vendorId)
            .map((product) => `<option value="${product.id}">${product.name}</option>`)
            .join('');
        const normalizePreset = (items, vendorId) => {
          if (!items || !items.length) {
            const defaults = (this.purchaseProducts || []).filter((product) => product.vendorId === vendorId).slice(0, 3);
            return defaults.map((product) => ({
              productId: product.id,
              sku: product.sku,
              name: product.name,
              qty: 1,
              price: product.price || 0,
            }));
          }
          return items.map((item) => {
            const product = this.findPurchaseProductBySku(item.sku) || {};
            return {
              productId: product.id,
              sku: item.sku || product.sku,
              name: item.name || product.name,
              qty: item.qty || 1,
              price: item.price || product.price || 0,
            };
          });
        };
        const state = {
          vendorId: vendorIdDefault,
          items: normalizePreset(presetItems, vendorIdDefault),
        };
        modal.classList.add('active');
        title.textContent = this.t('poTitle');
        body.innerHTML = `
          <form id="po-form" class="modal-step">
            <div class="form-grid">
              <div class="form-group">
                <label>${this.t('poVendor')}</label>
                <select id="po-vendor" required>
                  ${this.purchaseSuppliers
                    .map((supplier) => `<option value="${supplier.id}" ${supplier.id === state.vendorId ? 'selected' : ''}>${supplier.name}</option>`)
                    .join('')}
                </select>
              </div>
              <div class="form-group">
                <label>${this.t('poJob')}</label>
                <input type="text" id="po-job" placeholder="20240617" />
              </div>
            </div>
            <div class="form-group" style="margin-top:12px;">
              <label>${this.t('poItems')}</label>
              <p class="helper-text">${this.t('poItemsOptional')}</p>
              <div id="po-items" class="inventory-report-list"></div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
                <select id="po-product-select">
                  <option value="">${this.t('poVendorPlaceholder')}</option>
                  ${buildProductOptions(state.vendorId)}
                </select>
                <input type="number" id="po-product-qty" min="1" value="1" style="width:80px;" />
                <button type="button" class="btn btn-secondary btn-small" id="po-add-product">${this.t('inventoryTruckLoadoutAdd')}</button>
              </div>
            </div>
            <div class="form-group">
              <label>${this.t('poNotes')}</label>
              <textarea id="po-notes" class="form-textarea"></textarea>
            </div>
            <div class="form-group" style="display:flex; justify-content:space-between; align-items:center;">
              <strong>${this.t('poTotal')}:</strong>
              <span id="po-total">${this.formatCurrency(0)}</span>
            </div>
            <div class="modal-step-actions" style="justify-content:flex-end;">
              <button type="submit" class="btn btn-primary">${this.t('poSave')}</button>
            </div>
          </form>`;
        const vendorSelect = document.getElementById('po-vendor');
        const productSelect = document.getElementById('po-product-select');
        const qtyInput = document.getElementById('po-product-qty');
        const itemsContainer = document.getElementById('po-items');
        const totalLabel = document.getElementById('po-total');
        const renderItems = () => {
          if (!state.items.length) {
            itemsContainer.innerHTML = `<p class="inventory-empty">${this.t('poNoProducts')}</p>`;
            totalLabel.textContent = this.formatCurrency(0);
            return;
          }
          let total = 0;
          itemsContainer.innerHTML = state.items
            .map((item, index) => {
              const subtotal = (item.qty || 0) * (item.price || 0);
              total += subtotal;
              return `
              <div class="inventory-report-item">
                <div>
                  <strong>${this.escapeHtml(item.name || '')}</strong>
                  <small>${this.escapeHtml(item.sku || '')}</small>
                </div>
                <div style="display:flex; gap:6px; align-items:center;">
                  <input type="number" data-index="${index}" class="qty-input" value="${item.qty}" min="1" style="width:80px;" />
                  <span>${this.formatCurrency(subtotal)}</span>
                  <button type="button" class="btn btn-secondary btn-small" data-remove="${index}">×</button>
                </div>
              </div>`;
            })
            .join('');
          totalLabel.textContent = this.formatCurrency(total);
          itemsContainer.querySelectorAll('input[data-index]').forEach((input) => {
            input.addEventListener('change', () => {
              const idx = Number(input.dataset.index);
              const value = Math.max(1, Number(input.value) || 1);
              state.items[idx].qty = value;
              renderItems();
            });
          });
          itemsContainer.querySelectorAll('button[data-remove]').forEach((btn) => {
            btn.addEventListener('click', () => {
              const idx = Number(btn.dataset.remove);
              state.items.splice(idx, 1);
              renderItems();
            });
          });
        };
        const refreshProductSelect = () => {
          productSelect.innerHTML = `<option value="">${this.t('poVendorPlaceholder')}</option>${buildProductOptions(state.vendorId)}`;
        };
        vendorSelect.addEventListener('change', () => {
          state.vendorId = vendorSelect.value;
          state.items = normalizePreset([], state.vendorId);
          refreshProductSelect();
          renderItems();
        });
        document.getElementById('po-add-product').addEventListener('click', () => {
          const productId = productSelect.value;
          if (!productId) return;
          const vendorProduct = (this.purchaseProducts || []).find((product) => product.id === productId);
          if (!vendorProduct) return;
          const qty = Math.max(1, Number(qtyInput.value) || 1);
          const existing = state.items.find((item) => item.productId === productId);
          if (existing) {
            existing.qty += qty;
          } else {
            state.items.push({
              productId,
              sku: vendorProduct.sku,
              name: vendorProduct.name,
              qty,
              price: vendorProduct.price || 0,
            });
          }
          renderItems();
        });
        renderItems();
        const form = document.getElementById('po-form');
        form.addEventListener('submit', (event) => {
          event.preventDefault();
          if (!state.items.length) {
            alert(this.t('poNoProducts'));
            return;
          }
          const supplier = this.getPurchaseSupplierById(state.vendorId);
          const total = state.items.reduce((sum, item) => sum + (item.qty || 0) * (item.price || 0), 0);
          const order = {
            id: this.generatePoId(),
            vendorId: state.vendorId,
            vendorName: supplier?.name || vendorSelect.options[vendorSelect.selectedIndex]?.text || '—',
            vendorEmail: supplier?.email || '',
            date: new Date().toISOString(),
            jobNumber: document.getElementById('po-job').value.trim(),
            notes: document.getElementById('po-notes').value.trim(),
            status: 'draft',
            total,
            items: state.items.map((item) => ({
              sku: item.sku,
              name: item.name,
              qty: item.qty,
              price: item.price,
              subtotal: (item.qty || 0) * (item.price || 0),
            })),
          };
          this.purchaseOrders.unshift(order);
          this.persist('purchaseOrders');
          this.renderPurchaseOrders();
          this.closeModal();
          alert(`${this.t('poTitle')} ${order.id} listo.`);
        });
      },

      openPurchaseOrderSummary(orderId) {
        const order = (this.purchaseOrders || []).find((po) => po.id === orderId);
        if (!order) return;
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        modal.classList.add('active');
        title.textContent = `${this.t('poTitle')} · ${order.id}`;
        const rows = order.items
          .map(
            (item) => `
          <tr>
            <td>${item.sku || ''}</td>
            <td>${item.name || ''}</td>
            <td>${item.qty}</td>
            <td>${this.formatCurrency(item.price)}</td>
            <td>${this.formatCurrency(item.subtotal)}</td>
          </tr>`
          )
          .join('');
        body.innerHTML = `
          <div class="modal-step" style="gap:16px;">
            <div class="order-detail-grid">
              <div class="detail-item">
                <div class="detail-label">${this.t('poVendor')}</div>
                <div class="detail-value">${order.vendorName}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">${this.t('poJob')}</div>
                <div class="detail-value">${order.jobNumber || '—'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">${this.t('inventoryLastRestock')}</div>
                <div class="detail-value">${new Date(order.date).toLocaleDateString(this.getLocale())}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">${this.t('colStatus')}</div>
                <div class="detail-value"><span class="inventory-status ${this.getPoStatusClass(order.status)}">${this.formatPoStatus(
          order.status
        )}</span></div>
              </div>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>SKU</th>
                    <th>${this.t('colMaterial')}</th>
                    <th>Qty</th>
                    <th>${this.t('inventoryCost')}</th>
                    <th>${this.t('inventoryValue')}</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
            <div style="display:flex; justify-content:space-between; font-weight:600;">
              <span>${this.t('poTotal')}:</span>
              <span>${this.formatCurrency(order.total)}</span>
            </div>
            <div class="modal-step-actions" style="justify-content:space-between; gap:12px; flex-wrap:wrap;">
              <div class="report-actions">
                <button class="btn btn-secondary btn-small" data-action="po-copy">${this.t('inventoryPOCopy')}</button>
                <button class="btn btn-secondary btn-small" data-action="po-download">${this.t('poDownloadPdf')}</button>
                <button class="btn btn-secondary btn-small" data-action="po-email">${this.t('poEmailVendor')}</button>
              </div>
              <div class="report-actions">
                <button class="btn btn-secondary btn-small" data-action="po-status-sent">${this.t('poStatusSent')}</button>
                <button class="btn btn-secondary btn-small" data-action="po-status-received">${this.t('poStatusReceived')}</button>
              </div>
            </div>
          </div>`;
        const copyBtn = body.querySelector('[data-action="po-copy"]');
        if (copyBtn && navigator.clipboard) {
          copyBtn.addEventListener('click', async () => {
            const summary = `${order.vendorName}\n${order.items
              .map((item) => `${item.qty} x ${item.name} (${item.sku}) - ${this.formatCurrency(item.price)}`)
              .join('\n')}\nTotal: ${this.formatCurrency(order.total)}`;
            await navigator.clipboard.writeText(summary);
            copyBtn.textContent = this.t('inventoryPOCopied');
            setTimeout(() => (copyBtn.textContent = this.t('inventoryPOCopy')), 2000);
          });
        }
        const downloadBtn = body.querySelector('[data-action="po-download"]');
        if (downloadBtn) {
          downloadBtn.addEventListener('click', () => this.downloadPurchaseOrder(orderId));
        }
        const emailBtn = body.querySelector('[data-action="po-email"]');
        if (emailBtn) {
          emailBtn.addEventListener('click', () => this.emailPurchaseOrder(orderId));
        }
        const sentBtn = body.querySelector('[data-action="po-status-sent"]');
        if (sentBtn) {
          sentBtn.addEventListener('click', () => this.updatePurchaseOrderStatus(orderId, 'sent'));
        }
        const receivedBtn = body.querySelector('[data-action="po-status-received"]');
        if (receivedBtn) {
          receivedBtn.addEventListener('click', () => this.updatePurchaseOrderStatus(orderId, 'received'));
        }
      },

      updatePurchaseOrderStatus(orderId, status) {
        const order = (this.purchaseOrders || []).find((po) => po.id === orderId);
        if (!order) return;
        order.status = status;
        if (status === 'sent') {
          order.sentAt = new Date().toISOString();
        }
        if (status === 'received' && !order.receivedApplied) {
          order.receivedAt = new Date().toISOString();
          this.applyPurchaseOrderToInventory(order);
          order.receivedApplied = true;
        }
        this.persist('purchaseOrders');
        this.renderPurchaseOrders();
        this.closeModal();
      },

      downloadPurchaseOrder(orderId) {
        const order = (this.purchaseOrders || []).find((po) => po.id === orderId);
        if (!order) return;
        const headers = ['SKU', this.t('colMaterial'), this.localize('Cantidad', 'Qty'), this.t('inventoryCost'), this.t('inventoryValue')];
        const rows = (order.items || []).map((item) => [
          item.sku || '—',
          item.name || '—',
          item.qty || 0,
          this.formatCurrency(item.price || 0),
          this.formatCurrency(item.subtotal || 0),
        ]);
        this.downloadPdfTable({
          filename: `${order.id}.pdf`,
          title: `${order.id} · ${order.vendorName || ''}`,
          headers,
          rows,
        });
      },

      emailPurchaseOrder(orderId) {
        const order = (this.purchaseOrders || []).find((po) => po.id === orderId);
        if (!order) return;
        const supplier = this.getPurchaseSupplierById(order.vendorId);
        const target = order.vendorEmail || supplier?.email;
        if (!target) {
          alert(this.localize('Agrega un correo electrónico al proveedor para enviar la orden.', 'Add a supplier email before sending the PO.'));
          return;
        }
        const subject = encodeURIComponent(`${this.t('poTitle')} ${order.id}`);
        const lines = [
          `${this.t('poVendor')}: ${order.vendorName}`,
          `${this.t('poJob')}: ${order.jobNumber || '—'}`,
          '',
          ...order.items.map(
            (item) => `${item.qty} × ${item.name} (${item.sku}) · ${this.formatCurrency(item.price)} = ${this.formatCurrency(item.subtotal)}`
          ),
          '',
          `${this.t('poTotal')}: ${this.formatCurrency(order.total)}`,
        ];
        const body = encodeURIComponent(lines.join('\n'));
        window.location.href = `mailto:${encodeURIComponent(target)}?subject=${subject}&body=${body}`;
      },

      applyPurchaseOrderToInventory(order) {
        if (!order || !order.items || !order.items.length) return;
        let updated = false;
        order.items.forEach((item) => {
          const inventoryItem = (this.inventory || []).find((inv) => inv.sku === item.sku || inv.name === item.name);
          if (inventoryItem) {
            inventoryItem.qty = (Number(inventoryItem.qty) || 0) + (Number(item.qty) || 0);
            inventoryItem.lastRestock = new Date().toISOString().slice(0, 10);
            inventoryItem.status = this.resolveInventoryStatus(inventoryItem);
            updated = true;
          }
        });
        if (updated) {
          this.persist('inventory');
          this.renderInventory();
        }
      },


      openFleetModal(selectedId = null) {
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        modal.classList.add('active');
        title.textContent = this.t('inventoryFleetTitle');
        const list = this.fleet && this.fleet.length ? this.fleet : [];
        const targetId = selectedId || (list[0] && list[0].id) || null;
        const selected = list.find((truck) => truck.id === targetId) || null;
        const loadout = selected ? [...(selected.loadout || [])] : [];
        const staffOptions = (this.staffRecords || [])
          .filter((member) => ['technician', 'labor'].includes(member.category))
          .map(
            (member) =>
              `<option value="${this.escapeHtml(member.name)}" ${
                member.name === (selected?.lead || '') ? 'selected' : ''
              }>${member.name}</option>`
          )
          .join('');
        const inventoryOptions = (this.inventory || [])
          .map((item) => `<option value="${item.id}">${item.name}</option>`)
          .join('');
        const renderTruckList = () => {
          if (!list.length) {
            return `<p class="inventory-empty">${this.t('inventoryTruckEmpty')}</p>`;
          }
          return `
            <div class="inventory-report-list" style="max-height:260px; overflow:auto;">
              ${list
                .map(
                  (truck) => `
                <button class="chip-filter ${truck.id === (selected && selected.id) ? 'active' : ''}" data-fleet="${truck.id}" style="width:100%; justify-content:flex-start;">
                  ${truck.name}
                </button>`
                )
                .join('')}
            </div>`;
        };
        body.innerHTML = `
          <div style="display:grid; grid-template-columns:180px 1fr; gap:16px; min-height:280px;">
            <div>
              ${renderTruckList()}
              <button class="btn btn-secondary btn-small" id="fleet-new" style="margin-top:12px;">${this.t('inventoryTruckAdd')}</button>
            </div>
            <form id="fleet-form" class="modal-step" style="align-items:flex-start;">
              <input type="hidden" name="id" value="${selected?.id || ''}" />
              <div class="form-grid">
                <div class="form-group">
                  <label>${this.t('inventoryTruckName')}</label>
                  <input type="text" name="name" value="${this.escapeHtml(selected?.name || '')}" required />
                </div>
                <div class="form-group">
                  <label>${this.t('inventoryTruckPlate')}</label>
                  <input type="text" name="plate" value="${this.escapeHtml(selected?.plate || '')}" />
                </div>
                <div class="form-group">
                  <label>${this.t('inventoryTruckLead')}</label>
                  <select name="lead">
                    <option value="">—</option>
                    ${staffOptions}
                  </select>
                </div>
                <div class="form-group">
                  <label>${this.t('inventoryTruckCapacity')}</label>
                  <input type="number" name="capacity" min="0" max="100" value="${selected?.capacityUsed ?? 0}" />
                </div>
                <div class="form-group">
                  <label>${this.t('inventoryTruckLastService')}</label>
                  <input type="date" name="lastService" value="${selected?.lastService || ''}" />
                </div>
              </div>
              <div class="form-group" style="width:100%;">
                <label>${this.t('inventoryTruckLoadout')}</label>
                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                  <select id="fleet-item-select" style="flex:1;">
                    <option value="">${this.t('inventoryTruckLoadoutPlaceholder')}</option>
                    ${inventoryOptions}
                  </select>
                  <input type="number" id="fleet-item-qty" min="1" value="1" style="width:80px;" />
                  <button type="button" class="btn btn-secondary btn-small" id="fleet-add-item">${this.t('inventoryTruckLoadoutAdd')}</button>
                </div>
                <div id="fleet-loadout-list" class="fleet-loadout" style="margin-top:10px;"></div>
              </div>
              <div class="modal-step-actions" style="justify-content:flex-end; width:100%;">
                <button class="btn btn-primary" type="submit">${this.t('inventoryTruckSave')}</button>
              </div>
            </form>
          </div>`;
        const loadoutList = document.getElementById('fleet-loadout-list');
        const renderLoadout = () => {
          if (!loadout.length) {
            loadoutList.innerHTML = `<span class="fleet-meta">${this.t('inventoryTruckEmpty')}</span>`;
            return;
          }
          loadoutList.innerHTML = loadout
            .map((entry, index) => {
              const item = this.getInventoryItemById(entry.itemId);
              const label = item ? item.name : entry.itemId;
              return `<span class="fleet-chip">${entry.qty}× ${this.escapeHtml(label || '')} <button data-remove="${index}" style="border:none;background:none;color:#e03131;margin-left:6px;">×</button></span>`;
            })
            .join('');
          loadoutList.querySelectorAll('button[data-remove]').forEach((btn) => {
            btn.addEventListener('click', () => {
              loadout.splice(parseInt(btn.dataset.remove, 10), 1);
              renderLoadout();
            });
          });
        };
        renderLoadout();
        const fleetAddBtn = document.getElementById('fleet-add-item');
        const itemSelect = document.getElementById('fleet-item-select');
        const qtyInput = document.getElementById('fleet-item-qty');
        if (fleetAddBtn) {
          fleetAddBtn.addEventListener('click', () => {
            const itemId = itemSelect.value;
            const qty = Number(qtyInput.value) || 1;
            if (!itemId) return;
            const existingEntry = loadout.find((entry) => entry.itemId === itemId);
            if (existingEntry) {
              existingEntry.qty = qty;
            } else {
              loadout.push({ itemId, qty });
            }
            renderLoadout();
          });
        }
        const fleetButtons = body.querySelectorAll('[data-fleet]');
        fleetButtons.forEach((btn) => {
          btn.addEventListener('click', () => this.openFleetModal(btn.dataset.fleet));
        });
        const newFleetBtn = document.getElementById('fleet-new');
        if (newFleetBtn) {
          newFleetBtn.addEventListener('click', () => this.openFleetModal(null));
        }
        const form = document.getElementById('fleet-form');
        if (form) {
          form.addEventListener('submit', (event) => {
            event.preventDefault();
            const data = new FormData(form);
            const payload = {
              id: data.get('id') || `TRK-${Date.now().toString().slice(-4)}`,
              name: (data.get('name') || '').trim(),
              plate: (data.get('plate') || '').trim(),
              lead: data.get('lead') || '',
              leadRole: this.getStaffRole(data.get('lead')),
              capacityUsed: Number(data.get('capacity')) || 0,
              lastService: data.get('lastService') || '',
              loadout: loadout.slice(),
            };
            const existingFleet = this.fleet.find((truck) => truck.id === payload.id);
            if (existingFleet) {
              Object.assign(existingFleet, payload);
            } else {
              this.fleet.push(payload);
            }
            this.persist('fleet');
            this.renderInventoryFleet();
            this.closeModal();
          });
        }
      },

      getStaffRole(name) {
        if (!name) return '';
        const member = (this.staffRecords || []).find((staff) => staff.name === name);
        return member?.role || '';
      },

      deleteInventoryItem(itemId) {
        if (!itemId) return;
        if (!window.confirm(this.t('inventoryDeleteConfirm'))) return;
        this.inventory = (this.inventory || []).filter((item) => item.id !== itemId);
        this.persist('inventory');
        this.renderInventory();
        this.closeModal();
      },

      startNewOrderFlow() {
        if (!this.requireCapability('orders.manage')) return;
        const customers = this.customers || [];
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        modal.classList.add('active');
        if (!customers.length) {
          title.textContent = this.t('orders');
          body.innerHTML = `
            <div class="modal-step">
              <p>${this.t('ordersNoClients')}</p>
              <button class="btn btn-primary" id="order-go-customers">${this.t('orderAddCustomer')}</button>
            </div>`;
          document.getElementById('order-go-customers').addEventListener('click', () => {
            this.closeModal();
            this.showPage('customers');
          });
          return;
        }
        title.textContent = this.t('orderSelectClient');
        body.innerHTML = `
          <div class="modal-step">
            <p>${this.t('orderSelectClientHint')}</p>
            <input type="search" id="order-customer-search" placeholder="${this.t('orderSearchPlaceholder')}" />
            <div class="customer-card-grid" id="order-customer-grid">
              ${customers
                .map(
                  (c) => `
                <div class="customer-card" data-name="${c.name.toLowerCase()}">
                  <h4>${c.name}</h4>
                  <span>${(c.contacts && c.contacts[0]) || ''}</span>
                  <span>${(c.locations || []).length} ${this.t('customerAddresses').toLowerCase()}</span>
                  <button data-customer="${c.id}">${this.t('ordersContinue')}</button>
                </div>`
                )
                .join('')}
            </div>
            <div class="modal-step-actions">
              <button class="btn btn-secondary" id="order-add-client">${this.t('orderAddCustomer')}</button>
            </div>
          </div>`;
        const searchInput = document.getElementById('order-customer-search');
        const grid = document.getElementById('order-customer-grid');
        searchInput.addEventListener('input', () => {
          const query = searchInput.value.toLowerCase();
          grid.querySelectorAll('.customer-card').forEach((card) => {
            const match = card.dataset.name.includes(query);
            card.style.display = match ? 'flex' : 'none';
          });
        });
        grid.querySelectorAll('button[data-customer]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const customer = this.customers.find((c) => c.id === btn.dataset.customer);
            if (customer) {
              this.showOrderAddressStep(customer);
            }
          });
        });
        document.getElementById('order-add-client').addEventListener('click', () => {
          this.closeModal();
          this.showPage('customers');
        });
      },

      showOrderAddressStep(customer) {
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        const addresses = customer.locations || [];
        if (!this.selectedCustomerAddress || !addresses.includes(this.selectedCustomerAddress)) {
          this.selectedCustomerAddress = addresses[0] || null;
        }
        modal.classList.add('active');
        title.textContent = `${this.t('orderSelectAddress')} · ${customer.name}`;
        body.innerHTML = `
          <div class="order-step-panel">
            <div class="order-step-grid">
              <div class="form-group">
                <label>${this.t('orderSelectAddress')}</label>
                <select id="order-address-select">
                  ${addresses.map((addr) => `<option value="${this.escapeHtml(addr)}">${this.escapeHtml(addr)}</option>`).join('')}
                  <option value="__new__">${this.t('orderAddAddress')}</option>
                </select>
              </div>
              <div class="form-group" id="order-new-address-group" style="display:${addresses.length ? 'none' : 'block'};">
                <label>${this.t('orderAddAddress')}</label>
                <input type="text" id="order-new-address" placeholder="${this.t('orderNewAddressPlaceholder')}" />
              </div>
            </div>
            <div class="order-step-actions">
              <button type="button" class="btn btn-secondary" id="order-step-back">${this.t('ordersBack')}</button>
              <button type="button" class="btn btn-primary" id="order-step2-continue">${this.t('ordersContinue')}</button>
            </div>
          </div>`;
        const select = document.getElementById('order-address-select');
        const newAddressGroup = document.getElementById('order-new-address-group');
        const newAddressInput = document.getElementById('order-new-address');
        if (!addresses.length) {
            select.value = '__new__';
        }
        select.addEventListener('change', () => {
          newAddressGroup.style.display = select.value === '__new__' ? 'block' : 'none';
        });
        document.getElementById('order-step-back').addEventListener('click', () => this.startNewOrderFlow());
        document.getElementById('order-step2-continue').addEventListener('click', () => {
          let address = select.value;
          if (address === '__new__') {
            address = (newAddressInput.value || '').trim();
            if (!address) {
              alert(this.t('ordersAddressRequired'));
              return;
            }
            customer.locations = customer.locations || [];
            customer.locations.push(address);
            this.persist('customers');
          }
          this.selectedCustomerAddress = address;
          const recentOrder = this.orders.find((order) => order.customer === customer.name);
          this.openOrderForm(null, {
            customer: customer.name,
            address,
            customerId: customer.id,
            serviceId: this.findServiceIdByLabel(recentOrder?.service),
            windowSlot: this.getWindowSlotFromLabel(recentOrder?.window),
          });
        });
      },

      openOrderForm(orderId = null, prefill = {}) {
        const existingOrder = orderId ? this.orders.find((o) => o.id === orderId) : null;
        const isNew = !existingOrder;
        const order = isNew ? { ...this.getOrderTemplate(), ...prefill } : { ...existingOrder };
        order.customerId = order.customerId || prefill.customerId || '';
        order.serviceId = order.serviceId || prefill.serviceId || this.findServiceIdByLabel(order.service) || (this.SERVICE_LIBRARY[0]?.id || '');
        if (!Array.isArray(order.technicians) || !order.technicians.length) {
          order.technicians = order.crewLead ? [order.crewLead] : [];
        }
        if (!Array.isArray(order.labors) || !order.labors.length) {
          const derivedCrew = Array.isArray(order.crew) ? order.crew : [];
          order.labors = derivedCrew.filter((name) => !order.technicians.includes(name));
        }
        const encode = (value = '') =>
          value
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
        const windowSlot =
          prefill.windowSlot || this.getWindowSlotFromLabel(order.window) || (this.WINDOW_OPTIONS[0]?.id || 'morning');
        const customWindowValue = windowSlot === 'custom' ? order.window || '' : '';
        const serviceOptions = this.SERVICE_LIBRARY.map(
          (service) => `<option value="${service.id}" ${service.id === order.serviceId ? 'selected' : ''}>${service.label}</option>`
        ).join('');
        const windowOptions = this.WINDOW_OPTIONS.map(
          (option) => `<option value="${option.id}" ${option.id === windowSlot ? 'selected' : ''}>${option.label}</option>`
        ).join('');
        const statusOptions = Object.keys(this.ORDER_STATES || {})
          .map(
            (state) =>
              `<option value="${state}" ${state === (order.status || 'scheduled') ? 'selected' : ''}>${
                this.ORDER_STATES[state].label
              }</option>`
          )
          .join('');
        const priorityOptions = Object.keys(this.PRIORITY_CONFIG || {})
          .map(
            (key) =>
              `<option value="${key}" ${key === (order.priority || 'normal') ? 'selected' : ''}>${this.getPriorityLabel(key)}</option>`
          )
          .join('');
        const customerAddresses = this.getCustomerAddresses(order.customerId, order.customer);
        const addressDatalistId = 'order-address-options';
        const addressDatalist = customerAddresses.length
          ? `<datalist id="${addressDatalistId}">${customerAddresses
              .map((addr) => `<option value="${encode(addr)}"></option>`)
              .join('')}</datalist>`
          : '';
        const addressListAttribute = customerAddresses.length ? `list="${addressDatalistId}"` : '';
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        title.textContent = isNew ? this.t('newOrder') : `${this.t('scheduleEdit')} · ${order.id}`;
        body.innerHTML = `
          <form id="edit-order-form" class="order-form">
            <input type="hidden" name="customerId" value="${encode(order.customerId || '')}" />
            <div class="order-form-section">
              <h4>Cliente & sitio</h4>
              <div class="order-form-split">
                <div class="form-group">
                  <label>${this.t('labelCustomer')}</label>
                  <input type="text" name="customer" value="${encode(order.customer || '')}" placeholder="Nombre del cliente" />
                  <p class="helper-text">Este nombre aparecerá en la orden y en las notificaciones.</p>
                </div>
                <div class="form-group">
                  <label>${this.t('labelService')}</label>
                  <select id="order-service" name="serviceId">
                    ${serviceOptions}
                  </select>
                  <p class="helper-text">Selecciona el servicio que vamos a ejecutar.</p>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label>${this.t('scheduleAddress')}</label>
                  <input type="text" name="address" ${addressListAttribute} value="${encode(order.address || '')}" placeholder="${this.t(
                    'orderNewAddressPlaceholder'
                  )}" />
                  ${addressDatalist}
                  <p class="helper-text">Escribe la dirección o elige una registrada en el cliente.</p>
                </div>
              </div>
            </div>

            <div class="order-form-section">
              <h4>Programación</h4>
              <div class="order-form-split">
                <div class="form-group">
                  <label>${this.t('scheduleWindow')}</label>
                  <select id="order-window" name="windowSlot">
                    ${windowOptions}
                  </select>
                  <input type="text" id="order-window-custom" name="windowCustom" value="${encode(customWindowValue)}" placeholder="Ej. 07:00 - 09:00" style="display:none; margin-top:8px;" />
                  <p class="helper-text">La ventana es el bloque de tiempo comprometido con el cliente.</p>
                </div>
                <div class="form-group">
                  <label>${this.t('ordersDateLabel')}</label>
                  <input type="datetime-local" name="date" value="${this.toInputDate(order.date)}" />
                  <p class="helper-text">Si la fecha es mayor a 14 días se marcará como prioridad futura.</p>
                </div>
                <div class="form-group">
                  <label>${this.t('ordersTotalLabel')}</label>
                  <input type="number" step="0.01" name="total" value="${order.total || 0}" />
                </div>
              </div>
            </div>

            <div class="order-form-section">
              <h4>Equipo</h4>
              <div class="order-form-split">
                <div class="form-group">
                  <label>${this.t('orderTeamTechnicians')}</label>
                  <select id="order-techs" name="techniciansSelect" multiple size="5"></select>
                  <p class="helper-text">${this.t('orderCrewHelper')}</p>
                </div>
                <div class="form-group">
                  <label>${this.t('orderTeamLabor')}</label>
                  <select id="order-labors" name="laborsSelect" multiple size="5"></select>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label>Agregar personal extra</label>
                  <input type="text" id="order-crew-extra" name="crewExtra" placeholder="Nombres adicionales separados por coma" />
                </div>
              </div>
            </div>

            <div class="order-form-section">
              <h4>Detalle del trabajo</h4>
              <div class="order-form-split">
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label>${this.t('scheduleScope')}</label>
                  <textarea rows="2" name="scope" data-autofill="true">${encode(order.scope || '')}</textarea>
                  <p class="helper-text">Describe el alcance interno: qué se incluye y qué no.</p>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label>${this.t('scheduleDescription')}</label>
                  <textarea rows="3" name="description" data-autofill="true">${encode(order.description || '')}</textarea>
                  <p class="helper-text">Resume con las palabras del cliente lo que necesita.</p>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label>${this.t('scheduleTasks')}</label>
                  <textarea rows="3" name="tasks" data-autofill="true">${encode((order.tasks || []).join('\n'))}</textarea>
                  <p class="helper-text">${this.t('orderPrecautionsHelper')}</p>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label>${this.t('scheduleNotes')}</label>
                  <textarea rows="3" name="notes">${encode(order.notes || '')}</textarea>
                </div>
              </div>
            </div>

            <div class="order-form-section">
              <h4>Estado</h4>
              <div class="order-form-split">
                <div class="form-group">
                  <label>${this.t('colStatus')}</label>
                  <select name="status">
                    ${statusOptions}
                  </select>
                </div>
                <div class="form-group">
                  <label>${this.t('colPriority')}</label>
                  <select name="priority">
                    ${priorityOptions}
                  </select>
                </div>
              </div>
            </div>

            <div class="order-form-footer">
              <button class="btn btn-primary" type="submit">${this.t('saveChanges')}</button>
            </div>
          </form>`;
        modal.classList.add('active');
        const form = document.getElementById('edit-order-form');
        const serviceSelect = document.getElementById('order-service');
        const techSelect = document.getElementById('order-techs');
        const laborSelect = document.getElementById('order-labors');
        const windowSelect = document.getElementById('order-window');
        const windowCustomInput = document.getElementById('order-window-custom');
        const techniciansPrefill = [...(order.technicians || [])];
        if (!techniciansPrefill.length && order.crewLead) techniciansPrefill.push(order.crewLead);
        const laborPrefill = [...(order.labors || [])].filter((name) => !techniciansPrefill.includes(name));
        this.populateTeamSelect(techSelect, serviceSelect?.value || '', 'technicians', techniciansPrefill);
        this.populateTeamSelect(laborSelect, serviceSelect?.value || '', 'labor', laborPrefill);
        this.applyServicePreset(serviceSelect?.value, form, { initialize: isNew });
        this.updateWindowCustomField(windowSelect, windowCustomInput, customWindowValue);
        ['scope', 'description', 'tasks'].forEach((name) => {
          const field = form.querySelector(`[name="${name}"]`);
          if (field) {
            field.addEventListener('input', () => {
              field.dataset.autofill = 'false';
            });
          }
        });
        if (serviceSelect) {
          serviceSelect.addEventListener('change', () => {
            const currentTechSelection = techSelect
              ? Array.from(techSelect.selectedOptions).map((opt) => opt.value)
              : [];
            const currentLaborSelection = laborSelect
              ? Array.from(laborSelect.selectedOptions).map((opt) => opt.value)
              : [];
            this.applyServicePreset(serviceSelect.value, form, { resetCrew: true });
            this.populateTeamSelect(techSelect, serviceSelect.value, 'technicians', currentTechSelection);
            this.populateTeamSelect(laborSelect, serviceSelect.value, 'labor', currentLaborSelection);
            this.updateWindowCustomField(windowSelect, windowCustomInput);
          });
        }
        if (windowSelect) {
          windowSelect.addEventListener('change', () => this.updateWindowCustomField(windowSelect, windowCustomInput));
        }
        form.addEventListener('submit', (event) => {
          event.preventDefault();
          const data = new FormData(form);
          const serviceId = data.get('serviceId') || '';
          const serviceDef = this.getServiceDefinition(serviceId);
          const techniciansSelected = techSelect ? Array.from(techSelect.selectedOptions).map((opt) => opt.value) : [];
          const laborSelected = laborSelect ? Array.from(laborSelect.selectedOptions).map((opt) => opt.value) : [];
          const crewExtras = (data.get('crewExtra') || '')
            .split(',')
            .map((c) => c.trim())
            .filter(Boolean);
          const crewCombined = [...new Set([...techniciansSelected, ...laborSelected, ...crewExtras])];
          const crewLead = techniciansSelected[0] || crewCombined[0] || '';
          const supportingTechs = techniciansSelected.slice(1);
          const extraCrew = crewExtras.filter(
            (name) => !techniciansSelected.includes(name) && !laborSelected.includes(name)
          );
          const crewMembers = [...supportingTechs, ...laborSelected, ...extraCrew];
          const tasks = (data.get('tasks') || '')
            .split('\n')
            .map((t) => t.trim())
            .filter(Boolean);
          const windowSlotValue = data.get('windowSlot') || '';
          const windowLabel =
            windowSlotValue === 'custom'
              ? (data.get('windowCustom') || '').trim()
              : this.resolveWindowLabel(windowSlotValue);
          const scheduledDate = data.get('date')
            ? new Date(data.get('date')).toISOString()
            : order.date || new Date().toISOString();
          let priorityFinal = data.get('priority') || order.priority || 'normal';
          if (scheduledDate) {
            const diffDays = (new Date(scheduledDate).getTime() - Date.now()) / 86400000;
            if (diffDays >= 14) {
              priorityFinal = 'future';
            }
          }
          const payload = {
            id: isNew ? this.generateOrderId() : order.id,
            customerId: data.get('customerId') || order.customerId || '',
            customer: data.get('customer') || '',
            serviceId,
            service: serviceDef?.label || this.SERVICE_LIBRARY.find((s) => s.id === serviceId)?.label || order.service || '',
            address: data.get('address') || '',
            window: windowLabel,
            crewLead,
            crew: crewMembers,
            technicians: techniciansSelected,
            labors: [...laborSelected, ...extraCrew],
            scope: data.get('scope') || '',
            description: data.get('description') || '',
            tasks,
            notes: data.get('notes') || '',
            status: data.get('status') || order.status,
            priority: priorityFinal,
            total: parseFloat(data.get('total')) || 0,
            date: scheduledDate,
            lat: order.lat,
            lng: order.lng,
            future: priorityFinal === 'future',
          };
          if (isNew) {
            this.orders.unshift(payload);
          } else if (existingOrder) {
            Object.assign(existingOrder, payload);
          }
          this.persist('orders');
          this.closeModal();
          this.renderAll();
          if (!isNew && this.currentPage === 'schedule') {
            this.showScheduleDetail(payload.id);
          }
        });
      },

      formatStatus(status) {
        if (!status) return '—';
        const entry = this.ORDER_STATES && this.ORDER_STATES[status];
        return entry?.label || this.formatLabel(status);
      },

      formatPriority(priority) {
        if (!priority) return '—';
        return this.getPriorityLabel(priority);
      },

      formatLabel(value) {
        if (!value) return '—';
        return value
          .toString()
          .split(/[_\s]+/)
          .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
          .join(' ');
      },

      localize(esValue, enValue) {
        return this.currentLanguage === 'es' ? esValue : enValue;
      },

      formatList(items) {
        const list = (items || []).filter(Boolean);
        return list.length ? list.join(', ') : '—';
      },

      formatCustomerType(type) {
        if (!type) return this.t('customerTypeCommercial');
        const map = {
          residential: this.t('customerTypeResidential'),
          commercial: this.t('customerTypeCommercial'),
          contractor: this.t('customerTypeContractor'),
        };
        return map[type] || this.formatLabel(type);
      },

      normalizeName(value) {
        return (value || '').toString().trim().toLowerCase();
      },

      isMemberOnOrder(order, memberName) {
        if (!order || !memberName) return false;
        const target = this.normalizeName(memberName);
        if (!target) return false;
        const crewPool = [
          order.crewLead,
          ...(order.technicians || []),
          ...(order.labors || []),
          ...(Array.isArray(order.labor) ? order.labor : []),
          ...(order.crew || []),
        ];
        return crewPool.some((name) => this.normalizeName(name) === target);
      },

      getOrdersForRoster(roster = []) {
        if (!Array.isArray(roster) || !roster.length) return [];
        const normalizedRoster = roster.map((name) => this.normalizeName(name)).filter(Boolean);
        if (!normalizedRoster.length) return [];
        return (this.orders || []).filter((order) => {
          const crewPool = [
            order.crewLead,
            ...(order.technicians || []),
            ...(order.labors || []),
            ...(Array.isArray(order.labor) ? order.labor : []),
            ...(order.crew || []),
          ];
          return crewPool.some((member) => normalizedRoster.includes(this.normalizeName(member)));
        });
      },

      isSameDay(dateA, dateB) {
        if (!dateA || !dateB) return false;
        const a = new Date(dateA);
        const b = new Date(dateB);
        return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
      },

      isOrderCompleted(status) {
        return ['job_done', 'paid', 'invoiced', 'completed', 'archived'].includes(status);
      },

      renderScheduleFeed(jobs) {
        const feed = document.getElementById('schedule-feed');
        if (!feed) return;
        if (!jobs.length) {
          feed.innerHTML = `<p class="schedule-placeholder">${this.t('scheduleFeedEmpty')}</p>`;
          return;
        }
        const items = jobs
          .slice(0, 5)
          .map(
            (job) => `
          <li>
            <strong>${job.customer}</strong>
            <span>${this.formatScheduleTime(job.date)}</span>
            <span>${job.service}</span>
          </li>`
          )
          .join('');
        feed.innerHTML = `
          <div class="schedule-feed-title">${this.t('scheduleFeedTitle')}</div>
          <ul class="schedule-feed-list">${items}</ul>`;
      },

      highlightScheduleCard(orderId) {
        document.querySelectorAll('.schedule-card').forEach((card) => {
          const isActive = card.dataset.order === orderId;
          card.classList.toggle('active', isActive);
          card.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
        document.querySelectorAll('.timeline-entry').forEach((entry) => {
          const isActive = entry.dataset.order === orderId;
          entry.classList.toggle('active', isActive);
        });
      },

      formatScheduleTime(dateString) {
        if (!dateString) return '';
        const locale = this.getLocale();
        const date = new Date(dateString);
        const day = date.toLocaleDateString(locale, { weekday: 'short', day: 'numeric', month: 'short' });
        const time = date.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' });
        return `${day} · ${time}`;
      },

      formatScheduleDetailDate(dateString) {
        if (!dateString) return '';
        const locale = this.getLocale();
        return new Date(dateString).toLocaleDateString(locale, { weekday: 'long', day: 'numeric', month: 'long' });
      },

      getLocale() {
        return this.currentLanguage === 'es' ? 'es-US' : 'en-US';
      },

      formatCurrency(value) {
        return new Intl.NumberFormat(this.getLocale(), {
          style: 'currency',
          currency: 'USD',
          maximumFractionDigits: 0,
        }).format(value || 0);
      },

      formatNumber(value) {
        return new Intl.NumberFormat(this.getLocale(), {
          maximumFractionDigits: 2,
        }).format(value || 0);
      },

      formatShortDate(dateString) {
        if (!dateString) return '—';
        return new Date(dateString).toLocaleDateString(this.getLocale(), { month: 'short', day: 'numeric' });
      },

      billingItemTemplate(item, type) {
        const statusMeta = type === 'quote' ? this.getQuoteStatusMeta(item.status) : this.getInvoiceStatusMeta(item.status);
        const statusKey = (item.status || '').toLowerCase().replace(/\s+/g, '-');
        // Detect dark mode robustly: check html[data-theme] first, then .app-shell[data-theme]
        let isDark = false;
        try {
          if (typeof document !== 'undefined') {
            isDark = (document.documentElement?.dataset?.theme === 'dark') || (document.querySelector('.app-shell')?.dataset?.theme === 'dark');
          }
        } catch (e) {
          isDark = false;
        }
        const issuedLabel = this.formatShortDate(item.issued || item.date);
        const secondaryLabel =
          type === 'quote'
            ? `${this.t('billingValidUntil')}: ${this.formatShortDate(item.validUntil)}`
            : `${this.t('billingDueOn')}: ${this.formatShortDate(item.due)}`;
        const amount = this.formatCurrency(item.total || 0);
        const actionLabel = type === 'quote' ? this.t('billingActionSend') : this.t('billingActionCollect');
        return `
          <div class="billing-item${isDark ? ' billing-item--dark' : ''}" ${isDark ? 'style="background: linear-gradient(180deg, rgba(6,12,20,0.65), rgba(10,18,28,0.6)); border-color: rgba(255,255,255,0.03); box-shadow: 0 12px 28px rgba(0,0,0,0.6); color: #e6eef8;"' : ''}>
            <div class="billing-item-header">
              <div>
                <strong>${item.id}</strong>
                <div class="billing-meta">${item.customer || ''}</div>
              </div>
              <div class="billing-amount">${amount}</div>
            </div>
            <div class="billing-meta">
              <span>${this.t('startDate') || 'Inicio'}: ${issuedLabel}</span>
              <span>${secondaryLabel}</span>
            </div>
              <div class="billing-item-actions">
              <span class="billing-status-pill status-${statusKey}">${statusMeta.label}</span>
              <button class="btn btn-secondary btn-small">PDF</button>
              <button class="btn btn-primary btn-small">${actionLabel}</button>
            </div>
          </div>`;
      },

      getQuoteStatusMeta(status = '') {
        const map = {
          draft: { label: this.t('statusDraft') || 'Borrador', bg: 'rgba(148, 163, 184, 0.2)', color: '#475569' },
          sent: { label: this.t('statusSent') || 'Enviado', bg: 'rgba(59,130,246,0.18)', color: '#1d4ed8' },
          negotiation: { label: this.t('statusNegotiation') || 'Negociación', bg: 'rgba(250,204,21,0.22)', color: '#a16207' },
          won: { label: this.t('statusWon') || 'Ganada', bg: 'rgba(34,197,94,0.2)', color: '#15803d' },
          approved: { label: this.t('statusApproved') || 'Aprobada', bg: 'rgba(34,197,94,0.2)', color: '#15803d' },
          accepted: { label: this.t('statusAccepted') || 'Aceptada', bg: 'rgba(34,197,94,0.2)', color: '#15803d' },
          lost: { label: this.t('statusLost') || 'Perdida', bg: 'rgba(248,113,113,0.25)', color: '#b91c1c' },
        };
        const key = (status || '').toLowerCase();
        return map[key] || { label: this.formatLabel(status || 'open'), bg: 'rgba(148,163,184,0.18)', color: '#1f2937' };
      },

      getInvoiceStatusMeta(status = '') {
        const map = {
          open: { label: this.t('statusOpen') || 'Abierta', bg: 'rgba(59,130,246,0.18)', color: '#1d4ed8' },
          due: { label: this.t('statusDue') || 'Por vencer', bg: 'rgba(249,115,22,0.2)', color: '#c2410c' },
          overdue: { label: this.t('statusOverdue') || 'Vencida', bg: 'rgba(248,113,113,0.25)', color: '#b91c1c' },
          pending: { label: this.t('statusPending') || 'Pendiente', bg: 'rgba(249,115,22,0.2)', color: '#c2410c' },
          paid: { label: this.t('statusPaid') || 'Pagada', bg: 'rgba(34,197,94,0.2)', color: '#15803d' },
          partial: { label: this.t('statusPartial') || 'Parcial', bg: 'rgba(192,132,252,0.2)', color: '#6d28d9' },
        };
        const key = (status || '').toLowerCase();
        return map[key] || { label: this.formatLabel(status || 'open'), bg: 'rgba(148,163,184,0.18)', color: '#1f2937' };
      },

      navigateSchedule(step) {
        // Placeholder: in futuro se puede desplazar rangos semanales.
        this.renderSchedule();
      },

      renderOrders() {
        const tbody = document.getElementById('orders-tbody');
        if (!tbody) return;
        const showCosts = this.hasCapability('finance.view');
        const totalHeader = document.getElementById('orders-total-header');
        if (totalHeader) {
          totalHeader.style.display = showCosts ? 'table-cell' : 'none';
        }
        const search = (this.ordersSearch || '').toLowerCase();
        const searchInput = document.getElementById('search-orders');
        if (searchInput) {
          searchInput.placeholder = this.t('ordersSearchPlaceholder');
          if (searchInput.value !== this.ordersSearch) {
            searchInput.value = this.ordersSearch;
          }
        }
        const filtered = this.orders
          .filter(
            (order) =>
              (order.customer || '').toLowerCase().includes(search) ||
              (order.service || '').toLowerCase().includes(search)
          )
          .filter((order) => this.matchesOrdersFilter(order));

        if (!filtered.length) {
          tbody.innerHTML = `<tr><td colspan="${showCosts ? 7 : 6}">${this.t('ordersEmpty')}</td></tr>`;
          this.updateOrderFilterChips();
          return;
        }

        tbody.innerHTML = filtered.map((order) => this.orderRowTemplate(order, showCosts)).join('');
        this.updateOrderFilterChips();
        tbody.querySelectorAll('button[data-action="edit-order"]').forEach((btn) => {
          btn.addEventListener('click', (event) => {
            event.stopPropagation();
            this.openOrderForm(btn.dataset.order);
          });
        });
      },

      orderRowTemplate(order, showCosts = true) {
        return `
          <tr class="order-row" data-order="${order.id}">
            <td>${order.id}</td>
            <td>${order.customer}</td>
            <td>${order.service}</td>
            <td>${this.formatStatus(order.status)}</td>
            <td>${this.formatPriority(order.priority)}</td>
            ${showCosts ? `<td class="orders-col-total">${this.formatCurrency(order.total)}</td>` : ''}
            <td><button data-action="edit-order" data-order="${order.id}">${this.t('scheduleEdit')}</button></td>
          </tr>`;
      },

      matchesOrdersFilter(order) {
        const completed = new Set(['job_done', 'paid', 'invoiced', 'completed', 'archived']);
        if (this.ordersStatusFilter === 'active') {
          return !completed.has(order.status);
        }
        if (this.ordersStatusFilter === 'completed') {
          return completed.has(order.status);
        }
        return true;
      },

      updateOrderFilterChips() {
        document.querySelectorAll('[data-orders-filter]').forEach((chip) => {
          chip.classList.toggle('active', chip.dataset.ordersFilter === this.ordersStatusFilter);
        });
      },

      updateCustomerFilterChips() {
        document.querySelectorAll('[data-customer-filter]').forEach((chip) => {
          chip.classList.toggle('active', chip.dataset.customerFilter === this.customersFilter);
        });
      },

      updateInventoryFilterChips() {
        document.querySelectorAll('[data-inventory-filter]').forEach((chip) => {
          chip.classList.toggle('active', chip.dataset.inventoryFilter === this.inventoryFilter);
        });
      },

      updateInventoryViewControls() {
        document.querySelectorAll('[data-inventory-view]').forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.inventoryView === this.inventoryView);
        });
      },

      highlightCustomerCards() {
        document.querySelectorAll('.customer-card').forEach((card) => {
          card.classList.toggle('active', card.dataset.customer === this.selectedCustomerId);
        });
      },

      getOrderTemplate() {
        const now = new Date().toISOString();
        return {
          id: '',
          customer: '',
          customerId: '',
          serviceId: '',
          service: '',
          address: '',
          window: '',
          crewLead: '',
          crew: [],
          scope: '',
          description: '',
          tasks: [],
          notes: '',
          status: 'draft',
          priority: 'normal',
          total: 0,
          date: now,
          future: false,
          lat: 0,
          lng: 0,
        };
      },

      generateOrderId() {
        return `ORD-${Date.now().toString().slice(-6)}`;
      },

      generateCustomerId() {
        return `C-${Date.now().toString().slice(-5)}`;
      },

      generateStaffId() {
        return `STF-${Date.now().toString().slice(-4)}`;
      },

      generateInventoryId() {
        let counter = (this.inventory?.length || 0) + 1;
        let candidate = '';
        const exists = (id) => (this.inventory || []).some((item) => item.id === id);
        do {
          candidate = `INV-${String(counter).padStart(3, '0')}`;
          counter += 1;
        } while (exists(candidate));
        return candidate;
      },

      generatePoId() {
        return `PO-${Date.now().toString().slice(-6)}`;
      },

      generateUserId() {
        return `USR-${Date.now().toString().slice(-4)}`;
      },

      generateTempPassword(length = 8) {
        const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let result = '';
        for (let i = 0; i < length; i += 1) {
          result += alphabet.charAt(Math.floor(Math.random() * alphabet.length));
        }
        return result;
      },

      getRoleRoster(role) {
        const roster = new Set();
        (this.users || []).forEach((user) => {
          if (!user?.name) return;
          if (role === 'technicians' && ['tech', 'owner', 'admin'].includes(user.role)) roster.add(user.name);
          if (role === 'labor' && user.role === 'labor') roster.add(user.name);
        });
        (this.staffRecords || []).forEach((member) => {
          if (!member?.name) return;
          if (role === 'technicians' && member.category === 'technician') roster.add(member.name);
          if (role === 'labor' && member.category === 'labor') roster.add(member.name);
        });
        (this.orders || []).forEach((order) => {
          if (role === 'technicians') {
            if (order?.crewLead) roster.add(order.crewLead);
            (order?.technicians || []).forEach((name) => name && roster.add(name));
          } else {
            (order?.labors || order?.labor || order?.crew || []).forEach((name) => name && roster.add(name));
          }
        });
        return Array.from(roster);
      },

      getInventoryCategoryLabel(categoryId) {
        if (!categoryId) return this.t('inventoryFilterAll');
        const entry = (this.inventoryCategories || []).find((cat) => cat.id === categoryId);
        if (!entry) return categoryId;
        return this.t(entry.labelKey) || entry.labelKey;
      },

      resolveInventoryStatus(item) {
        const qty = Number(item?.qty ?? 0);
        const reorder = Number(item?.reorderPoint ?? item?.reorder ?? 0);
        const explicit = (item?.status || '').toLowerCase();
        if (['ok', 'low', 'critical'].includes(explicit)) {
          return explicit;
        }
        if (reorder > 0) {
          if (qty <= Math.max(1, reorder * 0.5)) return 'critical';
          if (qty <= reorder) return 'low';
        }
        if (qty <= 0) return 'critical';
        return 'ok';
      },

      getInventoryStatusMeta(item) {
        const statusKey = this.resolveInventoryStatus(item);
        const config = this.INVENTORY_STATUS[statusKey] || this.INVENTORY_STATUS.ok;
        return {
          key: statusKey,
          label: this.t(config.labelKey) || statusKey,
          className: config.className,
        };
      },

      calculateInventoryMetrics() {
        const list = this.inventory || [];
        const totalSkus = list.length;
        const totalQty = list.reduce((sum, item) => sum + (Number(item.qty) || 0), 0);
        const totalValue = list.reduce(
          (sum, item) => sum + (Number(item.qty) || 0) * (Number(item.cost) || 0),
          0
        );
        const lowItems = list.filter((item) => this.resolveInventoryStatus(item) !== 'ok');
        return { totalSkus, totalQty, totalValue, lowItems, lowCount: lowItems.length };
      },

      formatInventoryQty(item) {
        const qty = Number(item?.qty ?? 0).toLocaleString();
        const unit = item?.unit ? ` ${item.unit}` : '';
        return `${qty}${unit}`;
      },

      getInventoryItemById(id) {
        if (!id) return null;
        return (this.inventory || []).find((item) => item.id === id) || null;
      },

      findPurchaseProductBySku(sku) {
        if (!sku) return null;
        return (this.purchaseProducts || []).find((product) => product.sku === sku);
      },

      findPurchasePrice(item) {
        const product = this.findPurchaseProductBySku(item?.sku || item?.id);
        return product?.price || Number(item?.cost) || 0;
      },

      getPurchaseSupplierById(id) {
        if (!id) return null;
        return (this.purchaseSuppliers || []).find((supplier) => supplier.id === id) || null;
      },

      getPurchaseSupplierByName(name) {
        if (!name) return null;
        return (this.purchaseSuppliers || []).find((supplier) => supplier.name === name) || null;
      },

      formatPoStatus(status = 'draft') {
        const map = {
          draft: { es: 'Borrador', en: 'Draft' },
          sent: { es: 'Enviado', en: 'Sent' },
          received: { es: 'Recibido', en: 'Received' },
        };
        const key = (status || '').toLowerCase();
        const entry = map[key] || map.draft;
        return entry[this.currentLanguage] || status;
      },

      getPoStatusClass(status = 'draft') {
        const key = (status || '').toLowerCase();
        if (key === 'received') return 'ok';
        if (key === 'sent') return 'low';
        return 'critical';
      },

      getReportDatasetMeta(datasetId) {
        return (this.REPORT_DATASETS || []).find((set) => set.id === datasetId);
      },

      getDefaultDatasetColumns(datasetId) {
        const meta = this.getReportDatasetMeta(datasetId);
        if (!meta) return [];
        if (Array.isArray(meta.defaultColumns) && meta.defaultColumns.length) {
          return [...meta.defaultColumns];
        }
        return (meta.columns || []).map((col) => col.id);
      },

      saveReportDatasetDefaults(datasetId, columns) {
        if (!datasetId) return;
        this.reportDatasetDefaults = this.reportDatasetDefaults || {};
        this.reportDatasetDefaults[datasetId] = columns && columns.length ? [...columns] : this.getDefaultDatasetColumns(datasetId);
        this.persist('reportDatasetDefaults');
      },

      migrateReportTemplates() {
        let changed = false;
        const map = {
          overview: 'orders',
          financial: 'orders',
          operations: 'orders',
          technicians: 'staff',
          inventory: 'inventory',
        };
        (this.reportTemplates || []).forEach((template) => {
          if (!template.dataset) {
            template.dataset = map[template.category] || 'orders';
            changed = true;
          }
          if (!template.columns || !template.columns.length) {
            template.columns = this.getDefaultDatasetColumns(template.dataset);
            changed = true;
          }
          if (!('groupBy' in template)) {
            template.groupBy = '';
            changed = true;
          }
        });
        if (changed) {
          this.persist('reportTemplates');
        }
      },

      migrateReportHistory() {
        let changed = false;
        (this.reportHistory || []).forEach((entry) => {
          if (entry.snapshot) {
            if (!entry.columns || !entry.columns.length) {
              entry.columns = entry.snapshot.columns || [];
              changed = true;
            }
            if (!entry.dataset) {
              entry.dataset = entry.snapshot.dataset || 'orders';
              changed = true;
            }
            return;
          }
          const template =
            this.getReportTemplateById(entry.templateId) ||
            {
              dataset: entry.dataset || 'orders',
              columns: entry.columns && entry.columns.length ? entry.columns : this.getDefaultDatasetColumns(entry.dataset || 'orders'),
              groupBy: entry.groupBy || '',
            };
          entry.dataset = entry.dataset || template.dataset;
          entry.columns = entry.columns && entry.columns.length ? entry.columns : [...(template.columns || [])];
          entry.groupBy = entry.groupBy || template.groupBy || '';
          entry.snapshot = this.buildReportSnapshot(template);
          changed = true;
        });
        if (changed) {
          this.persist('reportHistory');
        }
      },

      getDatasetRows(datasetId) {
        switch (datasetId) {
          case 'orders':
            return (this.orders || []).map((order) => ({
              id: order.id,
              customer: order.customer,
              service: order.service,
              status: order.status,
              priority: order.priority,
              total: order.total || 0,
              date: order.date,
            }));
          case 'inventory':
            return (this.inventory || []).map((item) => ({
              name: item.name,
              sku: item.sku,
              qty: item.qty || 0,
              reorderPoint: item.reorderPoint || 0,
              vendor: item.vendor || '—',
              status: item.status || this.resolveInventoryStatus(item),
              cost: item.cost || 0,
            }));
          case 'staff':
            return (this.staffRecords || []).map((member) => ({
              name: member.name,
              role: member.role,
              category: member.category,
              status: member.status,
              hoursWeek: this.calculateStaffHours(member),
              location: member.location,
              specialization: member.specialization,
            }));
          case 'purchaseOrders':
            return (this.purchaseOrders || []).map((po) => ({
              id: po.id,
              vendorName: po.vendorName,
              jobNumber: po.jobNumber,
              status: po.status,
              total: po.total || 0,
              date: po.date,
            }));
          default:
            return [];
        }
      },

      exportInventoryCsv() {
        if (!this.requireCapability('inventory.export')) return;
        if (!this.inventory || !this.inventory.length) {
          alert(this.t('inventoryEmpty'));
          return;
        }
        const headers = ['ID', 'Name', 'SKU', 'Category', 'Qty', 'Unit', 'Reorder', 'Status', 'Location', 'Vendor', 'Unit Cost', 'Last Restock', 'Notes'];
        const rows = this.inventory.map((item) => [
          item.id || '',
          item.name || '',
          item.sku || '',
          this.getInventoryCategoryLabel(item.category || ''),
          item.qty ?? '',
          item.unit || '',
          item.reorderPoint ?? '',
          this.getInventoryStatusMeta(item).label,
          item.location || '',
          item.vendor || '',
          item.cost ?? '',
          item.lastRestock || '',
          item.notes || '',
        ]);
        this.downloadCsvFile(`inventory-${new Date().toISOString().slice(0, 10)}.csv`, headers, rows);
      },

      csvEscape(value) {
        if (value === null || value === undefined) return '';
        const str = value.toString();
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
          return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
      },

      downloadCsvFile(filename, headers, rows) {
        const csv = [headers, ...rows]
          .map((row) => row.map((value) => this.csvEscape(value ?? '')).join(','))
          .join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      },

      downloadPdfTable({ filename, title, headers, rows }) {
        if (!window.jspdf || !window.jspdf.jsPDF) {
          const message =
            this.currentLanguage === 'es'
              ? 'Motor PDF no disponible. Verifica tu conexión para cargar jsPDF.'
              : 'PDF engine not available. Please check your connection to load jsPDF.';
          alert(message);
          return;
        }
        const { jsPDF } = window.jspdf;
        const orientation = headers.length > 5 ? 'landscape' : 'portrait';
        const doc = new jsPDF({ orientation, unit: 'pt', format: 'a4' });
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 42;
        const colWidth = (pageWidth - margin * 2) / headers.length;
        const lineHeight = 14;
        let cursorY = margin;
        doc.setFontSize(16);
        doc.text(title || 'Reporte', margin, cursorY);
        cursorY += 24;
        const drawRow = (cells, isHeader = false) => {
          if (cursorY > pageHeight - margin) {
            doc.addPage();
            cursorY = margin;
          }
          doc.setFont(undefined, isHeader ? 'bold' : 'normal');
          let blockHeight = lineHeight;
          cells.forEach((cell, index) => {
            const text = cell === null || cell === undefined ? '' : cell.toString();
            const wrapped = doc.splitTextToSize(text, colWidth - 10);
            doc.text(wrapped, margin + index * colWidth + 4, cursorY + lineHeight);
            blockHeight = Math.max(blockHeight, wrapped.length * lineHeight);
          });
          cursorY += blockHeight + 8;
        };
        drawRow(headers, true);
        doc.setFont(undefined, 'normal');
        rows.forEach((row) => drawRow(row, false));
        doc.save(filename || 'snapshot.pdf');
      },

      getServiceDefinition(serviceId) {
        return this.SERVICE_LIBRARY.find((service) => service.id === serviceId);
      },

      findServiceIdByLabel(label) {
        if (!label) return null;
        return this.SERVICE_LIBRARY.find((service) => service.label === label)?.id || null;
      },

      getWindowSlotFromLabel(label) {
        if (!label) return null;
        const match = this.WINDOW_OPTIONS.find((option) => option.label === label);
        return match ? match.id : label ? 'custom' : null;
      },

      resolveWindowLabel(slot) {
        if (!slot) return '';
        return this.WINDOW_OPTIONS.find((option) => option.id === slot)?.label || slot;
      },

      populateTeamSelect(select, serviceId, role, locked = null) {
        if (!select) return;
        const service = this.getServiceDefinition(serviceId) || {};
        const recommended =
          role === 'technicians'
            ? service.technicians || service.crew || []
            : service.labor || [];
        const roster = this.getRoleRoster(role);
        const base = locked && locked.length ? locked : recommended;
        const universe = Array.from(new Set([...(recommended || []), ...roster, ...(locked || [])]));
        select.innerHTML = universe
          .map((name) => `<option value="${this.escapeHtml(name)}" ${base.includes(name) ? 'selected' : ''}>${this.escapeHtml(name)}</option>`)
          .join('');
      },

      applyServicePreset(serviceId, form, { initialize = false, resetCrew = false } = {}) {
        const service = this.getServiceDefinition(serviceId);
        if (!service || !form) return;
        const scopeField = form.querySelector('[name="scope"]');
        if (scopeField && (initialize || scopeField.dataset.autofill === 'true' || !scopeField.value.trim())) {
          scopeField.value = service.scope || '';
          scopeField.dataset.autofill = 'true';
        }
        const descriptionField = form.querySelector('[name="description"]');
        if (descriptionField && (initialize || descriptionField.dataset.autofill === 'true' || !descriptionField.value.trim())) {
          if (service.descriptionHint) {
            descriptionField.placeholder = service.descriptionHint;
          }
          descriptionField.dataset.autofill = 'true';
        }
        const tasksField = form.querySelector('[name="tasks"]');
        if (tasksField && (initialize || tasksField.dataset.autofill === 'true' || !tasksField.value.trim())) {
          tasksField.value = (service.tasks || []).join('\n');
          tasksField.dataset.autofill = 'true';
        }
        const windowSelect = form.querySelector('#order-window');
        if (windowSelect && service.window && (initialize || resetCrew)) {
          windowSelect.value = service.window;
        }
      },

      updateWindowCustomField(select, input, preset) {
        if (!select || !input) return;
        const isCustom = select.value === 'custom';
        input.style.display = isCustom ? 'block' : 'none';
        if (isCustom && typeof preset === 'string') {
          input.value = preset;
        }
      },

      escapeHtml(value = '') {
        return value
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      },

      getCustomerAddresses(customerId, customerName) {
        const byId = (this.customers || []).find((c) => c.id === customerId);
        if (byId) return Array.from(new Set(byId.locations || []));
        if (!customerName) return [];
        const byName = (this.customers || []).find((c) => c.name === customerName);
        return byName ? Array.from(new Set(byName.locations || [])) : [];
      },

      getPriorityLabel(priority) {
        const map = {
          high: { es: 'Alta', en: 'High' },
          normal: { es: 'Normal', en: 'Normal' },
          low: { es: 'Baja', en: 'Low' },
          future: { es: 'Futura', en: 'Future' },
        };
        const entry = map[priority];
        return entry ? entry[this.currentLanguage] : this.formatLabel(priority);
      },

      getKnownAddresses() {
        const registry = new Set();
        (this.customers || []).forEach((customer) => {
          (customer.locations || []).forEach((address) => address && registry.add(address));
        });
        (this.orders || []).forEach((order) => {
          if (order.address) registry.add(order.address);
        });
        return Array.from(registry);
      },

      toInputDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const pad = (n) => String(n).padStart(2, '0');
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(
          date.getMinutes()
        )}`;
      },


      renderQuotes() {
        const quotesBoard = document.getElementById('quotes-board');
        const invoicesBoard = document.getElementById('invoices-board');
        const quotesHistoryBody = document.getElementById('quotes-history-body');
        const invoicesHistoryBody = document.getElementById('invoices-history-body');
        if (!quotesBoard || !invoicesBoard) return;
        const billingSearchInput = document.getElementById('billing-search');
        if (billingSearchInput) {
          billingSearchInput.placeholder = this.t('billingSearchPlaceholder');
          if (billingSearchInput.value !== this.billingSearch) {
            billingSearchInput.value = this.billingSearch;
          }
        }
        const query = (this.billingSearch || '').toLowerCase();
        const matchesQuery = (entity) =>
          [entity.id, entity.customer, entity.status, entity.service].filter(Boolean).join(' ').toLowerCase().includes(query);
        const sortedQuotes = [...this.quotes]
          .filter(matchesQuery)
          .sort((a, b) => new Date(b.issued || b.date || 0) - new Date(a.issued || a.date || 0));
        const sortedInvoices = [...this.invoices]
          .filter(matchesQuery)
          .sort((a, b) => new Date(b.due || b.date || 0) - new Date(a.due || a.date || 0));

        const quotesTotalValue = this.quotes.reduce((sum, quote) => sum + (quote.total || 0), 0);
        const quotesWon = this.quotes.filter((quote) => ['won', 'approved', 'accepted'].includes((quote.status || '').toLowerCase()));
        const quotesWonValue = quotesWon.reduce((sum, quote) => sum + (quote.total || 0), 0);
        const invoicesDue = this.invoices.filter((invoice) =>
          ['open', 'due', 'overdue', 'pending'].includes((invoice.status || '').toLowerCase())
        );
        const invoicesDueValue = invoicesDue.reduce((sum, invoice) => sum + (invoice.total || 0), 0);

        const quotesValueNode = document.getElementById('quotes-total-value');
        if (quotesValueNode) quotesValueNode.textContent = this.formatCurrency(quotesTotalValue);
        const quotesCountNode = document.getElementById('quotes-total-count');
        if (quotesCountNode) quotesCountNode.textContent = `${this.quotes.length} ${this.t('billingQuotesCount')}`;
        const quotesWonNode = document.getElementById('quotes-won-value');
        if (quotesWonNode) quotesWonNode.textContent = this.formatCurrency(quotesWonValue);
        const quotesWonRateNode = document.getElementById('quotes-won-rate');
        if (quotesWonRateNode) {
          const rate = this.quotes.length ? Math.round((quotesWon.length / this.quotes.length) * 100) : 0;
          quotesWonRateNode.textContent = `${rate}% win rate`;
        }
        const invoicesDueNode = document.getElementById('invoices-due-value');
        if (invoicesDueNode) invoicesDueNode.textContent = this.formatCurrency(invoicesDueValue);
        const invoicesCountNode = document.getElementById('invoices-due-count');
        if (invoicesCountNode) invoicesCountNode.textContent = `${invoicesDue.length} ${this.t('billingInvoicesCount')}`;

        const quotesBadge = document.getElementById('quotes-count');
        if (quotesBadge) quotesBadge.textContent = sortedQuotes.length;
        const invoicesBadge = document.getElementById('invoices-count');
        if (invoicesBadge) invoicesBadge.textContent = sortedInvoices.length;

        quotesBoard.innerHTML = sortedQuotes.length
          ? sortedQuotes.map((quote) => this.billingItemTemplate(quote, 'quote')).join('')
          : `<div class="billing-empty">${this.t('ordersEmpty')}</div>`;
        invoicesBoard.innerHTML = sortedInvoices.length
          ? sortedInvoices.map((invoice) => this.billingItemTemplate(invoice, 'invoice')).join('')
          : `<div class="billing-empty">${this.t('ordersEmpty')}</div>`;

        if (quotesHistoryBody) {
          const quotesHistory = sortedQuotes
            .filter((quote) => ['won', 'lost', 'approved', 'accepted'].includes((quote.status || '').toLowerCase()))
            .slice(0, 5);
          quotesHistoryBody.innerHTML = quotesHistory.length
            ? quotesHistory
                .map(
                  (quote) => `
                <tr>
                  <td>${quote.id}</td>
                  <td>${quote.customer}</td>
                  <td>${this.getQuoteStatusMeta(quote.status).label}</td>
                  <td>${this.formatShortDate(quote.issued || quote.date)}</td>
                </tr>`
                )
                .join('')
            : `<tr><td colspan="4">${this.t('ordersEmpty')}</td></tr>`;
        }

        if (invoicesHistoryBody) {
          const invoicesHistory = sortedInvoices.filter((inv) => (inv.status || '').toLowerCase() === 'paid').slice(0, 5);
          invoicesHistoryBody.innerHTML = invoicesHistory.length
            ? invoicesHistory
                .map(
                  (invoice) => `
                <tr>
                  <td>${invoice.id}</td>
                  <td>${invoice.customer}</td>
                  <td>${this.getInvoiceStatusMeta(invoice.status).label}</td>
                  <td>${this.formatShortDate(invoice.due || invoice.date)}</td>
                </tr>`
                )
                .join('')
            : `<tr><td colspan="4">${this.t('ordersEmpty')}</td></tr>`;
        }
      },

      renderCustomers() {
        const grid = document.getElementById('customers-grid');
        if (!grid) return;
        const total = this.customers.length;
        const totalAddresses = this.customers.reduce((sum, customer) => sum + (customer.locations?.length || 0), 0);
        const activeOrders = this.orders.filter((order) => !this.isOrderCompleted(order.status)).length;
        const totalStat = document.getElementById('customer-stat-total');
        const addressStat = document.getElementById('customer-stat-addresses');
        const activeStat = document.getElementById('customer-stat-active');
        const totalHint = document.getElementById('customer-stat-total-hint');
        const addressHint = document.getElementById('customer-stat-addresses-hint');
        const activeHint = document.getElementById('customer-stat-active-hint');
        if (totalStat) totalStat.textContent = total;
        if (addressStat) addressStat.textContent = totalAddresses;
        if (activeStat) activeStat.textContent = activeOrders;
        if (totalHint) totalHint.textContent = this.t('customersStatTotalHint');
        if (addressHint) addressHint.textContent = this.t('customersStatLocationsHint');
        if (activeHint) activeHint.textContent = this.t('customersStatActiveHint');
        const customersSearchInput = document.getElementById('customers-search');
        if (customersSearchInput) {
          customersSearchInput.placeholder = this.t('customersSearchPlaceholder');
          if (customersSearchInput.value !== this.customersSearch) {
            customersSearchInput.value = this.customersSearch;
          }
        }
        const filtered = this.customers
          .filter((customer) => {
            if (this.customersFilter !== 'all' && customer.type !== this.customersFilter) return false;
            const query = (this.customersSearch || '').toLowerCase();
            if (!query) return true;
            const haystack = [customer.name, ...(customer.contacts || [])].join(' ').toLowerCase();
            return haystack.includes(query);
          })
          .sort((a, b) => a.name.localeCompare(b.name));
        if (!filtered.length) {
          grid.innerHTML = `<p class="schedule-placeholder">${this.t('ordersEmpty')}</p>`;
          this.updateCustomerFilterChips();
          const detailPanel = document.getElementById('customer-detail');
          if (detailPanel) detailPanel.classList.add('hidden');
          this.selectedCustomerId = null;
          this.selectedCustomerAddress = null;
          return;
        }
        if (!this.selectedCustomerId || !filtered.some((c) => c.id === this.selectedCustomerId)) {
          this.selectedCustomerId = filtered[0].id;
          this.selectedCustomerAddress = null;
        }
        grid.innerHTML = filtered
          .map(
            (customer) => `
          <div class="customer-card ${customer.id === this.selectedCustomerId ? 'active' : ''}" data-customer="${customer.id}">
            <h4>${customer.name}</h4>
            <span>${(customer.contacts && customer.contacts[0]) || ''}</span>
            <span>${customer.locations?.length || 0} ${this.t('customerAddresses').toLowerCase()}</span>
            <button data-customer="${customer.id}">${this.t('customerViewProfile')}</button>
          </div>`
          )
          .join('');
        this.updateCustomerFilterChips();
        grid.querySelectorAll('.customer-card button').forEach((btn) => {
          btn.addEventListener('click', (event) => {
            event.stopPropagation();
            this.showCustomerDetail(btn.dataset.customer);
          });
        });
        grid.querySelectorAll('.customer-card').forEach((card) => {
          card.addEventListener('click', () => this.showCustomerDetail(card.dataset.customer));
        });
        this.highlightCustomerCards();
        this.showCustomerDetail(this.selectedCustomerId);
      },

      showCustomerDetail(id) {
        const customer = this.customers.find((c) => c.id === id);
        if (!customer) return;
        this.selectedCustomerId = id;
        const panel = document.getElementById('customer-detail');
        if (!panel) return;
        panel.classList.remove('hidden');
        this.highlightCustomerCards();
        document.getElementById('customer-detail-name').textContent = customer.name;
        document.getElementById('customer-detail-type').textContent = this.formatCustomerType(customer.type);
        document.getElementById('customer-detail-contact').textContent = (customer.contacts && customer.contacts[1]) || '—';
        document.getElementById('customer-detail-email').textContent = (customer.contacts && customer.contacts[0]) || '—';
        const addresses = customer.locations || [];
        const customerOrders = this.orders.filter((order) => order.customer === customer.name);
        const activeOrders = customerOrders.filter((order) => !this.isOrderCompleted(order.status)).length;
        const totalSpent = customerOrders.reduce((sum, order) => sum + (order.total || 0), 0);
        const outstanding = customerOrders
          .filter((order) => !this.isOrderCompleted(order.status))
          .reduce((sum, order) => sum + (order.total || 0), 0);
        const lastServiceOrder = [...customerOrders].sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        document.getElementById('customer-detail-location-count').textContent = addresses.length;
        document.getElementById('customer-detail-order-count').textContent = customerOrders.length;
        document.getElementById('customer-detail-active-count').textContent = activeOrders;
        document.getElementById('customer-detail-total').textContent = this.formatCurrency(totalSpent);
        document.getElementById('customer-detail-outstanding').textContent = this.formatCurrency(outstanding);
        document.getElementById('customer-detail-last-service').textContent = lastServiceOrder
          ? this.formatScheduleDetailDate(lastServiceOrder.date)
          : '—';
        const addressList = document.getElementById('customer-address-list');
        addressList.innerHTML = addresses.length
          ? addresses
              .map(
                (addr) => `
            <div class="customer-address-chip ${addr === this.selectedCustomerAddress ? 'active' : ''}" data-address="${addr}">
              <span>${addr}</span>
              <button type="button" data-new-order="${addr}">＋</button>
            </div>`
              )
              .join('')
          : `<p class="schedule-placeholder">${this.t('customerAddressesEmpty')}</p>`;
        addressList.querySelectorAll('.customer-address-chip').forEach((chip) => {
          chip.addEventListener('click', (event) => {
            if (event.target.matches('button')) return;
            this.selectedCustomerAddress = chip.dataset.address;
            this.showCustomerDetail(id);
          });
        });
        addressList.querySelectorAll('button[data-new-order]').forEach((btn) => {
          btn.addEventListener('click', (event) => {
            event.stopPropagation();
            this.openOrderForm(null, { customer: customer.name, address: btn.dataset.newOrder, customerId: customer.id });
          });
        });
        const ordersContainer = document.getElementById('customer-orders');
        const ordersForTable = this.selectedCustomerAddress
          ? customerOrders.filter((order) => (order.address || '') === this.selectedCustomerAddress)
          : customerOrders;
        if (ordersForTable.length) {
          ordersContainer.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>${this.t('colService')}</th>
                  <th>${this.t('colStatus')}</th>
                  <th>${this.t('ordersDateLabel')}</th>
                  <th>${this.t('ordersTotalLabel')}</th>
                </tr>
              </thead>
              <tbody>
                ${ordersForTable
                  .map(
                    (order) => `
                  <tr>
                    <td>${order.id}</td>
                    <td>${order.service}</td>
                    <td>${this.formatStatus(order.status)}</td>
                    <td>${this.formatScheduleDetailDate(order.date)}</td>
                    <td>${this.formatCurrency(order.total)}</td>
                  </tr>`
                  )
                  .join('')}
              </tbody>
            </table>`;
        } else {
          ordersContainer.innerHTML = `<p class="schedule-placeholder">${this.t('customerOrdersEmpty')}</p>`;
        }
        const financialList = document.getElementById('customer-financial');
        if (financialList) {
          financialList.innerHTML = `
            <li>${this.t('ordersTotalLabel')}: <strong>${this.formatCurrency(totalSpent)}</strong></li>
            <li>${this.t('customerOutstanding')}: <strong>${this.formatCurrency(outstanding)}</strong></li>
            <li>${this.t('ordersFilterActive')}: <strong>${activeOrders}</strong></li>
            <li>${this.t('customerOrders')}: <strong>${customerOrders.length}</strong></li>
          `;
        }
        const newOrderBtn = document.getElementById('customer-new-order');
        if (newOrderBtn) {
          newOrderBtn.onclick = () => this.showOrderAddressStep(customer);
        }
        this.highlightCustomerCards();
      },

      openStaffModal() {
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        title.textContent = this.t('staffAddMember');
        const categoryOptions = [
          { value: 'technician', label: this.t('staffCategoryTechnician') },
          { value: 'labor', label: this.t('staffCategoryLabor') },
        ];
        const certificationOptions =
          (this.certificationsCatalog && this.certificationsCatalog.length ? this.certificationsCatalog : this.DEFAULT_CERTIFICATIONS) ||
          [];
        body.innerHTML = `
          <form id="staff-form" class="modal-step">
            <div class="form-grid">
              <div class="form-group">
                <label>${this.t('staffFormName')}</label>
                <input type="text" name="name" required />
              </div>
              <div class="form-group">
                <label>${this.t('staffFormCategory')}</label>
                <select name="category">
                  ${categoryOptions.map((opt) => `<option value="${opt.value}">${opt.label}</option>`).join('')}
                </select>
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>${this.t('staffFormCerts')}</label>
                <div style="display:flex; flex-direction:column; gap:6px;">
                  ${certificationOptions
                    .map(
                      (cert, index) => `
                      <label style="display:flex; gap:8px; align-items:center; font-size:13px;">
                        <input type="checkbox" name="certifications" value="${cert}" ${index < 2 ? 'checked' : ''}/>
                        <span>${cert}</span>
                      </label>`
                    )
                    .join('')}
                  <label style="display:flex; flex-direction:column; gap:4px;">
                    <span>${this.t('staffFormCertsOther')}</span>
                    <input type="text" name="certificationsOther" placeholder="CSLB Specialty, CAL/OSHA..." />
                  </label>
                  <p class="helper-text">${this.t('staffFormCertsHint')}</p>
                </div>
              </div>
            </div>
            <div class="modal-step-actions" style="justify-content:flex-end;">
              <button class="btn btn-primary" type="submit">${this.t('staffFormSave')}</button>
            </div>
          </form>`;
        modal.classList.add('active');
        document.getElementById('staff-form').addEventListener('submit', (event) => {
          event.preventDefault();
          const data = new FormData(event.currentTarget);
          const name = (data.get('name') || '').trim();
          if (!name) return;
          const category = data.get('category') || 'technician';
          const role = category === 'technician' ? 'Lead Technician' : 'Labor Helper';
          const specialization = category === 'technician' ? 'Servicio técnico' : 'Apoyo en campo';
          const availability = 'Disponible';
          const location = '—';
          const hoursWeek = 0;
          const certifications = Array.from(document.querySelectorAll('input[name="certifications"]:checked')).map((input) => input.value);
          const otherCerts = (data.get('certificationsOther') || '')
            .split(',')
            .map((item) => item.trim())
            .filter(Boolean);
          const combinedCerts = [...new Set([...certifications, ...otherCerts])];
          const technicians = category === 'technician' ? [name] : [];
          const labors = category === 'labor' ? [name] : [];
          const newMember = {
            id: this.generateStaffId(),
            name,
            category,
            role: role || (category === 'labor' ? 'Labor' : 'Technician'),
            specialization,
            availability,
            status: 'active',
            hoursWeek,
            hoursMonth: hoursWeek * 4,
            location,
            certifications: combinedCerts,
            lastJob: '—',
            nextShift: '—',
            technicians,
            labors,
          };
          this.staffRecords.unshift(newMember);
          this.persist('staff');
          this.selectedStaffId = newMember.id;
          this.renderStaff();
          this.closeModal();
        });
      },

      renderStaff() {
        const grid = document.getElementById('staff-grid');
        if (!grid) return;
        const staff = (this.staffRecords || []).filter((member) => ['technician', 'labor'].includes(member.category));
        const totalNode = document.getElementById('staff-total');
        const availableNode = document.getElementById('staff-available');
        const hoursNode = document.getElementById('staff-hours');
        const searchInput = document.getElementById('staff-search');
        if (searchInput) {
          searchInput.placeholder = this.t('staffSearchPlaceholder');
          if (searchInput.value !== this.staffSearch) {
            searchInput.value = this.staffSearch;
          }
        }
        if (totalNode) totalNode.textContent = staff.length;
        if (availableNode) availableNode.textContent = staff.filter((member) => member.status === 'active').length;
        if (hoursNode) {
          const avgHours =
            staff.length ? Math.round(staff.reduce((sum, member) => sum + this.calculateStaffHours(member), 0) / staff.length) : 0;
          hoursNode.textContent = avgHours;
        }
        if (!staff.length) {
          grid.innerHTML = `<p class="schedule-placeholder">${this.t('ordersEmpty')}</p>`;
          return;
        }
        const query = (this.staffSearch || '').toLowerCase();
        const filtered = staff
          .filter((member) => this.staffFilter === 'all' || member.category === this.staffFilter)
          .filter((member) => {
            if (!query) return true;
            const haystack = [member.name, member.specialization, member.role].join(' ').toLowerCase();
            return haystack.includes(query);
          })
          .sort((a, b) => a.name.localeCompare(b.name));
        if (!this.selectedStaffId || !staff.some((member) => member.id === this.selectedStaffId)) {
          this.selectedStaffId = filtered[0]?.id || staff[0].id;
        }
        grid.innerHTML = filtered
          .map((member) => this.staffCardTemplate(member))
          .join('') || `<p class="schedule-placeholder">${this.t('ordersEmpty')}</p>`;
        grid.querySelectorAll('.staff-card').forEach((card) => {
          card.addEventListener('click', () => {
            this.selectedStaffId = card.dataset.staff;
            this.renderStaff();
          });
        });
        this.updateStaffFilterChips();
        this.renderStaffTimesheet();
      },

      staffCardTemplate(member) {
        const initials = member.name
          .split(' ')
          .map((part) => part.charAt(0))
          .join('')
          .slice(0, 2)
          .toUpperCase();
        const certifications = (member.certifications || []).join(' · ');
        const weeklyHours = this.calculateStaffHours(member);
        const hoursClass = weeklyHours >= 40 ? 'hours-red' : weeklyHours >= 31 ? 'hours-orange' : 'hours-green';
        return `
          <div class="staff-card ${member.id === this.selectedStaffId ? 'active' : ''}" data-staff="${member.id}">
            <div style="display:flex; gap:12px; align-items:center;">
              <div class="staff-avatar">${initials}</div>
              <div>
                <strong>${member.name}</strong>
                <div class="staff-meta">${member.role}</div>
              </div>
            </div>
            <p style="font-size:13px; color: var(--text-secondary);">${member.specialization || ''}</p>
            <div class="staff-hours-pill ${hoursClass}">${weeklyHours}h · ${this.t('staffWeekLabel') || 'Semana actual'}</div>
            <div class="staff-meta">${this.t('staffLastJob') || 'Último trabajo'} · ${member.lastJob || '—'}</div>
            <div style="font-size:12px; color: var(--text-secondary);">${certifications}</div>
          </div>`;
      },

      renderStaffTimesheet() {
        const tbody = document.getElementById('staff-hours-body');
        const tag = document.getElementById('staff-timesheet-name');
        if (!tbody) return;
        const staff = (this.staffRecords || []).filter((member) => ['technician', 'labor'].includes(member.category));
        const selected = staff.find((member) => member.id === this.selectedStaffId) || staff[0];
        if (tag) {
          tag.textContent = selected ? `${selected.name} · ${selected.role}` : '';
        }
        const weekRangeLabel = document.getElementById('staff-week-range');
        if (weekRangeLabel) {
          weekRangeLabel.textContent = this.formatWeekRange();
        }
        if (!selected) {
          tbody.innerHTML = `<tr><td colspan="4">${this.t('staffTimesheetEmpty')}</td></tr>`;
          return;
        }
        const timesheet = this.buildStaffTimesheet(selected);
        if (!timesheet.length) {
          tbody.innerHTML = `<tr><td colspan="4">${this.t('staffTimesheetEmpty')}</td></tr>`;
          return;
        }
        tbody.innerHTML = timesheet
          .map(
            (entry) => `
          <tr>
            <td>${entry.day}</td>
            <td>${entry.job}</td>
            <td>${entry.detail}</td>
            <td>${entry.hours}h</td>
          </tr>`
          )
          .join('');
      },

      updateStaffFilterChips() {
        document.querySelectorAll('[data-staff-filter]').forEach((chip) => {
          chip.classList.toggle('active', chip.dataset.staffFilter === this.staffFilter);
        });
      },

      buildStaffTimesheet(member) {
        if (!member) return [];
        const { start, end } = this.getCurrentWeekRange();
        return (this.orders || [])
          .filter((order) => this.isMemberInOrder(member, order))
          .filter((order) => this.isDateWithinRange(order.date, start, end))
          .map((order) => {
            const windowLabel = order.window || '';
            const detailParts = [order.service || ''];
            if (windowLabel) detailParts.push(windowLabel);
            if (order.address) detailParts.push(order.address);
            return {
              day: this.formatTimesheetDay(order.date),
              job: order.id,
              detail: detailParts.filter(Boolean).join(' · '),
              hours: this.parseWindowHours(windowLabel),
              date: order.date,
            };
          })
          .sort((a, b) => new Date(b.date) - new Date(a.date));
      },

      isMemberInOrder(member, order) {
        if (!member || !order) return false;
        const name = member.name;
        const technicians = order.technicians || [];
        const labors = order.labors || order.labor || order.crew || [];
        return order.crewLead === name || technicians.includes(name) || labors.includes(name);
      },

      parseWindowHours(windowLabel) {
        if (!windowLabel) return 4;
        const match = windowLabel.match(/(\d{1,2}):(\d{2}).*?(\d{1,2}):(\d{2})/);
        if (!match) return 4;
        const [, sh, sm, eh, em] = match.map(Number);
        const start = sh + sm / 60;
        const end = eh + em / 60;
        const diff = Math.max(1, end - start);
        return Math.round(diff * 2) / 2;
      },

      formatTimesheetDay(dateString) {
        if (!dateString) return '—';
        return new Date(dateString).toLocaleDateString(this.getLocale(), { weekday: 'long', month: 'short', day: 'numeric' });
      },

      calculateStaffHours(member) {
        return this.buildStaffTimesheet(member).reduce((sum, entry) => sum + entry.hours, 0);
      },

      getCurrentWeekRange() {
        const now = new Date();
        const start = new Date(now);
        start.setHours(0, 0, 0, 0);
        start.setDate(start.getDate() - start.getDay());
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        end.setHours(23, 59, 59, 999);
        return { start, end };
      },

      isDateWithinRange(dateString, start, end) {
        if (!dateString) return false;
        const date = new Date(dateString);
        return date >= start && date <= end;
      },

      formatWeekRange() {
        const { start, end } = this.getCurrentWeekRange();
        const formatter = new Intl.DateTimeFormat(this.getLocale(), { month: 'short', day: 'numeric' });
        return `${formatter.format(start)} – ${formatter.format(end)}`;
      },

      formatDateTime(dateString) {
        if (!dateString) return '—';
        return new Date(dateString).toLocaleString(this.getLocale(), {
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        });
      },

      renderInventory() {
        const grid = document.getElementById('inventory-grid');
        const tableWrapper = document.getElementById('inventory-table');
        const tableBody = document.getElementById('inventory-table-body');
        const restockList = document.getElementById('inventory-restock-list');
        const restockCard = document.getElementById('inventory-restock-card');
        if (!grid || !tableWrapper || !tableBody) return;
        const searchInput = document.getElementById('inventory-search');
        if (searchInput) {
          const placeholder = this.t('inventorySearchPlaceholder');
          if (placeholder) searchInput.placeholder = placeholder;
          if (searchInput.value !== this.inventorySearch) {
            searchInput.value = this.inventorySearch;
          }
        }
        this.updateInventoryFilterChips();
        this.updateInventoryViewControls();
        const metrics = this.calculateInventoryMetrics();
        const totalSkusEl = document.getElementById('inventory-stat-skus');
        const totalHintEl = document.getElementById('inventory-stat-skus-hint');
        const lowEl = document.getElementById('inventory-stat-low');
        const valueEl = document.getElementById('inventory-stat-value');
        const valueHintEl = document.getElementById('inventory-stat-value-hint');
        const lowHintEl = document.getElementById('inventory-stat-low-hint');
        if (totalSkusEl) totalSkusEl.textContent = metrics.totalSkus;
        if (lowEl) lowEl.textContent = metrics.lowCount;
        if (valueEl) valueEl.textContent = this.formatCurrency(metrics.totalValue);
        if (totalHintEl) {
          const suffix = this.currentLanguage === 'es' ? 'unidades en stock' : 'units on hand';
          totalHintEl.textContent = `${metrics.totalQty.toLocaleString()} ${suffix}`;
        }
        if (lowHintEl) {
          const suffix = this.currentLanguage === 'es' ? 'materiales listos para compra' : 'SKUs to reorder';
          lowHintEl.textContent = `${metrics.lowCount} ${suffix}`;
        }
        if (valueHintEl) {
          const suffix = this.currentLanguage === 'es' ? 'incluye equipos mayores' : 'includes capital equipment';
          valueHintEl.textContent = suffix;
        }
        const search = (this.inventorySearch || '').toLowerCase();
        const filtered = (this.inventory || [])
          .filter((item) => {
            if (this.inventoryFilter !== 'all' && item.category !== this.inventoryFilter) return false;
            if (!search) return true;
            const haystack = [item.name, item.sku, item.vendor, item.location].filter(Boolean).join(' ').toLowerCase();
            return haystack.includes(search);
          })
          .sort((a, b) => {
            const priority = { critical: 0, low: 1, ok: 2 };
            const statusDiff =
              (priority[this.resolveInventoryStatus(a)] ?? 3) - (priority[this.resolveInventoryStatus(b)] ?? 3);
            if (statusDiff !== 0) return statusDiff;
            return (a.name || '').localeCompare(b.name || '');
          });
        const showCards = this.inventoryView === 'cards';
        grid.style.display = showCards ? 'grid' : 'none';
        tableWrapper.classList.toggle('active', !showCards);
        if (showCards) {
          grid.innerHTML = filtered.length
            ? filtered
                .map((item) => {
                  const statusMeta = this.getInventoryStatusMeta(item);
                  return `
                <div class="inventory-card">
                  <div class="inventory-card-header">
                    <div>
                      <p class="inventory-sku">${this.escapeHtml(item.sku || item.id || '')}</p>
                      <h3>${this.escapeHtml(item.name || '')}</h3>
                    </div>
                    <span class="inventory-status ${statusMeta.className}">${statusMeta.label}</span>
                  </div>
                  <div class="inventory-card-metrics">
                    <div>
                      <span>${this.t('colQty')}</span>
                      <strong>${this.formatInventoryQty(item)}</strong>
                    </div>
                    <div>
                      <span>${this.t('inventoryReorder')}</span>
                      <strong>${Number(item.reorderPoint || 0)}</strong>
                    </div>
                    <div>
                      <span>${this.t('inventoryValue')}</span>
                      <strong>${this.formatCurrency((Number(item.qty) || 0) * (Number(item.cost) || 0))}</strong>
                    </div>
                  </div>
                  <div class="inventory-card-footer">
                    <span>${this.getInventoryCategoryLabel(item.category)}</span>
                    <div class="inventory-card-actions">
                      <button class="btn btn-secondary btn-small" data-action="inventory-edit" data-id="${item.id}">${this.t('inventoryEdit')}</button>
                      <button class="btn btn-secondary btn-small" data-action="inventory-delete" data-id="${item.id}">${this.t('inventoryDelete')}</button>
                    </div>
                  </div>
                  <div style="font-size:12px; color:var(--text-secondary); display:flex; gap:12px; flex-wrap:wrap;">
                    <span>📦 ${this.t('inventoryLocation')}: ${item.location || '—'}</span>
                    <span>🤝 ${this.t('inventoryVendor')}: ${item.vendor || '—'}</span>
                  </div>
                </div>`;
                })
                .join('')
            : `<div class="inventory-empty card">${this.t('inventoryEmpty')}</div>`;
        } else {
          tableBody.innerHTML = filtered.length
            ? filtered
                .map((item) => {
                  const statusMeta = this.getInventoryStatusMeta(item);
                  return `
                <tr>
                  <td>
                    <strong>${this.escapeHtml(item.name || '')}</strong>
                    <div class="billing-meta">${this.getInventoryCategoryLabel(item.category)}</div>
                  </td>
                  <td>${this.escapeHtml(item.sku || '—')}</td>
                  <td>${this.formatInventoryQty(item)}</td>
                  <td>${Number(item.reorderPoint || 0)}</td>
                  <td>${this.escapeHtml(item.location || '—')}</td>
                  <td><span class="inventory-status ${statusMeta.className}">${statusMeta.label}</span></td>
                  <td>
                    <div class="inventory-card-actions">
                      <button class="btn btn-secondary btn-small" data-action="inventory-edit" data-id="${item.id}">${this.t('inventoryEdit')}</button>
                      <button class="btn btn-secondary btn-small" data-action="inventory-delete" data-id="${item.id}">${this.t('inventoryDelete')}</button>
                    </div>
                  </td>
                </tr>`;
                })
                .join('')
            : `<tr><td colspan="7">${this.t('inventoryEmpty')}</td></tr>`;
        }
        document.querySelectorAll('[data-action="inventory-edit"]').forEach((btn) => {
          btn.addEventListener('click', () => this.openInventoryModal(btn.dataset.id));
        });
        document.querySelectorAll('[data-action="inventory-delete"]').forEach((btn) => {
          btn.addEventListener('click', () => this.deleteInventoryItem(btn.dataset.id));
        });
        if (restockList) {
          const queue = metrics.lowItems
            .slice()
            .sort((a, b) => {
              const ratioA = (Number(a.qty) || 0) / Math.max(1, Number(a.reorderPoint) || 1);
              const ratioB = (Number(b.qty) || 0) / Math.max(1, Number(b.reorderPoint) || 1);
              return ratioA - ratioB;
            })
            .slice(0, 5);
          if (!queue.length) {
            restockList.innerHTML = `<p class="inventory-empty">${this.t('inventoryRestockEmpty')}</p>`;
          } else {
            const vendorGroups = queue.reduce((acc, item) => {
              const key = item.vendor || '—';
              acc[key] = acc[key] || [];
              acc[key].push(item);
              return acc;
            }, {});
            restockList.innerHTML = Object.entries(vendorGroups)
              .map(([vendor, items]) => {
                const list = items
                  .map((entry) => {
                    const qty = this.formatInventoryQty(entry);
                    const reorder = Number(entry.reorderPoint || 0);
                    return `<li style="font-size:13px;">${this.escapeHtml(entry.name || '')} · ${qty} / ${reorder}</li>`;
                  })
                  .join('');
                const payload = encodeURIComponent(
                  JSON.stringify(
                    items.map((entry) => ({
                      sku: entry.sku || entry.id || entry.name,
                      name: entry.name,
                      qty: Math.max(1, (Number(entry.reorderPoint) || 0) - (Number(entry.qty) || 0)),
                      price: this.findPurchasePrice(entry),
                    }))
                  )
                );
                return `
                <div class="inventory-report-item">
                  <div>
                    <strong>${this.escapeHtml(vendor)}</strong>
                    <ul class="schedule-task-list" style="margin-top:8px;">${list}</ul>
                  </div>
                  <div class="report-actions">
                    <button class="btn btn-secondary btn-small" data-action="inventory-restock" data-id="${items[0]?.id || ''}">${this.t(
                      'inventoryRestockAction'
                    )}</button>
                    <button class="btn btn-primary btn-small" data-action="inventory-vendor-po" data-vendor="${encodeURIComponent(
                      vendor
                    )}" data-items="${payload}">${this.t('inventoryGeneratePO')}</button>
                  </div>
                </div>`;
              })
              .join('');
          }
          restockList.querySelectorAll('[data-action="inventory-restock"]').forEach((btn) => {
            btn.addEventListener('click', () => this.openInventoryModal(btn.dataset.id));
          });
          restockList.querySelectorAll('[data-action="inventory-vendor-po"]').forEach((btn) => {
            btn.addEventListener('click', () => {
              const vendorName = decodeURIComponent(btn.dataset.vendor || '');
              const items = btn.dataset.items ? JSON.parse(decodeURIComponent(btn.dataset.items)) : [];
              this.openPurchaseOrderWizard(vendorName, items);
            });
          });
        }
        this.renderInventoryFleet();
        this.renderPurchaseOrders();
      },

      renderInventoryFleet() {
        const grid = document.getElementById('inventory-fleet-grid');
        if (!grid) return;
        if (!this.fleet || !this.fleet.length) {
          grid.innerHTML = `<p class="inventory-empty">${this.t('inventoryTruckEmpty')}</p>`;
          return;
        }
        grid.innerHTML = this.fleet
          .map((truck) => {
            const loadout = (truck.loadout || []).map((entry) => {
              const item = this.getInventoryItemById(entry.itemId);
              const label = item ? item.name : entry.itemId;
              const qty = entry.qty || 0;
              return `<span class="fleet-chip">${qty}× ${this.escapeHtml(label || '')}</span>`;
            });
            return `
          <div class="fleet-card">
            <div class="fleet-card-header">
              <div>
                <p class="inventory-sku">${this.escapeHtml(truck.plate || truck.id || '')}</p>
                <h4>${this.escapeHtml(truck.name || '')}</h4>
              </div>
              <span class="fleet-tag">${this.escapeHtml(truck.leadRole || '')}</span>
            </div>
            <div class="fleet-meta">${this.t('inventoryTruckLead')}: <strong>${this.escapeHtml(truck.lead || '—')}</strong></div>
            <div class="fleet-meta">${this.t('inventoryTruckCapacity')}: ${truck.capacityUsed || 0}%</div>
            <div class="fleet-meta">${this.t('inventoryTruckLastService')}: ${
              truck.lastService
                ? new Date(truck.lastService).toLocaleDateString(this.getLocale(), { month: 'short', day: 'numeric' })
                : '—'
            }</div>
            <div>
              <p class="fleet-meta" style="text-transform:uppercase; letter-spacing:0.16em;">${this.t('inventoryTruckLoadout')}</p>
              <div class="fleet-loadout">
                ${loadout.length ? loadout.join('') : `<span class="fleet-meta">${this.t('inventoryTruckEmpty')}</span>`}
              </div>
            </div>
          </div>`;
          })
          .join('');
      },

      renderPurchaseOrders() {
        const body = document.getElementById('po-history-body');
        if (!body) return;
        const orders = this.purchaseOrders || [];
        if (!orders.length) {
          body.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:16px;">${this.t('poHistoryEmpty')}</td></tr>`;
          return;
        }
        body.innerHTML = orders
          .slice(0, 5)
          .map(
            (order) => `
          <tr>
            <td>${order.id}</td>
            <td>${order.vendorName || '—'}</td>
            <td>${order.jobNumber || '—'}</td>
            <td>${new Date(order.date).toLocaleDateString(this.getLocale())}</td>
            <td>${this.formatCurrency(order.total || 0)}</td>
            <td><span class="inventory-status ${this.getPoStatusClass(order.status)}">${this.formatPoStatus(order.status)}</span></td>
            <td>
              <div class="report-actions">
                <button class="btn btn-secondary btn-small" data-action="po-view" data-id="${order.id}">👁</button>
              </div>
            </td>
          </tr>`
          )
          .join('');
        body.querySelectorAll('[data-action="po-view"]').forEach((btn) => {
          btn.addEventListener('click', () => this.openPurchaseOrderSummary(btn.dataset.id));
        });
      },

      updateReportCategoryChips() {
        document.querySelectorAll('[data-report-category]').forEach((chip) => {
          chip.classList.toggle('active', chip.dataset.reportCategory === this.reportsCategory);
        });
      },

      updateReportRangeChips() {
        document.querySelectorAll('[data-report-range]').forEach((chip) => {
          chip.classList.toggle('active', chip.dataset.reportRange === this.reportsRange);
        });
      },

      getReportSummary() {
        const orders = this.orders || [];
        const quotes = this.quotes || [];
        const revenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
        const activeOrders = orders.filter((order) => !this.isOrderCompleted(order.status)).length;
        const quotesWon = quotes.filter((quote) => ['won', 'approved', 'accepted'].includes((quote.status || '').toLowerCase())).length;
        const conversion = quotes.length ? Math.round((quotesWon / quotes.length) * 100) : 0;
        const averageTicket = orders.length ? Math.round(revenue / orders.length) : 0;
        const staff = (this.staffRecords || []).filter((member) => ['technician', 'labor'].includes(member.category));
        const avgHours =
          staff.length ? Math.round(staff.reduce((sum, member) => sum + this.calculateStaffHours(member), 0) / staff.length) : 0;
        const inventoryMetrics = this.calculateInventoryMetrics();
        return {
          revenue,
          conversion,
          backlog: activeOrders,
          averageTicket,
          avgHours,
          lowStock: inventoryMetrics.lowCount,
          inventoryValue: inventoryMetrics.totalValue,
        };
      },

      buildReportInsights(summary) {
        const fmt = (value) => this.formatCurrency(value);
        const category = this.reportsCategory;
        const base = {
          overview: [
            { title: this.t('reportsKpiRevenue'), value: fmt(summary.revenue), detail: `${this.t('orders')}: ${this.orders.length}` },
            { title: this.t('reportsKpiConversion'), value: `${summary.conversion}%`, detail: `${this.t('quotes')}: ${this.quotes.length}` },
            { title: this.t('reportsKpiBacklog'), value: summary.backlog, detail: this.t('reportsInsightActive') || 'Órdenes activas' },
            { title: this.t('reportsInsightCycle') || 'Ciclo promedio', value: '2.4 días', detail: 'De asignación a cierre' },
          ],
          financial: [
            { title: this.t('reportsKpiRevenue'), value: fmt(summary.revenue), detail: this.t('summaryAvgTicket') + ': ' + fmt(summary.averageTicket) },
            { title: this.t('billingInvoicesDue'), value: fmt(this.invoices.reduce((sum, inv) => sum + (inv.total || 0), 0)), detail: this.t('billingInvoicesCount') },
            { title: this.t('inventoryValue'), value: fmt(summary.inventoryValue), detail: this.t('inventoryReportValue') },
          ],
          operations: [
            { title: this.t('reportsKpiBacklog'), value: summary.backlog, detail: this.t('reportsInsightActive') || 'Órdenes activas' },
            { title: this.t('reportsInsightTravel') || 'Tiempo en tránsito', value: '1.2 h', detail: 'Promedio diario' },
            { title: this.t('reportsInsightCycle') || 'Ciclo promedio', value: '2.4 días', detail: 'De asignación a cierre' },
          ],
          technicians: [
            { title: this.t('reportsInsightTechUtil') || 'Utilización', value: `${summary.avgHours}h`, detail: this.t('staffWeekLabel') },
            { title: this.t('reportsInsightTravel') || 'Tiempo en tránsito', value: '1.2 h', detail: 'Promedio diario' },
            { title: this.t('reportsInsightWinRate') || 'Win rate', value: `${summary.conversion}%`, detail: this.t('billingQuotesValue') },
          ],
          inventory: [
            { title: this.t('inventoryKpiLow'), value: summary.lowStock, detail: this.t('inventoryRestockQueue') },
            { title: this.t('inventoryKpiValue'), value: fmt(summary.inventoryValue), detail: this.t('inventoryReportValue') },
            { title: this.t('inventoryReportLow'), value: `${summary.lowStock} SKU`, detail: this.t('inventoryRestockEmpty') },
          ],
        };
        return base[category] || base.overview;
      },

      renderReportsPage() {
        const summary = this.getReportSummary();
        const revenueNode = document.getElementById('reports-kpi-revenue');
        const conversionNode = document.getElementById('reports-kpi-conversion');
        const backlogNode = document.getElementById('reports-kpi-backlog');
        const revenueHint = document.getElementById('reports-kpi-revenue-hint');
        const conversionHint = document.getElementById('reports-kpi-conversion-hint');
        const backlogHint = document.getElementById('reports-kpi-backlog-hint');
        if (revenueNode) revenueNode.textContent = this.formatCurrency(summary.revenue);
        if (conversionNode) conversionNode.textContent = `${summary.conversion}%`;
        if (backlogNode) backlogNode.textContent = summary.backlog;
        if (revenueHint) revenueHint.textContent = `${this.t('summaryAvgTicket')}: ${this.formatCurrency(summary.averageTicket)}`;
        if (conversionHint) conversionHint.textContent = `${this.t('quotes')}: ${this.quotes.length}`;
        if (backlogHint) backlogHint.textContent = this.t('reportsInsightActive') || 'Órdenes activas';
        this.updateReportCategoryChips();
        this.updateReportRangeChips();
        const insights = this.buildReportInsights(summary);
        const insightsEl = document.getElementById('reports-insights');
        if (insightsEl) {
          insightsEl.innerHTML = insights
            .map(
              (insight) => `
            <div class="report-card">
              <span class="report-meta">${insight.title}</span>
              <strong>${insight.value}</strong>
              <p>${insight.detail || ''}</p>
            </div>`
            )
            .join('');
        }
        const templatesEl = document.getElementById('reports-templates');
        if (templatesEl) {
          const templates = (this.reportTemplates || []).filter(
            (template) => this.reportsCategory === 'overview' || template.category === this.reportsCategory
          );
          templatesEl.innerHTML = templates.length
            ? templates
                .map(
                  (template) => `
              <div class="report-queue-item">
                <div>
                  <strong>${template.name}</strong>
                  <small>${template.scope}</small>
                </div>
                <div class="report-actions">
                  <button class="btn btn-secondary btn-small" data-action="report-preview" data-id="${template.id}">${this.t('reportsTemplatePreview')}</button>
                  <button class="btn btn-primary btn-small" data-action="report-send" data-id="${template.id}">${this.t('reportsTemplateSend')}</button>
                </div>
              </div>`
                )
                .join('')
            : `<p class="inventory-empty">${this.t('reportsHistoryEmpty') || 'Sin registros'}</p>`;
          templatesEl.querySelectorAll('[data-action="report-preview"]').forEach((btn) => {
            btn.addEventListener('click', () => this.openReportPreview(btn.dataset.id));
          });
          templatesEl.querySelectorAll('[data-action="report-send"]').forEach((btn) => {
            btn.addEventListener('click', () => this.runReportTemplate(btn.dataset.id));
          });
        }
        this.renderReportsHistory();
        this.renderReportDetails();
      },

      buildReportSnapshot(template) {
        const dataset = template.dataset || 'orders';
        const columns = template.columns && template.columns.length ? template.columns : this.getReportDatasetMeta(dataset)?.columns?.map((col) => col.id) || [];
        const rows = this.getDatasetRows(dataset).slice(0, 25).map((row) => {
          const reduced = {};
          columns.forEach((col) => {
            reduced[col] = row[col];
          });
          return reduced;
        });
        return { dataset, columns, rows, groupBy: template.groupBy || '' };
      },

      renderDatasetPreview(datasetId, columns, groupBy = '') {
        const meta = this.getReportDatasetMeta(datasetId);
        if (!meta) return `<p>${this.t('reportsPreviewEmpty')}</p>`;
        const cols = columns && columns.length ? columns : meta.columns.map((col) => col.id);
        const rows = this.getDatasetRows(datasetId);
        if (!rows.length) return `<p>${this.t('reportsPreviewEmpty')}</p>`;
        if (!rows.length) return `<p>${this.t('reportsPreviewEmpty')}</p>`;
        const sample = rows.slice(0, 10);
        if (groupBy) {
          const grouped = {};
          rows.forEach((row) => {
            const key = row[groupBy] || '—';
            if (!grouped[key]) grouped[key] = { count: 0, total: 0 };
            grouped[key].count += 1;
            if (typeof row.total === 'number') grouped[key].total += row.total;
            if (typeof row.qty === 'number') grouped[key].total += row.qty;
          });
          const groupRows = Object.entries(grouped)
            .map(
              ([key, data]) => `
            <tr>
              <td>${this.escapeHtml(key)}</td>
              <td>${data.count}</td>
              <td>${this.formatNumber(data.total)}</td>
            </tr>`
            )
            .join('');
          return `
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>${this.t('reportsGrouping')}</th>
                    <th>${this.t('reportsColumns')}</th>
                    <th>${this.t('inventoryValue')}</th>
                  </tr>
                </thead>
                <tbody>${groupRows}</tbody>
              </table>
            </div>`;
        }
        const headers = cols
          .map((col) => {
            const metaCol = meta.columns.find((c) => c.id === col);
            return `<th>${metaCol ? metaCol.label : col}</th>`;
          })
          .join('');
        const body = sample
          .map((row) => {
            const cells = cols.map((col) => `<td>${this.formatPreviewValue(row[col])}</td>`).join('');
            return `<tr>${cells}</tr>`;
          })
          .join('');
        return `
          <div class="table-wrapper">
            <table>
              <thead><tr>${headers}</tr></thead>
              <tbody>${body}</tbody>
            </table>
          </div>`;
      },

      formatPreviewValue(value) {
        if (value === undefined || value === null) return '—';
        if (typeof value === 'number') return this.formatNumber(value);
        if (value instanceof Date) return value.toLocaleDateString(this.getLocale());
        if (!Number.isNaN(Date.parse(value)) && /\d{4}-\d{2}-\d{2}/.test(value)) {
          return new Date(value).toLocaleDateString(this.getLocale());
        }
        return value;
      },

      openReportSnapshot(historyId) {
        const entry = (this.reportHistory || []).find((hist) => hist.id === historyId);
        if (!entry || !entry.snapshot) {
          alert('Sin snapshot disponible.');
          return;
        }
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        modal.classList.add('active');
        title.textContent = `${entry.name} · Snapshot`;
        const meta = this.getReportDatasetMeta(entry.snapshot.dataset);
        const headers = entry.snapshot.columns
          .map((col) => {
            const metaCol = meta?.columns?.find((c) => c.id === col);
            return `<th>${metaCol ? metaCol.label : col}</th>`;
          })
          .join('');
        const rows = entry.snapshot.rows
          .map((row) => {
            const cells = entry.snapshot.columns.map((col) => `<td>${this.formatPreviewValue(row[col])}</td>`).join('');
            return `<tr>${cells}</tr>`;
          })
          .join('');
        const preferredFormat = ['PDF', 'CSV'].includes((entry.format || '').toUpperCase()) ? entry.format.toUpperCase() : 'CSV';
        body.innerHTML = `
          <div class="table-wrapper">
            <table>
              <thead><tr>${headers}</tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
          <div class="report-download-controls">
            <div>
              <small>${this.t('reportsBuilderDataset')}: ${this.t(meta?.labelKey || entry.snapshot.dataset)} · ${entry.snapshot.rows.length} ${this.t('reportsRows') || 'filas'}</small>
            </div>
            <div class="report-download-actions">
              <label for="snapshot-format">${this.t('reportsBuilderFormat')}</label>
              <select id="snapshot-format">
                <option value="PDF" ${preferredFormat === 'PDF' ? 'selected' : ''}>PDF</option>
                <option value="CSV" ${preferredFormat === 'CSV' ? 'selected' : ''}>CSV</option>
              </select>
              <button class="btn btn-primary btn-small" id="snapshot-download" data-history="${entry.id}">${this.t('reportsTemplateDownload')}</button>
            </div>
          </div>`;
        const formatSelect = document.getElementById('snapshot-format');
        const downloadBtn = document.getElementById('snapshot-download');
        if (downloadBtn) {
          downloadBtn.addEventListener('click', () => this.downloadReportSnapshot(entry.id, formatSelect.value));
        }
      },

      downloadReportSnapshot(historyId, format = 'CSV') {
        const entry = (this.reportHistory || []).find((hist) => hist.id === historyId);
        if (!entry || !entry.snapshot) {
          alert('Sin snapshot disponible.');
          return;
        }
        const meta = this.getReportDatasetMeta(entry.snapshot.dataset);
        const headers = entry.snapshot.columns.map((col) => meta?.columns?.find((c) => c.id === col)?.label || col);
        const rows = entry.snapshot.rows.map((row) => entry.snapshot.columns.map((col) => this.formatPreviewValue(row[col])));
        const normalized = (format || '').toUpperCase();
        if (normalized === 'PDF') {
          this.downloadPdfTable({
            filename: `${entry.id}.pdf`,
            title: entry.name,
            headers,
            rows,
          });
        } else {
          this.downloadCsvFile(`${entry.id}.csv`, headers, rows);
        }
      },

      rerunReportFromHistory(historyId) {
        const entry = (this.reportHistory || []).find((hist) => hist.id === historyId);
        if (!entry) return;
        let template = this.getReportTemplateById(entry.templateId);
        if (!template) {
          template = {
            id: entry.templateId || `TMP-${Date.now()}`,
            name: entry.name,
            dataset: entry.snapshot?.dataset || 'orders',
            columns: entry.snapshot?.columns || [],
            format: entry.format,
            scope: entry.scope,
            groupBy: entry.snapshot?.groupBy || '',
          };
          this.reportTemplates.unshift(template);
          this.persist('reportTemplates');
        }
        this.runReportTemplate(template.id);
      },

      buildReportSnapshot(template) {
        const dataset = template.dataset || 'orders';
        const columns =
          template.columns && template.columns.length
            ? template.columns
            : this.getReportDatasetMeta(dataset)?.columns?.map((col) => col.id) || [];
        const rows = this.getDatasetRows(dataset).slice(0, 25).map((row) => {
          const reduced = {};
          columns.forEach((col) => {
            reduced[col] = row[col];
          });
          return reduced;
        });
        return { dataset, columns, rows, groupBy: template.groupBy || '' };
      },

      renderReportsHistory() {
        const body = document.getElementById('reports-history-body');
        if (!body) return;
        const history = this.reportHistory || [];
        if (!history.length) {
          body.innerHTML = `<tr><td colspan="5" class="reports-history-empty">${this.t('reportsHistoryEmpty') || 'Sin registros'}</td></tr>`;
          return;
        }
        body.innerHTML = history
          .map(
            (entry) => `
          <tr>
            <td>${entry.name}</td>
            <td>${entry.scope}</td>
            <td>${entry.format}</td>
            <td>${this.formatDateTime(entry.ranAt)}</td>
            <td>
              <div class="report-actions">
                <button class="btn btn-secondary btn-small" data-action="report-snapshot" data-id="${entry.id}">${this.t('reportsViewSnapshot')}</button>
                <button class="btn btn-secondary btn-small" data-action="report-rerun" data-id="${entry.id}">${this.t('reportsRunAgain')}</button>
                <button class="btn btn-primary btn-small" data-action="report-download" data-format="${entry.format || 'CSV'}" data-id="${entry.id}">${this.t('reportsTemplateDownload')}</button>
              </div>
            </td>
          </tr>`
          )
          .join('');
        body.querySelectorAll('[data-action="report-snapshot"]').forEach((btn) => {
          btn.addEventListener('click', () => this.openReportSnapshot(btn.dataset.id));
        });
        body.querySelectorAll('[data-action="report-rerun"]').forEach((btn) => {
          btn.addEventListener('click', () => this.rerunReportFromHistory(btn.dataset.id));
        });
        body.querySelectorAll('[data-action="report-download"]').forEach((btn) => {
          btn.addEventListener('click', () => this.downloadReportSnapshot(btn.dataset.id, btn.dataset.format));
        });
        this.renderReportSchedules();
      },

      renderReportDetails() {
        const detail = document.getElementById('reports-detail-body');
        if (!detail) return;
        const model = this.buildReportDetailModel(this.reportsCategory);
        if (!model) {
          detail.innerHTML = `<p class="inventory-empty">${this.t('reportsHistoryEmpty') || 'Sin registros'}</p>`;
          return;
        }
        const cardsHtml = model.cards?.length
          ? `<div class="report-detail-cards">${model.cards
              .map(
                (card) => `
              <div class="report-detail-card">
                <span class="report-detail-card-label">${card.label}</span>
                <strong>${card.value}</strong>
                ${card.hint ? `<small>${card.hint}</small>` : ''}
              </div>`
              )
              .join('')}</div>`
          : '';
        const barsHtml = model.bars?.length ? `<div class="report-detail-bars">${this.renderReportBars(model.bars)}</div>` : '';
        const tableHtml = model.table ? this.renderReportDetailTable(model.table) : '';
        detail.innerHTML =
          cardsHtml || barsHtml || tableHtml
            ? `${cardsHtml}${barsHtml}${tableHtml}`
            : `<p class="inventory-empty">${this.t('reportsHistoryEmpty') || 'Sin registros'}</p>`;
      },

      renderReportDetailTable(model) {
        if (!model || !model.headers) return '';
        const headerHtml = model.headers.map((title) => `<th>${title}</th>`).join('');
        const rowsHtml = model.rows && model.rows.length
          ? model.rows.map((row) => `<tr>${row.map((cell) => `<td>${cell}</td>`).join('')}</tr>`).join('')
          : `<tr><td colspan="${model.headers.length}" class="reports-history-empty">${this.t('reportsHistoryEmpty') || 'Sin registros'}</td></tr>`;
        return `
          <div class="report-detail-table">
            ${model.title ? `<div class="report-detail-table-title">${model.title}</div>` : ''}
            <div class="table-wrapper">
              <table>
                <thead><tr>${headerHtml}</tr></thead>
                <tbody>${rowsHtml}</tbody>
              </table>
            </div>
          </div>`;
      },

      renderReportBars(bars = []) {
        if (!bars.length) return '';
        const total = bars.reduce((sum, entry) => sum + (entry.value || 0), 0) || 1;
        return bars
          .map((bar) => {
            const ratio = Math.min(100, total ? Math.max(bar.value > 0 ? 6 : 0, ((bar.value || 0) / total) * 100) : 0);
            return `
            <div class="report-bar">
              <span>${bar.label}</span>
              <div class="report-bar-track">
                <div class="report-bar-fill" style="width:${ratio}%;"></div>
              </div>
              <span class="report-bar-value">${bar.valueLabel ?? bar.value}</span>
            </div>`;
          })
          .join('');
      },

      buildReportDetailModel(category) {
        const orders = this.orders || [];
        const staff = this.staffRecords || [];
        const inventory = this.inventory || [];
        const summary = this.getReportSummary ? this.getReportSummary() : {};
        const buildDistribution = (list, labelFn) => {
          const map = {};
          list.forEach((item) => {
            const label = labelFn(item);
            if (!label) return;
            map[label] = (map[label] || 0) + 1;
          });
          return Object.entries(map).map(([label, value]) => ({ label, value, valueLabel: `${value}` }));
        };

        if (category === 'financial') {
          const totalRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
          const avgTicket = orders.length ? totalRevenue / orders.length : 0;
          const activeOrders = orders.filter((order) => !this.isOrderCompleted(order.status));
          const customerMap = {};
          orders.forEach((order) => {
            const key = order.customer || this.localize('Cliente sin nombre', 'Unnamed client');
            customerMap[key] = customerMap[key] || { total: 0, count: 0 };
            customerMap[key].total += order.total || 0;
            customerMap[key].count += 1;
          });
          const topCustomers = Object.entries(customerMap)
            .map(([customer, data]) => ({ customer, ...data }))
            .sort((a, b) => b.total - a.total)
            .slice(0, 5);
          return {
            cards: [
              { label: this.t('reportsKpiRevenue'), value: this.formatCurrency(totalRevenue), hint: `${orders.length} ${this.t('orders')}` },
              { label: this.t('summaryAvgTicket'), value: this.formatCurrency(avgTicket), hint: this.localize('Ticket promedio', 'Average ticket') },
              { label: this.t('reportsInsightActive'), value: activeOrders.length, hint: this.localize('Órdenes abiertas', 'Open jobs') },
            ],
            bars: buildDistribution(orders, (order) => this.formatStatus(order.status)),
            table: {
              title: this.localize('Top clientes', 'Top customers'),
              headers: [this.t('labelCustomer'), this.t('orders'), this.localize('Total', 'Total')],
              rows: topCustomers.map((entry) => [entry.customer, entry.count, this.formatCurrency(entry.total)]),
            },
          };
        }

        if (category === 'operations') {
          const activeOrders = orders.filter((order) => !this.isOrderCompleted(order.status));
          const urgentOrders = activeOrders.filter((order) => (order.priority || '').toLowerCase() === 'high');
          const now = Date.now();
          const avgAge =
            activeOrders.length > 0
              ? activeOrders.reduce((sum, order) => sum + Math.max(0, (now - new Date(order.date || now).getTime()) / 86400000), 0) /
                activeOrders.length
              : 0;
          const upcoming = [...activeOrders].sort((a, b) => new Date(a.date || 0) - new Date(b.date || 0)).slice(0, 5);
          return {
            cards: [
              { label: this.localize('Órdenes activas', 'Open jobs'), value: activeOrders.length, hint: this.localize('Incluye agenda futura', 'Includes future schedule') },
              { label: this.localize('Urgentes', 'Urgent'), value: urgentOrders.length, hint: this.localize('Prioridad alta', 'High priority') },
              { label: this.localize('Edad promedio', 'Average age'), value: `${Math.round(avgAge * 10) / 10} d`, hint: this.localize('Desde la creación', 'Since created') },
            ],
            bars: buildDistribution(activeOrders, (order) => this.getPriorityLabel(order.priority || 'normal')),
            table: {
              title: this.localize('Próximas visitas', 'Upcoming jobs'),
              headers: [this.localize('Orden', 'Order'), this.localize('Fecha', 'Date'), this.t('labelCustomer'), this.t('colStatus')],
              rows: upcoming.map((order) => [order.id, this.formatShortDate(order.date), order.customer, this.formatStatus(order.status)]),
            },
          };
        }

        if (category === 'technicians') {
          const technicians = staff.filter((member) => member.category === 'technician');
          const activeTechs = technicians.filter((member) => (member.status || '').toLowerCase() === 'active');
          const avgHours =
            technicians.length > 0
              ? Math.round(technicians.reduce((sum, member) => sum + this.calculateStaffHours(member), 0) / technicians.length)
              : 0;
          const today = new Date().toDateString();
          const crewsToday = new Set();
          (this.orders || []).forEach((order) => {
            if (order.date && new Date(order.date).toDateString() === today) {
              (order.technicians || []).forEach((tech) => tech && crewsToday.add(tech));
            }
          });
          const ranked = technicians
            .map((member) => ({ ...member, hours: this.calculateStaffHours(member) }))
            .sort((a, b) => b.hours - a.hours)
            .slice(0, 5);
          return {
            cards: [
              { label: this.localize('Técnicos activos', 'Active technicians'), value: activeTechs.length, hint: `${technicians.length} ${this.localize('totales', 'total')}` },
              { label: this.localize('Horas promedio (semana)', 'Avg weekly hours'), value: `${avgHours} h`, hint: this.localize('Basado en timesheets', 'Based on time sheets') },
              { label: this.localize('Cuadrillas hoy', 'Crews today'), value: crewsToday.size, hint: this.localize('Asignadas en la agenda', 'Scheduled today') },
            ],
            bars: buildDistribution(technicians, (member) => this.formatLabel(member.status || 'active')),
            table: {
              title: this.localize('Top técnicos por horas', 'Top technicians by hours'),
              headers: [this.localize('Técnico', 'Technician'), this.localize('Horas', 'Hours'), this.t('colStatus'), this.localize('Próximo turno', 'Next shift')],
              rows: ranked.map((member) => [member.name, `${member.hours} h`, this.formatLabel(member.status), member.nextShift || '—']),
            },
          };
        }

        if (category === 'inventory') {
          const metrics = this.calculateInventoryMetrics();
          const lowItems = metrics.lowItems.slice(0, 5);
          const categoryValue = {};
          inventory.forEach((item) => {
            const key = this.getInventoryCategoryLabel(item.category || '');
            const value = (Number(item.qty) || 0) * (Number(item.cost) || 0);
            categoryValue[key] = (categoryValue[key] || 0) + value;
          });
          const bars = Object.entries(categoryValue)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([label, value]) => ({ label, value, valueLabel: this.formatCurrency(value) }));
          return {
            cards: [
              { label: this.t('inventoryKpiSkus'), value: metrics.totalSkus, hint: this.t('inventoryKpiSkusHint') },
              { label: this.t('inventoryReportLow'), value: metrics.lowCount, hint: this.localize('Requieren reorden', 'Need reorder') },
              { label: this.t('inventoryKpiValue'), value: this.formatCurrency(metrics.totalValue), hint: this.t('inventoryKpiValueHint') },
            ],
            bars,
            table: {
              title: this.localize('Materiales críticos', 'Low stock items'),
              headers: ['SKU', this.localize('Qty/Reorden', 'Qty/Reorder'), this.t('inventoryVendor'), this.t('colStatus')],
              rows: lowItems.map((item) => [
                item.sku || item.id,
                `${item.qty ?? 0}/${item.reorderPoint ?? 0}`,
                item.vendor || '—',
                this.getInventoryStatusMeta(item).label,
              ]),
            },
          };
        }

        // Overview fallback
        const topOrders = [...orders].sort((a, b) => (b.total || 0) - (a.total || 0)).slice(0, 5);
        return {
          cards: [
            { label: this.t('reportsKpiRevenue'), value: this.formatCurrency(summary.revenue || 0), hint: this.localize('Periodo actual', 'Current period') },
            { label: this.t('reportsKpiBacklog'), value: summary.backlog || 0, hint: this.localize('Órdenes activas', 'Active jobs') },
            { label: this.t('inventoryKpiValue'), value: this.formatCurrency(summary.inventoryValue || 0), hint: this.localize('Inventario disponible', 'Inventory on hand') },
          ],
          bars: buildDistribution(orders, (order) => this.formatStatus(order.status)),
          table: {
            title: this.localize('Órdenes destacadas', 'Top orders'),
            headers: [this.localize('Orden', 'Order'), this.t('labelCustomer'), this.localize('Importe', 'Amount'), this.t('colStatus')],
            rows: topOrders.map((order) => [order.id, order.customer, this.formatCurrency(order.total), this.formatStatus(order.status)]),
          },
        };
      },

      renderReportSchedules() {
        const list = document.getElementById('reports-schedule-list');
        if (!list) return;
        const schedules = this.reportSchedules || [];
        if (!schedules.length) {
          list.innerHTML = `<p class="inventory-empty">${this.t('reportsScheduleEmpty')}</p>`;
          return;
        }
        list.innerHTML = schedules
          .map(
            (schedule) => `
          <div class="report-queue-item ${schedule.paused ? 'report-queue-item-paused' : ''}">
            <div>
              <div class="report-schedule-heading">
                <strong>${schedule.templateName || schedule.templateId}</strong>
                ${schedule.paused ? `<span class="schedule-paused-badge">${this.t('reportsSchedulePaused')}</span>` : ''}
              </div>
              <small>${this.t('reportsScheduleCadence')}: ${this.formatCadence(schedule.cadence)} · ${this.t('reportsScheduleNextRun')}: ${this.formatDateTime(schedule.nextRun)}</small>
              <small>${this.t('reportsScheduleRecipients')}: ${(schedule.recipients || []).join(', ') || '—'}</small>
            </div>
            <div class="report-actions">
              <button class="btn btn-secondary btn-small" data-action="schedule-send" data-id="${schedule.id}">${this.t('reportsScheduleRunNow')}</button>
              <button class="btn btn-secondary btn-small" data-action="schedule-toggle" data-id="${schedule.id}">${
                schedule.paused ? this.t('reportsScheduleResume') : this.t('reportsSchedulePause')
              }</button>
              <button class="btn btn-secondary btn-small" data-action="schedule-edit" data-id="${schedule.id}">✎</button>
              <button class="btn btn-secondary btn-small" data-action="schedule-delete" data-id="${schedule.id}">${this.t('reportsScheduleDelete')}</button>
            </div>
          </div>`
          )
          .join('');
        list.querySelectorAll('[data-action="schedule-send"]').forEach((btn) => {
          btn.addEventListener('click', () => this.runReportSchedule(btn.dataset.id));
        });
        list.querySelectorAll('[data-action="schedule-toggle"]').forEach((btn) => {
          btn.addEventListener('click', () => this.toggleReportSchedule(btn.dataset.id));
        });
        list.querySelectorAll('[data-action="schedule-edit"]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const schedule = (this.reportSchedules || []).find((item) => item.id === btn.dataset.id);
            const message = schedule
              ? this.localize(
                  `¿Editar el envío automático "${schedule.templateName}"?`,
                  `Edit schedule "${schedule.templateName}"?`
                )
              : this.localize('¿Editar este envío automático?', 'Edit this schedule?');
            this.openConfirmModal({
              title: this.t('reportsSchedule'),
              message,
              confirmLabel: this.localize('Editar', 'Edit'),
              cancelLabel: this.localize('Cancelar', 'Cancel'),
              onConfirm: () => this.openReportScheduleModal(btn.dataset.id),
            });
          });
        });
        list.querySelectorAll('[data-action="schedule-delete"]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const schedule = (this.reportSchedules || []).find((item) => item.id === btn.dataset.id);
            const message = schedule
              ? this.localize(
                  `¿Eliminar el envío programado "${schedule.templateName}"? Esta acción no se puede deshacer.`,
                  `Delete schedule "${schedule.templateName}"? This cannot be undone.`
                )
              : this.localize('¿Eliminar este envío automático?', 'Delete this schedule?');
            this.openConfirmModal({
              title: this.t('reportsScheduleDelete'),
              message,
              confirmLabel: this.localize('Eliminar', 'Delete'),
              cancelLabel: this.localize('Cancelar', 'Cancel'),
              onConfirm: () => this.deleteReportSchedule(btn.dataset.id),
            });
          });
        });
      },

      exportReportHistory() {
        if (!this.requireCapability('reports.download')) return;
        if (!this.reportHistory || !this.reportHistory.length) {
          alert(this.t('reportsHistoryEmpty') || 'Sin registros');
          return;
        }
        const headers = ['ID', 'Name', 'Scope', 'Format', 'RunAt'];
        const rows = this.reportHistory.map((entry) => [entry.id, entry.name, entry.scope, entry.format, entry.ranAt]);
        const csv = [headers, ...rows]
          .map((row) => row.map((value) => this.csvEscape(value)).join(','))
          .join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `reports-history-${Date.now()}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      },

      formatCadence(value) {
        const map = {
          daily: this.currentLanguage === 'es' ? 'Diario' : 'Daily',
          weekly: this.currentLanguage === 'es' ? 'Semanal' : 'Weekly',
          monthly: this.currentLanguage === 'es' ? 'Mensual' : 'Monthly',
          quarterly: this.currentLanguage === 'es' ? 'Trimestral' : 'Quarterly',
        };
        return map[value] || value;
      },

      getReportScopeLabel(range = this.reportsRange) {
        const map = {
          week: this.currentLanguage === 'es' ? 'Semana en curso' : 'Current week',
          month: this.currentLanguage === 'es' ? 'Mes en curso' : 'Current month',
          quarter: this.currentLanguage === 'es' ? 'Último trimestre' : 'Last quarter',
        };
        return map[range] || range;
      },

      getReportTemplateById(id) {
        return (this.reportTemplates || []).find((template) => template.id === id);
      },

      runReportTemplate(templateId) {
        const template = this.getReportTemplateById(templateId);
        if (!template) return;
        const snapshot = this.buildReportSnapshot(template);
        const entry = {
          id: `HIST-${Date.now().toString().slice(-6)}`,
          templateId: template.id,
          name: template.name,
          scope: `${this.getReportScopeLabel()} (${template.scope || ''})`,
          dataset: template.dataset || 'orders',
          columns: template.columns || [],
          groupBy: template.groupBy || '',
          format: template.format || 'PDF',
          ranAt: new Date().toISOString(),
          snapshot,
        };
        this.reportHistory.unshift(entry);
        this.persist('reportHistory');
        this.renderReportsPage();
        alert(`${template.name} listo para descargar.`);
      },

      runReportSchedule(scheduleId) {
        const schedule = (this.reportSchedules || []).find((item) => item.id === scheduleId);
        if (!schedule) return;
        if (schedule.paused) {
          alert('Schedule paused.');
          return;
        }
        this.runReportTemplate(schedule.templateId);
        const next = new Date(schedule.nextRun || Date.now());
        const increment = {
          daily: 1,
          weekly: 7,
          monthly: 30,
          quarterly: 90,
        }[schedule.cadence] || 7;
        next.setDate(next.getDate() + increment);
        schedule.nextRun = next.toISOString();
        this.persist('reportSchedules');
        this.renderReportSchedules();
      },

      deleteReportSchedule(scheduleId) {
        if (!scheduleId) return;
        this.reportSchedules = (this.reportSchedules || []).filter((schedule) => schedule.id !== scheduleId);
        this.persist('reportSchedules');
        this.renderReportSchedules();
      },

      toggleReportSchedule(scheduleId) {
        const schedule = (this.reportSchedules || []).find((item) => item.id === scheduleId);
        if (!schedule) return;
        schedule.paused = !schedule.paused;
        this.persist('reportSchedules');
        this.renderReportSchedules();
      },

      openReportPreview(templateId) {
        const template = this.getReportTemplateById(templateId);
        if (!template) return;
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        modal.classList.add('active');
        title.textContent = template.name;
        const preview = this.renderDatasetPreview(template.dataset, template.columns || [], template.groupBy);
        body.innerHTML = `
          <div class="modal-step" style="gap:16px;">
            <p>${template.scope || ''}</p>
            <div>${preview}</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <select id="preview-format">
                <option value="PDF">PDF</option>
                <option value="CSV">CSV</option>
                <option value="XLSX">XLSX</option>
              </select>
              <input type="text" id="preview-comment" placeholder="Comentario..." style="flex:1;" />
            </div>
            <button class="btn btn-primary" id="preview-run">${this.t('reportsTemplateSend')}</button>
          </div>`;
        document.getElementById('preview-run').addEventListener('click', () => {
          template.format = document.getElementById('preview-format').value;
          this.runReportTemplate(template.id);
          this.closeModal();
        });
      },

      openReportBuilder() {
        if (!this.requireCapability('reports.build')) return;
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        modal.classList.add('active');
        title.textContent = this.t('reportsBuilder');
        const categories = [
          { value: 'financial', label: this.t('reportType') },
          { value: 'operations', label: this.t('reportsFilterOps') },
          { value: 'technicians', label: this.t('reportsFilterTechs') },
          { value: 'inventory', label: this.t('reportTypeInventory') },
        ];
        const formats = ['PDF', 'XLSX', 'CSV', 'Dashboard'];
        const cadences = [
          { value: 'daily', label: this.formatCadence('daily') },
          { value: 'weekly', label: this.formatCadence('weekly') },
          { value: 'monthly', label: this.formatCadence('monthly') },
        ];
        const datasetOptions = (this.REPORT_DATASETS || [])
          .map((dataset) => `<option value="${dataset.id}">${this.t(dataset.labelKey) || dataset.labelKey}</option>`)
          .join('');
        body.innerHTML = `
          <form id="report-builder-form" class="modal-step">
            <div class="form-grid">
              <div class="form-group">
                <label>${this.t('reportsBuilderName')}</label>
                <input type="text" name="name" required />
              </div>
              <div class="form-group">
                <label>${this.t('reportsBuilderCategory')}</label>
                <select name="category">
                  ${categories.map((cat) => `<option value="${cat.value}">${cat.label}</option>`).join('')}
                </select>
              </div>
              <div class="form-group">
                <label>${this.t('reportsBuilderFormat')}</label>
                <select name="format">
                  ${formats.map((fmt) => `<option value="${fmt}">${fmt}</option>`).join('')}
                </select>
              </div>
              <div class="form-group">
                <label>${this.t('reportsBuilderScope')}</label>
                <input type="text" name="scope" placeholder="Ej. Clientes VIP - Mes actual" />
              </div>
              <div class="form-group">
                <label>${this.t('reportsBuilderCadence')}</label>
                <select name="cadence">
                  ${cadences.map((cad) => `<option value="${cad.value}">${cad.label}</option>`).join('')}
                </select>
              </div>
              <div class="form-group">
                <label>${this.t('reportsBuilderDataset')}</label>
                <select name="dataset" id="builder-dataset">
                  ${datasetOptions}
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>${this.t('reportsBuilderColumns')}</label>
              <div id="builder-columns" class="inventory-report-list"></div>
            </div>
            <div class="form-group">
              <label>${this.t('reportsBuilderGroup')}</label>
              <select name="groupBy" id="builder-group"></select>
            </div>
            <div class="form-group">
              <label>${this.t('reportsBuilderPreview')}</label>
              <div id="builder-preview" style="max-height:320px; overflow:auto; border:1px solid var(--border-color); border-radius:12px; padding:12px;">
                ${this.t('reportsPreviewEmpty')}
              </div>
              <button type="button" class="btn btn-secondary btn-small" id="builder-refresh" style="margin-top:8px;">${this.t(
                'reportsBuilderPreview'
              )}</button>
            </div>
            <div class="modal-step-actions" style="justify-content:flex-end;">
              <button class="btn btn-primary" type="submit">${this.t('reportsBuilderSave')}</button>
            </div>
          </form>`;
        const datasetSelect = document.getElementById('builder-dataset');
        const columnsContainer = document.getElementById('builder-columns');
        const groupSelect = document.getElementById('builder-group');
        const previewContainer = document.getElementById('builder-preview');
        const selectedColumns = new Set();
        const presetColumnsForDataset = (datasetId) => {
          selectedColumns.clear();
          const saved = (this.reportDatasetDefaults?.[datasetId] || []).filter(Boolean);
          const defaults = saved.length ? saved : this.getDefaultDatasetColumns(datasetId);
          defaults.forEach((col) => selectedColumns.add(col));
        };
        const renderColumns = () => {
          const dataset = this.getReportDatasetMeta(datasetSelect.value) || this.getReportDatasetMeta('orders');
          if (!dataset) {
            columnsContainer.innerHTML = `<p>${this.t('reportsPreviewEmpty')}</p>`;
            return;
          }
          columnsContainer.innerHTML = dataset.columns
            .map(
              (column) => `
            <label style="display:flex; align-items:center; gap:8px; font-size:13px;">
              <input type="checkbox" value="${column.id}" ${selectedColumns.has(column.id) ? 'checked' : ''}/>
              <span>${column.label}</span>
            </label>`
            )
            .join('');
          groupSelect.innerHTML = `<option value="">—</option>${(dataset.groupOptions || [])
            .map((group) => `<option value="${group.id}">${group.label}</option>`)
            .join('')}`;
          columnsContainer.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
            checkbox.addEventListener('change', () => {
              if (checkbox.checked) {
                selectedColumns.add(checkbox.value);
              } else {
                selectedColumns.delete(checkbox.value);
              }
            });
          });
        };
        presetColumnsForDataset(datasetSelect.value || 'orders');
        renderColumns();
        datasetSelect.addEventListener('change', () => {
          presetColumnsForDataset(datasetSelect.value || 'orders');
          renderColumns();
          previewContainer.innerHTML = this.t('reportsPreviewEmpty');
        });
        document.getElementById('builder-refresh').addEventListener('click', () => {
          const dataset = datasetSelect.value || 'orders';
          const columns = selectedColumns.size ? Array.from(selectedColumns) : null;
          previewContainer.innerHTML = this.renderDatasetPreview(dataset, columns, groupSelect.value);
        });
        const form = document.getElementById('report-builder-form');
        if (form) {
          form.addEventListener('submit', (event) => {
            event.preventDefault();
            const data = new FormData(form);
            const payload = {
              id: `REP-${Date.now().toString().slice(-4)}`,
              name: (data.get('name') || '').trim(),
              category: data.get('category') || 'financial',
              format: data.get('format') || 'PDF',
              scope: data.get('scope') || this.getReportScopeLabel(),
              cadence: data.get('cadence') || 'weekly',
              dataset: data.get('dataset') || 'orders',
              columns: selectedColumns.size ? Array.from(selectedColumns) : [],
              groupBy: data.get('groupBy') || '',
            };
            this.reportTemplates.unshift(payload);
            this.persist('reportTemplates');
            this.saveReportDatasetDefaults(payload.dataset, payload.columns);
            this.renderReportsPage();
            this.closeModal();
          });
        }
      },

      openReportScheduleModal(scheduleId = null) {
        if (!this.requireCapability('reports.schedule')) return;
        if (!this.reportTemplates || !this.reportTemplates.length) {
          alert('Necesitas al menos una plantilla para programar envíos.');
          return;
        }
        const schedule = scheduleId ? (this.reportSchedules || []).find((item) => item.id === scheduleId) : null;
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        modal.classList.add('active');
        title.textContent = this.t('reportsSchedule');
        const templateOptions = (this.reportTemplates || [])
          .map(
            (template) => `
              <option value="${template.id}" ${template.id === (schedule?.templateId || '') ? 'selected' : ''}>${template.name}</option>`
          )
          .join('');
        body.innerHTML = `
          <form id="report-schedule-form" class="modal-step">
            <input type="hidden" name="id" value="${schedule?.id || ''}" />
            <div class="form-grid">
              <div class="form-group">
                <label>${this.t('reportsBuilderName')}</label>
                <select name="templateId" required>
                  ${templateOptions}
                </select>
              </div>
              <div class="form-group">
                <label>${this.t('reportsScheduleCadence')}</label>
                <select name="cadence">
                  <option value="daily" ${schedule?.cadence === 'daily' ? 'selected' : ''}>${this.formatCadence('daily')}</option>
                  <option value="weekly" ${schedule?.cadence === 'weekly' ? 'selected' : ''}>${this.formatCadence('weekly')}</option>
                  <option value="monthly" ${schedule?.cadence === 'monthly' ? 'selected' : ''}>${this.formatCadence('monthly')}</option>
                </select>
              </div>
              <div class="form-group">
                <label>${this.t('reportsScheduleRecipients')}</label>
                <input type="text" name="recipients" value="${(schedule?.recipients || []).join(', ')}" placeholder="ops@opsis.com, finance@opsis.com" />
              </div>
              <div class="form-group">
                <label>${this.t('reportsScheduleNextRun')}</label>
                <input type="datetime-local" name="nextRun" value="${schedule?.nextRun ? this.toInputDate(schedule.nextRun, true) : ''}" required />
              </div>
            </div>
            <div class="modal-step-actions" style="justify-content:flex-end;">
              <button class="btn btn-primary" type="submit">${this.t('reportsBuilderSave')}</button>
            </div>
          </form>`;
        const form = document.getElementById('report-schedule-form');
        if (form) {
          form.addEventListener('submit', (event) => {
            event.preventDefault();
            const data = new FormData(form);
            const templateId = data.get('templateId');
            const template = this.getReportTemplateById(templateId);
            if (!template) return;
            const payload = {
              id: data.get('id') || `SCH-${Date.now().toString().slice(-4)}`,
              templateId,
              templateName: template.name,
              cadence: data.get('cadence') || 'weekly',
              recipients: (data.get('recipients') || '')
                .split(',')
                .map((item) => item.trim())
                .filter(Boolean),
              nextRun: data.get('nextRun') ? new Date(data.get('nextRun')).toISOString() : new Date().toISOString(),
            };
            const existing = (this.reportSchedules || []).find((item) => item.id === payload.id);
            if (existing) {
              Object.assign(existing, payload);
            } else {
              this.reportSchedules.unshift(payload);
            }
            this.persist('reportSchedules');
            this.renderReportSchedules();
            this.closeModal();
          });
        }
      },

      renderManagement() {
        const searchInput = document.getElementById('management-search');
        if (searchInput) {
          searchInput.placeholder = this.t('managementSearchPlaceholder');
        }
        this.renderManagementKpis();
        this.renderManagementTable();
        this.renderManagementDetail();
        this.renderManagementInvites();
        this.renderAdminActivity();
        this.renderPortalInvites();
      },

      renderManagementKpis() {
        const admins = (this.users || []).filter((user) => ['owner', 'admin'].includes(user.role));
        const invitesPending = (this.adminInvites || []).filter((invite) => invite.status === 'pending');
        const lastAccess = admins
          .map((user) => user.lastActive)
          .filter(Boolean)
          .sort((a, b) => new Date(b) - new Date(a))[0];
        const adminsNode = document.getElementById('management-kpi-admins');
        if (adminsNode) adminsNode.textContent = admins.length;
        const adminsHint = document.getElementById('management-kpi-admins-hint');
        if (adminsHint) adminsHint.textContent = this.localize('Con roles críticos', 'Critical roles');
        const inviteNode = document.getElementById('management-kpi-invites');
        if (inviteNode) inviteNode.textContent = invitesPending.length;
        const inviteHint = document.getElementById('management-kpi-invites-hint');
        if (inviteHint) inviteHint.textContent = invitesPending.length ? `${invitesPending.length} ${this.t('managementInvitesSubtitle')}` : '—';
        const lastNode = document.getElementById('management-kpi-lastaccess');
        if (lastNode) lastNode.textContent = lastAccess ? this.formatDateTime(lastAccess) : '—';
        const lastHint = document.getElementById('management-kpi-lastaccess-hint');
        if (lastHint) lastHint.textContent = this.localize('Última auditoría', 'Last audit');
      },

      renderManagementTable() {
        const body = document.getElementById('management-tbody');
        if (!body) return;
        const search = (this.managementSearch || '').toLowerCase();
        const roleFilter = this.managementRoleFilter || 'all';
        const rows = (this.users || [])
          .filter((user) => {
            const matchesSearch =
              !search ||
              user.name.toLowerCase().includes(search) ||
              (user.email || '').toLowerCase().includes(search) ||
              (user.department || '').toLowerCase().includes(search);
            const matchesRole = roleFilter === 'all' || user.role === roleFilter;
            return matchesSearch && matchesRole;
          })
          .sort((a, b) => new Date(b.lastActive || 0) - new Date(a.lastActive || 0));
        if (!rows.length) {
          body.innerHTML = `<tr><td colspan="6" class="management-empty">${this.t('managementEmpty')}</td></tr>`;
          this.selectedManagerId = null;
          this.renderManagementDetail();
          return;
        }
        if (!this.selectedManagerId || !rows.find((user) => user.id === this.selectedManagerId)) {
          this.selectedManagerId = rows[0].id;
        }
        body.innerHTML = rows
          .map((user) => {
            const status = this.getManagerStatusMeta(user.status);
            const mfaLabel = user.mfa ? '✓' : '—';
            const lastAccess = user.lastActive ? this.formatDateTime(user.lastActive) : '—';
            return `
          <tr data-manager="${user.id}" class="${user.id === this.selectedManagerId ? 'active' : ''}">
            <td>${this.escapeHtml(user.name)}</td>
            <td>${user.email}</td>
            <td>${user.role}</td>
            <td><span class="management-badge ${status.className}">${status.label}</span></td>
            <td>${lastAccess}</td>
            <td>${mfaLabel}</td>
          </tr>`;
          })
          .join('');
        body.querySelectorAll('tr[data-manager]').forEach((row) => {
          row.addEventListener('click', () => {
            this.selectedManagerId = row.dataset.manager;
            this.renderManagementTable();
            this.renderManagementDetail();
          });
        });
      },

      renderManagementDetail() {
        const panel = document.getElementById('management-detail');
        if (!panel) return;
        const user = (this.users || []).find((manager) => manager.id === this.selectedManagerId);
        if (!user) {
          panel.innerHTML = `<div class="management-detail-placeholder">${this.t('managementDetailPlaceholder')}</div>`;
          return;
        }
        const status = this.getManagerStatusMeta(user.status);
        const avatar = this.getInitials(user.name);
        const roleOptions = (this.rolesMatrix || [])
          .map((role) => `<option value="${role.role}" ${role.role === user.role ? 'selected' : ''}>${this.formatLabel(role.role)}</option>`)
          .join('');
        const statusOptions = [
          { value: 'active', label: this.t('managementStatusActive') },
          { value: 'away', label: this.t('managementStatusAway') },
          { value: 'disabled', label: this.t('managementStatusDisabled') },
        ]
          .map((option) => `<option value="${option.value}" ${option.value === (user.status || 'active') ? 'selected' : ''}>${option.label}</option>`)
          .join('');
        panel.innerHTML = `
          <div class="management-detail-header">
            <div class="management-avatar">${avatar}</div>
            <div>
              <h3>${this.escapeHtml(user.name)}</h3>
              <small>${user.email}</small>
            </div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px;">
            <span class="management-badge ${status.className}">${status.label}</span>
            <span class="management-badge ${user.mfa ? 'active' : 'disabled'}">${user.mfa ? this.t('managementMfaEnabled') : this.t('managementMfaDisabled')}</span>
          </div>
          <div class="management-detail-grid">
            <div>
              <span>${this.t('managementDetailRole')}</span>
              <strong>${user.role}</strong>
            </div>
            <div>
              <span>${this.t('managementDetailDepartment')}</span>
              <strong>${user.department || '—'}</strong>
            </div>
            <div>
              <span>${this.t('managementDetailPhone')}</span>
              <strong>${user.phone || '—'}</strong>
            </div>
            <div>
              <span>${this.t('managementDetailLastAccess')}</span>
              <strong>${user.lastActive ? this.formatDateTime(user.lastActive) : '—'}</strong>
            </div>
          </div>
          <div class="settings-divider"></div>
          <div class="form-group">
            <label>${this.t('managementModalRole')}</label>
            <select id="management-detail-role-select">
              ${roleOptions}
            </select>
          </div>
          <div class="form-group">
            <label>${this.t('managementModalStatus')}</label>
            <select id="management-detail-status-select">
              ${statusOptions}
            </select>
          </div>
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="management-detail-mfa" ${user.mfa ? 'checked' : ''} />
            ${this.t('managementModalMfa')}
          </label>
          <div class="management-detail-actions">
            <button class="btn btn-secondary" id="management-detail-save">${this.t('managementDetailSave')}</button>
            <button class="btn btn-danger" id="management-detail-remove">${this.t('managementDetailRemove')}</button>
          </div>`;
        const saveBtn = panel.querySelector('#management-detail-save');
        if (saveBtn) {
          saveBtn.addEventListener('click', () => this.saveSelectedManager());
        }
        const removeBtn = panel.querySelector('#management-detail-remove');
        if (removeBtn) {
          removeBtn.addEventListener('click', () => this.removeSelectedManager());
        }
      },

      renderManagementInvites() {
        const container = document.getElementById('management-invites-list');
        if (!container) return;
        const invites = this.adminInvites || [];
        if (!invites.length) {
          container.innerHTML = `<div class="management-empty">${this.t('managementInvitesEmpty')}</div>`;
          return;
        }
        container.innerHTML = invites
          .map((invite) => {
            const expires = invite.expiresAt ? this.formatDateTime(invite.expiresAt) : '—';
            const password = invite.tempPassword || '••••••';
            return `
          <div class="management-invite-item" data-invite="${invite.id}">
            <div>
              <strong>${invite.name} · ${invite.role}</strong>
              <small>${invite.email}</small>
              <small>${this.t('managementInviteExpires')}: ${expires}</small>
              <small>${this.localize('Contraseña temporal', 'Temporary password')}: <strong>${password}</strong></small>
            </div>
            <div class="report-actions">
              <button class="btn btn-secondary btn-small" data-action="invite-copy">${this.localize('Copiar', 'Copy')}</button>
              <button class="btn btn-secondary btn-small" data-action="invite-reset">${this.localize('Nueva clave', 'New key')}</button>
              <button class="btn btn-secondary btn-small" data-action="invite-resend">${this.t('managementInviteResend')}</button>
              <button class="btn btn-secondary btn-small" data-action="invite-cancel">${this.t('managementInviteCancel')}</button>
            </div>
          </div>`;
          })
          .join('');
        container.querySelectorAll('[data-action="invite-copy"]').forEach((btn) => {
          btn.addEventListener('click', () => this.copyAdminInvitePassword(btn.closest('.management-invite-item').dataset.invite));
        });
        container.querySelectorAll('[data-action="invite-reset"]').forEach((btn) => {
          btn.addEventListener('click', () => this.regenerateAdminInvitePassword(btn.closest('.management-invite-item').dataset.invite));
        });
        container.querySelectorAll('[data-action="invite-resend"]').forEach((btn) => {
          btn.addEventListener('click', () => this.resendAdminInvite(btn.closest('.management-invite-item').dataset.invite));
        });
        container.querySelectorAll('[data-action="invite-cancel"]').forEach((btn) => {
          btn.addEventListener('click', () => this.cancelAdminInvite(btn.closest('.management-invite-item').dataset.invite));
        });
      },

      renderPortalInvites() {
        const list = document.getElementById('portal-invite-list');
        if (!list) return;
        const invites = this.portalInvites || [];
        if (!invites.length) {
          list.innerHTML = `<div class="management-empty">${this.localize('Sin invitaciones aún', 'No invites yet')}</div>`;
          return;
        }
        list.innerHTML = invites
          .map((invite) => {
            const badgeClass =
              invite.status === 'active' ? 'active' : invite.status === 'revoked' ? 'disabled' : 'pending';
            const expires = invite.expiresAt ? this.formatDateTime(invite.expiresAt) : this.localize('Manual', 'Manual');
            return `
          <div class="management-invite-item" data-portal-invite="${invite.id}">
            <div>
              <strong>${invite.name} · ${this.formatLabel(invite.role)}</strong>
              <small>${invite.email}</small>
              <small>${this.localize('Código', 'Code')}: <span style="font-weight:600;">${invite.code}</span></small>
              <small>${this.localize('Expira', 'Expires')}: ${expires}</small>
            </div>
            <div class="report-actions">
              <button class="btn btn-secondary btn-small" data-action="portal-copy">${this.localize('Copiar código', 'Copy code')}</button>
              ${
                invite.status !== 'revoked'
                  ? `<button class="btn btn-secondary btn-small" data-action="portal-revoke">${this.localize('Revocar', 'Revoke')}</button>`
                  : `<button class="btn btn-secondary btn-small" data-action="portal-restore">${this.localize('Activar', 'Activate')}</button>`
              }
              <button class="btn btn-danger btn-small" data-action="portal-delete">${this.localize('Eliminar', 'Delete')}</button>
            </div>
          </div>`;
          })
          .join('');
        list.querySelectorAll('[data-action="portal-copy"]').forEach((btn) => {
          btn.addEventListener('click', () => this.copyPortalInvite(btn.closest('[data-portal-invite]').dataset.portalInvite));
        });
        list.querySelectorAll('[data-action="portal-revoke"]').forEach((btn) => {
          btn.addEventListener('click', () => this.updatePortalInviteStatus(btn.closest('[data-portal-invite]').dataset.portalInvite, 'revoked'));
        });
        list.querySelectorAll('[data-action="portal-restore"]').forEach((btn) => {
          btn.addEventListener('click', () => this.updatePortalInviteStatus(btn.closest('[data-portal-invite]').dataset.portalInvite, 'pending'));
        });
        list.querySelectorAll('[data-action="portal-delete"]').forEach((btn) => {
          btn.addEventListener('click', () => this.deletePortalInvite(btn.closest('[data-portal-invite]').dataset.portalInvite));
        });
      },

      copyPortalInvite(inviteId) {
        const invite = (this.portalInvites || []).find((item) => item.id === inviteId);
        if (!invite) return;
        if (navigator.clipboard?.writeText) {
          navigator.clipboard.writeText(invite.code).then(() => {
            this.showNotification(this.localize('Código copiado al portapapeles', 'Code copied to clipboard'), 'success');
          });
        }
      },

      createPortalInvite() {
        if (!this.requireCapability('portal.invite')) return;
        const name = document.getElementById('portal-invite-name').value.trim();
        const email = document.getElementById('portal-invite-email').value.trim();
        const role = document.getElementById('portal-invite-role').value;
        const company = document.getElementById('portal-invite-company').value.trim() || this.settings.companyName || 'Opsis Client';
        if (!name || !email) {
          this.showNotification(this.localize('Completa nombre y correo', 'Name and email required'), 'error');
          return;
        }
        const code = this.generatePortalCode();
        const invite = {
          id: `PORT-${Date.now().toString(36).toUpperCase()}`,
          name,
          email,
          company,
          role,
          code,
          status: 'pending',
          createdAt: new Date().toISOString(),
          expiresAt: new Date(Date.now() + 1000 * 60 * 60 * 24 * 30).toISOString(),
        };
        this.portalInvites = [invite, ...(this.portalInvites || [])];
        this.persist('portalInvites');
        this.renderPortalInvites();
        document.getElementById('portal-invite-form').reset();
        this.showNotification(this.localize('Invitación creada. Código copiado.', 'Invite generated and code copied'), 'success');
        if (navigator.clipboard?.writeText) {
          navigator.clipboard.writeText(code);
        }
      },

      updatePortalInviteStatus(inviteId, status) {
        const invite = (this.portalInvites || []).find((item) => item.id === inviteId);
        if (!invite) return;
        invite.status = status;
        invite.updatedAt = new Date().toISOString();
        this.persist('portalInvites');
        this.renderPortalInvites();
        this.showNotification(
          status === 'revoked' ? this.localize('Invitación revocada', 'Invite revoked') : this.localize('Invitación activa', 'Invite active'),
          'success'
        );
      },

      deletePortalInvite(inviteId) {
        this.portalInvites = (this.portalInvites || []).filter((invite) => invite.id !== inviteId);
        this.persist('portalInvites');
        this.renderPortalInvites();
        this.showNotification(this.localize('Invitación eliminada', 'Invite deleted'), 'success');
      },

      generatePortalCode() {
        return Math.floor(100000 + Math.random() * 900000).toString();
      },

      renderAdminActivity() {
        const container = document.getElementById('management-activity-list');
        if (!container) return;
        const entries = (this.adminActivity || []).slice().sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        if (!entries.length) {
          container.innerHTML = `<div class="management-empty">${this.t('managementActivityEmpty')}</div>`;
          return;
        }
        container.innerHTML = entries
          .map(
            (entry) => `
          <div class="management-activity-item">
            <div>
              <strong>${this.t(entry.action)}</strong>
              <small>${entry.actor} · ${entry.target}</small>
            </div>
            <div style="text-align:right;">
              <span>${this.formatDateTime(entry.timestamp)}</span>
              <small>${entry.detail || ''}</small>
            </div>
          </div>`
          )
          .join('');
      },

      openAdminModal(mode = 'add', userId = null, presetRole = null) {
        const isEdit = mode === 'edit';
        const user = isEdit ? (this.users || []).find((item) => item.id === (userId || this.selectedManagerId)) : null;
        if (isEdit && !user) {
          alert(this.t('managementSelectFirst') || 'Selecciona un administrador primero.');
          return;
        }
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        const roles = this.rolesMatrix || [];
        if (!roles.length) {
          alert(this.t('rolesEmpty'));
          return;
        }
        modal.classList.add('active');
        title.textContent = this.t(isEdit ? 'managementModalTitleEdit' : 'managementModalTitleNew');
        const selectedRole = presetRole || user?.role || roles[0].role;
        const roleOptions = roles
          .map((role) => `<option value="${role.role}" ${role.role === selectedRole ? 'selected' : ''}>${this.formatLabel(role.role)}</option>`)
          .join('');
        const statusOptions = [
          { value: 'active', label: this.t('managementStatusActive') },
          { value: 'away', label: this.t('managementStatusAway') },
          { value: 'disabled', label: this.t('managementStatusDisabled') },
        ]
          .map((option) => `<option value="${option.value}" ${option.value === (user?.status || 'active') ? 'selected' : ''}>${option.label}</option>`)
          .join('');
        body.innerHTML = `
          <form id="admin-form" class="modal-step" style="gap:16px;">
            <div class="form-group">
              <label>${this.t('managementModalName')}</label>
              <input type="text" id="admin-modal-name" value="${user?.name || ''}" required />
            </div>
            <div class="form-group">
              <label>${this.t('managementModalEmail')}</label>
              <input type="email" id="admin-modal-email" value="${user?.email || ''}" required />
            </div>
            <div class="form-group">
              <label>${this.t('managementModalPhone')}</label>
              <input type="tel" id="admin-modal-phone" value="${user?.phone || ''}" />
            </div>
            <div class="form-group">
              <label>${this.t('managementModalRole')}</label>
              <select id="admin-modal-role">${roleOptions}</select>
            </div>
            <div class="form-group">
              <label>${this.t('managementModalStatus')}</label>
              <select id="admin-modal-status">${statusOptions}</select>
            </div>
            <label style="display:flex; gap:8px; align-items:center;">
              <input type="checkbox" id="admin-modal-mfa" ${user?.mfa ? 'checked' : ''} />
              ${this.t('managementModalMfa')}
            </label>
            <div class="modal-step-actions" style="justify-content:flex-end;">
              <button class="btn btn-primary" type="submit">${this.t('managementModalSave')}</button>
            </div>
          </form>`;
        const form = document.getElementById('admin-form');
        form.addEventListener('submit', (event) => {
          event.preventDefault();
          const name = document.getElementById('admin-modal-name').value.trim();
          const email = document.getElementById('admin-modal-email').value.trim();
          if (!name || !email) {
            alert(this.t('managementModalRequired'));
            return;
          }
          const emailPattern = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;
          if (!emailPattern.test(email)) {
            alert(this.t('managementModalInvalidEmail'));
            return;
          }
          const phone = document.getElementById('admin-modal-phone').value.trim();
          const roleValue = document.getElementById('admin-modal-role').value;
          const statusValue = document.getElementById('admin-modal-status').value || 'active';
          const mfaEnabled = document.getElementById('admin-modal-mfa').checked;
          if (isEdit && user) {
            Object.assign(user, {
              name,
              email,
              phone,
              role: roleValue,
              status: statusValue,
              mfa: mfaEnabled,
            });
          } else {
            const newUser = {
              id: this.generateUserId(),
              name,
              email,
              phone,
              role: roleValue,
              status: statusValue,
              mfa: mfaEnabled,
              department: '',
              lastActive: new Date().toISOString(),
            };
            this.users = this.users || [];
            this.users.push(newUser);
            this.selectedManagerId = newUser.id;
          }
          this.persist('users');
          this.renderManagement();
          this.renderRoles();
          this.closeModal();
          this.showNotification(this.t(isEdit ? 'managementUserUpdated' : 'managementUserAdded'), 'success');
        });
      },

      saveSelectedManager() {
        const user = (this.users || []).find((manager) => manager.id === this.selectedManagerId);
        if (!user) return;
        const roleSelect = document.getElementById('management-detail-role-select');
        const statusSelect = document.getElementById('management-detail-status-select');
        const mfaInput = document.getElementById('management-detail-mfa');
        if (roleSelect) {
          user.role = roleSelect.value;
        }
        if (statusSelect) {
          user.status = statusSelect.value;
        }
        if (mfaInput) {
          user.mfa = mfaInput.checked;
        }
        this.persist('users');
        this.renderManagement();
        this.renderRoles();
        this.showNotification(this.t('managementUserUpdated'), 'success');
      },

      removeSelectedManager() {
        const user = (this.users || []).find((manager) => manager.id === this.selectedManagerId);
        if (!user) return;
        this.openConfirmModal({
          title: this.t('managementDetailRemove'),
          message: this.t('managementRemoveConfirm'),
          confirmLabel: this.t('managementDetailRemove'),
          cancelLabel: this.localize('Cancelar', 'Cancel'),
          onConfirm: () => {
            this.users = (this.users || []).filter((manager) => manager.id !== user.id);
            this.persist('users');
            this.selectedManagerId = this.users[0]?.id || null;
            this.renderManagement();
            this.renderRoles();
            this.showNotification(this.t('managementUserRemoved'), 'success');
          },
        });
      },

      saveRoleAssignments(roleName, fallbackRole = 'admin') {
        const grid = document.getElementById('role-assignment-grid');
        if (!grid) return;
        if (fallbackRole === roleName) {
          const alternative = (this.rolesMatrix || []).find((role) => role.role !== roleName);
          fallbackRole = alternative?.role || fallbackRole;
          if (fallbackRole === roleName) {
            this.showNotification(this.localize('Define un rol alterno antes de desasignar.', 'Pick a fallback role before unassigning.'), 'error');
            return;
          }
        }
        let changed = false;
        grid.querySelectorAll('input[data-role-assignment]').forEach((input) => {
          const user = (this.users || []).find((member) => member.id === input.value);
          if (!user) return;
          const shouldAssign = input.checked;
          if (shouldAssign && user.role !== roleName) {
            user.role = roleName;
            changed = true;
          } else if (!shouldAssign && user.role === roleName) {
            user.role = fallbackRole;
            changed = true;
          }
        });
        if (changed) {
          this.persist('users');
          this.renderManagement();
          this.renderRoles();
          this.showNotification(this.localize('Asignaciones actualizadas', 'Assignments updated'), 'success');
        } else {
          this.showNotification(this.localize('Sin cambios detectados', 'No changes detected'), 'info');
        }
      },

      renderSettingsKpis() {
        const companyNode = document.getElementById('settings-kpi-company');
        if (!companyNode) return;
        const company = (this.settings?.companyName || '').trim() || this.DEFAULT_SETTINGS.companyName || '—';
        companyNode.textContent = company;
        const companyHint = document.getElementById('settings-kpi-company-hint');
        if (companyHint) companyHint.textContent = this.t('settingsKpiCompanyHint');
        const themeNode = document.getElementById('settings-kpi-theme');
        if (themeNode) themeNode.textContent = this.currentTheme === 'dark' ? this.t('settingsThemeDark') : this.t('settingsThemeLight');
        const themeHint = document.getElementById('settings-kpi-theme-hint');
        if (themeHint) themeHint.textContent = this.t('settingsKpiThemeHint');
        const languageNode = document.getElementById('settings-kpi-language');
        if (languageNode) languageNode.textContent = this.currentLanguage === 'es' ? 'Español' : 'English';
        const languageHint = document.getElementById('settings-kpi-language-hint');
        if (languageHint) languageHint.textContent = this.t('settingsKpiLanguageHint');
      },

      resendAdminInvite(inviteId) {
        const invite = (this.adminInvites || []).find((item) => item.id === inviteId);
        if (!invite) return;
        invite.sentAt = new Date().toISOString();
        invite.status = 'pending';
        this.persist('adminInvites');
        this.renderManagementInvites();
        this.renderManagementKpis();
        this.showNotification(this.t('managementInviteResent'), 'success');
        this.copyAdminInvitePassword(inviteId);
      },

      cancelAdminInvite(inviteId) {
        this.adminInvites = (this.adminInvites || []).filter((invite) => invite.id !== inviteId);
        this.persist('adminInvites');
        this.renderManagementInvites();
        this.renderManagementKpis();
        this.showNotification(this.t('managementInviteCancelled'), 'success');
      },

      createAdminInvite() {
        const name = document.getElementById('admin-invite-name').value.trim();
        const email = document.getElementById('admin-invite-email').value.trim();
        const role = document.getElementById('admin-invite-role').value;
        if (!name || !email) {
          this.showNotification(this.localize('Completa nombre y correo', 'Name and email required'), 'error');
          return;
        }
        const invite = {
          id: `INVITE-${Date.now().toString(36).toUpperCase()}`,
          name,
          email,
          role,
          tempPassword: this.generateTempPassword(),
          status: 'pending',
          sentAt: new Date().toISOString(),
          expiresAt: new Date(Date.now() + 1000 * 60 * 60 * 24 * 7).toISOString(),
        };
        this.adminInvites = [invite, ...(this.adminInvites || [])];
        this.persist('adminInvites');
        this.renderManagementInvites();
        this.renderManagementKpis();
        document.getElementById('admin-invite-form').reset();
        this.showNotification(this.localize('Invitación generada', 'Invite generated'), 'success');
        this.copyAdminInvitePassword(invite.id);
      },

      copyAdminInvitePassword(inviteId) {
        const invite = (this.adminInvites || []).find((item) => item.id === inviteId);
        if (!invite?.tempPassword) return;
        if (navigator.clipboard?.writeText) {
          navigator.clipboard.writeText(invite.tempPassword);
          this.showNotification(this.localize('Contraseña copiada', 'Password copied'), 'success');
        }
      },

      regenerateAdminInvitePassword(inviteId) {
        const invite = (this.adminInvites || []).find((item) => item.id === inviteId);
        if (!invite) return;
        invite.tempPassword = this.generateTempPassword();
        invite.status = 'pending';
        invite.sentAt = new Date().toISOString();
        this.persist('adminInvites');
        this.renderManagementInvites();
        this.showNotification(this.localize('Nueva contraseña generada', 'New password generated'), 'success');
        this.copyAdminInvitePassword(inviteId);
      },

      getInitials(name = '') {
        return name
          .split(' ')
          .map((part) => part.charAt(0))
          .join('')
          .slice(0, 2)
          .toUpperCase() || '?';
      },

      getManagerStatusMeta(status = 'active') {
        const map = {
          active: { label: this.t('managementStatusActive'), className: 'active' },
          away: { label: this.t('managementStatusAway'), className: 'away' },
          disabled: { label: this.t('managementStatusDisabled'), className: 'disabled' },
        };
        return map[status] || map.active;
      },

      getRoleAccessConfig(role = this.currentRole) {
        return ROLE_ACCESS[role] || ROLE_ACCESS.owner;
      },

      getAccessiblePages(role = this.currentRole) {
        const config = this.getRoleAccessConfig(role);
        return config.pages || ROLE_ACCESS.owner.pages;
      },

      getRoleDefaultPage(role = this.currentRole) {
        const config = this.getRoleAccessConfig(role);
        return config.defaultPage || 'dashboard';
      },

      hasCapability(capability, role = this.currentRole) {
        if (!capability) return true;
        const config = this.getRoleAccessConfig(role);
        const capabilities = config.capabilities || [];
        return capabilities.includes('*') || capabilities.includes(capability);
      },

      requireCapability(capability) {
        if (this.hasCapability(capability)) {
          return true;
        }
        this.showNotification(this.localize('No tienes permiso para esta acción.', 'You are not allowed to perform this action.'), 'error');
        return false;
      },

      syncCapabilityVisibility() {
        document.querySelectorAll('[data-capability]').forEach((node) => {
          if (!node.dataset.capabilityDisplay) {
            node.dataset.capabilityDisplay = node.style.display || '';
          }
          const allowed = this.hasCapability(node.dataset.capability);
          if (node.dataset.capabilityMode === 'disable') {
            node.disabled = !allowed;
            node.classList.toggle('is-disabled', !allowed);
          } else {
            node.style.display = allowed ? node.dataset.capabilityDisplay : 'none';
          }
        });
      },

      enforceRoleAccess() {
        const allowed = this.getAccessiblePages();
        document.querySelectorAll('.sidebar-item').forEach((item) => {
          const page = item.dataset.page;
          // Only apply display logic to items with data-page (not navigation links)
          if (page) {
            item.style.display = allowed.includes(page) ? 'flex' : 'none';
          }
        });
        if (!allowed.includes(this.currentPage)) {
          const fallback = this.getRoleDefaultPage();
          if (fallback && fallback !== this.currentPage) {
            this.currentPage = fallback;
            this.showPage(fallback);
          }
        }
      },

      changeCurrentRole(role) {
        if (!ROLE_ACCESS[role]) return;
        if (['client', 'contractor'].includes(role)) {
          const target = role === 'client' ? 'client-portal.html' : 'contractor-portal.html';
          window.location.href = target;
          return;
        }
        if (this.currentRole === role) {
          this.enforceRoleAccess();
          this.updateRoleSwitcher();
          return;
        }
        this.currentRole = role;
        storage.set(STORAGE_KEYS.role, role);
        this.enforceRoleAccess();
        this.renderAll();
      },

      initRoleSwitcher() {
        const select = document.getElementById('role-switcher');
        if (!select) return;
        select.innerHTML = Object.keys(ROLE_ACCESS)
          .map((role) => `<option value="${role}">${this.formatLabel(role)}</option>`)
          .join('');
        select.value = this.currentRole;
        if (!select.dataset.bound) {
          select.addEventListener('change', (event) => this.changeCurrentRole(event.target.value));
          select.dataset.bound = 'true';
        }
      },

      updateRoleSwitcher() {
        const select = document.getElementById('role-switcher');
        if (select) {
          select.value = this.currentRole;
        }
      },

      renderRoles() {
        if (!this.selectedRoleId && this.rolesMatrix.length) {
          this.selectedRoleId = this.rolesMatrix[0].id;
        }
        this.renderRoleKpis();
        this.renderRoleList();
        this.renderRoleDetail();
      },

      renderRoleKpis() {
        const totalNode = document.getElementById('roles-kpi-total');
        if (!totalNode) return;
        const total = this.rolesMatrix.length;
        totalNode.textContent = total;
        const totalHint = document.getElementById('roles-kpi-total-hint');
        if (totalHint) totalHint.textContent = this.t('rolesKpiTotalHint');
        const adminCount = (this.users || []).filter((user) => ['owner', 'admin'].includes(user.role)).length;
        const adminNode = document.getElementById('roles-kpi-admins');
        if (adminNode) adminNode.textContent = adminCount;
        const adminHint = document.getElementById('roles-kpi-admins-hint');
        if (adminHint) adminHint.textContent = this.t('rolesKpiAdminsHint');
        const permissionsSet = new Set(this.rolesMatrix.flatMap((role) => role.permissions));
        const permNode = document.getElementById('roles-kpi-permissions');
        if (permNode) permNode.textContent = permissionsSet.size;
        const permHint = document.getElementById('roles-kpi-permissions-hint');
        if (permHint) permHint.textContent = this.t('rolesKpiPermissionsHint');
      },

      renderRoleList() {
        const list = document.getElementById('role-list');
        const searchInput = document.getElementById('role-search');
        if (!list) return;
        if (searchInput) {
          searchInput.placeholder = this.t('rolesSearchPlaceholder');
        }
        const query = (searchInput?.value || '').toLowerCase();
        const roles = this.rolesMatrix.filter((role) => role.role.toLowerCase().includes(query));
        if (!roles.length) {
          list.innerHTML = `<div class="management-empty">${this.t('rolesEmpty')}</div>`;
          this.selectedRoleId = null;
          this.renderRoleDetail();
          return;
        }
        if (!this.selectedRoleId || !roles.find((role) => role.id === this.selectedRoleId)) {
          this.selectedRoleId = roles[0].id;
        }
        list.innerHTML = roles
          .map(
            (role) => `
          <div class="role-item ${role.id === this.selectedRoleId ? 'active' : ''}" data-role="${role.id}">
            <div>
              <strong>${this.formatLabel(role.role)}</strong>
              <small>${role.permissions.length} ${this.t('rolesPermissionsLabel')}</small>
            </div>
            <span class="management-badge active" style="background:${role.color}; color:#fff;">${role.role}</span>
          </div>`
          )
          .join('');
        list.querySelectorAll('.role-item').forEach((item) => {
          item.addEventListener('click', () => {
            this.selectedRoleId = item.dataset.role;
            this.renderRoleList();
            this.renderRoleDetail();
          });
        });
        if (searchInput && !searchInput.dataset.bound) {
          searchInput.addEventListener('input', () => this.renderRoleList());
          searchInput.dataset.bound = 'true';
        }
      },

      renderRoleDetail() {
        const panel = document.getElementById('role-detail-card');
        if (!panel) return;
        const role = this.rolesMatrix.find((item) => item.id === this.selectedRoleId);
        if (!role) {
          panel.innerHTML = `<div class="management-detail-placeholder">${this.t('rolesDetailPlaceholder')}</div>`;
          return;
        }
        const assignedUsers = (this.users || []).filter((user) => user.role === role.role);
        const fallbackRoles = this.rolesMatrix.filter((item) => item.role !== role.role);
        const fallbackDefault = fallbackRoles.find((item) => item.role === 'admin')?.role || fallbackRoles[0]?.role || role.role;
        panel.innerHTML = `
          <div class="card-header" style="padding:0 0 10px 0; border:none;">
            <div>
              <h3 class="card-title">${this.formatLabel(role.role)}</h3>
              <p class="settings-note">${role.description || ''}</p>
            </div>
            <span class="management-badge active" style="background:${role.color}; color:#fff;">${assignedUsers.length} ${this.t(
          'rolesUsersLabel'
        )}</span>
          </div>
          <div class="role-permissions">
            ${role.permissions.map((perm) => `<div class="role-permission">${perm}</div>`).join('')}
          </div>
          <div class="settings-divider"></div>
          <div>
            <h4>${this.t('rolesUsersList')}</h4>
            <ul class="role-users-list">
              ${
                assignedUsers.length
                  ? assignedUsers.map((user) => `<li>${user.name} (${user.email})</li>`).join('')
                  : `<li>${this.t('rolesUsersEmpty')}</li>`
              }
            </ul>
          </div>
          <div class="settings-divider"></div>
          <div>
            <h4>${this.localize('Asignaciones rápidas', 'Quick assignments')}</h4>
            ${
              (this.users || []).length
                ? `<div class="role-permissions" id="role-assignment-grid">
                ${
                  (this.users || [])
                    .map(
                      (user) => `
                  <label class="role-permission" style="cursor:pointer;">
                    <input type="checkbox" data-role-assignment="${user.id}" ${user.role === role.role ? 'checked' : ''} />
                    ${user.name} (${this.formatLabel(user.role)})
                  </label>`
                    )
                    .join('')
                }
              </div>`
                : `<p class="settings-note">${this.t('rolesUsersEmpty')}</p>`
            }
          </div>
          ${
            fallbackRoles.length
              ? `<div class="form-group">
                  <label>${this.localize('Rol al desasignar', 'Fallback role')}</label>
                  <select id="role-assignment-fallback">
                    ${fallbackRoles
                      .map((item) => `<option value="${item.role}" ${item.role === fallbackDefault ? 'selected' : ''}>${this.formatLabel(item.role)}</option>`)
                      .join('')}
                  </select>
                </div>`
              : ''
          }
          <div class="management-detail-actions">
            <button class="btn btn-secondary" id="role-assign-save">${this.localize('Actualizar', 'Update')}</button>
            <button class="btn btn-secondary" id="role-assign-user">${this.t('rolesAssignUser')}</button>
          </div>`;
        const assignSaveBtn = panel.querySelector('#role-assign-save');
        if (assignSaveBtn) {
          assignSaveBtn.addEventListener('click', () => {
            const fallback = document.getElementById('role-assignment-fallback')?.value || fallbackDefault || 'admin';
            this.saveRoleAssignments(role.role, fallback);
          });
        }
        const assignBtn = panel.querySelector('#role-assign-user');
        if (assignBtn) {
          assignBtn.addEventListener('click', () => this.openAdminModal('add', null, role.role));
        }
      },


      getRolePermissionCatalog() {
        const set = new Set(this.rolesMatrix.flatMap((role) => role.permissions));
        return Array.from(set).sort((a, b) => a.localeCompare(b));
      },

      openRoleModal(mode = 'add', roleId = null) {
        const isEdit = mode === 'edit';
        const role = isEdit ? this.rolesMatrix.find((item) => item.id === roleId) : null;
        if (isEdit && !role) {
          alert(this.t('rolesSelectFirst'));
          return;
        }
        const modal = document.getElementById('modal-form');
        const titleEl = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        modal.classList.add('active');
        titleEl.textContent = this.t(isEdit ? 'rolesModalTitleEdit' : 'rolesModalTitleNew');
        const catalog = this.getRolePermissionCatalog();
        const selectedSet = new Set(role ? role.permissions : []);
        body.innerHTML = `
          <form id="role-form" class="modal-step" style="gap:16px;">
            <div class="form-group">
              <label>${this.t('rolesModalName')}</label>
              <input type="text" id="role-modal-name" value="${role ? this.escapeHtml(this.formatLabel(role.role)) : ''}" required />
            </div>
            <div class="form-group">
              <label>${this.t('rolesModalDescription')}</label>
              <textarea id="role-modal-description" rows="2">${role?.description || ''}</textarea>
            </div>
            <div class="form-group">
              <label>${this.t('rolesModalColor')}</label>
              <input type="color" id="role-modal-color" value="${role?.color || this.currentAccent || '#02735E'}" />
            </div>
            <div class="form-group">
              <label>${this.t('rolesModalPermissions')}</label>
              <div class="role-permissions" id="role-modal-permissions">
                ${catalog
                  .map(
                    (perm) => `
                  <label class="role-permission" style="cursor:pointer;">
                    <input type="checkbox" value="${this.escapeHtml(perm)}" ${selectedSet.has(perm) ? 'checked' : ''} style="margin-right:6px;" />
                    ${perm}
                  </label>`
                  )
                  .join('')}
              </div>
            </div>
            <div class="modal-step-actions" style="justify-content:flex-end;">
              <button type="submit" class="btn btn-primary">${this.t('rolesModalSave')}</button>
            </div>
          </form>`;
        const form = document.getElementById('role-form');
        form.addEventListener('submit', (event) => {
          event.preventDefault();
          const name = document.getElementById('role-modal-name').value.trim();
          if (!name) {
            alert(this.t('rolesModalRequired'));
            return;
          }
          const description = document.getElementById('role-modal-description').value.trim();
          const color = document.getElementById('role-modal-color').value || this.currentAccent || '#02735E';
          const perms = Array.from(document.querySelectorAll('#role-modal-permissions input[type="checkbox"]:checked')).map(
            (input) => input.value
          );
          if (!perms.length) {
            alert(this.t('rolesModalNoPermissions'));
            return;
          }
          if (isEdit && role) {
            role.role = name;
            role.description = description;
            role.color = color;
            role.permissions = perms;
          } else {
            const newRole = {
              id: `role-${Date.now().toString().slice(-5)}`,
              role: name,
              description,
              color,
              permissions: perms,
            };
            this.rolesMatrix.push(newRole);
            this.selectedRoleId = newRole.id;
          }
          this.persist('rolesMatrix');
          this.renderRoles();
          this.renderManagement();
          this.closeModal();
          this.showNotification(this.t('rolesSaved'), 'success');
        });
      },

      duplicateRole() {
        const role = this.rolesMatrix.find((item) => item.id === this.selectedRoleId);
        if (!role) {
          alert(this.t('rolesSelectFirst'));
          return;
        }
        const clone = {
          ...role,
          id: `role-${Date.now().toString().slice(-5)}`,
          role: `${role.role} Copy`,
          description: role.description,
          permissions: [...role.permissions],
        };
        this.rolesMatrix.push(clone);
        this.selectedRoleId = clone.id;
        this.persist('rolesMatrix');
        this.renderRoles();
        this.renderManagement();
        this.showNotification(this.t('rolesDuplicated'), 'success');
      },

      showPage(page) {
        const allowed = this.getAccessiblePages();
        if (!allowed.includes(page)) {
          if (page === 'settings' && this.currentRole !== 'owner') {
            this.showNotification(this.t('settingsOwnerOnly'), 'error');
          }
          const fallback = this.getRoleDefaultPage();
          if (fallback && fallback !== page) {
            this.currentPage = fallback;
            this.showPage(fallback);
          }
          return;
        }
        document.querySelectorAll('.sidebar-item').forEach((item) => item.classList.remove('active'));
        const navItem = document.querySelector(`.sidebar-item[data-page="${page}"]`);
        if (navItem) navItem.classList.add('active');
        document.querySelectorAll('.page').forEach((section) => {
          section.classList.remove('active');
          section.hidden = true;
        });
        const targetSection = document.getElementById(`page-${page}`);
        if (targetSection) {
          targetSection.classList.add('active');
          targetSection.hidden = false;
        }
        this.currentPage = page;
      },

      openConfirmModal({ title, message, confirmLabel = this.localize('Confirmar', 'Confirm'), cancelLabel = this.localize('Cancelar', 'Cancel'), onConfirm }) {
        const modal = document.getElementById('modal-form');
        const body = document.getElementById('modal-body');
        const modalTitle = document.getElementById('modal-title');
        modal.classList.add('active');
        modalTitle.textContent = title || 'Confirmar';
        body.innerHTML = `
          <div class="modal-step" style="gap:16px;">
            <p>${message}</p>
            <div class="modal-step-actions" style="justify-content:flex-end; gap:8px;">
              <button class="btn btn-secondary" data-confirm="cancel">${cancelLabel}</button>
              <button class="btn btn-primary" data-confirm="accept">${confirmLabel}</button>
            </div>
          </div>`;
        const cancelBtn = body.querySelector('[data-confirm="cancel"]');
        const acceptBtn = body.querySelector('[data-confirm="accept"]');
        if (cancelBtn) {
          cancelBtn.addEventListener('click', () => this.closeModal());
        }
        if (acceptBtn) {
          acceptBtn.addEventListener('click', () => {
            this.closeModal();
            if (typeof onConfirm === 'function') {
              onConfirm();
            }
          });
        }
      },

      openQuoteModal(quoteId = null) {
        if (!this.requireCapability('quotes.manage')) return;
        const modal = document.getElementById('modal-form');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        const quote = quoteId ? (this.quotes || []).find((item) => item.id === quoteId) : null;
        const customers = this.customers || [];
        const statuses = ['draft', 'sent', 'approved', 'won', 'lost'];
        modal.classList.add('active');
        title.textContent = quote ? this.localize('Editar cotización', 'Edit quote') : this.localize('Nueva cotización', 'New quote');
        body.innerHTML = `
          <form id="quote-form" class="modal-step" style="gap:16px;">
            <div class="form-group">
              <label>${this.t('colCustomer')}</label>
              <select name="customer" required>
                <option value="">${this.t('orderSelectClientHint')}</option>
                ${customers
                  .map(
                    (customer) => `<option value="${customer.name}" ${quote?.customer === customer.name ? 'selected' : ''}>${customer.name}</option>`
                  )
                  .join('')}
              </select>
            </div>
            <div class="form-group">
              <label>${this.t('colService')}</label>
              <input type="text" name="service" value="${quote?.service || ''}" required />
            </div>
            <div class="form-group">
              <label>${this.t('inventoryValue')}</label>
              <input type="number" name="total" min="0" step="100" value="${quote?.total || 0}" required />
            </div>
            <div class="form-group">
              <label>${this.t('colStatus')}</label>
              <select name="status">
                ${statuses
                  .map((status) => `<option value="${status}" ${status === (quote?.status || 'draft') ? 'selected' : ''}>${this.formatStatus(status)}</option>`)
                  .join('')}
              </select>
            </div>
            <div class="form-group">
              <label>${this.t('startDate')}</label>
              <input type="date" name="issued" value="${quote?.issued || new Date().toISOString().split('T')[0]}" required />
            </div>
            <div class="form-group">
              <label>${this.t('billingValidUntil') || 'Vigencia'}</label>
              <input type="date" name="validUntil" value="${quote?.validUntil || ''}" />
            </div>
            <div class="form-group" style="grid-column:1 / -1;">
              <label>${this.t('notes')}</label>
              <textarea name="notes" rows="3">${quote?.notes || ''}</textarea>
            </div>
            <div class="modal-step-actions" style="justify-content:flex-end;">
              <button type="submit" class="btn btn-primary">${this.localize('Guardar', 'Save')}</button>
            </div>
          </form>`;
        const form = document.getElementById('quote-form');
        form.addEventListener('submit', (event) => {
          event.preventDefault();
          const data = new FormData(form);
          const customer = data.get('customer');
          const service = (data.get('service') || '').trim();
          if (!customer || !service) {
            this.showNotification(this.localize('Completa los campos requeridos.', 'Please complete required fields.'), 'error');
            return;
          }
          const payload = {
            id: quote ? quote.id : `Q-${Date.now().toString().slice(-4)}`,
            customer,
            service,
            total: Number(data.get('total')) || 0,
            status: data.get('status') || 'draft',
            issued: data.get('issued') || new Date().toISOString().split('T')[0],
            validUntil: data.get('validUntil') || data.get('issued') || '',
            notes: data.get('notes') || '',
          };
          if (quote) {
            Object.assign(quote, payload);
          } else {
            this.quotes.unshift(payload);
          }
          this.persist('quotes');
          this.renderQuotes();
          this.renderClientPortal();
          this.closeModal();
          this.showNotification(this.localize('Cotización guardada', 'Quote saved'), 'success');
        });
      },

      openModal(type) {
        const modal = document.getElementById('modal-form');
        const body = document.getElementById('modal-body');
        const title = document.getElementById('modal-title');
        if (type === 'new-customer') {
          this.openCustomerModal();
          return;
        }
        if (type === 'new-quote') {
          this.openQuoteModal();
          return;
        }
        title.textContent = type;
        body.innerHTML = `
          <div class="form-group">
            <label>Nombre</label>
            <input type="text" />
          </div>
          <button class="btn btn-primary" style="margin-top: 12px;">Guardar</button>`;
        modal.classList.add('active');
      },

      closeModal() {
        document.getElementById('modal-form').classList.remove('active');
      },
    };

    window.addEventListener('DOMContentLoaded', () => app.init());
  </script>
  
  <script>
    // ========== GLOBAL SEARCH FUNCTIONALITY ==========
    let searchTimeout = null;
    
    function performGlobalSearch(query) {
      // Clear previous timeout
      clearTimeout(searchTimeout);
      
      const dropdown = document.getElementById('searchResultsDropdown');
      
      // Hide dropdown if query is too short
      if (!query || query.trim().length < 2) {
        dropdown.style.display = 'none';
        return;
      }
      
      // Debounce search
      searchTimeout = setTimeout(() => {
        executeSearch(query.trim().toLowerCase());
      }, 300);
    }
    
    function executeSearch(query) {
      const dropdown = document.getElementById('searchResultsDropdown');
      
      // Search in projects
      const projects = JSON.parse(localStorage.getItem('projectsync_projects') || '[]');
      const projectResults = projects.filter(p => {
        return (p.name && p.name.toLowerCase().includes(query)) ||
               (p.client && p.client.toLowerCase().includes(query)) ||
               (p.idSync && p.idSync.toLowerCase().includes(query)) ||
               (p.id && p.id.toLowerCase().includes(query)) ||
               (p.contact && p.contact.toLowerCase().includes(query)) ||
               (p.phone && p.phone.toLowerCase().includes(query)) ||
               (p.email && p.email.toLowerCase().includes(query)) ||
               (p.address && p.address.toLowerCase().includes(query));
      }).slice(0, 5); // Limit to 5 results
      
      // Search in threads
      const threadsData = JSON.parse(localStorage.getItem('threadsync_threads') || '{}');
      const threads = Object.values(threadsData);
      const threadResults = threads.filter(t => {
        return (t.clientName && t.clientName.toLowerCase().includes(query)) ||
               (t.title && t.title.toLowerCase().includes(query)) ||
               (t.subject && t.subject.toLowerCase().includes(query)) ||
               (t.contactInfo && t.contactInfo.toLowerCase().includes(query)) ||
               (t.owner && t.owner.toLowerCase().includes(query));
      }).slice(0, 5); // Limit to 5 results
      
      // Build results HTML
      let resultsHTML = '';
      
      if (projectResults.length > 0) {
        resultsHTML += `
          <div style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9; background: #fafafa;">
            <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b;">Proyectos (${projectResults.length})</div>
          </div>
        `;
        
        projectResults.forEach(project => {
          resultsHTML += `
            <div class="search-result-item" onclick="openProject('${project.id}')" style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.15s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #02735E, #035951); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                  </svg>
                </div>
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 600; font-size: 14px; color: #1e293b; margin-bottom: 2px;">${project.name}</div>
                  <div style="font-size: 12px; color: #64748b;">
                    ${project.idSync || project.id} · ${project.client || 'Sin cliente'}
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 4px; color: #02735E;">
                  <span style="font-size: 12px; font-weight: 600;">Ver</span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </div>
              </div>
            </div>
          `;
        });
      }
      
      if (threadResults.length > 0) {
        resultsHTML += `
          <div style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9; background: #fafafa;">
            <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b;">Threads (${threadResults.length})</div>
          </div>
        `;
        
        threadResults.forEach(thread => {
          const threadId = Object.keys(threadsData).find(key => threadsData[key] === thread);
          resultsHTML += `
            <div class="search-result-item" onclick="openThread('${threadId}')" style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.15s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                  </svg>
                </div>
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 600; font-size: 14px; color: #1e293b; margin-bottom: 2px;">${thread.clientName || thread.title}</div>
                  <div style="font-size: 12px; color: #64748b;">
                    ${thread.subject || 'Sin descripción'} · ${thread.owner || 'Sin asignar'}
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 4px; color: #10b981;">
                  <span style="font-size: 12px; font-weight: 600;">Ver</span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </div>
              </div>
            </div>
          `;
        });
      }
      
      if (projectResults.length === 0 && threadResults.length === 0) {
        resultsHTML = `
          <div style="padding: 32px 16px; text-align: center;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="2" style="margin: 0 auto 12px;">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <div style="font-size: 14px; font-weight: 600; color: #64748b; margin-bottom: 4px;">Sin resultados</div>
            <div style="font-size: 12px; color: #94a3b8;">No se encontraron proyectos ni threads con "${query}"</div>
          </div>
        `;
      }
      
      dropdown.innerHTML = resultsHTML;
      dropdown.style.display = 'block';
    }
    
    function openProject(projectId) {
      window.location.href = `viewsync.html?id=${projectId}`;
    }
    
    function openThread(threadId) {
      window.location.href = `threadsync.html?id=${threadId}`;
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const searchInput = document.getElementById('globalSearchInput');
      const dropdown = document.getElementById('searchResultsDropdown');
      
      if (searchInput && dropdown && !searchInput.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });
  </script>
  
  <script>
    // Forzador: reaplica estilos oscuros a los elementos de facturación si el tema es dark.
    (function forceBillingDark() {
      function apply() {
        try {
          const isDark = (document.documentElement && document.documentElement.dataset && document.documentElement.dataset.theme === 'dark') || (document.querySelector('.app-shell')?.dataset?.theme === 'dark');
          if (!isDark) return;
          // Force dark style on billing columns and layout (large panels)
          document.querySelectorAll('.billing-column, .billing-layout, .portal-detail-card, .portal-section').forEach((col) => {
            col.style.setProperty('background', 'linear-gradient(180deg, rgba(6,12,20,0.7), rgba(8,16,26,0.62))', 'important');
            col.style.setProperty('border-color', 'rgba(255,255,255,0.03)', 'important');
            col.style.setProperty('box-shadow', '0 20px 48px rgba(0,0,0,0.6)', 'important');
            col.style.setProperty('color', '#e6eef8', 'important');
          });

          // Then force each billing item darker as well
          document.querySelectorAll('.billing-item').forEach((el) => {
            el.style.setProperty('background', 'linear-gradient(180deg, rgba(6,12,20,0.65), rgba(10,18,28,0.6))', 'important');
            el.style.setProperty('border-color', 'rgba(255,255,255,0.03)', 'important');
            el.style.setProperty('box-shadow', '0 12px 28px rgba(0,0,0,0.6)', 'important');
            el.style.setProperty('color', '#e6eef8', 'important');
          });

          // Remove inline styles on status pills so CSS classes control appearance
          document.querySelectorAll('.billing-status-pill[style]').forEach((pill) => {
            pill.removeAttribute('style');
          });
        } catch (e) {
          // no-op
        }
      }

      // Ejecutar varias veces y observar cambios para vencer otros scripts que se ejecuten después
      setTimeout(apply, 100);
      setTimeout(apply, 400);
      setTimeout(apply, 1000);

      const observer = new MutationObserver(() => apply());
      observer.observe(document.body, { childList: true, subtree: true });
      // Desconectar después de 8s para evitar overhead
      setTimeout(() => observer.disconnect(), 8000);
    })();
  </script>

  <script>
    // MotorSync - Adaptación de Categorías
    const CATEGORY_CONFIG = {
      plumbing: {
        code: 'PLM',
        name: 'Plomería',
        serviceLabel: 'Servicios de Plomería',
        techLabel: 'Plomeros/Técnicos',
        workLabel: 'Reparaciones',
        materialLabel: 'Tubería y Accesorios',
        color: '#02735E'
      },
      hvac: {
        code: 'HVC',
        name: 'HVAC y Refrigeración',
        serviceLabel: 'Servicios HVAC',
        techLabel: 'Técnicos HVAC',
        workLabel: 'Instalaciones',
        materialLabel: 'Equipos HVAC',
        color: '#034040'
      },
      solar: {
        code: 'SOL',
        name: 'Energía Solar',
        serviceLabel: 'Instalaciones Solares',
        techLabel: 'Instaladores Solares',
        workLabel: 'Proyectos',
        materialLabel: 'Paneles y Equipos',
        color: '#035951'
      },
      electrical: {
        code: 'ELC',
        name: 'Electricidad',
        serviceLabel: 'Servicios Eléctricos',
        techLabel: 'Electricistas',
        workLabel: 'Trabajos Eléctricos',
        materialLabel: 'Material Eléctrico',
        color: '#02735E'
      },
      roofing: {
        code: 'ROF',
        name: 'Roofing (Techos)',
        serviceLabel: 'Servicios de Techado',
        techLabel: 'Techadores',
        workLabel: 'Proyectos de Techo',
        materialLabel: 'Tejas y Materiales',
        color: '#022326'
      },
      restoration: {
        code: 'RST',
        name: 'Restauración de Daños',
        serviceLabel: 'Servicios de Restauración',
        techLabel: 'Técnicos Restauración',
        workLabel: 'Casos',
        materialLabel: 'Equipos Restauración',
        color: '#034040'
      },
      abatement: {
        code: 'ABT',
        name: 'Abatimiento',
        serviceLabel: 'Servicios de Abatimiento',
        techLabel: 'Técnicos Certificados',
        workLabel: 'Proyectos',
        materialLabel: 'EPP y Equipos',
        color: '#035951'
      },
      landscaping: {
        code: 'LND',
        name: 'Landscaping',
        serviceLabel: 'Servicios de Paisajismo',
        techLabel: 'Jardineros/Paisajistas',
        workLabel: 'Proyectos',
        materialLabel: 'Plantas y Equipos',
        color: '#02735E'
      },
      pool: {
        code: 'POL',
        name: 'Servicios de Piscinas',
        serviceLabel: 'Mantenimiento de Piscinas',
        techLabel: 'Técnicos Piscinas',
        workLabel: 'Servicios',
        materialLabel: 'Químicos y Equipos',
        color: '#034040'
      },
      painting: {
        code: 'PNT',
        name: 'Pintura',
        serviceLabel: 'Servicios de Pintura',
        techLabel: 'Pintores',
        workLabel: 'Proyectos',
        materialLabel: 'Pinturas y Materiales',
        color: '#035951'
      },
      pest: {
        code: 'PST',
        name: 'Control de Plagas',
        serviceLabel: 'Control de Plagas',
        techLabel: 'Técnicos Control',
        workLabel: 'Servicios',
        materialLabel: 'Productos Control',
        color: '#02735E'
      },
      telecom: {
        code: 'TLC',
        name: 'Telecomunicaciones',
        serviceLabel: 'Instalaciones Telecom',
        techLabel: 'Técnicos Telecom',
        workLabel: 'Instalaciones',
        materialLabel: 'Equipos y Cables',
        color: '#022326'
      },
      concrete: {
        code: 'CNC',
        name: 'Concreto y Albañilería',
        serviceLabel: 'Trabajos de Construcción',
        techLabel: 'Albañiles/Concreteros',
        workLabel: 'Proyectos',
        materialLabel: 'Materiales Construcción',
        color: '#034040'
      },
      fire: {
        code: 'FIR',
        name: 'Sistemas Contra Incendios',
        serviceLabel: 'Sistemas Contra Incendios',
        techLabel: 'Técnicos Certificados',
        workLabel: 'Instalaciones/Servicios',
        materialLabel: 'Equipos Contra Incendios',
        color: '#035951'
      },
      facility: {
        code: 'FAC',
        name: 'Facility Management',
        serviceLabel: 'Mantenimiento de Edificios',
        techLabel: 'Técnicos Mantenimiento',
        workLabel: 'Órdenes de Trabajo',
        materialLabel: 'Suministros Generales',
        color: '#02735E'
      },
      excavation: {
        code: 'EXC',
        name: 'Excavación',
        serviceLabel: 'Servicios de Excavación',
        techLabel: 'Operadores',
        workLabel: 'Proyectos',
        materialLabel: 'Maquinaria y Equipos',
        color: '#022326'
      },
      logistics: {
        code: 'LOG',
        name: 'Logística y Distribución',
        serviceLabel: 'Servicios Logísticos',
        techLabel: 'Conductores',
        workLabel: 'Rutas',
        materialLabel: 'Vehículos y Equipos',
        color: '#034040'
      },
      moving: {
        code: 'MOV',
        name: 'Mudanzas',
        serviceLabel: 'Servicios de Mudanza',
        techLabel: 'Equipo Mudanzas',
        workLabel: 'Mudanzas',
        materialLabel: 'Materiales Empaque',
        color: '#035951'
      },
      catering: {
        code: 'CAT',
        name: 'Catering y Eventos',
        serviceLabel: 'Servicios de Catering',
        techLabel: 'Personal Catering',
        workLabel: 'Eventos',
        materialLabel: 'Suministros y Equipos',
        color: '#02735E'
      },
      remodeling: {
        code: 'REM',
        name: 'Remodelación',
        serviceLabel: 'Servicios de Remodelación',
        techLabel: 'Contratistas/Técnicos',
        workLabel: 'Proyectos',
        materialLabel: 'Materiales Construcción',
        color: '#034040'
      }
    };

    function updateCategory() {
      const selector = document.getElementById('category-selector');
      const category = selector.value;
      const config = CATEGORY_CONFIG[category];
      
      if (!config) return;
      
      // Save preference
      localStorage.setItem('motorsync_category', category);
      
      // Update dynamically throughout the UI
      console.log('MotorSync adaptado a:', config.name);
      
      // You can expand this to update labels, terminology, colors dynamically
    }

    // Initialize category selector
    document.addEventListener('DOMContentLoaded', () => {
      const selector = document.getElementById('category-selector');
      const saved = localStorage.getItem('motorsync_category');
      
      if (saved && CATEGORY_CONFIG[saved]) {
        selector.value = saved;
        updateCategory();
      }
      
      selector.addEventListener('change', updateCategory);
    });

    // Logo upload handler
    document.addEventListener('DOMContentLoaded', () => {
      const logoUpload = document.getElementById('logo-upload');
      const logoPreview = document.getElementById('logo-preview');
      const accentPicker = document.getElementById('accent-picker');
      const accentHex = document.getElementById('accent-hex');

      if (logoUpload) {
        logoUpload.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (event) => {
              logoPreview.innerHTML = `<img src="${event.target.result}" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px;">`;
              localStorage.setItem('company_logo', event.target.result);
            };
            reader.readAsDataURL(file);
          }
        });

        // Load saved logo
        const savedLogo = localStorage.getItem('company_logo');
        if (savedLogo) {
          logoPreview.innerHTML = `<img src="${savedLogo}" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px;">`;
        }
      }

      if (accentPicker && accentHex) {
        accentPicker.addEventListener('input', (e) => {
          accentHex.value = e.target.value;
          document.documentElement.style.setProperty('--accent-color', e.target.value);
          localStorage.setItem('company_accent', e.target.value);
        });

        // Load saved accent
        const savedAccent = localStorage.getItem('company_accent');
        if (savedAccent) {
          accentPicker.value = savedAccent;
          accentHex.value = savedAccent;
          document.documentElement.style.setProperty('--accent-color', savedAccent);
        }
      }
    });

    // Tab functionality for new pages
    document.addEventListener('DOMContentLoaded', () => {
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.getAttribute('data-tab');
          
          // Remove active class from all tabs and contents
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(tc => tc.classList.remove('active'));
          
          // Add active class to clicked tab and corresponding content
          tab.classList.add('active');
          const targetContent = document.querySelector(`[data-tab-content="${targetTab}"]`);
          if (targetContent) {
            targetContent.classList.add('active');
          }
        });
      });

      // ===== MOTORSYNC MAIN TABS (ProjectSync / ThreadSync) =====
      const motorsyncMainTabs = document.querySelectorAll('[data-motorsync-main]');
      const motorsyncMainPanels = document.querySelectorAll('[data-motorsync-main-panel]');
      
      motorsyncMainTabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          const target = tab.dataset.motorsyncMain;
          
          // Actualizar estilos de pestañas
          motorsyncMainTabs.forEach((btn) => {
            btn.classList.remove('active');
            // Estilo inactivo
            btn.style.background = 'transparent';
            btn.style.border = '1px solid rgba(16, 185, 129, 0.3)';
            btn.style.color = '#047857';
          });
          
          // Estilo activo
          tab.classList.add('active');
          tab.style.background = 'white';
          tab.style.border = '2px solid #10b981';
          tab.style.color = '#10b981';
          
          // Mostrar/ocultar paneles
          motorsyncMainPanels.forEach((panel) => {
            if (panel.dataset.motorsyncMainPanel === target) {
              panel.style.display = 'block';
            } else {
              panel.style.display = 'none';
            }
          });
        });
      });

      const projectTabs = document.querySelectorAll('[data-projectsync-tab]');
      const projectPanels = document.querySelectorAll('[data-projectsync-panel]');
      projectTabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          const target = tab.dataset.projectsyncTab;
          projectTabs.forEach((btn) => btn.classList.remove('active'));
          tab.classList.add('active');
          projectPanels.forEach((panel) => {
            panel.classList.toggle('active', panel.dataset.projectsyncPanel === target);
          });
          
          // Reinicializar el mapa cuando se cambia a una pestaña que lo contiene
          if (target === 'overview' || target === 'projects') {
            // Destruir mapa anterior si existe
            if (map) {
              map.remove();
              map = null;
              markers = [];
            }
            // Inicializar nuevo mapa después de un breve delay
            setTimeout(() => {
              initializeProjectsMap();
            }, 100);
          }
        });
      });
    });

    // ===== PROJECT CHAT FUNCTIONALITY (Basecamp-style) =====
    
    // Sample chat data
    const projectChats = {
      'ORD-201': {
        name: 'Instalación HVAC Completo',
        messages: [
          { id: 1, author: 'Juan Rodríguez', role: 'Owner', time: '10:24 AM', date: '15 Nov', message: 'Equipo confirmado para mañana. Carlos, ¿tienes todo el material listo?', avatar: 'JR', color: '#02735E' },
          { id: 2, author: 'Carlos Sánchez', role: 'Tech', time: '10:31 AM', date: '15 Nov', message: 'Sí, todo preparado. El equipo HVAC llegó ayer y ya lo revisé. Todo en orden.', avatar: 'CS', color: '#64748b' },
          { id: 3, author: 'María López', role: 'Admin', time: '11:15 AM', date: '15 Nov', message: 'Perfecto. Actualicé la orden de compra con los materiales adicionales que solicitaste.', avatar: 'ML', color: '#035951' },
          { id: 4, author: 'Carlos Sánchez', role: 'Tech', time: '2:45 PM', date: '15 Nov', message: 'Avance del 65%. Sistema de ductos instalado. Mañana conectamos la unidad principal.', avatar: 'CS', color: '#64748b' },
          { id: 5, author: 'Juan Rodríguez', role: 'Owner', time: '3:10 PM', date: '15 Nov', message: 'Excelente progreso 👍 Mantén actualizado el registro fotográfico para el cliente.', avatar: 'JR', color: '#02735E' }
        ]
      },
      'ORD-202': {
        name: 'Reparación Sistema Eléctrico',
        messages: [
          { id: 1, author: 'María López', role: 'Admin', time: '9:00 AM', date: '16 Nov', message: 'Cliente confirmó acceso para el lunes 18. Necesitamos asignar técnico.', avatar: 'ML', color: '#035951' },
          { id: 2, author: 'Juan Rodríguez', role: 'Owner', time: '9:15 AM', date: '16 Nov', message: 'Carlos está disponible. Lo asigno a este proyecto.', avatar: 'JR', color: '#02735E' }
        ]
      },
      'ORD-203': {
        name: 'Mantenimiento de Calderas',
        messages: [
          { id: 1, author: 'Carlos Sánchez', role: 'Tech', time: '8:00 AM', date: '05 Nov', message: 'Iniciando inspección de las 3 calderas del hotel.', avatar: 'CS', color: '#64748b' },
          { id: 2, author: 'Carlos Sánchez', role: 'Tech', time: '10:30 AM', date: '05 Nov', message: 'Caldera #1: Necesita reemplazo de válvula de seguridad. Tenemos en stock?', avatar: 'CS', color: '#64748b' },
          { id: 3, author: 'María López', role: 'Admin', time: '10:45 AM', date: '05 Nov', message: 'Sí, hay 2 en bodega. Ya pedí que te las lleven.', avatar: 'ML', color: '#035951' },
          { id: 4, author: 'Carlos Sánchez', role: 'Tech', time: '3:20 PM', date: '06 Nov', message: 'Las 3 calderas ya pasaron pruebas. Todo funcionando correctamente.', avatar: 'CS', color: '#64748b' },
          { id: 5, author: 'Juan Rodríguez', role: 'Owner', time: '3:45 PM', date: '06 Nov', message: 'Perfecto. Genera el reporte de mantenimiento para el cliente.', avatar: 'JR', color: '#02735E' },
          { id: 6, author: 'Carlos Sánchez', role: 'Tech', time: '5:10 PM', date: '07 Nov', message: 'Reporte enviado con fotos del antes/después y certificado de pruebas.', avatar: 'CS', color: '#64748b' },
          { id: 7, author: 'María López', role: 'Admin', time: '9:30 AM', date: '08 Nov', message: 'Cliente muy satisfecho. Ya autorizó el pago.', avatar: 'ML', color: '#035951' },
          { id: 8, author: 'Juan Rodríguez', role: 'Owner', time: '10:00 AM', date: '08 Nov', message: 'Excelente trabajo equipo! Proyecto cerrado. ✅', avatar: 'JR', color: '#02735E' }
        ]
      }
    };

    function openProjectChat(projectId, projectName) {
      const modal = document.getElementById('project-chat-modal');
      const overlay = document.getElementById('chat-overlay');
      const chatMessages = document.getElementById('chat-messages');
      const orderRecord = (window.app && typeof app.findOrderByKey === 'function') ? app.findOrderByKey(projectId) : null;
      const resolvedId = orderRecord?.id || projectId;
      const derivedName = orderRecord?.projectName || orderRecord?.service || projectName || 'Proyecto';
      const idSyncLabel = orderRecord?.idSync
        ? `IDSync ${orderRecord.idSync}`
        : orderRecord?.projectNumber
        ? `Proyecto #${orderRecord.projectNumber}`
        : `ID: ${resolvedId}`;
      
      // Set project info
      document.getElementById('chat-project-name').textContent = derivedName;
      document.getElementById('chat-project-id').textContent = idSyncLabel;
      
      // Load messages
      const chat = projectChats[resolvedId] || projectChats[projectId];
      if (chat && chat.messages) {
        chatMessages.innerHTML = chat.messages.map(msg => `
          <div style="margin-bottom: 20px;">
            <div style="display: flex; gap: 12px; align-items: flex-start;">
              <div style="width: 36px; height: 36px; border-radius: 50%; background: ${msg.color}; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 600; flex-shrink: 0;">${msg.avatar}</div>
              <div style="flex: 1;">
                <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px;">
                  <strong style="color: #334155; font-size: 14px;">${msg.author}</strong>
                  <span style="color: #94a3b8; font-size: 12px;">${msg.role}</span>
                  <span style="color: #cbd5e1; font-size: 12px;">•</span>
                  <span style="color: #94a3b8; font-size: 12px;">${msg.date} ${msg.time}</span>
                </div>
                <p style="margin: 0; color: #475569; font-size: 14px; line-height: 1.5;">${msg.message}</p>
              </div>
            </div>
          </div>
        `).join('');
      } else {
        chatMessages.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 40px 20px;">No hay mensajes aún. Inicia la conversación.</p>';
      }
      
      // Show modal and overlay
      overlay.style.display = 'block';
      modal.style.display = 'block';
      
      // Animate slide in
      setTimeout(() => {
        modal.style.right = '0';
      }, 10);
      
      // Scroll to bottom
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 100);
      
      // Store current project
      modal.dataset.projectId = resolvedId;
    }

    function closeProjectChat() {
      const modal = document.getElementById('project-chat-modal');
      const overlay = document.getElementById('chat-overlay');
      
      // Animate slide out
      modal.style.right = '-400px';
      
      setTimeout(() => {
        modal.style.display = 'none';
        overlay.style.display = 'none';
      }, 300);
    }

    function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      const modal = document.getElementById('project-chat-modal');
      const projectId = modal.dataset.projectId;
      const chatMessages = document.getElementById('chat-messages');
      
      // Create new message (simulated as current user)
      const now = new Date();
      const timeStr = now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
      const dateStr = now.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
      
      const newMessage = {
        id: Date.now(),
        author: 'Tú',
        role: 'Owner',
        time: timeStr,
        date: dateStr,
        message: message,
        avatar: 'TU',
        color: '#02735E'
      };
      
      // Add to chat data
      if (!projectChats[projectId]) {
        const linkedOrder = window.app && typeof app.findOrderByKey === 'function' ? app.findOrderByKey(projectId) : null;
        projectChats[projectId] = { name: linkedOrder?.projectName || linkedOrder?.service || 'Proyecto', messages: [] };
      }
      projectChats[projectId].messages.push(newMessage);
      
      // Append to UI
      const messageHTML = `
        <div style="margin-bottom: 20px;">
          <div style="display: flex; gap: 12px; align-items: flex-start;">
            <div style="width: 36px; height: 36px; border-radius: 50%; background: ${newMessage.color}; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 600; flex-shrink: 0;">${newMessage.avatar}</div>
            <div style="flex: 1;">
              <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px;">
                <strong style="color: #334155; font-size: 14px;">${newMessage.author}</strong>
                <span style="color: #94a3b8; font-size: 12px;">${newMessage.role}</span>
                <span style="color: #cbd5e1; font-size: 12px;">•</span>
                <span style="color: #94a3b8; font-size: 12px;">${newMessage.date} ${newMessage.time}</span>
              </div>
              <p style="margin: 0; color: #475569; font-size: 14px; line-height: 1.5;">${newMessage.message}</p>
            </div>
          </div>
        </div>
      `;
      
      chatMessages.insertAdjacentHTML('beforeend', messageHTML);
      
      // Clear input
      input.value = '';
      
      // Scroll to bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Allow Enter to send message (Shift+Enter for new line)
    document.addEventListener('DOMContentLoaded', () => {
      const chatInput = document.getElementById('chat-input');
      if (chatInput) {
        chatInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
          }
        });
        
        // Auto-resize textarea
        chatInput.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
      }

      // Inicializar mapa de proyectos
      const projectsTab = document.querySelector('[data-projectsync-tab="projects"]');
      if (projectsTab) {
        projectsTab.addEventListener('click', () => {
          setTimeout(() => {
            initializeProjectsMap();
          }, 100);
        });
      }

      // Si la pestaña ya está activa al cargar (overview está activa por defecto)
      setTimeout(() => {
        initializeProjectsMap();
      }, 800);
    });

    // ========================================
    // DASHBOARD DATA & COUNTERS
    // ========================================

    // Default projects data if localStorage is empty
    function getDefaultProjectsData() {
      return [
        { id: 'ORD-201', name: 'Instalación HVAC Completo', client: 'Residencial Torres', status: 'active', amount: 12500, startDate: '2025-11-10', endDate: '2025-11-20' },
        { id: 'ORD-202', name: 'Reparación Sistema Eléctrico', client: 'Planta Industrial', status: 'active', amount: 8400, startDate: '2025-11-12', endDate: '2025-11-28' },
        { id: 'ORD-203', name: 'Mantenimiento Preventivo', client: 'Oficinas Corp', status: 'scheduled', amount: 4200, startDate: '2025-11-26', endDate: '2025-11-28' },
        { id: 'ORD-204', name: 'Renovación Plomería', client: 'Edificio Norte', status: 'active', amount: 15600, startDate: '2025-11-05', endDate: '2025-11-30' },
        { id: 'ORD-205', name: 'Sistema Contra Incendios', client: 'Centro Comercial', status: 'completed', amount: 22000, startDate: '2025-10-15', endDate: '2025-11-10' },
        { id: 'ORD-206', name: 'Cableado Estructurado', client: 'Tech Hub', status: 'active', amount: 9800, startDate: '2025-11-20', endDate: '2025-12-05' },
        { id: 'ORD-207', name: 'Pintura Exterior', client: 'Hotel Plaza', status: 'scheduled', amount: 35000, startDate: '2025-12-01', endDate: '2025-12-15' },
        { id: 'ORD-208', name: 'Jardinería General', client: 'Parque Central', status: 'active', amount: 3200, startDate: '2025-11-01', endDate: '2025-11-30' },
        { id: 'ORD-209', name: 'Impermeabilización', client: 'Bodegas Sur', status: 'completed', amount: 18500, startDate: '2025-10-01', endDate: '2025-10-20' },
        { id: 'ORD-210', name: 'Instalación Cámaras', client: 'Seguridad Total', status: 'active', amount: 7500, startDate: '2025-11-20', endDate: '2025-11-28' },
        { id: 'ORD-211', name: 'Reparación Techo', client: 'Casa Blanca', status: 'completed', amount: 5600, startDate: '2025-10-20', endDate: '2025-11-05' },
        { id: 'ORD-212', name: 'Limpieza Industrial', client: 'Fabrica X', status: 'active', amount: 4500, startDate: '2025-11-01', endDate: '2025-11-30' },
        { id: 'ORD-213', name: 'Mantenimiento Elevadores', client: 'Torre Ejecutiva', status: 'scheduled', amount: 8900, startDate: '2025-11-27', endDate: '2025-11-28' },
        { id: 'ORD-214', name: 'Instalación Paneles Solares', client: 'Eco House', status: 'active', amount: 45000, startDate: '2025-11-15', endDate: '2025-12-10' },
        { id: 'ORD-215', name: 'Remodelación Baños', client: 'Restaurante Y', status: 'completed', amount: 12000, startDate: '2025-10-05', endDate: '2025-10-25' },
        { id: 'ORD-216', name: 'Cambio Luminarias', client: 'Oficinas Z', status: 'completed', amount: 3400, startDate: '2025-11-01', endDate: '2025-11-15' }
      ];
    }

    function loadProjectsFromStorage() {
      const stored = localStorage.getItem('projectsync_projects');
      if (stored) {
        try {
          const projects = JSON.parse(stored);
          // Si hay proyectos guardados, usarlos
          if (projects && projects.length > 0) {
            return projects;
          }
        } catch (e) {
          console.error('Error parsing projects from localStorage', e);
        }
      }
      // Solo usar defaults si no hay nada en localStorage
      const defaults = getDefaultProjectsData();
      saveProjectsToStorage(defaults);
      return defaults;
    }

    function saveProjectsToStorage(projects) {
      localStorage.setItem('projectsync_projects', JSON.stringify(projects));
    }

    function updateDashboardCounters() {
      const projects = loadProjectsFromStorage();
      
      // Calculate counts
      const completed = projects.filter(p => p.status === 'completed').length;
      const active = projects.filter(p => p.status === 'active').length;
      const scheduled = projects.filter(p => p.status === 'scheduled').length;
      const total = projects.length;
      
      // Calculate financials
      const totalRevenue = projects.reduce((sum, p) => sum + (p.amount || 0), 0);
      const activeClients = new Set(projects.map(p => p.client)).size;
      const avgTicket = projects.length ? Math.round(totalRevenue / projects.length) : 0;

      // Update DOM - Dashboard Summary
      const summaryCards = document.querySelectorAll('#dashboard-summary .summary-card');
      if (summaryCards.length >= 3) {
        // Completed
        summaryCards[0].querySelector('.summary-card-value').textContent = completed;
        // Active
        summaryCards[1].querySelector('.summary-card-value').textContent = active;
        // Scheduled
        summaryCards[2].querySelector('.summary-card-value').textContent = scheduled;
      }

      // Update DOM - KPI Grids
      // We have two .kpi-grid elements.
      // Grid 1: Financials (indices 0-3)
      // Grid 2: Project Stats (indices 4-7)
      const kpiCards = document.querySelectorAll('.kpi-grid .stat-card');
      
      // Grid 1
      if (kpiCards.length > 0) kpiCards[0].querySelector('.stat-value').textContent = '$' + totalRevenue.toLocaleString();
      if (kpiCards.length > 1) kpiCards[1].querySelector('.stat-value').textContent = activeClients;
      if (kpiCards.length > 2) kpiCards[2].querySelector('.stat-value').textContent = '$' + avgTicket.toLocaleString();
      // kpiCards[3] is Satisfaction (static for now)

      // Grid 2 (ProjectSync Overview)
      if (kpiCards.length > 4) {
          kpiCards[4].querySelector('.stat-value').textContent = total;
          kpiCards[4].querySelector('.stat-change').textContent = `${active} activos`;
      }
      if (kpiCards.length > 5) kpiCards[5].querySelector('.stat-value').textContent = active;
      if (kpiCards.length > 6) kpiCards[6].querySelector('.stat-value').textContent = completed;
      if (kpiCards.length > 7) kpiCards[7].querySelector('.stat-value').textContent = scheduled;
      
      console.log('✅ Dashboard counters updated from real data');
    }

    function updateThreadCounters() {
      const storedThreads = localStorage.getItem('threadsync_threads');
      if (!storedThreads) return;
      
      try {
        const threads = JSON.parse(storedThreads);
        const unreadCount = Object.values(threads).filter(t => !t.isRead && !t.isArchived).length;
        
        const unreadBadge = document.querySelector('[data-thread-filter="unread"] span');
        if (unreadBadge) {
          unreadBadge.textContent = unreadCount;
          unreadBadge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
        }
        console.log('✅ Thread counters updated from real data');
      } catch (e) {
        console.error('Error updating thread counters', e);
      }
    }

    // === FECHA DINÁMICA ===
    function updateDashboardDate() {
      const dateEl = document.getElementById('dashboard-date');
      if (dateEl) {
        const now = new Date();
        const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        const formatted = now.toLocaleDateString('es-MX', options);
        // Capitalizar primera letra
        dateEl.textContent = formatted.charAt(0).toUpperCase() + formatted.slice(1);
      }
    }

    // === KPIs OPERACIONALES EN TIEMPO REAL ===
    function updateOperationalKPIs() {
      const projects = loadProjectsFromStorage();
      const threads = JSON.parse(localStorage.getItem('threadsync_threads') || '{}');
      const threadsArray = Object.values(threads);
      
      // Técnicos en campo (proyectos activos = técnicos asignados)
      const activeProjects = projects.filter(p => p.status === 'active');
      const techniciansInField = activeProjects.length;
      const techEl = document.getElementById('kpi-technicians');
      const techDetailEl = document.getElementById('kpi-technicians-detail');
      if (techEl) {
        techEl.textContent = techniciansInField;
        techDetailEl.textContent = techniciansInField > 0 ? `${techniciansInField} equipos activos` : 'Sin asignaciones';
        techDetailEl.className = 'stat-change ' + (techniciansInField > 0 ? 'positive' : 'neutral');
      }
      
      // Servicios programados hoy
      const today = new Date().toISOString().split('T')[0];
      const servicesToday = projects.filter(p => {
        if (!p.startDate) return false;
        return p.startDate === today || (p.status === 'active');
      }).length;
      const servicesEl = document.getElementById('kpi-services-today');
      const servicesDetailEl = document.getElementById('kpi-services-detail');
      if (servicesEl) {
        servicesEl.textContent = servicesToday;
        const completed = projects.filter(p => p.status === 'completed').length;
        servicesDetailEl.textContent = `${completed} completados este mes`;
        servicesDetailEl.className = 'stat-change positive';
      }
      
      // Pendientes urgentes (threads sin leer + proyectos scheduled)
      const unreadThreads = threadsArray.filter(t => !t.isRead && !t.isArchived).length;
      const scheduled = projects.filter(p => p.status === 'scheduled').length;
      const urgentCount = unreadThreads + scheduled;
      const urgentEl = document.getElementById('kpi-urgent');
      const urgentDetailEl = document.getElementById('kpi-urgent-detail');
      if (urgentEl) {
        urgentEl.textContent = urgentCount;
        urgentDetailEl.textContent = urgentCount > 0 ? `${unreadThreads} mensajes, ${scheduled} pendientes` : '✓ Todo al día';
        urgentDetailEl.className = 'stat-change ' + (urgentCount === 0 ? 'positive' : urgentCount > 5 ? 'negative' : 'neutral');
      }
      
      // Tiempo de respuesta promedio (simulado basado en proyectos)
      const avgResponseHours = activeProjects.length > 0 ? Math.max(1.5, 4 - activeProjects.length * 0.3) : 2.0;
      const responseEl = document.getElementById('kpi-response-time');
      const responseDetailEl = document.getElementById('kpi-response-detail');
      if (responseEl) {
        responseEl.textContent = avgResponseHours.toFixed(1) + 'h';
        responseDetailEl.textContent = avgResponseHours <= 2 ? '↑ Excelente' : avgResponseHours <= 4 ? '→ Normal' : '↓ Revisar';
        responseDetailEl.className = 'stat-change ' + (avgResponseHours <= 2 ? 'positive' : avgResponseHours <= 4 ? 'neutral' : 'negative');
      }
      
      console.log('📊 KPIs operacionales actualizados');
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      updateDashboardDate();
      updateDashboardCounters();
      updateThreadCounters();
      updateOperationalKPIs();
    });
    
    // Update counters when page becomes visible (user returns from another page)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        updateDashboardDate();
        updateDashboardCounters();
        updateThreadCounters();
        updateOperationalKPIs();
        console.log('🔄 Page visible - counters refreshed');
      }
    });
    
    // Also update on window focus (when switching back to this tab)
    window.addEventListener('focus', () => {
      updateDashboardDate();
      updateDashboardCounters();
      updateThreadCounters();
      updateOperationalKPIs();
      console.log('🔄 Window focused - counters refreshed');
    });

    // Mapa real con Leaflet + OpenStreetMap (100% gratuito)
    let currentMapFilter = 'all';
    let map = null;
    let markers = [];

    // projectsData removed - using localStorage

    const statusColors = {
      active: '#10b981',
      scheduled: '#f97316',
      completed: '#3b82f6',
      cancelled: '#ef4444'
    };

    const statusLabels = {
      active: 'Activo',
      scheduled: 'Programado',
      completed: 'Completado',
      cancelled: 'Cancelado'
    };

    function initializeProjectsMap() {
      // Determinar cuál contenedor de mapa usar
      let mapContainerId = 'projects-map';
      const activeTab = document.querySelector('[data-projectsync-tab].active');
      
      if (activeTab && activeTab.dataset.projectsyncTab === 'projects') {
        mapContainerId = 'projects-map-projects';
      }
      
      const mapContainer = document.getElementById(mapContainerId);
      if (!mapContainer) return;

      if (map) {
        // Si el mapa ya existe, solo actualizar tamaño
        map.invalidateSize();
        updateMapMarkers();
        return;
      }

      // Crear mapa en el contenedor activo
      map = L.map(mapContainerId).setView([32.7157, -117.1611], 12);

      // Añadir capa de OpenStreetMap
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(map);

      updateMapMarkers();

      // Configurar filtros
      const filterButtons = document.querySelectorAll('[data-map-filter], [data-project-filter]');
      filterButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          // Obtener el grupo de filtros hermanos
          const filterGroup = e.target.closest('.map-filter-group') || e.target.parentElement;
          const siblingFilters = filterGroup.querySelectorAll('.chip-filter');
          
          siblingFilters.forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          currentMapFilter = e.target.dataset.mapFilter || e.target.dataset.projectFilter;
          updateMapVisibility();
        });
      });

      // Ajustar tamaño después de cargar
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    }

    function updateMapMarkers() {
      if (!map) return;
      
      // Clear existing markers
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
      
      const projects = loadProjectsFromStorage();
      
      // Crear marcadores
      projects.forEach(project => {
        // Generate random coordinates around San Diego if not present
        const lat = project.lat || (32.7157 + (Math.random() - 0.5) * 0.1);
        const lng = project.lng || (-117.1611 + (Math.random() - 0.5) * 0.1);
        
        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="
            width: 36px;
            height: 36px;
            background: ${statusColors[project.status] || '#94a3b8'};
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            overflow: hidden;
            white-space: nowrap;
          " data-status="${project.status}">${project.id.replace('ORD-', '')}</div>`,
          iconSize: [36, 36],
          iconAnchor: [18, 18]
        });

        const marker = L.marker([lat, lng], { icon: icon })
          .bindPopup(`
            <div style="font-size: 12px; min-width: 150px;">
              <strong style="font-size: 13px;">${project.name}</strong><br/>
              <span style="color: #64748b;">Cliente: ${project.client}</span><br/>
              <span style="display: inline-block; margin-top: 6px; padding: 3px 8px; border-radius: 4px; background: ${(statusColors[project.status] || '#94a3b8')}22; color: ${statusColors[project.status] || '#94a3b8'}; font-weight: 600; font-size: 10px;">
                ${statusLabels[project.status] || project.status}
              </span>
            </div>
          `)
          .addTo(map);

        marker.projectData = project;
        markers.push(marker);
      });
      
      updateMapVisibility();
    }

    function updateMapVisibility() {
      markers.forEach(marker => {
        const status = marker.projectData.status;
        const shouldShow = currentMapFilter === 'all' || currentMapFilter === status;
        
        if (shouldShow) {
          marker.setOpacity(1);
        } else {
          marker.setOpacity(0.3);
        }
      });
    }

    // ========================================
    // THREADSYNC FUNCTIONS
    // ========================================
    
    function createNewThread() {
      // Abrir modal de selección de proyecto
      document.getElementById('newThreadModal').style.display = 'block';
    }

    function closeNewThreadModal() {
      document.getElementById('newThreadModal').style.display = 'none';
    }

    function selectProjectForThread(projectId, projectName) {
      // Cerrar modal
      closeNewThreadModal();
      
      // Confirmar y redirigir
      const confirmMessage = `Crear nuevo thread para:\n\n${projectName}\n\n¿Continuar?`;
      if (confirm(confirmMessage)) {
        window.location.href = `threadsync.html?action=new&project=${projectId}&name=${encodeURIComponent(projectName)}`;
      }
    }

    // Cerrar modal al hacer clic fuera
    window.onclick = function(event) {
      const modal = document.getElementById('newThreadModal');
      if (event.target === modal) {
        closeNewThreadModal();
      }
    }
    
    function toggleThreadGroup(projectId) {
      const container = document.getElementById('threads-' + projectId);
      const projectGroup = container.closest('.thread-project-group');
      const isVisible = container.style.display !== 'none';
      
      container.style.display = isVisible ? 'none' : 'block';
      
      if (projectGroup) {
        if (isVisible) {
          projectGroup.classList.remove('expanded');
        } else {
          projectGroup.classList.add('expanded');
        }
      }
    }

    function expandProject(projectId) {
      toggleThreadGroup(projectId);
    }

    function openThread(threadId) {
      // Redirigir a la página de detalle del thread
      window.location.href = `threadsync.html?id=${threadId}`;
    }

    function createNewThread() {
      // Abrir modal de selección o redirigir a crear thread
      window.location.href = 'threadsync.html?action=new';
    }

    function goToProject(projectId, isActive) {
      if (isActive) {
        // Si el proyecto ya está activo, ir directamente
        window.location.href = `motorsync.html?project=${projectId}&tab=project`;
      } else {
        // Si no está activo, pedir confirmación
        const confirmMessage = '¿Activar este proyecto?\n\nEsto te llevará a la vista del proyecto en ProjectSync.';
        if (confirm(confirmMessage)) {
          // Simular activación del proyecto
          alert(`✓ Proyecto activado correctamente\n\nRedirigiendo a ProjectSync...`);
          window.location.href = `motorsync.html?project=${projectId}&tab=project&action=activate`;
        }
      }
    }

    function createThreadForProject(projectId) {
      // Crear thread para un proyecto específico
      window.location.href = `threadsync.html?action=new&project=${projectId}`;
    }

    function archiveThread(threadId) {
      if (confirm('¿Archivar este thread?\n\nPodrás encontrarlo en la sección de Archivados.')) {
        // En producción, esto haría una llamada a la API
        alert(`✓ Thread ${threadId} archivado correctamente`);
        // Aquí recargarías la lista
      }
    }

    function refreshThreads() {
      const btn = event.target.closest('button');
      const icon = btn.querySelector('svg');
      
      // Add rotation animation
      icon.style.transition = 'transform 0.6s ease';
      icon.style.transform = 'rotate(360deg)';
      
      // Simulate refresh
      setTimeout(() => {
        icon.style.transform = 'rotate(0deg)';
      }, 600);
    }

    function showThreadFilters() {
      alert('Filtros de Hilos\n\n- Por proyecto\n- Por autor\n- Por fecha\n- Con archivos\n- Con menciones\n- Estado (activo/archivado)');
    }

    // Hover effects para hilos
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const threadItems = document.querySelectorAll('.thread-item');
        threadItems.forEach(item => {
          item.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(4px)';
            this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
          });
          item.addEventListener('mouseleave', function() {
            this.style.transform = 'translateX(0)';
            this.style.boxShadow = 'none';
          });
        });
      }, 500);
    });

    // ========================================
    // PROJECT ACTIONS & MODALS
    // ========================================

    // Toggle dropdown menu de acciones
    function toggleProjectActions(projectId) {
      const menu = document.getElementById('actions-' + projectId);
      const allMenus = document.querySelectorAll('.project-actions-menu');
      
      // Cerrar todos los otros menús
      allMenus.forEach(m => {
        if (m.id !== 'actions-' + projectId) {
          m.style.display = 'none';
        }
      });
      
      // Toggle el menú actual
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    // Cerrar menús al hacer click fuera
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.project-actions-dropdown')) {
        document.querySelectorAll('.project-actions-menu').forEach(m => {
          m.style.display = 'none';
        });
      }
    });

    // Abrir modal de detalles del proyecto
    function openProjectDetail(projectId) {
      // Cerrar menú
      document.getElementById('actions-' + projectId).style.display = 'none';
      
      // Redirigir a ViewSync - Portal del proyecto
      console.log('Abriendo ViewSync para proyecto:', projectId);
      window.location.href = `viewsync.html?id=${projectId}`;
    }

    function closeProjectDetail() {
      document.getElementById('projectDetailModal').style.display = 'none';
    }

    function switchModalTab(tab) {
      // Actualizar tabs
      const infoTab = document.getElementById('modal-tab-info');
      const threadsTab = document.getElementById('modal-tab-threads');
      const infoContent = document.getElementById('modal-content-info');
      const threadsContent = document.getElementById('modal-content-threads');
      
      if (tab === 'info') {
        infoTab.className = 'modal-tab-active';
        infoTab.style.color = '#02735E';
        infoTab.style.borderBottom = '2px solid #02735E';
        threadsTab.className = '';
        threadsTab.style.color = '#64748b';
        threadsTab.style.borderBottom = '2px solid transparent';
        infoContent.style.display = 'block';
        threadsContent.style.display = 'none';
      } else {
        threadsTab.className = 'modal-tab-active';
        threadsTab.style.color = '#02735E';
        threadsTab.style.borderBottom = '2px solid #02735E';
        infoTab.className = '';
        infoTab.style.color = '#64748b';
        infoTab.style.borderBottom = '2px solid transparent';
        threadsContent.style.display = 'block';
        infoContent.style.display = 'none';
      }
    }

    function loadProjectData(projectId) {
      // Aquí cargarías los datos reales del proyecto
      // Por ahora es solo un ejemplo
      console.log('Cargando datos del proyecto:', projectId);
    }

    // Abrir modal de edición
    function openEditProject(projectId) {
      // Cerrar menú
      document.getElementById('actions-' + projectId).style.display = 'none';
      
      const modal = document.getElementById('editProjectModal');
      modal.style.display = 'block';
      
      // Cargar datos del proyecto para editar
      // En producción vendría de API
      console.log('Editando proyecto:', projectId);
    }

    function closeEditProject() {
      document.getElementById('editProjectModal').style.display = 'none';
    }

    // Manejar submit del formulario de edición
    document.addEventListener('DOMContentLoaded', () => {
      const editForm = document.getElementById('editProjectForm');
      if (editForm) {
        editForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          // Recoger datos del formulario
          const formData = {
            name: document.getElementById('edit-project-name').value,
            client: document.getElementById('edit-project-client').value,
            address: document.getElementById('edit-project-address').value,
            startDate: document.getElementById('edit-project-start').value,
            endDate: document.getElementById('edit-project-end').value,
            amount: document.getElementById('edit-project-amount').value,
            status: document.getElementById('edit-project-status').value,
            progress: document.getElementById('edit-project-progress').value,
            team: document.getElementById('edit-project-team').value,
            contract: document.getElementById('edit-project-contract').value,
            notes: document.getElementById('edit-project-notes').value
          };
          
          // Aquí enviarías los datos al servidor
          console.log('Guardando cambios:', formData);
          
          // Mostrar mensaje de éxito
          alert('Proyecto actualizado exitosamente');
          
          // Cerrar modal
          closeEditProject();
          
          // Recargar datos de la tabla
          // location.reload();
        });
      }
    });

    // Duplicar proyecto
    function duplicateProject(projectId) {
      // Cerrar menú
      document.getElementById('actions-' + projectId).style.display = 'none';
      
      if (confirm('¿Estás seguro de que deseas duplicar este proyecto?')) {
        console.log('Duplicando proyecto:', projectId);
        // Aquí llamarías a la API para duplicar
        alert('Proyecto duplicado exitosamente');
        // location.reload();
      }
    }

    // Pausar proyecto
    function pauseProject(projectId) {
      // Cerrar menú
      document.getElementById('actions-' + projectId).style.display = 'none';
      
      if (confirm('¿Deseas pausar este proyecto?')) {
        console.log('Pausando proyecto:', projectId);
        // Aquí llamarías a la API
        alert('Proyecto pausado');
        // Actualizar estado en la tabla
      }
    }

    // Cancelar proyecto
    function cancelProject(projectId) {
      // Cerrar menú
      document.getElementById('actions-' + projectId).style.display = 'none';
      
      if (confirm('⚠️ ¿Estás seguro de que deseas CANCELAR este proyecto?\n\nEsta acción no se puede deshacer.')) {
        console.log('Cancelando proyecto:', projectId);
        // Aquí llamarías a la API
        alert('Proyecto cancelado');
        // Actualizar estado en la tabla
      }
    }

    // Cerrar modales al presionar ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeProjectDetail();
        closeEditProject();
      }
    });

    // ========================================
    // FUNCIONES DE AGENDA - EVENTOS CLICKEABLES
    // ========================================
    
    // Abrir detalle de cita/evento → Redirigir a ViewSync
    function openEventDetail(eventData) {
      console.log('Abriendo ViewSync - Portal del proyecto:', eventData);
      // Redirigir a la página ViewSync
      window.location.href = 'viewsync.html';
    }

    // Hacer clickeables los eventos del calendario del mes
    document.addEventListener('DOMContentLoaded', function() {
      // Esperar a que se cargue todo el contenido
      setTimeout(() => {
        // Seleccionar todos los eventos en el calendario del mes
        const monthEvents = document.querySelectorAll('[data-agenda-view-content="month"] [style*="background: #02735E"], [data-agenda-view-content="month"] [style*="background: #eab308"], [data-agenda-view-content="month"] [style*="background: #3b82f6"]');
        
        monthEvents.forEach(event => {
          event.style.cursor = 'pointer';
          event.style.transition = 'all 0.2s ease';
          
          event.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
            this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
          });
          
          event.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.boxShadow = 'none';
          });
          
          event.addEventListener('click', function() {
            const eventText = this.textContent.trim();
            openEventDetail({
              service: eventText,
              date: 'Nov 2025',
              status: 'Programado'
            });
          });
        });

        // Hacer clickeables los eventos en la vista de SEMANA
        const weekEvents = document.querySelectorAll('[data-agenda-view-content="week"] td[style*="background: rgba"]');
        
        weekEvents.forEach(cell => {
          if (cell.querySelector('small')) {
            cell.style.cursor = 'pointer';
            cell.style.transition = 'all 0.2s ease';
            
            cell.addEventListener('mouseenter', function() {
              this.style.transform = 'scale(1.02)';
              this.style.opacity = '0.9';
            });
            
            cell.addEventListener('mouseleave', function() {
              this.style.transform = 'scale(1)';
              this.style.opacity = '1';
            });
            
            cell.addEventListener('click', function() {
              const eventText = this.textContent.trim();
              openEventDetail({
                service: eventText,
                status: 'Programado'
              });
            });
          }
        });

        // Hacer clickeables los botones "Ver" en la vista LISTA
        const viewButtons = document.querySelectorAll('[data-agenda-view-content="list"] .btn-secondary');
        
        viewButtons.forEach(btn => {
          btn.addEventListener('click', function() {
            const row = this.closest('tr');
            const cells = row.querySelectorAll('td');
            
            openEventDetail({
              date: cells[0]?.textContent.trim(),
              time: cells[1]?.textContent.trim(),
              service: cells[2]?.textContent.trim(),
              client: cells[3]?.textContent.trim(),
              location: cells[4]?.textContent.trim(),
              crew: cells[5]?.textContent.trim(),
              status: cells[6]?.textContent.trim()
            });
          });
        });
      }, 500);
    });

    // ========================================
    // FILTROS DE TABLA DE PROYECTOS
    // ========================================
    
    // Configurar filtros de estado para la tabla de proyectos
    document.addEventListener('DOMContentLoaded', function() {
      const statusFilterButtons = document.querySelectorAll('[data-project-status-filter]');
      
      statusFilterButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
          const filterValue = e.target.dataset.projectStatusFilter;
          
          // Actualizar botones activos
          statusFilterButtons.forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          
          // Filtrar filas de la tabla
          const tableRows = document.querySelectorAll('tbody tr[data-order-id]');
          
          tableRows.forEach(row => {
            // Obtener el estado de la fila
            const statusBadge = row.querySelector('.badge');
            if (!statusBadge) return;
            
            const statusText = statusBadge.textContent.trim().toUpperCase();
            let rowStatus = 'active'; // por defecto
            
            // Mapear el texto del badge al estado
            if (statusText.includes('CURSO') || statusText.includes('ACTIVO')) {
              rowStatus = 'active';
            } else if (statusText.includes('PROGRAMADO') || statusText.includes('PENDIENTE')) {
              rowStatus = 'scheduled';
            } else if (statusText.includes('COMPLETADO') || statusText.includes('FINALIZADO')) {
              rowStatus = 'completed';
            } else if (statusText.includes('CANCELADO')) {
              rowStatus = 'cancelled';
            } else if (statusText.includes('PAUSADO')) {
              rowStatus = 'paused';
            }
            
            // Mostrar/ocultar según el filtro
            if (filterValue === 'all' || filterValue === rowStatus) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
        });
      });
    });

    // ===== AGENDA VIEW FILTERS =====
    document.addEventListener('DOMContentLoaded', () => {
      const agendaViewButtons = document.querySelectorAll('[data-agenda-view]');
      const agendaViews = document.querySelectorAll('[data-agenda-view-content]');
      
      agendaViewButtons.forEach(button => {
        button.addEventListener('click', () => {
          const viewType = button.dataset.agendaView;
          
          // Actualizar botones activos
          agendaViewButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          // Mostrar la vista correspondiente
          agendaViews.forEach(view => {
            if (view.dataset.agendaViewContent === viewType) {
              view.style.display = 'block';
            } else {
              view.style.display = 'none';
            }
          });
        });
      });
    });

    // ========================================
    // MODAL DE SELECCIÓN: PROYECTO vs THREADSYNC
    // ========================================
    function showNewItemModal() {
      const modalHTML = `
        <div class="modal-overlay" id="selectionModal" onclick="if(event.target === this) closeMotorModal('selectionModal')" style="z-index: 2000;">
          <div class="selection-modal">
            <h2 class="selection-title">¿Qué deseas crear?</h2>
            <p class="selection-subtitle">Selecciona el tipo de registro que quieres agregar</p>
            
            <div class="selection-options">
              <div class="selection-option" onclick="openNewProjectModal()">
                <div class="selection-option-header">
                  <div class="selection-option-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                      <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                  </div>
                  <div class="selection-option-title">Proyecto Confirmado</div>
                </div>
                <p class="selection-option-description">
                  Cliente confirmó el proyecto. Agregar directamente a la programación con fechas, equipo y presupuesto.
                </p>
              </div>
              
              <div class="selection-option" onclick="openNewThreadModal()">
                <div class="selection-option-header">
                  <div class="selection-option-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                  </div>
                  <div class="selection-option-title">ThreadSync (Seguimiento)</div>
                </div>
                <p class="selection-option-description">
                  Oportunidad o cotización en proceso. Dar seguimiento hasta que el cliente confirme para convertir en proyecto.
                </p>
              </div>
            </div>
            
            <button class="btn btn-secondary" style="width: 100%; margin-top: 24px;" onclick="closeMotorModal('selectionModal')">
              Cancelar
            </button>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function closeMotorModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.animation = 'fadeOut 0.2s ease-out';
        setTimeout(() => modal.remove(), 200);
      }
    }

    function openNewProjectModal() {
      closeMotorModal('selectionModal');
      // Redirigir al formulario de proyecto real
      window.location.href = 'project-form.html';
    }

    function openNewThreadModal() {
      closeMotorModal('selectionModal');
      // Redirigir a la página de ThreadSync para crear nuevo
      window.location.href = 'threadsync-list.html';
    }
  </script>

  <script>
    // ===================================
    // MODULE TABS DYNAMIC LOADER
    // ===================================
    // Este sistema permite que las pestañas de módulos se carguen dinámicamente
    // según los módulos habilitados para la compañía en Supabase
    
    const MODULE_REGISTRY = {
      motorsync: {
        name: 'MotorSync',
        url: 'motorsync.html',
        order: 1,
        enabled: true // Siempre habilitado (módulo base)
      },
      timesync: {
        name: 'TimeSync',
        url: '../timesync/timesync.html',
        order: 2,
        enabled: true // Habilitado por defecto
      },
      projectsync: {
        name: 'ProjectSync',
        url: 'projectsync.html',
        order: 3,
        enabled: false // Se habilita cuando la compañía hace upgrade
      },
      toolsync: {
        name: 'ToolSync',
        url: '../toolsync/inventory.html',
        order: 4,
        enabled: false
      },
      humansync: {
        name: 'HumanSync',
        url: '../humansync/dashboard.html',
        order: 5,
        enabled: false
      },
      financesync: {
        name: 'FinanceSync',
        url: '../financesync/dashboard.html',
        order: 6,
        enabled: false
      }
    };

    // Función para renderizar las pestañas dinámicamente
    function renderModuleTabs() {
      const container = document.getElementById('module-tabs-container');
      if (!container) return;

      // Limpiar pestañas existentes
      container.innerHTML = '';

      // Obtener módulos habilitados y ordenarlos
      const enabledModules = Object.entries(MODULE_REGISTRY)
        .filter(([key, module]) => module.enabled)
        .sort((a, b) => a[1].order - b[1].order);

      // Obtener la URL actual para marcar la pestaña activa
      const currentPath = window.location.pathname;

      // Crear pestañas
      enabledModules.forEach(([key, module]) => {
        // Si estamos en la carpeta motorsync/, marcar MotorSync como activo
        const isActive = (key === 'motorsync' && currentPath.includes('/motorsync/')) ||
                       currentPath.endsWith(module.url);
        
        const tab = document.createElement('a');
        tab.href = module.url;
        tab.className = `module-tab${isActive ? ' active' : ''}`;
        tab.textContent = module.name;
        
        container.appendChild(tab);
      });
    }

    // Función para habilitar un nuevo módulo (cuando la compañía hace upgrade)
    function enableModule(moduleKey) {
      if (MODULE_REGISTRY[moduleKey]) {
        MODULE_REGISTRY[moduleKey].enabled = true;
        renderModuleTabs();
        
        // Aquí se conectaría con Supabase para persistir el cambio
        console.log(`✅ Módulo ${moduleKey} habilitado`);
      }
    }

    // Función para deshabilitar un módulo
    function disableModule(moduleKey) {
      if (MODULE_REGISTRY[moduleKey] && moduleKey !== 'motorsync') {
        MODULE_REGISTRY[moduleKey].enabled = false;
        renderModuleTabs();
        console.log(`❌ Módulo ${moduleKey} deshabilitado`);
      }
    }

    // Cargar las pestañas cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', renderModuleTabs);
    } else {
        renderModuleTabs();
    }

    // En producción, esto se conectaría con Supabase para obtener
    // los módulos habilitados desde la base de datos:
    /*
    async function loadCompanyModules() {
      const { data, error } = await supabase
        .from('company_modules')
        .select('module_key')
        .eq('company_id', currentCompanyId)
        .eq('enabled', true);
      
      if (data) {
        data.forEach(row => {
          if (MODULE_REGISTRY[row.module_key]) {
            MODULE_REGISTRY[row.module_key].enabled = true;
          }
        });
        renderModuleTabs();
      }
    }
    */

    // Guardar la ruta actual antes de abrir HowSync para regresar de forma inteligente
    document.addEventListener('DOMContentLoaded', () => {
      const howSyncLinks = document.querySelectorAll('a[href="howsync.html"]');
      if (!howSyncLinks.length) return;

      howSyncLinks.forEach(link => {
        link.addEventListener('click', () => {
          sessionStorage.setItem('lastHowSyncReferrer', window.location.href);
        });
      });
    });

    // ========================================================================
    // SISTEMA DINÁMICO DE ESTADÍSTICAS DEL DASHBOARD
    // ========================================================================
    function calculateProjectStats() {
      const projectsData = JSON.parse(localStorage.getItem('projectsync_projects') || '{}');
      const projects = Object.values(projectsData);
      
      const total = projects.length;
      const active = projects.filter(p => p.status === 'active').length;
      const inProgress = projects.filter(p => p.status === 'in-progress').length;
      const completed = projects.filter(p => p.status === 'completed').length;
      const scheduled = projects.filter(p => p.status === 'scheduled').length;
      
      // Actualizar KPIs de Overview
      const totalEl = document.getElementById('stat-total-projects');
      const activeEl = document.getElementById('stat-active-projects');
      const inProgressEl = document.getElementById('stat-in-progress');
      const inProgressChangeEl = document.getElementById('stat-in-progress-change');
      const completedEl = document.getElementById('stat-completed');
      const scheduledEl = document.getElementById('stat-scheduled');
      
      if (totalEl) totalEl.textContent = total;
      if (activeEl) activeEl.textContent = `${active} activos`;
      if (inProgressEl) inProgressEl.textContent = inProgress;
      if (inProgressChangeEl) inProgressChangeEl.textContent = inProgress > 0 ? `↑ ${inProgress} activos` : '--';
      if (completedEl) completedEl.textContent = completed;
      if (scheduledEl) scheduledEl.textContent = scheduled;
      
      return { total, active, inProgress, completed, scheduled, projects };
    }
    
    function calculateAgendaStats() {
      const appointmentsData = JSON.parse(localStorage.getItem('projectsync_appointments') || '{}');
      const appointments = Object.values(appointmentsData);
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayTime = today.getTime();
      const weekTime = todayTime + (7 * 24 * 60 * 60 * 1000);
      
      const apptToday = appointments.filter(a => {
        if (!a.date) return false;
        const apptDate = new Date(a.date);
        apptDate.setHours(0, 0, 0, 0);
        return apptDate.getTime() === todayTime;
      }).length;
      
      const apptWeek = appointments.filter(a => {
        if (!a.date) return false;
        const apptDate = new Date(a.date);
        return apptDate >= today && apptDate <= new Date(weekTime);
      }).length;
      
      const pending = appointments.filter(a => a.status === 'pending').length;
      
      // Actualizar KPIs de Agenda
      const todayEl = document.getElementById('stat-appts-today');
      const weekEl = document.getElementById('stat-appts-week');
      const next7El = document.getElementById('stat-appts-next7');
      const pendingEl = document.getElementById('stat-appts-pending');
      
      if (todayEl) todayEl.textContent = apptToday;
      if (weekEl) weekEl.textContent = apptWeek;
      if (next7El) next7El.textContent = apptWeek;
      if (pendingEl) pendingEl.textContent = pending;
      
      return { apptToday, apptWeek, pending, appointments };
    }
    
    function renderOverviewProjectsTable() {
      const tbody = document.getElementById('overview-projects-tbody');
      if (!tbody) return;
      
      const projectsData = JSON.parse(localStorage.getItem('projectsync_projects') || '{}');
      const projects = Object.values(projectsData).slice(0, 10); // Mostrar solo 10
      
      if (projects.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #94a3b8;">No hay proyectos aún. <a href="projectsync.html" style="color: #02735E;">Crea tu primer proyecto</a></td></tr>';
        return;
      }
      
      tbody.innerHTML = projects.map(project => {
        const statusColors = {
          'active': 'rgba(2, 115, 94, 0.1); color: #02735E',
          'in-progress': 'rgba(2, 115, 94, 0.1); color: #02735E',
          'scheduled': 'rgba(234, 179, 8, 0.1); color: #eab308',
          'completed': 'rgba(5, 150, 105, 0.1); color: #059669',
          'cancelled': 'rgba(239, 68, 68, 0.1); color: #ef4444'
        };
        const statusText = {
          'active': 'ACTIVO',
          'in-progress': 'EN CURSO',
          'scheduled': 'PROGRAMADO',
          'completed': 'COMPLETADO',
          'cancelled': 'CANCELADO'
        };
        
        return `
          <tr data-order-id="${project.id}">
            <td>
              <strong>${project.idSync || '────────'}</strong>
              <p style="font-size: 12px; color: #94a3b8; margin: 4px 0 0 0;">${project.id}</p>
            </td>
            <td>
              <strong>${project.name || 'Sin nombre'}</strong>
              <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">${project.address || ''}</p>
            </td>
            <td>${project.client || 'Sin cliente'}</td>
            <td><span class="badge" style="background: ${statusColors[project.status] || statusColors.active}; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">${statusText[project.status] || 'ACTIVO'}</span></td>
            <td>${project.startDate || '--'}</td>
            <td>${project.endDate || '--'}</td>
            <td><strong>$${project.amount ? project.amount.toLocaleString() : '0'}</strong></td>
            <td>
              <div style="width: 100%;">
                <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                  <div style="background: linear-gradient(135deg, #02735E, #035951); width: ${project.progress || 0}%; height: 100%;"></div>
                </div>
                <p style="font-size: 11px; color: #64748b; margin: 4px 0 0 0;">${project.progress || 0}%</p>
              </div>
            </td>
            <td>
              <button class="btn btn-small" style="background: #035951; color: white;" onclick="window.location.href='threadsync.html?project=${project.id}'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
              </button>
            </td>
            <td>
              <button class="btn btn-small btn-secondary" onclick="window.location.href='viewsync.html?id=${project.id}'">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function renderAgendaAppointmentsTable() {
      const tbody = document.getElementById('agenda-appointments-tbody');
      if (!tbody) return;
      
      const appointmentsData = JSON.parse(localStorage.getItem('projectsync_appointments') || '{}');
      const appointments = Object.values(appointmentsData).slice(0, 10);
      
      if (appointments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #94a3b8;">No hay citas agendadas. <a href="plansync.html" style="color: #02735E;">Agenda tu primera cita</a></td></tr>';
        return;
      }
      
      tbody.innerHTML = appointments.map(appt => {
        const statusColors = {
          'confirmed': 'rgba(2,115,94,0.1); color: #02735E',
          'pending': 'rgba(234,179,8,0.1); color: #eab308',
          'en-route': 'rgba(59,130,246,0.1); color: #3b82f6',
          'completed': 'rgba(5,150,105,0.1); color: #059669'
        };
        const statusText = {
          'confirmed': 'Confirmado',
          'pending': 'Pendiente',
          'en-route': 'En ruta',
          'completed': 'Completado'
        };
        
        const apptDate = appt.date ? new Date(appt.date) : new Date();
        const dateStr = apptDate.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
        
        return `
          <tr>
            <td><strong>${dateStr}</strong></td>
            <td>${appt.time || '--'}</td>
            <td>${appt.title || appt.service || 'Sin descripción'}</td>
            <td>${appt.client || 'Sin cliente'}</td>
            <td>${appt.location || appt.address || 'Sin ubicación'}</td>
            <td>${appt.crew || 'Sin asignar'}</td>
            <td><span class="badge" style="background: ${statusColors[appt.status] || statusColors.pending}">${statusText[appt.status] || 'Pendiente'}</span></td>
            <td><button class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;" onclick="window.location.href='plansync.html?id=${appt.id}'">Ver</button></td>
          </tr>
        `;
      }).join('');
    }
    
    // Inicializar al cargar el dashboard
    document.addEventListener('DOMContentLoaded', () => {
      // Solo ejecutar si estamos en motorsync.html (dashboard principal)
      if (window.location.pathname.includes('motorsync.html')) {
        console.log('🔄 Cargando estadísticas dinámicas del dashboard...');
        calculateProjectStats();
        calculateAgendaStats();
        renderOverviewProjectsTable();
        renderAgendaAppointmentsTable();
        console.log('✅ Dashboard actualizado con datos reales de localStorage');
      }
    });
  </script>

  <!-- ==================== CUSTOMERS MANAGEMENT ==================== -->
  <script>
    // Customers localStorage key
    const CUSTOMERS_KEY = 'motorsync_customers';

    // Initialize demo customers if none exist (based on Opsis Plumbing structure)
    function initializeDemoCustomers() {
      let customers = JSON.parse(localStorage.getItem(CUSTOMERS_KEY) || '[]');
      if (customers.length === 0) {
        const now = new Date().toISOString();
        customers = [
          {
            id: 'cus-001',
            name: 'Constructora Atlas',
            phone: '+52 55 6789 4321',
            email: 'contacto@atlas.mx',
            address_text: 'Av. Reforma 123, CDMX',
            tags: ['B2B', 'VIP'],
            type: 'commercial',
            projects: [],
            totalSpent: 186500,
            lastService: '2025-01-10',
            satisfaction: 4.9,
            created_at: now
          },
          {
            id: 'cus-002',
            name: 'Residencial Alameda',
            phone: '+52 55 1357 2468',
            email: 'admin@alameda.mx',
            address_text: 'Calle 5 #88, Naucalpan',
            tags: ['Residencial', 'Recurrente'],
            type: 'residential',
            projects: [],
            totalSpent: 75000,
            lastService: '2025-01-08',
            satisfaction: 4.7,
            created_at: now
          },
          {
            id: 'cus-003',
            name: 'Fabricas Arali',
            phone: '+52 722 555 9988',
            email: 'mantenimiento@arali.mx',
            address_text: 'Parque Industrial 45, Toluca',
            tags: ['Industrial', 'B2B'],
            type: 'commercial',
            projects: [],
            totalSpent: 320000,
            lastService: '2025-01-05',
            satisfaction: 4.8,
            created_at: now
          },
          {
            id: 'cus-004',
            name: 'Hotel Aurora',
            phone: '+52 998 222 4411',
            email: 'ops@aurora.mx',
            address_text: 'Zona Hotelera, Cancún',
            tags: ['Hotel', 'VIP', 'Urgencias'],
            type: 'commercial',
            projects: [],
            totalSpent: 560000,
            lastService: '2025-01-12',
            satisfaction: 5.0,
            created_at: now
          },
          {
            id: 'cus-005',
            name: 'Colegio Faro',
            phone: '+52 442 777 8899',
            email: 'compras@faro.mx',
            address_text: 'Av. Universidad 2000, Querétaro',
            tags: ['Educación', 'Gubernamental'],
            type: 'commercial',
            projects: [],
            totalSpent: 28000,
            lastService: '2025-01-03',
            satisfaction: 4.6,
            created_at: now
          },
          {
            id: 'cus-006',
            name: 'Residencial Torres',
            phone: '+52 33 1234 5678',
            email: 'ops@torres.com',
            address_text: 'Av. Vallarta 2020, Guadalajara, JAL',
            tags: ['Residencial', 'Premium'],
            type: 'residential',
            projects: [],
            totalSpent: 124500,
            lastService: '2025-01-11',
            satisfaction: 4.9,
            created_at: now
          }
        ];
        localStorage.setItem(CUSTOMERS_KEY, JSON.stringify(customers));
      }
      return customers;
    }

    // Get all customers
    function getCustomers() {
      return JSON.parse(localStorage.getItem(CUSTOMERS_KEY) || '[]');
    }

    // Save customers
    function saveCustomers(customers) {
      localStorage.setItem(CUSTOMERS_KEY, JSON.stringify(customers));
    }

    // Add new customer (improved structure from Opsis Plumbing)
    function addCustomer(customerData) {
      const customers = getCustomers();
      const newId = `cus-${String(customers.length + 1).padStart(3, '0')}`;
      const newCustomer = {
        id: newId,
        name: customerData.name,
        phone: customerData.phone || null,
        email: customerData.email || null,
        address_text: customerData.address_text || null,
        tags: customerData.tags || [],
        type: customerData.type || 'residential',
        projects: [],
        totalSpent: 0,
        satisfaction: 0,
        created_at: new Date().toISOString()
      };
      customers.push(newCustomer);
      saveCustomers(customers);
      return newCustomer;
    }

    // Update customer
    function updateCustomer(customerId, updates) {
      const customers = getCustomers();
      const index = customers.findIndex(c => c.id === customerId);
      if (index !== -1) {
        customers[index] = { ...customers[index], ...updates };
        saveCustomers(customers);
        return customers[index];
      }
      return null;
    }

    // Delete customer
    function deleteCustomer(customerId) {
      const customers = getCustomers();
      const filtered = customers.filter(c => c.id !== customerId);
      saveCustomers(filtered);
    }

    // Render customers table (improved with Opsis Plumbing design)
    function renderCustomersTable() {
      const customers = getCustomers();
      const tbody = document.querySelector('#page-customers table tbody');
      if (!tbody) return;

      if (customers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">No hay clientes registrados. Haz clic en "+ Nuevo cliente" para agregar uno.</td></tr>';
        return;
      }

      tbody.innerHTML = customers.map(customer => {
        const typeColors = {
          residential: 'rgba(59, 130, 246, 0.1); color: #3b82f6',
          commercial: 'rgba(251, 146, 60, 0.1); color: #fb923c'
        };
        const typeLabels = {
          residential: 'Residencial',
          commercial: 'Comercial'
        };

        const projectCount = customer.projects?.length || 0;
        const tags = customer.tags?.join(', ') || '';

        return `
          <tr onclick="viewCustomerDetail('${customer.id}')" style="cursor: pointer;">
            <td>
              <strong>${customer.name}</strong>
              <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">
                ${customer.email || ''}
                ${tags ? `<span style="margin-left: 8px; padding: 2px 6px; background: rgba(100,116,139,0.1); border-radius: 4px; font-size: 10px; text-transform: uppercase;">${tags}</span>` : ''}
              </p>
            </td>
            <td><span class="badge" style="background: ${typeColors[customer.type] || typeColors.residential}">${typeLabels[customer.type] || 'Residencial'}</span></td>
            <td>
              ${customer.phone ? `📞 ${customer.phone}` : ''}
              ${customer.address_text ? `<br><small style="color: #64748b;">📍 ${customer.address_text.substring(0, 30)}${customer.address_text.length > 30 ? '...' : ''}</small>` : ''}
            </td>
            <td><strong>${projectCount}</strong> proyecto${projectCount !== 1 ? 's' : ''}</td>
            <td>${customer.lastService ? new Date(customer.lastService).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' }) : '--'}</td>
            <td><strong>$${customer.totalSpent?.toLocaleString('es-MX')}</strong></td>
            <td>
              <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); viewCustomerDetail('${customer.id}')">Ver</button>
              <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); editCustomer('${customer.id}')" style="margin-left: 4px;">Editar</button>
            </td>
          </tr>
        `;
      }).join('');

      updateCustomerStats();
    }

    // Update customer statistics
    function updateCustomerStats() {
      const customers = getCustomers();
      const projects = JSON.parse(localStorage.getItem('projectsync_projects') || '[]');

      document.getElementById('customer-stat-total').textContent = customers.length;
      document.getElementById('customer-stat-addresses').textContent = projects.length;
      
      const activeProjects = projects.filter(p => p.status !== 'completed' && p.status !== 'cancelled').length;
      document.getElementById('customer-stat-active').textContent = activeProjects;
    }

    // View customer detail (improved modal similar to Opsis Plumbing)
    function viewCustomerDetail(customerId) {
      const customer = getCustomers().find(c => c.id === customerId);
      if (!customer) return;

      const projects = JSON.parse(localStorage.getItem('projectsync_projects') || '[]');
      const customerProjects = projects.filter(p => p.customerId === customerId || p.customer === customer.name);
      const tags = customer.tags?.join(', ') || 'Sin tags';

      const detailHTML = `
        <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;" onclick="this.remove()">
          <div style="background: var(--bg-card); border-radius: 20px; padding: 32px; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px;">
              <div>
                <p style="font-size: 12px; text-transform: uppercase; color: #64748b; letter-spacing: 0.1em; margin-bottom: 8px;">${customer.type === 'commercial' ? 'Comercial' : 'Residencial'}</p>
                <h2 style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${customer.name}</h2>
                <p style="font-size: 14px; color: #64748b;">${tags}</p>
              </div>
              <button onclick="this.closest('[style*=fixed]').remove()" style="background: #f1f5f9; border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer; font-weight: 600;">✕ Cerrar</button>
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px;">
              <div style="background: linear-gradient(135deg, #02735E, #035951); color: white; padding: 16px; border-radius: 12px;">
                <div style="font-size: 12px; opacity: 0.8; margin-bottom: 4px;">Total Proyectos</div>
                <div style="font-size: 28px; font-weight: 700;">${customerProjects.length}</div>
              </div>
              <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 16px; border-radius: 12px;">
                <div style="font-size: 12px; opacity: 0.8; margin-bottom: 4px;">Total Gastado</div>
                <div style="font-size: 28px; font-weight: 700;">$${customer.totalSpent?.toLocaleString('es-MX')}</div>
              </div>
              <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 16px; border-radius: 12px;">
                <div style="font-size: 12px; opacity: 0.8; margin-bottom: 4px;">Satisfacción</div>
                <div style="font-size: 28px; font-weight: 700;">${customer.satisfaction?.toFixed(1) || '--'}/5</div>
              </div>
            </div>

            <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <h3 style="font-size: 14px; font-weight: 600; text-transform: uppercase; color: #64748b; margin-bottom: 16px;">Información de Contacto</h3>
              <div style="display: flex; flex-direction: column; gap: 8px; font-size: 14px;">
                ${customer.phone ? `<div>📞 <strong>Teléfono:</strong> ${customer.phone}</div>` : ''}
                ${customer.email ? `<div>✉️ <strong>Email:</strong> ${customer.email}</div>` : ''}
                ${customer.address_text ? `<div>📍 <strong>Dirección:</strong> ${customer.address_text}</div>` : ''}
              </div>
            </div>

            <div>
              <h3 style="font-size: 14px; font-weight: 600; text-transform: uppercase; color: #64748b; margin-bottom: 12px;">Proyectos Recientes</h3>
              ${customerProjects.length > 0 ? customerProjects.slice(0, 5).map(p => `
                <div style="border: 1px solid #e2e8f0; border-radius: 10px; padding: 16px; margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                      <strong style="font-size: 16px;">${p.name}</strong>
                      <p style="font-size: 13px; color: #64748b; margin-top: 4px;">${p.description || 'Sin descripción'}</p>
                    </div>
                    <span style="padding: 4px 10px; background: rgba(2,115,94,0.1); color: #02735E; border-radius: 999px; font-size: 12px; font-weight: 600;">${p.status?.toUpperCase() || 'PENDIENTE'}</span>
                  </div>
                </div>
              `).join('') : '<p style="text-align: center; color: #94a3b8; padding: 20px;">No hay proyectos registrados para este cliente.</p>'}
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px; padding-top: 24px; border-top: 1px solid #e2e8f0;">
              <button onclick="editCustomer('${customer.id}'); this.closest('[style*=fixed]').remove();" class="btn btn-primary" style="flex: 1;">Editar Cliente</button>
              <button onclick="alert('Crear proyecto para ${customer.name}'); this.closest('[style*=fixed]').remove();" class="btn btn-secondary" style="flex: 1;">+ Nuevo Proyecto</button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', detailHTML);
    }

    // Edit customer
    function editCustomer(customerId) {
      const customer = getCustomers().find(c => c.id === customerId);
      if (!customer) return;

      const name = prompt('Nombre del cliente:', customer.name);
      if (!name) return;

      const email = prompt('Email:', customer.email);
      const phone = prompt('Teléfono:', customer.phone);
      const address = prompt('Dirección:', customer.address);
      const type = prompt('Tipo (residential/commercial):', customer.type);

      updateCustomer(customerId, {
        name,
        email: email || customer.email,
        phone: phone || customer.phone,
        address: address || customer.address,
        type: type || customer.type
      });

      renderCustomersTable();
    }

    // Open new customer modal
    document.addEventListener('DOMContentLoaded', () => {
      const btnNewCustomer = document.getElementById('btn-new-customer');
      if (btnNewCustomer) {
        btnNewCustomer.addEventListener('click', () => {
          // Create a proper modal form
          const modalHTML = `
            <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;" id="new-customer-modal">
              <div style="background: var(--bg-card); border-radius: 20px; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 25px 50px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px;">Nuevo Cliente</h2>
                <form id="new-customer-form" style="display: flex; flex-direction: column; gap: 16px;">
                  <div>
                    <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #64748b;">Nombre del Cliente *</label>
                    <input type="text" name="name" required style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                      <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #64748b;">Tipo</label>
                      <select name="type" style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                        <option value="residential">Residencial</option>
                        <option value="commercial">Comercial</option>
                      </select>
                    </div>
                    <div>
                      <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #64748b;">Teléfono</label>
                      <input type="tel" name="phone" placeholder="+52 33 1234 5678" style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                    </div>
                  </div>
                  <div>
                    <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #64748b;">Email</label>
                    <input type="email" name="email" placeholder="contacto@empresa.com" style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                  </div>
                  <div>
                    <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #64748b;">Dirección</label>
                    <input type="text" name="address_text" placeholder="Calle, Ciudad, Estado" style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                  </div>
                  <div>
                    <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #64748b;">Tags (separados por coma)</label>
                    <input type="text" name="tags" placeholder="VIP, Recurrente, B2B" style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                  </div>
                  <div style="display: flex; gap: 12px; margin-top: 8px;">
                    <button type="button" onclick="document.getElementById('new-customer-modal').remove()" style="flex: 1; padding: 12px; background: #f1f5f9; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Cancelar</button>
                    <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #02735E, #035951); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Guardar Cliente</button>
                  </div>
                </form>
              </div>
            </div>
          `;
          
          document.body.insertAdjacentHTML('beforeend', modalHTML);
          
          document.getElementById('new-customer-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const tags = formData.get('tags')?.toString().split(',').map(t => t.trim()).filter(Boolean) || [];
            
            addCustomer({
              name: formData.get('name'),
              type: formData.get('type'),
              phone: formData.get('phone'),
              email: formData.get('email'),
              address_text: formData.get('address_text'),
              tags
            });

            renderCustomersTable();
            document.getElementById('new-customer-modal').remove();
            
            const successHTML = `
              <div style="position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001; font-weight: 600;">
                ✓ Cliente "${formData.get('name')}" agregado exitosamente
              </div>
            `;
            document.body.insertAdjacentHTML('beforeend', successHTML);
            setTimeout(() => document.querySelector('[style*="top: 20px"]')?.remove(), 3000);
          });
        });
      }

      // Customer filter
      document.querySelectorAll('[data-customer-filter]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[data-customer-filter]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          const filter = btn.dataset.customerFilter;
          filterCustomers(filter);
        });
      });

      // Customer search
      const searchInput = document.getElementById('customers-search');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          searchCustomers(e.target.value);
        });
      }

      // Initialize customers on page load
      initializeDemoCustomers();
      renderCustomersTable();
    });

    function filterCustomers(type) {
      const customers = getCustomers();
      const filtered = type === 'all' ? customers : customers.filter(c => c.type === type);
      
      const tbody = document.querySelector('#page-customers table tbody');
      if (!tbody) return;

      tbody.innerHTML = filtered.map(customer => {
        const typeColors = {
          residential: 'rgba(59, 130, 246, 0.1); color: #3b82f6',
          commercial: 'rgba(251, 146, 60, 0.1); color: #fb923c'
        };
        const typeLabels = {
          residential: 'Residencial',
          commercial: 'Comercial'
        };

        return `
          <tr onclick="viewCustomerDetail('${customer.id}')" style="cursor: pointer;">
            <td>
              <strong>${customer.name}</strong>
              <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">${customer.email}</p>
            </td>
            <td><span class="badge" style="background: ${typeColors[customer.type] || typeColors.residential}">${typeLabels[customer.type] || 'Residencial'}</span></td>
            <td>${customer.phone}</td>
            <td><strong>${customer.projects?.length || 0}</strong> proyectos</td>
            <td>${customer.lastService ? new Date(customer.lastService).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' }) : '--'}</td>
            <td><strong>$${customer.totalSpent?.toLocaleString('es-MX')}</strong></td>
            <td>
              <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); viewCustomerDetail('${customer.id}')">Ver Detalle</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function searchCustomers(query) {
      const customers = getCustomers();
      const lowerQuery = query.toLowerCase();
      const filtered = customers.filter(c => 
        c.name.toLowerCase().includes(lowerQuery) ||
        c.email.toLowerCase().includes(lowerQuery) ||
        c.phone.toLowerCase().includes(lowerQuery)
      );

      const tbody = document.querySelector('#page-customers table tbody');
      if (!tbody) return;

      tbody.innerHTML = filtered.map(customer => {
        const typeColors = {
          residential: 'rgba(59, 130, 246, 0.1); color: #3b82f6',
          commercial: 'rgba(251, 146, 60, 0.1); color: #fb923c'
        };
        const typeLabels = {
          residential: 'Residencial',
          commercial: 'Comercial'
        };

        return `
          <tr onclick="viewCustomerDetail('${customer.id}')" style="cursor: pointer;">
            <td>
              <strong>${customer.name}</strong>
              <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">${customer.email}</p>
            </td>
            <td><span class="badge" style="background: ${typeColors[customer.type] || typeColors.residential}">${typeLabels[customer.type] || 'Residencial'}</span></td>
            <td>${customer.phone}</td>
            <td><strong>${customer.projects?.length || 0}</strong> proyectos</td>
            <td>${customer.lastService ? new Date(customer.lastService).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' }) : '--'}</td>
            <td><strong>$${customer.totalSpent?.toLocaleString('es-MX')}</strong></td>
            <td>
              <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); viewCustomerDetail('${customer.id}')">Ver Detalle</button>
            </td>
          </tr>
        `;
      }).join('');
    }
  </script>

  <!-- ==================== STAFF/EMPLOYEES MANAGEMENT ==================== -->
  <script>
    // Staff localStorage key
    const STAFF_KEY = 'motorsync_staff';

    // Initialize demo staff if none exist
    function initializeDemoStaff() {
      let staff = JSON.parse(localStorage.getItem(STAFF_KEY) || '[]');
      if (staff.length === 0) {
        staff = [
          {
            id: 'EMP-001',
            name: 'Ana Owner',
            email: 'ana@opsis.com',
            phone: '+52 33 1111 2222',
            role: 'owner',
            status: 'active',
            mfa: true,
            lastAccess: '2025-06-16T07:20:00',
            createdAt: '2024-01-01'
          },
          {
            id: 'EMP-002',
            name: 'Leo Admin',
            email: 'leo@opsis.com',
            phone: '+52 33 2222 3333',
            role: 'admin',
            status: 'active',
            mfa: true,
            lastAccess: '2025-06-15T11:45:00',
            createdAt: '2024-02-01'
          },
          {
            id: 'EMP-003',
            name: 'Marco Tech',
            email: 'marco@opsis.com',
            phone: '+52 33 3333 4444',
            role: 'tech',
            status: 'active',
            mfa: false,
            lastAccess: '2025-06-12T01:30:00',
            createdAt: '2024-03-01'
          },
          {
            id: 'EMP-004',
            name: 'María Compliance',
            email: 'compliance@opsis.com',
            phone: '+52 33 4444 5555',
            role: 'admin',
            status: 'away',
            mfa: false,
            lastAccess: '2025-06-10T04:05:00',
            createdAt: '2024-04-01'
          }
        ];
        localStorage.setItem(STAFF_KEY, JSON.stringify(staff));
      }
      return staff;
    }

    // Get all staff
    function getStaff() {
      return JSON.parse(localStorage.getItem(STAFF_KEY) || '[]');
    }

    // Save staff
    function saveStaff(staff) {
      localStorage.setItem(STAFF_KEY, JSON.stringify(staff));
    }

    // Add new staff member
    function addStaffMember(staffData) {
      const staff = getStaff();
      const newId = `EMP-${String(staff.length + 1).padStart(3, '0')}`;
      const newMember = {
        id: newId,
        ...staffData,
        status: 'active',
        mfa: false,
        lastAccess: null,
        createdAt: new Date().toISOString()
      };
      staff.push(newMember);
      saveStaff(staff);
      return newMember;
    }

    // Update staff member
    function updateStaffMember(staffId, updates) {
      const staff = getStaff();
      const index = staff.findIndex(s => s.id === staffId);
      if (index !== -1) {
        staff[index] = { ...staff[index], ...updates };
        saveStaff(staff);
        return staff[index];
      }
      return null;
    }

    // Delete staff member
    function deleteStaffMember(staffId) {
      const staff = getStaff();
      const filtered = staff.filter(s => s.id !== staffId);
      saveStaff(filtered);
    }

    // Render staff table
    function renderStaffTable() {
      const staff = getStaff();
      const tbody = document.querySelector('#management-tbody');
      if (!tbody) return;

      if (staff.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">No hay empleados registrados.</td></tr>';
        return;
      }

      tbody.innerHTML = staff.map(member => {
        const statusBadges = {
          active: '<span class="management-badge active">Activo</span>',
          away: '<span class="management-badge away">Fuera</span>',
          inactive: '<span class="management-badge">Inactivo</span>'
        };

        const lastAccess = member.lastAccess 
          ? new Date(member.lastAccess).toLocaleString('es-MX', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit', hour12: true })
          : 'Nunca';

        return `
          <tr data-manager="${member.id}" class="${member.status === 'active' ? 'active' : ''}">
            <td>${member.name}</td>
            <td>${member.email}</td>
            <td>${member.role}</td>
            <td>${statusBadges[member.status] || statusBadges.inactive}</td>
            <td>${lastAccess}</td>
            <td>${member.mfa ? '✓' : '—'}</td>
          </tr>
        `;
      }).join('');

      updateStaffStats();
    }

    // Update staff statistics
    function updateStaffStats() {
      const staff = getStaff();
      const admins = staff.filter(s => s.role === 'owner' || s.role === 'admin').length;
      
      document.getElementById('management-kpi-admins').textContent = admins;
      document.getElementById('management-kpi-invites').textContent = '0'; // Can implement invites later
    }

    // Initialize staff management
    document.addEventListener('DOMContentLoaded', () => {
      const btnNewManager = document.getElementById('btn-new-manager');
      if (btnNewManager) {
        btnNewManager.addEventListener('click', () => {
          const name = prompt('Nombre del empleado:');
          if (!name) return;

          const email = prompt('Email:');
          const phone = prompt('Teléfono:');
          const role = prompt('Rol (owner/admin/tech/labor):', 'tech');

          addStaffMember({
            name,
            email: email || '',
            phone: phone || '',
            role: role || 'tech'
          });

          renderStaffTable();
          alert(`Empleado "${name}" agregado exitosamente.`);
        });
      }

      // Initialize staff
      initializeDemoStaff();
      renderStaffTable();
    });

    // ============================================================================
    // GLOBAL SEARCH FUNCTIONALITY
    // ============================================================================

    let searchDebounceTimer = null;

    function performGlobalSearch(query) {
      const resultsPanel = document.getElementById('searchResults');
      
      // Limpiar timeout anterior
      if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
      
      // Si el query está vacío, ocultar resultados
      if (!query || query.trim().length < 2) {
        resultsPanel.style.display = 'none';
        return;
      }

      // Debounce para evitar búsquedas excesivas
      searchDebounceTimer = setTimeout(() => {
        const searchTerm = query.toLowerCase().trim();
        const results = {
          projects: [],
          customers: [],
          appointments: [],
          threads: []
        };

        // 1. Buscar en Proyectos
        const projects = JSON.parse(localStorage.getItem('projectsync_projects') || '[]');
        results.projects = projects.filter(p => 
          (p.idSync && p.idSync.toLowerCase().includes(searchTerm)) ||
          (p.projectName && p.projectName.toLowerCase().includes(searchTerm)) ||
          (p.clientName && p.clientName.toLowerCase().includes(searchTerm)) ||
          (p.address && p.address.toLowerCase().includes(searchTerm))
        ).slice(0, 5);

        // 2. Buscar en Clientes
        const customers = JSON.parse(localStorage.getItem('motorsync_customers') || '[]');
        results.customers = customers.filter(c => 
          (c.name && c.name.toLowerCase().includes(searchTerm)) ||
          (c.phone && c.phone.includes(searchTerm)) ||
          (c.email && c.email.toLowerCase().includes(searchTerm))
        ).slice(0, 5);

        // 3. Buscar en Citas
        const appointments = JSON.parse(localStorage.getItem('projectsync_appointments') || '[]');
        results.appointments = appointments.filter(a => 
          (a.id && a.id.toString().includes(searchTerm)) ||
          (a.projectId && a.projectId.toLowerCase().includes(searchTerm)) ||
          (a.date && a.date.includes(searchTerm))
        ).slice(0, 5);

        // 4. Buscar en Threads
        const threads = JSON.parse(localStorage.getItem('threadsync_threads') || '[]');
        results.threads = threads.filter(t => 
          (t.id && t.id.toLowerCase().includes(searchTerm)) ||
          (t.subject && t.subject.toLowerCase().includes(searchTerm)) ||
          (t.customerName && t.customerName.toLowerCase().includes(searchTerm))
        ).slice(0, 5);

        // Renderizar resultados
        renderSearchResults(results, searchTerm);
      }, 300);
    }

    function renderSearchResults(results, searchTerm) {
      const resultsPanel = document.getElementById('searchResults');
      const totalResults = results.projects.length + results.customers.length + 
                          results.appointments.length + results.threads.length;

      if (totalResults === 0) {
        resultsPanel.innerHTML = `
          <div style="padding: 24px; text-align: center; color: #6b7280;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 12px;">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
            <p style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">No se encontraron resultados</p>
            <p style="font-size: 13px;">Intenta con otro término de búsqueda</p>
          </div>
        `;
        resultsPanel.style.display = 'block';
        return;
      }

      let html = '<div style="padding: 12px;">';

      // Proyectos
      if (results.projects.length > 0) {
        html += `
          <div style="margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f0fdf4; border-radius: 8px; margin-bottom: 8px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              </svg>
              <span style="font-size: 12px; font-weight: 700; color: #047857; text-transform: uppercase; letter-spacing: 0.05em;">Proyectos (${results.projects.length})</span>
            </div>
        `;
        
        results.projects.forEach(p => {
          const stateData = JSON.parse(localStorage.getItem(\`project_state_\${p.idSync}\`) || 'null');
          const stateEmoji = stateData ? getWorkflowStateEmoji(stateData.state) : '📋';
          
          html += `
            <div onclick="navigateToProject('${p.idSync}')" style="padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#10b981'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                <span style="font-size: 13px; font-weight: 600; color: #111827;">${stateEmoji} ${p.idSync}</span>
                <span style="font-size: 11px; color: #6b7280;">${p.status || 'Activo'}</span>
              </div>
              <p style="font-size: 13px; color: #374151; margin-bottom: 2px;">${p.projectName || 'Sin nombre'}</p>
              <p style="font-size: 12px; color: #6b7280;">👤 ${p.clientName} • 📍 ${p.address || 'Sin dirección'}</p>
            </div>
          `;
        });
        
        html += '</div>';
      }

      // Clientes
      if (results.customers.length > 0) {
        html += `
          <div style="margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #eff6ff; border-radius: 8px; margin-bottom: 8px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              <span style="font-size: 12px; font-weight: 700; color: #1e40af; text-transform: uppercase; letter-spacing: 0.05em;">Clientes (${results.customers.length})</span>
            </div>
        `;
        
        results.customers.forEach(c => {
          html += `
            <div onclick="navigateToCustomer('${c.id}')" style="padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#3b82f6'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
              <p style="font-size: 13px; font-weight: 600; color: #111827; margin-bottom: 4px;">${c.name}</p>
              <p style="font-size: 12px; color: #6b7280;">📞 ${c.phone || 'Sin teléfono'} • ✉️ ${c.email || 'Sin email'}</p>
            </div>
          `;
        });
        
        html += '</div>';
      }

      // Citas
      if (results.appointments.length > 0) {
        html += `
          <div style="margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #fef3c7; border-radius: 8px; margin-bottom: 8px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              <span style="font-size: 12px; font-weight: 700; color: #92400e; text-transform: uppercase; letter-spacing: 0.05em;">Citas (${results.appointments.length})</span>
            </div>
        `;
        
        results.appointments.forEach(a => {
          html += `
            <div onclick="navigateToAppointment('${a.id}')" style="padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#f59e0b'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                <span style="font-size: 13px; font-weight: 600; color: #111827;">📅 Cita #${a.id}</span>
                <span style="font-size: 11px; color: #6b7280;">${a.date}</span>
              </div>
              <p style="font-size: 12px; color: #6b7280;">🏗️ ${a.projectId || 'Sin proyecto'} • ⏰ ${a.time || 'Sin hora'}</p>
            </div>
          `;
        });
        
        html += '</div>';
      }

      // Threads
      if (results.threads.length > 0) {
        html += `
          <div style="margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #fce7f3; border-radius: 8px; margin-bottom: 8px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ec4899" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              <span style="font-size: 12px; font-weight: 700; color: #9f1239; text-transform: uppercase; letter-spacing: 0.05em;">Threads (${results.threads.length})</span>
            </div>
        `;
        
        results.threads.forEach(t => {
          const priority = t.priority === 'high' ? '🔴' : t.priority === 'medium' ? '🟡' : '🟢';
          html += `
            <div onclick="navigateToThread('${t.id}')" style="padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='#ec4899'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                <span style="font-size: 13px; font-weight: 600; color: #111827;">${priority} ${t.id}</span>
                <span style="font-size: 11px; color: #6b7280;">${t.status || 'Abierto'}</span>
              </div>
              <p style="font-size: 13px; color: #374151; margin-bottom: 2px;">${t.subject}</p>
              <p style="font-size: 12px; color: #6b7280;">👤 ${t.customerName || 'Sin cliente'}</p>
            </div>
          `;
        });
        
        html += '</div>';
      }

      html += '</div>';
      resultsPanel.innerHTML = html;
      resultsPanel.style.display = 'block';
    }

    function getWorkflowStateEmoji(state) {
      const emojis = {
        'lead': '🎯',
        'scheduled': '📅',
        'in_progress': '⚙️',
        'review': '👀',
        'invoice_sent': '💰',
        'paid': '✅',
        'completed': '🏆'
      };
      return emojis[state] || '📋';
    }

    function navigateToProject(projectId) {
      window.location.href = \`viewsync.html?id=\${projectId}\`;
    }

    function navigateToCustomer(customerId) {
      alert(\`Navegar a cliente \${customerId} (CustomerSync en desarrollo)\`);
      document.getElementById('searchResults').style.display = 'none';
      document.getElementById('globalSearch').value = '';
    }

    function navigateToAppointment(appointmentId) {
      // Cambiar al tab de ProjectSync
      document.getElementById('projectsync-tab').click();
      // Scroll a la tabla de citas
      setTimeout(() => {
        const table = document.getElementById('appointments-table');
        if (table) table.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
      
      document.getElementById('searchResults').style.display = 'none';
      document.getElementById('globalSearch').value = '';
    }

    function navigateToThread(threadId) {
      // Cambiar al tab de ThreadSync
      document.getElementById('threadsync-tab').click();
      
      document.getElementById('searchResults').style.display = 'none';
      document.getElementById('globalSearch').value = '';
    }

    // Cerrar resultados al hacer click fuera
    document.addEventListener('click', (e) => {
      const searchInput = document.getElementById('globalSearch');
      const resultsPanel = document.getElementById('searchResults');
      
      if (searchInput && resultsPanel && 
          !searchInput.contains(e.target) && 
          !resultsPanel.contains(e.target)) {
        resultsPanel.style.display = 'none';
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + K para enfocar el buscador
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const searchInput = document.getElementById('globalSearch');
        if (searchInput) {
          searchInput.focus();
          searchInput.select();
        }
      }
      
      // Escape para cerrar resultados
      if (e.key === 'Escape') {
        const resultsPanel = document.getElementById('searchResults');
        if (resultsPanel) resultsPanel.style.display = 'none';
      }
    });

  </script>

  </div><!-- /app-content -->
  </div><!-- /app-shell -->

</body></html>
