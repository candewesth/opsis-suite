<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ViewSync - Portal del Proyecto</title>
  <!-- Cache-bust: v2024-11-25 -->
  <link rel="stylesheet" href="../assets/css/main.css">
  <link rel="stylesheet" href="styles.css?v=verdi2">
  <link rel="stylesheet" href="css/verdi-overrides.css?v=verdi2">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="js/modules.js?v=verdi2"></script>
  <script src="js/sidebar.js?v=verdi2"></script>
  <script src="js/back-link.js?v=verdi2"></script>
  <script src="./js/ui-feedback.js"></script>
  <script>
    window.showToast = (type, message) => uiToast(type, message);
    window.showConfirm = (message, opts) => uiConfirm(message, opts);
    window.alert = (message) => uiToast('info', String(message));
  </script>
  <script>
    const CLIENTS_DATA_KEY = 'clientsync_clients';

    function loadClientsFromStore() {
      try {
        return JSON.parse(localStorage.getItem(CLIENTS_DATA_KEY) || '[]');
      } catch (err) {
        console.warn('No se pudieron cargar clientes', err);
        return [];
      }
    }

    function getTimelineModalBaseStart(modal) {
      const startInput = modal?.querySelector('#tl-start');
      return startInput?.value || currentProject?.startDate || toInputDate(new Date());
    }

    function updateTimelineComputedRow(row, modal) {
      if (!row || !modal) return;
      const baseStart = parseInputDate(getTimelineModalBaseStart(modal));
      const offsetInput = row.querySelector('[data-field="startOffset"]');
      const durationInput = row.querySelector('[data-field="duration"]');
      const manualStart = row.querySelector('[data-field="startDate"]')?.value;
      const manualEnd = row.querySelector('[data-field="endDate"]')?.value;
      const offset = Number(offsetInput?.value || 0);
      const duration = Math.max(1, Number(durationInput?.value || 1));
      let computedStart = manualStart ? parseInputDate(manualStart) : (baseStart ? addDays(baseStart, offset) : null);
      let computedEnd = manualEnd ? parseInputDate(manualEnd) : (computedStart ? addDays(computedStart, duration - 1) : null);
      const startLabel = row.querySelector(`[data-computed-start="${row.dataset.idx}"]`);
      const endLabel = row.querySelector(`[data-computed-end="${row.dataset.idx}"]`);
      if (startLabel) startLabel.textContent = formatShortDate(computedStart);
      if (endLabel) endLabel.textContent = formatShortDate(computedEnd);
    }

    function refreshTimelineComputed(modal) {
      if (!modal) return;
      const rows = modal.querySelectorAll('.timeline-row');
      rows.forEach((row) => updateTimelineComputedRow(row, modal));
    }

    function getClientRecord(clientId) {
      if (!clientId) return null;
      const clients = loadClientsFromStore();
      return clients.find(c => c.id === clientId) || null;
    }

    function updateClientRecord(clientId, payload) {
      if (!clientId) return;
      const clients = loadClientsFromStore();
      const idx = clients.findIndex(c => c.id === clientId);
      if (idx === -1) return;
      clients[idx] = { ...clients[idx], ...payload };
      localStorage.setItem(CLIENTS_DATA_KEY, JSON.stringify(clients));
    }

    const FORMSYNC_FIELDS = [
      { key: 'crew', label: 'Equipo / Crew', selector: '[data-formsync-field=\"crew\"]' },
      { key: 'hours', label: 'Horas totales', selector: '[data-formsync-field=\"hours\"]' },
      { key: 'weather', label: 'Clima', selector: '[data-formsync-field=\"weather\"]' },
      { key: 'start', label: 'Inicio', selector: '[data-formsync-field=\"start\"]' },
      { key: 'end', label: 'Fin', selector: '[data-formsync-field=\"end\"]' },
      { key: 'crewCount', label: 'Crew (número)', selector: '[data-formsync-field=\"crewCount\"]' },
      { key: 'photo', label: 'Foto', selector: '[data-formsync-field=\"photo\"]' },
      { key: 'work', label: 'Trabajo realizado', selector: '[data-formsync-field=\"work\"]' },
      { key: 'materials', label: 'Materiales usados', selector: '[data-formsync-field=\"materials\"]' },
      { key: 'safety', label: 'Seguridad / incidencias', selector: '[data-formsync-field=\"safety\"]' },
      { key: 'notes', label: 'Notas', selector: '[data-formsync-field=\"notes\"]' }
    ];

    const FORMSYNC_SIGNATURE_OPTIONS = [
      { key: 'supervisor', label: 'Supervisor', resolveName: (project) => project?.supervisor || project?.owner || 'Supervisor del Proyecto' },
      { key: 'client', label: 'Cliente', resolveName: (project) => project?.clientContact || project?.client || project?.clientName || 'Cliente' }
    ];

    const FORMSYNC_TEMPLATE_DEFAULT = {
      fields: {
        crew: 'required',
        hours: 'required',
        weather: 'optional',
        start: 'optional',
        end: 'optional',
        crewCount: 'optional',
        photo: 'optional',
        work: 'required',
        materials: 'optional',
        safety: 'optional',
        notes: 'optional'
      },
      signatures: {
        supervisor: true,
        client: false
      }
    };

    let currentFormTemplate = null;

    function cloneTemplate(obj) {
      return JSON.parse(JSON.stringify(obj));
    }

    function getFormTemplateStorageKey() {
      const companyId = (currentProject && (currentProject.companyId || currentProject.company || currentProject.clientCompany)) || 'default';
      return `formsync_template_${companyId}`;
    }

    function ensureTemplateStructure(template) {
      const base = { fields: {}, signatures: {} };
      FORMSYNC_FIELDS.forEach((field) => {
        const state = template?.fields?.[field.key];
        base.fields[field.key] = ['required', 'optional', 'hidden'].includes(state)
          ? state
          : (FORMSYNC_TEMPLATE_DEFAULT.fields[field.key] || 'optional');
      });
      FORMSYNC_SIGNATURE_OPTIONS.forEach((sig) => {
        base.signatures[sig.key] = Boolean(template?.signatures?.[sig.key]);
      });
      return base;
    }

    function getStoredProjects() {
      try {
        return JSON.parse(localStorage.getItem('projectsync_projects') || '[]');
      } catch (err) {
        return [];
      }
    }

    function getProjectMeta(projectId) {
      if (!projectId) return null;
      const projects = getStoredProjects();
      return projects.find((p) => p.id === projectId || p.idSync === projectId) || null;
    }

    function loadFormTemplate() {
      if (currentFormTemplate) return currentFormTemplate;
      const key = getFormTemplateStorageKey();
      let template = null;
      try {
        template = JSON.parse(localStorage.getItem(key) || 'null');
      } catch (err) {
        template = null;
      }
      if (!template) {
        template = cloneTemplate(FORMSYNC_TEMPLATE_DEFAULT);
        localStorage.setItem(key, JSON.stringify(template));
      }
      currentFormTemplate = ensureTemplateStructure(template);
      return currentFormTemplate;
    }

    function saveFormTemplateConfig(template) {
      const sanitized = ensureTemplateStructure(template || {});
      currentFormTemplate = sanitized;
      localStorage.setItem(getFormTemplateStorageKey(), JSON.stringify(sanitized));
    }

    function applyFormTemplateToForm() {
      const template = loadFormTemplate();
      const form = document.getElementById('formSyncForm');
      if (!form) return;
      FORMSYNC_FIELDS.forEach((field) => {
        const wrappers = form.querySelectorAll(field.selector);
        const state = template.fields?.[field.key] || 'optional';
        wrappers.forEach((wrapper) => {
          wrapper.style.display = state === 'hidden' ? 'none' : '';
          wrapper.querySelectorAll('input, textarea, select').forEach((input) => {
            input.required = state === 'required';
            if (state === 'hidden') {
              input.value = '';
            }
          });
          const label = wrapper.querySelector('.kpi-sub');
          if (label) {
            label.style.color = state === 'required' ? '#b45309' : '#64748b';
          }
        });
      });
    }

    function collectFormSyncTemplateFromModal(modal) {
      const template = { fields: {}, signatures: {} };
      FORMSYNC_FIELDS.forEach((field) => {
        const selected = modal.querySelector(`input[name="fs-field-${field.key}"]:checked`);
        template.fields[field.key] = selected ? selected.value : 'optional';
      });
      FORMSYNC_SIGNATURE_OPTIONS.forEach((sig) => {
        template.signatures[sig.key] = modal.querySelector(`#fs-sign-${sig.key}`)?.checked || false;
      });
      return template;
    }

    function renderFormSyncTemplatePreview(modal) {
      const container = modal.querySelector('#fs-template-preview');
      if (!container) return;
      const template = collectFormSyncTemplateFromModal(modal);
      const required = FORMSYNC_FIELDS.filter((field) => template.fields[field.key] === 'required');
      const optional = FORMSYNC_FIELDS.filter((field) => template.fields[field.key] === 'optional');
      const hidden = FORMSYNC_FIELDS.filter((field) => template.fields[field.key] === 'hidden');
      container.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:12px;">
          <div>
            <p style="margin:0; font-size:12px; color:#94a3b8;">Campos obligatorios</p>
            <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:6px;">
              ${required.length ? required.map(field => `<span class="kpi-badge" style="background:rgba(2,115,94,0.12); border-color:rgba(2,115,94,0.2);">${field.label}</span>`).join('') : '<span style="font-size:12px; color:#94a3b8;">Ninguno</span>'}
            </div>
          </div>
          <div>
            <p style="margin:0; font-size:12px; color:#94a3b8;">Campos visibles opcionales</p>
            <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:6px;">
              ${optional.length ? optional.map(field => `<span class="kpi-badge" style="background:#f8fafc; border-color:#e2e8f0; color:#475569;">${field.label}</span>`).join('') : '<span style="font-size:12px; color:#94a3b8;">Ninguno</span>'}
            </div>
          </div>
          <div>
            <p style="margin:0; font-size:12px; color:#94a3b8;">Campos ocultos</p>
            <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:6px;">
              ${hidden.length ? hidden.map(field => `<span class="kpi-badge" style="background:#fee2e2; border-color:#fecaca; color:#b91c1c;">${field.label}</span>`).join('') : '<span style="font-size:12px; color:#94a3b8;">Ninguno</span>'}
            </div>
          </div>
        </div>
      `;
    }

    function getSignatureFallbacks(template, project) {
      const list = [];
      FORMSYNC_SIGNATURE_OPTIONS.forEach((sig) => {
        if (template.signatures?.[sig.key]) {
          list.push({
            name: sig.resolveName ? sig.resolveName(project) : sig.label,
            role: sig.label
          });
        }
      });
      return list;
    }

    function isFormFieldFilled(key, value) {
      if (key === 'crewCount') {
        return Number(value) > 0;
      }
      return Boolean(String(value || '').trim());
    }
  </script>
  <style>
    :root {
      --verdi-dark: #022326;
      --verdi-mid: #034040;
      --verdi-accent: #035951;
      --verdi-light: #02735E;
      --primary-color: #02735E;
      --accent-color: #035951;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --bg-body: #fafafa;
      --bg-card: #ffffff;
      --border-color: #ebebeb;
      --hero-title-size-base: clamp(28px, 3vw, 36px);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Helvetica Neue', Helvetica, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-body);
      color: var(--text-primary);
      font-weight: 400;
      line-height: 1.6;
    }

    /* Hero compacto */
    .project-hero {
      background: linear-gradient(135deg, #02735E 0%, #035951 90%);
      color: #fff;
      padding: 18px 24px;
      box-shadow: 0 4px 12px rgba(2, 115, 94, 0.15);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      --project-hero-title-size: var(--hero-title-size-base);
    }
    .project-hero[data-title-size="lg"] {
      --project-hero-title-size: clamp(40px, 5vw, 56px);
    }

    .hero-grid {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      flex-wrap: wrap;
    }

    .project-hero .hero-primary {
      flex: 1 1 320px;
      min-width: 0;
    }

    .project-title {
      margin: 0;
      font-size: var(--project-hero-title-size, 32px);
      font-weight: 800;
      letter-spacing: -0.2px;
      color: #fff;
      line-height: 1.2;
      text-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }

    .project-hero .meta-row span,
    .project-hero .meta-row svg,
    .project-hero .meta-row strong {
      color: #fff;
    }

    .hero-actions {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .hero-actions button {
      color: #fff;
    }

    .meta-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .id-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      font-weight: 700;
    }

    .hero-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: center;
    }

    /* KPIs compactos estilo tablero */
    .project-kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      padding: 12px 18px 0 18px;
      background: #f8fafc;
    }

    .kpi-card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px 14px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 6px;
      align-items: center;
      box-shadow: 0 6px 18px rgba(15,23,42,0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(15,23,42,0.12); }

    .kpi-title {
      font-size: 13px;
      font-weight: 700;
      color: #1f2937;
    }

    .kpi-sub {
      font-size: 12px;
      color: #64748b;
    }

    .kpi-value {
      font-size: 18px;
      font-weight: 800;
      color: #02735E;
      text-align: right;
    }

    .kpi-badge {
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid rgba(2,115,94,0.15);
      background: rgba(2,115,94,0.06);
      color: #02735E;
    }

    /* Galería rápida */
    .quick-gallery {
      display: flex;
      gap: 12px;
      padding: 12px 18px 4px 18px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
    }

    .photo-chip {
      width: 140px;
      height: 90px;
      border-radius: 12px;
      background: #e2e8f0;
      border: 1px solid #dfe5ec;
      overflow: hidden;
      position: relative;
      scroll-snap-align: start;
      flex-shrink: 0;
      box-shadow: 0 6px 18px rgba(15,23,42,0.06);
    }

    .photo-chip img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .photo-chip .label {
      position: absolute;
      bottom: 6px;
      left: 6px;
      background: rgba(0,0,0,0.55);
      color: #fff;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
    }

    /* Ajustes previos */
    .portal-header { display: none; }

    .viewsync-brand {
      display: inline-block;
      padding: 0;
      background: none;
      border-radius: 0;
      color: white;
      font-weight: 700;
      font-size: 24px;
      letter-spacing: 0;
      box-shadow: none;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .back-button {
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.25);
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
    }

    .back-button:hover {
      background: rgba(255,255,255,0.25);
      border-color: rgba(255,255,255,0.4);
    }

    .back-button svg {
      width: 14px;
      height: 14px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-white {
      background: white;
      color: var(--primary-color);
      border: 1px solid white;
    }

    .btn-white:hover {
      background: rgba(255,255,255,0.9);
      border-color: white;
    }

    .btn-success {
      background: #10b981;
      color: white;
      border: 1px solid #10b981;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
      border: 1px solid #3b82f6;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
      border: 1px solid #f59e0b;
    }

    .btn-warning:hover {
      background: #d97706;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    /* Menú de acciones */
    .actions-menu {
      position: fixed;
      top: 0;
      right: 0;
      width: 420px;
      height: 100vh;
      background: white;
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
      }
      to {
        transform: translateX(0);
      }
    }
    
    .actions-menu-header {
      background: linear-gradient(135deg, #02735E 0%, #035951 100%);
      color: white;
      padding: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      font-weight: 600;
    }
    
    .actions-menu-body {
      padding: 24px;
      overflow-y: auto;
      height: calc(100vh - 72px);
    }
    
    .action-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 20px;
      margin-bottom: 12px;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      text-align: left;
    }
    
    .action-item:hover {
      transform: translateX(-4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .action-icon {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .action-success .action-icon {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
    }
    
    .action-success:hover {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.02);
    }
    
    .action-primary .action-icon {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }
    
    .action-primary:hover {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.02);
    }
    
    .action-warning .action-icon {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }
    
    .action-warning:hover {
      border-color: #f59e0b;
      background: rgba(245, 158, 11, 0.02);
    }
    
    .action-danger .action-icon {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }
    
    .action-danger:hover {
      border-color: #ef4444;
      background: rgba(239, 68, 68, 0.02);
    }
    
    .action-content {
      flex: 1;
    }
    
    .action-title {
      font-size: 16px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 4px;
    }
    
    .action-description {
      font-size: 13px;
      color: #64748b;
      line-height: 1.4;
    }
    
    .action-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 20px 0;
    }

    /* Modales */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal {
      background: white;
      border-radius: 16px;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(40px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      background: linear-gradient(135deg, #02735E 0%, #035951 100%);
      color: white;
      padding: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .modal-body {
      padding: 24px;
      max-height: calc(90vh - 200px);
      overflow-y: auto;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Modal flotante para equipo */
    #assignStaffModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2500;
      padding: 20px;
    }

    #assignStaffModal .modal-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 640px;
      box-shadow: 0 24px 48px rgba(0,0,0,0.25);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
      border: 1px solid #6b7280;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .message-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
      max-height: 400px;
      overflow-y: auto;
      padding: 16px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .message-item {
      background: white;
      padding: 12px 16px;
      border-radius: 8px;
      border-left: 4px solid var(--primary-color);
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .message-author {
      font-weight: 600;
      font-size: 14px;
    }

    .message-time {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .message-text {
      font-size: 14px;
      line-height: 1.5;
    }

    .project-title-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .project-title {
      font-size: 20px;
      font-weight: 600;
      font-style: italic;
      margin-bottom: 6px;
      color: rgba(255,255,255,0.95);
    }

    .project-id {
      font-size: 14px;
      color: rgba(255,255,255,0.95);
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }

    .project-id .id-badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 6px 14px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .project-id .id-badge strong {
      color: white;
      font-size: 15px;
      letter-spacing: 0.5px;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-active {
      background: rgba(16, 185, 129, 0.2);
      color: #059669;
    }

    .project-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.2);
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: rgba(255,255,255,0.95);
    }

    .meta-item svg {
      color: white;
      width: 16px;
      height: 16px;
      opacity: 0.9;
    }

    .portal-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 32px;
    }

    .tabs {
      background: white;
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 24px;
      display: flex;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .tab {
      padding: 12px 24px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab.active {
      background: var(--primary-color);
      color: white;
    }

    .tab:hover:not(.active) {
      background: rgba(2, 115, 94, 0.05);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid var(--border-color);
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.98), rgba(250,250,250,0.95));
      border: 1px solid rgba(2,115,94,0.08);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 4px;
    }

    .stat-change {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .info-label {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-value {
      font-size: 15px;
      color: var(--text-primary);
      font-weight: 500;
    }

    .progress-bar {
      background: #e5e7eb;
      height: 12px;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      background: linear-gradient(90deg, #02735E, #059669);
      height: 100%;
      border-radius: 6px;
      transition: width 0.3s ease;
    }

    .timeline {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 16px;
    }

    .timeline-item {
      display: flex;
      gap: 16px;
      align-items: start;
    }

    .timeline-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary-color);
      margin-top: 4px;
      flex-shrink: 0;
    }

    .timeline-dot.pending {
      background: #e5e7eb;
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .timeline-date {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .photo-item {
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s ease;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px dashed var(--border-color);
    }

    .photo-item:hover {
      transform: scale(1.05);
    }

    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .team-member {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      background: #f9fafb;
      margin-bottom: 8px;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #02735E, #059669);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 16px;
    }

    .member-info {
      flex: 1;
    }

    .member-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .member-role {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* === Sistema de Asignación de Personal === */
    .staff-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      background: white;
      margin-bottom: 8px;
      border: 2px solid transparent;
      transition: all 0.2s;
      cursor: pointer;
    }

    html[data-theme='dark'] .staff-item {
      background: rgba(255, 255, 255, 0.03);
    }

    .staff-item:hover {
      border-color: rgba(2, 115, 94, 0.3);
      background: rgba(2, 115, 94, 0.05);
    }

    .staff-item.selected {
      border-color: #02735E;
      background: rgba(2, 115, 94, 0.1);
    }

    .staff-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid #d1d5db;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .staff-item.selected .staff-checkbox {
      background: #02735E;
      border-color: #02735E;
    }

    .staff-item.selected .staff-checkbox::after {
      content: '✓';
      color: white;
      font-size: 14px;
      font-weight: 700;
    }

    .staff-details {
      flex: 1;
    }

    .staff-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .staff-meta {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .role-badge {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .role-badge.owner { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }
    .role-badge.admin { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    .role-badge.tech { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .role-badge.supervisor { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }

    .assigned-team-empty {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-secondary);
    }

    /* === Timeline Visual (Gantt-style) === */
    .timeline-container {
      background: white;
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--border-color);
      margin-bottom: 24px;
    }

    html[data-theme='dark'] .timeline-container {
      background: rgba(255, 255, 255, 0.03);
      border-color: rgba(255, 255, 255, 0.06);
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border-color);
    }

    .timeline-grid {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 16px;
      min-height: 300px;
    }

    .timeline-tasks {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .timeline-task-label {
      background: var(--bg-body);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      gap: 4px;
      height: 64px;
      justify-content: center;
    }

    .timeline-task-date {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .timeline-bars {
      position: relative;
      background: linear-gradient(90deg, transparent 0%, transparent calc(100% - 1px), var(--border-color) calc(100% - 1px), var(--border-color) 100%);
      background-size: calc(100% / 7) 100%;
      background-repeat: repeat-x;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .timeline-bar-container {
      position: relative;
      height: 64px;
      display: flex;
      align-items: center;
    }

    .timeline-bar {
      position: absolute;
      height: 36px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      padding: 0 12px;
      font-size: 12px;
      font-weight: 600;
      color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transition: all 0.2s;
      cursor: pointer;
    }

    .timeline-bar:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .timeline-bar.completed {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .timeline-bar.in-progress {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .timeline-bar.pending {
      background: linear-gradient(135deg, #94a3b8, #64748b);
    }

    .timeline-bar.cancelled {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .timeline-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
      font-size: 11px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .timeline-legend {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .legend-color {
      width: 20px;
      height: 12px;
      border-radius: 3px;
    }

    .milestone {
      position: absolute;
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 12px solid #8b5cf6;
      top: 50%;
      transform: translateY(-50%);
    }

    .milestone-label {
      position: absolute;
      top: -24px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      font-weight: 700;
      color: #8b5cf6;
      white-space: nowrap;
      background: rgba(139, 92, 246, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .assigned-team-empty svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .drag-handle {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      border: 1px dashed #cbd5e1;
      background: #f8fafc;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      cursor: grab;
    }

    .drag-handle svg {
      pointer-events: none;
    }

    .sch-row-wrapper.dragging {
      opacity: 0.7;
    }

    .comment-feed {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-height: 500px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .comment {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .comment-content {
      flex: 1;
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .comment-author {
      font-weight: 600;
      font-size: 14px;
    }

    .comment-time {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .comment-text {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .new-comment {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }

    .comment-input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      min-height: 80px;
    }

    .comment-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
      margin-top: 12px;
    }

    .btn-primary:hover {
      background: var(--verdi-accent);
    }

    /* Animaciones para modales */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Hover effects para photo-card */
    .photo-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }

    /* Estilos para filtros de fotos */
    .photo-filter {
      transition: all 0.2s ease;
    }

    .photo-filter:hover {
      background: #f1f5f9 !important;
      border-color: #cbd5e1 !important;
    }

    .photo-filter.active:hover {
      background: linear-gradient(135deg, #02735E, #035951) !important;
      border-color: transparent !important;
    }

    /* Estilos para filtros de documentos */
    .doc-filter {
      transition: all 0.2s ease;
    }

    .doc-filter:hover {
      background: #f1f5f9 !important;
      border-color: #cbd5e1 !important;
    }

    .doc-filter.active:hover {
      background: linear-gradient(135deg, #02735E, #035951) !important;
      border-color: transparent !important;
    }

    /* Hover effects para doc-item */
    .doc-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* ============================================================================
       TOAST NOTIFICATION SYSTEM
       ============================================================================ */
    
    #toastContainer {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 400px;
    }

    .toast {
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: toastSlideIn 0.3s ease-out;
      border-left: 4px solid #10b981;
      min-width: 300px;
    }

    .toast.success {
      border-left-color: #10b981;
    }

    .toast.error {
      border-left-color: #ef4444;
    }

    .toast.warning {
      border-left-color: #f59e0b;
    }

    .toast.info {
      border-left-color: #3b82f6;
    }

    .toast-icon {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toast.success .toast-icon {
      background: #d1fae5;
      color: #065f46;
    }

    .toast.error .toast-icon {
      background: #fee2e2;
      color: #991b1b;
    }

    .toast.warning .toast-icon {
      background: #fef3c7;
      color: #92400e;
    }

    .toast.info .toast-icon {
      background: #dbeafe;
      color: #1e40af;
    }

    .toast-message {
      flex: 1;
      font-size: 14px;
      color: #1f2937;
      font-weight: 500;
    }

    .toast-close {
      flex-shrink: 0;
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 4px;
      transition: color 0.2s;
    }

    .toast-close:hover {
      color: #4b5563;
    }

    @keyframes toastSlideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes toastSlideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .toast.removing {
      animation: toastSlideOut 0.3s ease-out;
    }

  </style>
</head>
<body data-sidebar-active="projectsync">
  <div class="app-shell" data-theme="light" data-accent="#02735E">
    <header style="background: linear-gradient(135deg, #02735E 0%, #035951 50%, #034040 100%); background-size: 200% 200%; animation: aire 8s ease infinite; padding: 0; display: flex; align-items: flex-end;">
      <div class="logo" aria-label="Opsis Suite" style="padding: 18px 32px;">
        <div class="logo-text">
          <div class="logo-title">Opsis Suite</div>
          <div id="company-name-header" style="font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.85); margin-top: 2px;">CVE San Diego</div>
        </div>
      </div>
      
      <!-- Module Tabs -->
      <div class="module-tabs" id="module-tabs-container" style="display: flex; gap: 0;">
        <a href="motorsync.html" class="module-tab active">MotorSync</a>
        <a href="../timesync/timesync.html" class="module-tab">TimeSync</a>
      </div>
    </header>
    
    <div class="app-content">
      <aside id="sidebar"></aside>

      <main id="main" style="padding: 0; background: #f8fafc;">
        <div id="toastContainer"></div>

        <div class="project-hero" data-title-size="md">
          <div class="hero-grid">
            <div class="hero-primary" style="display:flex; flex-direction:column; gap:10px;">
              <div class="meta-row" style="gap:10px;">
                <button class="back-button" data-return-target="motorsync" style="background: rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.3); color:#fff; padding:8px 12px; border-radius:8px; display:inline-flex; align-items:center; gap:6px; font-weight:600; cursor:pointer;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                  Volver a MotorSync
                </button>
                <span class="id-badge" id="projectIdBadge">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                  </svg>
                  <strong>IDSync</strong>
                </span>
                <button type="button" id="threadLinkBtn" onclick="openLinkedThread()" style="display:none; background: rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.3); color:#fff; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; gap:6px; align-items:center;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                  Ver Conversación
                </button>
              </div>
              <h1 class="project-title" id="projectTitle">Proyecto</h1>
              <div class="meta-row" style="color: rgba(255,255,255,0.9); font-weight:600;">
                <span id="projectAddress" style="display:inline-flex; align-items:center; gap:6px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                  <span>Dirección</span>
                </span>
              </div>
            </div>
            <div class="hero-actions">
              <button type="button" class="btn btn-white" id="heroSizeToggle" onclick="toggleHeroTitleSize()" title="Ajustar tamaño del título" style="background: rgba(255,255,255,0.18); border:1px solid rgba(255,255,255,0.35); color:#fff; width:50px; height:50px; border-radius:14px; justify-content:center;">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19h6M7 19V5m-3 4h6"/><path d="M14 10h7m-3.5-3v10"/></svg>
              </button>
              <button type="button" class="btn btn-white" onclick="toggleActionsMenu()" title="Acciones rápidas" style="background: rgba(255,255,255,0.14); border:1px solid rgba(255,255,255,0.3); color:#fff; width:50px; height:50px; border-radius:14px; justify-content:center;">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
              </button>
              <button type="button" class="btn btn-white" onclick="editProject()" title="Editar Información" style="background: rgba(255,255,255,0.18); border:1px solid rgba(255,255,255,0.35); color:#fff; width:50px; height:50px; border-radius:14px; justify-content:center;">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              </button>
              <button type="button" class="btn btn-white" onclick="exportProjectToPDF()" title="Exportar PDF" style="background:#f59e0b; color:#fff; border-color:#f59e0b; box-shadow:0 6px 14px rgba(245,158,11,0.35); width:50px; height:50px; border-radius:14px; justify-content:center;">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
              </button>
            </div>
          </div>
        </div>

        <div class="project-kpis">
        <div class="kpi-card">
          <div>
            <div class="kpi-title" style="display:flex; align-items:center; gap:6px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              Progreso
            </div>
            <div class="kpi-sub" id="kpi-progress-dates">Fechas clave</div>
          </div>
          <div class="kpi-value" id="kpi-progress">0%</div>
        </div>
        <div class="kpi-card">
          <div>
            <div class="kpi-title" style="display:flex; align-items:center; gap:6px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              Permisos
            </div>
            <div class="kpi-sub">Estado permisos/inspecciones</div>
          </div>
          <div class="kpi-badge" id="kpi-permits">En revisión</div>
        </div>
        <div class="kpi-card">
          <div>
            <div class="kpi-title" style="display:flex; align-items:center; gap:6px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
              Horas laborales
            </div>
            <div class="kpi-sub">Plan vs real</div>
          </div>
          <div class="kpi-value" id="kpi-hours">0h</div>
        </div>
        <div class="kpi-card">
          <div>
            <div class="kpi-title" style="display:flex; align-items:center; gap:6px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12h6"/><path d="M9 16h6"/><path d="M9 8h6"/><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
              SLA / Riesgos
            </div>
            <div class="kpi-sub">Cumplimiento y alertas</div>
          </div>
          <div class="kpi-badge" id="kpi-sla">En objetivo</div>
        </div>
      </div>

        <div class="quick-gallery" id="quickGallery">
          <!-- fotos rápidas -->
        </div>

        <div class="portal-container">
    
    <!-- TABS Y THREADSYNC -->
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 24px;">
      <div class="tabs" style="margin-bottom: 0; flex: 1;">
        <button type="button" class="tab active" onclick="switchTab('overview')">Resumen</button>
        <button type="button" class="tab" onclick="switchTab('info')">Información</button>
        <button type="button" class="tab" onclick="switchTab('schedule')">Programación</button>
        <button type="button" class="tab" onclick="switchTab('daily')">FormSync</button>
        <button type="button" class="tab" onclick="switchTab('team')">Equipo</button>
        <button type="button" class="tab" onclick="switchTab('photos')">Fotos</button>
        <button type="button" class="tab" onclick="switchTab('docs')">Documentos</button>
      </div>
      
      <!-- Botón ThreadSync separado -->
      <button type="button" onclick="openThreadSync()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); white-space: nowrap; backdrop-filter: blur(10px);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'; this.style.background='linear-gradient(135deg, #059669 0%, #047857 100%)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(16, 185, 129, 0.25)'; this.style.background='linear-gradient(135deg, #10b981 0%, #059669 100%)';">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <span>Abrir ThreadSync</span>
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
          <polyline points="15 3 21 3 21 9"/>
          <line x1="10" y1="14" x2="21" y2="3"/>
        </svg>
      </button>
    </div>

    <!-- TAB: INFORMACIÓN -->
    <div id="tab-info" class="tab-content">
      <div style="margin-bottom:12px;">
        <h3 style="margin:0; font-size:16px; font-weight:700; color:#0f172a;">Ficha completa del proyecto</h3>
        <p style="margin:0; color:#64748b; font-size:13px;">Datos comerciales, operativos y de contacto</p>
      </div>
      <div class="grid grid-2">
        <div class="card">
          <h3 class="card-title">Datos del Proyecto</h3>
          <p class="card-subtitle">Detalles generales</p>
          <div class="grid grid-2" style="margin-top: 12px;">
            <div>
              <div class="kpi-sub">ID Sync</div>
              <div class="kpi-title" id="info-id">-</div>
            </div>
            <div>
              <div class="kpi-sub">Cliente</div>
              <div class="kpi-title" id="info-client">-</div>
            </div>
            <div>
              <div class="kpi-sub">Dirección</div>
              <div class="kpi-title" id="info-address">-</div>
            </div>
            <div>
              <div class="kpi-sub">Estado</div>
              <div class="kpi-title" id="info-status">-</div>
            </div>
            <div>
              <div class="kpi-sub">Tipo de servicio</div>
              <div class="kpi-title" id="info-service">-</div>
            </div>
            <div>
              <div class="kpi-sub">Monto estimado</div>
              <div class="kpi-title" id="info-budget">-</div>
            </div>
            <div>
              <div class="kpi-sub">Contacto</div>
              <div class="kpi-title" id="info-contact">-</div>
            </div>
            <div>
              <div class="kpi-sub">Teléfono</div>
              <div class="kpi-title" id="info-phone">-</div>
            </div>
            <div>
              <div class="kpi-sub">Email</div>
              <div class="kpi-title" id="info-email">-</div>
            </div>
            <div>
              <div class="kpi-sub">Plan</div>
              <div class="kpi-title" id="info-plan">-</div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title">Fechas y responsables</h3>
          <p class="card-subtitle">Planificación actual</p>
          <div class="grid grid-2" style="margin-top: 12px;">
            <div>
              <div class="kpi-sub">Inicio</div>
              <div class="kpi-title" id="info-start">-</div>
            </div>
            <div>
              <div class="kpi-sub">Fin</div>
              <div class="kpi-title" id="info-end">-</div>
            </div>
            <div>
              <div class="kpi-sub">Duración</div>
              <div class="kpi-title" id="info-duration">-</div>
            </div>
            <div>
              <div class="kpi-sub">Supervisor</div>
              <div class="kpi-title" id="info-supervisor">-</div>
            </div>
            <div>
              <div class="kpi-sub">Creado por</div>
              <div class="kpi-title" id="info-owner">-</div>
            </div>
            <div>
              <div class="kpi-sub">SLA / Prioridad</div>
              <div class="kpi-title" id="info-sla">-</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: DIARIO / FORMSYNC -->
    <div id="tab-daily" class="tab-content">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:12px;">
        <div>
          <h3 style="margin:0; font-size:16px; font-weight:700; color:#0f172a;">FormSync</h3>
          <p style="margin:0; color:#64748b; font-size:13px;">Reportes diarios y formularios configurables</p>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" class="btn btn-primary" onclick="toggleFormSyncForm(true)" style="padding:10px 14px; border-radius:12px; box-shadow:0 6px 16px rgba(2,115,94,0.2); display:flex; align-items:center; gap:8px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Agregar Form
          </button>
          <button type="button" class="btn btn-white" onclick="configureFormSync()" style="padding:10px 12px; border-radius:12px;">Configurar Formularios</button>
        </div>
      </div>
      <div class="card" id="formSyncForm" style="margin-bottom: 16px; display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
          <h3 class="card-title" style="margin-bottom:0;">Nuevo FormSync</h3>
          <button type="button" class="btn btn-white" onclick="toggleFormSyncForm(false)" style="padding:8px 12px;">Cerrar</button>
        </div>
        <div class="grid grid-2" style="gap: 12px; margin-top: 10px;">
          <div>
            <label class="kpi-sub">Fecha</label>
            <input type="date" id="daily-date" class="form-input" />
          </div>
          <div data-formsync-field="crew">
            <label class="kpi-sub">Equipo (separar por coma)</label>
            <input type="text" id="daily-crew" class="form-input" placeholder="Juan, Ana" />
          </div>
          <div data-formsync-field="hours">
            <label class="kpi-sub">Horas totales</label>
            <input type="text" id="daily-hours" class="form-input" placeholder="8h" />
          </div>
          <div data-formsync-field="weather">
            <label class="kpi-sub">Clima</label>
            <input type="text" id="daily-weather" class="form-input" placeholder="Soleado 25°C" />
          </div>
          <div data-formsync-field="start">
            <label class="kpi-sub">Inicio</label>
            <input type="time" id="daily-start" class="form-input" />
          </div>
          <div data-formsync-field="end">
            <label class="kpi-sub">Fin</label>
            <input type="time" id="daily-end" class="form-input" />
          </div>
          <div data-formsync-field="crewCount">
            <label class="kpi-sub">Crew (número)</label>
            <input type="number" id="daily-crew-count" class="form-input" min="1" placeholder="5" />
          </div>
          <div data-formsync-field="photo">
            <label class="kpi-sub">Foto (URL opcional)</label>
            <input type="text" id="daily-photo" class="form-input" placeholder="https://...jpg" />
          </div>
        </div>
        <div data-formsync-field="work">
          <label class="kpi-sub" style="margin-top: 10px;">Trabajo realizado</label>
          <textarea id="daily-work" class="form-textarea" rows="2" placeholder="Descripción del trabajo..."></textarea>
        </div>
        <div data-formsync-field="materials">
          <label class="kpi-sub" style="margin-top: 10px;">Materiales usados</label>
          <textarea id="daily-materials" class="form-textarea" rows="2" placeholder="Listado breve de materiales"></textarea>
        </div>
        <div data-formsync-field="safety">
          <label class="kpi-sub" style="margin-top: 10px;">Seguridad / incidencias</label>
          <textarea id="daily-safety" class="form-textarea" rows="2" placeholder="Incidentes, EPP, observaciones"></textarea>
        </div>
        <div data-formsync-field="notes">
          <label class="kpi-sub" style="margin-top: 10px;">Notas</label>
          <textarea id="daily-notes" class="form-textarea" rows="2" placeholder="Notas adicionales"></textarea>
        </div>
        <div style="display:flex; justify-content:flex-end; margin-top:12px; gap:10px; flex-wrap:wrap;">
          <button type="button" class="btn btn-white" onclick="resetDailyForm()">Limpiar</button>
          <button type="button" class="btn btn-primary" onclick="saveDailyLog()">Guardar FormSync</button>
        </div>
      </div>
      <div class="card" style="margin-top:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <h3 style="margin:0; font-size:16px; font-weight:700; color:#0f172a;">Historial FormSync</h3>
          <button type="button" class="btn btn-white" onclick="configureFormSync()" style="padding:6px 10px; border-radius:10px;">Configurar</button>
        </div>
        <div class="grid grid-2" id="dailyLogsContainer"></div>
      </div>
    </div>

    <!-- TAB: RESUMEN -->
    <div id="tab-overview" class="tab-content active">
      
      <!-- Timeline Amplia -->
      <div class="card" style="margin-bottom: 20px; padding: 16px 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <div>
            <h3 style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 2px;">Progreso del Proyecto</h3>
            <p id="progress-dates" style="font-size: 12px; color: var(--text-secondary);">Cargando...</p>
          </div>
          <div style="text-align: right;">
            <div id="progress-percent" style="font-size: 24px; font-weight: 700; color: #10b981;">0%</div>
            <div id="progress-day" style="font-size: 11px; color: var(--text-secondary);">Calculando...</div>
          </div>
        </div>
        
        <div style="position: relative; height: 40px; background: #e5e7eb; border-radius: 20px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);">
          <div id="progress-bar" style="position: absolute; height: 100%; width: 0%; background: linear-gradient(90deg, #10b981, #059669); border-radius: 20px; display: flex; align-items: center; justify-content: flex-end; padding-right: 20px; transition: width 0.5s ease;">
            <span id="progress-hours" style="color: white; font-size: 15px; font-weight: 600;"></span>
          </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
          <span id="progress-completed">🟢 Calculando...</span>
          <span id="progress-remaining">⏰ Calculando...</span>
        </div>
      </div>

<!-- Estado + Flujo en paralelo -->
      <div class="grid-2" style="gap:16px; margin-bottom:20px;">
        <div class="card" style="padding: 20px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 2px solid #e2e8f0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div>
              <h3 style="font-size: 15px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 6v6l4 2"/>
                </svg>
                Estado Actual
              </h3>
              <p style="font-size: 12px; color: #64748b;">Estado operativo del proyecto</p>
            </div>
            <button type="button" onclick="changeProjectState()" id="btnChangeState" style="background: rgba(2, 115, 94, 0.1); color: #02735E; border: 1px solid rgba(2, 115, 94, 0.3); padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='rgba(2, 115, 94, 0.15)'" onmouseout="this.style.background='rgba(2, 115, 94, 0.1)';">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="1 4 1 10 7 10"/>
                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
              </svg>
              Cambiar Estado
            </button>
          </div>
          <div id="currentStateBadge" style="text-align: center; padding: 24px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div style="font-size: 48px; margin-bottom: 12px;" id="badgeEmoji">⏳</div>
            <div style="font-size: 22px; font-weight: 700; color: #1e293b; margin-bottom: 8px;" id="badgeTitle">Estado</div>
            <div style="font-size: 13px; color: #64748b;" id="badgeSubtitle">Descripción del estado</div>
          </div>
        </div>

        <div class="card" style="padding: 20px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 2px solid #e2e8f0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div>
              <h3 style="font-size: 15px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 6v6l4 2"/>
                </svg>
                Flujo del Proyecto
              </h3>
              <p style="font-size: 12px; color: #64748b;">Estados operativos del proyecto</p>
            </div>
          </div>
          <div id="workflowRow" style="margin-top: 0; padding: 16px; background: rgba(255,255,255,0.7); border-radius: 10px;"></div>
        </div>
      </div>
    </div>

    <!-- TAB: PROGRAMACIÓN -->
    <div id="tab-schedule" class="tab-content">
      <!-- Timeline Visual tipo Gantt -->
      <div class="timeline-container">
        <div class="timeline-header">
          <div>
            <h3 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
              </svg>
              Timeline del Proyecto
            </h3>
            <p style="font-size: 13px; color: var(--text-secondary);">Visualización de fases, milestones y progreso</p>
          </div>
          <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button type="button" class="btn btn-white" onclick="setTimelineView('phase')" style="padding:8px 10px;">Fases</button>
              <button type="button" class="btn btn-white" onclick="setTimelineView('week')" style="padding:8px 10px;">Semanal</button>
              <button type="button" class="btn btn-white" onclick="setTimelineView('day')" style="padding:8px 10px;">Diario</button>
              <button type="button" class="btn btn-white" onclick="setTimelineView('month')" style="padding:8px 10px;">Mensual</button>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button type="button" class="btn btn-primary" onclick="quickAddTimelinePhase()" style="display:flex; align-items:center; gap:8px; background:#02735E; border-color:#02735E;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                + Fase
              </button>
              <button type="button" class="btn btn-white" onclick="editTimeline()" style="display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Editar Timeline
              </button>
            </div>
          </div>
        </div>

        <div id="timelineChart">
          <!-- Timeline se renderiza dinámicamente -->
        </div>

        <div class="timeline-legend">
          <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #10b981, #059669);"></div>
            <span>Completado</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #f59e0b, #d97706);"></div>
            <span>En Progreso</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #94a3b8, #64748b);"></div>
            <span>Pendiente</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #ef4444, #dc2626);"></div>
            <span>Cancelado/Retrasado</span>
          </div>
          <div class="legend-item">
            <div style="width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid #8b5cf6;"></div>
            <span>Milestone</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
          <h3 class="card-title" style="margin:0;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            Programación Detallada del Proyecto
          </h3>
          <button type="button" class="btn btn-primary" onclick="editSchedule()" style="padding:8px 12px; border-radius:10px; display:flex; gap:6px; align-items:center;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Agregar programación
          </button>
        </div>
        <div id="schedule-blocks" style="margin-top:24px; display:grid; gap:16px;"></div>
      </div>
    </div>

    <!-- TAB: EQUIPO -->
    <div id="tab-team" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 class="card-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            Personal Asignado al Proyecto
          </h3>
          <button type="button" class="btn btn-primary" onclick="openAssignStaffModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="8.5" cy="7" r="4"/>
              <line x1="20" y1="8" x2="20" y2="14"/>
              <line x1="23" y1="11" x2="17" y2="11"/>
            </svg>
            Asignar Personal
          </button>
        </div>

        <div id="assignedTeamList">
          <!-- El equipo asignado se renderiza dinámicamente aquí -->
        </div>
      </div>
    </div>

    <!-- Modal: Asignar Personal -->
    <div id="assignStaffModal" style="display: none;">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h3>Asignar Personal al Proyecto</h3>
          <button type="button" class="modal-close" onclick="closeAssignStaffModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 24px;">
          <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
            Selecciona el personal disponible para asignar a este proyecto. Puedes asignar roles específicos a cada miembro del equipo.
          </p>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary);">Buscar Personal</label>
            <input 
              type="text" 
              id="staffSearchInput" 
              placeholder="Buscar por nombre, email o rol..." 
              style="width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;"
              onkeyup="filterStaffList()"
            />
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display:block; font-weight:600; margin-bottom:6px; font-size:13px; color:var(--text-secondary);">Fase / Día asignación (opcional)</label>
            <input type="text" id="assignPhaseInput" class="form-input" placeholder="Ej: Instalación - Día 2">
          </div>

          <div style="background: var(--bg-body); border-radius: 12px; padding: 12px; max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color);">
            <div id="availableStaffList">
              <!-- Lista de staff disponible se renderiza aquí -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-white" onclick="closeAssignStaffModal()">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="saveStaffAssignments()">Guardar Asignaciones</button>
        </div>
      </div>
    </div>

    <!-- TAB: FOTOS -->
    <div id="tab-photos" class="tab-content">
      <div class="card" style="padding: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <div>
            <h3 class="card-title" style="margin-bottom: 4px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21 15 16 10 5 21"/>
              </svg>
              Galería de Evidencias
            </h3>
            <p style="font-size: 13px; color: var(--text-secondary);">Fotos organizadas por categoría del proyecto</p>
          </div>
          <button type="button" class="btn btn-primary" onclick="openUploadPhotoModal()" style="display: flex; align-items: center; gap: 8px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            Subir Foto
          </button>
        </div>

        <!-- Filtros de categoría -->
        <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
          <button type="button" class="photo-filter active" data-category="all" onclick="filterPhotos('all')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: linear-gradient(135deg, #02735E, #035951); color: white; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
            Todas (<span id="count-all">0</span>)
          </button>
          <button type="button" class="photo-filter" data-category="before" onclick="filterPhotos('before')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: white; color: #64748b; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
            📷 Antes (<span id="count-before">0</span>)
          </button>
          <button type="button" class="photo-filter" data-category="during" onclick="filterPhotos('during')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: white; color: #64748b; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
            🔧 En Proceso (<span id="count-during">0</span>)
          </button>
          <button type="button" class="photo-filter" data-category="after" onclick="filterPhotos('after')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: white; color: #64748b; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
            ✅ Después (<span id="count-after">0</span>)
          </button>
          <button type="button" class="photo-filter" data-category="defect" onclick="filterPhotos('defect')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: white; color: #64748b; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
            ⚠️ Defectos (<span id="count-defect">0</span>)
          </button>
          <button type="button" class="photo-filter" data-category="completion" onclick="filterPhotos('completion')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: white; color: #64748b; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
            📋 Entrega (<span id="count-completion">0</span>)
          </button>
        </div>
        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:20px; align-items:flex-end;">
          <div style="flex:1; min-width:200px;">
            <label style="display:block; font-size:12px; font-weight:600; color:#64748b; margin-bottom:6px;">Proyecto</label>
            <select id="photoProjectFilter" onchange="handlePhotoProjectChange(this)" style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:14px;">
              <option value="">Cargando proyectos...</option>
            </select>
          </div>
          <div style="flex:1; min-width:200px;">
            <label style="display:block; font-size:12px; font-weight:600; color:#64748b; margin-bottom:6px;">Fase</label>
            <select id="photoPhaseFilter" onchange="handlePhotoPhaseChange(this)" style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:14px;">
              <option value="all">Todas las fases</option>
            </select>
          </div>
          <div style="min-width:180px;">
            <label style="display:block; font-size:12px; font-weight:600; color:#64748b; margin-bottom:6px;">Fecha de captura</label>
            <input type="date" id="photoDateFilter" onchange="handlePhotoDateChange(this)" style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:14px;">
          </div>
          <button type="button" class="btn btn-white" onclick="resetPhotoFilters()" style="height:42px; padding:0 18px; border:1px solid #e5e7eb;">Limpiar filtros</button>
          <button type="button" class="btn btn-secondary" onclick="downloadSelectedPhotos()" style="height:42px; padding:0 22px; display:flex; align-items:center; gap:6px;">
            Descargar selección (<span id="photoSelectionCount">0</span>)
          </button>
        </div>

        <!-- Grid de fotos -->
        <div id="photo-gallery-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; min-height: 200px;">
          <!-- Las fotos se cargarán dinámicamente aquí -->
          <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #94a3b8;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px;">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            <p style="font-size: 15px; font-weight: 500; margin-bottom: 8px;">No hay fotos en este proyecto</p>
            <p style="font-size: 13px; color: #cbd5e1;">Sube fotos para documentar el progreso del trabajo</p>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: DOCUMENTOS -->
    <div id="tab-docs" class="tab-content">
      <div class="card" style="padding: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <div>
            <h3 class="card-title" style="margin-bottom: 4px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                <polyline points="13 2 13 9 20 9"/>
              </svg>
              Biblioteca de Documentos
            </h3>
            <p style="font-size: 13px; color: var(--text-secondary);">Archivos organizados por categoría del proyecto</p>
          </div>
          <button type="button" class="btn btn-primary" onclick="openUploadDocumentModal()" style="display: flex; align-items: center; gap: 8px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            Subir Documento
          </button>
        </div>

        <!-- Filtros de categoría -->
        <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
          <button type="button" class="doc-filter active" data-category="all" onclick="filterDocuments('all')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: linear-gradient(135deg, #02735E, #035951); color: white; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
            Todos (<span id="doc-count-all">0</span>)
          </button>
          <button type="button" class="doc-filter" data-category="contrato" onclick="filterDocuments('contrato')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: white; color: #64748b; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
            📄 Contratos (<span id="doc-count-contrato">0</span>)
          </button>
          <button type="button" class="doc-filter" data-category="permiso" onclick="filterDocuments('permiso')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: white; color: #64748b; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
            📋 Permisos (<span id="doc-count-permiso">0</span>)
          </button>
          <button type="button" class="doc-filter" data-category="factura" onclick="filterDocuments('factura')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: white; color: #64748b; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
            💰 Facturas (<span id="doc-count-factura">0</span>)
          </button>
          <button type="button" class="doc-filter" data-category="plano" onclick="filterDocuments('plano')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: white; color: #64748b; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
            📐 Planos (<span id="doc-count-plano">0</span>)
          </button>
          <button type="button" class="doc-filter" data-category="manual" onclick="filterDocuments('manual')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: white; color: #64748b; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
            📚 Manuales (<span id="doc-count-manual">0</span>)
          </button>
          <button type="button" class="doc-filter" data-category="otro" onclick="filterDocuments('otro')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: white; color: #64748b; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
            📎 Otros (<span id="doc-count-otro">0</span>)
          </button>
          <button type="button" class="doc-filter" data-category="daily" onclick="filterDocuments('daily')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: white; color: #64748b; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
            📝 FormSync (<span id="doc-count-daily">0</span>)
          </button>
        </div>

        <!-- Lista de documentos -->
        <div id="documents-list" style="display: grid; gap: 12px; min-height: 200px;">
          <!-- Los documentos se cargarán dinámicamente aquí -->
          <div style="text-align: center; padding: 60px 20px; color: #94a3b8;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px;">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
              <polyline points="13 2 13 9 20 9"/>
            </svg>
            <p style="font-size: 15px; font-weight: 500; margin-bottom: 8px;">No hay documentos en este proyecto</p>
            <p style="font-size: 13px; color: #cbd5e1;">Sube documentos para mantener toda la información organizada</p>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    console.log('🔧 ViewSync JavaScript loaded - v2024-11-25');
    
    // Global variable for linked thread ID
    window.linkedThreadId = null;
    let timelineView = 'phase';
    const DAY_IN_MS = 24 * 60 * 60 * 1000;

    function toInputDate(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      return date.toISOString().slice(0, 10);
    }

    function addDays(value, days) {
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return null;
      const copy = new Date(date);
      copy.setDate(copy.getDate() + (days || 0));
      return copy;
    }

    function parseInputDate(value) {
      if (!value) return null;
      const date = new Date(value);
      return Number.isNaN(date.getTime()) ? null : date;
    }

    function diffInDays(start, end) {
      if (!start || !end) return 0;
      const startDate = new Date(start);
      const endDate = new Date(end);
      if (Number.isNaN(startDate.getTime()) || Number.isNaN(endDate.getTime())) return 0;
      return Math.round((endDate - startDate) / DAY_IN_MS);
    }

    function formatShortDate(value) {
      const date = parseInputDate(value);
      if (!date) return '—';
      return date.toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function loadDailyLogsForProject(project) {
      if (!project) return [];
      const key = `daily_logs_${project.idSync || project.id}`;
      try {
        return JSON.parse(localStorage.getItem(key) || '[]');
      } catch (error) {
        console.warn('No se pudieron cargar los diarios', error);
        return [];
      }
    }

    function parseHoursValue(value) {
      if (typeof value === 'number') return value;
      if (!value) return 0;
      const match = String(value).match(/([\d.]+)/);
      return match ? Number(match[1]) : 0;
    }

    function loadTimelineSnapshot(project) {
      if (!project) return null;
      const key = `project_timeline_${project.idSync || project.id}`;
      try {
        return JSON.parse(localStorage.getItem(key) || 'null');
      } catch (error) {
        console.warn('Timeline corrupto, usando null', error);
        return null;
      }
    }

    function computePlannedHours(project, timeline) {
      if (!project) return 0;
      if (project.plannedHours) return Number(project.plannedHours);
      const start = timeline?.startDate || project.startDate;
      const end = timeline?.endDate || project.endDate;
      if (start && end) {
        return (diffInDays(start, end) + 1) * 8;
      }
      return 0;
    }

    const scheduleDragState = { dragged: null };
    const photoFilters = { projectId: null, category: 'all', phase: 'all', date: 'all' };
    const selectedPhotoIds = new Set();
    const HERO_TITLE_SIZE_KEY = 'viewsync_hero_title_size';

    function applyHeroTitleSize(mode) {
      const hero = document.querySelector('.project-hero');
      if (!hero) return;
      const normalized = mode === 'lg' ? 'lg' : 'md';
      hero.dataset.titleSize = normalized;
      const toggle = document.getElementById('heroSizeToggle');
      if (toggle) {
        toggle.setAttribute('aria-pressed', normalized === 'lg');
        toggle.setAttribute('title', normalized === 'lg' ? 'Reducir tamaño del título' : 'Ampliar tamaño del título');
      }
    }

    function toggleHeroTitleSize() {
      const hero = document.querySelector('.project-hero');
      if (!hero) return;
      const current = hero.dataset.titleSize === 'lg' ? 'lg' : 'md';
      const next = current === 'lg' ? 'md' : 'lg';
      localStorage.setItem(HERO_TITLE_SIZE_KEY, next);
      applyHeroTitleSize(next);
    }

    function initHeroTitleSize() {
      const saved = localStorage.getItem(HERO_TITLE_SIZE_KEY) || 'md';
      applyHeroTitleSize(saved);
    }
    let cachedSchedulePhases = [];
    let cachedProjectOptions = [];

    function ensureProjectSchedule(project) {
      if (!project) return [];
      const key = `project_schedule_${project.idSync || project.id}`;
      let phases = [];
      try {
        phases = JSON.parse(localStorage.getItem(key) || '[]');
      } catch (err) {
        phases = [];
      }
      if (phases.length) {
        cachedSchedulePhases = phases;
        return phases;
      }
      const baseStart = project.startDate ? new Date(project.startDate) : new Date();
      const template = [
        { title: 'Inspección inicial', offset: 0, duration: 2, status: 'completed', notes: 'Visita y diagnósticos' },
        { title: 'Instalación principal', offset: 2, duration: 3, status: 'in-progress', notes: 'Montaje y pruebas' },
        { title: 'Ajustes y QA', offset: 5, duration: 2, status: 'pending', notes: 'Calibración final' },
        { title: 'Entrega y cierre', offset: 7, duration: 1, status: 'pending', notes: 'Cliente firma aceptación' }
      ];
      const computed = template.map((item) => {
        const start = toInputDate(addDays(baseStart, item.offset));
        const end = toInputDate(addDays(start, item.duration - 1));
        return {
          title: item.title,
          start,
          end,
          status: item.status,
          notes: item.notes
        };
      });
      localStorage.setItem(key, JSON.stringify(computed));
      syncScheduleToTimeline(computed);
      cachedSchedulePhases = computed;
      return computed;
    }

    function scheduleRowTemplate(phase, idx) {
      const title = phase.title || '';
      const start = phase.start || '';
      const end = phase.end || '';
      const status = phase.status || 'pending';
      const notes = phase.notes || '';
      return `
        <div class="sch-row-wrapper" data-idx="${idx}">
          <div class="sch-row" data-idx="${idx}" style="display:grid; grid-template-columns:auto 2fr 1fr 1fr 1fr; gap:8px; align-items:center;">
            <button type="button" class="drag-handle" aria-label="Reordenar etapa" draggable="true">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="7" cy="5" r="1"></circle>
                <circle cx="7" cy="12" r="1"></circle>
                <circle cx="7" cy="19" r="1"></circle>
                <circle cx="17" cy="5" r="1"></circle>
                <circle cx="17" cy="12" r="1"></circle>
                <circle cx="17" cy="19" r="1"></circle>
              </svg>
            </button>
            <input class="form-input" data-field="title" value="${title}" placeholder="Etapa">
            <input class="form-input" data-field="start" type="date" value="${start}">
            <input class="form-input" data-field="end" type="date" value="${end}">
            <select class="form-select" data-field="status">
              <option value="pending" ${status === 'pending' ? 'selected' : ''}>Pendiente</option>
              <option value="in-progress" ${status === 'in-progress' ? 'selected' : ''}>En Proceso</option>
              <option value="completed" ${status === 'completed' ? 'selected' : ''}>Completado</option>
            </select>
          </div>
          <input class="form-input sch-note" data-field="notes" placeholder="Notas" value="${notes}">
        </div>
      `;
    }

    function attachScheduleRowInteractions(wrapper) {
      if (!wrapper) return;
      wrapper.addEventListener('dragover', scheduleDragOver);
      wrapper.addEventListener('drop', scheduleDragDrop);
      const handle = wrapper.querySelector('.drag-handle');
      if (handle) {
        handle.addEventListener('dragstart', scheduleDragStart);
        handle.addEventListener('dragend', scheduleDragEnd);
      }
    }

    function initScheduleDrag(container) {
      if (!container) return;
      container.querySelectorAll('.sch-row-wrapper').forEach(attachScheduleRowInteractions);
    }

    function reindexScheduleRows(container) {
      if (!container) return;
      container.querySelectorAll('.sch-row-wrapper').forEach((wrapper, index) => {
        wrapper.dataset.idx = index;
        wrapper.querySelectorAll('[data-field]').forEach((field) => {
          field.dataset.idx = index;
        });
      });
    }

    function scheduleDragStart(event) {
      const wrapper = event.currentTarget.closest('.sch-row-wrapper');
      if (!wrapper) return;
      scheduleDragState.dragged = wrapper;
      wrapper.classList.add('dragging');
      if (event.dataTransfer) {
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', '');
      }
    }

    function scheduleDragOver(event) {
      event.preventDefault();
      const target = event.currentTarget;
      const dragged = scheduleDragState.dragged;
      if (!dragged || target === dragged) return;
      const container = target.parentElement;
      const rect = target.getBoundingClientRect();
      const shouldPlaceAfter = (event.clientY - rect.top) > rect.height / 2;
      container.insertBefore(dragged, shouldPlaceAfter ? target.nextSibling : target);
    }

    function scheduleDragDrop(event) {
      event.preventDefault();
    }

    function scheduleDragEnd() {
      if (scheduleDragState.dragged) {
        scheduleDragState.dragged.classList.remove('dragging');
      }
      const container = document.querySelector('#scheduleModalOverlay #sch-rows');
      if (container) {
        reindexScheduleRows(container);
      }
      scheduleDragState.dragged = null;
    }

    function updateKpis(project) {
      if (!project) return;
      const timeline = loadTimelineSnapshot(project);
      const permitsEl = document.getElementById('kpi-permits');
      if (permitsEl) {
        const normalized = (project.permitsStatus || project.permitStatus || project.inspectionStatus || project.status || '').toString().toLowerCase();
        const permitLabels = {
          approved: 'Aprobados',
          completed: 'Aprobados',
          scheduled: 'Programados',
          pending: 'Pendientes',
          submitted: 'En revisión',
          reviewing: 'En revisión',
          rejected: 'Rechazados'
        };
        permitsEl.textContent = permitLabels[normalized] || (project.permitsStatus || project.status || 'Sin seguimiento');
      }

      const logs = loadDailyLogsForProject(project);
      const actualFromLogs = logs.reduce((sum, log) => sum + parseHoursValue(log.hours), 0);
      const actualHours = actualFromLogs || Number(project.actualHours) || 0;
      const plannedHours = computePlannedHours(project, timeline);
      const hoursEl = document.getElementById('kpi-hours');
      if (hoursEl) {
        if (plannedHours) {
          hoursEl.textContent = `${actualHours}h / ${plannedHours}h`;
        } else {
          hoursEl.textContent = `${actualHours}h`;
        }
      }

      const slaEl = document.getElementById('kpi-sla');
      if (slaEl) {
        const sla = project.sla || project.priority || 'Standard';
        const alertsCount = Array.isArray(project.alerts) ? project.alerts.length : Number(project.alerts) || 0;
        const riskLabel = project.risk || project.riskLevel || 'En objetivo';
        slaEl.textContent = alertsCount > 0 ? `${sla} · ${alertsCount} alertas` : `${sla} · ${riskLabel}`;
      }

      const progressEl = document.getElementById('kpi-progress');
      const datesEl = document.getElementById('kpi-progress-dates');
      if (progressEl && datesEl && project.startDate && project.endDate) {
        const startDate = new Date(project.startDate);
        const endDate = new Date(project.endDate);
        const today = new Date();
        const total = Math.max(1, diffInDays(startDate, endDate) + 1);
        const elapsed = Math.max(0, diffInDays(startDate, today) + 1);
        const percent = Math.min(100, Math.max(0, Math.round((elapsed / total) * 100)));
        progressEl.textContent = `${percent}%`;
        datesEl.textContent = `${formatDate(project.startDate)} - ${formatDate(project.endDate)} · ${total} días`;
      }
    }

    function populateQuickGallery(project) {
      const container = document.getElementById('quickGallery');
      if (!container) return;
      container.innerHTML = '';
      const photos = loadProjectPhotos(resolveDefaultProjectId());
      if (photos && photos.length > 0) {
        photos.slice(0, 8).forEach((photo, idx) => {
          const div = document.createElement('div');
          div.className = 'photo-chip';
          div.innerHTML = `
            <img src="${photo.url}" alt="Foto ${idx + 1}">
            <div class="label">${photo.category || 'Foto'}</div>
          `;
          container.appendChild(div);
        });
      } else {
        ['Sin fotos', 'Captura progreso', 'Documenta avances'].forEach((txt, idx) => {
          const div = document.createElement('div');
          div.className = 'photo-chip';
          div.style.background = idx === 0 ? '#e2e8f0' : 'linear-gradient(135deg, rgba(2,115,94,0.12), rgba(2,115,94,0.05))';
          div.innerHTML = `<div class="label">${txt}</div>`;
          container.appendChild(div);
        });
      }
    }

    function renderDailyLogs(project) {
      const container = document.getElementById('dailyLogsContainer');
      if (!container) return;
      const storedLogs = loadDailyLogsForProject(project);
      const logs = (project?.dailyLogs && project.dailyLogs.length ? project.dailyLogs : storedLogs.length ? storedLogs : [
        {
          date: '2025-12-10',
          crew: ['Juan Pérez', 'Ana García'],
          hours: '8h',
          work: 'Instalación de ductos principales y sellado de uniones.',
          weather: 'Soleado 25°C',
          crewCount: 5,
          start: '08:00',
          end: '17:00',
          materials: 'Ductos 8", sellador, abrazaderas',
          safety: 'Sin incidentes',
          photos: ['https://images.unsplash.com/photo-1582719478248-04c0b58ad942?auto=format&fit=crop&w=400&q=80'],
          notes: 'Sin incidencias. Cliente aprobó avance.',
          signatures: [
            { name: 'Laura Mendoza', role: 'Supervisor de Proyecto' },
            { name: 'Carlos Rivera', role: 'Cliente / Propietario' }
          ]
        },
        {
          date: '2025-12-09',
          crew: ['Carlos Ruiz'],
          hours: '6h',
          work: 'Revisión de soportes y ajustes menores.',
          weather: 'Nublado 20°C',
          crewCount: 2,
          start: '09:00',
          end: '15:00',
          materials: 'Soportes, remaches',
          safety: 'Revisión EPP completa',
          photos: [],
          notes: 'Pendiente recibir válvulas nuevas.',
          signatures: [
            { name: 'Sofía Delgado', role: 'Coordinadora' }
          ]
        }
      ]);

      const template = loadFormTemplate();
      const fallbackSignatures = getSignatureFallbacks(template, project);
      window._latestDailyLogs = logs;
      container.innerHTML = logs.map((log, index) => {
        const crewChips = (log.crew || []).map(member => `<span class="kpi-badge" style="background: rgba(2,115,94,0.08); border-color: rgba(2,115,94,0.2);">${member}</span>`).join('');
        const photos = log.photos && log.photos.length ? `
          <div style="display:flex; gap:12px; overflow-x:auto; padding-top:8px;">
            ${log.photos.map((photo, idx) => `
              <div class="photo-chip" style="width:140px; height:90px;">
                <img src="${photo}" alt="Foto ${idx + 1}">
                <div class="label">Foto ${idx + 1}</div>
              </div>
            `).join('')}
          </div>
        ` : '';
        const materialChips = (log.materials || '').split(/[,;]/).map(item => item.trim()).filter(Boolean).map(item => `
          <span style="background: rgba(245,158,11,0.1); color:#b45309; padding:4px 10px; border-radius:999px; font-size:12px;">${item}</span>
        `).join('');
        const signatures = (log.signatures && log.signatures.length ? log.signatures : fallbackSignatures).map(sig => `
          <div style="display:flex; flex-direction:column; gap:2px;">
            <span style="font-weight:600; color:#0f172a;">${sig.name}</span>
            <span style="font-size:12px; color:#475569;">${sig.role}</span>
          </div>
        `).join('');

        return `
          <article class="card" style="padding:18px 20px; display:grid; gap:16px; border:1px solid rgba(2,115,94,0.08); box-shadow:0 16px 40px rgba(15,23,42,0.08);">
            <header style="display:flex; flex-wrap:wrap; gap:12px; justify-content:space-between; align-items:flex-start;">
              <div>
                <p style="margin:0; font-size:12px; color:#94a3b8;">Registro Diario</p>
                <h3 style="margin:4px 0 0; font-size:20px; color:#0f172a;">${formatDate(log.date)}</h3>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:8px; margin-top:10px;">
                  <div style="background:#f1f5f9; border-radius:10px; padding:10px;">
                    <div style="font-size:11px; text-transform:uppercase; letter-spacing:0.05em; color:#94a3b8;">Clima</div>
                    <div style="font-weight:600; color:#0f172a;">${log.weather || 'No registrado'}</div>
                  </div>
                  <div style="background:#f1f5f9; border-radius:10px; padding:10px;">
                    <div style="font-size:11px; text-transform:uppercase; letter-spacing:0.05em; color:#94a3b8;">Horas</div>
                    <div style="font-weight:600; color:#0f172a;">${log.hours || (log.start && log.end ? `${log.start} - ${log.end}` : 'N/A')}</div>
                  </div>
                  <div style="background:#f1f5f9; border-radius:10px; padding:10px;">
                    <div style="font-size:11px; text-transform:uppercase; letter-spacing:0.05em; color:#94a3b8;">Crew</div>
                    <div style="font-weight:600; color:#0f172a;">${log.crewCount || (log.crew ? log.crew.length : 0)} personas</div>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-white" onclick="exportDailyLog(${index})" style="display:flex; align-items:center; gap:8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 5v14"></path>
                  <path d="M18 13l-6 6-6-6"></path>
                </svg>
                Exportar PDF
              </button>
            </header>

            <section style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:16px;">
              <div style="background:#f8fafc; border-radius:12px; padding:14px;">
                <p style="margin:0; font-size:12px; font-weight:600; color:#94a3b8;">Trabajo Realizado</p>
                <p style="margin:8px 0 0; color:#0f172a;">${log.work || 'Sin descripción'}</p>
              </div>
              <div style="background:#ecfccb; border-radius:12px; padding:14px;">
                <p style="margin:0; font-size:12px; font-weight:600; color:#3f6212;">Seguridad</p>
                <p style="margin:8px 0 0; color:#1f2937;">${log.safety || 'Sin observaciones'}</p>
              </div>
              <div style="background:#fef9c3; border-radius:12px; padding:14px;">
                <p style="margin:0; font-size:12px; font-weight:600; color:#b45309;">Materiales</p>
                <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;">
                  ${materialChips || '<span style="color:#b45309;">No registrado</span>'}
                </div>
              </div>
            </section>

            <section style="display:grid; gap:12px;">
              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <span style="font-size:12px; font-weight:600; color:#94a3b8;">Crew</span>
                ${crewChips || '<span style="font-size:13px; color:#94a3b8;">Equipo no asignado</span>'}
                ${log.crewCount ? `<span class="kpi-badge" style="background: rgba(3,89,81,0.08); border-color: rgba(3,89,81,0.2);">Total: ${log.crewCount}</span>` : ''}
              </div>
              ${log.notes ? `<p style="font-size:13px; color:#475569;">${log.notes}</p>` : ''}
              ${photos}
            </section>

            <section style="display:flex; flex-direction:column; gap:8px;">
              <p style="margin:0; font-size:12px; font-weight:600; color:#94a3b8;">Firmas</p>
              <div style="display:flex; gap:20px; flex-wrap:wrap;">${signatures}</div>
            </section>
          </article>
        `;
      }).join('');
    }

    function exportDailyLog(index) {
      const log = (window._latestDailyLogs || [])[index];
      if (!log) {
        uiToast('error', 'No se encontró el registro solicitado.');
        return;
      }
      uiToast('success', `Generando PDF del ${formatDate(log.date)}... (demo)`);
      console.log('📄 Export daily log', log);
    }

    function renderWorkflowRow(stateKey) {
      const row = document.getElementById('workflowRow');
      if (!row) return;
      const resolved = PROJECT_STATES[stateKey] ? stateKey : 'quoted';
      const highlightKey = WORKFLOW_SEQUENCE.includes(resolved)
        ? resolved
        : resolved === 'overdue'
          ? 'in-progress'
          : 'quoted';
      const currentIndex = WORKFLOW_SEQUENCE.indexOf(highlightKey);
      row.innerHTML = `
        <div style="display: flex; align-items: stretch; gap: 12px; flex-wrap: wrap;">
          ${WORKFLOW_SEQUENCE.map((key, idx) => {
            const config = PROJECT_STATES[key];
            if (!config) return '';
            const isActive = key === highlightKey && currentIndex === idx;
            const isCompleted = currentIndex > idx;
            const background = isActive ? `${config.color}22` : '#ffffff';
            const borderColor = isActive ? config.color : isCompleted ? '#d1fae5' : '#e2e8f0';
            const labelColor = isActive ? '#0f172a' : '#475569';
            const iconColor = isActive ? '#fff' : '#475569';
            return `
              <div class="workflow-step ${isActive ? 'active' : ''}" data-state="${key}" style="
                flex: 1;
                min-width: 140px;
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px 16px;
                border-radius: 12px;
                border: 1px solid ${borderColor};
                background: ${background};
                box-shadow: ${isActive ? `0 6px 16px ${config.color}28` : 'none'};
                opacity: ${isCompleted || isActive ? 1 : 0.6};
              ">
                <span style="
                  width: 36px;
                  height: 36px;
                  border-radius: 12px;
                  background: ${isActive ? config.color : '#f1f5f9'};
                  display: inline-flex;
                  align-items: center;
                  justify-content: center;
                  color: ${iconColor};
                ">
                  ${config.icon}
                </span>
                <div>
                  <div style="font-weight: 700; color: ${labelColor};">${config.name}</div>
                  <div style="font-size: 12px; color: #94a3b8;">Paso ${idx + 1}</div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    // Function to open linked thread
    function openLinkedThread() {
      if (window.linkedThreadId) {
        console.log('🔗 Abriendo thread vinculado:', window.linkedThreadId);
        window.location.href = `threadsync.html?id=${window.linkedThreadId}`;
      } else {
        alert('⚠️ No se encontró el thread vinculado');
      }
    }
    
    // ========================================
    // LOAD PROJECT DATA DYNAMICALLY
    // ========================================
    let currentProject = null;
    
    function loadProjectData() {
      // Get project ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      let projectId = urlParams.get('id');
      
      // Load from localStorage
      const projects = JSON.parse(localStorage.getItem('projectsync_projects') || '[]');
      
      // Si no hay ID en URL, intentar cargar el proyecto más reciente activo
      if (!projectId) {
        const activeProjects = projects.filter(p => p.status === 'active');
        if (activeProjects.length > 0) {
          // Usar el proyecto activo más reciente
          const recentProject = activeProjects[0];
          projectId = recentProject.id || recentProject.idSync;
          console.log('🔄 No project ID in URL, loading most recent active:', projectId);
        } else if (projects.length > 0) {
          // Si no hay activos, usar el primero disponible
          projectId = projects[0].id || projects[0].idSync;
          console.log('🔄 No active projects, loading first available:', projectId);
        } else {
          alert('⚠️ No hay proyectos disponibles. Redirigiendo a ProjectSync...');
          window.location.href = 'projectsync.html';
          return null;
        }
      }
      
      const project = projects.find(p => p.id === projectId || p.idSync === projectId);
      
      if (!project) {
        alert('⚠️ Proyecto no encontrado. Redirigiendo a ProjectSync...');
        window.location.href = 'projectsync.html';
        return null;
      }
      
      console.log('✅ Project loaded:', project.name, project.idSync);
      return project;
    }
    
    function renderProjectData(project) {
      if (!project) return;

      const clientRecord = getClientRecord(project.clientId);
      const displayClient = project.client || project.clientName || clientRecord?.name || 'Cliente';
      ensureProjectSchedule(project);
      
      // Update title
      const titleElement = document.querySelector('.project-title');
      if (titleElement) {
        const projectName = project.name || project.projectName || 'Proyecto';
        titleElement.textContent = `${projectName} - ${displayClient}`;
      }
      
      // Hero background con cover si existe
      const hero = document.querySelector('.project-hero');
      if (hero) {
        if (project.cover) {
          hero.style.backgroundImage = `linear-gradient(135deg, rgba(2,115,94,0.94) 0%, rgba(3,89,81,0.92) 60%), url(${project.cover})`;
          hero.style.backgroundSize = 'cover';
          hero.style.backgroundPosition = 'center';
        } else {
          hero.style.backgroundImage = 'linear-gradient(135deg, #02735E 0%, #035951 90%)';
        }
      }
      
      // Update IDSync badge
      const idBadge = document.querySelector('.id-badge strong');
      if (idBadge) {
        idBadge.textContent = project.idSync || project.id;
      }
      
      // Update address
      const addressElement = document.getElementById('projectAddress');
      if (addressElement) {
        addressElement.querySelector('span').textContent = project.address || 'Sin dirección';
      }
      renderProjectInfo(project, clientRecord);
      renderProjectState(project);
      updateKpis(project);
      populateQuickGallery(project);
      console.log('✅ Project data rendered:', project);
    }
    
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
    }
    
    // ========================================
    // PROGRESS BAR - Sincronizado con fechas del proyecto
    // ========================================
    function updateProgressBar(project) {
      if (!project || !project.startDate || !project.endDate) {
        console.log('⚠️ No hay fechas de proyecto para calcular progreso');
        return;
      }
      
      const startDate = new Date(project.startDate);
      const endDate = new Date(project.endDate);
      const today = new Date();
      
      // Normalizar fechas a medianoche para cálculos precisos
      startDate.setHours(0, 0, 0, 0);
      endDate.setHours(0, 0, 0, 0);
      today.setHours(0, 0, 0, 0);
      
      // Calcular días totales y días transcurridos
      const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
      const daysElapsed = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
      const daysRemaining = Math.max(0, Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)));
      
      // Calcular porcentaje (limitar entre 0 y 100)
      let percent = Math.round((daysElapsed / totalDays) * 100);
      percent = Math.max(0, Math.min(100, percent));
      
      // Determinar si está antes, durante o después del proyecto
      let status = 'in-progress';
      let color = '#10b981'; // verde
      
      if (today < startDate) {
        status = 'not-started';
        percent = 0;
        color = '#6b7280'; // gris
      } else if (today > endDate) {
        status = 'overdue';
        percent = 100;
        color = '#ef4444'; // rojo
      }
      
      // Calcular horas estimadas (8 hrs por día)
      const totalHours = totalDays * 8;
      const hoursElapsed = Math.min(daysElapsed * 8, totalHours);
      
      // Actualizar elementos del DOM
      const progressDates = document.getElementById('progress-dates');
      const progressPercent = document.getElementById('progress-percent');
      const progressDay = document.getElementById('progress-day');
      const progressBar = document.getElementById('progress-bar');
      const progressHours = document.getElementById('progress-hours');
      const progressCompleted = document.getElementById('progress-completed');
      const progressRemaining = document.getElementById('progress-remaining');
      
      if (progressDates) {
        const startStr = formatDate(project.startDate);
        const endStr = formatDate(project.endDate);
        progressDates.textContent = `${startStr} - ${endStr} • ${totalDays} días`;
      }
      
      if (progressPercent) {
        progressPercent.textContent = `${percent}%`;
        progressPercent.style.color = color;
      }
      
      if (progressDay) {
        if (status === 'not-started') {
          progressDay.textContent = `Inicia en ${Math.abs(daysElapsed - 1)} días`;
        } else if (status === 'overdue') {
          const daysOver = Math.ceil((today - endDate) / (1000 * 60 * 60 * 24));
          progressDay.textContent = `${daysOver} días de retraso`;
          progressDay.style.color = '#ef4444';
        } else {
          progressDay.textContent = `Día ${Math.min(daysElapsed, totalDays)} de ${totalDays}`;
        }
      }
      
      if (progressBar) {
        progressBar.style.width = `${percent}%`;
        progressBar.style.background = `linear-gradient(90deg, ${color}, ${color}dd)`;
      }
      
      if (progressHours) {
        progressHours.textContent = `${hoursElapsed} de ${totalHours} hrs`;
      }
      
      if (progressCompleted) {
        const completedDays = Math.max(0, Math.min(daysElapsed, totalDays));
        progressCompleted.textContent = `🟢 ${completedDays} días completados`;
      }
      
      if (progressRemaining) {
        if (status === 'overdue') {
          progressRemaining.textContent = `⚠️ Proyecto vencido`;
          progressRemaining.style.color = '#ef4444';
        } else if (status === 'not-started') {
          progressRemaining.textContent = `⏰ ${totalDays} días totales`;
        } else {
          progressRemaining.textContent = `⏰ ${daysRemaining} días restantes`;
        }
      }
      
      // KPIs rápidos
      const kpiProgress = document.getElementById('kpi-progress');
      if (kpiProgress) kpiProgress.textContent = `${percent}%`;
      const kpiDates = document.getElementById('kpi-progress-dates');
      if (kpiDates) kpiDates.textContent = `${formatDate(project.startDate)} - ${formatDate(project.endDate)} · ${totalDays} días`;
      
      console.log('📊 Progress updated:', { percent, daysElapsed, totalDays, status });
    }

    function renderProjectInfo(project, clientRecord = null) {
      const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value || 'N/A';
      };

      setText('info-id', project.idSync || project.id || 'N/A');
      setText('info-client', clientRecord?.name || project.client || project.clientName || 'N/A');
      setText('info-address', project.address || clientRecord?.address || 'Sin dirección');
      setText('info-status', project.status || 'Activo');

      if (project.startDate) setText('info-start', formatDate(project.startDate));
      if (project.endDate) setText('info-end', formatDate(project.endDate));
      if (project.startDate && project.endDate) {
        const start = new Date(project.startDate);
        const end = new Date(project.endDate);
        const days = Math.max(1, Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1);
        setText('info-duration', `${days} días`);
      }

      setText('info-supervisor', project.supervisor || project.owner || 'No asignado');
      setText('info-service', project.serviceType || project.category || 'Operativo');
      setText('info-budget', project.budget ? `$${project.budget}` : 'No definido');
      setText('info-owner', project.createdBy || project.accountOwner || 'Opsis Suite');
      setText('info-sla', project.sla || project.priority || 'Estándar');
      setText('info-contact', clientRecord?.contact || project.contactName || project.clientContact || 'N/A');
      setText('info-phone', clientRecord?.phone || project.phone || project.contactPhone || 'N/A');
      setText('info-email', clientRecord?.email || project.email || project.contactEmail || 'N/A');
      setText('info-plan', project.plan || project.tier || 'MotorSync Base');
    }

    function saveDailyLog() {
      if (!currentProject) {
        showToast('warning', 'No hay proyecto activo para guardar el diario.');
        return;
      }

      const template = loadFormTemplate();
      const date = document.getElementById('daily-date')?.value || new Date().toISOString().slice(0, 10);
      const values = {
        crew: document.getElementById('daily-crew')?.value || '',
        hours: document.getElementById('daily-hours')?.value || '',
        weather: document.getElementById('daily-weather')?.value || '',
        start: document.getElementById('daily-start')?.value || '',
        end: document.getElementById('daily-end')?.value || '',
        crewCount: document.getElementById('daily-crew-count')?.value || '',
        photo: document.getElementById('daily-photo')?.value || '',
        work: document.getElementById('daily-work')?.value || '',
        materials: document.getElementById('daily-materials')?.value || '',
        safety: document.getElementById('daily-safety')?.value || '',
        notes: document.getElementById('daily-notes')?.value || ''
      };

      const missingRequired = FORMSYNC_FIELDS.filter((field) => (template.fields?.[field.key] || 'optional') === 'required')
        .filter((field) => !isFormFieldFilled(field.key, values[field.key]))
        .map((field) => field.label);

      if (!date) {
        missingRequired.unshift('Fecha');
      }

      if (missingRequired.length) {
        uiToast('error', `Completa los campos requeridos: ${missingRequired.join(', ')}`);
        return;
      }

      const crew = values.crew
        ? values.crew.split(',').map((member) => member.trim()).filter(Boolean)
        : [];
      const crewCount = values.crewCount ? Number(values.crewCount) : null;
      const photoList = values.photo ? [values.photo] : [];
      const signatures = getSignatureFallbacks(template, currentProject);

      const key = `daily_logs_${currentProject.idSync || currentProject.id}`;
      const logs = JSON.parse(localStorage.getItem(key) || '[]');
      const logEntry = {
        id: `LOG-${Date.now()}`,
        date,
        crew,
        hours: values.hours,
        weather: values.weather,
        start: values.start,
        end: values.end,
        crewCount,
        work: values.work,
        materials: values.materials,
        safety: values.safety,
        notes: values.notes,
        photos: photoList,
        signatures,
        templateConfig: template,
        createdAt: new Date().toISOString()
      };
      logs.unshift(logEntry);
      localStorage.setItem(key, JSON.stringify(logs));
      registerFormSyncDocument(logEntry);

      renderDailyLogs(currentProject);
      showToast('success', 'Reporte diario guardado.');
      resetDailyForm();
      applyFormTemplateToForm();
    }

    function toggleFormSyncForm(show) {
      const form = document.getElementById('formSyncForm');
      if (!form) return;
      form.style.display = show ? 'block' : 'none';
      if (show) {
        resetDailyForm();
        applyFormTemplateToForm();
      }
    }

    function configureFormSync() {
      const template = loadFormTemplate();
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      const fieldsHTML = FORMSYNC_FIELDS.map((field) => {
        const state = template.fields?.[field.key] || 'optional';
        return `
          <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; padding:10px 0; border-bottom:1px solid #f1f5f9;">
            <div>
              <p style="margin:0; font-size:14px; font-weight:600; color:#0f172a;">${field.label}</p>
              <p style="margin:2px 0 0; font-size:12px; color:#94a3b8;">Configura si es obligatorio, opcional u oculto</p>
            </div>
            <div style="display:flex; gap:12px; font-size:12px; color:#475569;">
              <label style="display:flex; gap:4px; align-items:center;">
                <input type="radio" name="fs-field-${field.key}" value="required" ${state === 'required' ? 'checked' : ''}>
                Obligatorio
              </label>
              <label style="display:flex; gap:4px; align-items:center;">
                <input type="radio" name="fs-field-${field.key}" value="optional" ${state === 'optional' ? 'checked' : ''}>
                Opcional
              </label>
              <label style="display:flex; gap:4px; align-items:center;">
                <input type="radio" name="fs-field-${field.key}" value="hidden" ${state === 'hidden' ? 'checked' : ''}>
                Oculto
              </label>
            </div>
          </div>
        `;
      }).join('');

      const signaturesHTML = FORMSYNC_SIGNATURE_OPTIONS.map((sig) => `
        <label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" id="fs-sign-${sig.key}" ${template.signatures?.[sig.key] ? 'checked' : ''}>
          ${sig.label}
        </label>
      `).join('');

      modal.innerHTML = `
        <div class="modal" style="max-width: 760px;">
          <div class="modal-header">
            <div class="modal-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3z"/><path d="M9 9h6v6H9z"/><path d="M9 3v6"/><path d="M15 15v6"/></svg>
              Configurar Formularios
            </div>
            <button type="button" class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
          </div>
          <div class="modal-body" style="display:grid; gap:16px;">
            <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:12px; font-size:13px; color:#475569;">
              Define qué campos serán obligatorios u opcionales para todos los formularios de esta compañía.
            </div>
            <div id="fs-template-preview" style="border:1px dashed rgba(2,115,94,0.3); border-radius:12px; padding:12px;"></div>
            <div style="display:grid; gap:12px; max-height:360px; overflow-y:auto; padding-right:6px;">
              ${fieldsHTML}
            </div>
            <div class="form-group">
              <label class="form-label">Firmas requeridas</label>
              <div style="display:flex; gap:16px; flex-wrap:wrap; font-size:13px;">
                ${signaturesHTML}
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-white" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
            <button class="btn btn-primary" id="fs-save-template">Guardar</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      renderFormSyncTemplatePreview(modal);
      modal.addEventListener('change', (event) => {
        if (event.target.name?.startsWith('fs-field-') || event.target.id?.startsWith('fs-sign-')) {
          renderFormSyncTemplatePreview(modal);
        }
      });

      modal.querySelector('#fs-save-template').addEventListener('click', () => {
        const updated = collectFormSyncTemplateFromModal(modal);
        saveFormTemplateConfig(updated);
        applyFormTemplateToForm();
        uiToast('success', 'Plantilla guardada');
        modal.remove();
      });
    }

    function resetDailyForm() {
      ['daily-date','daily-crew','daily-hours','daily-weather','daily-start','daily-end','daily-crew-count','daily-work','daily-materials','daily-safety','daily-notes','daily-photo']
        .forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = '';
        });
      const today = new Date().toISOString().slice(0,10);
      const dateEl = document.getElementById('daily-date');
      if (dateEl) dateEl.value = today;
    }

    // Semillas y render wrappers para mantener secciones pobladas
    function seedStaffData() {
      const existing = localStorage.getItem(STAFF_KEY);
      if (existing && JSON.parse(existing).length) return;
      const demo = [
        { id: 'STAFF-1', name: 'Juan Pérez', email: 'juan@opsis.demo', phone: '+52 55 1000 2000', role: 'supervisor' },
        { id: 'STAFF-2', name: 'Ana García', email: 'ana@opsis.demo', phone: '+52 55 3000 4000', role: 'tech' },
        { id: 'STAFF-3', name: 'Luis Romero', email: 'luis@opsis.demo', phone: '+52 55 5000 6000', role: 'admin' },
        { id: 'STAFF-4', name: 'Carla Méndez', email: 'carla@opsis.demo', phone: '+52 55 7000 8000', role: 'owner' }
      ];
      localStorage.setItem(STAFF_KEY, JSON.stringify(demo));
    }

    function renderTeamSection(project) {
      seedStaffData();
      const assignmentsKey = `project_staff_${project.idSync || project.id}`;
      const existing = JSON.parse(localStorage.getItem(assignmentsKey) || '[]');
      if (!existing.length) {
        const allStaff = JSON.parse(localStorage.getItem(STAFF_KEY) || '[]');
        const demoAssign = allStaff.slice(0, 2).map(s => ({ staffId: s.id, assignedDate: new Date().toISOString(), projectRole: null }));
        localStorage.setItem(assignmentsKey, JSON.stringify(demoAssign));
      }
      renderAssignedTeam();
    }

    function seedPhotoData() {
      const baseProjectId = resolveDefaultProjectId();
      const photos = loadProjectPhotos(baseProjectId);
      if (photos.length) return;
      const defaultPhases = cachedSchedulePhases.length ? cachedSchedulePhases : ensureProjectSchedule(currentProject);
      const firstPhase = defaultPhases[0]?.title || 'Inspección inicial';
      const secondPhase = defaultPhases[1]?.title || 'Instalación principal';
      const thirdPhase = defaultPhases[2]?.title || 'Pruebas';
      const demoPhotos = [
        { id: 'PHOTO-1', projectId: baseProjectId, category: 'before', caption: 'Condición inicial fachada', url: 'https://images.unsplash.com/photo-1503387762-592deb58ef4e?auto=format&fit=crop&w=800&q=80', uploadDate: new Date().toISOString(), captureDate: new Date().toISOString().slice(0,10), phaseName: firstPhase, phaseId: 'demo-1' },
        { id: 'PHOTO-2', projectId: baseProjectId, category: 'during', caption: 'Instalación ductos', url: 'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=800&q=80', uploadDate: new Date().toISOString(), captureDate: new Date().toISOString().slice(0,10), phaseName: secondPhase, phaseId: 'demo-2' },
        { id: 'PHOTO-3', projectId: baseProjectId, category: 'after', caption: 'Entrega preliminar', url: 'https://images.unsplash.com/photo-1497366754035-f200968a6e72?auto=format&fit=crop&w=800&q=80', uploadDate: new Date().toISOString(), captureDate: new Date().toISOString().slice(0,10), phaseName: thirdPhase, phaseId: 'demo-3' }
      ];
      saveProjectPhotos(demoPhotos, baseProjectId);
    }

    function renderPhotosSection(project) {
      ensurePhotoFilterDefaults();
      seedPhotoData();
      hydratePhotoFilterControls();
      renderPhotoGallery();
    }

    function seedDocumentData() {
      const docs = loadProjectDocuments();
      if (docs.length) return;
      const demoDocs = [
        { id: 'DOC-1', category: 'contrato', description: 'Contrato firmado', fileName: 'Contrato_Cliente.pdf', fileSize: 560000, fileType: 'application/pdf', url: '#', uploadDate: new Date().toISOString(), uploadedBy: 'Opsis Suite', origin: 'manual' },
        { id: 'DOC-2', category: 'permiso', description: 'Permiso municipal', fileName: 'Permiso_Municipal.pdf', fileSize: 230000, fileType: 'application/pdf', url: '#', uploadDate: new Date().toISOString(), uploadedBy: 'Opsis Suite', origin: 'manual' },
        { id: 'DOC-3', category: 'plano', description: 'Plano HVAC', fileName: 'Plano_HVAC.dwg', fileSize: 1200000, fileType: 'application/octet-stream', url: '#', uploadDate: new Date().toISOString(), uploadedBy: 'Opsis Suite', origin: 'manual' }
      ];
      saveProjectDocuments(demoDocs);
    }

    function renderDocsSection(project) {
      seedDocumentData();
      renderDocumentsList();
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      currentProject = loadProjectData();
      if (currentProject) {
        currentFormTemplate = null;
        loadFormTemplate();
        ensureProjectSchedule(currentProject);
        renderProjectData(currentProject);
        updateProgressBar(currentProject);
        initializeProjectHistory();
        updateHistoryCounter();
        checkForActiveChangeOrder();
        renderDailyLogs(currentProject);
        applyFormTemplateToForm();
        renderTeamSection(currentProject);
        renderPhotosSection(currentProject);
        renderDocsSection(currentProject);
        renderScheduleBlocks();
        initHeroTitleSize();
      }
    });
    
    // ========================================
    // TAB & UI FUNCTIONS
    // ========================================
    
    // Helper function to get project-specific localStorage keys
    function getProjectKey(suffix) {
      const id = currentProject ? (currentProject.idSync || currentProject.id) : 'IDSync250001';
      return `${suffix}_${id}`;
    }
    
    function switchTab(tabName) {
      // Ocultar todos los tabs
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Activar el tab seleccionado
      event.target.classList.add('active');
      const tabContent = document.getElementById('tab-' + tabName);
      
      if (tabContent) {
        tabContent.classList.add('active');
      }
    }

    // Función para abrir ThreadSync en nueva ventana/pestaña
    function openThreadSync() {
      const projectId = currentProject ? (currentProject.id || currentProject.idSync) : null;
      
      if (!projectId) {
        alert('Error: No se pudo identificar el proyecto');
        return;
      }
      
      // Search for linked thread in localStorage
      let linkedThreadId = null;
      
      try {
        // Method 1: Check if project has linkedThreads array
        const projectsData = JSON.parse(localStorage.getItem('projectsync_projects') || '[]');
        const project = projectsData.find(p => p.id === projectId);
        
        if (project && project.linkedThreads && project.linkedThreads.length > 0) {
          linkedThreadId = project.linkedThreads[0]; // Get first linked thread
        }
        
        // Method 2: Check threads for projectId reference
        if (!linkedThreadId) {
          const threadsData = JSON.parse(localStorage.getItem('threadsync_threads') || '{}');
          const linkedThread = Object.entries(threadsData).find(([id, thread]) => thread.projectId === projectId);
          
          if (linkedThread) {
            linkedThreadId = linkedThread[0];
          }
        }
        
        // Method 3: Check thread-project links registry
        if (!linkedThreadId) {
          const links = JSON.parse(localStorage.getItem('thread_project_links') || '[]');
          const link = links.find(l => l.projectUUID === projectId);
          
          if (link) {
            linkedThreadId = link.threadUUID;
          }
        }
      } catch (e) {
        console.error('Error searching for linked thread:', e);
      }
      
      if (linkedThreadId) {
        // Has linked thread - open it directly
        console.log('✅ Thread vinculado encontrado:', linkedThreadId);
        window.location.href = `threadsync.html?id=${linkedThreadId}&returnTo=viewsync&projectId=${projectId}`;
      } else {
        // No linked thread - show creation modal
        console.log('ℹ️ No hay thread vinculado, mostrando modal de creación');
        showCreateThreadModal(projectId);
      }
    }

    function showCreateThreadModal(projectId) {
      const modalHTML = `
        <div class="modal-overlay" id="threadModal" onclick="if(event.target === this) closeModal('threadModal')">
          <div class="modal">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                ThreadSync no encontrado
              </div>
              <button type="button" class="modal-close" onclick="closeModal('threadModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin-bottom: 20px; display: flex; gap: 12px; align-items: start;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" style="flex-shrink: 0;">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="12" y1="8" x2="12" y2="12"/>
                  <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <div style="font-size: 14px; color: #92400e;">
                  <strong>No hay ThreadSync vinculado</strong><br>
                  Este proyecto aún no tiene una conversación de ThreadSync asociada.
                </div>
              </div>

              <p style="color: var(--text-secondary); margin-bottom: 24px; font-size: 14px; line-height: 1.6;">
                <strong style="color: var(--text-primary);">¿Deseas iniciar un nuevo Thread?</strong><br><br>
                Al crear un ThreadSync podrás:
              </p>

              <ul style="list-style: none; padding: 0; margin-bottom: 24px;">
                <li style="padding: 10px 0; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 12px;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  <span style="font-size: 14px;">Centralizar toda la comunicación del proyecto</span>
                </li>
                <li style="padding: 10px 0; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 12px;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  <span style="font-size: 14px;">Mantener un historial completo de actualizaciones</span>
                </li>
                <li style="padding: 10px 0; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 12px;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  <span style="font-size: 14px;">Colaborar con el equipo en tiempo real</span>
                </li>
                <li style="padding: 10px 0; display: flex; align-items: center; gap: 12px;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  <span style="font-size: 14px;">Vincular automáticamente con este proyecto</span>
                </li>
              </ul>

              <div style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 12px 16px; border-radius: 4px; margin-top: 20px;">
                <div style="font-size: 13px; color: #1e40af; font-weight: 600; margin-bottom: 4px;">💡 Tip</div>
                <div style="font-size: 12px; color: #1e40af;">El Thread se creará automáticamente vinculado al proyecto <strong>${projectId}</strong></div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeModal('threadModal')">Cancelar</button>
              <button type="button" class="btn btn-primary" onclick="createNewThread('${projectId}')" style="background: #10b981; border-color: #10b981;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Iniciar ThreadSync
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function createNewThread(projectId) {
      // En producción, esto crearía el thread en la base de datos
      // y luego abriría la página con el nuevo thread
      closeModal('threadModal');
      
      // Simular creación del thread
      setTimeout(() => {
        alert('✓ ThreadSync creado exitosamente\n\nSe ha creado una nueva conversación vinculada al proyecto ' + projectId + '\n\nAbriendo ThreadSync...');
        // Navegar en la misma ventana con parámetro de retorno
        window.location.href = 'threadsync-detail.html?project=' + projectId + '&new=true&returnTo=viewsync';
      }, 300);
    }

    // Función para abrir/cerrar el menú de acciones
    function toggleActionsMenu() {
      const menu = document.getElementById('actionsMenu');
      if (menu.style.display === 'none') {
        menu.style.display = 'block';
      } else {
        menu.style.display = 'none';
      }
    }

    // Función para editar proyecto
    function editProject() {
      console.log('🔵 editProject() called');
      
      if (!currentProject) {
        alert('⚠️ No se pudo cargar el proyecto actual');
        return;
      }

      const linkedClient = getClientRecord(currentProject.clientId);
      const projectNameValue = currentProject.projectName || currentProject.name || '';
      const clientNameValue = linkedClient?.name || currentProject.client || currentProject.clientName || '';
      const contactValue = linkedClient?.contact || currentProject.contact || currentProject.contactName || '';
      const phoneValue = linkedClient?.phone || currentProject.phone || '';
      const emailValue = linkedClient?.email || currentProject.email || '';

      const modalHTML = `
        <div class="modal-overlay" id="editModal" onclick="if(event.target === this) closeModal('editModal')">
          <div class="modal">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Editar Proyecto ${currentProject.idSync || currentProject.id}
              </div>
              <button type="button" class="modal-close" onclick="closeModal('editModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div style="background: #f0fdf4; border: 1px solid #10b981; border-radius: 8px; padding: 12px 16px; margin-bottom: 20px; display: flex; gap: 12px; align-items: start;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="12" y1="8" x2="12" y2="12"/>
                  <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <div style="font-size: 14px; color: #065f46;">
                  <strong>Editar Información del Proyecto</strong><br>
                  Los cambios se guardarán en localStorage y se actualizarán en ProjectSync.
                </div>
              </div>

              <h4 style="font-size: 14px; font-weight: 700; margin-bottom: 16px; color: var(--text-secondary); text-transform: uppercase;">Información General</h4>

              <div class="form-group">
                <label class="form-label">Nombre del Proyecto</label>
                <input type="text" class="form-input" id="editProjectName" value="${projectNameValue}" />
              </div>
              <div class="form-group">
                <label class="form-label">Cliente</label>
                <input type="text" class="form-input" id="editClientName" value="${clientNameValue}" />
              </div>
              <div class="form-group">
                <label class="form-label">Contacto Principal</label>
                <input type="text" class="form-input" id="editContactName" value="${contactValue}" />
              </div>
              <div class="grid-2" style="gap: 16px;">
                <div class="form-group">
                  <label class="form-label">Teléfono</label>
                  <input type="tel" class="form-input" id="editPhone" value="${phoneValue}" />
                </div>
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-input" id="editEmail" value="${emailValue}" />
                </div>
              </div>

              <h4 style="font-size: 14px; font-weight: 700; margin: 24px 0 16px; color: var(--text-secondary); text-transform: uppercase;">Ubicación y Programación</h4>

              <div class="form-group">
                <label class="form-label">Dirección del Proyecto</label>
                <input type="text" class="form-input" id="editAddress" value="${currentProject.address || ''}" />
              </div>
              <div class="grid-2" style="gap: 16px;">
                <div class="form-group">
                  <label class="form-label">Fecha Inicio</label>
                  <input type="date" class="form-input" id="editStartDate" value="${currentProject.startDate || ''}" />
                </div>
                <div class="form-group">
                  <label class="form-label">Fecha Fin</label>
                  <input type="date" class="form-input" id="editEndDate" value="${currentProject.endDate || ''}" />
                </div>
              </div>

              <h4 style="font-size: 14px; font-weight: 700; margin: 24px 0 16px; color: var(--text-secondary); text-transform: uppercase;">Presupuesto y Servicios</h4>

              <div class="grid-2" style="gap: 16px;">
                <div class="form-group">
                  <label class="form-label">Presupuesto Estimado (USD)</label>
                  <input type="number" class="form-input" id="editBudget" value="${currentProject.budget || ''}" placeholder="12500" />
                </div>
                <div class="form-group">
                  <label class="form-label">Estado del Proyecto</label>
                  <select class="form-select" id="editStatus">
                    <option value="En Progreso" ${currentProject.status === 'En Progreso' ? 'selected' : ''}>En Progreso</option>
                    <option value="Completado" ${currentProject.status === 'Completado' ? 'selected' : ''}>Completado</option>
                    <option value="Pendiente" ${currentProject.status === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                    <option value="Cancelado" ${currentProject.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Descripción del Proyecto</label>
                <textarea class="form-textarea" id="editDescription" placeholder="Agregar descripción del proyecto...">${currentProject.description || ''}</textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">Cancelar</button>
              <button type="button" class="btn btn-primary" onclick="saveProjectEdit()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                Guardar Cambios
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function saveProjectEdit() {
      if (!currentProject) {
        alert('⚠️ Error: No se pudo identificar el proyecto');
        return;
      }

      // Obtener valores del formulario
      const projectName = (document.getElementById('editProjectName').value || '').trim() || currentProject.projectName || currentProject.name || '';
      const clientName = (document.getElementById('editClientName').value || '').trim() || currentProject.client || '';
      const contactName = (document.getElementById('editContactName').value || '').trim() || currentProject.contact || '';
      const phoneValue = (document.getElementById('editPhone').value || '').trim() || currentProject.phone || '';
      const emailValue = (document.getElementById('editEmail').value || '').trim() || currentProject.email || '';

      const updatedData = {
        name: projectName,
        projectName,
        client: clientName,
        clientName,
        contact: contactName,
        contactName,
        clientContact: contactName,
        phone: phoneValue,
        email: emailValue,
        address: document.getElementById('editAddress').value,
        startDate: document.getElementById('editStartDate').value,
        endDate: document.getElementById('editEndDate').value,
        budget: document.getElementById('editBudget').value,
        status: document.getElementById('editStatus').value,
        description: document.getElementById('editDescription').value,
        lastModified: new Date().toISOString()
      };

      // Actualizar currentProject
      Object.assign(currentProject, updatedData);

      // Actualizar en localStorage (projectsync_projects)
      const projects = JSON.parse(localStorage.getItem('projectsync_projects') || '[]');
      const projectIndex = projects.findIndex(p => 
        (p.idSync && p.idSync === currentProject.idSync) || 
        (p.id && p.id === currentProject.id)
      );

      if (projectIndex !== -1) {
        projects[projectIndex] = { ...projects[projectIndex], ...updatedData };
        localStorage.setItem('projectsync_projects', JSON.stringify(projects));
        console.log('✅ Proyecto actualizado en localStorage:', projects[projectIndex]);
      }

      // Si el proyecto está vinculado a un cliente, actualizamos también ese registro
      if (currentProject.clientId) {
        updateClientRecord(currentProject.clientId, {
          name: clientName,
          contact: contactName,
          phone: phoneValue,
          email: emailValue
        });
      }

      // Actualizar la UI
      renderProjectData(currentProject);
      updateProgressBar(currentProject);

      // Mostrar toast de éxito
      showToast('✓ Proyecto actualizado exitosamente', 'success');
      
      closeModal('editModal');
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.animation = 'fadeOut 0.2s ease-out';
        setTimeout(() => modal.remove(), 200);
      }
    }

    // Función para subir fotos
    function uploadPhotos() {
      const modalHTML = `
        <div class="modal-overlay" id="photoModal" onclick="if(event.target === this) closeModal('photoModal')">
          <div class="modal">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <polyline points="21 15 16 10 5 21"/>
                </svg>
                Subir Fotos del Proyecto
              </div>
              <button type="button" class="modal-close" onclick="closeModal('photoModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div style="border: 2px dashed #cbd5e1; border-radius: 12px; padding: 48px; text-align: center; background: #f9fafb; cursor: pointer;" onclick="document.getElementById('fileInput').click()">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 16px;">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Arrastra archivos aquí o haz clic para seleccionar</div>
                <div style="font-size: 14px; color: var(--text-secondary);">JPG, PNG o HEIC hasta 10MB</div>
                <input type="file" id="fileInput" accept="image/*" multiple style="display: none;" onchange="handleFileSelect(event)" />
              </div>
              <div id="fileList" style="margin-top: 16px;"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeModal('photoModal')">Cancelar</button>
              <button type="button" class="btn btn-primary" onclick="savePhotos()">Subir Fotos</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function handleFileSelect(event) {
      const files = event.target.files;
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = '';
      
      Array.from(files).forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e5e7eb;';
        fileItem.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
          <div style="flex: 1;">
            <div style="font-weight: 600; font-size: 14px;">${file.name}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">${(file.size / 1024).toFixed(1)} KB</div>
          </div>
        `;
        fileList.appendChild(fileItem);
      });
    }

    function savePhotos() {
      alert('✓ Fotos subidas exitosamente\n\nLas fotos han sido agregadas a la galería del proyecto.');
      closeModal('photoModal');
    }

    // Función para descargar documentos
    function downloadDocument(docType) {
      const docNames = {
        'contrato': 'Contrato_Firmado.pdf',
        'planos': 'Planos_HVAC.pdf',
        'materiales': 'Lista_de_Materiales.xlsx'
      };
      
      alert(`📥 Descargando documento\\n\\nArchivo: ${docNames[docType]}\\n\\nEn un entorno de producción, esto iniciaría la descarga del archivo.`);
      console.log(`Descargando: ${docNames[docType]}`);
    }

    // Función para subir documentos
    function uploadDocument() {
      const modalHTML = `
        <div class="modal-overlay" id="docModal" onclick="if(event.target === this) closeModal('docModal')">
          <div class="modal">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                  <polyline points="13 2 13 9 20 9"/>
                </svg>
                Subir Documento
              </div>
              <button type="button" class="modal-close" onclick="closeModal('docModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Tipo de Documento</label>
                <select class="form-select" id="docType">
                  <option>Contrato</option>
                  <option>Plano</option>
                  <option>Factura</option>
                  <option>Orden de Compra</option>
                  <option>Certificado</option>
                  <option>Otro</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Nombre del Documento</label>
                <input type="text" class="form-input" id="docName" placeholder="Ej: Contrato firmado cliente" />
              </div>
              <div style="border: 2px dashed #cbd5e1; border-radius: 12px; padding: 48px; text-align: center; background: #f9fafb; cursor: pointer;" onclick="document.getElementById('docFileInput').click()">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 16px;">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Selecciona el archivo</div>
                <div style="font-size: 14px; color: var(--text-secondary);">PDF, DOC, XLS, IMG hasta 25MB</div>
                <input type="file" id="docFileInput" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.png" style="display: none;" onchange="handleDocFileSelect(event)" />
              </div>
              <div id="docFileList" style="margin-top: 16px;"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeModal('docModal')">Cancelar</button>
              <button type="button" class="btn btn-primary" onclick="saveDocument()">Subir Documento</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function handleDocFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        const fileList = document.getElementById('docFileList');
        fileList.innerHTML = `
          <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
              <polyline points="13 2 13 9 20 9"/>
            </svg>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 14px;">${file.name}</div>
              <div style="font-size: 12px; color: var(--text-secondary);">${(file.size / 1024).toFixed(1)} KB</div>
            </div>
          </div>
        `;
      }
    }

    function saveDocument() {
      const docName = document.getElementById('docName').value;
      const docType = document.getElementById('docType').value;
      
      if (!docName) {
        alert('⚠️ Por favor ingresa un nombre para el documento');
        return;
      }
      
      alert(`✓ Documento subido exitosamente\\n\\nTipo: ${docType}\\nNombre: ${docName}\\n\\nEl documento ha sido agregado al proyecto.`);
      closeModal('docModal');
    }

    // Función para editar programación (modal con filas)
    function editSchedule() {
      const scheduleKey = `project_schedule_${currentProject.idSync || currentProject.id}`;
      const existing = JSON.parse(localStorage.getItem(scheduleKey) || '[]');
      const phases = existing.length ? existing : ensureProjectSchedule(currentProject);
      const modal = document.createElement('div');
      modal.className = 'modal-overlay schedule-editor';
      modal.id = 'scheduleModalOverlay';
      modal.innerHTML = `
        <div class="modal" style="max-width: 720px;">
          <div class="modal-header">
            <div class="modal-title" style="gap:10px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              Editar Programación
            </div>
            <button type="button" class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
          </div>
          <div class="modal-body" style="display:grid; gap:12px;">
            <div class="form-group">
              <label class="form-label">Etapas</label>
              <div id="sch-rows" style="display:grid; gap:12px;">
                ${phases.map((p, idx) => scheduleRowTemplate(p, idx)).join('')}
              </div>
              <button type="button" class="btn btn-white" style="margin-top:8px;" onclick="addScheduleRow()">+ Agregar etapa</button>
            </div>
            <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:10px; font-size:13px; color:#475569;">
              Demo: guardado local. En producción se sincronizará con ProjectSync/TimeSync.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-white" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="saveScheduleModal(this)">Guardar</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      initScheduleDrag(modal.querySelector('#sch-rows'));
      reindexScheduleRows(modal.querySelector('#sch-rows'));
    }

    function addScheduleRow() {
      const modal = document.getElementById('scheduleModalOverlay');
      const rows = modal ? modal.querySelector('#sch-rows') : null;
      if (!rows) return;
      const idx = rows.querySelectorAll('.sch-row-wrapper').length;
      rows.insertAdjacentHTML('beforeend', scheduleRowTemplate({}, idx));
      const newWrapper = rows.querySelector('.sch-row-wrapper:last-of-type');
      attachScheduleRowInteractions(newWrapper);
      reindexScheduleRows(rows);
    }

    function saveScheduleModal(btn) {
      const modal = btn.closest('.modal-overlay');
      const wrappers = modal.querySelectorAll('#sch-rows .sch-row-wrapper');
      if (!wrappers.length) {
        uiToast('error', 'Agrega al menos una etapa para guardar');
        return;
      }
      const phases = [];
      for (const [index, wrapper] of Array.from(wrappers).entries()) {
        const title = (wrapper.querySelector('[data-field="title"]')?.value || '').trim();
        const start = wrapper.querySelector('[data-field="start"]')?.value || '';
        const end = wrapper.querySelector('[data-field="end"]')?.value || '';
        const status = wrapper.querySelector('[data-field="status"]')?.value || 'pending';
        const notes = wrapper.querySelector('[data-field="notes"]')?.value || '';
        if (!title || !start || !end) {
          uiToast('error', `Completa título y fechas en la fase ${index + 1}`);
          return;
        }
        if (new Date(end) < new Date(start)) {
          uiToast('error', `La fase "${title}" tiene una fecha final anterior a la inicial`);
          return;
        }
        phases.push({ title, start, end, status, notes });
      }
      const scheduleKey = `project_schedule_${currentProject.idSync || currentProject.id}`;
      localStorage.setItem(scheduleKey, JSON.stringify(phases));
      modal.remove();
      renderScheduleBlocks();
      syncScheduleToTimeline(phases);
      uiToast('success', 'Programación actualizada');
    }

    // Función para contactar miembro del equipo
    async function contactMember(name, phone) {
      const ok = await uiConfirm(`📞 Contactar a ${name}\\n\\nTeléfono: ${phone}\\n\\n¿Deseas llamar ahora?`, {
        confirmText: 'Llamar',
        cancelText: 'Cancelar'
      });
      if (!ok) return;
      uiToast('info', `Marcando ${phone}... (demo)`);
    }

    // Función para agregar miembro al equipo
    function addTeamMember() {
      const modalHTML = `
        <div class="modal-overlay" id="teamModal" onclick="if(event.target === this) closeModal('teamModal')">
          <div class="modal">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                  <circle cx="8.5" cy="7" r="4"/>
                  <line x1="20" y1="8" x2="20" y2="14"/>
                  <line x1="23" y1="11" x2="17" y2="11"/>
                </svg>
                Agregar Miembro al Equipo
              </div>
              <button type="button" class="modal-close" onclick="closeModal('teamModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Empleado</label>
                <select class="form-select" id="employeeSelect">
                  <option value="">Seleccionar empleado...</option>
                  <option>Roberto Sánchez - Técnico</option>
                  <option>Laura Martínez - Técnico Senior</option>
                  <option>Pedro González - Ayudante</option>
                  <option>Sofia Ramírez - Supervisor</option>
                  <option>Miguel Torres - Electricista</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Rol en el Proyecto</label>
                <select class="form-select" id="roleSelect">
                  <option>Técnico</option>
                  <option>Técnico Senior</option>
                  <option>Ayudante</option>
                  <option>Supervisor</option>
                  <option>Project Manager</option>
                  <option>Especialista</option>
                </select>
              </div>
              <div class="grid-2" style="gap: 16px;">
                <div class="form-group">
                  <label class="form-label">Fecha Inicio</label>
                  <input type="date" class="form-input" value="2024-11-19" />
                </div>
                <div class="form-group">
                  <label class="form-label">Fecha Fin</label>
                  <input type="date" class="form-input" value="2024-11-20" />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Notas</label>
                <textarea class="form-textarea" placeholder="Responsabilidades específicas..."></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeModal('teamModal')">Cancelar</button>
              <button type="button" class="btn btn-primary" onclick="saveTeamMember()">Agregar al Proyecto</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function saveTeamMember() {
      const employee = document.getElementById('employeeSelect').value;
      if (!employee) {
        alert('⚠️ Por favor selecciona un empleado');
        return;
      }
      alert(`✓ Miembro agregado al equipo\\n\\n${employee} ha sido asignado al proyecto.`);
      closeModal('teamModal');
    }

    // Función para marcar proyecto como COMPLETADO (scope terminado)
    async function completeProject() {
      toggleActionsMenu(); // Cerrar menú
      const ok = await uiConfirm('✓ Marcar Proyecto como COMPLETADO\n\nEsto indica que:\n• El scope de trabajo ha sido terminado\n• Quedan pendientes administrativos (pagos, facturas, etc.)\n\n¿Marcar como completado?', {
        confirmText: 'Marcar completado',
        cancelText: 'Cancelar'
      });
      if (!ok) return;
      console.log('Marcando proyecto como completado...');
      uiToast('success', 'Proyecto marcado como COMPLETADO. Revisa pendientes administrativos.');
    }

    // Función para editar el estado del proyecto como checklist
    function editProjectStatus() {
      // Cargar checklist actual
      const currentChecklist = loadProjectChecklist();
      
      const modalHTML = `
        <div class="modal-overlay" id="statusModal" onclick="if(event.target === this) closeModal('statusModal')">
          <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 11l3 3L22 4"/>
                  <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
                Checklist Operativo del Proyecto
              </div>
              <button type="button" class="modal-close" onclick="closeModal('statusModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <!-- Templates -->
              ${currentChecklist.length === 0 ? `
              <div style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border-left: 4px solid #f59e0b;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <div style="font-size: 28px;">🚀</div>
                  <div>
                    <div style="font-weight: 700; font-size: 15px; color: #92400e;">Checklist Vacío</div>
                    <div style="font-size: 13px; color: #92400e;">Selecciona un template para comenzar o crea tu propio checklist</div>
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 12px;">
                  <button type="button" onclick="loadTemplate('plomeria')" style="padding: 12px; background: white; border: 2px solid #fbbf24; color: #92400e; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; justify-content: center;" onmouseover="this.style.background='#fffbeb'" onmouseout="this.style.background='white'">
                    🔧 Plomería
                  </button>
                  <button type="button" onclick="loadTemplate('hvac')" style="padding: 12px; background: white; border: 2px solid #fbbf24; color: #92400e; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; justify-content: center;" onmouseover="this.style.background='#fffbeb'" onmouseout="this.style.background='white'">
                    ❄️ HVAC
                  </button>
                  <button type="button" onclick="loadTemplate('electrico')" style="padding: 12px; background: white; border: 2px solid #fbbf24; color: #92400e; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; justify-content: center;" onmouseover="this.style.background='#fffbeb'" onmouseout="this.style.background='white'">
                    ⚡ Eléctrico
                  </button>
                  <button type="button" onclick="loadTemplate('construccion')" style="padding: 12px; background: white; border: 2px solid #fbbf24; color: #92400e; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; justify-content: center;" onmouseover="this.style.background='#fffbeb'" onmouseout="this.style.background='white'">
                    🏗️ Construcción
                  </button>
                  <button type="button" onclick="loadTemplate('mantenimiento')" style="padding: 12px; background: white; border: 2px solid #fbbf24; color: #92400e; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; justify-content: center;" onmouseover="this.style.background='#fffbeb'" onmouseout="this.style.background='white'">
                    🔨 Mantenimiento
                  </button>
                  <button type="button" onclick="loadTemplate('limpieza')" style="padding: 12px; background: white; border: 2px solid #fbbf24; color: #92400e; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; justify-content: center;" onmouseover="this.style.background='#fffbeb'" onmouseout="this.style.background='white'">
                    🧹 Limpieza
                  </button>
                </div>
              </div>
              ` : ''}
              
              <!-- Progreso Visual -->
              <div style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border-left: 4px solid #3b82f6;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <span style="font-weight: 700; font-size: 14px; color: #1e40af;">Progreso General</span>
                  <span id="checklistProgress" style="font-weight: 700; font-size: 18px; color: #1e40af;">0%</span>
                </div>
                <div style="height: 8px; background: rgba(59, 130, 246, 0.2); border-radius: 4px; overflow: hidden;">
                  <div id="checklistProgressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #3b82f6, #2563eb); border-radius: 4px; transition: width 0.3s;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: #1e40af;">
                  <span id="checklistCompleted">0 completadas</span>
                  <span id="checklistRemaining">0 pendientes</span>
                </div>
              </div>
              
              <!-- Lista de Checklist con Drag & Drop -->
              <div id="checklistContainer" style="display: flex; flex-direction: column; gap: 10px; min-height: 200px;">
                ${currentChecklist.length === 0 ? '<div style="text-align: center; padding: 40px 20px; color: #94a3b8;"><p style="font-size: 14px;">No hay tareas en el checklist</p></div>' : ''}
              </div>

              <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button type="button" onclick="addNewChecklistItem()" style="flex: 1; padding: 12px; background: rgba(2, 115, 94, 0.1); color: #02735E; border: 2px dashed rgba(2, 115, 94, 0.3); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.background='rgba(2, 115, 94, 0.15)'" onmouseout="this.style.background='rgba(2, 115, 94, 0.1)'">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                  Nueva Tarea
                </button>
                
                ${currentChecklist.length > 0 ? `
                <button type="button" onclick="clearChecklist()" style="padding: 12px 16px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 2px solid rgba(239, 68, 68, 0.2); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='rgba(239, 68, 68, 0.15)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'">
                  🗑️ Limpiar Todo
                </button>
                ` : ''}
              </div>

              <div style="margin-top: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                <div style="font-size: 13px; color: #1e40af; font-weight: 600; margin-bottom: 4px;">💡 Tips</div>
                <ul style="font-size: 12px; color: #1e40af; margin-left: 16px; line-height: 1.6;">
                  <li>Marca tareas conforme avanzas para actualizar el progreso</li>
                  <li>Agrega fechas programadas para mejor seguimiento</li>
                  <li>Usa templates predefinidos si el checklist está vacío</li>
                </ul>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeModal('statusModal')">Cancelar</button>
              <button type="button" class="btn btn-secondary" onclick="showProjectHistory()" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3);">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 6px;">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                Ver Historial
              </button>
              <button type="button" class="btn btn-primary" onclick="saveProjectStatus()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 6px;">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                Guardar Cambios
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Renderizar checklist actual
      renderChecklistItems();
      updateChecklistProgress();
    }

    // ===================================
    // CHECKLIST OPERATIVO - FUNCIONES
    // ===================================

    // Templates predefinidos por tipo de servicio
    const checklistTemplates = {
      plomeria: [
        { title: 'Inspección inicial del sitio', completed: false },
        { title: 'Verificar permisos y códigos locales', completed: false },
        { title: 'Preparar área de trabajo', completed: false },
        { title: 'Instalar tubería principal', completed: false },
        { title: 'Conectar ramales secundarios', completed: false },
        { title: 'Instalar válvulas y accesorios', completed: false },
        { title: 'Prueba de presión del sistema', completed: false },
        { title: 'Inspección final y documentación', completed: false },
        { title: 'Limpieza del sitio', completed: false },
        { title: 'Entrega y capacitación al cliente', completed: false }
      ],
      hvac: [
        { title: 'Evaluación térmica del espacio', completed: false },
        { title: 'Diseño de layout de ductos', completed: false },
        { title: 'Instalación de ductos principales', completed: false },
        { title: 'Montaje de unidades interiores', completed: false },
        { title: 'Instalación de unidad exterior', completed: false },
        { title: 'Conexiones eléctricas', completed: false },
        { title: 'Carga de refrigerante', completed: false },
        { title: 'Pruebas de funcionamiento', completed: false },
        { title: 'Calibración de termostatos', completed: false },
        { title: 'Entrega y manual de operación', completed: false }
      ],
      electrico: [
        { title: 'Inspección eléctrica inicial', completed: false },
        { title: 'Verificar capacidad del panel', completed: false },
        { title: 'Instalar cableado principal', completed: false },
        { title: 'Montar cajas y ductos', completed: false },
        { title: 'Conexiones de circuitos', completed: false },
        { title: 'Instalar breakers y protecciones', completed: false },
        { title: 'Puesta a tierra del sistema', completed: false },
        { title: 'Pruebas de continuidad y voltaje', completed: false },
        { title: 'Etiquetado de circuitos', completed: false },
        { title: 'Inspección final y certificación', completed: false }
      ],
      construccion: [
        { title: 'Preparación del terreno', completed: false },
        { title: 'Excavación y cimentación', completed: false },
        { title: 'Estructura principal', completed: false },
        { title: 'Instalación de techos', completed: false },
        { title: 'Instalaciones hidráulicas', completed: false },
        { title: 'Instalaciones eléctricas', completed: false },
        { title: 'Acabados interiores', completed: false },
        { title: 'Acabados exteriores', completed: false },
        { title: 'Limpieza final', completed: false },
        { title: 'Entrega de obra', completed: false }
      ],
      mantenimiento: [
        { title: 'Inspección general del equipo', completed: false },
        { title: 'Limpieza de componentes', completed: false },
        { title: 'Lubricación de partes móviles', completed: false },
        { title: 'Revisión de conexiones eléctricas', completed: false },
        { title: 'Verificar niveles de fluidos', completed: false },
        { title: 'Reemplazo de filtros', completed: false },
        { title: 'Ajuste de calibraciones', completed: false },
        { title: 'Pruebas de funcionamiento', completed: false },
        { title: 'Actualizar registro de mantenimiento', completed: false },
        { title: 'Entrega de reporte técnico', completed: false }
      ],
      limpieza: [
        { title: 'Evaluación del área', completed: false },
        { title: 'Protección de superficies sensibles', completed: false },
        { title: 'Limpieza profunda de pisos', completed: false },
        { title: 'Limpieza de ventanas', completed: false },
        { title: 'Desinfección de sanitarios', completed: false },
        { title: 'Limpieza de áreas comunes', completed: false },
        { title: 'Retiro de residuos', completed: false },
        { title: 'Aspirado y trapeado final', completed: false },
        { title: 'Inspección de calidad', completed: false },
        { title: 'Entrega del espacio', completed: false }
      ]
    };

    // Cargar checklist del proyecto
    function loadProjectChecklist() {
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('id');
      
      if (!projectId) return [];
      
      const key = `project_checklist_${projectId}`;
      const stored = localStorage.getItem(key);
      
      return stored ? JSON.parse(stored) : [];
    }

    // Guardar checklist del proyecto
    function saveProjectChecklist(checklist) {
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('id');
      
      if (!projectId) return;
      
      const key = `project_checklist_${projectId}`;
      localStorage.setItem(key, JSON.stringify(checklist));
    }

    // Cargar template
    async function loadTemplate(templateType) {
      if (!checklistTemplates[templateType]) {
        uiToast('error', '❌ Error: Template no encontrado.');
        return;
      }
      
      const ok = await uiConfirm(`🚀 Cargar Template: ${templateType.toUpperCase()}\n\n¿Deseas cargar el template predefinido para ${templateType}?\n\nEsto agregará ${checklistTemplates[templateType].length} tareas al checklist.`, {
        confirmText: 'Cargar',
        cancelText: 'Cancelar'
      });
      if (!ok) return;
      
      const checklist = checklistTemplates[templateType].map((item, index) => ({
        id: `TASK-${Date.now()}-${index}`,
        title: item.title,
        completed: false,
        date: null,
        completedDate: null
      }));
      
      saveProjectChecklist(checklist);
      renderChecklistItems();
      updateChecklistProgress();
      
      uiToast('success', `Template cargado. ${checklist.length} tareas agregadas.`);
    }

    // Renderizar items del checklist
    function renderChecklistItems() {
      const container = document.getElementById('checklistContainer');
      if (!container) return;
      
      const checklist = loadProjectChecklist();
      
      if (checklist.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: #94a3b8;"><p style="font-size: 14px;">No hay tareas en el checklist</p></div>';
        return;
      }
      
      container.innerHTML = checklist.map(item => {
        const isCompleted = item.completed;
        const bgColor = isCompleted ? '#f0fdf4' : 'white';
        const borderColor = isCompleted ? '#10b981' : '#e5e7eb';
        const textColor = isCompleted ? '#059669' : '#1e293b';
        const dateColor = isCompleted ? '#047857' : '#64748b';
        
        return `
          <label data-task-id="${item.id}" style="display: flex; align-items: center; gap: 12px; padding: 14px; background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="if(!this.querySelector('input').checked) this.style.background='#f8fafc'" onmouseout="if(!this.querySelector('input').checked) this.style.background='white'">
            <input type="checkbox" ${isCompleted ? 'checked' : ''} style="width: 20px; height: 20px; cursor: pointer;" onchange="toggleChecklistItem('${item.id}')" />
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 14px; color: ${textColor}; ${isCompleted ? 'text-decoration: line-through;' : ''}">${item.title}</div>
              <div style="font-size: 12px; color: ${dateColor}; margin-top: 2px;">
                ${item.completedDate ? '✅ Completada: ' + new Date(item.completedDate).toLocaleDateString('es-MX', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : (item.date || 'Sin fecha programada')}
              </div>
            </div>
            <button type="button" onclick="event.stopPropagation(); deleteChecklistItem('${item.id}')" style="background: #fee2e2; color: #dc2626; border: none; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#fecaca'" onmouseout="this.style.background='#fee2e2'">
              🗑️
            </button>
          </label>
        `;
      }).join('');
    }

    // Toggle checklist item
    function toggleChecklistItem(taskId) {
      const checklist = loadProjectChecklist();
      const task = checklist.find(t => t.id === taskId);
      
      if (!task) return;
      
      task.completed = !task.completed;
      task.completedDate = task.completed ? new Date().toISOString() : null;
      
      saveProjectChecklist(checklist);
      renderChecklistItems();
      updateChecklistProgress();
    }

    // Agregar nueva tarea
    function addNewChecklistItem() {
      const title = prompt('📝 Nueva Tarea\n\nEscribe el nombre de la nueva tarea:');
      
      if (!title || !title.trim()) {
        return;
      }
      
      const checklist = loadProjectChecklist();
      
      const newTask = {
        id: `TASK-${Date.now()}`,
        title: title.trim(),
        completed: false,
        date: null,
        completedDate: null
      };
      
      checklist.push(newTask);
      saveProjectChecklist(checklist);
      renderChecklistItems();
      updateChecklistProgress();
    }

    // Eliminar tarea
    async function deleteChecklistItem(taskId) {
      const ok = await uiConfirm('⚠️ Eliminar Tarea\n\n¿Estás seguro de eliminar esta tarea?\n\nEsta acción no se puede deshacer.', {
        confirmText: 'Eliminar',
        cancelText: 'Cancelar'
      });
      if (!ok) return;
      
      const checklist = loadProjectChecklist();
      const filtered = checklist.filter(t => t.id !== taskId);
      
      saveProjectChecklist(filtered);
      renderChecklistItems();
      updateChecklistProgress();
    }

    // Limpiar todo el checklist
    async function clearChecklist() {
      const ok = await uiConfirm('⚠️ Limpiar Checklist\n\n¿Estás seguro de eliminar TODAS las tareas?\n\nEsta acción no se puede deshacer.', {
        confirmText: 'Limpiar',
        cancelText: 'Cancelar'
      });
      if (!ok) return;
      
      saveProjectChecklist([]);
      renderChecklistItems();
      updateChecklistProgress();
      uiToast('success', 'Checklist limpiado correctamente.');
    }

    // Actualizar progreso del checklist
    function updateChecklistProgress() {
      const checklist = loadProjectChecklist();
      
      const total = checklist.length;
      const completed = checklist.filter(t => t.completed).length;
      const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
      
      const progressEl = document.getElementById('checklistProgress');
      const barEl = document.getElementById('checklistProgressBar');
      const completedEl = document.getElementById('checklistCompleted');
      const remainingEl = document.getElementById('checklistRemaining');
      
      if (progressEl) progressEl.textContent = `${percentage}%`;
      if (barEl) barEl.style.width = `${percentage}%`;
      if (completedEl) completedEl.textContent = `${completed} completadas`;
      if (remainingEl) remainingEl.textContent = `${total - completed} pendientes`;
    }

    function saveProjectStatus() {
      // Obtener checklist del proyecto
      const checklist = loadProjectChecklist();
      
      if (checklist.length === 0) {
        alert('⚠️ Checklist Vacío\n\nNo hay tareas para guardar.\nAgrega tareas manualmente o carga un template predefinido.');
        return;
      }
      
      // Convertir a formato de historial
      const checklistItems = checklist.map((task, index) => ({
        id: index + 1,
        title: task.title,
        date: task.completedDate 
          ? new Date(task.completedDate).toLocaleString('es-MX', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
          : (task.date || 'Programado'),
        completed: task.completed
      }));

      // Crear entrada de historial
      const historyEntry = {
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleString('es-MX', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit' 
        }),
        items: checklistItems,
        user: 'Usuario Actual'
      };

      // Guardar en historial (usando projectId dinámico)
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('id');
      const historyKey = getProjectKey('projectStatusHistory');
      
      let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
      history.unshift(historyEntry);
      if (history.length > 50) history = history.slice(0, 50);
      localStorage.setItem(historyKey, JSON.stringify(history));

      // Actualizar timeline visible
      updateTimelineDisplay(checklistItems);
      
      // Actualizar contador de historial
      updateHistoryCounter();
      
      const completed = checklist.filter(t => t.completed).length;
      const total = checklist.length;
      
      alert(`✅ Checklist Guardado\n\n📊 Progreso: ${completed}/${total} tareas (${Math.round((completed/total)*100)}%)\n📅 Guardado: ${historyEntry.date}\n\nEl timeline del proyecto se ha actualizado.`);
      closeModal('statusModal');
    }

    function updateTimelineDisplay(items) {
      const timelineContainer = document.querySelector('.timeline');
      if (!timelineContainer) return;

      // Limpiar timeline actual
      timelineContainer.innerHTML = '';

      // Si no hay items, mostrar mensaje de estado vacío
      if (items.length === 0) {
        timelineContainer.innerHTML = `
          <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 48px; margin-bottom: 12px;">📋</div>
            <div style="font-weight: 600; font-size: 16px; color: var(--text-primary); margin-bottom: 8px;">
              Estado del Proyecto Vacío
            </div>
            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
              Aún no se han definido etapas para este proyecto.
            </div>
            <button type="button" onclick="editProjectStatus()" style="background: rgba(2, 115, 94, 0.1); color: #02735E; border: 1px solid rgba(2, 115, 94, 0.3); padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 6px;">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Definir Etapas
            </button>
          </div>
        `;
        return;
      }

      // Reconstruir timeline con los items actualizados
      items.forEach(item => {
        const timelineItem = document.createElement('div');
        timelineItem.className = 'timeline-item';
        
        const dotClass = item.completed ? 'timeline-dot' : 'timeline-dot pending';
        
        timelineItem.innerHTML = `
          <div class="${dotClass}"></div>
          <div class="timeline-content">
            <div class="timeline-title">${item.title}</div>
            <div class="timeline-date">${item.date}</div>
          </div>
        `;
        
        timelineContainer.appendChild(timelineItem);
      });
    }

    function showProjectHistory() {
      const history = JSON.parse(localStorage.getItem('projectStatusHistory_IDSync250001') || '[]');
      
      if (history.length === 0) {
        alert('📋 No hay historial disponible\n\nNo se han registrado cambios en el estado del proyecto.');
        return;
      }

      const modalHTML = `
        <div class="modal-overlay" id="historyModal" onclick="if(event.target === this) closeModal('historyModal')">
          <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                Historial de Cambios del Proyecto
              </div>
              <button type="button" class="modal-close" onclick="closeModal('historyModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body" style="max-height: 600px; overflow-y: auto;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">
                  Revisa todos los cambios realizados al estado del proyecto. Puedes restaurar cualquier versión anterior.
                </p>
                <button type="button" onclick="showArchivedHistory()" style="background: rgba(107, 114, 128, 0.1); color: #6b7280; border: 1px solid rgba(107, 114, 128, 0.3); padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 4px;">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                  </svg>
                  Ver Archivados
                </button>
              </div>
              
              <div style="display: flex; flex-direction: column; gap: 16px;">
                ${history.map((entry, index) => `
                  <div style="background: ${index === 0 ? '#f0fdf4' : 'white'}; border: 2px solid ${index === 0 ? '#10b981' : '#e5e7eb'}; border-radius: 12px; padding: 16px; position: relative;">
                    ${index === 0 ? '<div style="position: absolute; top: -10px; right: 16px; background: #10b981; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700;">ACTUAL</div>' : ''}
                    ${entry.restored ? '<div style="position: absolute; top: -10px; left: 16px; background: #f59e0b; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700;">↩ RESTAURADO</div>' : ''}
                    ${entry.changeOrder ? '<div style="position: absolute; top: -10px; left: 16px; background: #f59e0b; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700;">📝 CHANGE ORDER</div>' : ''}
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;">
                      <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 15px; color: var(--text-primary);">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 6px;">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                          </svg>
                          ${entry.date}
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                          Por: ${entry.user}
                          ${entry.restored ? `<br><span style="color: #f59e0b;">🔄 Restaurado desde: ${entry.restoredFrom}</span>` : ''}
                          ${entry.changeOrder ? `<br><span style="color: #f59e0b;">📋 ${entry.coDescription}</span><br><span style="color: #10b981;">💰 $${entry.coBudget} USD • 📅 ${entry.coDays} días</span>` : ''}
                        </div>
                      </div>
                      ${index !== 0 ? `
                        <button type="button" onclick="restoreProjectStatus(${index})" style="background: rgba(2, 115, 94, 0.1); color: #02735E; border: 1px solid rgba(2, 115, 94, 0.3); padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 4px;">
                            <polyline points="1 4 1 10 7 10"/>
                            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                          </svg>
                          Restaurar
                        </button>
                      ` : ''}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 8px;">
                      ${entry.items.map(item => `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: ${item.completed ? '#f0fdf4' : '#f9fafb'}; border-radius: 6px;">
                          <div style="width: 6px; height: 6px; border-radius: 50%; background: ${item.completed ? '#10b981' : '#d1d5db'};"></div>
                          <div style="flex: 1; font-size: 13px; color: ${item.completed ? '#059669' : 'var(--text-secondary)'}">${item.title}</div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeModal('historyModal')">Cerrar</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    async function restoreProjectStatus(historyIndex) {
      const ok = await uiConfirm('⚠️ Restaurar Estado Anterior\n\n¿Deseas restaurar el estado del proyecto a esta versión?\n\nEsto creará una nueva entrada en el historial.', {
        confirmText: 'Restaurar',
        cancelText: 'Cancelar'
      });
      if (!ok) return;

      const history = JSON.parse(localStorage.getItem('projectStatusHistory_IDSync250001') || '[]');
      const entryToRestore = history[historyIndex];
      
      if (!entryToRestore) {
        uiToast('error', '❌ Error: No se pudo encontrar esta versión en el historial.');
        return;
      }

      // Actualizar el timeline visible
      updateTimelineDisplay(entryToRestore.items);

      // Crear nueva entrada en el historial indicando la restauración
      const restoreEntry = {
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleString('es-MX', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit' 
        }),
        items: entryToRestore.items,
        user: 'Usuario Actual',
        restored: true,
        restoredFrom: entryToRestore.date
      };

      history.unshift(restoreEntry);
      if (history.length > 50) history.pop();
      localStorage.setItem('projectStatusHistory_IDSync250001', JSON.stringify(history));

      alert(`✓ Estado Restaurado\n\nSe ha restaurado el estado del proyecto desde:\n${entryToRestore.date}\n\nLos cambios se reflejan en el timeline.`);
      closeModal('historyModal');
      updateHistoryCounter();
    }

    function showArchivedHistory() {
      const archives = JSON.parse(localStorage.getItem('projectStatusArchive_IDSync250001') || '[]');
      
      if (archives.length === 0) {
        alert('📦 No hay historiales archivados\n\nCuando se crea un Change Order, el historial actual se archiva aquí.');
        return;
      }

      const modalHTML = `
        <div class="modal-overlay" id="archivedModal" onclick="if(event.target === this) closeModal('archivedModal')">
          <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                </svg>
                Historiales Archivados
              </div>
              <button type="button" class="modal-close" onclick="closeModal('archivedModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body" style="max-height: 600px; overflow-y: auto;">
              <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                📦 Estos son los historiales archivados cuando se crearon Change Orders. Son solo de referencia histórica y <strong>no se pueden restaurar</strong> para evitar pérdida de datos del trabajo actual.
              </p>
              
              <div style="display: flex; flex-direction: column; gap: 20px;">
                ${archives.map((archive, archiveIndex) => `
                  <div style="background: #fafaf9; border: 2px solid #d6d3d1; border-radius: 12px; padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                      <div style="background: #78716c; color: white; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 700;">
                        📦 ARCHIVO ${archiveIndex + 1}
                      </div>
                      <div style="flex: 1; text-align: right; font-size: 12px; color: #78716c;">
                        ${archive.history.length} versiones guardadas
                      </div>
                    </div>
                    
                    <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #d6d3d1;">
                      <div style="font-weight: 600; font-size: 14px; color: #57534e; margin-bottom: 4px;">
                        📅 Archivado: ${archive.archivedDate}
                      </div>
                      <div style="font-size: 12px; color: #78716c;">
                        💡 Razón: ${archive.reason}
                      </div>
                    </div>
                    
                    <details style="cursor: pointer;">
                      <summary style="font-weight: 600; font-size: 13px; color: #57534e; padding: 10px; background: white; border-radius: 6px; list-style: none; display: flex; justify-content: space-between; align-items: center; transition: 0.2s;" onmouseover="this.style.background='#f5f5f4'" onmouseout="this.style.background='white'">
                        <span>📜 Expandir para ver historial completo</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: 0.2s;">
                          <polyline points="6 9 12 15 18 9"/>
                        </svg>
                      </summary>
                      
                      <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 12px; padding-top: 12px;">
                        ${archive.history.map((entry, entryIndex) => `
                          <div style="background: white; border: 1px solid #e7e5e4; border-radius: 8px; padding: 12px; position: relative;">
                            ${entryIndex === 0 ? '<div style="position: absolute; top: -8px; right: 12px; background: #10b981; color: white; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700;">ÚLTIMO ESTADO</div>' : ''}
                            
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #f5f5f4;">
                              <div>
                                <div style="font-weight: 600; font-size: 13px; color: #57534e; margin-bottom: 2px;">
                                  🕐 ${entry.date}
                                </div>
                                <div style="font-size: 11px; color: #78716c;">
                                  👤 ${entry.user}
                                </div>
                              </div>
                              <div style="text-align: right; font-size: 11px; color: #78716c;">
                                ${entry.items.filter(i => i.completed).length} de ${entry.items.length} completadas
                              </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 6px;">
                              ${entry.items.map(item => `
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 11px; padding: 4px 6px; background: ${item.completed ? '#f0fdf4' : '#f9fafb'}; border-radius: 4px;">
                                  <div style="width: 5px; height: 5px; border-radius: 50%; background: ${item.completed ? '#10b981' : '#d1d5db'}; flex-shrink: 0;"></div>
                                  <span style="color: ${item.completed ? '#059669' : '#78716c'}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.title}">${item.title}</span>
                                </div>
                              `).join('')}
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    </details>
                  </div>
                `).join('')}
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeModal('archivedModal')">Cerrar</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function updateHistoryCounter() {
      const history = JSON.parse(localStorage.getItem('projectStatusHistory_IDSync250001') || '[]');
      const counterEl = document.getElementById('historyCount');
      if (counterEl) {
        counterEl.textContent = history.length;
      }
    }

    // Inicializar cuando cargue la página
    document.addEventListener('DOMContentLoaded', function() {
      initializeProjectHistory();
      updateHistoryCounter();
      checkForActiveChangeOrder();
    });

    function checkForActiveChangeOrder() {
      const projectKey = currentProject ? `projectStatusHistory_${currentProject.idSync || currentProject.id}` : 'projectStatusHistory_IDSync250001';
      const history = JSON.parse(localStorage.getItem(projectKey) || '[]');
      
      if (history.length > 0 && history[0].changeOrder) {
        const co = history[0];
        const banner = document.getElementById('changeOrderBanner');
        const description = document.getElementById('changeOrderDescription');
        
        if (banner && description) {
          description.textContent = `${co.coDescription} • $${co.coBudget} USD • ${co.coDays} días`;
          banner.style.display = 'block';
        }
      }
    }

    function initializeProjectHistory() {
      const projectKey = currentProject ? `projectStatusHistory_${currentProject.idSync || currentProject.id}` : 'projectStatusHistory_IDSync250001';
      const history = JSON.parse(localStorage.getItem(projectKey) || '[]');
      
      // Si no hay historial, crear historial de ejemplo
      if (history.length === 0) {
        const exampleHistory = [
          {
            timestamp: new Date('2024-11-18T14:30:00').toISOString(),
            date: '18 nov 2024, 14:30',
            user: 'Juan Pérez',
            items: [
              { id: 1, title: 'Inspección inicial completada', date: '10 Nov 2024 - 08:00 AM', completed: true },
              { id: 2, title: 'Instalación de ductos', date: '11 Nov 2024 - 09:00 AM', completed: true },
              { id: 3, title: 'Montaje de unidades', date: '14 Nov 2024 - 10:00 AM', completed: true },
              { id: 4, title: 'Pruebas de sistema', date: '19 Nov 2024 - Programado', completed: false },
              { id: 5, title: 'Entrega final', date: '20 Nov 2024 - Pendiente', completed: false }
            ]
          },
          {
            timestamp: new Date('2024-11-15T10:15:00').toISOString(),
            date: '15 nov 2024, 10:15',
            user: 'María Torres',
            items: [
              { id: 1, title: 'Inspección inicial completada', date: '10 Nov 2024 - 08:00 AM', completed: true },
              { id: 2, title: 'Instalación de ductos', date: '11 Nov 2024 - 09:00 AM', completed: true },
              { id: 3, title: 'Montaje de unidades', date: '14 Nov 2024 - 10:00 AM', completed: false },
              { id: 4, title: 'Pruebas de sistema', date: '19 Nov 2024 - Programado', completed: false },
              { id: 5, title: 'Entrega final', date: '20 Nov 2024 - Pendiente', completed: false }
            ]
          },
          {
            timestamp: new Date('2024-11-12T09:00:00').toISOString(),
            date: '12 nov 2024, 09:00',
            user: 'Carlos Ramírez',
            items: [
              { id: 1, title: 'Inspección inicial completada', date: '10 Nov 2024 - 08:00 AM', completed: true },
              { id: 2, title: 'Instalación de ductos', date: '11 Nov 2024 - 09:00 AM', completed: false },
              { id: 3, title: 'Montaje de unidades', date: '14 Nov 2024 - 10:00 AM', completed: false },
              { id: 4, title: 'Pruebas de sistema', date: '19 Nov 2024 - Programado', completed: false },
              { id: 5, title: 'Entrega final', date: '20 Nov 2024 - Pendiente', completed: false }
            ]
          }
        ];
        
        localStorage.setItem(getProjectKey('projectStatusHistory'), JSON.stringify(exampleHistory));
      }
    }

    function toggleChecklistItem(checkbox) {
      const label = checkbox.parentElement;
      if (checkbox.checked) {
        label.style.background = '#f0fdf4';
        label.style.borderColor = '#10b981';
        label.querySelector('div > div:first-child').style.color = '#059669';
        label.querySelector('div > div:last-child').style.color = '#047857';
      } else {
        label.style.background = 'white';
        label.style.borderColor = '#e5e7eb';
        label.querySelector('div > div:first-child').style.color = '';
        label.querySelector('div > div:last-child').style.color = 'var(--text-secondary)';
      }
    }

    function addNewChecklistItem() {
      const title = prompt('📝 Nueva Etapa del Proyecto\n\nIngresa el nombre de la etapa:');
      if (!title || title.trim() === '') return;

      const date = prompt('📅 Fecha de la Etapa\n\nIngresa la fecha (ej: 25 Nov 2024):');
      const dateText = date && date.trim() !== '' ? date : 'Fecha pendiente';

      const container = document.getElementById('checklistContainer');
      const newItem = document.createElement('label');
      newItem.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 14px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;';
      newItem.innerHTML = `
        <input type="checkbox" style="width: 20px; height: 20px; cursor: pointer;" onchange="toggleChecklistItem(this)" />
        <div style="flex: 1;">
          <div style="font-weight: 600; font-size: 14px;">${title}</div>
          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">${dateText}</div>
        </div>
      `;
      container.appendChild(newItem);
      
      // Scroll to the new item
      newItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Función para CERRAR proyecto (todo terminado)
    async function closeProject() {
      toggleActionsMenu(); // Cerrar menú
      const ok = await uiConfirm('🔒 CERRAR PROYECTO\n\nEsto indica que TODO está completo:\n• Trabajo terminado\n• Pagos recibidos\n• Facturas emitidas\n• Documentación completa\n\nDespués de cerrar, solo podrás crear Change Orders.\n\n¿Cerrar proyecto?', {
        confirmText: 'Cerrar proyecto',
        cancelText: 'Cancelar'
      });
      if (!ok) return;
      console.log('Cerrando proyecto...');
      uiToast('success', 'Proyecto CERRADO. Se archiva y solo permite Change Orders.');
      setTimeout(() => {
        window.location.href = 'motorsync.html';
      }, 2000);
    }

    // Función para crear Change Order
    function createChangeOrder() {
      toggleActionsMenu(); // Cerrar menú
      
      const modalHTML = `
        <div class="modal-overlay" id="changeOrderModal" onclick="if(event.target === this) closeModal('changeOrderModal')">
          <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Crear Change Order
              </div>
              <button type="button" class="modal-close" onclick="closeModal('changeOrderModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; gap: 12px;">
                  <div style="color: #f59e0b; font-size: 20px;">⚠️</div>
                  <div>
                    <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;">Impacto en Estado del Proyecto</div>
                    <div style="font-size: 13px; color: #92400e; line-height: 1.5;">
                      Al crear un Change Order, se <strong>archivará el historial actual</strong> del proyecto y se iniciará un <strong>nuevo ciclo de trabajo</strong> con estado limpio. El historial anterior quedará guardado para referencia.
                    </div>
                  </div>
                </div>
              </div>

              <div style="display: flex; flex-direction: column; gap: 16px;">
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                    Número de Change Order
                  </label>
                  <input type="text" id="coNumber" value="CO-1" readonly style="width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: #f9fafb; color: var(--text-secondary);">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Se asigna automáticamente</div>
                </div>

                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                    Descripción del Trabajo Adicional *
                  </label>
                  <textarea id="coDescription" rows="3" placeholder="Ej: Instalación de sistema de ventilación adicional en área de cocina..." style="width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; resize: vertical; font-family: inherit;"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                      Presupuesto Adicional *
                    </label>
                    <div style="position: relative;">
                      <span style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-weight: 600;">$</span>
                      <input type="number" id="coBudget" placeholder="5000" style="width: 100%; padding: 10px 14px 10px 32px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    </div>
                  </div>

                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                      Días Estimados *
                    </label>
                    <input type="number" id="coDays" placeholder="15" style="width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                      Fecha de Inicio *
                    </label>
                    <input type="date" id="coStartDate" style="width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                  </div>

                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                      Fecha de Fin Estimada *
                    </label>
                    <input type="date" id="coEndDate" style="width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                  </div>
                </div>

                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                    Razón del Change Order *
                  </label>
                  <select id="coReason" onchange="toggleOtroField()" style="width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white;">
                    <option value="">Seleccionar razón...</option>
                    <option value="cliente">Solicitud del Cliente</option>
                    <option value="descubrimiento">Descubrimiento en Sitio</option>
                    <option value="codigo">Requerimientos de Código</option>
                    <option value="mejora">Mejora/Upgrade</option>
                    <option value="error">Corrección de Error</option>
                    <option value="otro">Otro (especificar)</option>
                  </select>
                </div>

                <div id="otroReasonField" style="display: none;">
                  <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                    Especificar Razón *
                  </label>
                  <input type="text" id="coOtroReason" placeholder="Describe la razón del Change Order..." style="width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                </div>

                <div style="background: #f0f9ff; border-radius: 8px; padding: 12px; border-left: 4px solid #3b82f6;">
                  <div style="font-size: 13px; color: #1e40af; font-weight: 600; margin-bottom: 4px;">📋 Proceso del Change Order</div>
                  <ol style="font-size: 12px; color: #1e40af; margin-left: 16px; line-height: 1.6;">
                    <li>Se archivará el historial actual del proyecto</li>
                    <li>Se creará nuevo estado vacío para el CO</li>
                    <li>Podrás definir nuevas etapas específicas del CO</li>
                    <li>El timeline se reiniciará para este trabajo</li>
                  </ol>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeModal('changeOrderModal')">Cancelar</button>
              <button type="button" class="btn btn-primary" onclick="confirmCreateChangeOrder()" style="background: #f59e0b; border-color: #f59e0b;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 6px;">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Crear Change Order
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Establecer fecha mínima como hoy
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('coStartDate').min = today;
      document.getElementById('coEndDate').min = today;
      
      // Auto-calcular fecha de fin cuando se cambia fecha de inicio o días
      document.getElementById('coStartDate').addEventListener('change', updateEndDate);
      document.getElementById('coDays').addEventListener('input', updateEndDate);
    }

    function toggleOtroField() {
      const reason = document.getElementById('coReason').value;
      const otroField = document.getElementById('otroReasonField');
      
      if (reason === 'otro') {
        otroField.style.display = 'block';
      } else {
        otroField.style.display = 'none';
      }
    }

    function updateEndDate() {
      const startDate = document.getElementById('coStartDate').value;
      const days = parseInt(document.getElementById('coDays').value);
      
      if (startDate && days > 0) {
        const start = new Date(startDate);
        const end = new Date(start);
        end.setDate(end.getDate() + days);
        
        document.getElementById('coEndDate').value = end.toISOString().split('T')[0];
      }
    }

    function confirmCreateChangeOrder() {
      const description = document.getElementById('coDescription').value.trim();
      const budget = document.getElementById('coBudget').value.trim();
      const days = document.getElementById('coDays').value.trim();
      const startDate = document.getElementById('coStartDate').value;
      const endDate = document.getElementById('coEndDate').value;
      const reason = document.getElementById('coReason').value;
      const otroReason = document.getElementById('coOtroReason').value.trim();

      // Validaciones
      if (!description) {
        alert('❌ Error\n\nPor favor describe el trabajo adicional.');
        return;
      }
      if (!budget || parseFloat(budget) <= 0) {
        alert('❌ Error\n\nPor favor ingresa un presupuesto válido.');
        return;
      }
      if (!days || parseInt(days) <= 0) {
        alert('❌ Error\n\nPor favor ingresa los días estimados.');
        return;
      }
      if (!startDate) {
        alert('❌ Error\n\nPor favor selecciona la fecha de inicio.');
        return;
      }
      if (!endDate) {
        alert('❌ Error\n\nPor favor selecciona la fecha de fin.');
        return;
      }
      if (!reason) {
        alert('❌ Error\n\nPor favor selecciona la razón del Change Order.');
        return;
      }
      if (reason === 'otro' && !otroReason) {
        alert('❌ Error\n\nPor favor especifica la razón del Change Order.');
        return;
      }

      // Validar que la fecha de fin sea posterior a la de inicio
      if (new Date(endDate) <= new Date(startDate)) {
        alert('❌ Error\n\nLa fecha de fin debe ser posterior a la fecha de inicio.');
        return;
      }

      const finalReason = reason === 'otro' ? otroReason : reason;

      // Archivar historial actual antes de resetear
      archiveProjectHistory();

      // Resetear estado del proyecto para el Change Order
      resetProjectStateForChangeOrder(description, budget, days, finalReason, startDate, endDate);

      closeModal('changeOrderModal');
    }

    function archiveProjectHistory() {
      const currentHistory = JSON.parse(localStorage.getItem('projectStatusHistory_IDSync250001') || '[]');
      
      if (currentHistory.length > 0) {
        const archiveEntry = {
          archivedAt: new Date().toISOString(),
          archivedDate: new Date().toLocaleString('es-MX', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
          }),
          reason: 'Change Order creado',
          history: currentHistory
        };

        // Guardar en archivo histórico separado
        let archives = JSON.parse(localStorage.getItem('projectStatusArchive_IDSync250001') || '[]');
        archives.unshift(archiveEntry);
        if (archives.length > 10) archives = archives.slice(0, 10); // Mantener últimas 10 versiones archivadas
        localStorage.setItem('projectStatusArchive_IDSync250001', JSON.stringify(archives));
      }
    }

    function resetProjectStateForChangeOrder(description, budget, days, reason, startDate, endDate) {
      // Limpiar historial actual
      localStorage.removeItem(getProjectKey('projectStatusHistory'));

      // Formatear fechas para mostrar
      const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        return date.toLocaleDateString('es-MX', { year: 'numeric', month: 'short', day: 'numeric' });
      };

      // Crear entrada inicial del Change Order
      const initialEntry = {
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleString('es-MX', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit' 
        }),
        items: [], // Estado vacío para empezar
        user: 'Usuario Actual',
        changeOrder: true,
        coDescription: description,
        coBudget: budget,
        coDays: days,
        coReason: reason,
        coStartDate: formatDate(startDate),
        coEndDate: formatDate(endDate)
      };

      localStorage.setItem(getProjectKey('projectStatusHistory'), JSON.stringify([initialEntry]));

      // Limpiar el timeline visible
      updateTimelineDisplay([]);
      
      // Actualizar contador
      updateHistoryCounter();
      
      // Mostrar banner de Change Order
      checkForActiveChangeOrder();

      alert(`✅ Change Order Creado\n\n📋 Descripción: ${description}\n💰 Presupuesto: $${budget} USD\n📅 Duración: ${days} días (${formatDate(startDate)} - ${formatDate(endDate)})\n🔍 Razón: ${reason}\n\nEl estado del proyecto se ha reseteado.\nAhora puedes definir las nuevas etapas del Change Order.\n\n✨ El historial anterior ha sido archivado.`);
      
      // Abrir modal de edición para definir nuevas etapas
      setTimeout(() => {
        editProjectStatus();
      }, 500);
    }

    // Función para CANCELAR proyecto
    async function cancelProject() {
      toggleActionsMenu(); // Cerrar menú
      const first = await uiConfirm('⚠️ CANCELAR PROYECTO\n\nEsto detendrá el proyecto permanentemente:\n• Se liberarán recursos asignados\n• Se cancelarán órdenes pendientes\n• No se podrá reactivar\n\n¿Estás seguro de cancelar?', {
        confirmText: 'Cancelar proyecto',
        cancelText: 'Volver'
      });
      if (!first) return;
      const second = await uiConfirm('⚠️ CONFIRMACIÓN FINAL\n\n¿Realmente deseas CANCELAR este proyecto?\n\nEsta acción no se puede deshacer.', {
        confirmText: 'Confirmar cancelación',
        cancelText: 'Abortar'
      });
      if (!second) return;
      console.log('Cancelando proyecto...');
      uiToast('warning', 'Proyecto CANCELADO. Redirigiendo a MotorSync...');
      setTimeout(() => {
        window.location.href = 'motorsync.html';
      }, 1500);
    }

    // ===================================
    // SISTEMA DE ESTADOS AVANZADOS
    // ===================================

    const STATE_ICONS = {
      quoted: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="14" height="16" rx="2"></rect><polyline points="14 4 20 4 20 14"></polyline><line x1="7" y1="9" x2="13" y2="9"></line><line x1="7" y1="13" x2="11" y2="13"></line></svg>',
      approved: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><polyline points="8 12 11 15 16 9"></polyline></svg>',
      scheduled: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="17" rx="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><path d="M12 14h4"></path></svg>',
      'in-progress': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M7 21v-4a2 2 0 0 1 2-2h1"></path><path d="M14 14h1a2 2 0 0 1 2 2v4"></path><circle cx="12" cy="7" r="3"></circle><path d="M5 7h1"></path><path d="M18 7h1"></path><path d="M12 3v1"></path><path d="M12 10v1"></path></svg>',
      paused: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><line x1="9" y1="9" x2="9" y2="15"></line><line x1="15" y1="9" x2="15" y2="15"></line></svg>',
      completed: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l2.09 6.26L20 9.27l-5 3.73L16.18 20 12 16.9 7.82 20 9 13 4 9.27l5.91-.99z"></path></svg>',
      cancelled: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>',
      overdue: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>'
    };

    const WORKFLOW_SEQUENCE = ['quoted', 'approved', 'scheduled', 'in-progress', 'paused', 'completed', 'cancelled'];

    const STATE_ALIASES = {
      'en-progreso': 'in-progress',
      'en-proceso': 'in-progress',
      'en curso': 'in-progress',
      'en-curso': 'in-progress',
      'en progreso': 'in-progress',
      'aprobado': 'approved',
      'programado': 'scheduled',
      'cotizado': 'quoted',
      'completado': 'completed',
      'finalizado': 'completed',
      'cancelado': 'cancelled',
      'pausado': 'paused',
      'pendiente': 'quoted',
      'activo': 'in-progress',
      'overdue': 'overdue',
      'not-started': 'quoted'
    };

    const PROJECT_STATES = {
      quoted: {
        name: 'Cotizado',
        icon: STATE_ICONS.quoted,
        description: 'Esperando aprobación del cliente',
        color: '#3b82f6',
        next: ['approved', 'cancelled']
      },
      approved: {
        name: 'Aprobado',
        icon: STATE_ICONS.approved,
        description: 'Aprobado por cliente, pendiente programación',
        color: '#10b981',
        next: ['scheduled', 'cancelled']
      },
      scheduled: {
        name: 'Programado',
        icon: STATE_ICONS.scheduled,
        description: 'Fechas confirmadas, listo para iniciar',
        color: '#8b5cf6',
        next: ['in-progress', 'paused', 'cancelled']
      },
      'in-progress': {
        name: 'En Proceso',
        icon: STATE_ICONS['in-progress'],
        description: 'Trabajo activo en sitio',
        color: '#f59e0b',
        next: ['paused', 'completed', 'cancelled']
      },
      paused: {
        name: 'Pausado',
        icon: STATE_ICONS.paused,
        description: 'Temporalmente detenido',
        color: '#fbbf24',
        next: ['in-progress', 'cancelled']
      },
      completed: {
        name: 'Completado',
        icon: STATE_ICONS.completed,
        description: 'Proyecto finalizado exitosamente',
        color: '#059669',
        next: []
      },
      cancelled: {
        name: 'Cancelado',
        icon: STATE_ICONS.cancelled,
        description: 'Proyecto cancelado',
        color: '#ef4444',
        next: []
      },
      overdue: {
        name: 'Retrasado',
        icon: STATE_ICONS.overdue,
        description: 'Fuera de fecha planificada',
        color: '#ef4444',
        next: ['in-progress', 'completed', 'cancelled']
      }
    };

    function normalizeStateKey(value) {
      if (!value) return null;
      const raw = String(value).trim().toLowerCase();
      const stripped = raw.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      const slug = stripped.replace(/[\s_]+/g, '-');
      if (PROJECT_STATES[slug]) return slug;
      if (STATE_ALIASES[slug]) return STATE_ALIASES[slug];
      if (STATE_ALIASES[stripped]) return STATE_ALIASES[stripped];
      return slug;
    }

    function resolveProjectState(project) {
      const fromProject = project && (project.state || project.status || project.phase);
      const normalizedProjectState = normalizeStateKey(fromProject);
      if (normalizedProjectState && PROJECT_STATES[normalizedProjectState]) {
        return normalizedProjectState;
      }
      const storedState = normalizeStateKey(getCurrentProjectState());
      if (storedState && PROJECT_STATES[storedState]) {
        return storedState;
      }
      return 'in-progress';
    }

    // Cargar estado actual del proyecto
    function getCurrentProjectState() {
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('id');
      
      if (!projectId) return 'quoted';
      
      const key = `project_state_${projectId}`;
      return localStorage.getItem(key) || 'quoted';
    }

    // Guardar estado del proyecto
    function saveProjectState(newState) {
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('id');
      
      if (!projectId) return;
      
      const key = `project_state_${projectId}`;
      localStorage.setItem(key, newState);
      
      // También actualizar en projectsync_projects
      const projects = JSON.parse(localStorage.getItem('projectsync_projects') || '{}');
      if (projects[projectId]) {
        projects[projectId].state = newState;
        projects[projectId].stateChangedAt = new Date().toISOString();
        localStorage.setItem('projectsync_projects', JSON.stringify(projects));
      }
      
      // Guardar en historial de cambios de estado
      saveStateHistory(newState);
      
      // Actualizar UI
      renderProjectState();
    }

    // Guardar historial de cambios de estado
    function saveStateHistory(newState) {
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('id');
      
      if (!projectId) return;
      
      const key = `project_state_history_${projectId}`;
      const history = JSON.parse(localStorage.getItem(key) || '[]');
      
      const entry = {
        state: newState,
        timestamp: new Date().toISOString(),
        user: 'Usuario Actual'
      };
      
      history.push(entry);
      localStorage.setItem(key, JSON.stringify(history));
    }

    // Renderizar estado actual
    function renderProjectState(project) {
      const currentStateKey = resolveProjectState(project);
      const stateConfig = PROJECT_STATES[currentStateKey] || PROJECT_STATES['in-progress'];
      
      const badgeEmoji = document.getElementById('badgeEmoji');
      const badgeTitle = document.getElementById('badgeTitle');
      const badgeSubtitle = document.getElementById('badgeSubtitle');
      const badgeContainer = document.getElementById('currentStateBadge');
      if (badgeEmoji) {
        badgeEmoji.innerHTML = stateConfig.icon;
      }
      if (badgeTitle) badgeTitle.textContent = stateConfig.name;
      if (badgeSubtitle) badgeSubtitle.textContent = stateConfig.description;
      if (badgeContainer) {
        badgeContainer.style.border = `1px solid ${stateConfig.color}`;
      }
      
      renderWorkflowRow(currentStateKey);
      
      const btnChange = document.getElementById('btnChangeState');
      if (btnChange) {
        if (currentStateKey === 'completed' || currentStateKey === 'cancelled') {
          btnChange.disabled = true;
          btnChange.style.opacity = '0.5';
          btnChange.style.cursor = 'not-allowed';
        } else {
          btnChange.disabled = false;
          btnChange.style.opacity = '1';
          btnChange.style.cursor = 'pointer';
        }
      }
    }

    // Abrir modal de cambio de estado
    function changeProjectState() {
      const currentState = getCurrentProjectState();
      const stateConfig = PROJECT_STATES[currentState];
      
      if (!stateConfig) return;
      
      if (currentState === 'completed' || currentState === 'cancelled') {
        alert('⚠️ Estado Final\n\nEste proyecto está en un estado final y no puede ser modificado.');
        return;
      }
      
      const nextStates = stateConfig.next;
      
      if (nextStates.length === 0) {
        alert('⚠️ Sin Transiciones\n\nNo hay estados disponibles para transición.');
        return;
      }
      
      const modalHTML = `
        <div class="modal-overlay" id="stateChangeModal" onclick="if(event.target === this) closeModal('stateChangeModal')">
          <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="1 4 1 10 7 10"/>
                  <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                </svg>
                Cambiar Estado del Proyecto
              </div>
              <button type="button" class="modal-close" onclick="closeModal('stateChangeModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #3b82f6; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 36px; height: 36px; color: #1e40af;">${stateConfig.icon}</div>
                  <div>
                    <div style="font-weight: 700; font-size: 14px; color: #1e40af; margin-bottom: 2px;">Estado Actual: ${stateConfig.name}</div>
                    <div style="font-size: 12px; color: #1e40af;">${stateConfig.description}</div>
                  </div>
                </div>
              </div>

              <p style="font-weight: 600; margin-bottom: 12px; color: #1e293b;">Selecciona el nuevo estado:</p>

              <div style="display: flex; flex-direction: column; gap: 12px;">
                ${nextStates.map(state => {
                  const nextConfig = PROJECT_STATES[state];
                  return `
                    <label onclick="selectNewState('${state}')" style="display: flex; align-items: center; gap: 16px; padding: 16px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='${nextConfig.color}'; this.style.background='rgba(${hexToRgb(nextConfig.color)}, 0.05)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                      <input type="radio" name="newState" value="${state}" style="width: 20px; height: 20px; cursor: pointer;" />
                      <div style="width: 36px; height: 36px; color:${nextConfig.color}; display:flex; align-items:center; justify-content:center;">${nextConfig.icon}</div>
                      <div style="flex: 1;">
                        <div style="font-weight: 700; font-size: 15px; color: #1e293b; margin-bottom: 4px;">${nextConfig.name}</div>
                        <div style="font-size: 12px; color: #64748b;">${nextConfig.description}</div>
                      </div>
                    </label>
                  `;
                }).join('')}
              </div>

              <div style="margin-top: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                <div style="font-size: 13px; color: #1e40af; font-weight: 600; margin-bottom: 4px;">💡 Información</div>
                <div style="font-size: 12px; color: #1e40af;">El cambio de estado se registrará en el historial del proyecto y será visible en toda la plataforma.</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeModal('stateChangeModal')">Cancelar</button>
              <button type="button" class="btn btn-primary" onclick="confirmStateChange()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 6px;">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                Confirmar Cambio
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    // Seleccionar nuevo estado (helper para radio)
    function selectNewState(state) {
      const radio = document.querySelector(`input[value="${state}"]`);
      if (radio) radio.checked = true;
    }

    // Confirmar cambio de estado
    async function confirmStateChange() {
      const selected = document.querySelector('input[name="newState"]:checked');
      
      if (!selected) {
        uiToast('error', 'Por favor selecciona un estado.');
        return;
      }
      
      const newState = selected.value;
      const stateConfig = PROJECT_STATES[newState];
      
      const ok = await uiConfirm(`🔄 Confirmar Cambio de Estado\n\n¿Confirmas cambiar el estado del proyecto a "${stateConfig.name}"?\n\n${stateConfig.description}\n\nEste cambio se registrará en el historial.`, {
        confirmText: 'Confirmar',
        cancelText: 'Cancelar'
      });
      if (!ok) return;
      
      saveProjectState(newState);
      
      closeModal('stateChangeModal');
      
      uiToast('success', `Estado actualizado a ${stateConfig.name}.`);
    }

    // Helper: convertir hex a rgb para backgrounds
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '0, 0, 0';
    }

    // ===================================
    // SISTEMA DE FOTOS Y EVIDENCIAS
    // ===================================

    function resolveDefaultProjectId() {
      if (currentProject) return currentProject.idSync || currentProject.id;
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
    }

    function ensurePhotoFilterDefaults() {
      if (!photoFilters.projectId) {
        photoFilters.projectId = resolveDefaultProjectId();
      }
    }

    function listPhotoProjectIds() {
      const ids = new Set();
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('photo_gallery_')) {
          ids.add(key.replace('photo_gallery_', ''));
        }
      }
      const fallback = resolveDefaultProjectId();
      if (fallback) ids.add(fallback);
      return Array.from(ids);
    }

    function normalizePhotoRecord(photo, projectId) {
      const baseDate = photo.uploadDate || new Date().toISOString();
      return {
        ...photo,
        projectId: photo.projectId || projectId || resolveDefaultProjectId(),
        captureDate: photo.captureDate || baseDate.slice(0, 10),
        uploadDate: baseDate,
        phaseName: photo.phaseName || photo.phase || 'General',
        phaseId: photo.phaseId || photo.phase || null
      };
    }

    function loadProjectPhotos(targetProjectId = resolveDefaultProjectId()) {
      const projectId = targetProjectId || resolveDefaultProjectId();
      if (!projectId) return [];
      const key = `photo_gallery_${projectId}`;
      const stored = localStorage.getItem(key);
      const parsed = stored ? JSON.parse(stored) : [];
      return parsed.map((photo) => normalizePhotoRecord(photo, projectId));
    }

    function loadPhotoUniverse() {
      ensurePhotoFilterDefaults();
      if (photoFilters.projectId === 'all') {
        return listPhotoProjectIds().flatMap((projectId) => loadProjectPhotos(projectId));
      }
      return loadProjectPhotos(photoFilters.projectId || resolveDefaultProjectId());
    }

    function saveProjectPhotos(photos, targetProjectId = resolveDefaultProjectId()) {
      const projectId = targetProjectId || resolveDefaultProjectId();
      if (!projectId) {
        console.error('No project ID found');
        return;
      }
      const key = `photo_gallery_${projectId}`;
      localStorage.setItem(key, JSON.stringify(photos));
      renderPhotoGallery();
    }

    // Renderizar galería de fotos con filtros avanzados
    function renderPhotoGallery() {
      ensurePhotoFilterDefaults();
      const grid = document.getElementById('photo-gallery-grid');
      if (!grid) return;

      const scopedPhotos = loadPhotoUniverse().filter((photo) => {
        const matchesPhase = photoFilters.phase === 'all' || photo.phaseId === photoFilters.phase || photo.phaseName === photoFilters.phase;
        const matchesDate = photoFilters.date === 'all' || (photo.captureDate && photo.captureDate === photoFilters.date);
        return matchesPhase && matchesDate;
      });

      const counts = {
        all: scopedPhotos.length,
        before: scopedPhotos.filter((p) => p.category === 'before').length,
        during: scopedPhotos.filter((p) => p.category === 'during').length,
        after: scopedPhotos.filter((p) => p.category === 'after').length,
        defect: scopedPhotos.filter((p) => p.category === 'defect').length,
        completion: scopedPhotos.filter((p) => p.category === 'completion').length
      };

      Object.keys(counts).forEach((cat) => {
        const counter = document.getElementById(`count-${cat}`);
        if (counter) counter.textContent = counts[cat];
      });

      const filtered = photoFilters.category === 'all'
        ? scopedPhotos
        : scopedPhotos.filter((p) => p.category === photoFilters.category);

      if (!filtered.length) {
        grid.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #94a3b8;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px;">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            <p style="font-size: 15px; font-weight: 500; margin-bottom: 8px;">No hay fotos que coincidan con los filtros seleccionados</p>
            <p style="font-size: 13px; color: #cbd5e1;">Ajusta los filtros o sube nuevas evidencias del proyecto.</p>
          </div>
        `;
        updatePhotoSelectionCount();
        return;
      }

      const categoryEmoji = {
        before: '📷',
        during: '🔧',
        after: '✅',
        defect: '⚠️',
        completion: '📋'
      };
      const categoryName = {
        before: 'Antes',
        during: 'En Proceso',
        after: 'Después',
        defect: 'Defecto',
        completion: 'Entrega'
      };
      const categoryColor = {
        before: '#3b82f6',
        during: '#f59e0b',
        after: '#10b981',
        defect: '#ef4444',
        completion: '#8b5cf6'
      };

      grid.innerHTML = filtered.map((photo) => {
        const isSelected = selectedPhotoIds.has(photo.id);
        const showProjectTag = photoFilters.projectId === 'all';
        return `
          <div class="photo-card" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; position: relative;">
            <label style="position:absolute; top:10px; right:10px; z-index:5; background:rgba(255,255,255,0.9); border-radius:8px; padding:4px 8px; display:flex; align-items:center; gap:4px; font-size:11px; font-weight:600;">
              <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="togglePhotoSelection('${photo.id}', this.checked)">
              Seleccionar
            </label>
            <div style="position: relative; padding-top: 75%; background: #f1f5f9; overflow: hidden; cursor:pointer;" onclick="openPhotoLightbox('${photo.id}')">
              <img src="${photo.url}" alt="${photo.caption || 'Foto del proyecto'}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
              <div style="position: absolute; top: 8px; left: 8px;">
                <span style="background: ${categoryColor[photo.category]}; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                  ${categoryEmoji[photo.category]} ${categoryName[photo.category]}
                </span>
              </div>
            </div>
            <div style="padding: 12px; display:flex; flex-direction:column; gap:8px;">
              ${photo.caption ? `<p style="font-size: 13px; font-weight: 600; color: #1e293b; margin: 0;">${photo.caption}</p>` : ''}
              <div style="display:flex; flex-wrap:wrap; gap:8px; font-size:11px; color:#64748b;">
                <span style="display:inline-flex; align-items:center; gap:4px;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                  </svg>
                  ${photo.captureDate}
                </span>
                ${photo.phaseName ? `<span style="display:inline-flex; align-items:center; gap:4px;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                  ${photo.phaseName}
                </span>` : ''}
                ${showProjectTag ? `<span style="display:inline-flex; align-items:center; gap:4px;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21v-4a8 8 0 0 1 8-8 8 8 0 0 1 8 8v4"></path><circle cx="12" cy="7" r="4"></circle></svg>
                  ${photo.projectId}
                </span>` : ''}
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                <div style="display:flex; gap:6px;">
                  <button type="button" onclick="event.stopPropagation(); renamePhoto('${photo.id}')" style="background: #e0f2fe; color: #0369a1; border: none; padding: 6px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Renombrar
                  </button>
                  <button type="button" onclick="event.stopPropagation(); deletePhoto('${photo.id}')" style="background: #fee2e2; color: #dc2626; border: none; padding: 6px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    🗑️ Eliminar
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      updatePhotoSelectionCount();
    }

    // Filtrar fotos por categoría
    function filterPhotos(category) {
      photoFilters.category = category;
      selectedPhotoIds.clear();
      document.querySelectorAll('.photo-filter').forEach((btn) => {
        if (btn.dataset.category === category) {
          btn.style.background = 'linear-gradient(135deg, #02735E, #035951)';
          btn.style.color = 'white';
          btn.classList.add('active');
        } else {
          btn.style.background = 'white';
          btn.style.color = '#64748b';
          btn.classList.remove('active');
        }
      });
      updatePhotoSelectionCount();
      renderPhotoGallery();
    }

    function hydratePhotoFilterControls() {
      ensurePhotoFilterDefaults();
      const projectSelect = document.getElementById('photoProjectFilter');
      if (projectSelect) {
        const projectId = resolveDefaultProjectId();
        const options = listPhotoProjectIds();
        projectSelect.innerHTML = `
          <option value="${projectId}">Proyecto actual (${projectId})</option>
          <option value="all">Todos los proyectos</option>
          ${options.filter((id) => id !== projectId).map((id) => `<option value="${id}">${id}</option>`).join('')}
        `;
        projectSelect.value = photoFilters.projectId || projectId;
      }
      const phaseSelect = document.getElementById('photoPhaseFilter');
      if (phaseSelect) {
        const phases = cachedSchedulePhases.length ? cachedSchedulePhases : ensureProjectSchedule(currentProject);
        phaseSelect.innerHTML = `
          <option value="all">Todas las fases</option>
          ${phases.map((phase, index) => `<option value="${phase.id || phase.title || index}">${phase.title || phase.name}</option>`).join('')}
        `;
        phaseSelect.value = photoFilters.phase || 'all';
      }
      const dateInput = document.getElementById('photoDateFilter');
      if (dateInput) {
        dateInput.value = photoFilters.date !== 'all' ? photoFilters.date : '';
      }
    }

    function handlePhotoProjectChange(select) {
      photoFilters.projectId = select.value === 'all' ? 'all' : select.value;
      selectedPhotoIds.clear();
      updatePhotoSelectionCount();
      hydratePhotoFilterControls();
      renderPhotoGallery();
    }

    function handlePhotoPhaseChange(select) {
      photoFilters.phase = select.value || 'all';
      selectedPhotoIds.clear();
      updatePhotoSelectionCount();
      renderPhotoGallery();
    }

    function handlePhotoDateChange(input) {
      photoFilters.date = input.value ? input.value : 'all';
      selectedPhotoIds.clear();
      updatePhotoSelectionCount();
      renderPhotoGallery();
    }

    function resetPhotoFilters() {
      photoFilters.category = 'all';
      photoFilters.phase = 'all';
      photoFilters.date = 'all';
      photoFilters.projectId = resolveDefaultProjectId();
      selectedPhotoIds.clear();
      updatePhotoSelectionCount();
      hydratePhotoFilterControls();
      document.querySelectorAll('.photo-filter').forEach((btn) => {
        if (btn.dataset.category === 'all') {
          btn.style.background = 'linear-gradient(135deg, #02735E, #035951)';
          btn.style.color = 'white';
          btn.classList.add('active');
        } else {
          btn.style.background = 'white';
          btn.style.color = '#64748b';
          btn.classList.remove('active');
        }
      });
      renderPhotoGallery();
    }

    function togglePhotoSelection(photoId, checked) {
      if (checked) {
        selectedPhotoIds.add(photoId);
      } else {
        selectedPhotoIds.delete(photoId);
      }
      updatePhotoSelectionCount();
    }

    function updatePhotoSelectionCount() {
      const counter = document.getElementById('photoSelectionCount');
      if (counter) {
        counter.textContent = selectedPhotoIds.size;
      }
    }

    function sanitizeFileName(text) {
      return text.replace(/[^a-z0-9-_]+/gi, '_');
    }

    function downloadSelectedPhotos() {
      if (!selectedPhotoIds.size) {
        uiToast('info', 'Selecciona al menos una foto para descargar.');
        return;
      }
      selectedPhotoIds.forEach((photoId) => {
        const context = getPhotoContext(photoId);
        if (!context) return;
        const link = document.createElement('a');
        link.href = context.photo.url;
        const safeName = sanitizeFileName(context.photo.caption || context.photo.id || 'foto');
        link.download = `${safeName}.jpg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
      uiToast('success', `Descarga iniciada para ${selectedPhotoIds.size} foto(s).`);
    }

    function getPhotoContext(photoId) {
      const projectIds = photoFilters.projectId === 'all'
        ? listPhotoProjectIds()
        : [photoFilters.projectId || resolveDefaultProjectId()];
      for (const pid of projectIds) {
        const photos = loadProjectPhotos(pid);
        const index = photos.findIndex((p) => p.id === photoId);
        if (index !== -1) {
          return { projectId: pid, photos, index, photo: photos[index] };
        }
      }
      return null;
    }

    // Abrir modal de subir foto
    function openUploadPhotoModal() {
      const phases = cachedSchedulePhases.length ? cachedSchedulePhases : ensureProjectSchedule(currentProject);
      const phaseOptions = phases.map((phase, index) => {
        const value = phase.id || phase.title || `phase-${index}`;
        return `<option value="${value}">${phase.title || phase.name}</option>`;
      }).join('');
      const today = new Date().toISOString().slice(0, 10);
      const modalHTML = `
        <div id="uploadPhotoModal" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s;">
          <div style="background: white; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: #1e293b;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Subir Foto
              </h3>
              <button type="button" onclick="closeUploadPhotoModal()" style="background: none; border: none; font-size: 28px; color: #94a3b8; cursor: pointer; line-height: 1; padding: 0; width: 32px; height: 32px;">&times;</button>
            </div>

            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #334155; font-size: 14px;">
                Categoría *
              </label>
              <select id="photoCategory" style="width: 100%; padding: 12px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white;">
                <option value="">Seleccionar categoría...</option>
                <option value="before">📷 Antes - Condiciones iniciales</option>
                <option value="during">🔧 En Proceso - Trabajo en progreso</option>
                <option value="after">✅ Después - Trabajo completado</option>
                <option value="defect">⚠️ Defecto - Problemas encontrados</option>
                <option value="completion">📋 Entrega - Evidencia final</option>
              </select>
            </div>

            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #334155; font-size: 14px;">
                Descripción (opcional)
              </label>
              <input type="text" id="photoCaption" placeholder="Ej: Instalación de tubería principal" style="width: 100%; padding: 12px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #334155; font-size: 14px;">
                Fase asociada
              </label>
              <select id="photoPhaseSelect" style="width: 100%; padding: 12px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white;">
                <option value="">General</option>
                ${phaseOptions}
              </select>
            </div>
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #334155; font-size: 14px;">
                Fecha de captura
              </label>
              <input type="date" id="photoCaptureDate" value="${today}" style="width: 100%; padding: 12px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 24px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #334155; font-size: 14px;">
                Seleccionar Foto *
              </label>
              <input type="file" id="photoFile" accept="image/*" style="width: 100%; padding: 12px 14px; border: 2px dashed #cbd5e1; border-radius: 8px; font-size: 14px; background: #f8fafc; cursor: pointer;">
              <p style="font-size: 12px; color: #94a3b8; margin-top: 8px;">Formatos: JPG, PNG, HEIC (máx 10MB)</p>
            </div>

            <div style="display: flex; gap: 12px;">
              <button type="button" onclick="closeUploadPhotoModal()" style="flex: 1; padding: 14px; border: 2px solid #e5e7eb; background: white; color: #64748b; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                Cancelar
              </button>
              <button type="button" onclick="confirmUploadPhoto()" style="flex: 1; padding: 14px; border: none; background: linear-gradient(135deg, #02735E, #035951); color: white; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                Subir Foto
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    // Cerrar modal de subir
    function closeUploadPhotoModal() {
      const modal = document.getElementById('uploadPhotoModal');
      if (modal) modal.remove();
    }

    // Confirmar subida de foto
    function confirmUploadPhoto() {
      const category = document.getElementById('photoCategory').value;
      const caption = document.getElementById('photoCaption').value.trim();
      const fileInput = document.getElementById('photoFile');
      const phaseSelect = document.getElementById('photoPhaseSelect');
      const captureDate = document.getElementById('photoCaptureDate').value || new Date().toISOString().slice(0, 10);
      const selectedPhaseValue = phaseSelect ? phaseSelect.value : '';
      const selectedPhaseLabel = phaseSelect && phaseSelect.options[phaseSelect.selectedIndex]
        ? phaseSelect.options[phaseSelect.selectedIndex].text
        : 'General';
      
      if (!category) {
        alert('❌ Error\n\nPor favor selecciona una categoría para la foto.');
        return;
      }
      
      if (!fileInput.files || fileInput.files.length === 0) {
        alert('❌ Error\n\nPor favor selecciona una foto para subir.');
        return;
      }
      
      const file = fileInput.files[0];
      
      // Validar tamaño (10MB máx)
      if (file.size > 10 * 1024 * 1024) {
        alert('❌ Error\n\nLa foto excede el tamaño máximo de 10MB.');
        return;
      }
      
      // Leer archivo como Base64
      const reader = new FileReader();
      reader.onload = function(e) {
        const projectId = resolveDefaultProjectId();
        const photos = loadProjectPhotos(projectId);
        
        const newPhoto = {
          id: 'PHOTO-' + Date.now(),
          category: category,
          caption: caption || null,
          url: e.target.result, // Base64 data URL
          uploadDate: new Date().toISOString(),
          uploadedBy: 'Usuario Actual', // TODO: integrar con sistema de auth
          fileName: file.name,
          fileSize: file.size,
          projectId,
          captureDate,
          phaseId: selectedPhaseValue || null,
          phaseName: selectedPhaseLabel
        };
        
        photos.push(newPhoto);
        saveProjectPhotos(photos, projectId);
        
        closeUploadPhotoModal();
        
        // Cambiar a la categoría de la foto subida
        filterPhotos(category);
        
        alert(`✅ Foto Subida\n\n📁 Archivo: ${file.name}\n📂 Categoría: ${getCategoryName(category)}\n${caption ? '📝 Descripción: ' + caption : ''}\n\nLa foto se ha guardado correctamente.`);
      };
      
      reader.readAsDataURL(file);
    }

    // Abrir lightbox para ver foto
    function openPhotoLightbox(photoId) {
      const context = getPhotoContext(photoId);
      if (!context) return;
      const photo = context.photo;
      
      const categoryEmoji = {
        before: '📷',
        during: '🔧',
        after: '✅',
        defect: '⚠️',
        completion: '📋'
      };
      
      const lightboxHTML = `
        <div id="photoLightbox" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 10001; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s;" onclick="closePhotoLightbox()">
          <button type="button" onclick="closePhotoLightbox()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 36px; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; z-index: 10002; backdrop-filter: blur(10px);">&times;</button>
          
          <div style="max-width: 90vw; max-height: 90vh; text-align: center;" onclick="event.stopPropagation()">
            <img src="${photo.url}" alt="${photo.caption || 'Foto del proyecto'}" style="max-width: 100%; max-height: 80vh; border-radius: 12px; box-shadow: 0 20px 80px rgba(0,0,0,0.5);">
            
            <div style="background: rgba(0,0,0,0.8); border-radius: 12px; padding: 20px; margin-top: 20px; backdrop-filter: blur(10px);">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span style="background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 700;">
                  ${categoryEmoji[photo.category]} ${getCategoryName(photo.category)}
                </span>
                <span style="color: #94a3b8; font-size: 13px;">
                  ${new Date(photo.uploadDate).toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' })}
                </span>
              </div>
              ${photo.caption ? `<p style="color: white; font-size: 16px; font-weight: 500; margin: 0;">${photo.caption}</p>` : ''}
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', lightboxHTML);
    }

    // Cerrar lightbox
    function closePhotoLightbox() {
      const lightbox = document.getElementById('photoLightbox');
      if (lightbox) lightbox.remove();
    }

    // Eliminar foto
    async function deletePhoto(photoId) {
      const ok = await uiConfirm('⚠️ Eliminar Foto\n\n¿Estás seguro de eliminar esta foto?\n\nEsta acción no se puede deshacer.', {
        confirmText: 'Eliminar',
        cancelText: 'Cancelar'
      });
      if (!ok) return;
      
      const context = getPhotoContext(photoId);
      if (!context) return;
      context.photos.splice(context.index, 1);
      saveProjectPhotos(context.photos, context.projectId);
      selectedPhotoIds.delete(photoId);
      updatePhotoSelectionCount();
      uiToast('success', 'Foto eliminada correctamente.');
    }

    // Renombrar foto
    async function renamePhoto(photoId) {
      const context = getPhotoContext(photoId);
      if (!context) return;
      const photo = context.photo;
      const newName = prompt('Nuevo nombre para la foto', photo.caption || 'Foto del proyecto');
      if (!newName) return;
      photo.caption = newName;
      saveProjectPhotos(context.photos, context.projectId);
      uiToast('success', 'Nombre actualizado');
    }

    // Helper: obtener nombre de categoría
    function getCategoryName(category) {
      const names = {
        before: 'Antes',
        during: 'En Proceso',
        after: 'Después',
        defect: 'Defecto',
        completion: 'Entrega'
      };
      return names[category] || category;
    }

    // Cargar galería al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
      // Solo ejecutar si estamos en viewsync.html
      if (window.location.pathname.includes('viewsync.html')) {
        renderProjectState(currentProject);
        renderPhotoGallery();
        renderDocumentsList();
      }
    });

    // ===================================
    // SISTEMA DE DOCUMENTOS
    // ===================================

    let currentDocFilter = 'all';

    function getDocumentStorageKey(projectId) {
      return `project_documents_${projectId}`;
    }

    function loadProjectDocuments(projectId = resolveDefaultProjectId()) {
      const targetId = projectId || resolveDefaultProjectId();
      if (!targetId) return [];
      const stored = localStorage.getItem(getDocumentStorageKey(targetId));
      if (!stored) return [];
      try {
        return JSON.parse(stored) || [];
      } catch (err) {
        console.warn('Documentos corruptos, regenerando', err);
        return [];
      }
    }

    function saveProjectDocuments(documents, projectId = resolveDefaultProjectId(), options = {}) {
      const targetId = projectId || resolveDefaultProjectId();
      if (!targetId) return;
      localStorage.setItem(getDocumentStorageKey(targetId), JSON.stringify(documents));
      if (!options.silent) {
        renderDocumentsList();
      }
    }

    function appendProjectDocument(doc, projectId = resolveDefaultProjectId(), options = {}) {
      const docs = loadProjectDocuments(projectId);
      docs.push(doc);
      saveProjectDocuments(docs, projectId, options);
    }

    function createDocumentFromLog(log) {
      return {
        id: `FS-DOC-${log.id || Date.now()}`,
        category: 'daily',
        description: log.work || 'Actividad registrada en FormSync',
        fileName: `FormSync_${formatDate(log.date || new Date().toISOString())}.pdf`,
        fileSize: 180000,
        fileType: 'application/pdf',
        url: '#',
        uploadDate: log.createdAt || new Date().toISOString(),
        uploadedBy: (log.crew && log.crew[0]) || 'Equipo Operativo',
        origin: 'formsync',
        linkedLogId: log.id
      };
    }

    function registerFormSyncDocument(logEntry) {
      const projectId = resolveDefaultProjectId();
      if (!projectId || !logEntry) return;
      const documents = loadProjectDocuments(projectId);
      if (documents.some(doc => doc.origin === 'formsync' && doc.linkedLogId === logEntry.id)) {
        return;
      }
      documents.push(createDocumentFromLog(logEntry));
      saveProjectDocuments(documents, projectId, { silent: true });
      renderDocumentsList();
    }

    function ensureFormSyncDocuments() {
      const projectId = resolveDefaultProjectId();
      if (!projectId) return;
      const documents = loadProjectDocuments(projectId);
      const linked = new Set(
        documents
          .filter(doc => doc.origin === 'formsync' && doc.linkedLogId)
          .map(doc => doc.linkedLogId)
      );
      const logsKey = `daily_logs_${projectId}`;
      let logs = [];
      try {
        logs = JSON.parse(localStorage.getItem(logsKey) || '[]');
      } catch (err) {
        logs = [];
      }
      let updatedLogs = false;
      let updatedDocs = false;
      logs.forEach((log, idx) => {
        if (!log.id) {
          log.id = `LOG-${Date.now()}-${idx}`;
          updatedLogs = true;
        }
        if (linked.has(log.id)) return;
        documents.push(createDocumentFromLog(log));
        linked.add(log.id);
        updatedDocs = true;
      });
      if (updatedLogs) {
        localStorage.setItem(logsKey, JSON.stringify(logs));
      }
      if (updatedDocs) {
        saveProjectDocuments(documents, projectId, { silent: true });
      }
    }

    // Renderizar lista de documentos con secciones
    function renderDocumentsList() {
      ensureFormSyncDocuments();
      const allDocs = loadProjectDocuments();
      const manualDocs = allDocs.filter(doc => doc.origin !== 'formsync');
      const generatedDocs = allDocs.filter(doc => doc.origin === 'formsync');
      const listEl = document.getElementById('documents-list');
      if (!listEl) return;

      const categoryEmoji = { contrato: '📄', permiso: '📋', factura: '💰', plano: '📐', manual: '📚', otro: '📎', daily: '📝', foto: '🖼️' };
      const categoryName = { contrato: 'Contrato', permiso: 'Permiso', factura: 'Factura', plano: 'Plano', manual: 'Manual', otro: 'Otro', daily: 'FormSync', foto: 'Fotos' };
      const categoryColor = { contrato: '#3b82f6', permiso: '#10b981', factura: '#f59e0b', plano: '#8b5cf6', manual: '#06b6d4', otro: '#64748b', daily: '#0ea5e9', foto: '#16a34a' };

      const counts = {
        all: allDocs.length,
        contrato: allDocs.filter(d => d.category === 'contrato').length,
        permiso: allDocs.filter(d => d.category === 'permiso').length,
        factura: allDocs.filter(d => d.category === 'factura').length,
        plano: allDocs.filter(d => d.category === 'plano').length,
        manual: allDocs.filter(d => d.category === 'manual').length,
        otro: allDocs.filter(d => d.category === 'otro').length,
        daily: allDocs.filter(d => d.category === 'daily').length
      };
      Object.keys(counts).forEach(cat => {
        const counter = document.getElementById(`doc-count-${cat}`);
        if (counter) counter.textContent = counts[cat];
      });

      const applyFilter = docs => currentDocFilter === 'all' ? docs : docs.filter(d => d.category === currentDocFilter);
      const filteredProjectDocs = applyFilter(manualDocs);
      const filteredGeneratedDocs = applyFilter(generatedDocs);

      const renderCards = docs => {
        if (docs.length === 0) {
          return `<div style="text-align: center; padding: 24px; color: #94a3b8; border: 1px dashed #e5e7eb; border-radius: 10px;">Sin elementos en esta sección</div>`;
        }
        return docs.map(doc => {
          const fileIcon = getFileIcon(doc.fileName);
          const fileSize = doc.fileSize ? formatFileSize(doc.fileSize) : '';
          const sourceBadge = doc.origin === 'formsync'
            ? `<span style="background:#0ea5e9; color:white; padding:2px 8px; border-radius:6px; font-size:11px; font-weight:700;">FormSync</span>`
            : `<span style="background:#e2e8f0; color:#475569; padding:2px 8px; border-radius:6px; font-size:11px; font-weight:700;">Manual</span>`;
          return `
            <div class="doc-item" style="padding: 16px; background: white; border: 2px solid #e5e7eb; border-radius: 12px; display: flex; align-items: center; gap: 16px; transition: all 0.2s; cursor: pointer;" onmouseover="this.style.borderColor='#cbd5e1'" onmouseout="this.style.borderColor='#e5e7eb'" onclick="viewDocument('${doc.id}')">
              <div style="font-size: 32px;">${fileIcon}</div>
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                  <span style="font-weight: 600; font-size: 14px; color: #1e293b;">${doc.fileName}</span>
                  <span style="background: ${categoryColor[doc.category] || '#02735E'}; color: white; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 700;">
                    ${categoryEmoji[doc.category] || '📎'} ${categoryName[doc.category] || 'Documento'}
                  </span>
                  ${sourceBadge}
                </div>
                ${doc.description ? `<div style="font-size: 12px; color: #64748b; margin-bottom: 6px;">${doc.description}</div>` : ''}
                <div style="font-size: 11px; color: #94a3b8;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                  </svg>
                  ${doc.uploadDate ? new Date(doc.uploadDate).toLocaleDateString('es-MX', { year: 'numeric', month: 'short', day: 'numeric' }) : 'Sin fecha'}
                  ${fileSize ? ` • ${fileSize}` : ''}
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button type="button" onclick="event.stopPropagation(); downloadDocument('${doc.id}')" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: none; padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'" onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                  </svg>
                  Descargar
                </button>
                <button type="button" onclick="event.stopPropagation(); deleteDocument('${doc.id}')" style="background: #fee2e2; color: #dc2626; border: none; padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#fecaca'" onmouseout="this.style.background='#fee2e2'">
                  🗑️ Eliminar
                </button>
              </div>
            </div>
          `;
        }).join('');
      };

      if (filteredProjectDocs.length === 0 && filteredGeneratedDocs.length === 0) {
        listEl.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #94a3b8;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px;">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
              <polyline points="13 2 13 9 20 9"/>
            </svg>
            <p style="font-size: 15px; font-weight: 500; margin-bottom: 8px;">${currentDocFilter === 'all' ? 'No hay documentos en este proyecto' : 'No hay documentos en esta categoría'}</p>
            <p style="font-size: 13px; color: #cbd5e1;">Sube documentos para mantener toda la información organizada</p>
          </div>
        `;
        return;
      }

      listEl.innerHTML = `
        <div class="grid-2" style="gap:16px;">
          <div>
            <div style="font-weight:700; color:#0f172a; margin-bottom:8px;">Documentos del Proyecto</div>
            ${renderCards(filteredProjectDocs)}
          </div>
          <div>
            <div style="font-weight:700; color:#0f172a; margin-bottom:8px;">Generados desde MotorSync</div>
            ${renderCards(filteredGeneratedDocs)}
          </div>
        </div>
      `;
    }

    // Filtrar documentos
    function filterDocuments(category) {
      currentDocFilter = category;
      
      // Actualizar botones activos
      document.querySelectorAll('.doc-filter').forEach(btn => {
        if (btn.dataset.category === category) {
          btn.style.background = 'linear-gradient(135deg, #02735E, #035951)';
          btn.style.color = 'white';
          btn.classList.add('active');
        } else {
          btn.style.background = 'white';
          btn.style.color = '#64748b';
          btn.classList.remove('active');
        }
      });
      
      renderDocumentsList();
    }

    // Abrir modal de subir documento
    function openUploadDocumentModal() {
      const modalHTML = `
        <div id="uploadDocumentModal" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s;">
          <div style="background: white; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
              <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: #1e293b;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Subir Documento
              </h3>
              <button type="button" onclick="closeUploadDocumentModal()" style="background: none; border: none; font-size: 28px; color: #94a3b8; cursor: pointer; line-height: 1; padding: 0; width: 32px; height: 32px;">&times;</button>
            </div>

            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #334155; font-size: 14px;">
                Categoría *
              </label>
              <select id="docCategory" style="width: 100%; padding: 12px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white;">
                <option value="">Seleccionar categoría...</option>
                <option value="contrato">📄 Contrato - Acuerdos legales</option>
                <option value="permiso">📋 Permiso - Autorizaciones</option>
                <option value="factura">💰 Factura - Comprobantes de pago</option>
                <option value="plano">📐 Plano - Diseños técnicos</option>
                <option value="manual">📚 Manual - Instrucciones</option>
                <option value="otro">📎 Otro - Documentos varios</option>
              </select>
            </div>

            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #334155; font-size: 14px;">
                Descripción (opcional)
              </label>
              <input type="text" id="docDescription" placeholder="Ej: Contrato firmado con cliente" style="width: 100%; padding: 12px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 24px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #334155; font-size: 14px;">
                Seleccionar Archivo *
              </label>
              <input type="file" id="docFile" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.jpg,.jpeg,.png" style="width: 100%; padding: 12px 14px; border: 2px dashed #cbd5e1; border-radius: 8px; font-size: 14px; background: #f8fafc; cursor: pointer;">
              <p style="font-size: 12px; color: #94a3b8; margin-top: 8px;">Formatos: PDF, DOC, DOCX, XLS, XLSX, TXT, JPG, PNG (máx 20MB)</p>
            </div>

            <div style="display: flex; gap: 12px;">
              <button type="button" onclick="closeUploadDocumentModal()" style="flex: 1; padding: 14px; border: 2px solid #e5e7eb; background: white; color: #64748b; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                Cancelar
              </button>
              <button type="button" onclick="confirmUploadDocument()" style="flex: 1; padding: 14px; border: none; background: linear-gradient(135deg, #02735E, #035951); color: white; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                Subir Documento
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    // Cerrar modal de subir
    function closeUploadDocumentModal() {
      const modal = document.getElementById('uploadDocumentModal');
      if (modal) modal.remove();
    }

    // Confirmar subida de documento
    function confirmUploadDocument() {
      const category = document.getElementById('docCategory').value;
      const description = document.getElementById('docDescription').value.trim();
      const fileInput = document.getElementById('docFile');
      
      if (!category) {
        alert('❌ Error\n\nPor favor selecciona una categoría para el documento.');
        return;
      }
      
      if (!fileInput.files || fileInput.files.length === 0) {
        alert('❌ Error\n\nPor favor selecciona un archivo para subir.');
        return;
      }
      
      const file = fileInput.files[0];
      
      // Validar tamaño (20MB máx)
      if (file.size > 20 * 1024 * 1024) {
        alert('❌ Error\n\nEl archivo excede el tamaño máximo de 20MB.');
        return;
      }
      
      // Leer archivo como Base64
      const reader = new FileReader();
      reader.onload = function(e) {
        const documents = loadProjectDocuments();
        
        const newDoc = {
          id: 'DOC-' + Date.now(),
          category: category,
          description: description || null,
          fileName: file.name,
          fileSize: file.size,
          fileType: file.type,
          url: e.target.result, // Base64 data URL
          uploadDate: new Date().toISOString(),
          uploadedBy: 'Usuario Actual',
          origin: 'manual'
        };
        
        documents.push(newDoc);
        saveProjectDocuments(documents);
        
        closeUploadDocumentModal();
        
        // Cambiar a la categoría del documento subido
        filterDocuments(category);
        
        alert(`✅ Documento Subido\n\n📁 Archivo: ${file.name}\n📂 Categoría: ${getCategoryNameDoc(category)}\n💾 Tamaño: ${formatFileSize(file.size)}\n${description ? '📝 Descripción: ' + description : ''}\n\nEl documento se ha guardado correctamente.`);
      };
      
      reader.readAsDataURL(file);
    }

    // Ver documento
    function viewDocument(docId) {
      const documents = loadProjectDocuments();
      const doc = documents.find(d => d.id === docId);
      
      if (!doc) return;
      if (!doc.url || doc.url === '#') {
        uiToast('info', 'Documento demo disponible solo como referencia.');
        return;
      }
      
      // Si es PDF o imagen, abrir en nueva pestaña
      if (doc.fileType.includes('pdf') || doc.fileType.includes('image')) {
        window.open(doc.url, '_blank');
      } else {
        // Para otros archivos, descargar directamente
        downloadDocument(docId);
      }
    }

    // Descargar documento
    function downloadDocument(docId) {
      const documents = loadProjectDocuments();
      const doc = documents.find(d => d.id === docId);
      
      if (!doc) return;
      if (!doc.url || doc.url === '#') {
        uiToast('info', 'Documento demo disponible solo como referencia.');
        return;
      }
      
      const link = document.createElement('a');
      link.href = doc.url;
      link.download = doc.fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      alert(`📥 Descargando...\n\n${doc.fileName}\n\nEl archivo se está descargando.`);
    }

    // Eliminar documento
    async function deleteDocument(docId) {
      const ok = await uiConfirm('⚠️ Eliminar Documento\n\n¿Estás seguro de eliminar este documento?\n\nEsta acción no se puede deshacer.', {
        confirmText: 'Eliminar',
        cancelText: 'Cancelar'
      });
      if (!ok) return;
      
      const documents = loadProjectDocuments();
      const filtered = documents.filter(d => d.id !== docId);
      
      saveProjectDocuments(filtered);
      
      uiToast('success', 'Documento eliminado correctamente.');
    }

    // Helper: obtener icono de archivo
    function getFileIcon(fileName) {
      const ext = fileName.split('.').pop().toLowerCase();
      
      const icons = {
        pdf: '📕',
        doc: '📘',
        docx: '📘',
        xls: '📗',
        xlsx: '📗',
        txt: '📄',
        jpg: '🖼️',
        jpeg: '🖼️',
        png: '🖼️'
      };
      
      return icons[ext] || '📎';
    }

    // Helper: formatear tamaño de archivo
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Helper: obtener nombre de categoría
    function getCategoryNameDoc(category) {
      const names = {
        contrato: 'Contrato',
        permiso: 'Permiso',
        factura: 'Factura',
        plano: 'Plano',
        manual: 'Manual',
        otro: 'Otro',
        daily: 'FormSync'
      };
      return names[category] || category;
    }

    // ============================================================================
    // TOAST NOTIFICATION SYSTEM
    // ============================================================================

    /**
     * Muestra un toast notification
     * @param {string} message - Mensaje a mostrar
     * @param {string} type - Tipo: 'success', 'error', 'warning', 'info'
     * @param {number} duration - Duración en ms (default: 4000)
     */
    function showToast(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toastContainer');
      if (!container) {
        console.error('❌ Toast container not found');
        return;
      }

      const toastId = 'toast-' + Date.now();
      
      const icons = {
        success: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>`,
        error: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="15" y1="9" x2="9" y2="15"/>
                  <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>`,
        warning: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                   <line x1="12" y1="9" x2="12" y2="13"/>
                   <line x1="12" y1="17" x2="12.01" y2="17"/>
                 </svg>`,
        info: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                 <circle cx="12" cy="12" r="10"/>
                 <line x1="12" y1="16" x2="12" y2="12"/>
                 <line x1="12" y1="8" x2="12.01" y2="8"/>
               </svg>`
      };

      const toastHTML = `
        <div id="${toastId}" class="toast ${type}">
          <div class="toast-icon">
            ${icons[type] || icons.info}
          </div>
          <div class="toast-message">${message}</div>
          <button type="button" class="toast-close" onclick="removeToast('${toastId}')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
      `;

      container.insertAdjacentHTML('beforeend', toastHTML);

      // Auto-dismiss después de 'duration' ms
      setTimeout(() => {
        removeToast(toastId);
      }, duration);
    }

    function removeToast(toastId) {
      const toast = document.getElementById(toastId);
      if (toast) {
        toast.classList.add('removing');
        setTimeout(() => {
          toast.remove();
        }, 300);
      }
    }

    // ============================================================================
    // EXPORTAR PROYECTO INDIVIDUAL A PDF
    // ============================================================================
    function exportProjectToPDF() {
      if (!currentProject) {
        showToast('error', 'No hay proyecto cargado para exportar');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 15;
      let y = margin;
      
      function checkPageBreak(incrementY) {
        if (y + incrementY > pageHeight - margin) {
          doc.addPage();
          y = margin;
          return true;
        }
        return false;
      }
      
      // Encabezado
      doc.setFillColor(2, 115, 94);
      doc.rect(0, 0, pageWidth, 40, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(26);
      doc.setFont(undefined, 'bold');
      doc.text('ViewSync', margin, 18);
      
      doc.setFontSize(13);
      doc.setFont(undefined, 'normal');
      doc.text('Reporte Detallado del Proyecto', margin, 28);
      
      doc.setFontSize(9);
      const dateStr = new Date().toLocaleDateString('es-MX', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      doc.text(dateStr, pageWidth - margin, 28, { align: 'right' });
      
      y = 50;
      
      // ID del Proyecto
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.text(`ID: ${currentProject.idSync || currentProject.id}`, margin, y);
      y += 10;
      
      // Título del proyecto
      doc.setFontSize(16);
      const titleText = currentProject.clientName || 'Proyecto sin nombre';
      const titleLines = doc.splitTextToSize(titleText, pageWidth - 2 * margin);
      doc.text(titleLines, margin, y);
      y += titleLines.length * 7 + 8;
      
      // Estado
      const estadoLabels = {
        'lead': 'Lead',
        'scheduled': 'Agendado',
        'confirmed': 'Confirmado',
        'in_progress': 'En Progreso',
        'completed': 'Completado',
        'invoiced': 'Facturado',
        'paid': 'Pagado',
        'cancelled': 'Cancelado'
      };
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text(`Estado: ${estadoLabels[currentProject.estado] || 'N/A'}`, margin, y);
      y += 8;
      
      // Información del Cliente
      checkPageBreak(40);
      doc.setFontSize(13);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(2, 115, 94);
      doc.text('Información del Cliente', margin, y);
      y += 10;
      
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      
      doc.text(`Nombre: ${currentProject.clientName || 'N/A'}`, margin + 5, y);
      y += 6;
      doc.text(`Teléfono: ${currentProject.phone || 'N/A'}`, margin + 5, y);
      y += 6;
      doc.text(`Email: ${currentProject.email || 'N/A'}`, margin + 5, y);
      y += 6;
      
      if (currentProject.serviceAddress) {
        const addressLines = doc.splitTextToSize(`Dirección: ${currentProject.serviceAddress}`, pageWidth - 2 * margin - 10);
        doc.text(addressLines, margin + 5, y);
        y += addressLines.length * 6 + 6;
      }
      
      // Información del Servicio
      checkPageBreak(30);
      doc.setFontSize(13);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(2, 115, 94);
      doc.text('Detalles del Servicio', margin, y);
      y += 10;
      
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      
      if (currentProject.serviceType) {
        doc.text(`Tipo de Servicio: ${currentProject.serviceType}`, margin + 5, y);
        y += 6;
      }
      
      if (currentProject.estimatedPrice) {
        doc.setFont(undefined, 'bold');
        doc.setTextColor(2, 115, 94);
        doc.text(`Precio Estimado: $${parseFloat(currentProject.estimatedPrice).toLocaleString('es-MX')}`, margin + 5, y);
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'normal');
        y += 6;
      }
      
      if (currentProject.description) {
        y += 2;
        doc.setFontSize(9);
        const descLines = doc.splitTextToSize(`Descripción: ${currentProject.description}`, pageWidth - 2 * margin - 10);
        doc.text(descLines, margin + 5, y);
        y += descLines.length * 5 + 8;
      }
      
      // Checklist
      const checklistKey = `project_checklist_${currentProject.idSync || currentProject.id}`;
      const checklist = JSON.parse(localStorage.getItem(checklistKey) || '[]');
      
      if (checklist.length > 0) {
        checkPageBreak(20);
        doc.setFontSize(13);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(2, 115, 94);
        doc.text('Checklist Operativo', margin, y);
        y += 10;
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        
        const completed = checklist.filter(t => t.completed).length;
        doc.text(`Progreso: ${completed} de ${checklist.length} tareas completadas (${Math.round((completed / checklist.length) * 100)}%)`, margin + 5, y);
        y += 8;
        
        checklist.forEach((task, idx) => {
          checkPageBreak(8);
          const checkbox = task.completed ? '☑' : '☐';
          const taskText = `${checkbox} ${task.task}`;
          doc.text(taskText, margin + 8, y);
          y += 5;
        });
        
        y += 6;
      }
      
      // Fotos
      const photosKey = `project_photos_${currentProject.idSync || currentProject.id}`;
      const photos = JSON.parse(localStorage.getItem(photosKey) || '[]');
      
      if (photos.length > 0) {
        checkPageBreak(20);
        doc.setFontSize(13);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(2, 115, 94);
        doc.text('Evidencias Fotográficas', margin, y);
        y += 10;
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text(`Total de fotos adjuntas: ${photos.length}`, margin + 5, y);
        y += 6;
        
        photos.forEach((photo, idx) => {
          checkPageBreak(6);
          const photoDate = new Date(photo.timestamp).toLocaleDateString('es-MX');
          doc.text(`${idx + 1}. ${photo.caption || 'Sin descripción'} - ${photoDate}`, margin + 8, y);
          y += 5;
        });
        
        y += 6;
      }
      
      // Documentos
      const docsKey = `project_documents_${currentProject.idSync || currentProject.id}`;
      const documents = JSON.parse(localStorage.getItem(docsKey) || '[]');
      
      if (documents.length > 0) {
        checkPageBreak(20);
        doc.setFontSize(13);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(2, 115, 94);
        doc.text('Documentos Adjuntos', margin, y);
        y += 10;
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text(`Total de documentos: ${documents.length}`, margin + 5, y);
        y += 6;
        
        documents.forEach((docItem, idx) => {
          checkPageBreak(6);
          const docDate = new Date(docItem.timestamp).toLocaleDateString('es-MX');
          const docType = docItem.type === 'change_order' ? 'Change Order' : 'Documento';
          doc.text(`${idx + 1}. ${docType} - ${docItem.title || 'Sin título'} - ${docDate}`, margin + 8, y);
          y += 5;
        });
        
        y += 6;
      }
      
      // Notas adicionales
      if (currentProject.notes) {
        checkPageBreak(20);
        doc.setFontSize(13);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(2, 115, 94);
        doc.text('Notas Adicionales', margin, y);
        y += 10;
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        const notesLines = doc.splitTextToSize(currentProject.notes, pageWidth - 2 * margin - 10);
        doc.text(notesLines, margin + 5, y);
        y += notesLines.length * 5 + 6;
      }
      
      // Pie de página
      const totalPages = doc.internal.getNumberOfPages();
      for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(`Página ${i} de ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
        doc.text(`${currentProject.idSync || currentProject.id} - Generado por Opsis Suite ViewSync`, pageWidth / 2, pageHeight - 6, { align: 'center' });
      }
      
      // Guardar
      const filename = `ViewSync_${currentProject.idSync || currentProject.id}_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(filename);
      
      showToast('success', `PDF exportado exitosamente: ${filename}`);
    }

    // ============================================================================
    // SISTEMA DE ASIGNACIÓN DE PERSONAL
    // ============================================================================

    const STAFF_KEY = 'motorsync_staff';
    let selectedStaffIds = [];
    let assignedStaff = [];

    // Renderizar equipo asignado
    function renderAssignedTeam() {
      const container = document.getElementById('assignedTeamList');
      
      if (!currentProject) return;
      
      const assignmentsKey = `project_staff_${currentProject.idSync || currentProject.id}`;
      assignedStaff = JSON.parse(localStorage.getItem(assignmentsKey) || '[]');
      
      if (assignedStaff.length === 0) {
        container.innerHTML = `
          <div class="assigned-team-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            <p style="font-size: 14px; margin-bottom: 8px;">No hay personal asignado a este proyecto</p>
            <p style="font-size: 12px;">Haz clic en "Asignar Personal" para agregar miembros del equipo</p>
          </div>
        `;
        return;
      }
      
      const allStaff = JSON.parse(localStorage.getItem(STAFF_KEY) || '[]');
      
      container.innerHTML = assignedStaff.map(assignment => {
        const staff = allStaff.find(s => s.id === assignment.staffId);
        if (!staff) return '';
        
        const initials = staff.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        
        return `
          <div class="team-member">
            <div class="avatar">${initials}</div>
            <div class="member-info">
              <div class="member-name">${staff.name}</div>
              <div class="member-role">
                <span class="role-badge ${staff.role}">${getRoleLabel(staff.role)}</span>
                ${assignment.projectRole ? ` • ${assignment.projectRole}` : ''}
              </div>
              <div style="font-size:12px; color:#6b7280;">
                ${assignment.phase ? `Fase: ${assignment.phase} • ` : ''}Asignado: ${formatDate(assignment.assignedDate || new Date())}
              </div>
            </div>
            <button type="button" class="btn btn-white" onclick="contactStaff('${staff.name}', '${staff.phone}')" title="Contactar">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
              </svg>
            </button>
            <button type="button" class="btn btn-white" onclick="removeStaffFromProject('${staff.id}')" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border-color: rgba(239, 68, 68, 0.3);" title="Remover">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        `;
      }).join('');
    }

    // Obtener label del rol
    function getRoleLabel(role) {
      const labels = {
        'owner': 'Owner',
        'admin': 'Admin',
        'tech': 'Técnico',
        'supervisor': 'Supervisor'
      };
      return labels[role] || role;
    }

    // Contactar staff
    async function contactStaff(name, phone) {
      const ok = await uiConfirm(`¿Contactar a ${name}?\n\nTeléfono: ${phone}\n\n¿Deseas llamar ahora?`, {
        confirmText: 'Llamar',
        cancelText: 'Cancelar'
      });
      if (!ok) return;
      window.location.href = `tel:${phone}`;
    }

    // Remover staff del proyecto
    async function removeStaffFromProject(staffId) {
      const ok = await uiConfirm('¿Estás seguro de remover este miembro del equipo?', {
        confirmText: 'Remover',
        cancelText: 'Cancelar'
      });
      if (!ok) return;
      
      const assignmentsKey = `project_staff_${currentProject.idSync || currentProject.id}`;
      let assignments = JSON.parse(localStorage.getItem(assignmentsKey) || '[]');
      
      assignments = assignments.filter(a => a.staffId !== staffId);
      localStorage.setItem(assignmentsKey, JSON.stringify(assignments));
      
      renderAssignedTeam();
      showToast('success', 'Miembro removido del proyecto');
    }

    // Abrir modal de asignación
    function openAssignStaffModal() {
      selectedStaffIds = [];
      
      // Pre-seleccionar staff ya asignado
      const assignmentsKey = `project_staff_${currentProject.idSync || currentProject.id}`;
      const currentAssignments = JSON.parse(localStorage.getItem(assignmentsKey) || '[]');
      selectedStaffIds = currentAssignments.map(a => a.staffId);
      
      renderAvailableStaff();
      
      const modal = document.getElementById('assignStaffModal');
      modal.style.display = 'flex';
      modal.style.animation = 'fadeIn 0.2s ease';
    }

    // Cerrar modal
    function closeAssignStaffModal() {
      const modal = document.getElementById('assignStaffModal');
      modal.style.display = 'none';
    }

    // Renderizar staff disponible
    function renderAvailableStaff(filter = '') {
      const container = document.getElementById('availableStaffList');
      const allStaff = JSON.parse(localStorage.getItem(STAFF_KEY) || '[]');
      
      let filtered = allStaff;
      
      if (filter) {
        const searchLower = filter.toLowerCase();
        filtered = allStaff.filter(s => 
          s.name.toLowerCase().includes(searchLower) ||
          s.email.toLowerCase().includes(searchLower) ||
          s.role.toLowerCase().includes(searchLower)
        );
      }
      
      if (filtered.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No se encontró personal</p>';
        return;
      }
      
      container.innerHTML = filtered.map(staff => {
        const isSelected = selectedStaffIds.includes(staff.id);
        const initials = staff.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        
        return `
          <div class="staff-item ${isSelected ? 'selected' : ''}" onclick="toggleStaffSelection('${staff.id}')">
            <div class="staff-checkbox"></div>
            <div class="avatar">${initials}</div>
            <div class="staff-details">
              <div class="staff-name">${staff.name}</div>
              <div class="staff-meta">
                <span class="role-badge ${staff.role}">${getRoleLabel(staff.role)}</span>
                <span>${staff.email}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Filtrar lista de staff
    function filterStaffList() {
      const input = document.getElementById('staffSearchInput');
      renderAvailableStaff(input.value);
    }

    // Toggle selección de staff
    window.toggleStaffSelection = function(staffId) {
      if (selectedStaffIds.includes(staffId)) {
        selectedStaffIds = selectedStaffIds.filter(id => id !== staffId);
      } else {
        selectedStaffIds.push(staffId);
      }
      renderAvailableStaff(document.getElementById('staffSearchInput').value);
    };

    // Guardar asignaciones
    function saveStaffAssignments() {
      const assignmentsKey = `project_staff_${currentProject.idSync || currentProject.id}`;
      const phaseNote = document.getElementById('assignPhaseInput')?.value || '';
      
      const assignments = selectedStaffIds.map(staffId => ({
        staffId: staffId,
        assignedDate: new Date().toISOString(),
        projectRole: null, // Se puede extender para asignar roles específicos
        phase: phaseNote
      }));
      
      localStorage.setItem(assignmentsKey, JSON.stringify(assignments));
      
      closeAssignStaffModal();
      renderAssignedTeam();
      
      showToast('success', `${assignments.length} miembro${assignments.length !== 1 ? 's' : ''} asignado${assignments.length !== 1 ? 's' : ''} al proyecto`);
    }

    // Inicializar al cargar página
    document.addEventListener('DOMContentLoaded', () => {
      // Renderizar equipo asignado cuando se cargue el proyecto
      if (currentProject) {
        renderAssignedTeam();
        renderProjectTimeline();
      }
    });

    // ============================================================================
    // TIMELINE VISUAL DEL PROYECTO
    // ============================================================================

    function renderProjectTimeline() {
      const container = document.getElementById('timelineChart');
      if (!container || !currentProject) return;

      const timelineKey = `project_timeline_${currentProject.idSync || currentProject.id}`;
      let timeline = loadTimelineSnapshot(currentProject);
      let shouldPersist = false;

      if (timeline && (!timeline.phases || !timeline.phases.length) && Array.isArray(timeline.tasks)) {
        const baseStart = timeline.startDate || currentProject.startDate || toInputDate(new Date());
        const baseDate = baseStart ? new Date(baseStart) : new Date();
        const phasesFromTasks = timeline.tasks.map((task, idx) => {
          const offset = Number(task.startOffset) || 0;
          const duration = Math.max(1, Number(task.duration) || 1);
          const startDate = addDays(baseDate, offset) || baseDate;
          const endDate = addDays(startDate, duration - 1) || startDate;
          return {
            id: idx + 1,
            name: task.label || `Fase ${idx + 1}`,
            start: toInputDate(startDate),
            end: toInputDate(endDate),
            status: task.status || 'pending',
            progress: task.status === 'completed' ? 100 : task.status === 'in-progress' ? 60 : 0
          };
        });
        timeline.phases = phasesFromTasks;
        timeline.startDate = timeline.startDate || phasesFromTasks[0]?.start;
        timeline.endDate = timeline.endDate || phasesFromTasks[phasesFromTasks.length - 1]?.end;
        shouldPersist = true;
      }

      // Si no existe timeline, crear uno de ejemplo o construir desde programación
      if (!timeline || !timeline.phases || !timeline.phases.length) {
        const scheduleKey = `project_schedule_${currentProject.idSync || currentProject.id}`;
        const phasesSched = JSON.parse(localStorage.getItem(scheduleKey) || '[]');
        if (phasesSched.length) {
          const startDates = phasesSched.map(p => new Date(p.start)).filter(d => !isNaN(d));
          const endDates = phasesSched.map(p => new Date(p.end)).filter(d => !isNaN(d));
          const minStart = startDates.length ? new Date(Math.min(...startDates)) : new Date();
          const maxEnd = endDates.length ? new Date(Math.max(...endDates)) : new Date(minStart.getTime() + 7 * DAY_IN_MS);
          timeline = {
            startDate: toInputDate(minStart),
            endDate: toInputDate(maxEnd),
            phases: phasesSched.map((p, idx) => ({
              id: idx + 1,
              name: p.title || 'Etapa',
              start: p.start,
              end: p.end || p.start,
              status: p.status || 'pending',
              progress: p.status === 'completed' ? 100 : p.status === 'in-progress' ? 60 : 0
            })),
            milestones: [],
            tasks: phasesSched.map((p, idx) => ({
              label: p.title || `Etapa ${idx + 1}`,
              startOffset: Math.max(0, diffInDays(minStart, p.start)),
              duration: Math.max(1, diffInDays(p.start, p.end || p.start) + 1),
              status: p.status || 'pending'
            }))
          };
        } else {
          timeline = {
            startDate: '2024-11-10',
            endDate: '2024-11-19',
            phases: [
              { id: 1, name: 'Inspección Inicial', start: '2024-11-10', end: '2024-11-11', status: 'completed', progress: 100 },
              { id: 2, name: 'Instalación Sistema', start: '2024-11-12', end: '2024-11-14', status: 'completed', progress: 100 },
              { id: 3, name: 'Pruebas y Ajustes', start: '2024-11-15', end: '2024-11-17', status: 'in-progress', progress: 60 },
              { id: 4, name: 'Verificación Final', start: '2024-11-18', end: '2024-11-19', status: 'pending', progress: 0 }
            ],
            milestones: [
              { id: 1, name: 'Inicio', date: '2024-11-10' },
              { id: 2, name: 'Inspección OK', date: '2024-11-11' },
              { id: 3, name: 'Sistema Instalado', date: '2024-11-14' },
              { id: 4, name: 'Entrega', date: '2024-11-19' }
            ],
            tasks: [
              { label: 'Inspección Inicial', startOffset: 0, duration: 2, status: 'completed' },
              { label: 'Instalación Sistema', startOffset: 2, duration: 3, status: 'completed' },
              { label: 'Pruebas y Ajustes', startOffset: 5, duration: 3, status: 'in-progress' },
              { label: 'Verificación Final', startOffset: 8, duration: 2, status: 'pending' }
            ]
          };
        }
        shouldPersist = true;
      }

      if (shouldPersist && timeline) {
        localStorage.setItem(timelineKey, JSON.stringify(timeline));
      }

      const timelineStartDate = new Date(timeline.startDate);
      const timelineEndDate = new Date(timeline.endDate);
      const timelineTotalDays = Math.max(1, Math.ceil((timelineEndDate - timelineStartDate) / DAY_IN_MS) + 1);

      const spanConfig = {
        phase: timelineTotalDays,
        month: Math.min(30, timelineTotalDays),
        week: Math.min(7, timelineTotalDays),
        day: Math.min(3, timelineTotalDays)
      };

      let viewSpanDays = spanConfig[timelineView] || timelineTotalDays;
      let viewStartDate = new Date(timelineStartDate);
      let viewEndDate = new Date(viewStartDate);
      viewEndDate.setDate(viewStartDate.getDate() + viewSpanDays - 1);

      const visiblePhases = timeline.phases.filter((phase) => {
        const start = new Date(phase.start);
        const end = new Date(phase.end);
        return end >= viewStartDate && start <= viewEndDate;
      });

      if (!visiblePhases.length) {
        container.innerHTML = `
          <div style="padding:32px; text-align:center; border:1px dashed var(--border-color); border-radius:12px;">
            <p style="margin-bottom:12px; font-weight:600; color:var(--text-primary);">No hay fases dentro de esta vista.</p>
            <p style="color:var(--text-secondary); font-size:14px;">Ajusta el rango del timeline o agrega nuevas fases para este periodo.</p>
          </div>
        `;
        return;
      }

      function calculateBarPosition(phaseStart, phaseEnd) {
        const phaseStartDate = new Date(phaseStart);
        const phaseEndDate = new Date(phaseEnd);
        const clampedStart = phaseStartDate < viewStartDate ? new Date(viewStartDate) : phaseStartDate;
        const clampedEnd = phaseEndDate > viewEndDate ? new Date(viewEndDate) : phaseEndDate;
        const daysFromStart = Math.max(0, Math.round((clampedStart - viewStartDate) / DAY_IN_MS));
        const phaseDuration = Math.max(1, Math.round((clampedEnd - clampedStart) / DAY_IN_MS) + 1);
        const left = (daysFromStart / viewSpanDays) * 100;
        const width = Math.min(100, (phaseDuration / viewSpanDays) * 100);
        return { left: `${left}%`, width: `${width}%` };
      }

      const tasksHTML = visiblePhases.map(phase => {
        const formatDate = (dateStr) => {
          const date = new Date(dateStr);
          return date.toLocaleDateString('es-MX', { month: 'short', day: 'numeric' });
        };

        return `
          <div class="timeline-task-label">
            <div>${phase.name}</div>
            <div class="timeline-task-date">${formatDate(phase.start)} - ${formatDate(phase.end)}</div>
          </div>
        `;
      }).join('');

      const barsHTML = visiblePhases.map(phase => {
        const position = calculateBarPosition(phase.start, phase.end);
        const statusClass = phase.status;
        
        return `
          <div class="timeline-bar-container">
            <div class="timeline-bar ${statusClass}" style="left: ${position.left}; width: ${position.width};" title="${phase.name}: ${phase.progress}%">
              ${phase.progress > 0 ? `${phase.progress}%` : ''}
            </div>
          </div>
        `;
      }).join('');

      const dateLabels = [];
      const labelFormatter = new Intl.DateTimeFormat('es-MX', { month: 'short', day: 'numeric' });
      if (timelineView === 'day') {
        for (let i = 0; i < viewSpanDays; i++) {
          const labelDate = new Date(viewStartDate);
          labelDate.setDate(viewStartDate.getDate() + i);
          dateLabels.push(labelDate.toLocaleDateString('es-MX', { weekday: 'short', day: 'numeric' }));
        }
      } else if (timelineView === 'week') {
        for (let i = 0; i < viewSpanDays; i++) {
          const labelDate = new Date(viewStartDate);
          labelDate.setDate(viewStartDate.getDate() + i);
          dateLabels.push(labelDate.toLocaleDateString('es-MX', { weekday: 'short' }));
        }
      } else if (timelineView === 'month') {
        const bucketSize = Math.max(1, Math.round(viewSpanDays / 4));
        for (let i = 0; i < viewSpanDays; i += bucketSize) {
          const labelDate = new Date(viewStartDate);
          labelDate.setDate(viewStartDate.getDate() + i);
          dateLabels.push(labelFormatter.format(labelDate));
        }
      } else {
        const bucketSize = Math.max(1, Math.round(viewSpanDays / 6));
        for (let i = 0; i < viewSpanDays; i += bucketSize) {
          const labelDate = new Date(viewStartDate);
          labelDate.setDate(viewStartDate.getDate() + i);
          dateLabels.push(labelFormatter.format(labelDate));
        }
      }

      const labelsHTML = dateLabels.map(label => `<span>${label}</span>`).join('');

      container.innerHTML = `
        <div class="timeline-grid">
          <div class="timeline-tasks">
            ${tasksHTML}
          </div>
          <div class="timeline-bars">
            ${barsHTML}
          </div>
        </div>
        <div class="timeline-labels">
          ${labelsHTML}
        </div>
      `;
    }

    function setTimelineView(mode) {
      timelineView = mode;
      renderProjectTimeline();
      uiToast('info', `Vista de timeline: ${mode}`);
    }

    // Programación detallada (card)
    function renderScheduleBlocks() {
      const container = document.getElementById('schedule-blocks');
      if (!container) return;
      const phases = ensureProjectSchedule(currentProject);
      const statusColor = {
        'completed': { bg: '#f0fdf4', border: '#10b981', label: 'COMPLETADO', text: '#065f46' },
        'in-progress': { bg: '#fef3c7', border: '#f59e0b', label: 'EN PROGRESO', text: '#92400e' },
        'pending': { bg: '#f3f4f6', border: '#9ca3af', label: 'PENDIENTE', text: '#374151' },
        'cancelled': { bg: '#fee2e2', border: '#ef4444', label: 'CANCELADO', text: '#991b1b' }
      };
      container.innerHTML = phases.map(p => {
        const cfg = statusColor[p.status] || statusColor.pending;
        return `
          <div style="background:${cfg.bg}; border-left:4px solid ${cfg.border}; padding:16px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
              <div>
                <div style="font-weight:600; font-size:16px; margin-bottom:4px;">${p.title}</div>
                <div style="font-size:14px; color: var(--text-secondary);">${p.start || ''}${p.end ? ' - ' + p.end : ''}</div>
              </div>
              <span style="background:${cfg.border}; color:white; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:600;">${cfg.label}</span>
            </div>
            ${p.notes ? `<div style="font-size:14px; margin-top:12px; color:${cfg.text};">${p.notes}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    function syncScheduleToTimeline(phases) {
      if (!currentProject || !Array.isArray(phases) || !phases.length) return;
      const timelineKey = `project_timeline_${currentProject.idSync || currentProject.id}`;
      const existing = loadTimelineSnapshot(currentProject) || {};
      const startCandidate = phases.find(p => p.start)?.start || existing.startDate || currentProject.startDate || toInputDate(new Date());
      const endCandidate = [...phases].reverse().find(p => p.end)?.end || existing.endDate || currentProject.endDate || startCandidate;
      const normalizedPhases = phases.map((phase, idx) => {
        const start = phase.start || startCandidate;
        const end = phase.end && phase.end >= start ? phase.end : start;
        return {
          id: idx + 1,
          name: phase.title || `Fase ${idx + 1}`,
          start,
          end,
          status: phase.status || 'pending',
          progress: phase.status === 'completed' ? 100 : phase.status === 'in-progress' ? 60 : 0
        };
      });
      const anchorStart = normalizedPhases[0]?.start || startCandidate;
      const anchorEnd = normalizedPhases[normalizedPhases.length - 1]?.end || endCandidate;
      const tasks = normalizedPhases.map((phase) => ({
        label: phase.name,
        startOffset: Math.max(0, diffInDays(anchorStart, phase.start)),
        duration: Math.max(1, diffInDays(phase.start, phase.end) + 1),
        status: phase.status || 'pending'
      }));
      const payload = {
        ...existing,
        startDate: anchorStart,
        endDate: anchorEnd,
        phases: normalizedPhases,
        notes: existing.notes || '',
        tasks
      };
      localStorage.setItem(timelineKey, JSON.stringify(payload));
      renderProjectTimeline();
    }

    function syncTimelineToSchedule(phases) {
      if (!currentProject || !Array.isArray(phases) || !phases.length) return;
      const scheduleKey = `project_schedule_${currentProject.idSync || currentProject.id}`;
      const normalized = phases.map((phase, idx) => ({
        title: phase.name || phase.title || `Fase ${idx + 1}`,
        start: phase.start,
        end: phase.end || phase.start,
        status: phase.status || 'pending',
        notes: phase.notes || ''
      }));
      localStorage.setItem(scheduleKey, JSON.stringify(normalized));
      cachedSchedulePhases = normalized;
      renderScheduleBlocks();
    }

    function timelineRowTemplate(data, idx) {
      const status = data.status || 'pending';
      const statusOptions = ['pending', 'in-progress', 'completed'];
      const offsetVal = Number.isFinite(data.startOffset) ? data.startOffset : 0;
      const durationVal = data.duration || 1;
      return `
        <div class="timeline-row" data-idx="${idx}" style="display:flex; flex-direction:column; gap:10px; padding:12px; border:1px solid #e2e8f0; border-radius:12px; background:#fff;">
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <input class="form-input" data-field="label" value="${data.label || ''}" placeholder="Nombre de la fase" style="flex:1; min-width:220px;">
            <select class="form-select" data-field="status" style="min-width:160px;">
              ${statusOptions.map(opt => `<option value="${opt}" ${opt === status ? 'selected' : ''}>${opt === 'pending' ? 'Pendiente' : opt === 'in-progress' ? 'En Proceso' : 'Completado'}</option>`).join('')}
            </select>
            <button type="button" onclick="removeTimelineRow(${idx})" title="Eliminar fase" style="background:none;border:none;color:#94a3b8;font-size:20px;line-height:1;padding:4px 8px;cursor:pointer;">&times;</button>
          </div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:8px;">
            <div>
              <label class="form-label" style="font-size:12px;">Offset desde inicio (días)</label>
              <input class="form-input" data-field="startOffset" type="number" min="0" value="${offsetVal}">
            </div>
            <div>
              <label class="form-label" style="font-size:12px;">Duración (días)</label>
              <input class="form-input" data-field="duration" type="number" min="1" value="${durationVal}">
            </div>
            <div>
              <label class="form-label" style="font-size:12px;">Fecha inicio</label>
              <input class="form-input" data-field="startDate" type="date" value="${data.startDate || ''}">
            </div>
            <div>
              <label class="form-label" style="font-size:12px;">Fecha fin</label>
              <input class="form-input" data-field="endDate" type="date" value="${data.endDate || ''}">
            </div>
          </div>
          <div class="timeline-computed" data-computed="${idx}" style="display:flex; gap:12px; flex-wrap:wrap; font-size:12px;">
            <span style="background:#f1f5f9; border-radius:999px; padding:4px 10px; color:#0f172a;">
              Inicio estimado: <strong data-computed-start="${idx}">—</strong>
            </span>
            <span style="background:#ecfeff; border-radius:999px; padding:4px 10px; color:#0369a1;">
              Fin estimado: <strong data-computed-end="${idx}">—</strong>
            </span>
          </div>
        </div>
      `;
    }

    function quickAddTimelinePhase() {
      const existingModal = document.getElementById('timelineEditorModal');
      if (existingModal) {
        addTimelineRow();
        const rows = existingModal.querySelectorAll('.timeline-row');
        const lastRow = rows[rows.length - 1];
        if (lastRow) {
          lastRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
          const input = lastRow.querySelector('[data-field="label"]');
          if (input) input.focus();
          updateTimelineComputedRow(lastRow, existingModal);
        }
        return;
      }
      editTimeline({ prefillBlankPhase: true });
    }

    function editTimeline(options = {}) {
      const opts = options || {};
      const timeline = loadTimelineSnapshot(currentProject) || {};
      const startVal = timeline.startDate || currentProject.startDate || toInputDate(new Date());
      const endVal = timeline.endDate || currentProject.endDate || startVal;
      let basePhases = (timeline.phases && timeline.phases.length) ? timeline.phases : [];
      if (!basePhases.length && Array.isArray(timeline.tasks) && timeline.tasks.length) {
        basePhases = timeline.tasks.map((task, idx) => {
          const startDate = toInputDate(addDays(startVal, task.startOffset || 0)) || startVal;
          const endDate = toInputDate(addDays(startDate, Math.max(1, (task.duration || 1)) - 1)) || startDate;
          return {
            id: idx + 1,
            name: task.label || `Fase ${idx + 1}`,
            start: startDate,
            end: endDate,
            status: task.status
          };
        });
      }
      if (!basePhases.length) {
        basePhases = [
          { name: 'Inspección', start: startVal, end: toInputDate(addDays(startVal, 1)), status: 'completed' },
          { name: 'Instalación', start: toInputDate(addDays(startVal, 2)), end: toInputDate(addDays(startVal, 4)), status: 'in-progress' }
        ];
      }
      const normalizedRows = basePhases.map((phase, idx) => {
        const start = phase.start || startVal;
        const end = phase.end || start;
        return {
          label: phase.name || `Fase ${idx + 1}`,
          startOffset: Math.max(0, diffInDays(startVal, start)),
          duration: Math.max(1, diffInDays(start, end) + 1),
          startDate: start,
          endDate: end,
          status: phase.status || 'pending'
        };
      });
      const modal = document.createElement('div');
      modal.className = 'modal-overlay timeline-editor';
      modal.id = 'timelineEditorModal';
      modal.innerHTML = `
        <div class="modal" style="max-width: 860px;">
          <div class="modal-header">
            <div class="modal-title" style="gap:10px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
              Editar Timeline
            </div>
            <button type="button" class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
          </div>
          <div class="modal-body" style="display:grid; gap:16px;">
            <div class="form-group">
              <label class="form-label">Rango de fechas</label>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <input type="date" class="form-input" id="tl-start" value="${startVal || ''}">
                <input type="date" class="form-input" id="tl-end" value="${endVal || ''}">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Fases principales</label>
              <div style="font-size:12px; color:#94a3b8; margin-bottom:6px;">Puedes usar offsets o definir fechas exactas. Las fechas tienen prioridad.</div>
              <div id="tl-rows" style="display:grid; gap:8px;" data-next-idx="${normalizedRows.length}">
                ${normalizedRows.map((phase, idx) => timelineRowTemplate(phase, idx)).join('')}
              </div>
              <button type="button" class="btn btn-white" style="margin-top:8px;" onclick="addTimelineRow()">+ Agregar fase</button>
            </div>
            <div class="form-group">
              <label class="form-label">Notas</label>
              <input class="form-input" id="tl-notes" placeholder="Dependencias o comentarios" value="${timeline.notes || ''}">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-white" onclick="this.closest('.modal-overlay').remove()">Cerrar</button>
            <button type="button" class="btn btn-primary" onclick="saveTimelineModal(this, false)">Guardar</button>
            <button type="button" class="btn btn-primary" style="background:#02735E; border-color:#02735E;" onclick="saveTimelineModal(this, true)">Guardar y aplicar al Timeline</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      refreshTimelineComputed(modal);
      modal.addEventListener('input', (event) => {
        if (event.target.matches('#tl-start')) {
          refreshTimelineComputed(modal);
          return;
        }
        const row = event.target.closest('.timeline-row');
        if (row) {
          updateTimelineComputedRow(row, modal);
        }
      });
    }

    function addTimelineRow() {
      const rows = document.getElementById('tl-rows');
      if (!rows) return;
      const idx = Number(rows.dataset.nextIdx || rows.children.length);
      rows.dataset.nextIdx = idx + 1;
      rows.insertAdjacentHTML('beforeend', timelineRowTemplate({
        label: '',
        startOffset: 0,
        duration: 1,
        startDate: '',
        endDate: '',
        status: 'pending'
      }, idx));
      const modal = document.getElementById('timelineEditorModal');
      const newRow = rows.querySelector(`.timeline-row[data-idx="${idx}"]`);
      if (modal && newRow) {
        updateTimelineComputedRow(newRow, modal);
      }
    }

    function removeTimelineRow(idx) {
      const row = document.querySelector(`.timeline-row[data-idx="${idx}"]`);
      if (row) {
        const modal = row.closest('.modal-overlay');
        row.remove();
        if (modal) refreshTimelineComputed(modal);
      }
    }

    function saveTimelineModal(btn, applyTimeline = false) {
      const modal = btn.closest('.modal-overlay');
      if (!modal) return;
      const timelineKey = `project_timeline_${currentProject.idSync || currentProject.id}`;
      const existing = loadTimelineSnapshot(currentProject) || {};
      const startInput = modal.querySelector('#tl-start');
      const endInput = modal.querySelector('#tl-end');
      const baseStart = startInput?.value || currentProject.startDate || toInputDate(new Date());
      const rows = modal.querySelectorAll('.timeline-row');
      if (!rows.length) {
        uiToast('error', 'Agrega al menos una fase para guardar el timeline');
        return;
      }
      const phases = [];
      const tasks = [];
      for (const row of rows) {
        const label = row.querySelector('[data-field="label"]')?.value.trim();
        if (!label) {
          uiToast('error', 'Todas las fases necesitan un nombre');
          return;
        }
        const offset = Math.max(0, Number(row.querySelector('[data-field="startOffset"]')?.value || 0));
        const duration = Math.max(1, Number(row.querySelector('[data-field="duration"]')?.value || 1));
        const manualStart = row.querySelector('[data-field="startDate"]')?.value;
        const manualEnd = row.querySelector('[data-field="endDate"]')?.value;
        const startDate = manualStart || toInputDate(addDays(baseStart, offset)) || baseStart;
        const endDate = manualEnd || toInputDate(addDays(startDate, duration - 1)) || startDate;
        if (new Date(endDate) < new Date(startDate)) {
          uiToast('error', `La fase "${label}" tiene una fecha final anterior a la inicial`);
          return;
        }
        const status = row.querySelector('[data-field="status"]')?.value || 'pending';
        phases.push({
          id: phases.length + 1,
          name: label,
          start: startDate,
          end: endDate,
          status,
          progress: status === 'completed' ? 100 : status === 'in-progress' ? 60 : 0
        });
        tasks.push({
          label,
          startOffset: Math.max(0, diffInDays(baseStart, startDate)),
          duration: Math.max(1, diffInDays(startDate, endDate) + 1),
          status
        });
      }
      const timelineData = {
        startDate: startInput?.value || phases[0].start,
        endDate: endInput?.value || phases[phases.length - 1].end,
        phases,
        tasks,
        notes: modal.querySelector('#tl-notes')?.value || '',
        milestones: existing.milestones || []
      };
      localStorage.setItem(timelineKey, JSON.stringify(timelineData));
      modal.remove();
      if (applyTimeline) {
        syncTimelineToSchedule(phases);
      }
      renderProjectTimeline();
      uiToast('success', applyTimeline ? 'Fases aplicadas y sincronizadas' : 'Timeline guardado');
    }

  </script>

      </main>
    </div> <!-- app-content -->
  </div> <!-- app-shell -->

</body>
</html>
