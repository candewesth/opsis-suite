<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ThreadSync - Seguimiento de Oportunidad | Opsis Suite</title>
  <link rel="stylesheet" href="styles.css">
  <script src="js/seeds.js?v=verdi2"></script>
  <script src="js/modules.js"></script>
  <script src="js/sidebar.js?v=verdi2"></script>
  <script src="js/back-link.js?v=verdi2"></script>
  <style>
    :root {
      --verdi-dark: #022326;
      --verdi-mid: #034040;
      --verdi-accent: #035951;
      --verdi-light: #02735E;
      --primary-color: #02735E;
      --accent-color: #035951;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --bg-body: #fafafa;
      --bg-card: #ffffff;
      --border-color: #e2e8f0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: #f4f6f8;
      color: #1d2433;
      font-weight: 400;
      line-height: 1.6;
    }

    @keyframes aire {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .app-content {
      display: grid;
      grid-template-columns: 260px 1fr;
      flex: 1;
      transition: grid-template-columns 0.3s ease;
    }

    main {
      width: 100%;
    }

    @media (max-width: 1024px) {
      .app-content {
        grid-template-columns: 1fr;
      }
    }

    header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 20px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    /* Header Styles */
    .logo {
      display: flex;
      align-items: center;
      gap: 0;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }

    .logo-title {
      font-size: 26px;
      font-weight: 700;
      color: #ffffff;
      text-transform: none;
      letter-spacing: -0.3px;
    }

    .module-tab {
      padding: 10px 28px;
      border-radius: 10px 10px 0 0;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
      background: rgba(2, 115, 94, 0.15);
      color: #64748b;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .module-tab:hover {
      background: rgba(2, 115, 94, 0.25) !important;
      color: #475569 !important;
    }

    .module-tab.active {
      background: white !important;
      color: #02735E !important;
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .app-content {
      display: grid;
      grid-template-columns: 260px 1fr;
      flex: 1;
    }

    /* Header */
    .back-button:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 10px 18px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-white {
      background: rgba(255,255,255,0.15);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
    }

    .btn-white:hover {
      background: rgba(255,255,255,0.25);
      border: 1px solid rgba(255,255,255,0.4);
    }

    .btn-success {
      background: #10b981;
      color: white;
      border: 1px solid #10b981;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-color);
    }

    .project-status-wrapper {
      width: 100%;
      margin: 20px 0;
    }

    .project-status-card {
      width: 100%;
      border: 1px solid var(--border-color);
      border-radius: 18px;
      padding: 18px 22px;
      background: var(--bg-card);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      display: flex;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .project-status-card.connected {
      border-left: 4px solid #02735E;
    }

    .project-status-card.empty {
      border-left: 4px solid #f97316;
      background: linear-gradient(135deg, rgba(249,115,22,0.08), rgba(255,255,255,0));
    }

    .project-status-content h4 {
      margin: 0 0 4px 0;
      font-size: 15px;
      color: var(--text-primary);
    }

    .project-status-content p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 13px;
    }

    .project-status-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .confirm-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 4000;
      padding: 20px;
    }

    .confirm-card {
      background: var(--bg-card);
      padding: 22px;
      border-radius: 16px;
      border: 1px solid var(--border-color);
      box-shadow: 0 25px 50px rgba(15,23,42,0.3);
      max-width: 420px;
      width: 100%;
    }

    .confirm-card p {
      margin: 0 0 16px 0;
      color: var(--text-primary);
      font-size: 15px;
    }

    .confirm-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }



    .meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .status-prospecto {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
      border: 1px solid #fbbf24;
    }

    .status-cotizado {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      color: #1e3a8a;
      border: 1px solid #60a5fa;
    }

    .status-negociacion {
      background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
      color: #831843;
      border: 1px solid #f472b6;
    }

    /* Container */
    .container {
      width: 100%;
      margin: 0;
      padding: 32px 40px 60px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(0, 0, 0, 0.03);
      margin-bottom: 32px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 24px;
      color: #1d2433;
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 20px;
      border-bottom: 1px solid #f1f5f9;
    }

    .info-grid {
      display: grid;
      gap: 20px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      padding-bottom: 16px;
      border-bottom: 1px solid #f1f5f9;
    }

    .info-label {
      font-size: 14px;
      color: #64748b;
      font-weight: 500;
    }

    .info-value {
      font-size: 15px;
      font-weight: 600;
      color: #1e293b;
    }

    .timeline {
      display: flex;
      flex-direction: column;
      gap: 24px;
      margin-top: 12px;
    }

    .timeline-item {
      display: flex;
      gap: 20px;
      padding: 24px;
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #f1f5f9;
      box-shadow: 0 2px 8px rgba(0,0,0,0.02);
      position: relative;
      transition: all 0.2s ease;
    }

    .timeline-item:hover {
      border-color: #e2e8f0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    /* Hilo visual que conecta respuestas */
    .timeline-item.reply {
      margin-left: 64px;
      position: relative;
    }

    .timeline-item.reply::before {
      content: '';
      position: absolute;
      left: -32px;
      top: -12px;
      width: 2px;
      height: calc(100% + 24px);
      background: linear-gradient(180deg, #cbd5e1 0%, transparent 100%);
    }

    .timeline-item.reply::after {
      content: '';
      position: absolute;
      left: -32px;
      top: 28px;
      width: 24px;
      height: 2px;
      background: #cbd5e1;
      border-radius: 0 2px 2px 0;
    }

    .timeline-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      color: #1d2433;
    }

    .timeline-author {
      font-size: 12px;
      color: #02735E;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .comment-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 0;
    }

    .comment-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #02735E, #035951);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 17px;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(2, 115, 94, 0.15);
    }

    .comment-meta {
      flex: 1;
    }

    .comment-author-name {
      font-weight: 700;
      font-size: 16px;
      color: #1e293b;
      margin-bottom: 4px;
    }

    .comment-author-role {
      font-size: 13px;
      color: #64748b;
      margin-bottom: 0;
      font-weight: 500;
    }

    .comment-body {
      margin-left: 0;
      padding: 0;
      background: transparent;
      border: none;
    }

    .comment-text {
      font-size: 15px;
      line-height: 1.7;
      color: #334155;
      margin-top: 16px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #f1f5f9;
    }

    .comment-timestamp {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 8px;
    }

    .announcement-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
      padding: 6px 16px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
      border: 1px solid #fbbf24;
      box-shadow: 0 2px 4px rgba(251, 191, 36, 0.1);
    }

    .timeline-date {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .timeline-text {
      font-size: 14px;
      line-height: 1.5;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-input,
    .form-textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Rich Text Editor */
    .rich-editor {
      background: white;
      border: 1px solid #e2e8f0;
      padding: 12px;
      line-height: 1.6;
    }

    .rich-editor:empty:before {
      content: attr(placeholder);
      color: #9ca3af;
    }

    .rich-editor:focus {
      border-color: var(--primary-color);
    }

    .toolbar-btn:hover {
      background: #e2e8f0 !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .toolbar-btn:active {
      transform: scale(0.96);
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3) !important;
      transform: rotate(90deg);
    }

    .btn-secondary:hover {
      background: #f8fafc !important;
      border-color: #cbd5e1 !important;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(2,115,94,0.35) !important;
    }

    .mention {
      background: rgba(2, 115, 94, 0.1);
      color: var(--primary-color);
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
    }

    .mention:hover {
      background: rgba(2, 115, 94, 0.2);
    }

    .mention-item {
      padding: 10px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.2s;
    }

    .mention-item:hover {
      background: #f8fafc;
    }

    .mention-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 13px;
    }

    .mention-info {
      flex: 1;
    }

    .mention-name {
      font-weight: 600;
      font-size: 14px;
      color: #1e293b;
    }

    .mention-role {
      font-size: 12px;
      color: #64748b;
    }

    /* Address Autocomplete */
    .address-wrapper {
      position: relative;
    }

    .address-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--primary-color);
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .address-suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.15s;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .address-suggestion-item:last-child {
      border-bottom: none;
    }

    .address-suggestion-item:hover {
      background-color: #f0f9f7;
    }

    .address-suggestion-item.active {
      background-color: #e6f7f4;
    }

    .address-icon {
      color: var(--primary-color);
      flex-shrink: 0;
      margin-top: 2px;
    }

    .address-suggestion-content {
      flex: 1;
    }

    .address-suggestion-main {
      font-size: 14px;
      color: #1d2433;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .address-suggestion-secondary {
      font-size: 12px;
      color: #64748b;
    }

    .address-loading {
      padding: 12px 16px;
      text-align: center;
      color: #64748b;
      font-size: 13px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal {
      background: white;
      border-radius: 20px;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.15), 0 8px 16px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 750px;
      max-height: 90vh;
      overflow: hidden;
      animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideUp {
      from {
        transform: translateY(60px) scale(0.95);
        opacity: 0;
      }
      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    .modal-header {
      background: linear-gradient(135deg, #02735E 0%, #035951 100%);
      color: white;
      padding: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .modal-body {
      padding: 24px;
      max-height: calc(90vh - 200px);
      overflow-y: auto;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .form-select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .alert-box {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
    }

    .alert-icon {
      color: #f59e0b;
      flex-shrink: 0;
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .alert-text {
      font-size: 14px;
      color: var(--text-secondary);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    /* Nuevos estilos para funcionalidades */
    .btn-icon {
      background: transparent;
      border: none;
      padding: 6px;
      cursor: pointer;
      border-radius: 4px;
      color: #64748b;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #1d2433;
    }



    .reply-btn {
      background: transparent;
      border: none;
      color: #64748b;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 8px;
      transition: all 0.2s;
      margin-left: auto;
    }

    .reply-btn:hover {
      background: #f1f5f9;
      color: var(--primary-color);
    }

    /* Thread Header - Verdi + Aire Style */
    .thread-header {
      background: white;
      padding: 40px 40px;
      border-bottom: 1px solid #f1f5f9;
      margin-bottom: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .thread-title {
      font-size: 32px;
      font-weight: 800;
      color: #1e293b;
      letter-spacing: -0.5px;
      margin-bottom: 16px;
      display: inline-flex;
      align-items: center;
      gap: 12px;
    }

    .thread-title-icon {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: rgba(2, 115, 94, 0.08);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #02735E;
    }

    .thread-title-icon svg {
      width: 22px;
      height: 22px;
    }

    .thread-meta-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .meta-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 16px;
      border-radius: 100px;
      font-size: 13px;
      font-weight: 600;
      background: #f8fafc;
      color: #64748b;
      border: 1px solid #e2e8f0;
    }

    .status-badge {
      padding: 6px 16px;
      border-radius: 100px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    /* Fin de estilos nuevos */

  </style>
</head>
<body data-sidebar-active="threadsync">

  <div class="app-shell">
    <header style="background: linear-gradient(135deg, #02735E 0%, #035951 50%, #034040 100%); background-size: 200% 200%; animation: aire 8s ease infinite; padding: 0; display: flex; align-items: flex-end;">
      <div class="logo" aria-label="Opsis Suite" style="padding: 18px 32px;">
        <div class="logo-text">
          <div class="logo-title">Opsis Suite</div>
          <div id="company-name-header" style="font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.85); margin-top: 2px;">CVE San Diego</div>
        </div>
      </div>
      
      <!-- Module Tabs -->
      <div class="module-tabs" id="module-tabs-container" style="display: flex; gap: 0;"></div>
    </header>

    <div class="app-content">
    <aside id="sidebar"></aside>

    <main id="main" style="padding: 32px; background: #f8fafc;">
      <div class="thread-header">
        <button class="back-button" data-return-target="motorsync.html" style="background: white; color: #64748b; border: 1px solid #e2e8f0; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); align-self: flex-start;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Volver a ThreadSync
        </button>
        
        <div style="display:flex; flex-direction:column; align-items:center; gap:8px; width:100%;">
          <h1 class="thread-title" id="threadTitle" style="margin:0;">
            <span class="thread-title-icon" id="threadTitleIcon" aria-hidden="true"></span>
            <span id="threadTitleText"></span>
          </h1>
          <div class="thread-meta-container" id="threadMeta" style="margin-bottom: 8px;">
            <!-- Meta items injected via JS -->
          </div>
        </div>

        <p class="thread-address" id="threadAddress" style="display: none; color: #64748b; font-size: 14px; align-items: center; gap: 6px; justify-content: center;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--primary-color);"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
          <span id="addressText"></span>
        </p>

        <div class="header-actions" style="display: flex; gap: 12px; justify-content: center; margin-top: 24px; flex-wrap: wrap;">
          <button type="button" class="btn btn-white" onclick="editThread()" style="background: white; color: #1e293b; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Editar
          </button>
          <button type="button" class="btn btn-white" onclick="scheduleAppointmentFromThread()" style="background: white; color: #1e293b; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            Agendar Cita
          </button>
          <!-- Botón cuando NO está convertido -->
          <div id="notConvertedSection">
            <button type="button" class="btn btn-success" onclick="convertToProject()" style="background: #02735E; border-color: #02735E; box-shadow: 0 4px 12px rgba(2, 115, 94, 0.2);">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
              Convertir a Proyecto
            </button>
          </div>
          <!-- Botón cuando YA está convertido -->
          <div id="convertedSection" style="display: none;">
            <button type="button" class="btn btn-primary" onclick="goToProject()" style="background: #02735E; border-color: #02735E; box-shadow: 0 4px 12px rgba(2, 115, 94, 0.2);">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
              Ir al ProjectSync
            </button>
          </div>
        </div>
      </div>

      <div class="container">
        <div>
      <div class="card">
          <div class="timeline">
            <!-- Comentario 1 -->
            <div class="timeline-item">
              <div class="comment-header">
                <div class="comment-avatar">RR</div>
                <div class="comment-meta">
                  <div class="comment-author-name">Rodolfo Real</div>
                  <div class="comment-author-role">
                    <span>Estimator/PM</span> · <span>Nov 17, 2024 10:30 AM</span> · <span style="color: #94a3b8;">Notificó a 8 personas</span>
                  </div>
                </div>
              </div>
              <div class="comment-body">
                <div class="comment-text thread-description">
                  El cliente mencionó que tiene presupuesto aprobado pero quiere ver opciones de financiamiento a 12 meses. Revisar con finanzas.
                </div>
                <div style="display: flex; gap: 12px; margin-top: 12px; align-items: center; justify-content: flex-end;">
                  <button type="button" class="reply-btn" onclick="replyToComment(1)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="9 14 4 9 9 4"/>
                      <path d="M20 20v-7a4 4 0 0 0-4-4H4"/>
                    </svg>
                    Responder
                  </button>
                </div>
              </div>
            </div>

            <!-- Comentario 2 -->
            <div class="timeline-item">
              <div class="comment-header">
                <div class="comment-avatar" style="background: linear-gradient(135deg, #f59e0b, #d97706);">MC</div>
                <div class="comment-meta">
                  <div class="comment-author-name">Matias Carrillo</div>
                  <div class="comment-author-role">
                    <span>Operations Coordinator</span> · <span>Nov 16, 2024 2:15 PM</span> · <span style="color: #94a3b8;">Notificó a 5 personas</span>
                  </div>
                </div>
              </div>
              <div class="comment-body">
                <div class="comment-text">
                  Contacto muy profesional. Ing. Mendoza tiene experiencia previa con proyectos HVAC. Esto facilita la comunicación técnica.
                </div>
                <div style="display: flex; gap: 12px; margin-top: 12px; align-items: center; justify-content: flex-end;">
                  <button type="button" class="reply-btn" onclick="replyToComment(2)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="9 14 4 9 9 4"/>
                      <path d="M20 20v-7a4 4 0 0 0-4-4H4"/>
                    </svg>
                    Responder
                  </button>
                </div>
              </div>
            </div>
              
            <!-- Respuesta anidada - estilo Facebook con hilo visual -->
            <div class="timeline-item reply">
              <div class="comment-header">
                <div class="comment-avatar" style="width: 40px; height: 40px; font-size: 14px;">RR</div>
                <div class="comment-meta">
                  <div class="comment-author-name" style="font-size: 15px;">Rodolfo Real</div>
                  <div class="comment-author-role" style="font-size: 12px;">
                    <span>Estimator/PM</span> · <span>Nov 16, 2024 3:20 PM</span> · <span style="color: #94a3b8;">Notificó a 2 personas</span>
                  </div>
                </div>
              </div>
              <div class="comment-body">
                <div class="comment-text" style="padding: 16px; font-size: 14px;">
                  Exacto, <span style="color: #02735E; font-weight: 600;">@Matias</span> ya coordinó una llamada técnica para mañana con el Ing. Mendoza.
                </div>
                <div style="display: flex; gap: 12px; margin-top: 12px; align-items: center; justify-content: flex-end;">
                  <button type="button" class="reply-btn" onclick="replyToComment(3)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="9 14 4 9 9 4"/>
                      <path d="M20 20v-7a4 4 0 0 0-4-4H4"/>
                    </svg>
                    Responder
                  </button>
                </div>
              </div>
            </div>

            <!-- Comentario 3 -->
            <div class="timeline-item" style="background: #f9fafb; border-left: none; border: 1px solid #e1e4e8; padding: 20px; margin-bottom: 16px; border-radius: 8px;">
              <div class="comment-header">
                <div class="comment-avatar">RR</div>
                <div class="comment-meta">
                  <div class="comment-author-name">Rodolfo Real</div>
                  <div class="comment-author-role" style="display: flex; flex-direction: column; gap: 2px;">
                    <span>Estimator/PM</span>
                    <span>Nov 15, 2024 9:45 AM</span>
                    <span>Notificó a 3 personas</span>
                  </div>
                </div>
              </div>
              <div class="comment-body">
                <div class="comment-text" style="background: white; border: 1px solid #e1e4e8; border-radius: 6px; padding: 16px; margin-top: 12px;">
                  Edificio en buenas condiciones. Acceso fácil para equipos. Cliente muy organizado, tienen planos actualizados.
                </div>
                
                <!-- Archivo adjunto -->
                <div style="margin-top: 12px; padding: 12px; background: white; border: 1px solid #e1e4e8; border-radius: 6px; display: inline-flex; align-items: center; gap: 10px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#02735E" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                  </svg>
                  <div>
                    <div style="font-size: 13px; font-weight: 600; color: #1d2433;">Planos_Edificio.pdf</div>
                    <div style="font-size: 12px; color: #64748b;">2.4 MB</div>
                  </div>
                  <button class="btn-icon" style="margin-left: 8px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/>
                      <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                  </button>
                </div>
                
                <!-- Responder en línea -->
                <div style="display: flex; gap: 12px; margin-top: 12px; align-items: center; justify-content: flex-end;">
                  <button type="button" class="reply-btn" onclick="replyToComment(3)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="9 14 4 9 9 4"/>
                      <path d="M20 20v-7a4 4 0 0 0-4-4H4"/>
                    </svg>
                    Responder
                  </button>
                </div>
              </div>
            </div>
          </div>

          <button type="button" class="btn btn-primary" style="margin-top: 24px; width: 100%;" onclick="addComment()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Agregar Comentario
          </button>
        </div>
        </div>
      </div>
    </main>
  </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Mostrar rápidamente un título por defecto mientras cargan datos
        const urlId = new URLSearchParams(window.location.search).get('id');
        const defaultTitle = urlId || 'Thread';
        const titleEl = document.getElementById('threadTitle');
        if (titleEl && !titleEl.textContent) {
          titleEl.textContent = defaultTitle;
        }
      });
    function detectCurrentUser() {
      // Intentar obtener del objeto global de sesión
      if (window.opsisCurrentUser?.displayName) {
        return window.opsisCurrentUser.displayName;
      }

      if (window.opsisCurrentUser?.name) {
        return window.opsisCurrentUser.name;
      }

      // Intentar obtener de localStorage
      try {
        const stored = localStorage.getItem('opsisCurrentUser');
        if (stored) {
          const parsed = JSON.parse(stored);
          if (parsed?.displayName) return parsed.displayName;
          if (parsed?.fullName) return parsed.fullName;
          if (parsed?.name) return parsed.name;
        }
      } catch (error) {
        console.warn('No se pudo leer el usuario de localStorage', error);
      }

      // Intentar obtener de sessionStorage
      try {
        const sessionUser = sessionStorage.getItem('currentUser');
        if (sessionUser) {
          const parsed = JSON.parse(sessionUser);
          if (parsed?.displayName) return parsed.displayName;
          if (parsed?.fullName) return parsed.fullName;
          if (parsed?.name) return parsed.name;
        }
      } catch (error) {
        console.warn('No se pudo leer el usuario de sessionStorage', error);
      }

      // Intentar obtener del token JWT si existe
      try {
        const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        if (token) {
          const payload = JSON.parse(atob(token.split('.')[1]));
          if (payload?.name) return payload.name;
          if (payload?.displayName) return payload.displayName;
          if (payload?.email) return payload.email.split('@')[0];
        }
      } catch (error) {
        // Token inválido o no existe
      }

      // Por defecto usar el nombre genérico
      return 'Usuario Actual';
    }

    function getCurrentDateISO() {
      return new Date().toISOString().split('T')[0];
    }

    function getCurrentTimeHHMM() {
      const now = new Date();
      return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    }

    // Base de datos simulada de threads
    const threadsDatabase = (window.DemoSeeds && DemoSeeds.getThreadDetailMap()) || {};

    const THREAD_ICON_MAP = {
      document: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>',
      maintenance: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0-1.41 0L5 14.59V19h4.41l8.29-8.29a1 1 0 0 0 0-1.41z"></path><path d="M15 5l4 4"></path></svg>',
      camera: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19V7a2 2 0 0 0-2-2h-3l-2-3H8L6 5H3a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2z"></path><circle cx="12" cy="13" r="4"></circle></svg>',
      alert: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
      thread: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>'
    };

    const THREAD_INLINE_ICONS = {
      clipboard: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 4h-3.18a3 3 0 0 0-5.64 0H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="9" y1="12" x2="15" y2="12"></line><line x1="9" y1="16" x2="13" y2="16"></line></svg>',
      pencil: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"></path></svg>',
      lightbulb: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18h6"></path><path d="M10 22h4"></path><path d="M2 9a10 10 0 0 1 20 0c0 3.5-2 6.5-5 8a3 3 0 0 0-1 2v1H8v-1a3 3 0 0 0-1-2c-3-1.5-5-4.5-5-8z"></path></svg>',
      photo: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><path d="M21 15l-5-5L5 21"></path></svg>',
      document: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>'
    };

    const threadState = {
      title: 'Instalación HVAC - Edificio Corporativo Guadalajara',
      address: 'Av. Empresarial 345, Guadalajara, Jal.',
      createdBy: '',
      createdDate: '',
      createdTime: '',
      isConverted: false,
      projectId: null,
      projectName: null,
      iconKey: 'thread'
    };

    function getCurrentThreadId() {
      return new URLSearchParams(window.location.search).get('id');
    }

    function hydrateThreadDefaults() {
      // Detectar si hay un ID de thread en la URL
      const threadId = getCurrentThreadId();
      
      // Si hay un ID, cargar datos del thread
      if (threadId) {
        let threadData = null;
        
        // 1. Intentar cargar desde localStorage primero
        try {
          const storedThreads = localStorage.getItem('threadsync_threads');
          if (storedThreads) {
            const threadsData = JSON.parse(storedThreads);
            if (threadsData[threadId]) {
              threadData = threadsData[threadId];
              console.log('Thread cargado desde localStorage:', threadId);
            }
          }
        } catch (e) {
          console.error('Error al cargar desde localStorage:', e);
        }
        
        // 2. Si no está en localStorage, buscar en threadsDatabase (datos de ejemplo)
        if (!threadData && threadsDatabase[threadId]) {
          threadData = threadsDatabase[threadId];
          console.log('Thread cargado desde threadsDatabase:', threadId);
        }
        
        // 3. Aplicar datos si se encontró el thread
        if (threadData) {
          // Si viene de localStorage (formato nuevo)
          if (threadData.clientName) {
            threadState.title = threadData.clientName;
            threadState.clientName = threadData.clientName;
            threadState.subject = threadData.subject || '-';
            threadState.contactInfo = threadData.contactInfo || '-';
            threadState.projectId = threadData.projectId || null;
            threadState.projectName = threadData.projectName || null;
            threadState.createdBy = threadData.createdBy || threadData.owner;
            threadState.createdDate = threadData.createdDate || getCurrentDateISO();
            threadState.createdTime = threadData.createdTime || getCurrentTimeHHMM();
            threadState.iconKey = threadData.icon || threadState.iconKey;
            
            console.log('Thread cargado:', {
              title: threadState.title,
              subject: threadState.subject,
              contactInfo: threadState.contactInfo,
              projectName: threadState.projectName
            });
          } 
          // Si viene de threadsDatabase (formato viejo)
          else {
            threadState.title = threadData.title;
            threadState.address = threadData.address;
            threadState.createdBy = threadData.createdBy;
            threadState.createdDate = threadData.createdDate;
            threadState.createdTime = threadData.createdTime;
            threadState.projectId = threadData.projectId;
            threadState.iconKey = threadData.icon || threadState.iconKey;
            
            // Agregar descripción al primer comentario si existe
            const descriptionElement = document.querySelector('.thread-description');
            if (descriptionElement && threadData.description) {
              descriptionElement.textContent = threadData.description;
            }
          }
        } else {
          console.warn('Thread no encontrado:', threadId);
        }
      } else {
        // Valores por defecto si no hay ID
        if (!threadState.createdBy) {
          threadState.createdBy = detectCurrentUser();
        }

        if (!threadState.createdDate) {
          threadState.createdDate = getCurrentDateISO();
        }

        if (!threadState.createdTime) {
          threadState.createdTime = getCurrentTimeHHMM();
        }
      }
    }

    function formatDateForDisplay(isoDate) {
      if (!isoDate) return '';
      const date = new Date(`${isoDate}T00:00:00`);
      if (Number.isNaN(date.getTime())) {
        return isoDate;
      }
      const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
      return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
    }

    function formatTimeForDisplay(time24h) {
      if (!time24h) return '';
      const [rawHours, rawMinutes] = time24h.split(':');
      if (rawHours === undefined || rawMinutes === undefined) {
        return time24h;
      }
      const hours = parseInt(rawHours, 10);
      if (Number.isNaN(hours)) {
        return time24h;
      }
      const minutes = rawMinutes.padStart(2, '0');
      const suffix = hours >= 12 ? 'PM' : 'AM';
      const normalizedHour = ((hours + 11) % 12) + 1;
      return `${String(normalizedHour).padStart(2, '0')}:${minutes} ${suffix}`;
    }

    function escapeAttribute(value = '') {
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function inlineIconHTML(name) {
      const markup = THREAD_INLINE_ICONS[name];
      if (!markup) return '';
      return `<span style="display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;margin-right:6px;color:#02735E;">${markup}</span>`;
    }

    function renderThreadHeader() {
      hydrateThreadDefaults();

      const titleTextElement = document.getElementById('threadTitleText') || document.getElementById('threadTitle');
      const titleIconElement = document.getElementById('threadTitleIcon');
      const fallbackTitle = threadState.title || threadState.clientName || threadState.subject || getCurrentThreadId() || 'Thread';
      if (titleTextElement) {
        titleTextElement.textContent = fallbackTitle;
      }
      if (titleIconElement) {
        const iconMarkup = THREAD_ICON_MAP[threadState.iconKey] || THREAD_ICON_MAP.thread;
        if (iconMarkup) {
          titleIconElement.innerHTML = iconMarkup;
          titleIconElement.style.display = 'inline-flex';
        } else {
          titleIconElement.innerHTML = '';
          titleIconElement.style.display = 'none';
        }
      }

      const addressContainer = document.getElementById('threadAddress');
      const addressText = document.getElementById('addressText');
      if (addressContainer && addressText) {
        if (threadState.contactInfo && threadState.contactInfo !== '-') {
          addressText.textContent = threadState.contactInfo;
          addressContainer.style.display = 'flex';
        } else {
          addressText.textContent = '';
          addressContainer.style.display = 'none';
        }
      }

      const metaElement = document.getElementById('threadMeta');
      if (metaElement) {
        const createdDate = formatDateForDisplay(threadState.createdDate);
        const createdTime = formatTimeForDisplay(threadState.createdTime);
        
        let metaHTML = `
          <div class="meta-pill">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <span>${createdDate}${createdTime ? ` · ${createdTime}` : ''}</span>
          </div>
          <div class="meta-pill">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            <span>${threadState.createdBy}</span>
          </div>
        `;
        
        // Agregar descripción si existe
        if (threadState.subject && threadState.subject !== '-') {
          metaHTML += `
          <div class="meta-pill" style="max-width: 600px;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <span>${threadState.subject}</span>
          </div>
          `;
        }
        
        // Agregar proyecto si está asignado
        if (threadState.projectName) {
          metaHTML += `
          <div class="meta-pill">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            <span>Proyecto: ${threadState.projectName}</span>
          </div>
          `;
        }
        
        metaElement.innerHTML = metaHTML;
      }

      const convertSection = document.getElementById('notConvertedSection');
      const convertedSection = document.getElementById('convertedSection');
      if (threadState.projectId) {
        if (convertSection) convertSection.style.display = 'none';
        if (convertedSection) convertedSection.style.display = 'block';
      } else {
        if (convertSection) convertSection.style.display = 'block';
        if (convertedSection) convertedSection.style.display = 'none';
      }
    }


    // Función para obtener proyectos disponibles (sin threads conectados)
    function getAvailableProjectsOptions() {
      // Cargar proyectos reales desde localStorage
      const allProjects = JSON.parse(localStorage.getItem('projectsync_projects') || '[]').map(p => ({
        id: p.id,
        name: p.name,
        status: p.status || 'active'
      }));

      // Obtener todos los threads para saber cuáles tienen proyecto asignado
      let threadsWithProjects = new Set();
      
      try {
        const storedThreads = localStorage.getItem('threadsync_threads');
        if (storedThreads) {
          const threadsData = JSON.parse(storedThreads);
          Object.values(threadsData).forEach(thread => {
            if (thread.projectId && thread.projectId !== threadState.projectId) {
              // Solo excluir si el proyecto está asignado a OTRO thread (no al actual)
              threadsWithProjects.add(thread.projectId);
            }
          });
        }
      } catch (e) {
        console.error('Error al cargar threads:', e);
      }

      console.log('Proyectos ya conectados a otros threads:', Array.from(threadsWithProjects));

      // Filtrar proyectos disponibles
      const availableProjects = allProjects.filter(project => {
        return !threadsWithProjects.has(project.id);
      });

      console.log('Proyectos disponibles:', availableProjects.length);

      // Si el thread actual ya tiene un proyecto, incluirlo como seleccionado
      let optionsHTML = '';
      
      if (threadState.projectId) {
        const currentProject = allProjects.find(p => p.id === threadState.projectId);
        if (currentProject) {
          optionsHTML += `<option value="${currentProject.id}" selected>${currentProject.name} (actual)</option>`;
        }
      }

      // Agregar proyectos disponibles
      availableProjects.forEach(project => {
        if (project.id !== threadState.projectId) {
          optionsHTML += `<option value="${project.id}">${project.name}</option>`;
        }
      });

      // Si no hay proyectos disponibles, mostrar mensaje
      if (availableProjects.length === 0 && !threadState.projectId) {
        optionsHTML += `<option value="" disabled>No hay proyectos disponibles sin thread</option>`;
      }

      return optionsHTML;
    }

    function openLinkProjectModal() {
      const optionsHTML = getAvailableProjectsOptions();
      const modalHTML = `
        <div class="modal-overlay" id="linkProjectModal" onclick="handleOverlayClick(event, 'linkProjectModal')">
          <div class="modal modern-modal" style="max-width: 520px;">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Vincular a proyecto
              </div>
              <button type="button" class="modal-close" onclick="closeModal('linkProjectModal')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Selecciona un proyecto disponible</label>
                <select id="linkProjectSelect" class="form-input">
                  <option value="">Sin proyecto</option>
                  ${optionsHTML || '<option disabled>No hay proyectos disponibles</option>'}
                </select>
                <p style="font-size: 12px; color: #64748b; margin-top: 8px;">Solo se listan proyectos que aún no están conectados a otro thread.</p>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeModal('linkProjectModal')">Cancelar</button>
              <button type="button" class="btn btn-primary" onclick="linkThreadToProject()">Vincular</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function linkThreadToProject() {
      const select = document.getElementById('linkProjectSelect');
      if (!select) return;
      const projectId = select.value;
      if (!projectId) {
        showThreadToast('warning', 'Selecciona un proyecto disponible.');
        return;
      }
      const projectName = select.options[select.selectedIndex].text;
      
      const threadId = getCurrentThreadId();
      let storedThreads = {};
      try {
        storedThreads = JSON.parse(localStorage.getItem('threadsync_threads') || '{}');
      } catch (e) {
        console.error('Error al cargar threads para vincular:', e);
      }
      if (!storedThreads[threadId]) {
        storedThreads[threadId] = {};
      }
      storedThreads[threadId].projectId = projectId;
      storedThreads[threadId].projectName = projectName;
      localStorage.setItem('threadsync_threads', JSON.stringify(storedThreads));
      
      threadState.projectId = projectId;
      threadState.projectName = projectName;
      threadState.isConverted = true;
      renderThreadHeader();
      closeModal('linkProjectModal');
      showThreadToast('success', `Thread vinculado a ${projectName}.`);
    }

    // Función para editar thread
    function editThread() {
      hydrateThreadDefaults();

      const existingModal = document.getElementById('editThreadModal');
      if (existingModal) {
        existingModal.remove();
      }

      const modalHTML = `
        <div class="modal-overlay" id="editThreadModal" onclick="handleOverlayClick(event, 'editThreadModal')">
          <div class="modal">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Editar ThreadSync
              </div>
              <button type="button" class="modal-close" onclick="closeModal('editThreadModal')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <!-- Asunto/Cliente -->
              <div class="form-group">
                <label class="form-label" for="editThreadClientName">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                  Asunto o Cliente *
                </label>
                <input type="text" id="editThreadClientName" class="form-input" value="${escapeAttribute(threadState.title)}" placeholder="Ej: Cotización HVAC - Edificio Central" required />
              </div>

              <!-- Descripción -->
              <div class="form-group">
                <label class="form-label" for="editThreadSubject">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                  </svg>
                  Descripción *
                </label>
                <input type="text" id="editThreadSubject" class="form-input" value="${escapeAttribute(threadState.subject || '')}" placeholder="Ej: Cliente pregunta por mantenimiento preventivo" required />
              </div>

              <!-- Contacto -->
              <div class="form-group">
                <label class="form-label" for="editThreadContactInfo">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                  </svg>
                  Contacto del Cliente (opcional)
                </label>
                <input type="text" id="editThreadContactInfo" class="form-input" value="${escapeAttribute(threadState.contactInfo && threadState.contactInfo !== '-' ? threadState.contactInfo : '')}" placeholder="Teléfono, email o nombre" />
              </div>

              <!-- Proyecto -->
              <div class="form-group">
                <label class="form-label" for="editThreadProject">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                  </svg>
                  ¿Asociar a un proyecto?
                </label>
                <select id="editThreadProject" class="form-input" style="cursor: pointer;">
                  <option value="">Sin proyecto (thread independiente)</option>
                  ${getAvailableProjectsOptions()}
                </select>
                <p style="font-size: 12px; color: #64748b; margin-top: 8px; display: flex; align-items: center; gap: 6px;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="16" x2="12" y2="12"/>
                    <line x1="12" y1="8" x2="12.01" y2="8"/>
                  </svg>
                  Solo se muestran proyectos sin thread conectado
                </p>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeModal('editThreadModal')">Cancelar</button>
              <button type="button" class="btn btn-primary" onclick="saveThreadDetails()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                Guardar Cambios
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      requestAnimationFrame(() => {
        const clientNameField = document.getElementById('editThreadClientName');
        if (clientNameField) {
          clientNameField.focus();
        }
      });
    }

    // Inicializar autocomplete de direcciones con Nominatim (OpenStreetMap - Gratuito)
    function saveThreadDetails() {
      const clientNameField = document.getElementById('editThreadClientName');
      const subjectField = document.getElementById('editThreadSubject');
      const contactInfoField = document.getElementById('editThreadContactInfo');
      const projectField = document.getElementById('editThreadProject');

      const newClientName = clientNameField?.value.trim() || '';
      const newSubject = subjectField?.value.trim() || '';
      const newContactInfo = contactInfoField?.value.trim() || '';
      const newProjectId = projectField?.value || null;

      if (!newClientName) {
        showThreadToast('warning', 'El asunto o cliente es obligatorio.');
        clientNameField?.focus();
        return;
      }

      if (!newSubject) {
        showThreadToast('warning', 'La descripción es obligatoria.');
        subjectField?.focus();
        return;
      }

      console.log('Guardando cambios del thread:', {
        clientName: newClientName,
        subject: newSubject,
        contactInfo: newContactInfo,
        projectId: newProjectId
      });

      // Actualizar threadState
      threadState.title = newClientName;
      threadState.clientName = newClientName;
      threadState.subject = newSubject;
      threadState.contactInfo = newContactInfo || '-';
      threadState.projectId = newProjectId;
      
      // Buscar nombre del proyecto si está seleccionado
      if (newProjectId) {
        const projectSelect = projectField;
        const selectedOption = projectSelect.options[projectSelect.selectedIndex];
        threadState.projectName = selectedOption.text;
      } else {
        threadState.projectName = null;
      }

      // Actualizar en localStorage
      const threadId = getCurrentThreadId();
      
      if (threadId) {
        try {
          const storedThreads = localStorage.getItem('threadsync_threads');
          if (storedThreads) {
            const threadsData = JSON.parse(storedThreads);
            if (threadsData[threadId]) {
              threadsData[threadId].clientName = newClientName;
              threadsData[threadId].subject = newSubject;
              threadsData[threadId].contactInfo = newContactInfo || '-';
              threadsData[threadId].projectId = newProjectId;
              threadsData[threadId].projectName = threadState.projectName;
              
              localStorage.setItem('threadsync_threads', JSON.stringify(threadsData));
              console.log('Thread actualizado en localStorage:', threadsData[threadId]);
            }
          }
        } catch (e) {
          console.error('Error al guardar en localStorage:', e);
        }
      }

      hydrateThreadDefaults();
      renderThreadHeader();
      closeModal('editThreadModal');
      
      showThreadToast('success', 'Thread actualizado correctamente.');
    }

    // Función para agregar actualización
    function addComment() {
      const modalHTML = `
        <div class="modal-overlay" id="addCommentModal" onclick="handleOverlayClick(event, 'addCommentModal')">
          <div class="modal modern-modal">
            <!-- Header Moderno -->
            <div class="modal-header" style="background: linear-gradient(135deg, #02735E 0%, #035951 100%); color: white; padding: 28px 32px; border-radius: 20px 20px 0 0; position: relative; overflow: hidden;">
              
              <div style="position: relative; z-index: 1;">
                <div class="modal-title" style="display: flex; align-items: center; gap: 12px; font-size: 24px; font-weight: 700; margin: 0;">
                  <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                      <path d="M9 10h6M9 14h4"/>
                    </svg>
                  </div>
                  <div>
                    <div style="font-size: 20px; font-weight: 700; letter-spacing: -0.3px;">Nuevo Comentario</div>
                    <div style="font-size: 13px; font-weight: 400; opacity: 0.85; margin-top: 2px;">Comparte tu opinión o actualización</div>
                  </div>
                </div>
              </div>
              
              <button type="button" class="modal-close" onclick="closeModal('addCommentModal')" style="position: absolute; top: 24px; right: 24px; z-index: 2; width: 36px; height: 36px; border-radius: 8px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; backdrop-filter: blur(10px);">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            
            <!-- Body Moderno -->
            <div class="modal-body" style="padding: 32px; background: #fafafa;">
              <div class="form-group" style="margin-bottom: 24px;">
                <label class="form-label" style="font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 20h9"/>
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                  </svg>
                  Tu mensaje
                </label>
                
                <!-- Barra de herramientas modernizada -->
                <div class="editor-toolbar" style="background: white; border: 1px solid #e2e8f0; border-bottom: none; border-radius: 12px 12px 0 0; padding: 12px 16px; display: flex; gap: 6px; flex-wrap: wrap; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                  <button type="button" class="toolbar-btn" onclick="formatText('bold')" title="Negrita (Ctrl+B)" style="padding: 8px 12px; border: none; background: #f8fafc; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; transition: all 0.2s; min-width: 36px; height: 36px;">
                    <strong>B</strong>
                  </button>
                  <button type="button" class="toolbar-btn" onclick="formatText('italic')" title="Cursiva (Ctrl+I)" style="padding: 8px 12px; border: none; background: #f8fafc; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; font-style: italic; transition: all 0.2s; min-width: 36px; height: 36px;">
                    <em>I</em>
                  </button>
                  <button type="button" class="toolbar-btn" onclick="formatText('underline')" title="Subrayado" style="padding: 8px 12px; border: none; background: #f8fafc; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; text-decoration: underline; transition: all 0.2s; min-width: 36px; height: 36px;">
                    U
                  </button>
                  <div style="width: 1px; background: #e2e8f0; margin: 0 6px;"></div>
                  <button type="button" class="toolbar-btn" onclick="formatText('h1')" title="Título Grande" style="padding: 8px 12px; border: none; background: #f8fafc; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 700; transition: all 0.2s; min-width: 40px; height: 36px;">
                    H1
                  </button>
                  <button type="button" class="toolbar-btn" onclick="formatText('h2')" title="Título Mediano" style="padding: 8px 12px; border: none; background: #f8fafc; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; min-width: 40px; height: 36px;">
                    H2
                  </button>
                  <div style="width: 1px; background: #e2e8f0; margin: 0 6px;"></div>
                  <div style="position: relative; display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: #f8fafc; border-radius: 8px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                    </svg>
                    <input type="color" id="textColorPicker" value="#1e293b" title="Color de texto" style="width: 28px; height: 28px; border: none; border-radius: 4px; cursor: pointer; padding: 0; background: transparent;" onchange="applyTextColor(this.value)">
                  </div>
                  <div style="width: 1px; background: #e2e8f0; margin: 0 6px;"></div>
                  <button type="button" class="toolbar-btn" onclick="openMentionPicker()" title="Etiquetar a alguien" style="padding: 8px 14px; border: none; background: rgba(2,115,94,0.08); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; color: #02735E; font-weight: 600; font-size: 13px; transition: all 0.2s; height: 36px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                      <circle cx="9" cy="7" r="4"></circle>
                      <line x1="19" y1="8" x2="19" y2="14"></line>
                      <line x1="22" y1="11" x2="16" y2="11"></line>
                    </svg>
                    Mencionar
                  </button>
                </div>
                
                <div contenteditable="true" id="commentText" class="form-textarea rich-editor" placeholder="Escribe tu comentario, comparte ideas, o agrega una nota importante..." style="min-height: 180px; border-radius: 0 0 12px 12px; outline: none; overflow-y: auto; background: white; border: 1px solid #e2e8f0; border-top: none; font-size: 15px; line-height: 1.7; box-shadow: 0 1px 3px rgba(0,0,0,0.05);" oninput="updateCommentPreview()"></div>
                
                <!-- Dropdown de menciones modernizado -->
                <div id="mentionDropdown" style="display: none; position: absolute; background: white; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); max-height: 280px; overflow-y: auto; z-index: 1000; margin-top: 8px;">
                  <!-- Populated by JS -->
                </div>
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" style="font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                  </svg>
                  Archivos adjuntos
                  <span style="font-size: 12px; font-weight: 400; color: #64748b; margin-left: 4px;">(Opcional)</span>
                </label>
                
                <div style="position: relative;">
                  <input type="file" id="commentFiles" class="form-input" multiple style="display: none;" onchange="updateFileList(this)" />
                  <label for="commentFiles" style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 20px; border: 2px dashed #cbd5e1; border-radius: 12px; background: white; cursor: pointer; transition: all 0.2s; text-align: center;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #64748b;">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="17 8 12 3 7 8"/>
                      <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    <div>
                      <div style="font-weight: 600; color: #1e293b; font-size: 14px;">Haz clic para adjuntar archivos</div>
                      <div style="font-size: 12px; color: #64748b; margin-top: 4px;">O arrastra y suelta aquí · Fotos, PDFs, documentos</div>
                    </div>
                  </label>
                  <div id="fileListDisplay" style="margin-top: 12px; display: none;"></div>
                </div>
              </div>
            </div>
            
            <!-- Footer Moderno -->
            <div class="modal-footer" style="padding: 24px 32px; background: white; border-top: 1px solid #f1f5f9; border-radius: 0 0 20px 20px; display: flex; gap: 12px; justify-content: flex-end;">
              <button type="button" class="btn btn-secondary" onclick="closeModal('addCommentModal')" style="padding: 12px 24px; border-radius: 10px; font-weight: 600; font-size: 14px; border: 1px solid #e2e8f0; background: white; color: #64748b; transition: all 0.2s;">
                Cancelar
              </button>
              <button type="button" class="btn btn-primary" onclick="saveComment()" style="padding: 12px 28px; border-radius: 10px; font-weight: 600; font-size: 14px; background: linear-gradient(135deg, #02735E, #035951); border: none; color: white; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(2,115,94,0.25); transition: all 0.2s;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Publicar Comentario
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    // ========== Rich Text Editor Functions ==========
    
    // Lista de usuarios de la compañía para mencionar
    const companyUsers = [
      { id: 1, name: 'Carlos Mendoza', role: 'Gerente de Operaciones', initials: 'CM' },
      { id: 2, name: 'Ana García', role: 'Coordinadora de Proyectos', initials: 'AG' },
      { id: 3, name: 'Roberto Silva', role: 'Supervisor de Campo', initials: 'RS' },
      { id: 4, name: 'María López', role: 'Estimadora', initials: 'ML' },
      { id: 5, name: 'Juan Pérez', role: 'Técnico Senior', initials: 'JP' },
    ];

    function formatText(command) {
      const editor = document.getElementById('commentText');
      const selection = window.getSelection();
      const range = selection.getRangeAt(0);
      
      if (command === 'bold') {
        document.execCommand('bold', false, null);
      } else if (command === 'italic') {
        document.execCommand('italic', false, null);
      } else if (command === 'underline') {
        document.execCommand('underline', false, null);
      } else if (command === 'h1') {
        const h1 = document.createElement('h1');
        h1.style.fontSize = '24px';
        h1.style.fontWeight = '700';
        h1.style.marginBottom = '8px';
        h1.innerHTML = range.toString() || 'Título';
        range.deleteContents();
        range.insertNode(h1);
      } else if (command === 'h2') {
        const h2 = document.createElement('h2');
        h2.style.fontSize = '18px';
        h2.style.fontWeight = '600';
        h2.style.marginBottom = '6px';
        h2.innerHTML = range.toString() || 'Subtítulo';
        range.deleteContents();
        range.insertNode(h2);
      }
      
      editor.focus();
    }

    function applyTextColor(color) {
      const editor = document.getElementById('commentText');
      
      // Asegurar que el editor tiene foco
      editor.focus();
      
      const selection = window.getSelection();
      
      // Verificar si hay texto seleccionado
      if (selection.rangeCount > 0 && !selection.isCollapsed) {
        // Crear un span con el color seleccionado
        const range = selection.getRangeAt(0);
        const selectedText = range.toString();
        
        if (selectedText.length > 0) {
          const span = document.createElement('span');
          span.style.color = color;
          span.textContent = selectedText;
          
          range.deleteContents();
          range.insertNode(span);
          
          // Mover cursor después del span
          range.setStartAfter(span);
          range.collapse(true);
          selection.removeAllRanges();
          selection.addRange(range);
          
          console.log('Color aplicado:', color, 'a texto:', selectedText);
        }
      } else {
        showThreadToast('warning', 'Selecciona el texto al que deseas aplicar color.');
      }
      
      editor.focus();
    }

    function openMentionPicker() {
      const dropdown = document.getElementById('mentionDropdown');
      const editor = document.getElementById('commentText');
      
      // Toggle dropdown
      if (dropdown.style.display === 'block') {
        dropdown.style.display = 'none';
        return;
      }
      
      // Populate dropdown with users
      dropdown.innerHTML = companyUsers.map(user => `
        <div class="mention-item" onclick="insertMention(${user.id}, '${user.name}', '${user.initials}')" 
             onmouseover="this.style.background='#f8fafc'" 
             onmouseout="this.style.background='white'"
             style="padding: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; background: white;">
          <div class="mention-avatar" style="width: 36px; height: 36px; border-radius: 50%; background: #02735E; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px;">${user.initials}</div>
          <div class="mention-info">
            <div class="mention-name" style="font-weight: 600; font-size: 14px; color: #1e293b;">${user.name}</div>
            <div class="mention-role" style="font-size: 12px; color: #64748b;">${user.role}</div>
          </div>
        </div>
      `).join('');
      
      // Position dropdown below editor
      const rect = editor.getBoundingClientRect();
      dropdown.style.display = 'block';
      dropdown.style.width = rect.width + 'px';
      
      console.log('Dropdown de menciones abierto con', companyUsers.length, 'usuarios');
    }

    function insertMention(userId, userName, initials) {
      console.log('insertMention llamado:', userId, userName, initials);
      
      const editor = document.getElementById('commentText');
      
      if (!editor) {
        console.error('Editor no encontrado');
        return;
      }
      
      console.log('Editor encontrado, insertando mención...');
      
      // Asegurar que el editor tiene el foco
      editor.focus();
      
      // Crear elemento de mención
      const mention = document.createElement('span');
      mention.className = 'mention';
      mention.contentEditable = 'false';
      mention.setAttribute('data-user-id', userId);
      mention.style.cssText = 'background: rgba(2,115,94,0.1); color: #02735E; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin: 0 2px;';
      mention.textContent = `@${userName}`;
      
      console.log('Elemento mención creado:', mention);
      
      // Insertar en la posición del cursor
      const selection = window.getSelection();
      let range;
      
      if (selection.rangeCount > 0) {
        range = selection.getRangeAt(0);
      } else {
        // Si no hay rango, crear uno al final del editor
        range = document.createRange();
        range.selectNodeContents(editor);
        range.collapse(false);
      }
      
      // Insertar la mención
      range.insertNode(mention);
      
      // Agregar espacio después de la mención
      const space = document.createTextNode('\u00A0');
      range.setStartAfter(mention);
      range.insertNode(space);
      
      // Mover cursor después del espacio
      range.setStartAfter(space);
      range.collapse(true);
      selection.removeAllRanges();
      selection.addRange(range);
      
      console.log('Mención insertada exitosamente');
      
      // Cerrar dropdown
      document.getElementById('mentionDropdown').style.display = 'none';
    }

    function updateCommentPreview() {
      // This function can be used to show a live preview if needed
    }

    function updateFileList(input) {
      const fileListDisplay = document.getElementById('fileListDisplay');
      
      if (input.files.length > 0) {
        fileListDisplay.style.display = 'block';
        fileListDisplay.innerHTML = '<div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e2e8f0;">';
        
        for (let i = 0; i < input.files.length; i++) {
          const file = input.files[i];
          const fileSize = (file.size / 1024).toFixed(1) + ' KB';
          const fileIcon = getFileIcon(file.type);
          
          fileListDisplay.innerHTML += `
            <div style="display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 8px; background: #f8fafc; margin-bottom: 8px;">
              <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, #02735E, #035951); display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: 700;">
                ${fileIcon}
              </div>
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; font-size: 13px; color: #1e293b; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.name}</div>
                <div style="font-size: 12px; color: #64748b; margin-top: 2px;">${fileSize}</div>
              </div>
              <button type="button" onclick="removeFile(${i})" style="width: 28px; height: 28px; border-radius: 6px; border: none; background: #fee; color: #dc2626; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
          `;
        }
        
        fileListDisplay.innerHTML += '</div>';
      } else {
        fileListDisplay.style.display = 'none';
      }
    }

    function getFileIcon(fileType) {
      if (fileType.startsWith('image/')) return 'IMG';
      if (fileType.includes('pdf')) return 'PDF';
      if (fileType.includes('word') || fileType.includes('document')) return 'DOC';
      if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'XLS';
      if (fileType.includes('video')) return 'VID';
      return 'FILE';
    }

    function removeFile(index) {
      // Note: Can't directly remove files from input, would need to use DataTransfer API
      showThreadToast('info', 'Para remover archivos, vuelve a seleccionar los adjuntos sin el archivo a eliminar.');
    }

    // Close mention dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('mentionDropdown');
      const mentionBtn = e.target.closest('[onclick="openMentionPicker()"]');
      if (dropdown && !dropdown.contains(e.target) && !mentionBtn) {
        dropdown.style.display = 'none';
      }
    });

    // Close reply mention dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const replyDropdown = document.getElementById('replyMentionDropdown');
      const replyMentionBtn = e.target.closest('[onclick="openReplyMentionPicker()"]');
      if (replyDropdown && !replyDropdown.contains(e.target) && !replyMentionBtn) {
        replyDropdown.style.display = 'none';
      }
    });

    // ========== End Rich Text Editor Functions ==========

    function saveComment() {
      const commentEditor = document.getElementById('commentText');
      
      if (!commentEditor) {
        console.error('Editor no encontrado');
        showThreadToast('error', 'No se encontró el editor. Recarga e inténtalo de nuevo.');
        return;
      }
      
      const commentHTML = commentEditor.innerHTML.trim();
      
      console.log('Contenido del editor:', commentHTML);
      
      // Validar que hay contenido
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = commentHTML;
      const textContent = tempDiv.textContent.trim();
      
      if (!textContent || textContent === '') {
        showThreadToast('warning', 'Escribe un comentario antes de guardar.');
        commentEditor.focus();
        return;
      }

      // Obtener archivos adjuntos
      const filesInput = document.getElementById('commentFiles');
      let attachmentsHTML = '';
      
      if (filesInput.files.length > 0) {
        attachmentsHTML = '<div style="margin-top: 12px; padding: 10px; background: #f0f9ff; border-radius: 6px; display: inline-flex; align-items: center; gap: 10px;">';
        attachmentsHTML += '';
        for (let i = 0; i < filesInput.files.length; i++) {
          attachmentsHTML += filesInput.files[i].name;
          if (i < filesInput.files.length - 1) attachmentsHTML += ', ';
        }
        attachmentsHTML += '</div>';
      }

      // Obtener fecha/hora actual
      const now = new Date();
      const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
      const monthName = months[now.getMonth()];
      const day = now.getDate();

      // Crear nuevo comentario estilo Basecamp
      const newComment = `
        <div class="timeline-item">
          <div class="comment-header">
            <div class="comment-avatar" style="background: linear-gradient(135deg, #6366f1, #4f46e5);">UA</div>
            <div class="comment-meta">
              <div class="comment-author-name">Usuario Actual</div>
              <div class="comment-author-role">· ${monthName} ${day} · Ahora mismo</div>
            </div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              ${commentHTML}
            </div>
            ${attachmentsHTML}
          </div>
        </div>
      `;

      // Insertar al inicio del timeline
      const timeline = document.querySelector('.timeline');
      timeline.insertAdjacentHTML('afterbegin', newComment);
      
      // Limpiar editor
      commentEditor.innerHTML = '';

      closeModal('addCommentModal');
      showThreadToast('success', 'Comentario agregado exitosamente.');
    }

    function saveUpdate() {
      const title = document.getElementById('updateTitle').value.trim();
      const description = document.getElementById('updateDescription').value.trim();
      const type = document.getElementById('updateType').value;
      const photosInput = document.getElementById('updatePhotos');
      const docsInput = document.getElementById('updateDocuments');

      if (!title || !description) {
        showThreadToast('warning', 'Completa título y descripción antes de publicar.');
        return;
      }

      // Obtener fecha y hora actual del sistema
      const now = new Date();
      const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
      const day = now.getDate();
      const month = months[now.getMonth()];
      const year = now.getFullYear();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const formattedDate = `${day} ${month} ${year} - ${hours}:${minutes}`;

      // Procesar archivos adjuntos
      let attachmentsHTML = '';
      const photoFiles = photosInput.files;
      const docFiles = docsInput.files;
      
      if (photoFiles.length > 0 || docFiles.length > 0) {
        attachmentsHTML = '<div style="margin-top: 12px; padding: 10px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6;">';
        attachmentsHTML += '<div style="font-size: 12px; font-weight: 600; color: #1e40af; margin-bottom: 6px;">Archivos adjuntos:</div>';
        
        if (photoFiles.length > 0) {
          attachmentsHTML += `<div style="font-size: 12px; color: #475569; margin-bottom: 4px;">${inlineIconHTML('photo')}${photoFiles.length} foto(s): `;
          for (let i = 0; i < photoFiles.length; i++) {
            attachmentsHTML += photoFiles[i].name;
            if (i < photoFiles.length - 1) attachmentsHTML += ', ';
          }
          attachmentsHTML += '</div>';
        }
        
        if (docFiles.length > 0) {
          attachmentsHTML += `<div style="font-size: 12px; color: #475569;">${inlineIconHTML('document')}${docFiles.length} documento(s): `;
          for (let i = 0; i < docFiles.length; i++) {
            attachmentsHTML += docFiles[i].name;
            if (i < docFiles.length - 1) attachmentsHTML += ', ';
          }
          attachmentsHTML += '</div>';
        }
        
        attachmentsHTML += '</div>';
      }

      // Iconos según tipo
      const icons = {
        call: '<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>',
        meeting: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
        visit: '<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>',
        email: '<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>',
        quote: '<polyline points="20 6 9 17 4 12"/>',
        proposal: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>',
        correction: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>',
        comment: '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>',
        negotiation: '<circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>',
        followup: '<path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"/>',
        presentation: '<rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>',
        contract: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>',
        payment: '<rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/>',
        other: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>'
      };

      const newTimelineItem = `
        <div class="timeline-item" style="animation: slideUp 0.3s ease-out;">
          <div class="timeline-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              ${icons[type]}
            </svg>
          </div>
          <div class="timeline-content">
            <div class="timeline-title">${title}</div>
            <div class="timeline-date">${formattedDate}</div>
            <div class="timeline-text">${description}</div>
            ${attachmentsHTML}
          </div>
        </div>
      `;

      // Insertar al inicio del timeline
      const timeline = document.querySelector('.timeline');
      timeline.insertAdjacentHTML('afterbegin', newTimelineItem);

      closeModal('addUpdateModal');
      showThreadToast('success', 'Actualización agregada exitosamente.');
    }

    // Función principal para convertir Thread a Proyecto
    function convertToProject() {
      // Obtener datos del thread actual
      const urlParams = new URLSearchParams(window.location.search);
      const threadId = urlParams.get('id');
      
      console.log('Convirtiendo thread a proyecto:', threadId);
      
      let threadData = null;
      try {
        const storedThreads = localStorage.getItem('threadsync_threads');
        if (storedThreads) {
          const threadsData = JSON.parse(storedThreads);
          threadData = threadsData[threadId];
          console.log('Datos del thread encontrados:', threadData);
        }
      } catch (e) {
        console.error('Error al cargar thread:', e);
      }
      
      if (!threadData) {
        console.warn('No se encontraron datos para el thread:', threadId);
      }
      
      // Extraer datos del thread (si existen)
      const clientName = threadData?.clientName || 'Sin especificar';
      const subject = threadData?.subject || 'Sin descripción';
      const contactInfo = threadData?.contactInfo && threadData.contactInfo !== '-' ? threadData.contactInfo : 'No especificado';
      const owner = threadData?.owner || threadData?.createdBy || 'Sin asignar';
      
      console.log('Datos para el modal:', { clientName, subject, contactInfo, owner });
      
      const modalHTML = `
        <div class="modal-overlay" id="convertModal" onclick="handleOverlayClick(event, 'convertModal')">
          <div class="modal">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                  <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                Convertir a ProjectSync
              </div>
              <button type="button" class="modal-close" onclick="closeModal('convertModal')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div class="alert-box">
                <div class="alert-icon">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                  </svg>
                </div>
                <div class="alert-content">
                  <div class="alert-title">Convertir ThreadSync a Proyecto</div>
                  <div class="alert-text">La información existente se copiará automáticamente. Completa los datos faltantes para programar el proyecto.</div>
                </div>
              </div>

              <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-secondary); display: flex; align-items: center; gap: 8px;">
                <span style="display: inline-flex; width: 20px; height: 20px; color: var(--primary-color);">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 4h-3.18a3 3 0 0 0-5.64 0H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path>
                    <line x1="9" y1="12" x2="15" y2="12"></line>
                    <line x1="9" y1="16" x2="13" y2="16"></line>
                  </svg>
                </span>
                Información del ThreadSync (Editable)
              </h4>

              <div class="form-group">
                <label class="form-label">Nombre del Proyecto / Cliente *</label>
                <input type="text" id="projectClientName" class="form-input" value="${clientName}" placeholder="Ej: Corporativo ABC" />
              </div>

              <div class="form-group">
                <label class="form-label">Descripción del Proyecto *</label>
                <textarea id="projectDescription" class="form-textarea" rows="2" placeholder="Descripción breve del proyecto">${subject}</textarea>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                  <label class="form-label">Contacto Principal</label>
                  <input type="text" id="projectContact" class="form-input" value="${contactInfo !== 'No especificado' ? contactInfo : ''}" placeholder="Nombre del contacto" />
                </div>
                <div class="form-group">
                  <label class="form-label">Email/Teléfono</label>
                  <input type="text" id="projectContactInfo" class="form-input" value="${contactInfo !== 'No especificado' ? contactInfo : ''}" placeholder="contacto@ejemplo.com" />
                </div>
              </div>

              <h4 style="font-size: 16px; font-weight: 600; margin: 24px 0 16px; color: var(--primary-color); display: flex; align-items: center; gap: 8px;">
                <span style="display: inline-flex; width: 20px; height: 20px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
                  </svg>
                </span>
                Completar para Programación
              </h4>

              <div class="form-group">
                <label class="form-label">Dirección del Proyecto *</label>
                <input type="text" id="projectAddress" class="form-input" placeholder="Av. Universidad #789, Guadalajara" />
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                  <label class="form-label">Fecha de Inicio *</label>
                  <input type="date" id="projectStartDate" class="form-input" />
                </div>
                <div class="form-group">
                  <label class="form-label">Fecha de Fin *</label>
                  <input type="date" id="projectEndDate" class="form-input" />
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Notas del Proyecto</label>
                <textarea id="projectNotes" class="form-textarea" placeholder="Detalles adicionales del proyecto..."></textarea>
              </div>
              
              <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 12px; margin-top: 16px;">
                <p style="font-size: 13px; color: #0369a1; margin: 0; display: flex; align-items: center; gap: 8px;">
                  <span style="display: inline-flex; width: 18px; height: 18px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M9 18h6"></path>
                      <path d="M10 22h4"></path>
                      <path d="M2 9a10 10 0 0 1 20 0c0 3.5-2 6.5-5 8a3 3 0 0 0-1 2v1H8v-1a3 3 0 0 0-1-2c-3-1.5-5-4.5-5-8z"></path>
                    </svg>
                  </span>
                  <strong>Nota:</strong> La asignación de cuadrilla y presupuesto se realizará dentro de ProjectSync una vez creado el proyecto.
                </p>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeModal('convertModal')">Cancelar</button>
              <button type="button" class="btn btn-success" onclick="confirmConversion()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                Crear Proyecto
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function handleOverlayClick(event, modalId) {
      // Solo cerrar si se hace clic directamente en el overlay (no en el contenido)
      if (event.target === event.currentTarget) {
        // Verificar si hay texto seleccionado
        const selection = window.getSelection();
        if (selection && selection.toString().length > 0) {
          // Hay texto seleccionado, no cerrar el modal
          console.log('Texto seleccionado, modal no se cerrará');
          return;
        }
        // No hay selección, cerrar el modal
        closeModal(modalId);
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.animation = 'fadeOut 0.2s ease-out';
        setTimeout(() => modal.remove(), 200);
      }
    }

    function navigateWithReturn(base, extras = {}, options = {}) {
      if (window.ReturnNav && typeof window.ReturnNav.navigate === 'function') {
        window.ReturnNav.navigate(base, extras, options);
      } else {
        const params = new URLSearchParams(extras || {});
        const query = params.toString();
        window.location.href = `${base}${query ? `?${query}` : ''}`;
      }
    }

    function goToProject() {
      if (!threadState.projectId) {
        showThreadToast('warning', 'Este thread aún no tiene proyecto asignado.');
        return;
      }
      navigateWithReturn('viewsync.html', { id: threadState.projectId });
    }

    function showThreadToast(type, message) {
      const palette = {
        success: '#10b981',
        info: '#0f766e',
        warning: '#d97706',
        error: '#dc2626'
      };
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 24px;
        right: 24px;
        background: var(--bg-card);
        border: 2px solid ${palette[type] || palette.info};
        border-radius: 12px;
        padding: 14px 18px;
        box-shadow: 0 18px 40px rgba(15,23,42,0.2);
        font-weight: 600;
        color: var(--text-primary);
        z-index: 4000;
        min-width: 260px;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-6px)';
        setTimeout(() => toast.remove(), 200);
      }, 2800);
    }

    function threadConfirm(message, { confirmText = 'Confirmar', cancelText = 'Cancelar' } = {}) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'confirm-overlay';
        overlay.innerHTML = `
          <div class="confirm-card">
            <p>${message}</p>
            <div class="confirm-actions">
              <button class="btn btn-secondary">${cancelText}</button>
              <button class="btn btn-primary">${confirmText}</button>
            </div>
          </div>
        `;
        const [cancelBtn, confirmBtn] = overlay.querySelectorAll('button');
        cancelBtn.addEventListener('click', () => {
          overlay.remove();
          resolve(false);
        });
        confirmBtn.addEventListener('click', () => {
          overlay.remove();
          resolve(true);
        });
        overlay.addEventListener('click', (event) => {
          if (event.target === overlay) {
            overlay.remove();
            resolve(false);
          }
        });
        document.body.appendChild(overlay);
      });
    }

    function confirmConversion() {
      // Obtener datos del formulario
      const address = document.getElementById('projectAddress')?.value;
      const startDate = document.getElementById('projectStartDate')?.value;
      const endDate = document.getElementById('projectEndDate')?.value;
      const notes = document.getElementById('projectNotes')?.value;
      
      // Validar campos requeridos
      if (!address || !startDate || !endDate) {
        showThreadToast('warning', 'Completa dirección y fechas para crear el proyecto.');
        return;
      }
      
      // Obtener datos del thread
      const urlParams = new URLSearchParams(window.location.search);
      const threadId = urlParams.get('id');
      
      let threadData = null;
      try {
        const storedThreads = localStorage.getItem('threadsync_threads');
        if (storedThreads) {
          const threadsData = JSON.parse(storedThreads);
          threadData = threadsData[threadId];
        }
      } catch (e) {
        console.error('Error al cargar thread:', e);
      }
      
      // Generar IDSync automático
      const lastID = parseInt(localStorage.getItem('lastIDSync') || '1000');
      const nextID = lastID + 1;
      const idSyncValue = `IDSYNC-${nextID}`;
      
      // Generar ID de proyecto
      const existingProjects = JSON.parse(localStorage.getItem('projectsync_projects') || '[]');
      const maxId = existingProjects.reduce((max, p) => {
        const num = parseInt(p.id.replace('ORD-', ''));
        return num > max ? num : max;
      }, 200);
      const newProjectId = 'ORD-' + (maxId + 1);
      
      // Crear objeto de proyecto completo
      const projectData = {
        idSync: idSyncValue,
        id: newProjectId,
        name: threadData?.clientName || 'Proyecto desde Thread',
        client: threadData?.clientName || 'Cliente',
        contact: threadData?.contactInfo && threadData.contactInfo !== '-' ? threadData.contactInfo : '',
        phone: '',
        email: '',
        address: address,
        lat: null, // Se puede agregar geocodificación después
        lng: null,
        status: 'active',
        startDate: startDate,
        endDate: endDate,
        description: (threadData?.subject || '') + (notes ? '\n\n' + notes : ''),
        amount: 0,
        progress: 0,
        createdAt: new Date().toISOString(),
        convertedFromThread: threadId
      };
      
      // Guardar proyecto en localStorage
      const projects = JSON.parse(localStorage.getItem('projectsync_projects') || '[]');
      projects.push(projectData);
      localStorage.setItem('projectsync_projects', JSON.stringify(projects));
      
      // Actualizar lastIDSync
      localStorage.setItem('lastIDSync', nextID.toString());
      
      // Registrar IDSync como usado
      const usedIDs = JSON.parse(localStorage.getItem('usedIDSyncs') || '[]');
      usedIDs.push({
        idSync: idSyncValue,
        projectId: newProjectId,
        projectName: projectData.name,
        status: 'completed',
        createdAt: new Date().toISOString(),
        convertedFromThread: true
      });
      localStorage.setItem('usedIDSyncs', JSON.stringify(usedIDs));
      
      // Actualizar thread con vinculación al proyecto
      if (threadData && threadId) {
        try {
          const storedThreads = localStorage.getItem('threadsync_threads');
          if (storedThreads) {
            const threadsData = JSON.parse(storedThreads);
            if (threadsData[threadId]) {
              threadsData[threadId].projectId = newProjectId;
              threadsData[threadId].projectName = projectData.name;
              threadsData[threadId].isConverted = true;
              localStorage.setItem('threadsync_threads', JSON.stringify(threadsData));
            }
          }
        } catch (e) {
          console.error('Error al actualizar thread:', e);
        }
      }
      
      console.log('Proyecto creado:', projectData);
      console.log('Thread vinculado:', threadId, '→', newProjectId);
      
      threadState.projectId = newProjectId;
      threadState.projectName = projectData.name;
      threadState.isConverted = true;
      renderThreadHeader();
      closeModal('convertModal');
      showThreadToast('success', `Proyecto ${projectData.name} creado. Abriendo ViewSync...`);
      setTimeout(() => {
        navigateWithReturn('viewsync.html', { id: newProjectId });
      }, 1200);
    }



    // Función para responder a comentario
    function replyToComment(commentId) {
      const replyHTML = `
        <div class="modal-overlay" id="replyModal" onclick="handleOverlayClick(event, 'replyModal')">
          <div class="modal modern-modal">
            <!-- Header Moderno -->
            <div class="modal-header" style="background: linear-gradient(135deg, #02735E 0%, #035951 100%); color: white; padding: 28px 32px; border-radius: 20px 20px 0 0; position: relative; overflow: hidden;">
              
              <div style="position: relative; z-index: 1;">
                <div class="modal-title" style="display: flex; align-items: center; gap: 12px; font-size: 24px; font-weight: 700; margin: 0;">
                  <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                    </svg>
                  </div>
                  <div>
                    <div style="font-size: 20px; font-weight: 700; letter-spacing: -0.3px;">Responder Comentario</div>
                    <div style="font-size: 13px; font-weight: 400; opacity: 0.85; margin-top: 2px;">Comparte tu opinión en esta conversación</div>
                  </div>
                </div>
              </div>
              
              <button type="button" class="modal-close" onclick="closeModal('replyModal')" style="position: absolute; top: 24px; right: 24px; z-index: 2; width: 36px; height: 36px; border-radius: 8px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; backdrop-filter: blur(10px);">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            
            <!-- Body Moderno -->
            <div class="modal-body" style="padding: 32px; background: #fafafa;">
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" style="font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 20h9"/>
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                  </svg>
                  Tu respuesta
                </label>
                
                <!-- Barra de herramientas modernizada -->
                <div class="editor-toolbar" style="background: white; border: 1px solid #e2e8f0; border-bottom: none; border-radius: 12px 12px 0 0; padding: 12px 16px; display: flex; gap: 6px; flex-wrap: wrap; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                  <button type="button" class="toolbar-btn" onclick="formatReplyText('bold')" title="Negrita (Ctrl+B)" style="padding: 8px 12px; border: none; background: #f8fafc; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; transition: all 0.2s; min-width: 36px; height: 36px;">
                    <strong>B</strong>
                  </button>
                  <button type="button" class="toolbar-btn" onclick="formatReplyText('italic')" title="Cursiva (Ctrl+I)" style="padding: 8px 12px; border: none; background: #f8fafc; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; font-style: italic; transition: all 0.2s; min-width: 36px; height: 36px;">
                    <em>I</em>
                  </button>
                  <button type="button" class="toolbar-btn" onclick="formatReplyText('underline')" title="Subrayado" style="padding: 8px 12px; border: none; background: #f8fafc; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; text-decoration: underline; transition: all 0.2s; min-width: 36px; height: 36px;">
                    U
                  </button>
                  <div style="width: 1px; background: #e2e8f0; margin: 0 6px;"></div>
                  <button type="button" class="toolbar-btn" onclick="formatReplyText('h1')" title="Título Grande" style="padding: 8px 12px; border: none; background: #f8fafc; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 700; transition: all 0.2s; min-width: 40px; height: 36px;">
                    H1
                  </button>
                  <button type="button" class="toolbar-btn" onclick="formatReplyText('h2')" title="Título Mediano" style="padding: 8px 12px; border: none; background: #f8fafc; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; min-width: 40px; height: 36px;">
                    H2
                  </button>
                  <div style="width: 1px; background: #e2e8f0; margin: 0 6px;"></div>
                  <div style="position: relative; display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: #f8fafc; border-radius: 8px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                    </svg>
                    <input type="color" id="replyTextColorPicker" value="#1e293b" title="Color de texto" style="width: 28px; height: 28px; border: none; border-radius: 4px; cursor: pointer; padding: 0; background: transparent;" onchange="applyReplyTextColor(this.value)">
                  </div>
                  <div style="width: 1px; background: #e2e8f0; margin: 0 6px;"></div>
                  <button type="button" class="toolbar-btn" onclick="openReplyMentionPicker()" title="Etiquetar a alguien" style="padding: 8px 14px; border: none; background: rgba(2,115,94,0.08); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; color: #02735E; font-weight: 600; font-size: 13px; transition: all 0.2s; height: 36px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                      <circle cx="9" cy="7" r="4"></circle>
                      <line x1="19" y1="8" x2="19" y2="14"></line>
                      <line x1="22" y1="11" x2="16" y2="11"></line>
                    </svg>
                    Mencionar
                  </button>
                </div>
                
                <div contenteditable="true" id="replyText" class="form-textarea rich-editor" placeholder="Escribe tu respuesta... Usa formato y menciona a personas con @" style="min-height: 150px; border-radius: 0 0 12px 12px; outline: none; overflow-y: auto; background: white; border: 1px solid #e2e8f0; border-top: none; font-size: 15px; line-height: 1.7; box-shadow: 0 1px 3px rgba(0,0,0,0.05);" oninput="updateReplyPreview()"></div>
                
                <!-- Dropdown de menciones para reply -->
                <div id="replyMentionDropdown" style="display: none; position: absolute; background: white; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); max-height: 280px; overflow-y: auto; z-index: 1000; margin-top: 8px;">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
            
            <!-- Footer Moderno -->
            <div class="modal-footer" style="padding: 24px 32px; background: white; border-top: 1px solid #f1f5f9; border-radius: 0 0 20px 20px; display: flex; gap: 12px; justify-content: flex-end;">
              <button type="button" class="btn btn-secondary" onclick="closeModal('replyModal')" style="padding: 12px 24px; border-radius: 10px; font-weight: 600; font-size: 14px; border: 1px solid #e2e8f0; background: white; color: #64748b; transition: all 0.2s;">
                Cancelar
              </button>
              <button type="button" class="btn btn-primary" onclick="saveReply(${commentId})" style="padding: 12px 28px; border-radius: 10px; font-weight: 600; font-size: 14px; background: linear-gradient(135deg, #02735E, #035951); border: none; color: white; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(2,115,94,0.25); transition: all 0.2s;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
                Publicar Respuesta
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', replyHTML);
    }

    // Funciones para el editor de respuestas
    function formatReplyText(command) {
      const replyEditor = document.getElementById('replyText');
      replyEditor.focus();
      
      if (command === 'bold' || command === 'italic' || command === 'underline') {
        document.execCommand(command, false, null);
      } else if (command === 'h1') {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          const h1 = document.createElement('h1');
          h1.style.fontSize = '28px';
          h1.style.fontWeight = '700';
          h1.style.marginTop = '8px';
          h1.style.marginBottom = '8px';
          try {
            range.surroundContents(h1);
          } catch(e) {
            h1.textContent = range.toString();
            range.deleteContents();
            range.insertNode(h1);
          }
        }
      } else if (command === 'h2') {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          const h2 = document.createElement('h2');
          h2.style.fontSize = '22px';
          h2.style.fontWeight = '600';
          h2.style.marginTop = '6px';
          h2.style.marginBottom = '6px';
          try {
            range.surroundContents(h2);
          } catch(e) {
            h2.textContent = range.toString();
            range.deleteContents();
            range.insertNode(h2);
          }
        }
      }
    }

    function applyReplyTextColor(color) {
      document.getElementById('replyText').focus();
      document.execCommand('foreColor', false, color);
    }

    function openReplyMentionPicker() {
      const dropdown = document.getElementById('replyMentionDropdown');
      const editor = document.getElementById('replyText');
      
      // Populate with company users
      dropdown.innerHTML = companyUsers.map(user => `
        <div class="mention-item" onclick="insertReplyMention('${user.id}', '${user.name}', '${user.initials}')" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; transition: all 0.15s;">
          <div class="mention-avatar" style="width: 32px; height: 32px; border-radius: 50%; background: #02735E; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px;">
            ${user.initials}
          </div>
          <div>
            <div class="mention-name" style="font-weight: 600; font-size: 14px; color: #1e293b;">${user.name}</div>
            <div class="mention-role" style="font-size: 12px; color: #64748b;">${user.role}</div>
          </div>
        </div>
      `).join('');
      
      dropdown.style.display = 'block';
      
      // Position dropdown
      const rect = editor.getBoundingClientRect();
      dropdown.style.top = (rect.bottom + window.scrollY + 8) + 'px';
      dropdown.style.left = rect.left + 'px';
      dropdown.style.width = rect.width + 'px';
    }

    function insertReplyMention(userId, userName, initials) {
      const editor = document.getElementById('replyText');
      const dropdown = document.getElementById('replyMentionDropdown');
      
      editor.focus();
      
      const selection = window.getSelection();
      const range = selection.getRangeAt(0);
      
      const mention = document.createElement('span');
      mention.className = 'mention';
      mention.setAttribute('data-user-id', userId);
      mention.contentEditable = 'false';
      mention.textContent = '@' + userName;
      mention.style.background = 'rgba(2,115,94,0.1)';
      mention.style.color = '#02735E';
      mention.style.padding = '2px 6px';
      mention.style.borderRadius = '4px';
      mention.style.fontWeight = '600';
      mention.style.cursor = 'pointer';
      
      range.insertNode(mention);
      
      // Add space after mention
      const space = document.createTextNode('\u00A0');
      range.setStartAfter(mention);
      range.insertNode(space);
      range.setStartAfter(space);
      range.collapse(true);
      selection.removeAllRanges();
      selection.addRange(range);
      
      dropdown.style.display = 'none';
    }

    function updateReplyPreview() {
      // Optional: Could add character count or other real-time updates
    }

    function saveReply(commentId) {
      const replyEditor = document.getElementById('replyText');
      const replyHTML = replyEditor.innerHTML.trim();
      
      // Check if there's actual content
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = replyHTML;
      const textContent = tempDiv.textContent || tempDiv.innerText || '';
      
      if (!textContent.trim()) {
        showThreadToast('warning', 'Escribe una respuesta antes de publicar.');
        replyEditor.focus();
        return;
      }
      
      closeModal('replyModal');
      showThreadToast('success', 'Respuesta publicada.');
      console.log(`Reply to comment ${commentId}:`, replyHTML);
      
      // Clear editor
      replyEditor.innerHTML = '';
    }

    // Función para editar comentario
    function editComment(commentId) {
      const editHTML = `
        <div class="modal-overlay" id="editModal" onclick="handleOverlayClick(event, 'editModal')">
          <div class="modal">
            <div class="modal-header">
              <div class="modal-title">Editar Comentario</div>
              <button type="button" class="modal-close" onclick="closeModal('editModal')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Comentario</label>
                <textarea id="editText" class="form-textarea">Texto del comentario original...</textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">Cancelar</button>
              <button type="button" class="btn btn-primary" onclick="saveEdit(${commentId})">Guardar Cambios</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', editHTML);
    }

    function saveEdit(commentId) {
      closeModal('editModal');
      showThreadToast('success', 'Comentario actualizado.');
    }

    // Función para eliminar comentario
    async function deleteComment(commentId) {
      const confirmed = await threadConfirm('¿Estás seguro de eliminar este comentario?', {
        confirmText: 'Eliminar',
        cancelText: 'Cancelar'
      });
      if (!confirmed) return;
      
      showThreadToast('success', 'Comentario eliminado.');
      console.log(`Deleted comment ${commentId}`);
    }

    // Filtros de búsqueda
    document.addEventListener('DOMContentLoaded', function() {
      // SIMULACIÓN: Usuario de sesión actual (esto vendrá del login real)
      // En producción, esto se establecerá cuando el usuario haga login en motorsync.html
      if (!sessionStorage.getItem('currentUser')) {
        sessionStorage.setItem('currentUser', JSON.stringify({
          displayName: 'Rodolfo Real',
          email: 'rodolfo@opsis.com',
          role: 'estimator_pm',
          userId: 'user_001'
        }));
      }
      
      hydrateThreadDefaults();
      checkThreadConversionStatus();
      renderThreadHeader();
      
      // 🆕 RENDERIZAR COMENTARIOS DINÁMICAMENTE
      renderComments();
      
      const searchInput = document.getElementById('searchComments');
      const filterAuthor = document.getElementById('filterAuthor');
      const filterDate = document.getElementById('filterDate');
      
      if (searchInput) {
        searchInput.addEventListener('input', filterComments);
      }
      if (filterAuthor) {
        filterAuthor.addEventListener('change', filterComments);
      }
      if (filterDate) {
        filterDate.addEventListener('change', filterComments);
      }
    });
    
    // 🆕 FUNCIÓN PARA RENDERIZAR COMENTARIOS DESDE LOCALSTORAGE
    function renderComments() {
      const urlParams = new URLSearchParams(window.location.search);
      const threadId = urlParams.get('id');
      const timeline = document.querySelector('.timeline');
      
      if (!timeline) return;
      
      // Limpiar timeline
      timeline.innerHTML = '';
      
      if (!threadId) {
        timeline.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #94a3b8;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px; opacity: 0.3;">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <p style="font-size: 16px; font-weight: 600; color: #64748b; margin-bottom: 8px;">Sin comentarios aún</p>
            <p style="font-size: 14px; color: #94a3b8;">Sé el primero en comentar en este thread</p>
          </div>
        `;
        return;
      }
      
      // Cargar thread desde localStorage
      let threadData = null;
      try {
        const storedThreads = localStorage.getItem('threadsync_threads');
        if (storedThreads) {
          const threadsData = JSON.parse(storedThreads);
          threadData = threadsData[threadId];
        }
      } catch (e) {
        console.error('Error al cargar comentarios:', e);
      }
      
      // Si el thread tiene mensajes, mostrarlos
      if (threadData && threadData.messages && threadData.messages.length > 0) {
        threadData.messages.forEach((message, index) => {
          const commentHTML = `
            <div class="timeline-item">
              <div class="comment-header">
                <div class="comment-avatar">${getInitials(message.author)}</div>
                <div class="comment-meta">
                  <div class="comment-author-name">${message.author}</div>
                  <div class="comment-author-role">
                    <span>Hace unos momentos</span>
                  </div>
                </div>
              </div>
              <div class="comment-body">
                <div class="comment-text ${index === 0 ? 'thread-description' : ''}">
                  ${message.text}
                </div>
                <div style="display: flex; gap: 12px; margin-top: 12px; align-items: center; justify-content: flex-end;">
                  <button type="button" class="reply-btn" onclick="replyToComment(${message.id})">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="9 14 4 9 9 4"/>
                      <path d="M20 20v-7a4 4 0 0 0-4-4H4"/>
                    </svg>
                    Responder
                  </button>
                </div>
              </div>
            </div>
          `;
          timeline.innerHTML += commentHTML;
        });
      } else {
        // Mostrar estado vacío
        timeline.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #94a3b8;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px; opacity: 0.3;">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <p style="font-size: 16px; font-weight: 600; color: #64748b; margin-bottom: 8px;">Sin comentarios aún</p>
            <p style="font-size: 14px; color: #94a3b8;">Sé el primero en comentar en este thread</p>
          </div>
        `;
      }
    }
    
    // Función auxiliar para obtener iniciales
    function getInitials(name) {
      if (!name) return '??';
      const parts = name.split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }

    // Verificar si el thread ya fue convertido a proyecto
    function checkThreadConversionStatus() {
      // Simulación: En producción esto vendría de la base de datos
      const savedThread = localStorage.getItem('threadState_current');
      if (savedThread) {
        const saved = JSON.parse(savedThread);
        if (saved.isConverted && saved.projectId) {
          threadState.isConverted = true;
          threadState.projectId = threadState.projectId || saved.projectId;
          threadState.projectName = threadState.projectName || saved.projectName;
        }
      }
      if (threadState.projectId) {
        const convertSection = document.getElementById('notConvertedSection');
        const convertedSection = document.getElementById('convertedSection');
        if (convertSection) convertSection.style.display = 'none';
        if (convertedSection) convertedSection.style.display = 'block';
        renderProjectStatusCard();
      }
    }

    function filterComments() {
      const search = document.getElementById('searchComments')?.value.toLowerCase() || '';
      const author = document.getElementById('filterAuthor')?.value || '';
      const date = document.getElementById('filterDate')?.value || '';
      
      const comments = document.querySelectorAll('.timeline-item');
      
      comments.forEach(comment => {
        const text = comment.textContent.toLowerCase();
        const authorMatch = author === '' || comment.querySelector('.comment-avatar')?.textContent.includes(author);
        const searchMatch = search === '' || text.includes(search);
        
        if (searchMatch && authorMatch) {
          comment.style.display = '';
        } else {
          comment.style.display = 'none';
        }
      });
    }

    // ===================================
    // INTEGRATION: SCHEDULE APPOINTMENT FROM THREAD
    // ===================================
    function scheduleAppointmentFromThread() {
      const urlParams = new URLSearchParams(window.location.search);
      const threadId = urlParams.get('id');
      
      // Get thread data
      let threadData = null;
      try {
        const storedThreads = localStorage.getItem('threadsync_threads');
        if (storedThreads) {
          const threadsData = JSON.parse(storedThreads);
          threadData = threadsData[threadId];
        }
      } catch (e) {
        console.error('Error loading thread:', e);
      }
      
      // Prepare appointment data to pass to PlanSync
      const appointmentData = {
        sourceType: 'thread',
        sourceId: threadId,
        client: threadData?.clientName || 'Cliente no especificado',
        title: `Visita - ${threadData?.subject || 'Oportunidad'}`,
        notes: `Origen: Oportunidad ${threadId}\nAsunto: ${threadData?.subject || ''}`,
        type: 'inspection', // Default for threads
        address: threadData?.address || ''
      };
      
      // Store temporary appointment data
      localStorage.setItem('temp_appointment_data', JSON.stringify(appointmentData));
      
      // Redirect to PlanSync with new appointment modal
      navigateWithReturn('plansync.html', { action: 'new', source: 'thread', id: threadId });
    }
  </script>

  </div><!-- /app-content -->
</div><!-- /app-shell -->

</body>
</html>
