await loadRealStats();
                await loadCompaniesTable();

            } catch (error) {
                console.error('Cleanup failed:', error);
                showNotification('Cleanup Failed', error.message, 'error');
            }
        }

        // Funci√≥n para manejar el logout - FALTABA ESTA
        function handleSignOut() {
            const signOutBtn = document.querySelector('.sign-out-btn');
            
            if (!confirm('Are you sure you want to sign out of the Super Admin Panel?')) {
                return;
            }
            
            signOutBtn.innerHTML = '<span>üîÑ</span><span>Signing out...</span>';
            signOutBtn.disabled = true;
            
            localStorage.removeItem('opsis_admin_session');
            sessionStorage.clear();
            
            addActivity('info', 'Admin Logout', 'Super administrator signed out');
            showNotification('Signing Out', 'Redirecting to login page...', 'success');
            
            setTimeout(() => {
                window.location.href = 'https://www.opsis-suite.com/login';
            }, 1500);
        }

        // Funciones de UI - FALTABAN ESTAS
        function addNewCompany() {
            const modal = document.getElementById('addCompanyModal');
            modal.classList.add('show');
            addActivity('info', 'Add Company Modal', 'Opening new company creation form');
        }

        function closeAddCompanyModal() {
            const modal = document.getElementById('addCompanyModal');
            modal.classList.remove('show');
        }

        function viewAnalytics() {
            showNotification('Opening Analytics', 'Redirecting to analytics dashboard...', 'success');
            setTimeout(() => {
                window.open('/admin/analytics.html', '_top');
            }, 1000);
        }

        function systemHealth() {
            showNotification('System Health', 'All systems operational', 'success');
            addActivity('info', 'System Health Check', 'All services running normally');
        }

        // Sistema de notificaciones - FALTABA ESTA
        function showNotification(title, message, type = 'success') {
            const notification = document.getElementById('notification');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            notification.classList.remove('success', 'error', 'warning');
            notification.classList.add(type, 'show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Cargar estad√≠sticas - FALTABA ESTA
        async function loadRealStats() {
            try {
                const { data: companies, error } = await supabase
                    .from('companies')
                    .select('*');

                if (error) throw error;

                const totalCompanies = companies?.length || 0;
                const totalRevenue = calculateMonthlyRevenue(companies);
                const totalUsers = companies?.reduce((sum, company) => sum + (company.initial_users || 0), 0) || 0;

                document.getElementById('totalCompanies').textContent = totalCompanies;
                document.getElementById('totalRevenue').textContent = `$${totalRevenue}`;
                document.getElementById('totalUsers').textContent = totalUsers;

                document.getElementById('companiesChange').textContent = totalCompanies === 0 ? 'Ready to start' : `${totalCompanies} active companies`;
                document.getElementById('revenueChange').textContent = totalRevenue === 0 ? 'Growing from zero' : `$${totalRevenue}/month`;
                document.getElementById('usersChange').textContent = totalUsers === 0 ? 'Awaiting first company' : `${totalUsers} users total`;

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function calculateMonthlyRevenue(companies) {
            if (!companies) return 0;
            
            const planPrices = {
                trial: 0,
                warehouse_basic: 49,
                warehouse_pro: 149,
                suite_standard: 249,
                suite_premium: 499,
                enterprise: 999
            };

            return companies.reduce((total, company) => {
                return total + (planPrices[company.plan] || 0);
            }, 0);
        }

        // Cargar tabla de empresas - FALTABA ESTA
        async function loadCompaniesTable() {
            try {
                const { data: companies, error } = await supabase
                    .from('companies')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tableBody = document.getElementById('companiesTableBody');
                
                if (!companies || companies.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-icon">üè¢</div>
                                <div class="empty-title">Ready to Launch Your SaaS</div>
                                <div class="empty-description">Your Opsis Suite control center is ready.<br>Start by adding your first company to begin generating revenue.</div>
                                <button onclick="addNewCompany()" class="empty-cta">
                                    üöÄ Add First Company
                                </button>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tableBody.innerHTML = companies.map(company => `
                    <tr>
                        <td>
                            <div class="company-name">${company.name}</div>
                            <div class="company-domain">${company.domain}</div>
                        </td>
                        <td><span class="status-badge ${company.status}">${company.status}</span></td>
                        <td><span class="plan-badge">${formatPlan(company.plan)}</span></td>
                        <td>Warehouse${company.plan.includes('suite') ? ', HR' : ''}${company.plan === 'enterprise' ? ', TimeSync, Finance' : ''}</td>
                        <td>${company.initial_users || 5}</td>
                        <td>$${getPlanPrice(company.plan)}/month</td>
                        <td>
                            <button class="btn-small btn-primary" onclick="viewCompany('${company.slug}')">View</button>
                            <button class="btn-small btn-secondary" onclick="editCompany('${company.id}')">Edit</button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading companies:', error);
            }
        }

        function formatPlan(plan) {
            const planNames = {
                trial: 'Trial',
                warehouse_basic: 'Basic',
                warehouse_pro: 'Pro',
                suite_standard: 'Standard',
                suite_premium: 'Premium',
                enterprise: 'Enterprise'
            };
            return planNames[plan] || plan;
        }

        function getPlanPrice(plan) {
            const planPrices = {
                trial: 0,
                warehouse_basic: 49,
                warehouse_pro: 149,
                suite_standard: 249,
                suite_premium: 499,
                enterprise: 999
            };
            return planPrices[plan] || 0;
        }

        function viewCompany(slug) {
            window.open(`/${slug}`, '_blank');
        }

        function editCompany(id) {
            showNotification('Edit Company', 'Company editing feature coming soon', 'success');
        }

        // Manejo del formulario - FALTABA ESTA
        function handleAddCompany(event) {
            event.preventDefault();
            showNotification('Creating Company', 'Company creation feature coming soon', 'success');
            closeAddCompanyModal();
            return false;
        }

        // Inicializaci√≥n - FALTABA ESTA
        document.addEventListener('DOMContentLoaded', function() {
            addActivity('success', 'Super Admin Panel Loaded', 'System ready for enterprise management');
            loadRealStats();
            loadCompaniesTable();
            updateActivityLog();
        });

        // Auto-refresh
        setInterval(() => {
            loadRealStats();
            loadCompaniesTable();
        }, 30000);

    </script>
</body>
</html>
