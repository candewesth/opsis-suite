<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ThreadSync - Seguimiento de Oportunidad | Opsis Suite</title>
  <style>
    :root {
      --verdi-dark: #022326;
      --verdi-mid: #034040;
      --verdi-accent: #035951;
      --verdi-light: #02735E;
      --primary-color: #02735E;
      --accent-color: #035951;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --bg-body: #fafafa;
      --bg-card: #ffffff;
      --border-color: #e2e8f0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: #f4f6f8;
      color: #1d2433;
      font-weight: 400;
      line-height: 1.6;
    }

    @keyframes aire {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .app-content {
      display: grid;
      grid-template-columns: 250px 1fr;
      flex: 1;
    }

    #sidebar {
      background: var(--bg-card);
      border-right: 1px solid var(--border-color);
      padding: 20px 0;
      overflow-y: auto;
    }

    .sidebar-item {
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 500;
    }

    .sidebar-item:hover {
      background: rgba(2, 115, 94, 0.05);
      color: var(--primary-color);
    }

    .sidebar-item.active {
      background: rgba(2, 115, 94, 0.08);
      color: var(--primary-color);
      border-left: 3px solid var(--primary-color);
      font-weight: 600;
    }

    .module-tab:hover {
      background: rgba(255,255,255,0.2) !important;
      color: rgba(255,255,255,1) !important;
    }

    .module-tab.active {
      background: rgba(255,255,255,0.15) !important;
      color: rgba(255,255,255,0.95) !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Header */
    .back-button:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 10px 18px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-white {
      background: rgba(255,255,255,0.15);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
    }

    .btn-white:hover {
      background: rgba(255,255,255,0.25);
      border: 1px solid rgba(255,255,255,0.4);
    }

    .btn-success {
      background: #10b981;
      color: white;
      border: 1px solid #10b981;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-color);
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }



    .meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .status-prospecto {
      background: #fef3c7;
      color: #92400e;
    }

    .status-cotizado {
      background: #dbeafe;
      color: #1e3a8a;
    }

    .status-negociacion {
      background: #fce7f3;
      color: #831843;
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 24px 60px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 28px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      border: 1px solid #e1e4e8;
      margin-bottom: 28px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 24px;
      color: #1d2433;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e1e4e8;
    }

    .info-grid {
      display: grid;
      gap: 16px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .info-label {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .info-value {
      font-size: 14px;
      font-weight: 600;
    }

    .timeline {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 8px;
    }

    .timeline-item {
      display: flex;
      gap: 16px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 6px;
      border-left: 3px solid #02735E;
      position: relative;
    }

    /* Hilo visual que conecta respuestas */
    .timeline-item.reply {
      margin-left: 56px;
    }

    .timeline-item.reply::before {
      content: '';
      position: absolute;
      left: -28px;
      top: -10px;
      width: 2px;
      height: calc(100% + 10px);
      background: #cbd5e1;
    }

    .timeline-item.reply::after {
      content: '';
      position: absolute;
      left: -28px;
      top: 30px;
      width: 20px;
      height: 2px;
      background: #cbd5e1;
      border-radius: 0 2px 2px 0;
    }

    .timeline-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      color: #1d2433;
    }

    .timeline-author {
      font-size: 12px;
      color: #02735E;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .comment-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 0;
    }

    .comment-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, #02735E, #035951);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      flex-shrink: 0;
    }

    .comment-meta {
      flex: 1;
    }

    .comment-author-name {
      font-weight: 600;
      font-size: 15px;
      color: #1d2433;
      margin-bottom: 2px;
    }

    .comment-author-role {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 8px;
    }

    .comment-body {
      margin-left: 0;
      padding: 0;
      background: transparent;
      border: none;
    }

    .comment-text {
      font-size: 14px;
      line-height: 1.6;
      color: #334155;
      margin-bottom: 8px;
    }

    .comment-timestamp {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 8px;
    }

    .announcement-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #fef3c7;
      color: #92400e;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    .timeline-date {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .timeline-text {
      font-size: 14px;
      line-height: 1.5;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-input,
    .form-textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Address Autocomplete */
    .address-wrapper {
      position: relative;
    }

    .address-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--primary-color);
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .address-suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.15s;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .address-suggestion-item:last-child {
      border-bottom: none;
    }

    .address-suggestion-item:hover {
      background-color: #f0f9f7;
    }

    .address-suggestion-item.active {
      background-color: #e6f7f4;
    }

    .address-icon {
      color: var(--primary-color);
      flex-shrink: 0;
      margin-top: 2px;
    }

    .address-suggestion-content {
      flex: 1;
    }

    .address-suggestion-main {
      font-size: 14px;
      color: #1d2433;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .address-suggestion-secondary {
      font-size: 12px;
      color: #64748b;
    }

    .address-loading {
      padding: 12px 16px;
      text-align: center;
      color: #64748b;
      font-size: 13px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal {
      background: white;
      border-radius: 16px;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      overflow: hidden;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(40px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      background: linear-gradient(135deg, #02735E 0%, #035951 100%);
      color: white;
      padding: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .modal-body {
      padding: 24px;
      max-height: calc(90vh - 200px);
      overflow-y: auto;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .form-select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .alert-box {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
    }

    .alert-icon {
      color: #f59e0b;
      flex-shrink: 0;
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .alert-text {
      font-size: 14px;
      color: var(--text-secondary);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    /* Nuevos estilos para funcionalidades */
    .btn-icon {
      background: transparent;
      border: none;
      padding: 6px;
      cursor: pointer;
      border-radius: 4px;
      color: #64748b;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #1d2433;
    }

    .reaction-btn {
      background: white;
      border: 1px solid #e1e4e8;
      border-radius: 16px;
      padding: 4px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      transition: all 0.2s;
    }

    .reaction-btn:hover {
      border-color: #02735E;
      background: #f0fdf4;
    }

    .reaction-btn.active {
      background: #d1fae5;
      border-color: #02735E;
    }

    .reaction-count {
      font-weight: 600;
      color: #64748b;
      font-size: 12px;
    }

    .add-reaction {
      background: transparent;
      border: 1px dashed #cbd5e1;
      color: #64748b;
    }

    .add-reaction:hover {
      border-color: #02735E;
      background: #f9fafb;
    }

    .reply-btn {
      background: transparent;
      border: none;
      color: #64748b;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 4px;
      transition: all 0.2s;
      margin-left: auto;
    }

    .reply-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #1d2433;
    }
  </style>
</head>
<body>

  <div class="app-shell">
    <header style="background: linear-gradient(135deg, #02735E 0%, #035951 50%, #034040 100%); background-size: 200% 200%; animation: aire 8s ease infinite; padding: 18px 32px; display: flex; align-items: center; gap: 32px; grid-column: 1 / -1; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid rgba(0, 0, 0, 0.1);">
      <div class="logo" aria-label="Opsis Suite">
        <div class="logo-text">
          <div class="logo-title" style="font-size: 26px; font-weight: 700; color: #ffffff; letter-spacing: -0.3px;">Opsis Suite</div>
          <div id="company-name-header" style="font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.85); margin-top: 2px;">CVE San Diego</div>
        </div>
      </div>
      
      <!-- Module Tabs -->
      <div class="module-tabs" style="display: flex; gap: 8px; margin-left: auto;">
        <a href="motorsync.html" class="module-tab active" style="padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; color: #02735E; background: white; text-decoration: none; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"></path>
            <path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"></path>
            <path d="M12 2v2"></path>
            <path d="M12 22v-2"></path>
          </svg>
          MotorSync
        </a>
        <a href="../timesync/timesync.html" class="module-tab" style="padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; color: rgba(255,255,255,0.7); background: transparent; text-decoration: none; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          TimeSync
        </a>
      </div>
    </header>

    <div class="app-content">
    <aside id="sidebar" style="background: var(--bg-card); border-right: 1px solid var(--border-color); padding: 20px 0; overflow-y: auto;">
      <div class="sidebar-item" data-page="dashboard" style="display: flex; align-items: center; gap: 12px; padding: 14px 24px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s;" onclick="window.location.href='motorsync.html'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <rect x="3" y="3" width="7" height="9"></rect>
          <rect x="14" y="3" width="7" height="5"></rect>
          <rect x="14" y="12" width="7" height="9"></rect>
          <rect x="3" y="16" width="7" height="5"></rect>
        </svg>
        <span>Dashboard</span>
      </div>
      
      <a href="projectsync.html" class="sidebar-item" style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit; padding: 14px 24px; transition: all 0.2s;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="9" y1="3" x2="9" y2="21"></line>
        </svg>
        <span>ProjectSync</span>
      </a>
      <a href="threadsync-list.html" class="sidebar-item active" style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: var(--primary-color); background: rgba(2, 115, 94, 0.08); padding: 14px 24px; transition: all 0.2s; border-left: 3px solid var(--primary-color);">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          <line x1="9" y1="10" x2="15" y2="10"></line>
          <line x1="12" y1="7" x2="12" y2="13"></line>
        </svg>
        <span>ThreadSync</span>
      </a>
      
      <div class="sidebar-item" data-page="customers" style="display: flex; align-items: center; gap: 12px; padding: 14px 24px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s;" onclick="window.location.href='motorsync.html'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M22 21v-2a4 4 0 0 0-3-3.87m-3-12.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        <span>Clientes</span>
      </div>
      <div class="sidebar-item" data-page="management" style="display: flex; align-items: center; gap: 12px; padding: 14px 24px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s;" onclick="window.location.href='motorsync.html'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <line x1="12" y1="1" x2="12" y2="23"></line>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
        <span>Management</span>
      </div>
      <div class="sidebar-item" data-page="toolsync" style="display: flex; align-items: center; gap: 12px; padding: 14px 24px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s;" onclick="window.location.href='motorsync.html'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2v-4M9 21H5a2 2 0 0 1-2-2v-4"></path>
          <path d="M3 12h18"></path>
        </svg>
        <span>ToolSync</span>
      </div>
      <div class="sidebar-item" data-page="settings" style="display: flex; align-items: center; gap: 12px; padding: 14px 24px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; margin-top: auto;" onclick="window.location.href='motorsync.html'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="min-width: 20px;">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3m15.4-6.4l-4.2 4.2m-7.1 0L2.6 5.6m18.8 12.8l-4.2-4.2m-7.1 0l-4.5 4.5"></path>
        </svg>
        <span>Configuraci√≥n</span>
      </div>
    </aside>

    <main id="main" style="padding: 0;">
      <div class="thread-header" style="background: #02735E; color: white; padding: 20px 32px; border-bottom: 1px solid rgba(0, 0, 0, 0.1);">
        <div class="header-top" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 16px;">
            <button class="back-button" onclick="window.location.href='threadsync-list.html'" style="background: transparent; color: rgba(255,255,255,0.9); border: none; padding: 8px 12px; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              ‚Üê Volver a ThreadSync
            </button>
          </div>
          
          <div class="header-actions" style="display: flex; gap: 12px;">
            <button class="btn btn-white" onclick="editThread()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
              Editar
            </button>
            <!-- Bot√≥n cuando NO est√° convertido -->
            <div id="notConvertedSection">
              <button class="btn btn-success" onclick="convertToProject()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                  <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                Convertir a Proyecto
              </button>
            </div>
            <!-- Bot√≥n cuando YA est√° convertido -->
            <div id="convertedSection" style="display: none;">
              <button class="btn btn-primary" onclick="goToProject()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                  <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                Ir al Proyecto
              </button>
            </div>
          </div>
        </div>

        <div class="thread-info" style="margin-top: 16px; text-align: center;">
          <h1 class="thread-title" id="threadTitle" style="font-size: 28px; font-weight: 700; margin-bottom: 8px;"></h1>
          <p class="thread-address" id="threadAddress" style="display: none; font-size: 14px; color: rgba(255, 255, 255, 0.8); margin-bottom: 12px;"></p>
          <div class="thread-meta" id="threadMeta" style="display: flex; gap: 24px; flex-wrap: wrap; justify-content: center; font-size: 14px; opacity: 0.95;"></div>
        </div>
      </div>

      <div class="container">
        <div>
      <div class="card">
          <div class="timeline">
            <!-- Comentario 1 -->
            <div class="timeline-item" style="background: #f9fafb; border-left: none; border: 1px solid #e1e4e8; padding: 20px; margin-bottom: 16px; border-radius: 8px;">
              <div class="comment-header">
                <div class="comment-avatar">RR</div>
                <div class="comment-meta">
                  <div class="comment-author-name">Rodolfo Real</div>
                  <div class="comment-author-role" style="display: flex; flex-direction: column; gap: 2px;">
                    <span>Estimator/PM</span>
                    <span>Nov 17, 2024 10:30 AM</span>
                    <span>Notific√≥ a 8 personas</span>
                  </div>
                </div>
              </div>
              <div class="comment-body">
                <div class="comment-text thread-description" style="background: white; border: 1px solid #e1e4e8; border-radius: 6px; padding: 16px; margin-top: 12px;">
                  El cliente mencion√≥ que tiene presupuesto aprobado pero quiere ver opciones de financiamiento a 12 meses. Revisar con finanzas.
                </div>
                <div style="display: flex; gap: 12px; margin-top: 12px; align-items: center; justify-content: space-between;">
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="reaction-btn" onclick="toggleReaction(1, 'üëç')">
                      <span>üëç</span>
                      <span class="reaction-count">3</span>
                    </button>
                    <button class="reaction-btn" onclick="toggleReaction(1, 'üéØ')">
                      <span>üéØ</span>
                      <span class="reaction-count">1</span>
                    </button>
                    <button class="reaction-btn add-reaction" onclick="showReactionPicker(1)">
                      <span>‚ûï üòä</span>
                    </button>
                  </div>
                  <button class="reply-btn" onclick="replyToComment(1)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="9 14 4 9 9 4"/>
                      <path d="M20 20v-7a4 4 0 0 0-4-4H4"/>
                    </svg>
                    Responder
                  </button>
                </div>
              </div>
            </div>

            <!-- Comentario 2 -->
            <div class="timeline-item" style="background: #f9fafb; border-left: none; border: 1px solid #e1e4e8; padding: 20px; margin-bottom: 16px; border-radius: 8px;">
              <div class="comment-header">
                <div class="comment-avatar" style="background: linear-gradient(135deg, #f59e0b, #d97706);">MC</div>
                <div class="comment-meta">
                  <div class="comment-author-name">Matias Carrillo</div>
                  <div class="comment-author-role" style="display: flex; flex-direction: column; gap: 2px;">
                    <span>Operations Coordinator</span>
                    <span>Nov 16, 2024 2:15 PM</span>
                    <span>Notific√≥ a 5 personas</span>
                  </div>
                </div>
              </div>
              <div class="comment-body">
                <div class="comment-text" style="background: white; border: 1px solid #e1e4e8; border-radius: 6px; padding: 16px; margin-top: 12px;">
                  Contacto muy profesional. Ing. Mendoza tiene experiencia previa con proyectos HVAC. Esto facilita la comunicaci√≥n t√©cnica.
                </div>
                <div style="display: flex; gap: 12px; margin-top: 12px; align-items: center; justify-content: space-between;">
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="reaction-btn" onclick="toggleReaction(2, 'üëç')">
                      <span>üëç</span>
                      <span class="reaction-count">5</span>
                    </button>
                    <button class="reaction-btn" onclick="toggleReaction(2, 'üí°')">
                      <span>üí°</span>
                      <span class="reaction-count">2</span>
                    </button>
                    <button class="reaction-btn add-reaction" onclick="showReactionPicker(2)">
                      <span>‚ûï üòä</span>
                    </button>
                  </div>
                  <button class="reply-btn" onclick="replyToComment(2)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="9 14 4 9 9 4"/>
                      <path d="M20 20v-7a4 4 0 0 0-4-4H4"/>
                    </svg>
                    Responder
                  </button>
                </div>
              </div>
            </div>
              
            <!-- Respuesta anidada - estilo Facebook con hilo visual -->
            <div class="timeline-item reply" style="background: #f9fafb; border-left: none; border: 1px solid #e1e4e8; padding: 20px; margin-bottom: 16px; border-radius: 8px;">
              <div class="comment-header">
                <div class="comment-avatar" style="width: 36px; height: 36px; font-size: 13px;">RR</div>
                <div class="comment-meta">
                  <div class="comment-author-name" style="font-size: 14px;">Rodolfo Real</div>
                  <div class="comment-author-role" style="font-size: 12px; display: flex; flex-direction: column; gap: 2px;">
                    <span>Estimator/PM</span>
                    <span>Nov 16, 2024 3:20 PM</span>
                    <span>Notific√≥ a 2 personas</span>
                  </div>
                </div>
              </div>
              <div class="comment-body">
                <div class="comment-text" style="background: white; border: 1px solid #e1e4e8; border-radius: 6px; padding: 16px; margin-top: 12px; font-size: 14px;">
                  Exacto, <span style="color: #02735E; font-weight: 600;">@Matias</span> ya coordin√≥ una llamada t√©cnica para ma√±ana con el Ing. Mendoza.
                </div>
                <div style="display: flex; gap: 12px; margin-top: 12px; align-items: center; justify-content: space-between;">
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="reaction-btn" onclick="toggleReaction(3, 'üìã')">
                      <span>üìã</span>
                      <span class="reaction-count">4</span>
                    </button>
                    <button class="reaction-btn add-reaction" onclick="showReactionPicker(3)">
                      <span>‚ûï üòä</span>
                    </button>
                  </div>
                  <button class="reply-btn" onclick="replyToComment(3)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="9 14 4 9 9 4"/>
                      <path d="M20 20v-7a4 4 0 0 0-4-4H4"/>
                    </svg>
                    Responder
                  </button>
                </div>
              </div>
            </div>

            <!-- Comentario 3 -->
            <div class="timeline-item" style="background: #f9fafb; border-left: none; border: 1px solid #e1e4e8; padding: 20px; margin-bottom: 16px; border-radius: 8px;">
              <div class="comment-header">
                <div class="comment-avatar">RR</div>
                <div class="comment-meta">
                  <div class="comment-author-name">Rodolfo Real</div>
                  <div class="comment-author-role" style="display: flex; flex-direction: column; gap: 2px;">
                    <span>Estimator/PM</span>
                    <span>Nov 15, 2024 9:45 AM</span>
                    <span>Notific√≥ a 3 personas</span>
                  </div>
                </div>
              </div>
              <div class="comment-body">
                <div class="comment-text" style="background: white; border: 1px solid #e1e4e8; border-radius: 6px; padding: 16px; margin-top: 12px;">
                  Edificio en buenas condiciones. Acceso f√°cil para equipos. Cliente muy organizado, tienen planos actualizados.
                </div>
                
                <!-- Archivo adjunto -->
                <div style="margin-top: 12px; padding: 12px; background: white; border: 1px solid #e1e4e8; border-radius: 6px; display: inline-flex; align-items: center; gap: 10px;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#02735E" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                  </svg>
                  <div>
                    <div style="font-size: 13px; font-weight: 600; color: #1d2433;">Planos_Edificio.pdf</div>
                    <div style="font-size: 12px; color: #64748b;">2.4 MB</div>
                  </div>
                  <button class="btn-icon" style="margin-left: 8px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/>
                      <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                  </button>
                </div>
                
                <!-- Reacciones y Responder en l√≠nea -->
                <div style="display: flex; gap: 12px; margin-top: 12px; align-items: center; justify-content: space-between;">
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="reaction-btn" onclick="toggleReaction(3, 'üìã')">
                      <span>üìã</span>
                      <span class="reaction-count">4</span>
                    </button>
                    <button class="reaction-btn add-reaction" onclick="showReactionPicker(3)">
                      <span>‚ûï üòä</span>
                    </button>
                  </div>
                  
                  <button class="reply-btn" onclick="replyToComment(3)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="9 14 4 9 9 4"/>
                      <path d="M20 20v-7a4 4 0 0 0-4-4H4"/>
                    </svg>
                    Responder
                  </button>
                </div>
              </div>
            </div>
          </div>

          <button class="btn btn-primary" style="margin-top: 24px; width: 100%;" onclick="addComment()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Agregar Comentario
          </button>
        </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    function detectCurrentUser() {
      // Intentar obtener del objeto global de sesi√≥n
      if (window.opsisCurrentUser?.displayName) {
        return window.opsisCurrentUser.displayName;
      }

      if (window.opsisCurrentUser?.name) {
        return window.opsisCurrentUser.name;
      }

      // Intentar obtener de localStorage
      try {
        const stored = localStorage.getItem('opsisCurrentUser');
        if (stored) {
          const parsed = JSON.parse(stored);
          if (parsed?.displayName) return parsed.displayName;
          if (parsed?.fullName) return parsed.fullName;
          if (parsed?.name) return parsed.name;
        }
      } catch (error) {
        console.warn('No se pudo leer el usuario de localStorage', error);
      }

      // Intentar obtener de sessionStorage
      try {
        const sessionUser = sessionStorage.getItem('currentUser');
        if (sessionUser) {
          const parsed = JSON.parse(sessionUser);
          if (parsed?.displayName) return parsed.displayName;
          if (parsed?.fullName) return parsed.fullName;
          if (parsed?.name) return parsed.name;
        }
      } catch (error) {
        console.warn('No se pudo leer el usuario de sessionStorage', error);
      }

      // Intentar obtener del token JWT si existe
      try {
        const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        if (token) {
          const payload = JSON.parse(atob(token.split('.')[1]));
          if (payload?.name) return payload.name;
          if (payload?.displayName) return payload.displayName;
          if (payload?.email) return payload.email.split('@')[0];
        }
      } catch (error) {
        // Token inv√°lido o no existe
      }

      // Por defecto usar el nombre gen√©rico
      return 'Usuario Actual';
    }

    function getCurrentDateISO() {
      return new Date().toISOString().split('T')[0];
    }

    function getCurrentTimeHHMM() {
      const now = new Date();
      return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    }

    // Base de datos simulada de threads
    const threadsDatabase = {
      'thread-1': {
        title: 'üìã Cambios en especificaciones t√©cnicas',
        address: 'Instalaci√≥n HVAC Completo - Proyecto #1024',
        description: 'El cliente solicita modificar el tipo de refrigerante de R-410A a R-32 para cumplir nuevas normativas ambientales',
        createdBy: 'Juan P√©rez',
        createdDate: '2025-11-20',
        createdTime: '14:30',
        project: 'Instalaci√≥n HVAC Completo',
        projectId: 'project-1',
        status: 'unread',
        comments: 15,
        files: 3
      },
      'thread-2': {
        title: 'üîß Coordinaci√≥n de instalaci√≥n',
        address: 'Instalaci√≥n HVAC Completo - Proyecto #1024',
        description: 'Confirmar acceso al sitio el martes 21 nov a las 8:00 AM. Coordinaci√≥n con seguridad del edificio',
        createdBy: 'Mar√≠a Garc√≠a',
        createdDate: '2025-11-19',
        createdTime: '10:15',
        project: 'Instalaci√≥n HVAC Completo',
        projectId: 'project-1',
        status: 'read',
        comments: 8,
        files: 1
      },
      'thread-3': {
        title: 'üì∏ Fotos del progreso - Semana 1',
        address: 'Instalaci√≥n HVAC Completo - Proyecto #1024',
        description: 'Documentaci√≥n fotogr√°fica del avance de obra hasta el viernes. Todo seg√∫n cronograma',
        createdBy: 'Carlos L√≥pez',
        createdDate: '2025-11-17',
        createdTime: '16:45',
        project: 'Instalaci√≥n HVAC Completo',
        projectId: 'project-1',
        status: 'read',
        comments: 12,
        files: 24
      },
      'thread-4': {
        title: '‚ö° Inspecci√≥n de seguridad el√©ctrica',
        address: 'Reparaci√≥n Sistema El√©ctrico - Proyecto #1025',
        description: 'Resultados de la inspecci√≥n inicial y recomendaciones de actualizaci√≥n del sistema',
        createdBy: 'Ana Mart√≠nez',
        createdDate: '2025-11-20',
        createdTime: '11:00',
        project: 'Reparaci√≥n Sistema El√©ctrico',
        projectId: 'project-2',
        status: 'unread',
        comments: 6,
        files: 2
      }
    };

    const threadState = {
      title: 'Instalaci√≥n HVAC - Edificio Corporativo Guadalajara',
      address: 'Av. Empresarial 345, Guadalajara, Jal.',
      createdBy: '',
      createdDate: '',
      createdTime: '',
      isConverted: false,
      projectId: null
    };

    function hydrateThreadDefaults() {
      // Detectar si hay un ID de thread en la URL
      const urlParams = new URLSearchParams(window.location.search);
      const threadId = urlParams.get('id');
      
      // Si hay un ID, cargar datos del thread desde la base de datos
      if (threadId && threadsDatabase[threadId]) {
        const threadData = threadsDatabase[threadId];
        threadState.title = threadData.title;
        threadState.address = threadData.address;
        threadState.createdBy = threadData.createdBy;
        threadState.createdDate = threadData.createdDate;
        threadState.createdTime = threadData.createdTime;
        threadState.projectId = threadData.projectId;
        
        // Agregar descripci√≥n al primer comentario si existe
        const descriptionElement = document.querySelector('.thread-description');
        if (descriptionElement && threadData.description) {
          descriptionElement.textContent = threadData.description;
        }
      } else {
        // Valores por defecto si no hay ID
        if (!threadState.createdBy) {
          threadState.createdBy = detectCurrentUser();
        }

        if (!threadState.createdDate) {
          threadState.createdDate = getCurrentDateISO();
        }

        if (!threadState.createdTime) {
          threadState.createdTime = getCurrentTimeHHMM();
        }
      }
    }

    function formatDateForDisplay(isoDate) {
      if (!isoDate) return '';
      const date = new Date(`${isoDate}T00:00:00`);
      if (Number.isNaN(date.getTime())) {
        return isoDate;
      }
      const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
      return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
    }

    function formatTimeForDisplay(time24h) {
      if (!time24h) return '';
      const [rawHours, rawMinutes] = time24h.split(':');
      if (rawHours === undefined || rawMinutes === undefined) {
        return time24h;
      }
      const hours = parseInt(rawHours, 10);
      if (Number.isNaN(hours)) {
        return time24h;
      }
      const minutes = rawMinutes.padStart(2, '0');
      const suffix = hours >= 12 ? 'PM' : 'AM';
      const normalizedHour = ((hours + 11) % 12) + 1;
      return `${String(normalizedHour).padStart(2, '0')}:${minutes} ${suffix}`;
    }

    function escapeAttribute(value = '') {
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function renderThreadHeader() {
      hydrateThreadDefaults();

      const titleElement = document.getElementById('threadTitle');
      if (titleElement) {
        titleElement.textContent = threadState.title;
      }

      const addressElement = document.getElementById('threadAddress');
      if (addressElement) {
        if (threadState.address) {
          addressElement.textContent = threadState.address;
          addressElement.style.display = 'block';
        } else {
          addressElement.textContent = '';
          addressElement.style.display = 'none';
        }
      }

      const metaElement = document.getElementById('threadMeta');
      if (metaElement) {
        const createdDate = formatDateForDisplay(threadState.createdDate);
        const createdTime = formatTimeForDisplay(threadState.createdTime);
        metaElement.innerHTML = `
          <div class="meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <span>Creado: ${createdDate}${createdTime ? ` ¬∑ ${createdTime}` : ''}</span>
          </div>
          <div class="meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            <span>Creado por: ${threadState.createdBy}</span>
          </div>
        `;
      }
    }

    // Funci√≥n para editar thread
    function editThread() {
      hydrateThreadDefaults();

      const existingModal = document.getElementById('editThreadModal');
      if (existingModal) {
        existingModal.remove();
      }

      const modalHTML = `
        <div class="modal-overlay" id="editThreadModal" onclick="if(event.target === this) closeModal('editThreadModal')">
          <div class="modal">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Editar ThreadSync
              </div>
              <button class="modal-close" onclick="closeModal('editThreadModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label" for="editThreadTitle">T√≠tulo *</label>
                <input type="text" id="editThreadTitle" class="form-input" value="${escapeAttribute(threadState.title)}" placeholder="Nombre del proyecto" />
              </div>
              <div class="form-group">
                <label class="form-label" for="editThreadAddress">Direcci√≥n (opcional)</label>
                <div class="address-wrapper">
                  <input 
                    type="text" 
                    id="editThreadAddress" 
                    class="form-input" 
                    value="${escapeAttribute(threadState.address)}" 
                    placeholder="Escribe para buscar direcci√≥n..."
                    autocomplete="off"
                  />
                  <div id="addressSuggestions" class="address-suggestions" style="display: none;"></div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('editThreadModal')">Cancelar</button>
              <button class="btn btn-primary" onclick="saveThreadDetails()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                Guardar Cambios
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHTML);

      requestAnimationFrame(() => {
        const titleField = document.getElementById('editThreadTitle');
        if (titleField) {
          titleField.focus();
        }
        initAddressAutocomplete();
      });
    }

    // Inicializar autocomplete de direcciones con Nominatim (OpenStreetMap - Gratuito)
    function initAddressAutocomplete() {
      const addressInput = document.getElementById('editThreadAddress');
      const suggestionsContainer = document.getElementById('addressSuggestions');
      
      if (!addressInput || !suggestionsContainer) return;

      let debounceTimer = null;
      let selectedIndex = -1;
      let currentController = null;

      addressInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        clearTimeout(debounceTimer);
        
        // Cancelar petici√≥n anterior si existe
        if (currentController) {
          currentController.abort();
        }
        
        if (query.length < 3) {
          suggestionsContainer.style.display = 'none';
          return;
        }

        suggestionsContainer.innerHTML = '<div class="address-loading">Buscando direcciones...</div>';
        suggestionsContainer.style.display = 'block';

        debounceTimer = setTimeout(async () => {
          try {
            currentController = new AbortController();
            
            // Nominatim API de OpenStreetMap (100% gratuito)
            const url = `https://nominatim.openstreetmap.org/search?` + new URLSearchParams({
              q: query,
              countrycodes: 'mx',
              format: 'json',
              addressdetails: '1',
              limit: '8'
            });

            const response = await fetch(url, {
              signal: currentController.signal,
              headers: {
                'Accept': 'application/json',
                'User-Agent': 'OpsisSuite/1.0'
              }
            });

            if (!response.ok) throw new Error('Error en la b√∫squeda');

            const results = await response.json();
            
            if (results.length === 0) {
              suggestionsContainer.innerHTML = '<div class="address-loading">No se encontraron direcciones</div>';
              return;
            }

            renderSuggestions(results);
          } catch (error) {
            if (error.name === 'AbortError') return;
            suggestionsContainer.innerHTML = '<div class="address-loading">Error al buscar direcciones</div>';
          }
        }, 400);
      });

      function renderSuggestions(results) {
        selectedIndex = -1;
        suggestionsContainer.innerHTML = '';
        
        results.forEach((result, index) => {
          const item = document.createElement('div');
          item.className = 'address-suggestion-item';
          item.dataset.index = index;
          
          // Construir direcci√≥n legible
          const address = result.address || {};
          const mainText = result.display_name.split(',')[0];
          const secondaryParts = [];
          
          if (address.city || address.town || address.village) {
            secondaryParts.push(address.city || address.town || address.village);
          }
          if (address.state) {
            secondaryParts.push(address.state);
          }
          
          const secondaryText = secondaryParts.join(', ');
          
          item.innerHTML = `
            <svg class="address-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
            <div class="address-suggestion-content">
              <div class="address-suggestion-main">${mainText}</div>
              ${secondaryText ? `<div class="address-suggestion-secondary">${secondaryText}</div>` : ''}
            </div>
          `;
          
          item.addEventListener('click', () => selectAddress(result));
          suggestionsContainer.appendChild(item);
        });
        
        suggestionsContainer.style.display = 'block';
      }

      function selectAddress(result) {
        addressInput.value = result.display_name;
        suggestionsContainer.style.display = 'none';
      }

      // Navegaci√≥n con teclado
      addressInput.addEventListener('keydown', function(e) {
        const items = suggestionsContainer.querySelectorAll('.address-suggestion-item');
        
        if (items.length === 0) return;

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
          updateSelectedItem(items);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateSelectedItem(items);
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
          e.preventDefault();
          items[selectedIndex].click();
        } else if (e.key === 'Escape') {
          suggestionsContainer.style.display = 'none';
        }
      });

      function updateSelectedItem(items) {
        items.forEach((item, index) => {
          if (index === selectedIndex) {
            item.classList.add('active');
            item.scrollIntoView({ block: 'nearest' });
          } else {
            item.classList.remove('active');
          }
        });
      }

      // Cerrar sugerencias al hacer click fuera
      document.addEventListener('click', function(e) {
        if (!addressInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
          suggestionsContainer.style.display = 'none';
        }
      });
    }

    function saveThreadDetails() {
      const titleField = document.getElementById('editThreadTitle');
      const addressField = document.getElementById('editThreadAddress');

      const newTitle = titleField?.value.trim() || '';
      const newAddress = addressField?.value.trim() || '';

      if (!newTitle) {
        alert('‚ö†Ô∏è El t√≠tulo es obligatorio.');
        return;
      }

      threadState.title = newTitle;
      threadState.address = newAddress;

      hydrateThreadDefaults();
      renderThreadHeader();
      closeModal('editThreadModal');
      alert('‚úì Informaci√≥n de ThreadSync actualizada');
    }

    // Funci√≥n para agregar actualizaci√≥n
    function addComment() {
      const modalHTML = `
        <div class="modal-overlay" id="addCommentModal" onclick="if(event.target === this) closeModal('addCommentModal')">
          <div class="modal">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Agregar Comentario
              </div>
              <button class="modal-close" onclick="closeModal('addCommentModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Comentario o Nota *</label>
                <textarea id="commentText" class="form-textarea" placeholder="Escribe tu comentario o nota sobre esta oportunidad..." style="min-height: 150px;"></textarea>
              </div>

              <div class="form-group">
                <label class="form-label">Adjuntar Archivos (opcional)</label>
                <input type="file" id="commentFiles" class="form-input" multiple style="padding: 8px; font-size: 13px;" />
                <small style="color: var(--text-secondary); font-size: 12px;">üìé Puedes adjuntar fotos, documentos, etc.</small>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('addCommentModal')">Cancelar</button>
              <button class="btn btn-primary" onclick="saveComment()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Publicar Comentario
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function saveComment() {
      const commentText = document.getElementById('commentText').value.trim();
      
      if (!commentText) {
        alert('‚ö†Ô∏è Por favor escribe un comentario');
        return;
      }

      // Obtener archivos adjuntos
      const filesInput = document.getElementById('commentFiles');
      let attachmentsHTML = '';
      
      if (filesInput.files.length > 0) {
        attachmentsHTML = '<div style="margin-top: 12px; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 12px; color: #475569;">';
        attachmentsHTML += 'üìé ';
        for (let i = 0; i < filesInput.files.length; i++) {
          attachmentsHTML += filesInput.files[i].name;
          if (i < filesInput.files.length - 1) attachmentsHTML += ', ';
        }
        attachmentsHTML += '</div>';
      }

      // Obtener fecha/hora actual
      const now = new Date();
      const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
      const monthName = months[now.getMonth()];
      const day = now.getDate();

      // Crear nuevo comentario estilo Basecamp
      const newComment = `
        <div class="timeline-item" style="background: #f9fafb; border-left: none; padding: 20px;">
          <div class="comment-header">
            <div class="comment-avatar" style="background: linear-gradient(135deg, #6366f1, #4f46e5);">UA</div>
            <div class="comment-meta">
              <div class="comment-author-name">Usuario Actual</div>
              <div class="comment-author-role">¬∑ ${monthName} ${day} ¬∑ Ahora mismo</div>
            </div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              ${commentText}
            </div>
            ${attachmentsHTML}
          </div>
        </div>
      `;

      // Insertar al inicio del timeline
      const timeline = document.querySelector('.timeline');
      timeline.insertAdjacentHTML('afterbegin', newComment);

      closeModal('addCommentModal');
      alert('‚úì Comentario agregado exitosamente');
    }

    function saveUpdate() {
      const title = document.getElementById('updateTitle').value.trim();
      const description = document.getElementById('updateDescription').value.trim();
      const type = document.getElementById('updateType').value;
      const photosInput = document.getElementById('updatePhotos');
      const docsInput = document.getElementById('updateDocuments');

      if (!title || !description) {
        alert('‚ö†Ô∏è Por favor completa los campos obligatorios (*)');
        return;
      }

      // Obtener fecha y hora actual del sistema
      const now = new Date();
      const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
      const day = now.getDate();
      const month = months[now.getMonth()];
      const year = now.getFullYear();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const formattedDate = `${day} ${month} ${year} - ${hours}:${minutes}`;

      // Procesar archivos adjuntos
      let attachmentsHTML = '';
      const photoFiles = photosInput.files;
      const docFiles = docsInput.files;
      
      if (photoFiles.length > 0 || docFiles.length > 0) {
        attachmentsHTML = '<div style="margin-top: 12px; padding: 10px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #3b82f6;">';
        attachmentsHTML += '<div style="font-size: 12px; font-weight: 600; color: #1e40af; margin-bottom: 6px;">üìé Archivos adjuntos:</div>';
        
        if (photoFiles.length > 0) {
          attachmentsHTML += '<div style="font-size: 12px; color: #475569; margin-bottom: 4px;">üì∑ ' + photoFiles.length + ' foto(s): ';
          for (let i = 0; i < photoFiles.length; i++) {
            attachmentsHTML += photoFiles[i].name;
            if (i < photoFiles.length - 1) attachmentsHTML += ', ';
          }
          attachmentsHTML += '</div>';
        }
        
        if (docFiles.length > 0) {
          attachmentsHTML += '<div style="font-size: 12px; color: #475569;">üìÑ ' + docFiles.length + ' documento(s): ';
          for (let i = 0; i < docFiles.length; i++) {
            attachmentsHTML += docFiles[i].name;
            if (i < docFiles.length - 1) attachmentsHTML += ', ';
          }
          attachmentsHTML += '</div>';
        }
        
        attachmentsHTML += '</div>';
      }

      // Iconos seg√∫n tipo
      const icons = {
        call: '<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>',
        meeting: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
        visit: '<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>',
        email: '<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>',
        quote: '<polyline points="20 6 9 17 4 12"/>',
        proposal: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>',
        correction: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>',
        comment: '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>',
        negotiation: '<circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>',
        followup: '<path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"/>',
        presentation: '<rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>',
        contract: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>',
        payment: '<rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/>',
        other: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>'
      };

      const newTimelineItem = `
        <div class="timeline-item" style="animation: slideUp 0.3s ease-out;">
          <div class="timeline-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              ${icons[type]}
            </svg>
          </div>
          <div class="timeline-content">
            <div class="timeline-title">${title}</div>
            <div class="timeline-date">${formattedDate}</div>
            <div class="timeline-text">${description}</div>
            ${attachmentsHTML}
          </div>
        </div>
      `;

      // Insertar al inicio del timeline
      const timeline = document.querySelector('.timeline');
      timeline.insertAdjacentHTML('afterbegin', newTimelineItem);

      closeModal('addUpdateModal');
      alert('‚úì Actualizaci√≥n agregada exitosamente');
    }

    // Funci√≥n principal para convertir Thread a Proyecto
    function convertToProject() {
      const modalHTML = `
        <div class="modal-overlay" id="convertModal" onclick="if(event.target === this) closeModal('convertModal')">
          <div class="modal">
            <div class="modal-header">
              <div class="modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                  <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                Convertir a Proyecto Confirmado
              </div>
              <button class="modal-close" onclick="closeModal('convertModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div class="alert-box">
                <div class="alert-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                  </svg>
                </div>
                <div class="alert-content">
                  <div class="alert-title">Convertir ThreadSync a Proyecto</div>
                  <div class="alert-text">La informaci√≥n existente se copiar√° autom√°ticamente. Completa los datos faltantes para programar el proyecto.</div>
                </div>
              </div>

              <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-secondary);">
                üìã Informaci√≥n Existente (ThreadSync)
              </h4>

              <div class="form-group">
                <label class="form-label">Nombre del Proyecto</label>
                <input type="text" class="form-input" value="Instalaci√≥n HVAC - Edificio Corporativo Guadalajara" />
              </div>

              <div class="form-group">
                <label class="form-label">Cliente</label>
                <input type="text" class="form-input" value="Corporativo Azteca S.A." />
              </div>

              <div class="form-group">
                <label class="form-label">Contacto Principal</label>
                <input type="text" class="form-input" value="Ing. Roberto Mendoza" />
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                  <label class="form-label">Tel√©fono</label>
                  <input type="tel" class="form-input" value="+52 33 1234 5678" />
                </div>
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-input" value="rmendoza@azteca.com" />
                </div>
              </div>

              <h4 style="font-size: 16px; font-weight: 600; margin: 24px 0 16px; color: var(--primary-color);">
                ‚úèÔ∏è Completar para Programaci√≥n
              </h4>

              <div class="form-group">
                <label class="form-label">Direcci√≥n del Proyecto *</label>
                <input type="text" class="form-input" placeholder="Av. Universidad #789, Guadalajara" />
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                  <label class="form-label">Fecha de Inicio *</label>
                  <input type="date" class="form-input" />
                </div>
                <div class="form-group">
                  <label class="form-label">Fecha de Fin *</label>
                  <input type="date" class="form-input" />
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Cuadrilla Asignada *</label>
                <select id="crewSelect" class="form-select">
                  <option value="">Cargando cuadrillas...</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">Presupuesto Confirmado *</label>
                <input type="text" class="form-input" value="$45,000 USD" />
              </div>

              <div class="form-group">
                <label class="form-label">Notas del Proyecto</label>
                <textarea class="form-textarea" placeholder="Detalles adicionales del proyecto...">Cliente requiere instalaci√≥n antes de fin de a√±o. Edificio corporativo de 3 pisos.</textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('convertModal')">Cancelar</button>
              <button class="btn btn-success" onclick="confirmConversion()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                Crear Proyecto
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Cargar cuadrillas din√°micamente despu√©s de insertar el modal
      loadCrewsForProject();
    }

    // Funci√≥n para cargar cuadrillas disponibles
    async function loadCrewsForProject() {
      const crewSelect = document.getElementById('crewSelect');
      if (!crewSelect) return;
      
      try {
        // En producci√≥n, esto vendr√≠a de la API/base de datos
        // const response = await fetch('/api/crews/available');
        // const crews = await response.json();
        
        // SIMULACI√ìN: Datos de cuadrillas
        const crews = [
          { id: 'crew_001', name: 'Cuadrilla A', leader: 'Juan P√©rez', available: true },
          { id: 'crew_002', name: 'Cuadrilla B', leader: 'Luis Garc√≠a', available: true },
          { id: 'crew_003', name: 'Cuadrilla C', leader: 'Ana Mart√≠nez', available: false },
          { id: 'crew_004', name: 'Cuadrilla D', leader: 'Carlos Ruiz', available: true }
        ];
        
        // Limpiar y llenar el select
        crewSelect.innerHTML = '<option value="">Seleccionar cuadrilla...</option>';
        
        crews.forEach(crew => {
          const option = document.createElement('option');
          option.value = crew.id;
          option.textContent = `${crew.name} - ${crew.leader}${!crew.available ? ' (No disponible)' : ''}`;
          option.disabled = !crew.available;
          crewSelect.appendChild(option);
        });
        
      } catch (error) {
        console.error('Error al cargar cuadrillas:', error);
        crewSelect.innerHTML = '<option value="">Error al cargar cuadrillas</option>';
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.animation = 'fadeOut 0.2s ease-out';
        setTimeout(() => modal.remove(), 200);
      }
    }

    function goToProject() {
      // Redirigir al proyecto creado
      if (threadState.projectId) {
        // En producci√≥n, esto navegar√≠a al proyecto real
        window.location.href = `projects.html?id=${threadState.projectId}`;
      } else {
        alert('‚ö†Ô∏è No se encontr√≥ el proyecto asociado');
      }
    }

    function confirmConversion() {
      // Cerrar el modal
      closeModal('convertModal');
      
      // Marcar como convertido y guardar ID de proyecto
      threadState.isConverted = true;
      threadState.projectId = 'PROJ-' + Date.now(); // Simulaci√≥n de ID
      
      // Guardar estado en localStorage para persistencia
      localStorage.setItem('threadState_current', JSON.stringify({
        isConverted: threadState.isConverted,
        projectId: threadState.projectId
      }));
      
      // Ocultar bot√≥n de conversi√≥n y mostrar bot√≥n "Ir al Proyecto"
      document.getElementById('notConvertedSection').style.display = 'none';
      document.getElementById('convertedSection').style.display = 'block';
      
      // Mostrar mensaje de √©xito
      const successMessage = document.createElement('div');
      successMessage.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 20px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
        z-index: 10000;
        font-weight: 600;
        max-width: 400px;
        animation: slideIn 0.3s ease-out;
      `;
      successMessage.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 12px;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          <div>
            <div style="font-size: 16px; margin-bottom: 4px;">‚úì Proyecto Creado</div>
            <div style="font-size: 13px; opacity: 0.9;">ThreadSync convertido a proyecto confirmado</div>
          </div>
        </div>
      `;
      document.body.appendChild(successMessage);
      
      // Remover mensaje despu√©s de 3 segundos
      setTimeout(() => {
        successMessage.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => successMessage.remove(), 300);
      }, 3000);
    }

    // Funciones para reacciones
    function toggleReaction(commentId, emoji) {
      event.target.closest('.reaction-btn').classList.toggle('active');
      console.log(`Toggled ${emoji} on comment ${commentId}`);
    }

    function showReactionPicker(commentId) {
      const emojis = ['üëç', '‚ù§Ô∏è', 'üòä', 'üéØ', 'üí°', 'üî•', 'üëè', '‚úÖ'];
      const picker = document.createElement('div');
      picker.style.cssText = `
        position: fixed;
        background: white;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        gap: 8px;
        z-index: 1000;
      `;
      
      emojis.forEach(emoji => {
        const btn = document.createElement('button');
        btn.textContent = emoji;
        btn.style.cssText = `
          background: transparent;
          border: none;
          font-size: 24px;
          cursor: pointer;
          padding: 8px;
          border-radius: 6px;
          transition: all 0.2s;
        `;
        btn.onmouseover = () => btn.style.background = '#f3f4f6';
        btn.onmouseout = () => btn.style.background = 'transparent';
        btn.onclick = () => {
          toggleReaction(commentId, emoji);
          picker.remove();
        };
        picker.appendChild(btn);
      });
      
      const rect = event.target.getBoundingClientRect();
      picker.style.left = rect.left + 'px';
      picker.style.top = (rect.top - 60) + 'px';
      
      document.body.appendChild(picker);
      
      setTimeout(() => {
        document.addEventListener('click', function removePicker() {
          picker.remove();
          document.removeEventListener('click', removePicker);
        });
      }, 100);
    }

    // Funci√≥n para responder a comentario
    function replyToComment(commentId) {
      const replyHTML = `
        <div class="modal-overlay" id="replyModal" onclick="if(event.target === this) closeModal('replyModal')">
          <div class="modal">
            <div class="modal-header">
              <div class="modal-title">Responder Comentario</div>
              <button class="modal-close" onclick="closeModal('replyModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Tu Respuesta</label>
                <textarea id="replyText" class="form-textarea" placeholder="Escribe tu respuesta... Usa @ para mencionar personas"></textarea>
              </div>
              <div style="font-size: 12px; color: #64748b; margin-top: 8px;">
                üí° Tip: Escribe @ seguido del nombre para mencionar a alguien
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('replyModal')">Cancelar</button>
              <button class="btn btn-primary" onclick="saveReply(${commentId})">Publicar Respuesta</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', replyHTML);
    }

    function saveReply(commentId) {
      const replyText = document.getElementById('replyText').value.trim();
      if (!replyText) {
        alert('‚ö†Ô∏è Escribe una respuesta');
        return;
      }
      
      closeModal('replyModal');
      alert('‚úì Respuesta publicada');
      console.log(`Reply to comment ${commentId}: ${replyText}`);
    }

    // Funci√≥n para editar comentario
    function editComment(commentId) {
      const editHTML = `
        <div class="modal-overlay" id="editModal" onclick="if(event.target === this) closeModal('editModal')">
          <div class="modal">
            <div class="modal-header">
              <div class="modal-title">Editar Comentario</div>
              <button class="modal-close" onclick="closeModal('editModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="form-label">Comentario</label>
                <textarea id="editText" class="form-textarea">Texto del comentario original...</textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeModal('editModal')">Cancelar</button>
              <button class="btn btn-primary" onclick="saveEdit(${commentId})">Guardar Cambios</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', editHTML);
    }

    function saveEdit(commentId) {
      closeModal('editModal');
      alert('‚úì Comentario actualizado');
    }

    // Funci√≥n para eliminar comentario
    function deleteComment(commentId) {
      if (confirm('¬øEst√°s seguro de eliminar este comentario?')) {
        alert('‚úì Comentario eliminado');
        console.log(`Deleted comment ${commentId}`);
      }
    }

    // Filtros de b√∫squeda
    document.addEventListener('DOMContentLoaded', function() {
      // SIMULACI√ìN: Usuario de sesi√≥n actual (esto vendr√° del login real)
      // En producci√≥n, esto se establecer√° cuando el usuario haga login en motorsync.html
      if (!sessionStorage.getItem('currentUser')) {
        sessionStorage.setItem('currentUser', JSON.stringify({
          displayName: 'Rodolfo Real',
          email: 'rodolfo@opsis.com',
          role: 'estimator_pm',
          userId: 'user_001'
        }));
      }
      
      // Verificar si el thread ya est√° convertido (de localStorage o base de datos)
      checkThreadConversionStatus();
      
      hydrateThreadDefaults();
      renderThreadHeader();
      const searchInput = document.getElementById('searchComments');
      const filterAuthor = document.getElementById('filterAuthor');
      const filterDate = document.getElementById('filterDate');
      
      if (searchInput) {
        searchInput.addEventListener('input', filterComments);
      }
      if (filterAuthor) {
        filterAuthor.addEventListener('change', filterComments);
      }
      if (filterDate) {
        filterDate.addEventListener('change', filterComments);
      }
    });

    // Verificar si el thread ya fue convertido a proyecto
    function checkThreadConversionStatus() {
      // Simulaci√≥n: En producci√≥n esto vendr√≠a de la base de datos
      const savedThread = localStorage.getItem('threadState_current');
      if (savedThread) {
        const saved = JSON.parse(savedThread);
        if (saved.isConverted) {
          threadState.isConverted = true;
          threadState.projectId = saved.projectId;
          document.getElementById('notConvertedSection').style.display = 'none';
          document.getElementById('convertedSection').style.display = 'block';
        }
      }
    }

    function filterComments() {
      const search = document.getElementById('searchComments')?.value.toLowerCase() || '';
      const author = document.getElementById('filterAuthor')?.value || '';
      const date = document.getElementById('filterDate')?.value || '';
      
      const comments = document.querySelectorAll('.timeline-item');
      
      comments.forEach(comment => {
        const text = comment.textContent.toLowerCase();
        const authorMatch = author === '' || comment.querySelector('.comment-avatar')?.textContent.includes(author);
        const searchMatch = search === '' || text.includes(search);
        
        if (searchMatch && authorMatch) {
          comment.style.display = '';
        } else {
          comment.style.display = 'none';
        }
      });
    }
  </script>

  </div><!-- /app-content -->
</div><!-- /app-shell -->

</body>
</html>
