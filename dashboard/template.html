<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Opsis Suite</title>
    
    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            /* Colores din√°micos que se cargan desde la base de datos */
            --primary-color: #495057;
            --secondary-color: #6c757d;
            --accent-color: #22c55e;
            --background-color: #f8fafc;
            --text-color: #1e293b;
            --card-color: #ffffff;
            --border-color: #e2e8f0;
            --hover-color: #f1f5f9;
        // ================================================================
        // UTILITY FUNCTIONS
        // ================================================================
        function updateDebugInfo(info) {
            if (!isDebugMode) return;
            
            const debugElement = document.getElementById('debugInfo');
            if (debugElement) {
                debugElement.classList.add('show');
                const timestamp = new Date().toLocaleTimeString();
                debugElement.innerHTML += `<div>[${timestamp}] ${info}</div>`;
                
                // Limitar a √∫ltimas 10 l√≠neas
                const lines = debugElement.querySelectorAll('div');
                if (lines.length > 10) {
                    lines[0].remove();
                }
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            
            notification.textContent = message;
            notification.classList.remove('success', 'warning', 'error');
            notification.classList.add(type);
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function handleStatClick(type) {
            const messages = {
                'equipment': 'Loading equipment inventory dashboard...',
                'loans': 'Opening active loans management...',
                'maintenance': 'Loading maintenance scheduler...',
                'overdue': 'Opening overdue tracking system...',
                'users': 'Loading user management...',
                'financial': 'Opening financial dashboard...',
                'settings': 'Loading system settings...',
                'subscription': 'Opening subscription management...',
                'inventory': 'Loading inventory management...',
                'stock_alerts': 'Checking stock alerts...',
                'movements': 'Loading movement history...',
                'my_equipment': 'Loading your assigned equipment...',
                'quick_checkout': 'Opening quick checkout...',
                'incidents': 'Loading incident reports...',
                'schedule': 'Opening your schedule...',
                'projects': 'Loading project management...',
                'quotes': 'Opening quote manager...',
                'costs': 'Loading cost analysis...',
                'profitability': 'Opening profitability reports...',
                'field_equipment': 'Loading field equipment tracker...',
                'team_productivity': 'Opening team productivity dashboard...',
                'active_projects': 'Loading active project sites...',
                'alerts': 'Opening field alerts...'
            };
            
            showNotification(messages[type] || 'Loading...', 'success');
            updateDebugInfo(`Stat clicked: ${type}`);
            
            setTimeout(() => {
                window.location.href = 'https://candewesth.github.io/opsis-suite/built.html';
            }, 1000);
        }

        function handleActionClick(action) {
            const messages = {
                'manage_users': 'Opening user management...',
                'company_settings': 'Loading company settings...',
                'billing': 'Opening billing dashboard...',
                'reports': 'Generating financial reports...',
                'add_equipment': 'Opening equipment addition form...',
                'stock_check': 'Starting stock verification...',
                'generate_report': 'Generating inventory report...',
                'schedule_maintenance': 'Opening maintenance scheduler...',
                'quick_checkout': 'Opening quick checkout interface...',
                'report_incident': 'Loading incident report form...',
                'check_status': 'Checking equipment status...',
                'view_schedule': 'Loading your work schedule...',
                'new_quote': 'Creating new project quote...',
                'project_analysis': 'Loading project analysis tools...',
                'cost_calculator': 'Opening cost calculation tool...',
                'view_projects': 'Loading project overview...',
                'assign_equipment': 'Opening equipment assignment...',
                'team_report': 'Generating team performance report...',
                'project_status': 'Loading project status dashboard...',
                'field_alerts': 'Opening field alert management...'
            };
            
            showNotification(messages[action] || 'Loading...', 'success');
            updateDebugInfo(`Action: ${action}`);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header - Estilo Apple 96 */
        .header {
            background: var(--card-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Logo din√°mico */
        .logo-container {
            position: relative;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            padding: 2px;
            background: linear-gradient(45deg, var(--accent-color), var(--primary-color), var(--secondary-color));
            background-size: 400% 400%;
            animation: gradientShift 4s ease-in-out infinite;
            box-shadow: 0 4px 12px color-mix(in srgb, var(--accent-color) 20%, transparent);
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            position: relative;
        }

        .logo-icon.has-image {
            background: white;
            overflow: hidden;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }

        .logo-icon::after {
            content: '‚óâ';
            animation: winkEye 4s ease-in-out infinite;
        }

        .logo-icon.has-image::after {
            display: none;
        }

        @keyframes winkEye {
            0%, 90%, 100% { content: '‚óâ'; }
            95% { content: '‚óè'; }
        }

        .header-info h1 {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .header-info p {
            color: #64748b;
            font-size: 16px;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .profile-info {
            text-align: right;
            margin-right: 1rem;
        }

        .profile-name {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .profile-role {
            color: #64748b;
            font-size: 14px;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        /* Stats Grid - Apple 96 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .stat-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #64748b;
            font-size: 14px;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .content-card {
            background: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background: #fafbfc;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        .card-subtitle {
            color: #64748b;
            font-size: 14px;
        }

        .card-body {
            padding: 2rem;
        }

        /* Buttons Apple Style */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px color-mix(in srgb, var(--primary-color) 30%, transparent);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-color), #16a34a);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px color-mix(in srgb, var(--accent-color) 30%, transparent);
        }

        .btn-secondary {
            background: #f8fafc;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background: var(--hover-color);
            border-color: #cbd5e1;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
            transition: all 0.8s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-bottom: 1.5rem;
            animation: pulse 2s ease-in-out infinite;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .loading-logo.has-image {
            background: white;
            overflow: hidden;
        }

        .loading-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 18px;
        }

        .loading-logo::after {
            content: '‚óâ';
        }

        .loading-logo.has-image::after {
            display: none;
        }

        .loading-text {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .loading-subtitle {
            opacity: 0.8;
            font-size: 16px;
            margin-bottom: 2rem;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: white;
            border-radius: 2px;
            animation: loading 2s ease-out;
        }

        @keyframes loading {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(400px);
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--accent-color);
            background: color-mix(in srgb, var(--accent-color) 5%, var(--card-color));
        }

        .notification.error {
            border-left: 4px solid #ef4444;
            background: color-mix(in srgb, #ef4444 5%, var(--card-color));
        }

        .notification.warning {
            border-left: 4px solid #f59e0b;
            background: color-mix(in srgb, #f59e0b 5%, var(--card-color));
        }

        /* Debug Info */
        .debug-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #1e293b;
            color: #22c55e;
            padding: 1rem;
            border-radius: 8px;
            font-size: 12px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            display: none;
            max-width: 300px;
            border: 1px solid #334155;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .debug-info.show {
            display: block;
        }

        .debug-info div {
            margin: 2px 0;
            opacity: 0.9;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header-actions {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-logo" id="loadingLogo"></div>
        <div class="loading-text" id="loadingCompanyName">Loading...</div>
        <div class="loading-subtitle" id="loadingSubtitle">Initializing your workspace...</div>
        <div class="loading-progress">
            <div class="progress-bar"></div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="logo-container">
                    <div class="logo-icon" id="headerLogo"></div>
                </div>
                <div class="header-info">
                    <h1 id="companyName">Loading...</h1>
                    <p id="companyDescription">Warehouse Management System</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="profile-info">
                    <div class="profile-name" id="profileName">User</div>
                    <div class="profile-role" id="profileRole">Loading...</div>
                </div>
                <button class="logout-btn" onclick="handleSignOut()">Sign Out</button>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card" onclick="handleStatClick('equipment')">
                <div class="stat-header">
                    <div class="stat-title">Available Equipment</div>
                    <div class="stat-icon">‚úÖ</div>
                </div>
                <div class="stat-number" id="availableEquipment">0</div>
                <div class="stat-label">Ready for checkout</div>
            </div>

            <div class="stat-card" onclick="handleStatClick('loans')">
                <div class="stat-header">
                    <div class="stat-title">Active Loans</div>
                    <div class="stat-icon">üîÑ</div>
                </div>
                <div class="stat-number" id="activeLoans">0</div>
                <div class="stat-label">Currently checked out</div>
            </div>

            <div class="stat-card" onclick="handleStatClick('maintenance')">
                <div class="stat-header">
                    <div class="stat-title">In Maintenance</div>
                    <div class="stat-icon">üîß</div>
                </div>
                <div class="stat-number" id="inMaintenance">0</div>
                <div class="stat-label">Being serviced</div>
            </div>

            <div class="stat-card" onclick="handleStatClick('overdue')">
                <div class="stat-header">
                    <div class="stat-title">Overdue Returns</div>
                    <div class="stat-icon">‚è∞</div>
                </div>
                <div class="stat-number" id="overdueReturns">0</div>
                <div class="stat-label">Require attention</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-card">
                <div class="card-header">
                    <div class="card-title">Dashboard Overview</div>
                    <div class="card-subtitle">Warehouse operations and equipment management</div>
                </div>
                <div class="card-body">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Total Equipment</div>
                                <div class="stat-icon">üì¶</div>
                            </div>
                            <div class="stat-number" id="totalEquipment">0</div>
                            <div class="stat-label">All inventory items</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Active Users</div>
                                <div class="stat-icon">üë•</div>
                            </div>
                            <div class="stat-number" id="activeUsers">0</div>
                            <div class="stat-label">Current team members</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">This Month</div>
                                <div class="stat-icon">üìä</div>
                            </div>
                            <div class="stat-number" id="monthlyLoans">0</div>
                            <div class="stat-label">Equipment loans</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="handleActionClick('inventory')">
                            Manage Inventory
                        </button>
                        <button class="btn btn-success" onclick="handleActionClick('loans')">
                            New Loan
                        </button>
                        <button class="btn btn-secondary" onclick="handleActionClick('reports')">
                            View Reports
                        </button>
                        <button class="btn btn-secondary" onclick="handleActionClick('maintenance')">
                            Schedule Maintenance
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Debug Info -->
    <div id="debugInfo" class="debug-info"></div>

    <script>
        // ================================================================
        // SUPABASE CONFIGURATION
        // ================================================================
        const SUPABASE_CONFIG = {
            url: 'https://lmmlhncwdwjgtkdqaycv.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtbWxobmN3ZHdqZ3RrZHFheWN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDE4ODYsImV4cCI6MjA3MDk3Nzg4Nn0.vhL5E-o9RtjEtrYTOdFCvhXs5mu5fuuAtB13LCd6dJQ'
        };

        const supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);

        // ================================================================
        // GLOBAL VARIABLES
        // ================================================================
        let currentCompany = null;
        let currentUser = null;
        let userRole = 'admin';
        let companyBranding = null;
        let isDebugMode = window.location.search.includes('debug=true');

        // ================================================================
        // DYNAMIC BRANDING SYSTEM
        // ================================================================
        async function loadCompanyBranding(companyId) {
            try {
                console.log('Loading branding for company:', companyId);
                updateDebugInfo(`Loading branding: ${companyId}`);
                
                const { data: branding, error } = await supabase
                    .from('company_branding')
                    .select('*')
                    .eq('company_id', companyId)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading branding:', error);
                    updateDebugInfo(`Branding error: ${error.message}`);
                    return null;
                }

                if (branding) {
                    console.log('Company branding loaded:', branding);
                    updateDebugInfo(`Branding loaded: ${branding.primary_color}`);
                    companyBranding = branding;
                    applyCompanyBranding(branding);
                } else {
                    console.log('No custom branding found, using defaults');
                    updateDebugInfo('Using default branding');
                    companyBranding = getDefaultBranding();
                    applyCompanyBranding(companyBranding);
                }

                return branding;
            } catch (error) {
                console.error('Error in loadCompanyBranding:', error);
                updateDebugInfo(`Branding critical error: ${error.message}`);
                return null;
            }
        }

        function getDefaultBranding() {
            return {
                primary_color: '#495057',
                secondary_color: '#6c757d',
                accent_color: '#22c55e',
                background_color: '#f8fafc',
                text_color: '#1e293b',
                sidebar_color: '#ffffff',
                logo_url: null,
                custom_css: null
            };
        }

        function applyCompanyBranding(branding) {
            if (!branding) return;

            console.log('Applying company branding:', branding);
            updateDebugInfo('Applying branding colors');

            const root = document.documentElement;
            
            if (branding.primary_color) {
                root.style.setProperty('--primary-color', branding.primary_color);
            }
            if (branding.secondary_color) {
                root.style.setProperty('--secondary-color', branding.secondary_color);
            }
            if (branding.accent_color) {
                root.style.setProperty('--accent-color', branding.accent_color);
            }
            if (branding.background_color) {
                root.style.setProperty('--background-color', branding.background_color);
            }
            if (branding.text_color) {
                root.style.setProperty('--text-color', branding.text_color);
            }

            if (branding.logo_url) {
                applyCompanyLogo(branding.logo_url);
            }

            if (branding.custom_css) {
                applyCustomCSS(branding.custom_css);
            }

            updateDebugInfo('Branding applied successfully');
            console.log('Company branding applied successfully');
        }

        function applyCompanyLogo(logoUrl) {
            console.log('Applying company logo:', logoUrl);
            updateDebugInfo(`Logo: ${logoUrl}`);
            
            const loadingLogo = document.getElementById('loadingLogo');
            const headerLogo = document.getElementById('headerLogo');
            
            if (loadingLogo) {
                loadingLogo.classList.add('has-image');
                loadingLogo.innerHTML = `<img src="${logoUrl}" alt="Company Logo" onerror="handleLogoError(this)">`;
            }

            if (headerLogo) {
                headerLogo.classList.add('has-image');
                headerLogo.innerHTML = `<img src="${logoUrl}" alt="Company Logo" onerror="handleLogoError(this)">`;
            }
        }

        function handleLogoError(img) {
            console.warn('Logo failed to load:', img.src);
            updateDebugInfo('Logo load failed');
            img.style.display = 'none';
            const logoContainer = img.parentElement;
            if (logoContainer) {
                logoContainer.classList.remove('has-image');
            }
        }

        function applyCustomCSS(customCSS) {
            console.log('Applying custom CSS');
            updateDebugInfo('Custom CSS applied');
            
            let styleElement = document.getElementById('customCompanyStyles');
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'customCompanyStyles';
                document.head.appendChild(styleElement);
            }
            
            styleElement.textContent = customCSS;
        }

        // ================================================================
        // AUTHENTICATION CHECK CON MEJOR DEBUG
        // ================================================================
        async function checkAuth() {
            try {
                console.log('Verificando autenticaci√≥n...');
                updateDebugInfo('Checking authentication...');
                
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) {
                    console.error('Error en getUser:', error);
                    updateDebugInfo(`Auth error: ${error.message}`);
                    
                    if (isDebugMode) {
                        console.warn('DEBUG MODE: Continuando sin autenticaci√≥n');
                        updateDebugInfo('DEBUG: Skipping auth for testing');
                        return { id: 'debug-user', email: 'debug@test.com' };
                    }
                    
                    console.log('Redirigiendo al login por error de auth...');
                    window.location.href = 'https://candewesth.github.io/opsis-suite/login.html';
                    return null;
                }
                
                if (!user) {
                    console.log('No hay usuario autenticado');
                    updateDebugInfo('No authenticated user found');
                    
                    if (isDebugMode) {
                        console.warn('DEBUG MODE: Simulando usuario autenticado');
                        updateDebugInfo('DEBUG: Simulating authenticated user');
                        return { id: 'debug-user', email: 'debug@test.com' };
                    }
                    
                    console.log('Redirigiendo al login...');
                    window.location.href = 'https://candewesth.github.io/opsis-suite/login.html';
                    return null;
                }
                
                console.log('Usuario autenticado:', user.email);
                updateDebugInfo(`Authenticated: ${user.email}`);
                currentUser = user;
                
                try {
                    const { data: profile, error: profileError } = await Promise.race([
                        supabase.from('user_profiles').select('*').eq('user_id', user.id).single(),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Profile load timeout')), 5000))
                    ]);
                    
                    if (!profileError && profile) {
                        const userRole = profile.role || 'OPERATIVO';
                        document.getElementById('profileName').textContent = profile.full_name || profile.name || user.email;
                        document.getElementById('profileRole').textContent = userRole;
                        updateDebugInfo(`Profile loaded: ${userRole}`);
                        
                        // Actualizar dashboard seg√∫n el rol
                        updateDashboardForRole(userRole);
                        window.currentUserRole = userRole;
                    } else {
                        console.warn('No se pudo cargar el perfil del usuario:', profileError);
                        updateDebugInfo('Profile load failed, using defaults');
                        document.getElementById('profileName').textContent = user.email;
                        document.getElementById('profileRole').textContent = 'OPERATIVO';
                        updateDashboardForRole('OPERATIVO');
                        window.currentUserRole = 'OPERATIVO';
                    }
                } catch (profileError) {
                    console.warn('Error cargando perfil:', profileError);
                    updateDebugInfo('Profile error, using email');
                    document.getElementById('profileName').textContent = user.email;
                    document.getElementById('profileRole').textContent = 'User';
                }
                
                return user;
                
            } catch (error) {
                console.error('Error cr√≠tico en checkAuth:', error);
                updateDebugInfo(`Critical auth error: ${error.message}`);
                
                if (isDebugMode) {
                    console.warn('DEBUG MODE: Continuando con error de auth');
                    return { id: 'debug-user', email: 'debug@test.com' };
                }
                
                alert('Error de autenticaci√≥n. Redirigiendo al login...');
                window.location.href = 'https://candewesth.github.io/opsis-suite/login.html';
                return null;
            }
        }

        // ================================================================
        // SIGN OUT FUNCTION
        // ================================================================
        async function handleSignOut() {
            try {
                console.log('Iniciando cierre de sesi√≥n...');
                showNotification('Cerrando sesi√≥n...', 'success');
                
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    console.error('Error al cerrar sesi√≥n en Supabase:', error);
                }
                
                localStorage.clear();
                sessionStorage.clear();
                
                currentUser = null;
                currentCompany = null;
                companyBranding = null;
                userRole = null;
                
                setTimeout(() => {
                    window.location.href = 'https://candewesth.github.io/opsis-suite/login.html';
                }, 500);
                
            } catch (error) {
                console.error('Error en handleSignOut:', error);
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'https://candewesth.github.io/opsis-suite/login.html';
            }
        }

        // ================================================================
        // COMPANY DETECTION
        // ================================================================
        function detectCompany() {
            const urlParams = new URLSearchParams(window.location.search);
            const companyParam = urlParams.get('company');
            
            if (companyParam) {
                console.log('Company from URL parameter:', companyParam);
                return companyParam;
            }
            
            const path = window.location.pathname;
            const segments = path.split('/').filter(segment => segment);
            const lastSegment = segments[segments.length - 1];
            
            if (lastSegment === 'template.html' || lastSegment === 'template') {
                console.log('Template detected, defaulting to demo company');
                return 'demo';
            }
            
            const companySlug = lastSegment.replace('.html', '');
            console.log('Detected company slug from filename:', companySlug);
            return companySlug;
        }

        // ================================================================
        // DATA LOADING FUNCTIONS
        // ================================================================
        async function loadCompanyData() {
            try {
                const companySlug = detectCompany();
                
                if (!companySlug) {
                    throw new Error('No company identifier found in URL');
                }

                console.log('Loading company data for:', companySlug);
                updateDebugInfo(`Loading company: ${companySlug}`);

                const { data: company, error } = await supabase
                    .from('companies')
                    .select('*')
                    .eq('slug', companySlug)
                    .single();

                if (error) {
                    console.error('Error loading company:', error);
                    updateDebugInfo(`Company load error: ${error.message}`);
                    currentCompany = createDemoCompany(companySlug);
                } else {
                    currentCompany = company;
                    updateDebugInfo(`Company loaded from DB: ${company.name}`);
                }

                console.log('Company loaded:', currentCompany);
                
                if (currentCompany && currentCompany.id) {
                    await loadCompanyBranding(currentCompany.id);
                }
                
                updateCompanyDisplay();

            } catch (error) {
                console.error('Error in loadCompanyData:', error);
                updateDebugInfo(`Data load error: ${error.message}`);
                currentCompany = createDemoCompany('demo');
                updateCompanyDisplay();
            }
        }

        function createDemoCompany(slug) {
            const companyMap = {
                'demo': {
                    id: '550e8400-e29b-41d4-a716-446655440001',
                    name: 'Demo Company'
                },
                'acme': {
                    id: '550e8400-e29b-41d4-a716-446655440002',
                    name: 'ACME Corp'
                }
            };
            
            const companyData = companyMap[slug] || companyMap['demo'];
            
            return {
                id: companyData.id,
                name: companyData.name,
                slug: slug,
                domain: `${slug}.opsisuite.com`,
                status: 'active'
            };
        }

        function updateCompanyDisplay() {
            if (!currentCompany) return;

            document.getElementById('loadingCompanyName').textContent = currentCompany.name;
            document.getElementById('loadingSubtitle').textContent = `Initializing ${currentCompany.name} workspace...`;
            document.getElementById('companyName').textContent = currentCompany.name;
            
            updateDebugInfo(`Display updated: ${currentCompany.name}`);
        }

        // ================================================================
        // ROLE-BASED DASHBOARD SYSTEM
        // ================================================================
        const ROLE_CONFIGURATIONS = {
            'ADMIN': {
                title: 'Panel de Administraci√≥n',
                subtitle: 'Control total de la empresa y configuraciones del sistema',
                widgets: ['users', 'financial', 'settings', 'subscription'],
                actions: ['manage_users', 'company_settings', 'billing', 'reports']
            },
            'ALMACEN': {
                title: 'Centro de Almac√©n',
                subtitle: 'Gesti√≥n de inventario y control de equipos',
                widgets: ['inventory', 'stock_alerts', 'movements', 'maintenance'],
                actions: ['add_equipment', 'stock_check', 'generate_report', 'schedule_maintenance']
            },
            'OPERATIVO': {
                title: 'Panel Operativo',
                subtitle: 'Check-in/out de equipos y gesti√≥n de campo',
                widgets: ['my_equipment', 'quick_checkout', 'incidents', 'schedule'],
                actions: ['quick_checkout', 'report_incident', 'check_status', 'view_schedule']
            },
            'ESTIMADOR': {
                title: 'Mesa de Estimaciones',
                subtitle: 'Cotizaciones, proyectos y an√°lisis de costos',
                widgets: ['projects', 'quotes', 'costs', 'profitability'],
                actions: ['new_quote', 'project_analysis', 'cost_calculator', 'view_projects']
            },
            'SUPERVISOR': {
                title: 'Control de Campo',
                subtitle: 'Supervisi√≥n de equipos y equipos de trabajo',
                widgets: ['field_equipment', 'team_productivity', 'active_projects', 'alerts'],
                actions: ['assign_equipment', 'team_report', 'project_status', 'field_alerts']
            }
        };

        function getRoleConfiguration(role) {
            return ROLE_CONFIGURATIONS[role] || ROLE_CONFIGURATIONS['OPERATIVO'];
        }

        function updateDashboardForRole(role) {
            const config = getRoleConfiguration(role);
            
            // Actualizar t√≠tulos
            const titleElement = document.querySelector('.header-info h1');
            const subtitleElement = document.querySelector('.header-info p');
            
            if (titleElement) titleElement.textContent = config.title;
            if (subtitleElement) subtitleElement.textContent = config.subtitle;
            
            // Actualizar widgets
            updateWidgetsForRole(role, config.widgets);
            
            // Actualizar acciones
            updateActionsForRole(role, config.actions);
            
            updateDebugInfo(`Dashboard updated for role: ${role}`);
        }
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            
            notification.textContent = message;
            notification.classList.remove('success', 'warning', 'error');
            notification.classList.add(type);
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function handleStatClick(type) {
            const messages = {
                'equipment': 'Loading equipment inventory dashboard...',
                'loans': 'Opening active loans management...',
                'maintenance': 'Loading maintenance scheduler...',
                'overdue': 'Opening overdue tracking system...'
            };
            
            showNotification(messages[type] || 'Loading...', 'success');
            updateDebugInfo(`Stat clicked: ${type}`);
            
            setTimeout(() => {
                window.location.href = 'https://candewesth.github.io/opsis-suite/built.html';
            }, 1000);
        }

        function handleActionClick(action) {
            const messages = {
                'inventory': 'Opening inventory management...',
                'loans': 'Creating new loan...',
                'reports': 'Loading reports dashboard...',
                'maintenance': 'Opening maintenance scheduler...'
            };
            
            showNotification(messages[action] || 'Loading...', 'success');
            updateDebugInfo(`Action: ${action}`);
        }

        function updateWidgetsForRole(role, widgets) {
            const statsGrid = document.querySelector('.stats-grid');
            if (!statsGrid) return;
            
            // Limpiar widgets existentes
            statsGrid.innerHTML = '';
            
            // Crear widgets espec√≠ficos por rol
            widgets.forEach(widget => {
                const widgetConfig = getWidgetConfig(widget, role);
                if (widgetConfig) {
                    const widgetElement = createWidget(widgetConfig);
                    statsGrid.appendChild(widgetElement);
                }
            });
        }

        function getWidgetConfig(widget, role) {
            const configs = {
                // Widgets para ADMIN
                'users': { icon: 'üë•', title: 'Total Users', number: '15', label: 'Active team members', action: 'users' },
                'financial': { icon: 'üí∞', title: 'Monthly Revenue', number: '$2,500', label: 'Current billing cycle', action: 'financial' },
                'settings': { icon: '‚öôÔ∏è', title: 'System Health', number: '98%', label: 'All systems operational', action: 'settings' },
                'subscription': { icon: 'üìã', title: 'Plan Status', number: 'Pro', label: 'Warehouse Pro active', action: 'subscription' },
                
                // Widgets para ALMACEN
                'inventory': { icon: 'üì¶', title: 'Total Inventory', number: '247', label: 'Items in warehouse', action: 'inventory' },
                'stock_alerts': { icon: '‚ö†Ô∏è', title: 'Low Stock Alerts', number: '8', label: 'Items need reorder', action: 'stock_alerts' },
                'movements': { icon: 'üîÑ', title: 'Daily Movements', number: '45', label: 'In/Out today', action: 'movements' },
                'maintenance': { icon: 'üîß', title: 'Pending Maintenance', number: '12', label: 'Items scheduled', action: 'maintenance' },
                
                // Widgets para OPERATIVO
                'my_equipment': { icon: 'üéØ', title: 'My Equipment', number: '8', label: 'Currently assigned', action: 'my_equipment' },
                'quick_checkout': { icon: '‚ö°', title: 'Quick Actions', number: '3', label: 'Pending checkout', action: 'quick_checkout' },
                'incidents': { icon: 'üö®', title: 'Open Incidents', number: '2', label: 'Require attention', action: 'incidents' },
                'schedule': { icon: 'üìÖ', title: 'Today Schedule', number: '6', label: 'Scheduled tasks', action: 'schedule' },
                
                // Widgets para ESTIMADOR
                'projects': { icon: 'üèóÔ∏è', title: 'Active Projects', number: '12', label: 'In progress', action: 'projects' },
                'quotes': { icon: 'üìä', title: 'Pending Quotes', number: '7', label: 'Awaiting approval', action: 'quotes' },
                'costs': { icon: 'üíµ', title: 'Cost Analysis', number: '$45K', label: 'Monthly equipment cost', action: 'costs' },
                'profitability': { icon: 'üìà', title: 'Profit Margin', number: '23%', label: 'Current quarter', action: 'profitability' },
                
                // Widgets para SUPERVISOR
                'field_equipment': { icon: 'üöõ', title: 'Field Equipment', number: '89', label: 'On active sites', action: 'field_equipment' },
                'team_productivity': { icon: '‚≠ê', title: 'Team Efficiency', number: '94%', label: 'This week average', action: 'team_productivity' },
                'active_projects': { icon: 'üéØ', title: 'Supervised Sites', number: '5', label: 'Active locations', action: 'active_projects' },
                'alerts': { icon: 'üîî', title: 'Field Alerts', number: '3', label: 'Require response', action: 'alerts' }
            };
            
            return configs[widget];
        }

        function createWidget(config) {
            const widget = document.createElement('div');
            widget.className = 'stat-card';
            widget.onclick = () => handleStatClick(config.action);
            
            widget.innerHTML = `
                <div class="stat-header">
                    <div class="stat-title">${config.title}</div>
                    <div class="stat-icon">${config.icon}</div>
                </div>
                <div class="stat-number">${config.number}</div>
                <div class="stat-label">${config.label}</div>
            `;
            
            return widget;
        }

        function updateActionsForRole(role, actions) {
            const actionsContainer = document.querySelector('.card-body [style*="display: flex"]');
            if (!actionsContainer) return;
            
            // Limpiar acciones existentes
            actionsContainer.innerHTML = '';
            
            // Crear botones espec√≠ficos por rol
            actions.forEach(action => {
                const actionConfig = getActionConfig(action, role);
                if (actionConfig) {
                    const button = document.createElement('button');
                    button.className = `btn ${actionConfig.type}`;
                    button.onclick = () => handleActionClick(action);
                    button.innerHTML = actionConfig.label;
                    actionsContainer.appendChild(button);
                }
            });
        }

        function getActionConfig(action, role) {
            const configs = {
                // Acciones para ADMIN
                'manage_users': { label: 'üë• Manage Users', type: 'btn-primary' },
                'company_settings': { label: '‚öôÔ∏è Company Settings', type: 'btn-secondary' },
                'billing': { label: 'üí≥ Billing & Plans', type: 'btn-success' },
                'reports': { label: 'üìä Financial Reports', type: 'btn-secondary' },
                
                // Acciones para ALMACEN
                'add_equipment': { label: '‚ûï Add Equipment', type: 'btn-primary' },
                'stock_check': { label: 'üìã Stock Check', type: 'btn-secondary' },
                'generate_report': { label: 'üìÑ Generate Report', type: 'btn-secondary' },
                'schedule_maintenance': { label: 'üîß Schedule Maintenance', type: 'btn-success' },
                
                // Acciones para OPERATIVO
                'quick_checkout': { label: '‚ö° Quick Checkout', type: 'btn-primary' },
                'report_incident': { label: 'üö® Report Incident', type: 'btn-secondary' },
                'check_status': { label: 'üì± Check Status', type: 'btn-secondary' },
                'view_schedule': { label: 'üìÖ My Schedule', type: 'btn-success' },
                
                // Acciones para ESTIMADOR
                'new_quote': { label: 'üìù New Quote', type: 'btn-primary' },
                'project_analysis': { label: 'üìä Project Analysis', type: 'btn-secondary' },
                'cost_calculator': { label: 'üßÆ Cost Calculator', type: 'btn-success' },
                'view_projects': { label: 'üèóÔ∏è View Projects', type: 'btn-secondary' },
                
                // Acciones para SUPERVISOR
                'assign_equipment': { label: 'üéØ Assign Equipment', type: 'btn-primary' },
                'team_report': { label: 'üë• Team Report', type: 'btn-secondary' },
                'project_status': { label: 'üìà Project Status', type: 'btn-success' },
                'field_alerts': { label: 'üîî Field Alerts', type: 'btn-secondary' }
            };
            
            return configs[action];
        }

        // ================================================================
        // ROLE DETECTION AND SIMULATION
        // ================================================================
        function detectUserRole() {
            // En modo debug, simular diferentes roles
            if (isDebugMode) {
                const urlParams = new URLSearchParams(window.location.search);
                const roleParam = urlParams.get('role');
                
                if (roleParam) {
                    console.log('Role from URL parameter:', roleParam);
                    return roleParam.toUpperCase();
                }
                
                // Role por defecto en debug
                return 'ALMACEN';
            }
            
            // En modo real, obtener del perfil del usuario
            return userRole || 'OPERATIVO';
        }

        function setupRoleSelector() {
            if (!isDebugMode) return;
            
            // Agregar selector de roles en modo debug
            const header = document.querySelector('.header-actions');
            if (header && !document.getElementById('roleSelector')) {
                const roleSelector = document.createElement('select');
                roleSelector.id = 'roleSelector';
                roleSelector.style.cssText = `
                    padding: 0.5rem 1rem;
                    border-radius: 8px;
                    border: 1px solid var(--border-color);
                    background: var(--card-color);
                    margin-right: 1rem;
                `;
                
                const roles = ['ADMIN', 'ALMACEN', 'OPERATIVO', 'ESTIMADOR', 'SUPERVISOR'];
                const currentRole = detectUserRole();
                
                roleSelector.innerHTML = roles.map(role => 
                    `<option value="${role}" ${role === currentRole ? 'selected' : ''}>${role}</option>`
                ).join('');
                
                roleSelector.onchange = (e) => {
                    const newRole = e.target.value;
                    const url = new URL(window.location);
                    url.searchParams.set('role', newRole.toLowerCase());
                    window.location.href = url.toString();
                };
                
                header.insertBefore(roleSelector, header.firstChild);
            }
        }

        // ================================================================
        // INITIALIZATION CON MEJOR ERROR HANDLING
        // ================================================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Iniciando Company Dashboard - Opsis Suite');
            
            if (isDebugMode) {
                updateDebugInfo('Debug mode enabled');
                document.getElementById('debugInfo').classList.add('show');
            }
            
            try {
                updateDebugInfo('Starting initialization...');
                
                const user = await Promise.race([
                    checkAuth(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Auth timeout')), 8000))
                ]);
                
                if (user) {
                    updateDebugInfo('User authenticated, loading company data...');
                    
                    await Promise.race([
                        loadCompanyData(),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Company load timeout')), 6000))
                    ]);
                    
                    updateDebugInfo('Company data loaded, setting up stats...');
                    
                    // Estad√≠sticas de ejemplo
                    document.getElementById('availableEquipment').textContent = '168';
                    document.getElementById('activeLoans').textContent = '56';
                    document.getElementById('inMaintenance').textContent = '23';
                    document.getElementById('overdueReturns').textContent = '12';
                    document.getElementById('totalEquipment').textContent = '247';
                    document.getElementById('activeUsers').textContent = '15';
                    document.getElementById('monthlyLoans').textContent = '89';
                    
                    updateDebugInfo('Stats loaded, hiding loading screen...');
                    
                    setTimeout(() => {
                        document.getElementById('loadingScreen').classList.add('hidden');
                        showNotification(`Bienvenido a ${currentCompany?.name || 'Opsis Suite'}`, 'success');
                        updateDebugInfo('Initialization completed successfully');
                    }, 1200);
                }
                
            } catch (error) {
                console.error('Error durante la inicializaci√≥n:', error);
                updateDebugInfo(`Initialization error: ${error.message}`);
                
                if (isDebugMode) {
                    console.warn('DEBUG MODE: Continuando con datos de prueba');
                    updateDebugInfo('DEBUG: Using test data, skipping auth');
                    
                    currentCompany = createDemoCompany('demo');
                    updateCompanyDisplay();
                    
                    // Aplicar rol desde URL o usar por defecto
                    const debugRole = detectUserRole();
                    updateDashboardForRole(debugRole);
                    setupRoleSelector();
                    window.currentUserRole = debugRole;
                    
                    document.getElementById('availableEquipment').textContent = '168';
                    document.getElementById('activeLoans').textContent = '56';
                    document.getElementById('inMaintenance').textContent = '23';
                    document.getElementById('overdueReturns').textContent = '12';
                    document.getElementById('totalEquipment').textContent = '247';
                    document.getElementById('activeUsers').textContent = '15';
                    document.getElementById('monthlyLoans').textContent = '89';
                    
                    setTimeout(() => {
                        document.getElementById('loadingScreen').classList.add('hidden');
                        showNotification('Modo debug: Datos de prueba cargados', 'warning');
                    }, 1200);
                } else {
                    setTimeout(() => {
                        document.getElementById('loadingScreen').innerHTML = `
                            <div style="text-align: center; color: white; padding: 2rem;">
                                <h2>Error de Conexi√≥n</h2>
                                <p>No se pudo conectar con el servidor.</p>
                                <div style="margin-top: 2rem;">
                                    <button onclick="window.location.reload()" style="margin: 0.5rem; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: #007AFF; color: white; cursor: pointer;">
                                        Intentar de Nuevo
                                    </button>
                                    <button onclick="window.location.href='?debug=true'" style="margin: 0.5rem; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background: #FF9500; color: white; cursor: pointer;">
                                        Modo Debug
                                    </button>
                                </div>
                            </div>
                        `;
                    }, 2000);
                }
            }
        });

        // ================================================================
        // AUTH STATE LISTENER
        // ================================================================
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event);
            updateDebugInfo(`Auth event: ${event}`);
            
            if (event === 'SIGNED_OUT') {
                console.log('Usuario cerr√≥ sesi√≥n, redirigiendo...');
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'https://candewesth.github.io/opsis-suite/login.html';
            } else if (event === 'SIGNED_IN' && !currentUser) {
                console.log('Usuario autenticado, recargando...');
                window.location.reload();
            }
        });

        // Debug toggle con Ctrl+D
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                isDebugMode = !isDebugMode;
                const debugElement = document.getElementById('debugInfo');
                if (isDebugMode) {
                    debugElement.classList.add('show');
                    updateDebugInfo('Debug mode activated');
                } else {
                    debugElement.classList.remove('show');
                }
            }
        });

        console.log('Company Dashboard Template - Apple 96 Style Ready!');
    </script>
</body>
</html>
