<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Opsis Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #1d1d1f;
            min-height: 100vh;
            position: relative;
            line-height: 1.6;
        }

        /* Background Pattern - Premium Style */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(32, 201, 151, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(253, 126, 20, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 20% 80%, rgba(102, 16, 242, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(13, 202, 240, 0.1) 0%, transparent 50%);
            animation: subtleFloat 40s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes subtleFloat {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -25px) rotate(2deg); }
            66% { transform: translate(-25px, 25px) rotate(-2deg); }
        }

        /* Loading Screen - Premium */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #495057, #6c757d);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
            transition: all 0.8s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        /* Opsis Suite Logo - Premium */
        .company-logo {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 30px;
            padding: 4px;
            background: linear-gradient(45deg, 
                #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, 
                #feca57, #ff9ff3, #54a0ff, #5f27cd, 
                #00d2d3, #ff9f43, #10ac84, #ee5a6f);
            background-size: 400% 400%;
            animation: gradientShift 4s ease-in-out infinite, pulse 2s ease-in-out infinite;
            margin-bottom: 2rem;
        }

        .company-logo::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 112px;
            height: 112px;
            background: linear-gradient(135deg, #495057, #6c757d);
            border-radius: 26px;
            box-shadow: 0 8px 25px rgba(73, 80, 87, 0.3);
        }

        .company-logo::before {
            content: '◉';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: white;
            z-index: 3;
            animation: winkEye 6s ease-in-out infinite;
        }

        @keyframes winkEye {
            0%, 85% { transform: translate(-50%, -50%) scaleY(1); }
            88% { transform: translate(-50%, -50%) scaleY(0.1); }
            92% { transform: translate(-50%, -50%) scaleY(1); }
            94% { transform: translate(-50%, -50%) scaleY(0.1); }
            97% { transform: translate(-50%, -50%) scaleY(1); }
            100% { transform: translate(-50%, -50%) scaleY(1); }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            25% { background-position: 100% 50%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .loading-company-name {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .loading-subtitle {
            opacity: 0.9;
            font-size: 1.2rem;
            margin-bottom: 3rem;
        }

        .loading-progress {
            width: 300px;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: rgba(255,255,255,0.8);
            border-radius: 3px;
            animation: loading 3s ease-in-out;
        }

        @keyframes loading {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        /* Header - Premium Design */
        .dashboard-header {
            background: linear-gradient(135deg, #495057, #6c757d);
            color: white;
            padding: 2rem;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            position: relative;
            z-index: 2;
        }

        .company-info h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .company-info p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .header-stats {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .header-stat {
            text-align: center;
            padding: 1rem 1.5rem;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .header-stat:hover {
            transform: translateY(-3px);
            background: rgba(255,255,255,0.15);
        }

        .header-stat .number {
            font-size: 1.8rem;
            font-weight: 700;
            display: block;
        }

        .header-stat .label {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .profile-selector {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.4s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
            backdrop-filter: blur(20px);
        }

        .profile-selector:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }

        .profile-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
        }

        .profile-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .profile-role {
            opacity: 0.8;
            font-size: 0.75rem;
        }

        .logout-btn {
            background: linear-gradient(135deg, #495057, #6c757d);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.4s ease;
            text-decoration: none;
            font-weight: 600;
        }

        .logout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(73, 80, 87, 0.3);
        }

        /* Main Container - Premium Spacing */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 5rem 2rem;
        }

        .dashboard-title {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #1d1d1f, #495057);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            text-align: center;
            letter-spacing: -2px;
        }

        .dashboard-subtitle {
            text-align: center;
            color: #6c757d;
            font-size: 1.2rem;
            margin-bottom: 4rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Stats Grid - Premium Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 1px solid rgba(210, 210, 215, 0.3);
            border-radius: 32px;
            padding: 3rem 2.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            transition: all 0.4s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            text-align: center;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(135deg, #20c997, #17a2b8);
            border-radius: 32px 32px 0 0;
        }

        .stat-card:hover {
            transform: translateY(-15px);
            box-shadow: 0 25px 80px rgba(0,0,0,0.15);
            background: white;
        }

        .stat-icon {
            width: 100px;
            height: 100px;
            border-radius: 28px;
            background: linear-gradient(135deg, #20c997, #17a2b8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 2rem;
            transition: all 0.3s ease;
            color: white;
            box-shadow: 0 15px 40px rgba(32, 201, 151, 0.3);
        }

        .stat-card:hover .stat-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .stat-number {
            font-size: 2.8rem;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 1.2rem;
            color: #495057;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .stat-sublabel {
            font-size: 1rem;
            color: #6c757d;
        }

        /* Role Section - Premium */
        .role-section {
            margin-bottom: 5rem;
            animation: fadeInUp 0.6s ease;
        }

        .section-title {
            font-size: 2.2rem;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 3rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .section-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: linear-gradient(135deg, #495057, #6c757d);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            box-shadow: 0 15px 40px rgba(73, 80, 87, 0.3);
        }

        /* Content Cards - Premium */
        .content-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 1px solid rgba(210, 210, 215, 0.3);
            border-radius: 32px;
            padding: 3rem 2.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            transition: all 0.4s ease;
            margin-bottom: 3rem;
        }

        .content-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 80px rgba(0,0,0,0.12);
        }

        .content-card h3 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 2rem;
        }

        /* Module Grid - Premium */
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
        }

        .module-item {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 1px solid rgba(210, 210, 215, 0.3);
            border-radius: 24px;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 8px 30px rgba(0,0,0,0.06);
        }

        .module-item:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            background: white;
        }

        .module-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .module-icon {
            background: linear-gradient(135deg, #495057, #6c757d);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 8px 25px rgba(73, 80, 87, 0.2);
        }

        .module-name {
            font-weight: 600;
            color: #1d1d1f;
            flex: 1;
            font-size: 1.1rem;
        }

        .module-status {
            padding: 0.5rem 1rem;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .module-status.active {
            background: rgba(32, 201, 151, 0.1);
            color: #20c997;
        }

        .module-status.inactive {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .module-status.coming {
            background: rgba(253, 126, 20, 0.1);
            color: #fd7e14;
        }

        .module-description {
            color: #6c757d;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        /* Actions Grid - Premium */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }

        .action-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 1px solid rgba(210, 210, 215, 0.3);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--action-gradient);
            border-radius: 20px 20px 0 0;
        }

        .action-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.12);
            background: white;
        }

        .action-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            background: var(--action-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin: 0 auto 1rem;
            transition: all 0.3s ease;
            color: white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .action-card:hover .action-icon {
            transform: scale(1.05) rotate(-3deg);
        }

        .action-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 0.75rem;
            line-height: 1.3;
        }

        .action-description {
            color: #6c757d;
            line-height: 1.4;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .action-button {
            background: var(--action-gradient);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            width: 100%;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        /* Notification - Premium */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #20c997, #17a2b8);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: all 0.4s ease;
            z-index: 1000;
            max-width: 350px;
            backdrop-filter: blur(20px);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #20c997, #17a2b8);
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .notification.warning {
            background: linear-gradient(135deg, #fd7e14, #e55a14);
        }

        /* Hidden content by role */
        .role-hidden {
            display: none !important;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 2rem;
            max-width: 700px;
            width: 90%;
            position: relative;
            animation: modalSlideIn 0.4s ease;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from { 
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        /* Animations */
        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* Responsive - Premium */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 3rem 1.5rem;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 2rem;
            }

            .stats-grid,
            .actions-grid {
                grid-template-columns: 1fr;
            }

            .module-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-title {
                font-size: 2.8rem;
            }

            .header-stats {
                width: 100%;
                justify-content: center;
            }

            .header-stat {
                flex: 1;
                min-width: 120px;
            }
        }

        @media (min-width: 769px) and (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .actions-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="company-logo"></div>
        <div class="loading-company-name" id="loadingCompanyName">Loading...</div>
        <div class="loading-subtitle" id="loadingSubtitle">Initializing your workspace...</div>
        <div class="loading-progress">
            <div class="progress-bar"></div>
        </div>
    </div>

    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="company-info">
                <h1 id="companyName">Loading...</h1>
                <p id="companyDescription">Warehouse Management System</p>
            </div>
            <div class="header-stats">
                <div class="header-stat">
                    <span class="number" id="headerEquipment">0</span>
                    <span class="label">Total Equipment</span>
                </div>
                <div class="header-stat">
                    <span class="number" id="headerActive">0</span>
                    <span class="label">Active Loans</span>
                </div>
                <div class="header-stat">
                    <span class="number" id="headerUsers">0</span>
                    <span class="label">Active Users</span>
                </div>
            </div>
            <div class="header-actions">
                <div class="profile-selector" onclick="showRoleSelector()">
                    <div class="profile-avatar" id="profileAvatar">U</div>
                    <div class="profile-info">
                        <div class="profile-name" id="profileName">User</div>
                        <div class="profile-role" id="profileRole">Loading...</div>
                    </div>
                    <span>▼</span>
                </div>
                <a href="https://candewesth.github.io/opsis-suite/login.html" class="logout-btn">Sign Out</a>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard-container">
        <h1 class="dashboard-title" id="dashboardTitle">Warehouse Dashboard</h1>
        <p class="dashboard-subtitle" id="dashboardSubtitle">Complete warehouse operations overview and management with enterprise-grade tools for inventory control and equipment tracking</p>

        <!-- Quick Stats -->
        <div class="stats-grid">
            <div class="stat-card" onclick="handleStatClick('equipment')">
                <div class="stat-icon">✅</div>
                <div class="stat-number" id="availableEquipment">0</div>
                <div class="stat-label">Available Equipment</div>
                <div class="stat-sublabel">Ready for checkout</div>
            </div>

            <div class="stat-card" onclick="handleStatClick('loans')">
                <div class="stat-icon">🔄</div>
                <div class="stat-number" id="activeLoans">0</div>
                <div class="stat-label">Active Loans</div>
                <div class="stat-sublabel">Currently checked out</div>
            </div>

            <div class="stat-card" onclick="handleStatClick('maintenance')">
                <div class="stat-icon">🔧</div>
                <div class="stat-number" id="inMaintenance">0</div>
                <div class="stat-label">In Maintenance</div>
                <div class="stat-sublabel">Being serviced</div>
            </div>

            <div class="stat-card" onclick="handleStatClick('overdue')">
                <div class="stat-icon">⏰</div>
                <div class="stat-number" id="overdueReturns">0</div>
                <div class="stat-label">Overdue Returns</div>
                <div class="stat-sublabel">Require attention</div>
            </div>
        </div>

        <!-- Role-based Content -->
        <div class="role-section" id="roleSection">
            <!-- Content will be dynamically loaded based on user role -->
        </div>

        <!-- Available Modules based on Plan -->
        <div class="role-section">
            <h2 class="section-title">
                <div class="section-icon">🧩</div>
                Available Modules
            </h2>
            
            <div class="content-card">
                <h3>Active Modules for Your Plan</h3>
                <div class="module-grid" id="moduleGrid">
                    <!-- Modules will be loaded based on subscription plan -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Advanced Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 style="color: #1d1d1f; font-size: 1.8rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 2rem;">📊</span>
                    Advanced Data Export
                </h3>
                <button style="background: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3); color: #dc3545; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem;" onclick="closeExportModal()">×</button>
            </div>
            
            <div style="padding: 2rem 0;">
                <!-- Export Type Selection -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: #495057; margin-bottom: 1rem; font-size: 1.1rem;">Export Type</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e9ecef; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;" onclick="selectExportType('equipment')">
                            <input type="radio" name="exportType" value="equipment" checked style="width: 20px; height: 20px;">
                            <div>
                                <div style="font-weight: 600; color: #1d1d1f;">Equipment Data</div>
                                <div style="font-size: 0.9rem; color: #6c757d;">All equipment records and status</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e9ecef; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;" onclick="selectExportType('loans')">
                            <input type="radio" name="exportType" value="loans" style="width: 20px; height: 20px;">
                            <div>
                                <div style="font-weight: 600; color: #1d1d1f;">Loan History</div>
                                <div style="font-size: 0.9rem; color: #6c757d;">Equipment loans and returns</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e9ecef; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;" onclick="selectExportType('projects')">
                            <input type="radio" name="exportType" value="projects" style="width: 20px; height: 20px;">
                            <div>
                                <div style="font-weight: 600; color: #1d1d1f;">Project Data</div>
                                <div style="font-size: 0.9rem; color: #6c757d;">Job numbers and locations</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e9ecef; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;" onclick="selectExportType('complete')">
                            <input type="radio" name="exportType" value="complete" style="width: 20px; height: 20px;">
                            <div>
                                <div style="font-weight: 600; color: #1d1d1f;">Complete Export</div>
                                <div style="font-size: 0.9rem; color: #6c757d;">All company data</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Advanced Filters -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: #495057; margin-bottom: 1rem; font-size: 1.1rem;">Filter Data</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                        
                        <!-- Date Range Filter -->
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #495057;">Date Range</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="date" id="startDate" style="flex: 1; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px; font-size: 0.9rem;">
                                <span style="color: #6c757d;">to</span>
                                <input type="date" id="endDate" style="flex: 1; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px; font-size: 0.9rem;">
                            </div>
                        </div>

                        <!-- User Filter -->
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #495057;">User/Employee</label>
                            <select id="userFilter" style="width: 100%; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px; font-size: 0.9rem;">
                                <option value="">All Users</option>
                                <option value="john_smith">John Smith (Supervisor)</option>
                                <option value="maria_santos">Maria Santos (Warehouse)</option>
                                <option value="carlos_rodriguez">Carlos Rodriguez (Operativo)</option>
                                <option value="ana_martinez">Ana Martinez (Estimador)</option>
                            </select>
                        </div>

                        <!-- Equipment Type Filter -->
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #495057;">Equipment Type</label>
                            <select id="equipmentFilter" style="width: 100%; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px; font-size: 0.9rem;">
                                <option value="">All Equipment</option>
                                <option value="compressor">Air Compressors</option>
                                <option value="generator">Generators</option>
                                <option value="excavator">Excavators</option>
                                <option value="crane">Cranes</option>
                                <option value="tools">Hand Tools</option>
                                <option value="safety">Safety Equipment</option>
                            </select>
                        </div>

                        <!-- Status Filter -->
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #495057;">Equipment Status</label>
                            <select id="statusFilter" style="width: 100%; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px; font-size: 0.9rem;">
                                <option value="">All Statuses</option>
                                <option value="available">Available</option>
                                <option value="loaned">Currently Loaned</option>
                                <option value="maintenance">In Maintenance</option>
                                <option value="damaged">Damaged</option>
                                <option value="lost">Lost/Missing</option>
                            </select>
                        </div>

                        <!-- Job Number Filter -->
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #495057;">Job Number</label>
                            <input type="text" id="jobFilter" placeholder="e.g., JOB-2024-001" style="width: 100%; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px; font-size: 0.9rem;">
                        </div>

                        <!-- Location Filter -->
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #495057;">Work Location</label>
                            <input type="text" id="locationFilter" placeholder="Address or project site" style="width: 100%; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px; font-size: 0.9rem;">
                        </div>
                    </div>
                </div>

                <!-- Export Format -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: #495057; margin-bottom: 1rem; font-size: 1.1rem;">Export Format</h4>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="exportFormat" value="excel" checked style="width: 18px; height: 18px;">
                            <span style="font-weight: 500;">📊 Excel (.xlsx)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="exportFormat" value="csv" style="width: 18px; height: 18px;">
                            <span style="font-weight: 500;">📄 CSV (.csv)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="exportFormat" value="pdf" style="width: 18px; height: 18px;">
                            <span style="font-weight: 500;">📋 PDF Report</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="exportFormat" value="json" style="width: 18px; height: 18px;">
                            <span style="font-weight: 500;">🔗 JSON (API)</span>
                        </label>
                    </div>
                </div>

                <!-- Export Summary -->
                <div style="background: linear-gradient(135deg, rgba(32, 201, 151, 0.1), rgba(23, 162, 184, 0.1)); border: 1px solid rgba(32, 201, 151, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <h5 style="color: #20c997; margin-bottom: 1rem; font-size: 1.1rem; font-weight: 600;">Export Preview</h5>
                    <div id="exportSummary" style="color: #495057; font-size: 0.95rem; line-height: 1.5;">
                        <div>🗂️ <strong>Data Type:</strong> Equipment Data</div>
                        <div>📅 <strong>Date Range:</strong> All Time</div>
                        <div>👤 <strong>Users:</strong> All Users</div>
                        <div>📦 <strong>Equipment:</strong> All Types</div>
                        <div>📊 <strong>Format:</strong> Excel (.xlsx)</div>
                        <div style="margin-top: 0.75rem; font-weight: 600; color: #20c997;">Estimated records: ~1,247 items</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeExportModal()" style="background: #f8f9fa; color: #495057; border: 1px solid #e9ecef; padding: 1rem 2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                        Cancel
                    </button>
                    <button onclick="generateExport()" style="background: linear-gradient(135deg, #20c997, #17a2b8); color: white; border: none; padding: 1rem 2rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem;">
                        <span>📊</span>
                        <span>Generate Export</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ================================================================
        // SUPABASE CONFIGURATION
        // ================================================================
        const SUPABASE_CONFIG = {
            url: 'https://lmmlhncwdwjgtkdqaycv.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtbWxobmN3ZHdqZ3RrZHFheWN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDE4ODYsImV4cCI6MjA3MDk3Nzg4Nn0.vhL5E-o9RtjEtrYTOdFCvhXs5mu5fuuAtB13LCd6dJQ'
        };

        const supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);

        // ================================================================
        // GLOBAL VARIABLES
        // ================================================================
        let currentCompany = null;
        let currentUser = null;
        let userRole = 'admin'; // Default role

        // ================================================================
        // COMPANY DETECTION
        // ================================================================
        function detectCompany() {
            // Get company from URL path
            const path = window.location.pathname;
            const segments = path.split('/').filter(segment => segment);
            
            // Look for company identifier in URL
            const companySlug = segments[segments.length - 1];
            
            console.log('Detected company slug:', companySlug);
            return companySlug;
        }

        // ================================================================
        // DATA LOADING FUNCTIONS
        // ================================================================
        async function loadCompanyData() {
            try {
                const companySlug = detectCompany();
                
                if (!companySlug) {
                    throw new Error('No company identifier found in URL');
                }

                console.log('Loading company data for:', companySlug);

                // Load company from Supabase
                const { data: company, error } = await supabase
                    .from('companies')
                    .select('*')
                    .eq('slug', companySlug)
                    .single();

                if (error) {
                    console.error('Error loading company:', error);
                    // Fallback to demo data
                    currentCompany = createDemoCompany(companySlug);
                } else {
                    currentCompany = company;
                }

                console.log('Company loaded:', currentCompany);
                updateCompanyDisplay();
                await loadDashboardStats();
                loadModulesForPlan();

            } catch (error) {
                console.error('Error in loadCompanyData:', error);
                // Fallback to demo company
                currentCompany = createDemoCompany('demo');
                updateCompanyDisplay();
                loadDemoStats();
                loadModulesForPlan();
            }
        }

        function createDemoCompany(slug) {
            return {
                id: 'demo-' + slug,
                name: slug === 'cvesandiego' ? 'CVE San Diego' : 
                      slug === 'techcorp' ? 'Tech Corporation' : 
                      'Demo Company',
                slug: slug,
                domain: slug === 'cvesandiego' ? 'cve.com' : 
                        slug === 'techcorp' ? 'techcorp.com' : 
                        'demo.com',
                sector: 'construction',
                plan: 'warehouse_pro',
                status: 'active',
                initial_users: 5
            };
        }

        function updateCompanyDisplay() {
            if (!currentCompany) return;

            // Update loading screen
            document.getElementById('loadingCompanyName').textContent = currentCompany.name;
            document.getElementById('loadingSubtitle').textContent = `Initializing ${currentCompany.name} workspace...`;

            // Update header
            document.getElementById('companyName').textContent = currentCompany.name;
            document.getElementById('companyDescription').textContent = getCompanyDescription();

            // Update dashboard title
            document.getElementById('dashboardTitle').textContent = `${currentCompany.name} Dashboard`;
            document.getElementById('dashboardSubtitle').textContent = `Complete warehouse operations for ${currentCompany.name} with enterprise-grade tools`;
        }

        function getCompanyDescription() {
            const sectorDescriptions = {
                'construction': 'Construction & Engineering Operations',
                'manufacturing': 'Manufacturing & Production Management',
                'logistics': 'Logistics & Transportation Hub',
                'technology': 'Technology Solutions Center'
            };
            
            return sectorDescriptions[currentCompany.sector] || 'Warehouse Management System';
        }

        // ================================================================
        // STATS LOADING
        // ================================================================
        async function loadDashboardStats() {
            try {
                console.log('Loading dashboard stats for company:', currentCompany.id);
                
                // Try to load real stats from Google Sheets or Supabase
                // For now, use calculated demo stats based on company
                const stats = calculateCompanyStats();
                updateStatsDisplay(stats);

            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                loadDemoStats();
            }
        }

        function calculateCompanyStats() {
            // Calculate realistic stats based on company size and plan
            const baseMultiplier = currentCompany.initial_users || 5;
            
            return {
                totalEquipment: Math.floor(baseMultiplier * 25 + Math.random() * 50),
                availableEquipment: Math.floor(baseMultiplier * 20 + Math.random() * 30),
                activeLoans: Math.floor(baseMultiplier * 4 + Math.random() * 10),
                inMaintenance: Math.floor(baseMultiplier * 0.5 + Math.random() * 3),
                overdueReturns: Math.floor(Math.random() * 5),
                activeUsers: currentCompany.initial_users || 5
            };
        }

        function loadDemoStats() {
            const stats = {
                totalEquipment: 247,
                availableEquipment: 168,
                activeLoans: 56,
                inMaintenance: 23,
                overdueReturns: 12,
                activeUsers: 15
            };
            updateStatsDisplay(stats);
        }

        function updateStatsDisplay(stats) {
            // Header stats
            document.getElementById('headerEquipment').textContent = stats.totalEquipment;
            document.getElementById('headerActive').textContent = stats.activeLoans;
            document.getElementById('headerUsers').textContent = stats.activeUsers;

            // Main stats
            document.getElementById('availableEquipment').textContent = stats.availableEquipment;
            document.getElementById('activeLoans').textContent = stats.activeLoans;
            document.getElementById('inMaintenance').textContent = stats.inMaintenance;
            document.getElementById('overdueReturns').textContent = stats.overdueReturns;

            // Animate the numbers
            animateStats();
        }

        // ================================================================
        // MODULES LOADING BASED ON PLAN
        // ================================================================
        function loadModulesForPlan() {
            const plan = currentCompany?.plan || 'warehouse_pro';
            const modules = getModulesForPlan(plan);
            
            const moduleGrid = document.getElementById('moduleGrid');
            moduleGrid.innerHTML = modules.map(module => createModuleHTML(module)).join('');
        }

        function getModulesForPlan(plan) {
            const allModules = [
                {
                    id: 'equipment-tracking',
                    name: 'Equipment Tracking',
                    icon: '📦',
                    status: 'active',
                    description: 'Complete equipment lifecycle management and tracking',
                    available: ['warehouse_basic', 'warehouse_pro', 'suite_standard', 'suite_premium', 'enterprise']
                },
                {
                    id: 'loan-management',
                    name: 'Loan Management',
                    icon: '🔄',
                    status: 'active',
                    description: 'Request, approve, and track equipment loans',
                    available: ['warehouse_basic', 'warehouse_pro', 'suite_standard', 'suite_premium', 'enterprise']
                },
                {
                    id: 'maintenance-scheduler',
                    name: 'Maintenance Scheduler',
                    icon: '🔧',
                    status: 'active',
                    description: 'Schedule and track equipment maintenance',
                    available: ['warehouse_pro', 'suite_standard', 'suite_premium', 'enterprise']
                },
                {
                    id: 'analytics-reporting',
                    name: 'Analytics & Reporting',
                    icon: '📊',
                    status: 'active',
                    description: 'Advanced analytics and custom reports',
                    available: ['warehouse_pro', 'suite_standard', 'suite_premium', 'enterprise']
                },
                {
                    id: 'hr-integration',
                    name: 'HR Integration',
                    icon: '👥',
                    status: 'coming',
                    description: 'Employee management and HR workflows',
                    available: ['suite_standard', 'suite_premium', 'enterprise']
                },
                {
                    id: 'timesync-integration',
                    name: 'TimeSync Integration',
                    icon: '⏰',
                    status: 'coming',
                    description: 'Time tracking and project management',
                    available: ['suite_premium', 'enterprise']
                },
                {
                    id: 'finance-integration',
                    name: 'Finance Integration',
                    icon: '💰',
                    status: 'coming',
                    description: 'Financial management and cost tracking',
                    available: ['enterprise']
                }
            ];

            return allModules.filter(module => module.available.includes(plan));
        }

        function createModuleHTML(module) {
            return `
                <div class="module-item" onclick="openModule('${module.id}')">
                    <div class="module-header">
                        <span class="module-icon">${module.icon}</span>
                        <span class="module-name">${module.name}</span>
                        <span class="module-status ${module.status}">${module.status.toUpperCase()}</span>
                    </div>
                    <div class="module-description">${module.description}</div>
                </div>
            `;
        }

        // ================================================================
        // ROLE-BASED CONTENT
        // ================================================================
        function loadRoleBasedContent() {
            const roleSection = document.getElementById('roleSection');
            
            switch(userRole) {
                case 'admin':
                    roleSection.innerHTML = getAdminContent();
                    break;
                case 'almacen':
                    roleSection.innerHTML = getAlmacenContent();
                    break;
                case 'supervisor':
                    roleSection.innerHTML = getSupervisorContent();
                    break;
                case 'operativo':
                    roleSection.innerHTML = getOperativoContent();
                    break;
                case 'estimador':
                    roleSection.innerHTML = getEstimadorContent();
                    break;
                default:
                    roleSection.innerHTML = getAdminContent();
            }
        }

        function getAdminContent() {
            const userPlan = currentCompany?.plan || 'warehouse_pro';
            const availableModules = getModulesForAdminPlan(userPlan);
            
            return `
                <h2 class="section-title">
                    <div class="section-icon">👑</div>
                    Company Administration Center
                    <span style="margin-left: auto; background: linear-gradient(135deg, #20c997, #17a2b8); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase;">
                        ${getPlanDisplayName(userPlan)}
                    </span>
                </h2>
                
                ${availableModules.teamManagement ? `
                <!-- Core Management Section -->
                <div class="content-card">
                    <h3>Team & Access Management</h3>
                    <div class="actions-grid">
                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #20c997, #17a2b8);" onclick="handleAction('add-team-members')">
                            <div class="action-icon">👥</div>
                            <div class="action-title">Add Team Members</div>
                            <div class="action-description">Invite and register new users for your company</div>
                            <button class="action-button">Add Users</button>
                        </div>

                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #6610f2, #d63384);" onclick="handleAction('role-assignment')">
                            <div class="action-icon">🔐</div>
                            <div class="action-title">Role Assignment</div>
                            <div class="action-description">Assign roles: Almacén, Supervisor, Operativo, Estimador</div>
                            <button class="action-button">Manage Roles</button>
                        </div>

                        ${availableModules.teamPermissions ? `
                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #fd7e14, #dc3545);" onclick="handleAction('team-permissions')">
                            <div class="action-icon">🛡️</div>
                            <div class="action-title">Team Permissions</div>
                            <div class="action-description">Configure what each role can view and modify</div>
                            <button class="action-button">Set Permissions</button>
                        </div>
                        ` : ''}

                        ${availableModules.userActivity ? `
                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #0dcaf0, #6f42c1);" onclick="handleAction('user-activity')">
                            <div class="action-icon">📊</div>
                            <div class="action-title">User Activity</div>
                            <div class="action-description">Monitor team activity and system usage</div>
                            <button class="action-button">View Activity</button>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Company Configuration Section -->
                <div class="content-card">
                    <h3>Company Configuration</h3>
                    <div class="actions-grid">
                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #495057, #6c757d);" onclick="handleAction('company-settings')">
                            <div class="action-icon">🏢</div>
                            <div class="action-title">Company Settings</div>
                            <div class="action-description">Update company info, locations, and preferences</div>
                            <button class="action-button">Configure</button>
                        </div>

                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #20c997, #17a2b8);" onclick="handleAction('equipment-categories')">
                            <div class="action-icon">📦</div>
                            <div class="action-title">Equipment Categories</div>
                            <div class="action-description">Define equipment types specific to your industry</div>
                            <button class="action-button">Manage Categories</button>
                        </div>

                        ${availableModules.projectSetup ? `
                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #fd7e14, #dc3545);" onclick="handleAction('project-setup')">
                            <div class="action-icon">🏗️</div>
                            <div class="action-title">Project Management</div>
                            <div class="action-description">Create and manage company projects and job numbers</div>
                            <button class="action-button">Manage Projects</button>
                        </div>
                        ` : ''}

                        ${availableModules.workflowConfig ? `
                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #6610f2, #d63384);" onclick="handleAction('workflow-config')">
                            <div class="action-icon">⚙️</div>
                            <div class="action-title">Workflow Configuration</div>
                            <div class="action-description">Customize approval workflows and processes</div>
                            <button class="action-button">Configure Workflows</button>
                        </div>
                        ` : ''}
                    </div>
                </div>

                ${availableModules.analytics ? `
                <!-- Business Intelligence Section -->
                <div class="content-card">
                    <h3>Business Intelligence & Analytics</h3>
                    <div class="actions-grid">
                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #0dcaf0, #6f42c1);" onclick="handleAction('company-analytics')">
                            <div class="action-icon">📈</div>
                            <div class="action-title">Company Analytics</div>
                            <div class="action-description">Equipment utilization, costs, and performance metrics</div>
                            <button class="action-button">View Analytics</button>
                        </div>

                        ${availableModules.financialReports ? `
                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #20c997, #17a2b8);" onclick="handleAction('financial-reports')">
                            <div class="action-icon">💰</div>
                            <div class="action-title">Financial Reports</div>
                            <div class="action-description">Cost analysis, ROI, and equipment depreciation</div>
                            <button class="action-button">Financial Dashboard</button>
                        </div>
                        ` : ''}

                        ${availableModules.operationalReports ? `
                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #fd7e14, #dc3545);" onclick="handleAction('operational-reports')">
                            <div class="action-icon">📋</div>
                            <div class="action-title">Operational Reports</div>
                            <div class="action-description">Equipment usage, maintenance, and efficiency reports</div>
                            <button class="action-button">Generate Reports</button>
                        </div>
                        ` : ''}

                        ${availableModules.predictiveInsights ? `
                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #6610f2, #d63384);" onclick="handleAction('predictive-insights')">
                            <div class="action-icon">🔮</div>
                            <div class="action-title">Predictive Insights</div>
                            <div class="action-description">Equipment lifecycle and maintenance predictions</div>
                            <button class="action-button">View Insights</button>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                ${availableModules.dataManagement ? `
                <!-- Subscription & Data Management Section -->
                <div class="content-card">
                    <h3>Data & System Management</h3>
                    <div class="actions-grid">
                        ${availableModules.subscriptionManagement ? `
                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #28a745, #20c997);" onclick="handleAction('subscription-management')">
                            <div class="action-icon">💳</div>
                            <div class="action-title">Subscription & Billing</div>
                            <div class="action-description">Manage plan, billing, and module upgrades</div>
                            <button class="action-button">Manage Subscription</button>
                        </div>
                        ` : ''}

                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #17a2b8, #0dcaf0);" onclick="handleAction('data-backup')">
                            <div class="action-icon">💾</div>
                            <div class="action-title">Advanced Data Export</div>
                            <div class="action-description">Export filtered data by user, date, equipment, job number, location</div>
                            <button class="action-button">Export Data</button>
                        </div>

                        ${availableModules.integrationSettings ? `
                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #6f42c1, #6610f2);" onclick="handleAction('integration-settings')">
                            <div class="action-icon">🔗</div>
                            <div class="action-title">Integration Settings</div>
                            <div class="action-description">Configure external system integrations and APIs</div>
                            <button class="action-button">Manage Integrations</button>
                        </div>
                        ` : ''}

                        ${availableModules.systemMaintenance ? `
                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #e83e8c, #fd7e14);" onclick="handleAction('system-maintenance')">
                            <div class="action-icon">🛠️</div>
                            <div class="action-title">System Maintenance</div>
                            <div class="action-description">System health, updates, and maintenance schedules</div>
                            <button class="action-button">System Status</button>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                ${!availableModules.analytics ? `
                <!-- Upgrade Promotion Section -->
                <div class="content-card" style="background: linear-gradient(135deg, rgba(32, 201, 151, 0.1), rgba(23, 162, 184, 0.1)); border: 2px solid rgba(32, 201, 151, 0.3);">
                    <h3 style="color: #20c997;">Unlock Advanced Features</h3>
                    <div style="text-align: center; padding: 2rem;">
                        <p style="font-size: 1.1rem; color: #495057; margin-bottom: 2rem;">
                            Upgrade your plan to access advanced analytics, financial reports, and predictive insights.
                        </p>
                        <div class="action-card" style="--action-gradient: linear-gradient(135deg, #20c997, #17a2b8); max-width: 400px; margin: 0 auto;" onclick="handleAction('upgrade-plan')">
                            <div class="action-icon">⬆️</div>
                            <div class="action-title">Upgrade Plan</div>
                            <div class="action-description">Unlock analytics, reports, and premium features</div>
                            <button class="action-button">View Upgrade Options</button>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        }

        function getModulesForAdminPlan(plan) {
            const modules = {
                // WAREHOUSE BASIC ($49/mes) - Core Functionality
                'warehouse_basic': {
                    teamManagement: true,
                    teamPermissions: false,
                    userActivity: false,
                    projectSetup: false,
                    workflowConfig: false,
                    analytics: false,
                    financialReports: false,
                    operationalReports: false,
                    predictiveInsights: false,
                    dataManagement: true,
                    subscriptionManagement: false,
                    integrationSettings: false,
                    systemMaintenance: false
                },
                
                // WAREHOUSE PRO ($149/mes) - Operational Management
                'warehouse_pro': {
                    teamManagement: true,
                    teamPermissions: true,
                    userActivity: true,
                    projectSetup: true,
                    workflowConfig: false,
                    analytics: true,
                    financialReports: false,
                    operationalReports: false,
                    predictiveInsights: false,
                    dataManagement: true,
                    subscriptionManagement: false,
                    integrationSettings: false,
                    systemMaintenance: false
                },
                
                // SUITE STANDARD ($249/mes) - Business Intelligence
                'suite_standard': {
                    teamManagement: true,
                    teamPermissions: true,
                    userActivity: true,
                    projectSetup: true,
                    workflowConfig: true,
                    analytics: true,
                    financialReports: true,
                    operationalReports: true,
                    predictiveInsights: false,
                    dataManagement: true,
                    subscriptionManagement: false,
                    integrationSettings: false,
                    systemMaintenance: false
                },
                
                // SUITE PREMIUM ($499/mes) - Advanced Analytics
                'suite_premium': {
                    teamManagement: true,
                    teamPermissions: true,
                    userActivity: true,
                    projectSetup: true,
                    workflowConfig: true,
                    analytics: true,
                    financialReports: true,
                    operationalReports: true,
                    predictiveInsights: true,
                    dataManagement: true,
                    subscriptionManagement: false,
                    integrationSettings: true,
                    systemMaintenance: true
                },
                
                // ENTERPRISE ($999/mes) - Total Control
                'enterprise': {
                    teamManagement: true,
                    teamPermissions: true,
                    userActivity: true,
                    projectSetup: true,
                    workflowConfig: true,
                    analytics: true,
                    financialReports: true,
                    operationalReports: true,
                    predictiveInsights: true,
                    dataManagement: true,
                    subscriptionManagement: true,
                    integrationSettings: true,
                    systemMaintenance: true
                },
                
                // TRIAL - Limited Access
                'trial': {
                    teamManagement: false,
                    teamPermissions: false,
                    userActivity: false,
                    projectSetup: false,
                    workflowConfig: false,
                    analytics: false,
                    financialReports: false,
                    operationalReports: false,
                    predictiveInsights: false,
                    dataManagement: false,
                    subscriptionManagement: false,
                    integrationSettings: false,
                    systemMaintenance: false
                }
            };
            
            return modules[plan] || modules['warehouse_pro'];
        }

        function getPlanDisplayName(plan) {
            const plans = {
                'trial': 'Trial',
                'warehouse_basic': 'Warehouse Basic',
                'warehouse_pro': 'Warehouse Pro',
                'suite_standard': 'Suite Standard',
                'suite_premium': 'Suite Premium',
                'enterprise': 'Enterprise'
            };
            return plans[plan] || 'Warehouse Pro';
        }

        function getAlmacenContent() {
            return `
                <h2 class="section-title">
                    <div class="section-icon">🏭</div>
                    Warehouse Operations Control
                </h2>
                
                <div class="actions-grid">
                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #20c997, #17a2b8);" onclick="handleAction('approve-loans')">
                        <div class="action-icon">✅</div>
                        <div class="action-title">Approve Loan Requests</div>
                        <div class="action-description">Review and approve equipment loan requests</div>
                        <button class="action-button">View Requests</button>
                    </div>

                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #fd7e14, #dc3545);" onclick="handleAction('equipment-checkout')">
                        <div class="action-icon">📦</div>
                        <div class="action-title">Equipment Checkout</div>
                        <div class="action-description">Process equipment loans and returns</div>
                        <button class="action-button">Checkout System</button>
                    </div>

                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #6610f2, #d63384);" onclick="handleAction('inventory-management')">
                        <div class="action-icon">📋</div>
                        <div class="action-title">Inventory Management</div>
                        <div class="action-description">Manage equipment inventory and conditions</div>
                        <button class="action-button">Manage Inventory</button>
                    </div>

                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #0dcaf0, #6f42c1);" onclick="handleAction('maintenance-schedule')">
                        <div class="action-icon">🔧</div>
                        <div class="action-title">Maintenance Schedule</div>
                        <div class="action-description">Schedule and track equipment maintenance</div>
                        <button class="action-button">View Schedule</button>
                    </div>
                </div>
            `;
        }

        function getSupervisorContent() {
            return `
                <h2 class="section-title">
                    <div class="section-icon">👷</div>
                    Field Operations Dashboard
                </h2>
                
                <div class="actions-grid">
                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #20c997, #17a2b8);" onclick="handleAction('request-equipment')">
                        <div class="action-icon">📝</div>
                        <div class="action-title">Request Equipment</div>
                        <div class="action-description">Submit equipment requests for projects</div>
                        <button class="action-button">New Request</button>
                    </div>

                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #fd7e14, #dc3545);" onclick="handleAction('my-loans')">
                        <div class="action-icon">📦</div>
                        <div class="action-title">My Equipment Loans</div>
                        <div class="action-description">View and manage your current equipment</div>
                        <button class="action-button">View Loans</button>
                    </div>

                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #6610f2, #d63384);" onclick="handleAction('project-status')">
                        <div class="action-icon">🏗️</div>
                        <div class="action-title">Project Status</div>
                        <div class="action-description">Track project progress and equipment usage</div>
                        <button class="action-button">View Projects</button>
                    </div>

                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #0dcaf0, #6f42c1);" onclick="handleAction('return-equipment')">
                        <div class="action-icon">🔄</div>
                        <div class="action-title">Return Equipment</div>
                        <div class="action-description">Process equipment returns and condition reports</div>
                        <button class="action-button">Return Items</button>
                    </div>
                </div>
            `;
        }

        function getOperativoContent() {
            return `
                <h2 class="section-title">
                    <div class="section-icon">📊</div>
                    Operations Support Dashboard
                </h2>
                
                <div class="actions-grid">
                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #20c997, #17a2b8);" onclick="handleAction('data-entry')">
                        <div class="action-icon">📝</div>
                        <div class="action-title">Data Entry</div>
                        <div class="action-description">Input equipment data and maintenance records</div>
                        <button class="action-button">Enter Data</button>
                    </div>

                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #fd7e14, #dc3545);" onclick="handleAction('equipment-costs')">
                        <div class="action-icon">💰</div>
                        <div class="action-title">Equipment Costs</div>
                        <div class="action-description">Manage equipment costs and supplier information</div>
                        <button class="action-button">View Costs</button>
                    </div>

                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #6610f2, #d63384);" onclick="handleAction('support-tickets')">
                        <div class="action-icon">🎫</div>
                        <div class="action-title">Support Tickets</div>
                        <div class="action-description">Handle support requests and technical issues</div>
                        <button class="action-button">View Tickets</button>
                    </div>

                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #0dcaf0, #6f42c1);" onclick="handleAction('reports-export')">
                        <div class="action-icon">📋</div>
                        <div class="action-title">Export Reports</div>
                        <div class="action-description">Generate and export operational reports</div>
                        <button class="action-button">Export Data</button>
                    </div>
                </div>
            `;
        }

        function getEstimadorContent() {
            return `
                <h2 class="section-title">
                    <div class="section-icon">📊</div>
                    Project Estimation Dashboard
                </h2>
                
                <div class="actions-grid">
                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #20c997, #17a2b8);" onclick="handleAction('view-equipment')">
                        <div class="action-icon">👁️</div>
                        <div class="action-title">Equipment Catalog</div>
                        <div class="action-description">Browse available equipment for project estimates</div>
                        <button class="action-button">View Catalog</button>
                    </div>

                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #fd7e14, #dc3545);" onclick="handleAction('request-estimates')">
                        <div class="action-icon">📝</div>
                        <div class="action-title">Request Project Info</div>
                        <div class="action-description">Submit requests for project-specific information</div>
                        <button class="action-button">New Request</button>
                    </div>

                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #6610f2, #d63384);" onclick="handleAction('project-history')">
                        <div class="action-icon">📚</div>
                        <div class="action-title">Project History</div>
                        <div class="action-description">Review historical project data and costs</div>
                        <button class="action-button">View History</button>
                    </div>

                    <div class="action-card" style="--action-gradient: linear-gradient(135deg, #0dcaf0, #6f42c1);" onclick="handleAction('cost-analysis')">
                        <div class="action-icon">💹</div>
                        <div class="action-title">Cost Analysis</div>
                        <div class="action-description">Analyze equipment costs for project planning</div>
                        <button class="action-button">Analyze Costs</button>
                    </div>
                </div>
            `;
        }

        // ================================================================
        // EXPORT SYSTEM FUNCTIONS
        // ================================================================
        function openExportModal() {
            const modal = document.getElementById('exportModal');
            modal.classList.add('show');
            setupExportOptionsForRole(userRole);
            updateExportSummary();
        }

        function setupExportOptionsForRole(role) {
            const exportTypeSection = document.querySelector('#exportModal .actions-grid');
            const userFilter = document.getElementById('userFilter');
            const formatSection = document.querySelector('input[name="exportFormat"]').closest('div');
            
            // Configure export types based on role
            const exportTypes = getExportTypesForRole(role);
            updateExportTypeOptions(exportTypes);
            
            // Configure user filter based on role
            updateUserFilterForRole(role);
            
            // Configure available formats
            updateFormatsForRole(role);
        }

        function getExportTypesForRole(role) {
            const rolePermissions = {
                'admin': {
                    equipment: { enabled: true, description: 'All equipment records and status' },
                    loans: { enabled: true, description: 'All equipment loans and returns' },
                    projects: { enabled: true, description: 'All job numbers and locations' },
                    complete: { enabled: true, description: 'Complete company data export' }
                },
                'almacen': {
                    equipment: { enabled: true, description: 'Equipment inventory and conditions' },
                    loans: { enabled: true, description: 'Loan approvals and returns' },
                    projects: { enabled: true, description: 'Project equipment assignments' },
                    complete: { enabled: false, description: 'Not available for this role' }
                },
                'supervisor': {
                    equipment: { enabled: true, description: 'Available equipment catalog' },
                    loans: { enabled: true, description: 'Your equipment loans only' },
                    projects: { enabled: true, description: 'Your assigned projects only' },
                    complete: { enabled: false, description: 'Not available for this role' }
                },
                'operativo': {
                    equipment: { enabled: true, description: 'Equipment catalog and costs' },
                    loans: { enabled: false, description: 'Not available for this role' },
                    projects: { enabled: false, description: 'Not available for this role' },
                    complete: { enabled: false, description: 'Not available for this role' }
                },
                'estimador': {
                    equipment: { enabled: true, description: 'Equipment catalog for estimates' },
                    loans: { enabled: false, description: 'Not available for this role' },
                    projects: { enabled: false, description: 'Not available for this role' },
                    complete: { enabled: false, description: 'Not available for this role' }
                }
            };
            
            return rolePermissions[role] || rolePermissions['admin'];
        }

        function updateExportTypeOptions(exportTypes) {
            const typeLabels = document.querySelectorAll('#exportModal label[onclick*="selectExportType"]');
            
            typeLabels.forEach(label => {
                const input = label.querySelector('input');
                const type = input.value;
                const descElement = label.querySelector('div:last-child div:last-child');
                
                if (exportTypes[type] && exportTypes[type].enabled) {
                    label.style.opacity = '1';
                    label.style.pointerEvents = 'auto';
                    input.disabled = false;
                    descElement.textContent = exportTypes[type].description;
                    label.style.border = '2px solid #e9ecef';
                } else {
                    label.style.opacity = '0.5';
                    label.style.pointerEvents = 'none';
                    input.disabled = true;
                    descElement.textContent = 'Not available for your role';
                    label.style.border = '2px solid #f8f9fa';
                }
            });
            
            // Select first available option
            const firstAvailable = Object.keys(exportTypes).find(type => exportTypes[type].enabled);
            if (firstAvailable) {
                document.querySelector(`input[value="${firstAvailable}"]`).checked = true;
            }
        }

        function updateUserFilterForRole(role) {
            const userFilter = document.getElementById('userFilter');
            const userFilterContainer = userFilter.closest('div');
            
            if (role === 'supervisor') {
                userFilterContainer.style.display = 'none';
                // Supervisor only sees their own data
            } else if (role === 'estimador' || role === 'operativo') {
                userFilter.innerHTML = `
                    <option value="">All Users (Anonymous)</option>
                `;
                // These roles don't see specific user assignments
            } else {
                userFilterContainer.style.display = 'block';
                // Admin and Almacén see full user list
            }
        }

        function updateFormatsForRole(role) {
            const formatInputs = document.querySelectorAll('input[name="exportFormat"]');
            const roleFormats = {
                'admin': ['excel', 'csv', 'pdf', 'json'],
                'almacen': ['excel', 'csv', 'pdf'],
                'supervisor': ['excel', 'pdf'],
                'operativo': ['excel', 'csv'],
                'estimador': ['excel', 'pdf']
            };
            
            const allowedFormats = roleFormats[role] || ['excel'];
            
            formatInputs.forEach(input => {
                const label = input.closest('label');
                if (allowedFormats.includes(input.value)) {
                    label.style.display = 'flex';
                    input.disabled = false;
                } else {
                    label.style.display = 'none';
                    input.disabled = true;
                }
            });
            
            // Select first allowed format
            if (allowedFormats.length > 0) {
                const firstAllowed = document.querySelector(`input[value="${allowedFormats[0]}"]`);
                if (firstAllowed) firstAllowed.checked = true;
            }
        }

        function closeExportModal() {
            const modal = document.getElementById('exportModal');
            modal.classList.remove('show');
        }

        function selectExportType(type) {
            // Update radio selection
            document.querySelector(`input[value="${type}"]`).checked = true;
            updateExportSummary();
        }

        function updateExportSummary() {
            const exportType = document.querySelector('input[name="exportType"]:checked')?.value || 'equipment';
            const exportFormat = document.querySelector('input[name="exportFormat"]:checked')?.value || 'excel';
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;
            const userFilter = document.getElementById('userFilter')?.value;
            const equipmentFilter = document.getElementById('equipmentFilter')?.value;
            const statusFilter = document.getElementById('statusFilter')?.value;
            const jobFilter = document.getElementById('jobFilter')?.value;
            const locationFilter = document.getElementById('locationFilter')?.value;

            const typeLabels = {
                'equipment': 'Equipment Data',
                'loans': 'Loan History',
                'projects': 'Project Data',
                'complete': 'Complete Export'
            };

            const formatLabels = {
                'excel': 'Excel (.xlsx)',
                'csv': 'CSV (.csv)',
                'pdf': 'PDF Report',
                'json': 'JSON (API)'
            };

            let dateRange = 'All Time';
            if (startDate && endDate) {
                dateRange = `${startDate} to ${endDate}`;
            } else if (startDate) {
                dateRange = `From ${startDate}`;
            } else if (endDate) {
                dateRange = `Until ${endDate}`;
            }

            const userText = userFilter ? document.querySelector(`option[value="${userFilter}"]`).textContent : 'All Users';
            const equipmentText = equipmentFilter ? document.querySelector(`option[value="${equipmentFilter}"]`).textContent : 'All Types';
            const statusText = statusFilter ? document.querySelector(`option[value="${statusFilter}"]`).textContent : 'All Statuses';

            let additionalFilters = '';
            if (jobFilter) additionalFilters += `<div>🏗️ <strong>Job Number:</strong> ${jobFilter}</div>`;
            if (locationFilter) additionalFilters += `<div>📍 <strong>Location:</strong> ${locationFilter}</div>`;

            // Calculate estimated records based on filters
            let estimatedRecords = 1247; // Base number
            if (exportType === 'loans') estimatedRecords = 856;
            if (exportType === 'projects') estimatedRecords = 134;
            if (exportType === 'complete') estimatedRecords = 2897;

            // Adjust based on filters
            if (userFilter) estimatedRecords = Math.floor(estimatedRecords * 0.6);
            if (equipmentFilter) estimatedRecords = Math.floor(estimatedRecords * 0.4);
            if (statusFilter) estimatedRecords = Math.floor(estimatedRecords * 0.3);
            if (startDate || endDate) estimatedRecords = Math.floor(estimatedRecords * 0.7);

            const summaryHTML = `
                <div>🗂️ <strong>Data Type:</strong> ${typeLabels[exportType]}</div>
                <div>📅 <strong>Date Range:</strong> ${dateRange}</div>
                <div>👤 <strong>Users:</strong> ${userText}</div>
                <div>📦 <strong>Equipment:</strong> ${equipmentText}</div>
                <div>📊 <strong>Status:</strong> ${statusText}</div>
                ${additionalFilters}
                <div>📄 <strong>Format:</strong> ${formatLabels[exportFormat]}</div>
                <div style="margin-top: 0.75rem; font-weight: 600; color: #20c997;">Estimated records: ~${estimatedRecords.toLocaleString()} items</div>
            `;

            document.getElementById('exportSummary').innerHTML = summaryHTML;
        }

        async function generateExport() {
            const exportType = document.querySelector('input[name="exportType"]:checked')?.value;
            const exportFormat = document.querySelector('input[name="exportFormat"]:checked')?.value;
            
            const filters = {
                startDate: document.getElementById('startDate')?.value,
                endDate: document.getElementById('endDate')?.value,
                user: document.getElementById('userFilter')?.value,
                equipment: document.getElementById('equipmentFilter')?.value,
                status: document.getElementById('statusFilter')?.value,
                jobNumber: document.getElementById('jobFilter')?.value,
                location: document.getElementById('locationFilter')?.value
            };

            // Apply role-based restrictions
            const roleRestrictions = applyRoleRestrictionsToExport(userRole, filters);
            
            showNotification('Generating export... This may take a moment.', 'success');
            closeExportModal();

            try {
                // Simulate data collection from Supabase with role restrictions
                await simulateDataExport(exportType, exportFormat, roleRestrictions);
                
                const roleMessages = {
                    'admin': 'Complete export generated with full company data access.',
                    'almacen': 'Operations export generated with warehouse data.',
                    'supervisor': 'Project export generated with your assigned equipment and projects.',
                    'operativo': 'Equipment catalog export generated for operations support.',
                    'estimador': 'Equipment catalog export generated for project estimation.'
                };
                
                showNotification(roleMessages[userRole] || 'Export completed!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Export failed. Please try again.', 'error');
            }
        }

        function applyRoleRestrictionsToExport(role, filters) {
            const restrictedFilters = { ...filters };
            
            switch(role) {
                case 'supervisor':
                    // Supervisors only see their own data
                    restrictedFilters.user = getCurrentUserId(); // Would get from session
                    restrictedFilters.supervisorOnly = true;
                    break;
                    
                case 'estimador':
                    // Estimators don't see user assignments or sensitive data
                    restrictedFilters.user = null;
                    restrictedFilters.hideUserData = true;
                    restrictedFilters.hideCosts = true;
                    break;
                    
                case 'operativo':
                    // Operativo sees equipment data but limited project info
                    restrictedFilters.limitedProjectData = true;
                    break;
                    
                case 'almacen':
                    // Almacén sees all operational data but not financial details
                    restrictedFilters.hideFinancialData = false;
                    break;
                    
                case 'admin':
                    // Admin sees everything
                    break;
            }
            
            return restrictedFilters;
        }

        function getCurrentUserId() {
            // In real implementation, get from authentication context
            return 'current_user_id_from_session';
        }

        async function simulateDataExport(type, format, filters) {
            // Build role-aware query
            let query = `SELECT `;
            
            // Select appropriate columns based on role restrictions
            if (filters.hideUserData) {
                query += `equipment_id, name, type, status, location `;
            } else if (filters.limitedProjectData) {
                query += `*, (CASE WHEN sensitive_field THEN 'REDACTED' ELSE sensitive_field END) `;
            } else {
                query += `* `;
            }
            
            query += `FROM ${type} WHERE company_id = '${currentCompany?.id}'`;

            // Add role-based restrictions
            if (filters.supervisorOnly) {
                query += ` AND (assigned_to = '${filters.user}' OR requested_by = '${filters.user}')`;
            }
            
            if (filters.hideFinancialData) {
                query += ` AND type != 'financial'`;
            }

            // Add standard filters
            if (filters.startDate) query += ` AND created_at >= '${filters.startDate}'`;
            if (filters.endDate) query += ` AND created_at <= '${filters.endDate}'`;
            if (filters.user && !filters.hideUserData) query += ` AND user_id = '${filters.user}'`;
            if (filters.equipment) query += ` AND equipment_type = '${filters.equipment}'`;
            if (filters.status) query += ` AND status = '${filters.status}'`;
            if (filters.jobNumber) query += ` AND job_number ILIKE '%${filters.jobNumber}%'`;
            if (filters.location) query += ` AND work_location ILIKE '%${filters.location}%'`;

            console.log('Role-restricted Supabase Query:', query);
            console.log('Applied restrictions:', filters);

            // Simulate processing time
            await new Promise(resolve => setTimeout(resolve, 2000));

            const exportData = {
                companyName: currentCompany?.name,
                exportType: type,
                format: format,
                userRole: userRole,
                filters: filters,
                timestamp: new Date().toISOString(),
                recordCount: Math.floor(Math.random() * 500) + 100,
                restrictions: Object.keys(filters).filter(key => 
                    key.includes('hide') || key.includes('Only') || key.includes('limited')
                )
            };

            return exportData;
        }
        function showRoleSelector() {
            const roles = [
                { id: 'admin', name: 'Administrator', icon: '👑' },
                { id: 'almacen', name: 'Warehouse Manager', icon: '🏭' },
                { id: 'supervisor', name: 'Field Supervisor', icon: '👷' },
                { id: 'operativo', name: 'Operations Support', icon: '📊' },
                { id: 'estimador', name: 'Project Estimator', icon: '📋' }
            ];

            const roleList = roles.map(role => 
                `<div onclick="switchRole('${role.id}')" style="padding: 1rem; cursor: pointer; border-radius: 8px; margin: 0.5rem 0; background: rgba(255,255,255,0.1); transition: all 0.3s ease;">
                    ${role.icon} ${role.name}
                </div>`
            ).join('');

            showNotification(`Role Selector:\n${roleList}`, 'success');
        }

        function switchRole(newRole) {
            userRole = newRole;
            
            // Update profile display
            const roleNames = {
                'admin': 'Administrator',
                'almacen': 'Warehouse Manager', 
                'supervisor': 'Field Supervisor',
                'operativo': 'Operations Support',
                'estimador': 'Project Estimator'
            };

            const roleAvatars = {
                'admin': 'A',
                'almacen': 'W',
                'supervisor': 'S', 
                'operativo': 'O',
                'estimador': 'E'
            };

            document.getElementById('profileRole').textContent = roleNames[newRole];
            document.getElementById('profileAvatar').textContent = roleAvatars[newRole];

            // Reload role-based content
            loadRoleBasedContent();
            
            showNotification(`Switched to ${roleNames[newRole]} role`, 'success');
        }

        function handleStatClick(type) {
            const messages = {
                'equipment': 'Loading equipment inventory dashboard...',
                'loans': 'Opening active loans management...',
                'maintenance': 'Loading maintenance scheduler...',
                'overdue': 'Opening overdue tracking system...'
            };
            
            showNotification(messages[type] || 'Loading...', 'success');
            
            setTimeout(() => {
                window.open('https://www.opsis-suite.com/built', '_top');
            }, 1500);
        }

        function handleAction(action) {
            const actionMessages = {
                // Original actions
                'user-management': 'Opening user management panel...',
                'warehouse-overview': 'Loading warehouse overview dashboard...',
                'system-reports': 'Generating system reports...',
                'settings': 'Opening system settings...',
                
                // Almacén actions
                'approve-loans': 'Loading loan approval queue...',
                'equipment-checkout': 'Opening equipment checkout system...',
                'inventory-management': 'Loading inventory management...',
                'maintenance-schedule': 'Opening maintenance scheduler...',
                
                // Supervisor actions
                'request-equipment': 'Opening equipment request form...',
                'my-loans': 'Loading your current equipment loans...',
                'project-status': 'Checking project status...',
                'return-equipment': 'Opening equipment return system...',
                
                // Operativo actions
                'data-entry': 'Loading data entry interface...',
                'equipment-costs': 'Opening cost management system...',
                'support-tickets': 'Loading support ticket system...',
                'reports-export': 'Preparing report export...',
                
                // Estimador actions
                'view-equipment': 'Loading equipment catalog...',
                'request-estimates': 'Opening project request form...',
                'project-history': 'Loading project history...',
                'cost-analysis': 'Opening cost analysis tools...',

                // NEW ADMIN ACTIONS - Team & Access Management
                'add-team-members': 'Opening team member invitation system...',
                'role-assignment': 'Loading role assignment interface...',
                'team-permissions': 'Opening permissions configuration...',
                'user-activity': 'Loading user activity monitoring dashboard...',

                // NEW ADMIN ACTIONS - Company Configuration
                'company-settings': 'Opening company configuration panel...',
                'equipment-categories': 'Loading equipment category management...',
                'project-setup': 'Opening project management configuration...',
                'workflow-config': 'Loading workflow configuration interface...',

                // NEW ADMIN ACTIONS - Business Intelligence
                'company-analytics': 'Loading company analytics dashboard...',
                'financial-reports': 'Generating financial analysis reports...',
                'operational-reports': 'Preparing operational efficiency reports...',
                'predictive-insights': 'Loading predictive analytics dashboard...',

                // NEW ADMIN ACTIONS - Subscription & Data
                'subscription-management': 'Opening subscription and billing management...',
                'data-backup': 'Opening advanced data export system...',
                'integration-settings': 'Loading integration configuration panel...',
                'system-maintenance': 'Opening system maintenance dashboard...',
                
                // Upgrade action
                'upgrade-plan': 'Loading plan upgrade options and pricing...'
            };
            
            const message = actionMessages[action] || `Processing ${action}...`;
            showNotification(message, 'success');
            
            // Add special handling for certain admin actions
            if (action === 'add-team-members') {
                setTimeout(() => {
                    showNotification('Team invitation feature: Send invite links to new team members via email', 'success');
                }, 2000);
            } else if (action === 'role-assignment') {
                setTimeout(() => {
                    showNotification('Role management: Assign ADMIN, ALMACÉN, SUPERVISOR, OPERATIVO, or ESTIMADOR roles', 'success');
                }, 2000);
            } else if (action === 'subscription-management') {
                setTimeout(() => {
                    showNotification(`Current plan: ${currentCompany?.plan || 'warehouse_pro'} - Upgrade options available`, 'success');
                }, 2000);
            } else if (action === 'data-backup') {
                // Open export modal instead of redirecting
                setTimeout(() => {
                    openExportModal();
                }, 1000);
                return; // Don't redirect to /built
            }
            
            setTimeout(() => {
                window.open('https://www.opsis-suite.com/built', '_top');
            }, 1500);
        }

        function openModule(moduleId) {
            showNotification(`Opening ${moduleId} module...`, 'success');
            
            setTimeout(() => {
                window.open('https://www.opsis-suite.com/built', '_top');
            }, 1500);
        }

        // ================================================================
        // UTILITY FUNCTIONS
        // ================================================================
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            
            notification.textContent = message;
            notification.classList.remove('success', 'warning', 'error');
            notification.classList.add(type);
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3500);
        }

        function animateStats() {
            const statElements = [
                { element: document.getElementById('headerEquipment'), target: parseInt(document.getElementById('headerEquipment').textContent) },
                { element: document.getElementById('headerActive'), target: parseInt(document.getElementById('headerActive').textContent) },
                { element: document.getElementById('headerUsers'), target: parseInt(document.getElementById('headerUsers').textContent) }
            ];

            statElements.forEach(stat => {
                if (stat.target > 0) {
                    let current = 0;
                    const increment = stat.target / 30;
                    
                    const timer = setInterval(() => {
                        current += increment;
                        if (current >= stat.target) {
                            stat.element.textContent = stat.target;
                            clearInterval(timer);
                        } else {
                            stat.element.textContent = Math.floor(current);
                        }
                    }, 50);
                }
            });
        }

        function updateHeight() {
            const height = Math.max(
                document.body.scrollHeight,
                document.body.offsetHeight,
                document.documentElement.clientHeight,
                document.documentElement.scrollHeight,
                document.documentElement.offsetHeight
            );
            
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({
                    type: 'setHeight',
                    height: height + 50
                }, '*');
            }
        }

        // ================================================================
        // INITIALIZATION
        // ================================================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Company Dashboard - Initializing with Supabase integration...');
            
            // Load company data first
            await loadCompanyData();
            
            // Load role-based content
            loadRoleBasedContent();
            
            // Hide loading screen after data is loaded
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
                showNotification(`Welcome to ${currentCompany?.name || 'Company'} Dashboard`, 'success');
                updateHeight();
            }, 3000);

            // Update height on window resize
            window.addEventListener('resize', updateHeight);
            
            // Initial height update
            setTimeout(updateHeight, 100);
        });

        console.log('Company Dashboard - Supabase Integration Ready!');
    </script>
</body>
</html>
